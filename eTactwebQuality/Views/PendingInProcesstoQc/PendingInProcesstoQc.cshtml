@model eTactWeb.DOM.Models.PendingInProcessToQc

@{
    ViewData["Title"] = "Pending In Process To QC";
    Layout = "~/Views/Shared/_LayoutMain.cshtml";
}
<style>

    .select2-container--default .select2-selection--single {
        background-color: #e0f2f1;
        border: 1.5px solid #0a0a0a !important;
        border-radius: 4px;
    }

        .select2-container--default .select2-selection--single .select2-selection__rendered {
            /* border-bottom: 1.5px solid #000 !important; */
            border-bottom: none !important;
        }

    .select2-container--default .select2-results > .select2-results__options {
        background-color: #e0f2f1; /* Dropdown background color */
        color: #000;
</style>
<div class="shadow-lg">
    <div class="card rounded border-light bg-gradient">
        <div class="card-header card-headerBG text-light bg-gradient">
            <h5>
                Pending In Process TO QC
                <span class="d-flex float-end" style="margin-top:-2px;">
                    @*<a asp-action="ReqWithoutBom" asp-route-ID="0" class="btn btn-sm btn-outline-light bg-gradient">
                    <i class="fa fa-plus-circle fafw fa-lg" aria-hidden="true"></i>
                    Add New
                    </a>*@
                    <a asp-action="InProcessQcDashboard" asp-controller="InProcessQc" asp-route-FromDate="@DateTime.Now.AddMonths(-3)" asp-route-Todate="@DateTime.Today" asp-route-Flag="True" class="btn btn-sm btn-outline-light bg-gradient">
                        <i class="fa-solid fa-grip fa-lg fa-fw fa-beat" style="--fa-animation-duration: 2s;"></i>
                        Dashboard
                    </a>
                </span>
            </h5>
        </div>
        <div class="card-body">
            <div class="card overflow-auto">
                <div class="card-body">
                    <form id="SParam">
                        <div class="row">

                            <div class="col-sm-3 col-md-6 col-lg-2 col-xl-4">
                                <div class="row">
                                    <div class="col">
                                        <label class="form-label">From Date</label>
                                        <input type="hidden" value="@Model.FromDate" id="finFromDate" />
                                        <input type="hidden" value="@Model.ToDate" id="finToDate" />
                                        <input asp-for="FromDate" maxlength="10" class="form-control" value="@Model.FromDate" />
                                    </div>
                                    <div class="col">
                                        <label class="form-label">To Date</label>
                                        <input asp-for="ToDate" maxlength="10" class="form-control" value="@Model.ToDate" />
                                    </div>
                                </div>
                            </div>

                            <div class="col-sm-3 col-md-6 col-lg-4 col-xl-2">
                                <label asp-for="PartCode" class="form-label">Part Code</label>
                                <select class="form-select" asp-for="PartCode" asp-items="@(new SelectList(Model.PartCodeList,"Value","Text"))">
                                    <option value="" selected disabled>-Select-</option>
                                </select>
                            </div>
                            <div class="col-sm-3 col-md-6 col-lg-4 col-xl-2">
                                <label asp-for="ItemName" class="form-label">Item Name</label>
                                <select class="form-select" asp-for="ItemName" asp-items="@(new SelectList(Model.ItemNameList,"Value","Text"))">
                                    <option value="" selected disabled>-Select-</option>
                                </select>
                            </div>
                            <div class="col-sm-3 col-md-6 col-lg-4 col-xl-2">
                                <label asp-for="ProdSlipNo" class="form-label">ProdSlip NO</label>
                                <select class="form-select" asp-for="ProdSlipNo" asp-items="@(new SelectList(Model.ProdSlipList,"Value","Text"))">
                                    <option value="">-Select-</option>
                                </select>
                            </div>
                            <div class="col-sm-3 col-md-6 col-lg-4 col-xl-2">
                                <label asp-for="WorkCenter" class="form-label">Work Center</label>
                                <select class="form-select" asp-for="WorkCenter" asp-items="@(new SelectList(Model.WorkCenterList,"Value","Text"))">
                                    <option value="">-Select-</option>
                                </select>
                            </div>
                            <div class="col-sm-2 col-md-6 col-lg-4 col-xl-2">
                                <label class="form-label">Global search</label>
                                <input type="text" class="form-control" id="search-box" style="background-color:#FFFACD" placeholder="Search...">
                            </div>
                            <div class="col-sm-3 col-md-6 col-lg-2 col-xl-4 d-flex justify-content-end mt-3">
                                <button class="btn btn-sm btn-outline-primary" type="button" onclick="showDetail();" style="padding:3px;height:30px;width:100px;margin-left:20px;">
                                    <i class="fa-solid fa-magnifying-glass fa-fw fa-lg "></i>SHOW
                                </button>
                                <button class="btn btn-sm btn-outline-success" style="padding:3px;height:30px;width:100px;margin-left:20px;" type="button" id="sendToExcel">
                                    <i class="fa-solid fa-upload fa-fw fa-lg "></i>EXCEL
                                </button>
                                <a class="btn btn-sm btn-outline-danger" asp-controller="PendingInProcesstoQc" asp-action="PendingInProcesstoQc" style="padding:3px;height:30px;width:100px;margin-left:20px;">
                                    <i class="fa-solid fa-rotate fa-fw fa-lg"></i>RESET
                                </a>
                            </div>
                            <div class="col-sm-2 col-md-6 col-lg-4 col-xl-2">
                                <button class="btn btn-sm btn-outline-primary" style="margin-top:15px;height:30px;width:150px;margin-left:20px;" type="button" onclick="CheckDataforQc()">
                                    <i class="fa fa-check-circle" aria-hidden="true"></i> Check Qc
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        <div class="progress my-3 mb-3" style="height: 4px;">
            <div class="progress-bar progress-bar-striped bg-warning" role="progressbar" style="width: 100%" aria-valuenow="100" aria-valuemin="0" aria-valuemax="100"></div>
        </div> <div class="card">
            <div class="card-body overflow-auto pb-0">
                <div class="table-responsive" style="max-height:350px;">
                    <table class="table table-hover table-bordered table-striped" id="GateDataTable" style="background-color:#CEAFCE;">
                        <thead class="bg-gradient card-headerBG text-light small" style="white-space:nowrap" style="background-color:#CEAFCE;">
                            <tr>
                                <th>Chk/Unchk <input id="checkuncheck" class="form-check-input me-1 mt-2" type="checkbox" role="switch" /></th>
                                <th data-columnno="1" data-sortorder="asc" class="sortCol"><span style="padding:5px;margin:5px" class="sort-icon"><i class="fa" aria-hidden="true"></i></span>Prod Slip No</th>
                                <th data-columnno="2" data-sortorder="asc" class="sortCol"><span style="padding:5px;margin:5px" class="sort-icon"><i class="fa" aria-hidden="true"></i></span>New Prod Rework</th>
                                <th data-columnno="3" data-sortorder="asc" class="sortCol"><span style="padding:5px;margin:5px" class="sort-icon"><i class="fa" aria-hidden="true"></i></span>Part Code</th>
                                <th data-columnno="4" data-sortorder="asc" class="sortCol"><span style="padding:5px;margin:5px" class="sort-icon"><i class="fa" aria-hidden="true"></i></span>Item Name</th>
                                <th data-columnno="5" data-sortorder="asc" class="sortCol"><span style="padding:5px;margin:5px" class="sort-icon"><i class="fa" aria-hidden="true"></i></span>Shift Name</th>
                                <th data-columnno="6" data-sortorder="asc" class="sortCol"><span style="padding:5px;margin:5px" class="sort-icon"><i class="fa" aria-hidden="true"></i></span>Sch Qty</th>
                                <th data-columnno="7" data-sortorder="asc" class="sortCol"><span style="padding:5px;margin:5px" class="sort-icon"><i class="fa" aria-hidden="true"></i></span>Prod Qty</th>
                                <th data-columnno="8" data-sortorder="asc" class="sortCol"><span style="padding:5px;margin:5px" class="sort-icon"><i class="fa" aria-hidden="true"></i></span>Prod Ok Qty</th>
                                <th data-columnno="9" data-sortorder="asc" class="sortCol"><span style="padding:5px;margin:5px" class="sort-icon"><i class="fa" aria-hidden="true"></i></span>Prod Entry Id</th>
                                <th data-columnno="10" data-sortorder="asc" class="sortCol"><span style="padding:5px;margin:5px" class="sort-icon"><i class="fa" aria-hidden="true"></i></span>Prod Year Code</th>
                            </tr>
                        </thead>
                        <tbody id="divPendMRNGrid">
                            <tr class="text-center">
                                <td colspan="25" class="text-black-50"><strong>NO DATA YET</strong></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            <center><strong>TOTAL ROWS : <span id="totalRows"></span></strong></center>
        </div>
    </div>
</div>

@section Scripts
{
    <script>

        $(function () {
            var fromDate;
            var toDate;

            var today = new Date();
            var threeMonthsAgo = new Date(today.getTime() - (3 * 30 * 24 * 60 * 60 * 1000));
            var finFromDate = $('#finFromDate').val();
            var finToDate = $('#finToDate').val();
            var dateParts1 = finFromDate.split("/");
            var monthNames = {
                "Jan": "01",
                "Feb": "02",
                "Mar": "03",
                "Apr": "04",
                "May": "05",
                "Jun": "06",
                "Jul": "07",
                "Aug": "08",
                "Sep": "09",
                "Oct": "10",
                "Nov": "11",
                "Dec": "12"
            };

            var formattedDate1 = dateParts1[0] + "/" + monthNames[dateParts1[1]] + "/" + dateParts1[2];
            var dateParts2 = finToDate.split("/");

            var formattedDate2 = dateParts2[0] + "/" + monthNames[dateParts2[1]] + "/" + dateParts2[2];


            $("#FromDate").datepicker({ dateFormat: 'dd/mm/yy' }).datepicker("setDate", formattedDate1);
            $('#ToDate').datepicker({ dateFormat: 'dd/mm/yy' }).datepicker("setDate", formattedDate2);

            $('#ItemName').select2();
            $('#PartCode').select2();
            $('#ProdSlipNo').select2();
            $('#WorkCenter').select2();

            showDetail();
        });

        function showDetail() {
             
            var PartCode = $('#PartCode').find(':selected').text() == '-Select-' ? null : $('#PartCode').find(':selected').text();
            var ItemName = $('#ItemName').find(':selected').text() == '-Select-' ? null : $('#ItemName').find(':selected').text();
            var ProdSlipNo = $('#ProdSlipNo').find(':selected').text() == '-Select-' ? null : $('#ProdSlipNo').find(':selected').text();
            var WorkCenter = $('#WorkCenter').find(':selected').text() == '-Select-' ? null : $('#WorkCenter').find(':selected').text();
            var data = {
                "Flag": "PendingForQc",
                "FromDate": $('#FromDate').val(),
                "ToDate": $('#ToDate').val(),
                "PartCode":PartCode,
                "ItemName" : ItemName,
                "ProdSlipNo": ProdSlipNo,
                "WorkCenter": $('#WorkCenter').val()
            }

            $.ajax({
                url: '@Url.Action("GetDataForPendingInProcess")',
                type: "POST",
                data: data,
                success: function (data) {
                    if (data != null) {
                         
                        var obj = $.parseJSON(data);
                        if (obj.StatusCode == 200 && obj.StatusText == 'Success') {
                            $('#divPendMRNGrid').empty();
                            var i = 1;
                            $.each(obj.Result.Table, function (index, val) {
                                 
                                var html = '';
                                html += '<tr id="TableRow' + i + '" >' +
                                    '<td style="text-align:center;"><input style="background-color: #b2b3f0;" id="AcceptedQtySHA' + i + '" class="form-check-input me-1 mt-2" type="checkbox" role="switch" onchange="CheckacceptedQtySHA(' + i + ');"/></td>' +
                                    '<td id="ProdSlipNo' + i + '">' + val.ProdSlipNo + '</td>' +
                                    '<td>' + val.NewProdRework + '</td>' +
                                    '<td><input id="FGItemCode' + i + '" type="hidden" value="' + val.FGItemCode + '"/>' + val.PartCode + '</td>' +
                                    '<td style="width:150px;" id="FGItemCode' + i + '">' + val.ItemName + '</td>' +
                                    '<td>' + val.ShiftName + '</td>' +
                                    '<td>' + val.SchQty + '</td>' +
                                    '<td>' + val.TotProdQty + '</td>' +
                                    '<td>' + val.FGOKQty + '</td>' +
                                    '<td id="ProdEntryId' + i + '">' + val.ProdEntryId + '</td>' +
                                    '<td id="ProdYearcode' + i + '">' + val.ProdYearcode + '</td>' +
                                    '</tr>'
                                $('#divPendMRNGrid').append(html);
                                $('#TransertoMIRBtn').prop("disabled", false);

                                var count = $('#divPendMRNGrid tr').length;
                                $('#totalRows').text(count);
                                i++;
                            });
                            
                        }
                        else {
                            $('#divPendMRNGrid').empty();
                            var count = $('#divPendMRNGrid tr').length;
                            $('#totalRows').text(count);
                            $('#divPendMRNGrid').append('<tr class="text-center"><td colspan="26" class="text-black-50"><strong>NO DATA FOUND</strong></td></tr>')

                        }
                    }
                },
                error: function (response) {
                    alert(response.responseText);
                },
                failure: function (response) {
                    alert(response.responseText);
                }
            });

        }

        $('#checkuncheck').change(function () {
              
            var rowCount = $('#divPendMRNGrid tr').length;
            if ($('#checkuncheck').is(':checked') == true) {
                for (let i = 1; i <= rowCount; i++) {
                    $('#AcceptedQtySHA' + i).prop('checked', true)
                }
            }
            else {
                for (let i = 1; i <= rowCount; i++) {
                    $('#AcceptedQtySHA' + i).prop('checked', false)
                }
            }
        })

        function CheckacceptedQtySHA(i) {
             
            var checkedtruevalues = [];
            var rowCount = $('#divPendMRNGrid tr').length;
            for (let i = 1; i <= rowCount; i++) {
                checkedtruevalues.push({
                    "checked": $('#AcceptedQtySHA' + i).is(':checked')
                })
            }
             
            var checkedonlytrue = checkedtruevalues.filter(function (item) {
                return item.checked;
            }).length;
            if (rowCount == checkedonlytrue) {
                $('#checkuncheck').prop('checked', true)
            } else {
                $('#checkuncheck').prop('checked', false)
            }
        }

        function CheckDataforQc() {
             
            var GridList = [];
            var rowCount = $('#divPendMRNGrid tr').length;

            for (let i = 1; i <= rowCount; i++) {
                 
                if ($('#AcceptedQtySHA' + i).is(':checked') == true) {
                    GridList.push({
                        "ProdSlipNo": $('#ProdSlipNo' + i).text(),
                        "ProdEntryId": $('#ProdEntryId' + i).text(),
                        "ProdYearCode": $('#ProdYearcode' + i).text(),
                        "FGItemCode": $('#FGItemCode' + i).val()
                    });
                }
            }

            $.ajax({
                url: "@Url.Action("GetDataforQc")",
                type: "POST",
                data: { DisplayPendForQC: JSON.stringify(GridList), Flag: "DisplayForNewEntry", FromDate: $('#FromDate').val(), ToDate: $('#ToDate').val() },
                success: function (data, status, xhr) {
                     ("SUCCESS");
                    var url = '/InProcessQc/Index/?';
                    window.location.href = url;
                },
                error: function (result, status, xhr) {
                    $.notify(result.responseText, "error");
                     (result.responseText);
                }
            });
        }

        $(document).on('select2:select', '#ItemName,#PartCode', function (e) {
             
            var cntId = e.target.id;
            if (cntId == 'ItemName') {
                ItemNameChange(cntId);
            }
            else {
                PartCodeChange(cntId);
            }
        });

        function ItemNameChange(ID) {
            SetPartCodeItemName(ID);
        }

        function PartCodeChange(ID) {

            $.when(SetPartCodeItemName(ID)).done(function () {
            });
        }

        function SetPartCodeItemName(ID) {
            if (!ID) return;
            else {
                var v = $('#' + ID).select2('val');
                if (ID == "PartCode") {
                    $("#ItemName").val(v).trigger("change");
                }

                if (ID == "ItemName") {
                    $("#PartCode").val(v).trigger("change");
                }
            }
        }

        $(document).on("click", ".sortCol", function () {
            var $column = $(this).parent().closest("th");
            var colno = $(this).data('columnno');
            var currentOrder = $(this).data('sortorder');

            $('.sortCol').css('color', 'white');
            if (currentOrder === 'asc') {
                sortTable('GateDataTable', colno, false);
                $(this).data('sortorder', 'desc');
                $(this).css('color', 'yellow');
                //$(this).css('font-size', 'larger');
                $(this).find('i:first').removeClass('fa-arrow-up');
                $(this).find('i:first').addClass('fa-arrow-down');
            } else {
                sortTable('GateDataTable', colno, true);
                $(this).data('sortorder', 'asc');
                $(this).css('color', 'yellow');
                // $(this).css('font-size', 'larger');
                $(this).find('i:first').removeClass('fa-arrow-down');
                $(this).find('i:first').addClass('fa-arrow-up');
            }
        });

        var currentSearchColumn = null;

        $("#search-box").on("keyup", function () {

            var value = $(this).val().toLowerCase();
            $("#divPendMRNGrid tr").filter(function () {
                if (currentSearchColumn !== null) {
                    var columnText = $(this).find('td').eq(currentSearchColumn).text().toLowerCase();
                    $(this).toggle(columnText.indexOf(value) > -1);
                } else {
                    $(this).toggle($(this).text().toLowerCase().indexOf(value) > -1);
                }
            });
        });


        $(document).on("click", "th[data-columnno]", function () {
            currentSearchColumn = $(this).data('columnno');
            $("#search-box").val('').trigger('keyup'); // Reset search box and trigger the search
        });

        $('#checkuncheck').change(function () {

        })

    </script>
}

<style>
    .sort-icon {
        padding: 5px;
        margin: 5px;
        vertical-align: top;
    }

    .ascCol {
        font-size: 15px;
        vertical-align: bottom;
    }

    .descCol {
        font-size: 15px;
        vertical-align: super;
    }
</style>