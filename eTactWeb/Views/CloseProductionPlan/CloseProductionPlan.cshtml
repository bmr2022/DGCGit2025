@model eTactWeb.DOM.Models.CloseProductionPlanModel;
@{
    ViewData["Title"] = "Index";
    Layout = "~/Views/Shared/_LayoutMain.cshtml";
}

<div class="card bg-gradient mb-3 border-light shadow-lg">
    <form id="SParam" asp-action="CloseProductionPlan" asp-controller="CloseProductionPlan" method="post" autocomplete="on" class="form-horizontal">
        <div class="card-header card-headerBG text-light bg-gradient">
            <div class="card-header card-headerBG text-light justify-content-center bg-gradient">
                <h5>
                    <strong>Close ProductionPlan</strong>
                    <span class="d-flex float-end" style="margin-top:-2px;">
                        
                        <div class="row justify-content-between g-2">
                           
                            @if (Model.Mode != "V" && Model.Mode != "SOC" && Model.Mode != "POC")
                            {
                                <div class="col-auto">
                                    <a class="btn btn-secondary btn-sm" onclick="location.href=$('form')[0].action">
                                        <i class="fa fa-refresh fa-fw fa-lg" aria-hidden="true"></i>
                                        REFRESH
                                    </a>
                                </div>

                                

                            }
                        </div>
                    </span>
                </h5>
            </div>
            <div class="card-body bg-light">
                <div class="accordion shadow-lg" id="accordionItemCategory">
                    <div class="accordion-item">
                        <div id="B_ItemCategoryDetail" class="accordion-collapse collapse pnl1 bg-gradient show" aria-labelledby="H_ItemCategoryDetail">
                            <div class="accordion-body">
                                <div class="row g-2">
                                    <input type="hidden" asp-for="MachineName" value="@Environment.MachineName" />
                                    <input type="hidden" value="@Model.Mode" asp-for="Mode" />
                                    <input type="hidden" value="@Model.ActualEntryId" asp-for="ActualEntryId" />
                                    <input type="hidden" value="@Model.ActualEntryByEmpName" asp-for="ActualEntryByEmpName" />
                                    <input type="hidden" value="@Model.EmpId" asp-for="EmpId" />
                                    <div class="col-xl-2 col-lg-3 col-md-3 col-sm-6 col-xs-12" style="width:110px;">
                                        <label class="form-label">From Date</label>
                                        <input asp-for="FromDate" maxlength="10" class="form-control" value="@Model.FromDate" readonly/>
                                    </div>
                                    <div class="col-xl-2 col-lg-3 col-md-4 col-sm-6 col-xs-12" style="width:110px;">
                                        <label class="form-label">To Date</label>
                                        <input asp-for="ToDate" maxlength="10" class="form-control" value="@Model.ToDate" readonly/>
                                    </div>
                            
                                    <div class="col-sm-3 col-md-6 col-lg-4 col-xl-2">
                                        <label asp-for="CloseOpen" class="form-label">Close/Open</label>
                                        <select class="form-select" asp-for="CloseOpen">
                                            <option value="" disabled>-Select-</option>
                                            <option value="Close" selected>Close</option>
                                            <option value="Open">Open</option>
                                        </select>
                                    </div>
                                    <div class="col-xl-2 col-lg-3 col-md-4 col-sm-6 col-xs-12">
                                        <label asp-for="ItemName" class="form-label">Item Name</label>
                                        <select class="form-control" asp-for="ItemName">
                                            <option value="@Model.ItemCode">-Select-</option>
                                            @if (Model.Mode == "U" || Model.Mode == "V")
                                            {
                                                <option value="@Model.ItemCode" selected>@Model.ItemName</option>
                                            }
                                        </select>
                                    </div>
                                    <div class="col-xl-2 col-lg-3 col-md-4 col-sm-6 col-xs-12">
                                        <label asp-for="ProdPlanNo" class="form-label">Plan No</label>
                                        <select class="form-control"  asp-for="ProdPlanNo">
                                            <option value="@Model.ProdPlanNo">-Select-</option>
                                            @if (Model.Mode == "U" || Model.Mode == "V")
                                            {
                                                <option value="@Model.ProdPlanNo" selected>@Model.ProdPlanNo</option>
                                            }
                                        </select>
                                    </div>
                                    <div class="col-xl-2 col-lg-3 col-md-4 col-sm-6 col-xs-12" style="width:100px;">
                                        <label asp-for="ReportType" class="form-label">Report Type</label>
                                        <select class="form-control" asp-for="ReportType">
                                            <option value="">-Select-</option>
                                            <option value="SUMMARY" selected>SUMMARY</option>
                                            <option value="DETAIL">DETAIL</option>

                                        </select>
                                    </div>
                                   
                                        <button class="btn btn-sm btn-outline-info" type="button" style="margin-top:25px;height:30px;width:100px;" onclick="GetSearchData();">
                                            <i class="fa-solid fa-magnifying-glass fa-fw fa-lg"></i>SEARCH
                                        </button>
                                    <button class="btn btn-sm btn-outline-success" style="margin-top:25px;height:30px;width:100px;margin-left:5px;" type="button" id="sendToExcel">
                                            <i class="fa-solid fa-upload fa-fw fa-lg "></i>EXCEL
                                        </button>
                                    <a class="btn btn-sm btn-outline-danger" style="margin-top:25px;height:30px;width:100px;margin-left:5px;" asp-controller="CloseProductionPlan" asp-action="CloseProductionPlan">
                                            <i class="fa-solid fa-rotate fa-fw fa-lg"></i>RESET
                                    </a>

                                    
                                    @* <div class="col-xl-2 col-lg-3 col-md-4 col-sm-6 col-xs-12" style="margin-top:28px;">
                                        <button type="button" class="btn btn-sm btn-outline-danger " id="GridButton">
                                            <i class="fa-solid fa-angles-down fa-fw fa-lg"></i> ADD TO GRID
                                        </button>
                                    </div> *@

                                    <div asp-validation-summary="ModelOnly" class="text-danger"></div>
                                </div>
                                <div class="row">
                                    <div class="col-xl-3 col-lg-3 col-md-6 col-sm-6 col-xs-12 d-flex align-items-center">
                                        <input id="approvePO" type="checkbox" style="margin-left:30px;width:15px !important;height:15px !important;" />
                                        <label class="form-label" id="planLabel" style="display: inline-block;"><strong></strong></label>
                                    </div>
                                    <div class="col-xl-2 col-lg-3 col-md-3 col-sm-6 col-xs-12" >
                                        <label class="form-label">Approve Date</label>
                                        <input asp-for="EntryDate" class="form-control" readonly />
                                    </div>
                                    <div class="col-xl-2 col-lg-3 col-md-3 col-sm-6 col-xs-12">
                                        <label class="form-label">Approved By</label>
                                        <input type="hidden" asp-for='EmpId' />
                                        <input asp-for="EntryByEmpName" style="display: inline-block;" readonly class="form-control" />
                                    </div>
                                    <div class="col-xl-1 col-lg-1 col-md-2 col-sm-2 col-xs-12 d-flex align-items-center" style="margin-top:22px;">
                                        <div class="col-auto">
                                            <button type="submit" class="btn btn-primary btn-sm submitBTN" style="display: none;">
                                                <i class="fa-solid fa-chevron-circle-right"></i> SUBMIT
                                            </button>
                                        </div>
                                    </div>
                                </div>

                            </div>
                                   
                                    
                               
                            
                        </div>
                    </div>
                </div>
            </div>
            <div class="card-body pb-0 pt-0">
                <div class="progress" style="height: 4px;">
                    <div class="progress-bar progress-bar-striped bg-info" role="progressbar" style="width: 100%" aria-valuenow="100" aria-valuemin="0" aria-valuemax="100"></div>
                </div>
            </div>
            <div class="card-body" >
                <div class="card overflow-auto">
                    <div class="card-body" id="divDashboardGrid" >
                        <partial name="_CloseProductionPlanSummaryGrid" />
                    </div>
                </div>
            </div>
       </div>
    </form>
</div>




@section Scripts {
    <script>

        $('.submitBTN').click(function (e) {
             
            e.preventDefault();
            $('#SParam').submit();
        });
        document.addEventListener("DOMContentLoaded", function () {
            GetDetailData();
        });
        $('#ReportType').on('change', function () {
            GetDetailData();
        });
        $(document).ready(function () {
            $('#CloseOpen').rules("remove", "required");
            $('#CloseOpen').select2();
            $('#ProdPlanNo').rules("remove", "required");
            $('#ProdPlanNo').select2();
             $('#ItemName').rules("remove", "required");
            $('#ItemName').select2();
             

            var currentDate = new Date();
            var firstDayOfMonth = new Date(currentDate.getFullYear(), currentDate.getMonth(), 1);
            function formatDate(date) {
                var day = ("0" + date.getDate()).slice(-2);
                var monthNames = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
                var month = monthNames[date.getMonth()];
                var year = date.getFullYear();
                return day + "/" + month + "/" + year;
            }
            $('#FromDate').datepicker({ dateFormat: 'dd/M/yy' }).datepicker("setDate", firstDayOfMonth);
            $('#EntryDate').datepicker({ dateFormat: 'dd/M/yy' }).datepicker("setDate", firstDayOfMonth);
            $('#ToDate').datepicker({ dateFormat: 'dd/M/yy' }).datepicker("setDate", currentDate);
            checkOpenClose();

            $("#CloseOpen").change(function () {
                checkOpenClose();
            });
             
            function updatePlanLabel(CloseOpen) {
                 
                if (CloseOpen === "Open") {
                    $('#planLabel').html('<strong>Click to Open Production Plan</strong>');
                } else if (CloseOpen === "Close") {
                    $('#planLabel').html('<strong>Click to Close Production Plan</strong>');
                }
            }

            // Initial setup: Update the label based on the current value of the ReportType dropdown
            var initialReportType = $('#CloseOpen').val();
            updatePlanLabel(initialReportType);

            // Update the label when the ReportType dropdown value changes
            $('#CloseOpen').on('change', function () {
                var CloseOpen = $(this).val();  // Get the selected value
                updatePlanLabel(CloseOpen);      // Update the label text
            });

        });
        $(document).on('click', '[id^="submitCheckbox-"]', function () {
            // Check if any checkbox is checked
            var anyChecked = $('[id^="submitCheckbox-"]:checked').length > 0;

            if (anyChecked) {
                // If any checkbox is checked, show the submit button
                $('.submitBTN').show();
            } else {
                // If no checkboxes are checked, hide the submit button
                $('.submitBTN').hide();
            }
        });
       
        function checkOpenClose() {
            var status = $("#CloseOpen").val();

            if (status === "Open") {
                GetOpenItemName();
                GetOpenPlanNo();
            } else if (status === "Close") {
                GetCloseItemName();
                GetClosePlanNo();
            }
        }
        function GetDetailData() {

            var data = $('#SParam').serialize();
             ("Data:",data);
            $.ajax({
                url: '@Url.Action("GetDetailData")',
                type: "POST",
                data: $('#SParam').serializeArray(),
                async: false,
                success: function (data) {
                    $('#divDashboardGrid').empty().append(data);
                    if ($('#gateDashboardtable').val() == '') {
                        var dashGrid = 0;
                        $('#totalRows').text(dashGrid);
                    } else {
                        var dashGrid = $('#gateDashboardtable tr').length;
                        $('#totalRows').text(dashGrid);
                    }
                },
                error: function (response) {
                    alert(response.responseText);
                },
                failure: function (response) {
                    alert(response.responseText);
                }
            });
        }
        function GetOpenItemName() {
            var EmpId=$("#EmpId").val();
            var ActualEntryId = $("#ActualEntryId").val();
            $.ajax({
                url: '@Url.Action("GetOpenItemName", "CloseProductionPlan")',
                type: 'POST',
                data: {
                    EmpId: EmpId,
                    ActualEntryId: ActualEntryId,
                },
                async: false,
                success: function (response, status, error) {

                    var itemNameDropdown = $('#ItemName');
                    var obj = $.parseJSON(response);
                    itemNameDropdown.empty();
                    itemNameDropdown.append('<option value="">--Select--</option>');


                    $.each(obj.Result, function (index, item) {

                        itemNameDropdown.append('<option value="' + item.Itemcode + '">' + item.ItemName + '</option>');
                    });
                    if ($('#Mode').val() == "U" || $('#Mode').val() == "V") {

                        var itemCode = '@Model.ItemCode';
                        $('#ItemName').val(itemCode).trigger("change");
                        $('#ItemName').val(itemCode);
                    }
                },
                error: function (xhr, status, error) {
                    alert('Failed to load groups.');
                }
            });


        }

        function GetOpenPlanNo() {
            var EmpId = $("#EmpId").val();
            var ActualEntryId = $("#ActualEntryId").val();
            $.ajax({
                url: '@Url.Action("GetOpenPlanNo", "CloseProductionPlan")',
                type: 'POST',
                data: {
                    EmpId: EmpId,
                    ActualEntryId: ActualEntryId,
                },
                async: false,
                success: function (response, status, error) {

                    var planNoDropdown = $('#ProdPlanNo');
                    var obj = $.parseJSON(response);
                    planNoDropdown.empty();
                    planNoDropdown.append('<option value="">--Select--</option>');


                    $.each(obj.Result, function (index, prodPlanNo) {

                        planNoDropdown.append('<option value="' + prodPlanNo.WONO + '">' + prodPlanNo.WONO + '</option>');
                    });
                    if ($('#Mode').val() == "U" || $('#Mode').val() == "V") {

                        var prodPlanNo = '@Model.ProdPlanNo';
                        $('#ProdPlanNo').val(prodPlanNo).trigger("change");
                        $('#ProdPlanNo').val(prodPlanNo);
                    }
                },
                error: function (xhr, status, error) {
                    alert('Failed to load groups.');
                }
            });


        }
        function GetCloseItemName() {
            var EmpId = $("#EmpId").val();
            var ActualEntryId = $("#ActualEntryId").val();
            $.ajax({
                url: '@Url.Action("GetCloseItemName", "CloseProductionPlan")',
                type: 'POST',
                data: {
                    EmpId: EmpId,
                    ActualEntryId: ActualEntryId,
                },
                async: false,
                success: function (response, status, error) {

                    var itemNameDropdown = $('#ItemName');
                    var obj = $.parseJSON(response);
                    itemNameDropdown.empty();
                    itemNameDropdown.append('<option value="">--Select--</option>');


                    $.each(obj.Result, function (index, item) {

                        itemNameDropdown.append('<option value="' + item.Itemcode + '">' + item.ItemName + '</option>');
                    });
                    if ($('#Mode').val() == "U" || $('#Mode').val() == "V") {

                        var itemCode = '@Model.ItemCode';
                        $('#ItemName').val(itemCode).trigger("change");
                        $('#ItemName').val(itemCode);
                    }
                },
                error: function (xhr, status, error) {
                    alert('Failed to load groups.');
                }
            });


        }

        function GetClosePlanNo() {
            var EmpId = $("#EmpId").val();
            var ActualEntryId = $("#ActualEntryId").val();
            $.ajax({
                url: '@Url.Action("GetClosePlanNo", "CloseProductionPlan")',
                type: 'POST',
                data: {
                    EmpId: EmpId,
                    ActualEntryId: ActualEntryId,
                },
                async: false,
                success: function (response, status, error) {

                    var planNoDropdown = $('#ProdPlanNo');
                    var obj = $.parseJSON(response);
                    planNoDropdown.empty();
                    planNoDropdown.append('<option value="">--Select--</option>');


                    $.each(obj.Result, function (index, prodPlanNo) {

                        planNoDropdown.append('<option value="' + prodPlanNo.WONO + '">' + prodPlanNo.WONO + '</option>');
                    });
                    if ($('#Mode').val() == "U" || $('#Mode').val() == "V") {

                        var prodPlanNo = '@Model.ProdPlanNo';
                        $('#ProdPlanNo').val(prodPlanNo).trigger("change");
                        $('#ProdPlanNo').val(prodPlanNo);
                    }
                },
                error: function (xhr, status, error) {
                    alert('Failed to load groups.');
                }
            });


        }
        
       
        function TotalNoOfRows() {
            var Row = $('#divStockGrid tr').length;
            var tdCount = $('#divStockGrid tr td').length;
            if (tdCount >= 1) {
                $('#lblTotalNoOfBelowItems').text(Row);
            } else {
                $('#lblTotalNoOfBelowItems').text(0);
            }
        }

        function CheckBeforeUpdate() {
            $.ajax({
                url: '@Url.Action("CheckBeforeUpdate")',
                type: "POST",
                data: { "Type": $('#Entry_id').val() },
                success: function (data) {
                     ("success");
                    if (data != null) {
                        var obj = $.parseJSON(data);
                        if (obj.Result != null) {
                            if (obj.Result.Table[0].Column1 > 0) {
                                $.notify("You cannot update this Category as Item with this category already exists", "error");
                            }
                            else {
                                $('form').submit();
                            }
                        }
                    }
                },
                error: function (response) {
                    alert(response.responseText);
                },
                failure: function (response) {
                    alert(response.responseText);
                }
            });
        }
        
        $('#GridButton').click(function (e) {
            e.preventDefault();

            var SchData = {
                "MainItemCode": $('#MainPartCode').val(),
                "MainItemName": $('#MainItemName').val(),
                "AlternateItemCode": $('#AltPartCode').val(),
                "AltItemName": $('#AltItemName').val(),
                "MainPartCode": $('#MainPartCode').find(":selected").text(),
                "MainItemName": $('#MainItemName').find(":selected").text(),
                "AltPartCode": $('#AltPartCode').find(":selected").text(),
                "AltItemName": $('#AltItemName').find(":selected").text(),
            };
             (SchData);
            $.ajax({
                type: "POST",
                url: '@Url.Action("AddAlternateItemMasterDetail", "AlternateItemMaster")',
                data: { model: SchData },
                success: function (result, status, xhr) {
                    if (xhr.status == 200 && xhr.responseText == result) {

                        $('#divStockGrid').html(result);
                        TotalNoOfRows();
                    } else if (xhr.status == 207) {
                        $.notify('Duplicate Item...!', "info");
                    }
                },
                error: function () {
                    $.notify('Something Went Wrong, Please Try Again.', "error");
                }
            });
        });
        var isEditAllowed = "false";

        // function DeleteItemRow(SrNO) {

        //     return new Promise((resolve, reject) => {
        //         $.ajax({
        //             url: '@Url.Action("DeleteItemRow")',
        //             type: "POST",
        //             data: { "SrNO": SrNO, "Mode": $('#Mode').val() },
        //             success: function (data) {
        //                 $('#divStockGrid').html(data);
        //                 $.notify("Item Deleted from Grid", "info");
        //                 isEditAllowed = "true";
        //                 resolve();
        //             },
        //             error: function (response) {
        //                 reject(response.responseText);
        //             }


        //         });
        //     }
        // }
        var editingNow = false;
        function EditItemRow(SrNO) {

            if (editingNow == false) {
                return new Promise((resolve, reject) => {
                    $.ajax({
                        url: '@Url.Action("EditItemRow")',
                        type: "POST",
                        data: { "SrNO": SrNO, "Mode": $('#Mode').val() },
                    })
                        .done(function (data, status, xhr) {
                            editingNow = true;
                            var obj = $.parseJSON(data);
                            DeleteItemRow(SeqNo)
                                .then(() => {
                                    $('#MainPartCode').val(obj[0].MainPartCode).trigger('change');
                                    $('#MainItemName').val(obj[0].MainItemName).trigger('change');
                                    $('#AltPartCode').val(obj[0].AltPartCode).trigger('change');
                                    $('#AltItemName').val(obj[0].AltItemName).trigger('change');
                                    var currentSrNo = $('#SrNO').val();
                                    var newSrNo = obj[0].SrNO;
                                    if (currentSrNo !== newSrNo) {
                                        $('#SrNO').val(newSrNo).trigger('change');
                                    }

                                })
                                .catch((error) => {
                                    reject(error);
                                });

                        })
                        .fail(function (response) {
                            reject(response.responseText);
                        });
                    $.notify("Item Updated from Grid", "info");
                });
            }
            else {
                $.notify("Cannot edit as one item is already on above edit grid", "error");
            }
        }

        function PressBack() {

            sessionStorage.setItem('FromDateBack', $('#FromDateBack').val());
            sessionStorage.setItem('ToDateBack', $('#ToDateBack').val());
            sessionStorage.setItem('GroupNameBack', $('#GroupNameBack').val());
            sessionStorage.setItem('LedgerNameBack', $('#LedgerNameBack').val());
            sessionStorage.setItem('OpeningForYearBack', $('#OpeningForYearBack').val());
            sessionStorage.setItem('PreviousAmountBack', $('#PreviousAmountBack').val());
            sessionStorage.setItem('DrCrBack', $('#DrCrBack').val());
            sessionStorage.setItem('GlobalSearchBack', $('#GlobalSearchBack').val());

            window.history.back();
        }



    </script>


}


<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>


