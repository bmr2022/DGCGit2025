$(document).ready(function () {
    //FOR LAYOUT HEADER (blocking navigations acc to userrights)
    CheckPermissionForHeaders();
    let pageTitle = $('title').text();
    if (pageTitle.indexOf('SaleInvoice') === 0 || pageTitle.indexOf('Purchase Rejection') === 0) {
        $('#AdjDrCr').val("DR");
    } else {
        $('#AdjDrCr').val("CR"); // default or empty
    }
    CalculateAdjAmt('NetTotal');
    //$('#TxPartCode').select2();
    //$('#TxItemCode').select2();
});
const PageName = location.pathname;
$(function () {
    window.setInterval(function () {
        var DT = new Date().toLocaleString();
        $('#_DateTime').text("Date/Time : " + DT);
    }, 1000);
});

function back() {
    window.history.back();
}


(function () {
    'use strict'
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
    tooltipTriggerList.forEach(function (tooltipTriggerEl) {
        new bootstrap.Tooltip(tooltipTriggerEl)
    })
})()


function ViewFile(URL) {
    if (URL) {
        window.open(URL, '_blank');
    }
}


function Reload() {
    var _url = this.location.href;
    location.href = _url;
}


function ShowErrorFld(ID) {
    $('#' + ID + ' button').attr('style', 'background-color: red !important');
    $('#' + ID + ' small').css('color', 'chartreuse');
    $('#' + ID + ' small').html('All Highlighted Fields are Mandatory');
}


function HideErrorFld(ID) {
    $('#' + ID + ' button').css('background-color', '#127387');
    $('#' + ID + ' small').css('color', 'white');
    $('#' + ID + ' small').html('');
}

function ShowErrorFldwithAddtoGrid(ID) {
    $('#' + ID).attr('style', 'background-color: red !important');
    $('#' + ID + ' small').css('color', 'chartreuse');
    $('#' + ID + ' small').html('All Highlighted Fields are Mandatory');
}


function HideErrorFldwithAddtoGrid(ID) {
    $('#' + ID).css('background-color', '#127387');
    $('#' + ID + ' small').css('color', 'white');
    $('#' + ID + ' small').html('');
}

function AddErrorCls(ID) {
    $('#' + ID).addClass('is-invalid');
}


function RemoveErrorCls(ID) {
    $('#' + ID).removeClass('is-invalid');
}

function AddSelectErrorCls(elementId) {
    const select2Container = $('#' + elementId).next('.select2-container');
    if (select2Container.length) {
        select2Container.addClass('error-class');
    } else {
        console.error('Select2 container not found for element ID:', elementId);
    }
}

function RemoveSelectErrorCls(elementId) {
    const select2Container = $('#' + elementId).next('.select2-container');
    if (select2Container.length) {
        select2Container.removeClass('error-class');
    } else {
        console.error('Select2 container not found for element ID:', elementId);
    }
}

async function AutoComplete(Schema, CtrlID, ColName, SelectFunc) {
    $("#" + CtrlID).autocomplete({
        source: await function (request, response) {
            $.ajax({
                url: '/Home/AutoComplete',
                type: "POST",
                data: { "Schema": Schema, "ColName": ColName, "prefix": request.term },
                success: function (data) {
                    response($.map(data, function (key, value) {
                        return key.text;
                    }));
                },
                error: function (response) {
                    $.notify(response.responseText, { position: "top center", className: "error" });
                },
                failure: function (response) {
                    $.notify(response.responseText, { position: "top center", className: "error" });
                }
            });
        },
        select: function (e, i) {
            $("#" + SelectFunc).val(i.item.value);
        },
        minLength: 1
    });
}

function sortTable(tableId, columnIndex, ascending) {
    var table = $('#' + tableId);
    var rows = table.find('tbody tr').toArray();

    rows.sort(function (a, b) {
        var aValue = $(a).find('td').eq(columnIndex).text().trim();
        var bValue = $(b).find('td').eq(columnIndex).text().trim();
        var aNumeric = !isNaN(parseFloat(aValue));
        var bNumeric = !isNaN(parseFloat(bValue));
        var aDate = parseDate(parseDateToFormat(aValue));
        var bDate = parseDate(parseDateToFormat(bValue));

        if (aDate && bDate) {
            if (ascending) {
                return aDate - bDate;
            } else {
                return bDate - aDate;
            }
        } else if (aNumeric && bNumeric) {
            if (ascending) {
                return parseFloat(aValue) - parseFloat(bValue);
            } else {
                return parseFloat(bValue) - parseFloat(aValue);
            }
        }
        else {
            if (ascending) {
                return aValue.localeCompare(bValue);
            } else {
                return bValue.localeCompare(aValue);
            }
        }
    });

    $.each(rows, function (index, row) {
        $(row).appendTo(table);
    });
}

function parseDate(dateString) {
    var parts = dateString.split("/");
    var parsedDate = new Date(parts[2], parts[1] - 1, parts[0]);

    if (isNaN(parsedDate.getTime())) {
        return null;
    } else {
        return parsedDate;
    }
}

//function parseDateToFormat(inputDate) {
//    const dateFormats = [
//        /\b(\d{1,2})[-/](\d{1,2})[-/](\d{4})\b/,  // dd/MM/yyyy or MM/dd/yyyy
//        /\b(\d{4})[-/](\d{1,2})[-/](\d{1,2})\b/,  // yyyy/MM/dd or yyyy-MM-dd
//        /\b(\d{1,2})[/](\w{3})[/](\d{4})\b/,      // dd/Mon/yyyy
//        /\b(\d{1,2})[\/](\d{1,2})[\/](\d{2})\b/,  // MM/dd/yy
//        /\b(\d{1,2})-([A-Za-z]{3})-(\d{2})\b/,    // dd-MMM-yy
//        /\b(\d{1,2})-([A-Za-z]{3})-(\d{4})\b/     // dd-MMM-yyyy
//    ];

//    inputDate = inputDate.trim();
//    let day, month, year;

//    for (const format of dateFormats) {
//        const match = inputDate.match(format);

//        if (match) {
//            if (format === dateFormats[0]) {
//                // Determine if it's dd/MM/yyyy or MM/dd/yyyy by checking if the first number is > 12
//                if (parseInt(match[1]) > 12) {
//                    [, day, month, year] = match; // dd/MM/yyyy
//                } else {
//                    [, month, day, year] = match; // MM/dd/yyyy
//                }
//            } else if (format === dateFormats[1]) {
//                [, year, month, day] = match; // yyyy/MM/dd
//            } else if (format === dateFormats[2]) {
//                [, day, month, year] = match; // dd/Mon/yyyy
//            } else if (format === dateFormats[3]) {
//                [, month, day, year] = match; // MM/dd/yy
//                year = `20${year}`; // Convert 2-digit year to 4-digit year
//            } else if (format === dateFormats[4]) {
//                [, day, month, year] = match; // dd-MMM-yy
//                year = `20${year}`; // Convert 2-digit year to 4-digit year
//            } else if (format === dateFormats[5]) {
//                [, day, month, year] = match; // dd-MMM-yyyy
//            }
//            break;
//        }
//    }

//    // Convert month abbreviations to numeric format
//    if (month && isNaN(month)) {
//        const monthAbbreviations = {
//            Jan: '01', Feb: '02', Mar: '03',
//            Apr: '04', May: '05', Jun: '06',
//            Jul: '07', Aug: '08', Sep: '09',
//            Oct: '10', Nov: '11', Dec: '12'
//        };
//        month = monthAbbreviations[month];
//    }

//    if (!day || !month || !year) {
//        throw new Error("Invalid date format");
//    }

//    return `${day}/${month}/${year}`;
//}


//sumu sumu
//function parseDateToFormat(inputDate) {

//    inputDate = inputDate.trim();
//    const dateFormats = [
//        /\b(\d{1,2})[-/](\d{1,2})[-/](\d{4})\b/,     // dd/MM/yyyy
//        /\b(\d{4})[-/](\d{1,2})[-/](\d{1,2})\b/,     // yyyy/MM/dd
//        /\b(\d{1,2})[/](\w{3})[/](\d{4})\b/,         // dd/Mon/yyyy
//        /\b(\d{1,2})[\/](\d{1,2})[\/](\d{2})\b/,     // MM/dd/yy
//        /\b(\d{1,2})-([A-Za-z]{3})-(\d{2})\b/,       // dd-MMM-yy
//        /\b(\d{1,2})-([A-Za-z]{3})-(\d{4})\b/,        // dd-MMM-yyyy
//        /\b(\d{1,2})[-/](\d{1,2})[-/](\d{4})[ ](\d{1,2}):(\d{2}):(\d{2})[ ]?(AM|PM|am|pm)?\b/,
//        /\b(\d{1,2})\/([A-Za-z]{3})\/(\d{4})\b/   // dd/MMM/yyyy
//    ];

//    let day, month, year;

//    for (const format of dateFormats) {
//        const match = inputDate.match(format);

//        if (match) {
//            if (format === dateFormats[0]) {
//                [, day, month, year] = match; // Force dd/MM/yyyy
//            } else if (format === dateFormats[1]) {
//                [, year, month, day] = match; // yyyy/MM/dd
//            } else if (format === dateFormats[2]) {
//                [, day, month, year] = match; // dd/Mon/yyyy
//            } else if (format === dateFormats[3]) {
//                [, month, day, year] = match; // MM/dd/yy
//                year = `20${year}`;
//            } else if (format === dateFormats[4]) {
//                [, day, month, year] = match; // dd-MMM-yy
//                year = `20${year}`;
//            } else if (format === dateFormats[5]) {
//                [, day, month, year] = match; // dd-MMM-yyyy
//            }
//            break;
//        }
//    }

//    if (month && month.length === 3) {
//        const monthAbbreviations = {
//            Jan: '01', Feb: '02', Mar: '03',
//            Apr: '04', May: '05', Jun: '06',
//            Jul: '07', Aug: '08', Sep: '09',
//            Oct: '10', Nov: '11', Dec: '12'
//        };
//        month = monthAbbreviations[month];
//    }

//    const formattedDate = `${day}/${month}/${year}`;
//    return formattedDate;
//}
function formatDateTo_ddMMMyyyy(date) {
    const day = String(date.getDate()).padStart(2, '0');
    const monthNames = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
    const month = monthNames[date.getMonth()];
    const year = date.getFullYear();
    return `${day}/${month}/${year}`;
}
function parseDateToFormatnew(inputDate) {
    // Remove time part if present
    inputDate = inputDate.trim();
    const datePart = inputDate.split(' ')[0]; // "mm/dd/yyyy"

    // Split into parts
    const [mm, dd, yyyy] = datePart.split('/');

    // Create a Date object (month is 0-based, so subtract 1)
    const jsDate = new Date(parseInt(yyyy), parseInt(mm) - 1, parseInt(dd));

    // Return the Date object (datepicker can handle it)
    return jsDate;
}
//function parseDateToFormat(inputDate) {
//    if (!inputDate || typeof inputDate !== 'string') return '';

//    // Extract only the date part before time
//    const datePart = inputDate.trim().split(' ')[0]; // "9/04/2025"

//    const [day, month, year] = datePart.split('/');

//    if (!day || !month || !year) return '';

//    // Pad day and month to 2 digits
//    const formattedDay = String(day).padStart(2, '0');
//    const formattedMonth = String(month).padStart(2, '0');

//    return `${formattedDay}/${formattedMonth}/${year}`;
//}



//function parseDateToFormat(inputDate) {
//    
//    inputDate = inputDate.trim();
//    const dateFormats = [
//        /\b(\d{1,2})[-/](\d{1,2})[-/](\d{4})\b/, // dd/MM/yyyy or MM/dd/yyyy (handled later)
//        /\b(\d{4})[-/](\d{1,2})[-/](\d{1,2})\b/, // yyyy/MM/dd
//        /\b(\d{1,2})[/](\w{3})[/](\d{4})\b/, // dd/Mon/yyyy
//        /\b(\d{1,2})[\/](\d{1,2})[\/](\d{2})\b/, // MM/dd/yy or dd/MM/yy (handled later)
//        /\b(\d{1,2})-([A-Za-z]{3})-(\d{2})\b/, // dd-MMM-yy
//        /\b(\d{1,2})-([A-Za-z]{3})-(\d{4})\b/, // dd-MMM-yyyy
//        /\b(\d{1,2})[-/](\d{1,2})[-/](\d{4})[ ](\d{1,2}):(\d{2}):(\d{2})[ ]?(AM|PM|am|pm)?\b/,
//        /\b(\d{1,2})\/([A-Za-z]{3})\/(\d{4})\b/gi, // dd/MMM/yyyy
//        /\b(\d{1,2})\/(\d{1,2})\/(\d{4})\b/, // mm/dd/yyyy
//        /\b(\d{1,2})\/(\d{1,2})\/(\d{4}) (\d{1,2}):(\d{2}):(\d{2}) (AM|PM|am|pm)\b/ // mm/dd/yyyy HH:MM:ss tt
//    ];

//    let day, month, year;

//    for (const format of dateFormats) {
//        const match = inputDate.match(format);

//        if (match) {
//            if (format === dateFormats[0]) {
//                // Check if the first part is > 12 (likely day)
//                if (parseInt(match[1]) > 12) {
//                    [, day, month, year] = match; // dd/MM/yyyy
//                } else {
//                    [, month, day, year] = match; // mm/dd/yyyy
//                }
//            } else if (format === dateFormats[1]) {
//                [, year, month, day] = match; // yyyy/MM/dd
//            } else if (format === dateFormats[2]) {
//                [, day, month, year] = match; // dd/Mon/yyyy
//            } else if (format === dateFormats[3]) {
//                // Check if first part is > 12 (likely month)
//                if (parseInt(match[1]) > 12) {
//                    [, day, month, year] = match; // dd/MM/yy
//                } else {
//                    [, month, day, year] = match; // MM/dd/yy
//                }
//                year = `20${year}`;
//            } else if (format === dateFormats[4]) {
//                [, day, month, year] = match; // dd-MMM-yy
//                year = `20${year}`;
//            } else if (format === dateFormats[5]) {
//                [, day, month, year] = match; // dd-MMM-yyyy
//            } else if (format === dateFormats[8]) { // mm/dd/yyyy
//                [, month, day, year] = match;
//            } else if (format === dateFormats[9]) { // mm/dd/yyyy HH:MM:ss tt
//                [, month, day, year] = match;
//            }
//            break;
//        }
//    }

//    // Create a Date object and format it as dd/mm/yyyy
//    const date = new Date(year, month - 1, day);
//    const formattedDay = String(date.getDate()).padStart(2, '0');
//    const formattedMonth = String(date.getMonth() + 1).padStart(2, '0');
//    const formattedYear = date.getFullYear();

//    return `${formattedDay}/${formattedMonth}/${formattedYear}`;
//}

function parseDateToFormat(inputDate) {

    inputDate = inputDate.trim();

    let parsedDate = new Date(inputDate);


    const monthsMap = {
        Jan: 1, Feb: 2, Mar: 3, Apr: 4, May: 5, Jun: 6,
        Jul: 7, Aug: 8, Sep: 9, Oct: 10, Nov: 11, Dec: 12
    };

    const dateFormats = [
        { regex: /^(\d{1,2})\/(\d{1,2})\/(\d{4}) \d{1,2}:\d{2}:\d{2} (AM|PM)$/i, type: 'mdy' }, // MM/dd/yyyy hh:mm:ss AM/PM
        { regex: /\b(\d{1,2})[-/](\d{1,2})[-/](\d{4})\b/, type: 'dmyOrMdy' }, // dd/MM/yyyy
        { regex: /^(\d{1,2})\/(\d{1,2})\/(\d{4})$/, type: 'mdy' }, // MM/dd/yyyy
        //{ regex: /\b(\d{1,2})[-/](\d{1,2})[-/](\d{4})\b/, type: 'dmyOrMdy' }, // dd/MM/yyyy or MM/dd/yyyy
        { regex: /\b(\d{4})[-/](\d{1,2})[-/](\d{1,2})\b/, type: 'ymd' }, // yyyy/MM/dd
        { regex: /\b(\d{1,2})[/](\w{3})[/](\d{4})\b/, type: 'dMonY' }, // dd/Mon/yyyy
        { regex: /\b(\d{1,2})[\/](\d{1,2})[\/](\d{2})\b/, type: 'dmyShort' }, // dd/MM/yy or MM/dd/yy
        { regex: /\b(\d{1,2})-([A-Za-z]{3})-(\d{2})\b/, type: 'dMonYShort' }, // dd-Mon-yy
        { regex: /\b(\d{1,2})-([A-Za-z]{3})-(\d{4})\b/, type: 'dMonYFull' }, // dd-Mon-yyyy
        { regex: /\b(\d{1,2})[-/](\d{1,2})[-/](\d{4}) (\d{1,2}):(\d{2}):(\d{2}) ?(AM|PM|am|pm)?\b/, type: 'datetime' }, // dd/MM/yyyy hh:mm:ss AM/PM
        { regex: /\b(\d{1,2})\/([A-Za-z]{3})\/(\d{4})\b/i, type: 'dMonYFull' }, // dd/Mon/yyyy
        { regex: /\b(\d{1,2})\/(\d{1,2})\/(\d{4})\b/, type: 'mdy' }, // MM/dd/yyyy
        { regex: /\b(\d{1,2})\/(\d{1,2})\/(\d{4}) (\d{1,2}):(\d{2}):(\d{2}) (AM|PM|am|pm)\b/, type: 'datetimeMdy' } // MM/dd/yyyy hh:mm:ss AM/PM
    ];

    let day, month, year;

    for (const { regex, type } of dateFormats) {
        const match = inputDate.match(regex);
        if (!match) continue;

        switch (type) {
            case 'dmyOrMdy':
                if (parseInt(match[1]) > 12) {
                    [, day, month, year] = match;
                } else {
                    [, month, day, year] = match;
                }
                break;
            case 'datetimeMdy':
                // Format: "MM/dd/yyyy hh:mm:ss tt" (e.g., "5/27/2025 12:00:00 AM")
                [, month, day, year, hours, minutes, seconds, period] = match;
                break;
            case 'ymd':
                [, year, month, day] = match;
                break;
            case 'dMonY':
            case 'dMonYFull':
                [, day, month, year] = match;
                month = monthsMap[month];
                break;
            case 'dMonYShort':
                [, day, month, year] = match;
                month = monthsMap[month];
                year = `20${year}`;
                break;
            case 'dmyShort':
                if (parseInt(match[1]) > 12) {
                    [, day, month, year] = match;
                } else {
                    [, month, day, year] = match;
                }
                year = `20${year}`;
                break;
            case 'mdy':
                [, month, day, year] = match;
                break;
            case 'datetime':
            case 'datetimeMdy':
                [, month, day, year] = match;
                break;
        }

        // Parse final numbers
        day = parseInt(day);
        month = parseInt(month);
        year = parseInt(year);
        break;
    }

    if (isNaN(day) || isNaN(month) || isNaN(year)) {
        return "Invalid date";
    }

    const date = new Date(year, month - 1, day);
    const formattedDay = String(date.getDate()).padStart(2, '0');
    const formattedMonth = String(date.getMonth() + 1).padStart(2, '0');
    const formattedYear = date.getFullYear();

    //const formattedDay = String(day).padStart(2, '0');
    //const formattedMonth = String(month).padStart(2, '0');
    //const formattedYear = String(year);
    //return `${formattedDay}/${formattedMonth}/${formattedYear}`;

    //return `${formattedDay}/${formattedMonth}/${formattedYear}`;
    return `${String(day).padStart(2, '0')}/${String(month).padStart(2, '0')}/${year}`;
}









function formatCustomDate(date) {
    var monthNames = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
    return ('0' + date.getDate()).slice(-2) + '/' + monthNames[date.getMonth()] + '/' + date.getFullYear();
}

async function AutoCompleteRawMaterial(Schema, CtrlID, ColName, SelectFunc, FromDate, ToDate, ItemCode, StoreId) {
    $("#" + CtrlID).autocomplete({
        source: await function (request, response) {
            $.ajax({
                url: '/Home/AutoComplete',
                type: "POST",
                data: { "Schema": Schema, "ColName": ColName, "prefix": request.term, "FromDate": FromDate, "ToDate": ToDate, "ItemCode": ItemCode, "StoreId": StoreId },
                success: function (data) {
                    response($.map(data, function (key, value) {
                        return key.text;
                    }));
                },
                error: function (response) {
                    $.notify(response.responseText, { position: "top center", className: "error" });
                },
                failure: function (response) {
                    $.notify(response.responseText, { position: "top center", className: "error" });
                }
            });
        },
        select: function (e, i) {
            $("#" + SelectFunc).val(i.item.value);
        },
        minLength: 1
    });
}

function CheckPermissionForHeaders() {

    $.ajax({
        type: "POST",
        url: "/Admin/GetAllUserRights",
        dataType: "json",
        async: false,
        success: function (data, status, error) {

            var RightsGiven = [];
            var FromHeaders = [];

            var obj = $.parseJSON(data);
            if (obj.StatusText === "Fail" && obj.StatusCode === 403) {
                //$.notify(obj.Result[0].Result, { position: "top center", className: "info" });
                return false; // 🚫 stop execution here
            }

            for (var i = 0; i < obj.Result.length; i++) {

                RightsGiven.push(obj.Result[i].MainMenu);
            }

            $(".userRightsPermission").each(function () {
                FromHeaders.push($(this).val());
            });
            FromHeaders = FromHeaders.filter((value, index, self) => {
                return self.indexOf(value) === index;
            });

            RightsGiven = RightsGiven.filter((value, index, self) => {
                return self.indexOf(value) === index;
            });

            // Using jQuery to find elements not common in both arrays
            var notCommonElementsjQuery = $.grep(FromHeaders, function (element) {
                return $.inArray(element, RightsGiven) === -1;
            });
            notCommonElementsjQuery.forEach(function (element) {
                element = element.replaceAll(" ", "");
                //$('.' + element).removeAttr("style").css({ "pointer-events": "none", "color": "gray", "background-color": "#d3d3d3" });
                //$('#' + element).removeAttr("style").css({ "pointer-events": "none", "color": "gray", "background-color": "#d3d3d3" });

                $('.' + element).removeAttr("style").css({ "display": "none" });
                $('#' + element).removeAttr("style").css({ "display": "none" });
                //$('#' + element).addClass("noCursor");

            });
            var commonElements = RightsGiven.filter(function (element) {
                return FromHeaders.includes(element);
            });
            obj.Result.forEach(row => {
                var element = row.MainMenu.replaceAll(" ", "");
                var optSave = row.OptSave;
                var optView = row.OptView;

                if (optSave) {
                    $('#' + element).css({
                        "pointer-events": "",

                    });
                } else {
                    $('#' + element).removeAttr("style").css({
                        "pointer-events": "none",
                        "color": "gray",
                        "background-color": "#d3d3d3"
                    });
                }

                if (optView) {
                    $('.' + element).css({
                        "pointer-events": ""

                    });
                } else {
                    $('.' + element).removeAttr("style").css({
                        "pointer-events": "none",
                        "color": "gray",
                        "background-color": "#d3d3d3"
                    });
                }
            });
        },
        error: function (req, status, error) {
            $.notify(error, { position: "top center", className: "error" });
        }
    }).done(function (req, status, error) {

    });
}

function SetPartCodeItemName(ID) {
    if (!ID) return;
    else {
        var v = $('#' + ID).val();
        var t = $('#' + ID + ' option:selected').text();

        if (ID == "PartCode") {
            v == "" ? $('#ItemCode').val("") : $('#ItemCode').val(v);
        }

        if (ID == "ItemCode") {
            v == "" ? $('#PartCode').val("") : $('#PartCode').val(v);
        }
    }
}
function SetRecScrapPartCodeItemName(ID) {
    if (!ID) return;
    else {
        var v = $('#' + ID).val();
        var t = $('#' + ID + ' option:selected').text();

        if (ID == "RecScrapPartCode") {
            v == "" ? $('#RecScrapItemCode').val("") : $('#RecScrapItemCode').val(v);
        }

        if (ID == "RecScrapItemCode") {
            v == "" ? $('#RecScrapPartCode').val("") : $('#RecScrapPartCode').val(v);
        }
    }
}
function SetRecPartCodeItemName(ID) {
    if (!ID) return;
    else {
        var v = $('#' + ID).val();
        var t = $('#' + ID + ' option:selected').text();

        if (ID == "RecPartCode") {
            v == "" ? $('#RecItemCode').val("") : $('#RecItemCode').val(v);
        }

        if (ID == "RecItemCode") {
            v == "" ? $('#RecPartCode').val("") : $('#RecPartCode').val(v);
        }
    }
}
//******** TAX DETAL *******//

async function SetTxPartItem(ID, NID) {
    if (!ID) return;
    else {
        var v = $('#' + ID).val();
        var t = $('#' + ID + ' option:selected').text();

        v == "" ? $('#' + NID).val("") : $('#' + NID).val(v);
        $('#TxRoundOff').prop('selectedIndex', 0);
    }
}


$('#TxType').change(function () {
    //$('#TxPartCode').prop('selectedIndex', 0).change();
    //$('#TxRoundOff').prop('selectedIndex', 0);
    ClearTax();
    $('.divTax2All').fadeOut();
    if ($(this).val() == "EXPENSES") {
        $('#TxPartCode').prop('disabled', true), $('#TxItemCode').prop('disabled', true);
        $('#TxPercentg').removeClass('is-invalid');
        $('#TxPercentg').val(0).prop('readonly', 'readonly');
        $('#TxAdInTxable').val('Y').prop('disabled', false);
        $('#TxAmount').prop('disabled', false);
        $('#TxRefundable').val('N');
        $('.btnTax4HSN').prop('disabled', true);
        $('.divTax4HSN').fadeOut();
        GetTaxTypeName("EXPENSES");
    }
    else if ($(this).val() != "EXPENSES" && $(this).val() == "TAX") {
        $('.btnTax4HSN').prop('disabled', false);
        $('.divTax4HSN').fadeIn();
        $('#TxPartCode').prop('disabled', false), $('#TxItemCode').prop('disabled', false);
        $('#TxPercentg').val(0).removeAttr('readonly'), $('#TxRefundable').prop('selectedIndex', 0);
        $('#TxAdInTxable').val('').prop('selectedIndex', 0).prop('disabled', false), $('#TxAmount').prop('disabled', true);
        FillTaxType();
        //GetTaxTypeName("TAX");
    }
});

function FillTaxType() {
    $.ajax({
        type: "POST",
        url: "/Tax/FillTaxType",
        data: { "Flag": "FillTaxType" },
        dataType: "json",
        async: false,
        success: function (data, status, error) {

            $('#TxTaxType').empty();
            $('#TxTaxType').append('<option>-Select-</option>');
            $.each(data.txType, function (key, val) {
                $('#TxTaxType').append('<option value="' + val.value + '">' + val.text + '</option>');
            });

            //$('#TxAccountCode').empty();
            //$('#TxAccountCode').append('<option>-Select-</option>');
            //$.each(data.txName, function (key, val) {
            //    $('#TxAccountCode').append('<option value="' + val.value + '">' + val.text + '</option>');
            //});
        },
        error: function (req, status, error) {
            $.notify(error, { position: "top center", className: "error" });
        }
    }).done(function (req, status, error) {

    });
}

//$('#TxTaxType').change(function () {
//    GetTaxAccountName("TAX");
//});

function ClearTax() {
    $('#TxPartCode').prop('selectedIndex', 0).prop('disabled', false).removeClass('is-invalid').change(), $('#TxItemCode').prop('selectedIndex', 0).prop('disabled', false).removeClass('is-invalid'),
        $('#TxTaxType').prop('selectedIndex', 0).removeClass('is-invalid'), $('#TxAccountCode').prop('selectedIndex', 0).removeClass('is-invalid'), $('#TxPercentg').val(0).removeAttr('readonly').removeClass('is-invalid'),
        $('#TxAdInTxable').prop('selectedIndex', 0).prop('disabled', false).removeClass('is-invalid'), $('#TxRoundOff').prop('selectedIndex', 0).removeClass('is-invalid'),
        $('#TxRefundable').prop('selectedIndex', 0).removeClass('is-invalid'), $('#TxOnExp').val('0.00'), $('#TxRemark').val(''), $('#TxAmount').val("0.00").prop('disabled', false).removeClass('is-invalid');
    $('#TotalDiscountPercentage').val('0');
    $('#TotalAmtAftrDiscount').val('0.00');
}


async function GetTaxTypeName(Flag) {
    $.ajax({
        type: "POST",
        url: "/Tax/GetTaxTypeName",
        data: { "Flag": Flag },
        dataType: "json",
        async: false,
        success: function (data, status, error) {
            if (Flag == 'EXPENSES') {
                $('#TxTaxType').empty();
                $('#TxTaxType').append('<option>-Select-</option>');
                $.each(data.txType, function (key, val) {
                    $('#TxTaxType').append('<option value="' + val.value + '">' + val.text + '</option>');
                });
            }

            $('#TxAccountCode').empty();
            $('#TxAccountCode').append('<option>-Select-</option>');
            $.each(data.txName, function (key, val) {
                $('#TxAccountCode').append('<option value="' + val.value + '">' + val.text + '</option>');
            });
        },
        error: function (req, status, error) {
            $.notify(error, { position: "top center", className: "error" });
        }
    }).done(function (req, status, error) {

    });
}

async function GetTaxAccountName(Flag) {
    $.ajax({
        type: "POST",
        url: "/Tax/GetTaxAccountName",
        data: { "Flag": Flag, AccountCode: $('#AccountCode').val(), TaxType: $('#TxTaxType').find(":selected").text(), vendorStateCode: $('#AccountCode').find(':selected').data('state') },
        dataType: "json",
        async: false,
        success: function (data, status, error) {
            $('#TxAccountCode').empty();
            $('#TxAccountCode').append('<option>-Select-</option>');
            $.each(data.txName, function (key, val) {
                $('#TxAccountCode').append('<option value="' + val.value + '">' + val.text + '</option>');
            });
        },
        error: function (req, status, error) {
            $.notify(error, { position: "top center", className: "error" });
        }
    }).done(function (req, status, error) {

    });
}


$('#TxTaxType').change(function () {
    if ($('#TxType').val() == "TAX") {
        if ($(this).prop('selectedIndex') != 0) {
            $('#TxRoundOff').prop('selectedIndex', 0);
            if ($(this).val() !== "25") {
                $('#TxPartCode').removeClass('is-invalid').prop('selectedIndex', 0).change();
                $('#TxPartCode').prop('disabled', true), $('#TxItemCode').removeClass('is-invalid').prop('disabled', true);
                $('#TxAdInTxable').prop('selectedIndex', 0).prop('disabled', false);
                $('#TxRefundable').prop('selectedIndex', 0);
                $('.divTax2All').fadeOut();
            }
            else {
                $('#TxPartCode').prop('disabled', false), $('#TxItemCode').prop('disabled', false);
                $('#TxAdInTxable').val('N').prop('disabled', true);
                $('#TxRefundable').val('Y');
                $('.divTax2All').fadeIn();
            }
            //$.ajax({
            //    type: "POST",
            //    url: "/Tax/GetTaxByType",
            //    data: { "TxType": $(this).find('option:selected').text() },
            //    dataType: "json",
            //    success: function (data, status, error) {
            //        $('#TxAccountCode').empty();
            //        $('#TxAccountCode').append('<option>-Select-</option>');
            //        $.each(data, function (key, val) {
            //            $('#TxAccountCode').append('<option value="' + val.value + '">' + val.text + '</option>');
            //        });
            //    },
            //    error: function (req, status, error) {
            //        $.notify(error, { position: "top center", className: "error" });
            //    }
            //});
            GetTaxAccountName("TAX");

        }
        else {
            $('#TxAccountCode').empty();
            $('#TxAccountCode').append('<option>-Select-</option>');
        }
    }
});


$('#TxAccountCode').change(function () {
    if ($('#TxType').val() == "TAX") {
        $('#TxRoundOff').prop('selectedIndex', 0);
        if ($(this).prop('selectedIndex') != 0) {
            $.ajax({
                type: "POST",
                url: "/Tax/GetTaxPercentage",
                data: { "TxCode": $(this).val() },
                dataType: "json",
                success: function (data, status, error) {
                    if (data) {
                        $('#TxPercentg').val(data);
                    }
                },
                error: function (req, status, error) {
                    $.notify(error, { position: "top center", className: "error" });
                }
            });
        }
        else {
            $('#TxPercentg').val(0);
        }
    }
});


$('.btnAddTax2Grid').click(function (e) {
    e.preventDefault();
    e.stopImmediatePropagation();
    e.stopPropagation();

    var PageName = $('title').text();

    var Typ = $('#SOType').val();
    var isErr = 0;
    if ($('#TxType').val() == "TAX") {

        if (!$('#TxPartCode').val() || $('#TxPartCode').prop('selectedIndex') == 0) {
            AddErrorCls('TxPartCode');
            isErr = 1;
        }
        else {
            $('#TxPartCode').removeClass('is-invalid');
        }

        if (!$('#TxItemCode').val() || $('#TxItemCode').prop('selectedIndex') == 0) {
            AddErrorCls('TxItemCode');
            isErr = 1;
        }
        else {
            $('#TxItemCode').removeClass('is-invalid');
        }

        if (!$('#TxTaxType').val() || $('#TxTaxType').prop('selectedIndex') == 0) {
            AddErrorCls('TxTaxType');
            isErr = 1;
        }
        else {
            $('#TxTaxType').removeClass('is-invalid');
            if ($('#TxTaxType').val() != "25") {
                $('#TxPartCode').removeClass('is-invalid');
                $('#TxItemCode').removeClass('is-invalid');
                isErr = 0;
            }
        }

        if (!$('#TxAccountCode').val() || $('#TxAccountCode').prop('selectedIndex') == 0) {
            AddErrorCls('TxAccountCode');
            isErr = 1;
        }
        else {
            $('#TxAccountCode').removeClass('is-invalid');
        }

        if ($('#TxAccountCode').val() == 928 || $('#TxAccountCode').val() == 944 || $('#TxAccountCode').val() == 946 || $('#TxAccountCode').val() == 950 || $('#TxAccountCode').val() == 990 || $('#TxAccountCode').val() == 1006 || $('#TxAccountCode').val() == 1059 || $('#TxAccountCode').val() == 1060 || $('#TxAccountCode').val() == 1061 || $('#TxAccountCode').val() == 1062 || $('#TxAccountCode').val() == 1728) {
            /*$.notify('Please fill CGST Tax Detail First..!', { position: "top center", className: "error" });*/
            AddErrorCls('TxAccountCode');
            isErr = 1;
        }
        else {
            $('#TxAccountCode').removeClass('is-invalid');
        }

        //if (!$('#TxPercentg').val() || $('#TxPercentg').val() <= 0) {
        //    AddErrorCls('TxPercentg');
        //    isErr = 1;
        //}
        //else {
        //    $('#TxPercentg').removeClass('is-invalid');
        //}

        if (!$('#TxAdInTxable').val() || $('#TxAdInTxable').prop('selectedIndex') == 0) {
            AddErrorCls('TxAdInTxable');
            isErr = 1;
        }
        else {
            $('#TxAdInTxable').removeClass('is-invalid');
        }

        if (!$('#TxRoundOff').val() || $('#TxRoundOff').prop('selectedIndex') == 0) {
            AddErrorCls('TxRoundOff');
            isErr = 1;
        }
        else {
            $('#TxRoundOff').removeClass('is-invalid');
        }

        //if (Typ == "CLOSE") {
        //    if (!$('#TxAmount').val() || $('#TxAmount').val() <= 0) {
        //        AddErrorCls('TxAmount');
        //        isErr = 1;
        //    }
        //    else {
        //        $('#TxAmount').removeClass('is-invalid');
        //    }
        //}


        if (isErr == 1) {
            if ($('#TxAccountCode').val() == 928 || $('#TxAccountCode').val() == 944 || $('#TxAccountCode').val() == 946 || $('#TxAccountCode').val() == 950 || $('#TxAccountCode').val() == 990 || $('#TxAccountCode').val() == 1006 || $('#TxAccountCode').val() == 1059 || $('#TxAccountCode').val() == 1060 || $('#TxAccountCode').val() == 1061 || $('#TxAccountCode').val() == 1062 || $('#TxAccountCode').val() == 1728) {
                $.notify('Please fill First CGST Tax Detail..!', { position: "top center", className: "error" });
            } else {
                $.notify('Please fill Tax Detai Properly..!', { position: "top center", className: "error" });
            }
            return false;
        }
        else {
            if (PageName.indexOf('Issue NonRetuanable') === 0) {
                AddIssueTaxDtail();
            } else {
                AddTaxDetail();
            }
        }
    }

    if ($('#TxType').val() == "EXPENSES") {
        $('#TxPartCode').removeClass('is-invalid');
        $('#TxItemCode').removeClass('is-invalid');
        $('#TxPercentg').removeClass('is-invalid');

        if (!$('#TxTaxType').val() || $('#TxTaxType').prop('selectedIndex') == 0) {
            AddErrorCls('TxTaxType');
            isErr = 1;
        }
        else {
            $('#TxTaxType').removeClass('is-invalid');
        }

        if (!$('#TxAccountCode').val() || $('#TxAccountCode').prop('selectedIndex') == 0) {
            AddErrorCls('TxAccountCode');
            isErr = 1;
        }
        else {
            $('#TxAccountCode').removeClass('is-invalid');
        }

        if ($('#TxAdInTxable').prop('selectedIndex') == 0) {
            AddErrorCls('TxAdInTxable');
            isErr = 1;
        }
        else {
            $('#TxAdInTxable').removeClass('is-invalid');
        }

        if (!$('#TxRoundOff').val() || $('#TxRoundOff').prop('selectedIndex') == 0) {
            AddErrorCls('TxRoundOff');
            isErr = 1;
        }
        else {
            $('#TxRoundOff').removeClass('is-invalid');
        }

        if (!$('#TxAmount').val() || $('#TxAmount').val() <= 0) {
            AddErrorCls('TxAmount');
            isErr = 1;
        }
        else {
            $('#TxAmount').removeClass('is-invalid');
        }

        if ($('#TxRefundable').prop('selectedIndex') == 0) {
            AddErrorCls('TxRefundable');
            isErr = 1;
        }
        else {
            $('#TxRefundable').removeClass('is-invalid');
        }

        if (isErr == 1) {
            $.notify('Please fill Tax Detal Properly..!', { position: "top center", className: "error" });
            return false;
        }
        else {

            if (PageName.indexOf('Issue NonRetuanable') === 0) {
                AddIssueTaxDtail();
            } else {
                AddTaxDetail();
            }
        }
    }
    //ClearAdjustmentGrid();

});


function AddTaxDetail() {
    ;
    var TxPageName = $('title').text();
    var TxPageData;
    if (TxPageName.indexOf('Sale Order') === 0) {
        TxPageData = 'ItemList';
    }
    else if (TxPageName.indexOf('Purchase Order') == 0) {
        TxPageData = 'PurchaseOrder';
    }
    else if (TxPageName.indexOf('Issue NonRetuanable') == 0) {
        TxPageData = 'IssueNRGP';
    }
    else if (TxPageName.indexOf('Direct Purchase Bill') == 0) {
        TxPageData = 'DirectPurchaseBill';
    }
    else if (TxPageName.indexOf('Purchase Bill') == 0 && TxPageName.indexOf('Direct') != 0) {
        TxPageData = 'PurchaseBill';
    }
    else if (TxPageName.indexOf('SaleInvoice') == 0) {
        TxPageData = 'SaleInvoice';
    }
    else if (TxPageName.indexOf('Credit Note') == 0) {
        TxPageData = 'CreditNote';
    }
    else if (TxPageName.indexOf('Purchase Rejection') == 0) {
        TxPageData = 'PurchaseRejection';
    }
    else if (TxPageName.indexOf('Sale Rejection') == 0) {
        TxPageData = 'SaleRejection';
    }
    else {
        TxPageData = 'JobWorkIssue';
    }

    var TaxData = {
        "TxType": $('#TxType').val(),
        "TxItemCode": $('#TxItemCode').val(),
        "TxItemName": $('#TxItemCode option:selected').text(),
        "TxPartCode": $('#TxPartCode').val(),
        "TxPartName": $('#TxPartCode option:selected').text(),
        "TxTaxType": $('#TxTaxType').val(),
        "TxTaxTypeName": $('#TxTaxType option:selected').text(),
        "TxAccountCode": $('#TxAccountCode').val(),
        "TxAccountName": $('#TxAccountCode option:selected').text(),
        "TxPercentg": parseFloat($('#TxPercentg').val().trim()),
        "TxAdInTxable": $('#TxAdInTxable').val(),
        "TxRoundOff": $('#TxRoundOff').val(),
        "TxAmount": parseFloat($('#TxAmount').val().trim()),
        "TxRefundable": $('#TxRefundable').val(),
        "TxOnExp": parseInt($('#TxOnExp').val().trim()),
        "TxRemark": $('#TxRemark').val(),
        "TxPageName": TxPageData
    }

    $.ajax({
        type: "POST",
        url: '/Tax/AddTaxDetail',
        data: TaxData,
        async: false,
        success: function (resp, status, error) {
            if (resp.trim() == "") {
                $.notify('Adding Duplicate Tax Is Not Allowed...!', "info");
            }
            else {
                ClearAdjustmentGrid();
                $('#divTaxGrid').html(resp);
                var taxRowCount = $('#divTaxGrid tr').length;
                var txSum = 0;
                //if ($('#divTaxGrid tr td').length > 1) {
                //    for (var i = 1; i <= taxRowCount; i++) {
                //        txSum += parseFloat($('#txGridAmount-' + i).text() == '.00' ? 0 : $('#txGridAmount-' + i).text());
                //    }
                //}
                $('#divTaxGrid tr').toArray().forEach(row => {
                    debugger
                    const $row = $(row);

                    const typeText = $row.find('td').eq(2).text().trim().toUpperCase();

                    const $amountTd = $row.find('td[id^="txGridAmount-"]');
                    const amtText = $amountTd.text().trim();
                    const amt = parseFloat(amtText === '.00' ? 0 : amtText);

                    txSum += isNaN(amt) ? 0 : amt;
                });

                $('#TotalTaxAmt').val(txSum);
                //03/09/2025 - Dharmee's Changes for tax Net Amount suppose ItemAmount + TaxAmount
                var INA = parseFloat($('#lblItemNetAmount').text());
                var TTA = parseFloat($('#TotalTaxAmt').val());
                var NT = INA + TTA;

                $('#NetTotal').val(NT.toFixed(2));
                $('#BaseNetTotal').val(NT.toFixed(2));
                $('#TxType').prop('selectedIndex', 0).change();
                $('#AdjPendAmt').val(parseFloat($('#NetTotal').val() || 0).toFixed(2));
            }
            if (TxPageData == 'JobWorkIssue') {
                GetAmtAfterDiscount();
            }
            if (TxPageData == 'PurchaseBill' || TxPageData == 'SaleInvoice' || TxPageData == 'SaleRejection' || TxPageData == 'CreditNote' || TxPageData == 'PurchaseRejection') {
                GetDbCrDetail();
                //AddAdjstmntDetail1();
            }
            ClearTax();
            /*}*/
        },
        error: function (error, status, xhr) {
            if (error.status == 400) {
                $.notify(status + " : " + error.status + " : Cannot Add Expenses with Add In Taxable='Y', if Tax Exists.", { position: "top center", className: "error" });
            }
            else if (error.status == 501) {
                $.notify(status + " : " + error.status + " : " + error.responseText, { position: "top center", className: "error" });
            }
            else {
                $.notify(error, { position: "top center", className: "error" });
            }
        }
    }).done(function () {
        if (TxPageData == 'DirectPurchaseBill' || TxPageData == 'PurchaseBill' || TxPageData == 'SaleInvoice' || TxPageData == 'SaleRejection' || TxPageData == 'CreditNote' || TxPageData == 'PurchaseRejection') {

            AddAdjstmntDetail1();
        }
    })
}


function ValidateTaxDetail() {
    var isError = 0;

    if ($('#TxType').prop('selectedIndex') == 0) {
        AddErrorCls('TxType');
        isError = 1;
    }

    if ($('#TxPartCode').prop('selectedIndex') == 0) {
        AddErrorCls('TxPartCode');
        isError = 1;
    }

    if ($('#TxItemCode').prop('selectedIndex') == 0) {
        AddErrorCls('TxItemCode');
        isError = 1;
    }

    if ($('#TxTaxType').prop('selectedIndex') == 0) {
        AddErrorCls('TxTaxType');
        isError = 1;
    }

    if ($('#TxAccountCode').prop('selectedIndex') == 0) {
        AddErrorCls('TxAccountCode');
        isError = 1;
    }

    //if ($('#TxPercentg').val() <= 0) {
    //    AddErrorCls('TxPercentg');
    //    isError = 1;
    //}

    if ($('#TxAdInTxable').prop('selectedIndex') == 0) {
        AddErrorCls('TxAdInTxable');
        isError = 1;
    }

    if ($('#TxRoundOff').prop('selectedIndex') == 0) {
        AddErrorCls('TxRoundOff');
        isError = 1;
    }

    if ($('#SOType').val() == "CLOSE") {
        if ($('#TxAmount').val() <= 0) {
            AddErrorCls('TxAmount');
            isError = 1;
        }
    }

    return isError;
}

var isExpense = false;
function IsExpenseExists() {
    ;
    $('#taxTable tbody tr').each(function () {
        var taxOnExp = $(this).find('td').eq(indexOfTaxOnExpColumn).text().trim();
        if (parseFloat(taxOnExp) > 0) {
            isExpense = true;
            return false;
        }
    });
}
async function ApplyTax2All() {

    var RowCount = $('#divTaxGrid tr').length;
    var ColumnCount = $('#divTaxGrid tr td').length;
    console.log(isExpense);
    ClearAdjustmentGrid();
    if (RowCount >= 1 && ColumnCount > 1 && isExpense) {
        $.notify("Please clear tax first", "error");
    } else {
        var TxPageName = $('title').text();
        var TxPageData;
        if (TxPageName.indexOf('Sale Order') === 0) {
            TxPageData = 'ItemList';
        }
        else if (TxPageName.indexOf('Purchase Order') == 0) {
            TxPageData = 'PurchaseOrder';
        }
        else if (TxPageName.indexOf('Issue NonRetuanable') == 0) {
            TxPageData = 'IssueNRGP';
        }
        else if (TxPageName.indexOf('Direct Purchase Bill') == 0) {
            TxPageData = 'DirectPurchaseBill';
        }
        else if (TxPageName.indexOf('Purchase Bill') == 0 && TxPageName.indexOf('Direct') != 0) {
            TxPageData = 'PurchaseBill';
        }
        else if (TxPageName.indexOf('SaleInvoice') == 0) {
            TxPageData = 'SaleInvoice';
        }
        else if (TxPageName.indexOf('Sale Rejection') == 0) {
            TxPageData = 'SaleRejection';
        }
        else if (TxPageName.indexOf('Credit Note') == 0) {
            TxPageData = 'CreditNote';
        }
        else if (TxPageName.indexOf('Purchase Rejection') == 0) {
            TxPageData = 'PurchaseRejection';
        }
        else {
            TxPageData = 'JobWorkIssue';
        }
        if ($('#TxType').val() == "TAX") {
            if (ValidateTaxDetail() == 1) return;
            var TaxData = {
                "TxType": $('#TxType').val(),
                "TxItemCode": $('#TxItemCode').val(),
                "TxItemName": $('#TxItemCode option:selected').text(),
                "TxPartCode": $('#TxPartCode').val(),
                "TxPartName": $('#TxPartCode option:selected').text(),
                "TxTaxType": $('#TxTaxType').val(),
                "TxTaxTypeName": $('#TxTaxType option:selected').text(),
                "TxAccountCode": $('#TxAccountCode').val(),
                "TxAccountName": $('#TxAccountCode option:selected').text(),
                "TxPercentg": parseFloat($('#TxPercentg').val().trim()),
                "TxAdInTxable": $('#TxAdInTxable').val(),
                "TxRoundOff": $('#TxRoundOff').val(),
                "TxAmount": parseFloat($('#TxAmount').val().trim()),
                "TxRefundable": $('#TxRefundable').val(),
                "TxOnExp": parseInt($('#TxOnExp').val().trim()),
                "TxRemark": $('#TxRemark').val(),
                "TxPageName": TxPageData
            }

            $.ajax({
                url: '/Tax/ApplyTax2All',
                type: "POST",
                data: TaxData,
                success: function (data, status, xhr) {
                    var tableData = [];

                    $('#divTaxGrid tr').each(function () {
                        var rowData = {};
                        var typeValue = rowData['type'] = $(this).find('td:eq(2)').text().trim();
                        tableData.push(typeValue);
                    });

                    if (tableData[0] == "EXPENSES") {
                        var currentHtml = $('#divTaxGrid').html();
                        var newHtml = currentHtml + data;
                        $('#divTaxGrid').html("");
                        $('#divTaxGrid').html(data);
                    } else {

                        $('#divTaxGrid').html(data);
                    }

                    if (data.trim() != "") {

                        //if (!$('#divTaxGrid').html().includes(data)) {
                        //$('#divTaxGrid').append( data);
                        //}

                        var taxRowCount = $('#divTaxGrid tr').length;
                        var txSum = 0;
                        if ($('#divTaxGrid tr td').length > 1) {
                            for (var i = 1; i <= taxRowCount; i++) {
                                txSum += parseFloat($('#txGridAmount-' + i).text() == '.00' ? 0 : $('#txGridAmount-' + i).text());

                            }
                        }

                        $('#TotalTaxAmt').val(txSum);
                        //03/09/2025 - Dharmee's Changes for tax Net Amount suppose ItemAmount + TaxAmount
                        var INA = parseFloat($('#lblItemNetAmount').text());
                        var TTA = parseFloat($('#TotalTaxAmt').val());
                        var NT = INA + TTA;

                        $('#NetTotal').val(NT.toFixed(2));
                        $('#BaseNetTotal').val(NT.toFixed(2));
                        //$('#AdjPendAmt').val(NT.toFixed(2));
                        $('#AdjPendAmt').val(parseFloat($('#NetTotal').val() || 0).toFixed(2));

                    }
                    if ($('title').text().indexOf('Job Work') == 0) {
                        GetAmtAfterDiscount();
                    }
                    if ($('title').text().indexOf('Direct Purchase Bill') == 0 || $('title').text().indexOf('Purchase Rejection') == 0 || $('title').text().indexOf('Sale Rejection') == 0 || ($('title').text().indexOf('Purchase Bill') == 0 && $('title').text().indexOf('Direct') != 0) || $('title').text().indexOf('SaleInvoice') == 0 || $('title').text().indexOf('Credit Note ') == 0) {
                        GetDbCrDetail();
                        //AddAdjstmntDetail1();
                    }

                },
                error: function (error, status, xhr) {
                    if (error.status == 400) {
                        $.notify(status + " : " + error.status + " : Cannot Add Duplicate Tax, if Same Tax Exists...!", { position: "top center", className: "error" });
                    }
                    else {
                        $.notify(error, { position: "top center", className: "error" });
                    }
                }
            }).done(function () {
                if ($('title').text().indexOf('Direct Purchase Bill') == 0 || $('title').text().indexOf('Purchase Rejection') == 0 || $('title').text().indexOf('Sale Rejection') == 0 || ($('title').text().indexOf('Purchase Bill') == 0 && $('title').text().indexOf('Direct') != 0) || $('title').text().indexOf('SaleInvoice') == 0 || $('title').text().indexOf('Credit Note ') == 0) {

                    AddAdjstmntDetail1();
                }
            })
        }
    }
}


//function CalculateTax() {
//    //$('#divSaleItemGrid tr').each(function () {
//    //    alert($(this).find("td:eq(13)").html());
//    //});

//    if ($('#TxPartCode').prop('selectedIndex') != 0 && $('#TxTaxType').prop('selectedIndex') != 0 && $('#TxAccountCode').prop('selectedIndex') != 0) {
//        $.ajax({
//            type: "POST",
//            url: "/SaleOrder/CalculateTax",
//            data: { "PC": $('#TxPartCode').val(), "TP": $('#TxPercentg').val() },
//            dataType: "json",
//            success: function (data, status, error) {
//                $('#TxAmount').val(data.amt.toFixed(2)), $('#TxOnExp').val(data.taxOnExp.toFixed(2));
//            },
//            error: function (req, status, error) {
//                $.notify(error, { position: "top center", className: "error" });
//            }
//        });
//    }
//}


$('.btnClearTax').click(function (e) {
    e.preventDefault();
    var SN = $('title').text();
    //SN = SN.indexOf('Sale Order') === 0 ? 'ItemList' : 'PurchaseOrder';

    var TxPageData;
    if (SN.indexOf('Sale Order') === 0) {
        SN = 'ItemList';
    }
    else if (SN.indexOf('Purchase Order') == 0) {
        SN = 'PurchaseOrder';
    }
    else if (SN.indexOf('Direct Purchase Bill') == 0) {
        SN = 'DirectPurchaseBill';
    }
    else if (SN.indexOf('Purchase Bill') == 0 && SN.indexOf('Direct') != 0) {
        SN = 'PurchaseBill';
    }
    else if (SN.indexOf('Purchase Rejection') == 0) {
        SN = 'PurchaseRejection';
    }
    else if (SN.indexOf('Sale Rejection') == 0) {
        SN = 'SaleRejection';
    }
    else if (SN.indexOf('Issue NonRetuanable') == 0) {
        SN = 'IssueNRGP';
    }
    else if (SN.indexOf('Credit Note') == 0) {
        SN = 'CreditNote';
    }
    else {
        SN = 'JobWorkIssue';
    }
    ClearTax();
    $.ajax({
        url: '/Tax/ClearTax',
        type: "GET",
        data: { 'SN': SN },
        datatype: "json",
        async: false,
        success: function (data, status, xhr) {

            if (data.trim() != "") {

                //ClearDRCRGrid();
                ClearAdjustmentGrid();
                $('#divTaxGrid').html(data);
                var INA = parseFloat($('#ItemNetAmount').val());
                var TTA = parseFloat($('#TotalTaxAmt').val());
                TTA = TTA = "NAN" ? 0.00 : TTA;
                var NT = INA + TTA;
                $('#NetTotal').val(NT.toFixed(2));
                $('#BaseNetTotal').val(NT.toFixed(2));
            }
            if ($('title').text().indexOf('Job Work') == 0) {

                GetAmtAfterDiscount();
            }
            if ($('title').text().indexOf('Direct Purchase Bill') == 0 || $('title').text().indexOf('Purchase Rejection') == 0 || ($('title').text().indexOf('Purchase Bill') == 0 && $('title').text().indexOf('Direct') != 0) || $('title').text().indexOf('SaleInvoice') == 0 || $('title').text().indexOf('Sale Rejection') == 0) {
                GetDbCrDetail();
            }
        }
    }).done(function (data) {
        console.log(data);
    }).fail(function (data) {
        console.log(data);
    }).always(function (data) {
        console.log(data);
    });
});


async function ROF() {
    let Amt = $('#TxAmount').val().trim() == "" ? 0 : parseFloat($('#TxAmount').val().trim());
    Amt = Math.round(Amt);
    $('#TxAmount').val(Amt.toFixed(2));
}


var _TA = 0.00;


$('#TxRoundOff').change(function () {
    var SN = $('title').text();
    //SN = SN.indexOf('Sale Order') === 0 ? 'ItemList' : 'PurchaseOrder';

    var TxPageData;
    if (SN.indexOf('Sale Order') === 0) {
        SN = 'ItemList';
    }
    else if (SN.indexOf('Purchase Order') == 0) {
        SN = 'PurchaseOrder';
    }
    else if (SN.indexOf('Direct Purchase Bill') == 0) {
        SN = 'DirectPurchaseBill';
    }
    else if (SN.indexOf('Purchase Bill') == 0 && SN.indexOf('Direct') != 0) {
        SN = 'PurchaseBill';
    }
    else if (SN.indexOf('Issue NonRetuanable') == 0) {
        SN = 'IssueNRGP';
    }
    else if (SN.indexOf('SaleInvoice') == 0) {
        SN = 'SaleInvoice';
    }
    else if (SN.indexOf('Credit Note') == 0) {
        SN = 'CreditNote';
    }
    else if (SN.indexOf('Purchase Rejection') == 0) {
        SN = 'PurchaseRejection';
    }
    else if (SN.indexOf('Sale Rejection') == 0) {
        SN = 'SaleRejection';
    }
    else {
        SN = 'JobWorkIssue';
    }
    if ($(this).val() == "Y") {

        if ($('#TxPartCode').prop('selectedIndex') != 0 && $('#TxTaxType').prop('selectedIndex') != 0 && $('#TxAccountCode').prop('selectedIndex') != 0) {
            $.ajax({
                type: "POST",
                url: "/Tax/CalculateTax",
                data: { "PC": $('#TxPartCode').val(), "TP": $('#TxPercentg').val(), 'SN': SN },
                dataType: "json",
                success: function (data, status, error) {

                    $('#TxAmount').val(data.amt.toFixed(2));
                    $('#TxOnExp').val(data.taxOnExp.toFixed(2));
                    ROF();
                },
                error: function (req, status, error) {
                    $.notify(error, { position: "top center", className: "error" });
                }
            });
        }
        else if ($('#TxType').val() == "EXPENSES") {
            ROF();
        }
    }
    else if ($(this).val() == "N") {
        if ($('#TxType').val() == "TAX") {
            $.ajax({
                type: "POST",
                url: "/Tax/CalculateTax",
                data: { "PC": $('#TxPartCode').val(), "TP": $('#TxPercentg').val(), 'SN': SN },
                dataType: "json",
                success: function (data, status, error) {
                    $('#TxAmount').val(data.amt.toFixed(2));
                    $('#TxOnExp').val(data.taxOnExp.toFixed(2));
                },
                error: function (req, status, error) {
                    $.notify(error, { position: "top center", className: "error" });
                }
            });
        }
    }
    else {
        $('#TxAmount').val('0.00');
    }
});


$('#TxAmount').keydown(function () {
    $('#TxRoundOff').prop('selectedIndex', 0);
});


$('#TotalDiscountPercentage ').keydown(function () {
    $('#TotalRoundOff').prop('selectedIndex', 0);
});


$('#TotalAmtAftrDiscount').keydown(function () {
    $('#TotalRoundOff').prop('selectedIndex', 0);
});


$('#TotalRoundOff').change(function () {

    var TxPageName = $('title').text();
    var TxPageData;
    if (TxPageName.indexOf('Direct Purchase Bill') == 0) { TxPageData = 'DirectPurchaseBill'; }
    if (TxPageName.indexOf('Purchase Rejection') == 0) { TxPageData = 'PurchaseRejection'; }
    if (TxPageName.indexOf('Sale Rejection') == 0) { TxPageData = 'SaleRejection'; }
    if (TxPageName.indexOf('Purchase Bill') == 0 && TxPageName.indexOf('Direct') != 0) { TxPageData = 'PurchaseBill'; }
    if ($.isNumeric($('#NetTotal').val()) && parseFloat($('#NetTotal').val()) > 0) {
        if ($(this).val() == "Y") {
            let Amt = $('#NetTotal').val().trim() == "" ? 0 : parseFloat($('#NetTotal').val().trim());
            if (TxPageData == 'DirectPurchaseBill' || TxPageData == 'PurchaseBill') {
                RoundOffAmt = Amt;
                RoundOffAmt = Math.abs(Amt - Math.round(Amt));
                $('#TotalRoundOffAmt').val(RoundOffAmt.toFixed(2));
            }
            Amt = Math.round(Amt);
            $('#NetTotal').val(Amt.toFixed(2));
            $('#BaseNetTotal').val(Amt.toFixed(2));
            if (TxPageData == 'DirectPurchaseBill' || TxPageData == 'PurchaseBill' || TxPageData == 'PurchaseRejection') {
                CalculateAdjAmt('NetTotal');
            }
        }
        else {
            var INA = parseFloat($('#ItemNetAmount').val()) > 0 ? parseFloat($('#ItemNetAmount').val()) : (parseFloat($('#ItemNetAmount').text()) > 0 ? parseFloat($('#ItemNetAmount').text()) : 0);
            var TTA = parseFloat($('#TotalTaxAmt').val());
            TTA = TTA == "NAN" ? 0.00 : TTA;
            var NT = INA + TTA;

            var disPerc = $('#TotalDiscountPercentage').val();
            if (disPerc > 0) {
                var disNT = ((NT * disPerc) / 100);
                NT = NT - disNT;
                $('#NetTotal').val(NT.toFixed(2));
                $('#BaseNetTotal').val(NT.toFixed(2));
            }
            else {
                $('#NetTotal').val(NT.toFixed(2));
                $('#BaseNetTotal').val(NT.toFixed(2));
            }
            if (TxPageData == 'DirectPurchaseBill' || TxPageData == 'PurchaseBill' || TxPageData == 'PurchaseRejection') {
                $('#TotalRoundOffAmt').val(0.00);
                CalculateAdjAmt('NetTotal');
            }
        }
    }
});


function TDP() {

    const DP = $('#TotalDiscountPercentage') == "0" || $('#TotalDiscountPercentage').val() == "" ? 0 : parseFloat($('#TotalDiscountPercentage').val());
    var Amount = $('#NetTotal').val() == "0" || $('#NetTotal').val() == "" ? 0 : parseFloat($('#NetTotal').val());

    if (DP !== 0) {
        const DA = ((Amount * DP) / 100);
        $('#TotalAmtAftrDiscount').val(DA.toFixed(2));
        Amount = Amount - DA;
    }
    else {
        Amount = parseFloat($('#ItemNetAmount').val());
        var taxRowCount = $('#divTaxGrid tr').length;

        var txSum = 0;
        if ($('#divTaxGrid tr td').length > 1) {
            for (var i = 1; i <= taxRowCount; i++) {
                txSum += parseFloat($('#txGridAmount-' + i).text() == '.00' ? 0 : $('#txGridAmount-' + i).text());
            }
        }
        Amount += txSum;
        $('#TotalAmtAftrDiscount').val('0.00'), $('#TotalDiscountPercentage').val('0');
    }

    $('#NetTotal').val(Amount.toFixed(2));
    $('#BaseNetTotal').val(Amount.toFixed(2));
    $('#AdjPendAmt').val(parseFloat($('#NetTotal').val() || 0).toFixed(2));
}


//$('#TotalDiscountPercentage').keyup(function () {
//    TDP();
//});


$('#TotalDiscountPercentage').change(function () {
    TDP();
});


async function DeleteTaxRow(SeqNo) {

    //if ($('#txGridName-' + SeqNo).text().includes("GST") && $('#txGridName-' + SeqNo).text() != "IGST") {
    if ($('#txGridName-' + SeqNo).text().includes("GST") && !$('#txGridName-' + SeqNo).text().trim().includes("IGST")) {
        if ($('#txGridName-' + SeqNo).text().includes("CGST")) {
            console.log("seqNo: " + SeqNo + ", " + SN + "!ifIGST");
            var title = $('title').text();
            var SN = title.indexOf('Sale Order') === 0 ? 'ItemList' :
                title.indexOf('Direct Purchase Bill') === 0 ? 'DirectPurchaseBill' :
                    (title.indexOf('Purchase Bill') === 0 && title.indexOf('Direct') !== 0) ? 'PurchaseBill' :
                        title.indexOf('Purchase Rejection') === 0 ? 'PurchaseRejection' :
                            title.indexOf('Sale Rejection') === 0 ? 'SaleRejection' :
                                title.indexOf('SaleInvoice') === 0 ? 'SaleInvoice' :
                                    title.indexOf('Purchase Order') === 0 ? 'PurchaseOrder' :
                                        'Unknown';
            console.log("seqNo: " + SeqNo + ", " + SN);
            $.ajax({
                url: '/Tax/DeleteTaxRow',
                type: "POST",
                async: false,
                data: { "SeqNo": SeqNo, 'SN': SN },
                success: await function (data, status, xhr) {
                    $('#divTaxGrid').html(data);
                    ClearDRCRGrid();
                    ClearAdjustmentGrid();
                    var taxRowCount = $('#divTaxGrid tr').length;
                    var txSum = 0;
                    if ($('#divTaxGrid tr td').length > 1) {
                        for (var i = 1; i <= taxRowCount; i++) {
                            txSum += parseFloat($('#txGridAmount-' + i).text() == '.00' ? 0 : $('#txGridAmount-' + i).text());
                        }
                    }
                    $('#TotalTaxAmt').val(txSum);
                    var rowCountTax = $('#divTaxGrid tr').length;
                    var sumTax = 0;

                    for (var i = 1; i <= rowCountTax; i++) {

                        sumTax = parseFloat($('#txGridAmount-' + i).text()) + parseFloat($('#lblItemNetAmount').text());
                    }
                    $('#NetTotall').val(sumTax.toFixed(2));
                    $('#BaseNetTotal').val(sumTax.toFixed(2));

                    var INA = parseFloat($('#ItemNetAmount').val());
                    var TTA = parseFloat($('#TotalTaxAmt').val());
                    var NT = INA + TTA;
                    $('#NetTotal').val(NT.toFixed(2));
                    $('#BaseNetTotal').val(NT.toFixed(2));

                    if ($('#divTaxGrid').children().length == 0) {
                        var NoData = '<tr class="text-center"><td colspan="14" class="text-black-50"><strong>NO DATA ADDED</strong></td></tr>';
                        $('#divTaxGrid').html(NoData);
                        //$('#NetTotal').val(INA.toFixed(2));
                    }

                    $.notify('Item Deleted From Grid.', "info");
                    if ($('title').text().indexOf('Job Work') == 0) {
                        GetAmtAfterDiscount();
                    }
                    if ($('title').text().indexOf('Direct Purchase Bill') == 0 || $('title').text().indexOf('Purchase Rejection') == 0 || $('title').text().indexOf('Sale Rejection') == 0 || ($('title').text().indexOf('Purchase Bill') == 0 && $('title').text().indexOf('Direct') != 0) || $('title').text().indexOf('SaleInvoice') == 0 || $('title').text().indexOf('Credit Note') == 0) {
                        GetDbCrDetail();
                    }
                    $('#TotalAmtAftrDiscount').val("0.00");
                    $('#TotalDiscountPercentage').val(0);
                },
                error: function (error, status, xhr) {
                    $.notify(status + " : " + error.status + " : Cannot Delete Expenses, if Tax Exists.", { position: "top center", className: "error" });
                },
                failure: function (error, status, xhr) {
                    $.notify(error, { position: "top center", className: "error" });
                }
            });
        }
        else {
            console.log("seqNo: " + SeqNo + ", " + SN + "!elseIGST");
            var title = $('title').text();
            var SN = title.indexOf('Sale Order') === 0 ? 'ItemList' :
                title.indexOf('Direct Purchase Bill') === 0 ? 'DirectPurchaseBill' :
                    (title.indexOf('Purchase Bill') === 0 && title.indexOf('Direct') !== 0) ? 'PurchaseBill' :
                        title.indexOf('SaleInvoice') === 0 ? 'SaleInvoice' :
                            title.indexOf('Purchase Order') === 0 ? 'PurchaseOrder' :
                                title.indexOf('Credit Note') === 0 ? 'CreditNote' :
                                    title.indexOf('Purchase Rejection') === 0 ? 'PurchaseRejection' :
                                        title.indexOf('Sale Rejection') === 0 ? 'SaleRejection' :
                                            'Unknown';
            console.log("seqNo: " + SeqNo + ", " + SN);
            //var SN = $('title').text().indexOf('Sale Order') === 0 ? 'ItemList' : ($('title').text().indexOf('Direct Purchase Bill') === 0 ? 'DirectPurchaseBill' : 'PurchaseOrder');
            $.ajax({
                url: '/Tax/DeleteTaxRow',
                type: "POST",
                data: { "SeqNo": SeqNo, 'SN': SN },
                success: await function (data, status, xhr) {
                    ClearAdjustmentGrid();

                    $('#divTaxGrid').html(data);
                    var taxRowCount = $('#divTaxGrid tr').length;
                    var txSum = 0;
                    if ($('#divTaxGrid tr td').length > 1) {
                        for (var i = 1; i <= taxRowCount; i++) {
                            txSum += parseFloat($('#txGridAmount-' + i).text() == '.00' ? 0 : $('#txGridAmount-' + i).text());

                        }
                    }
                    $('#TotalTaxAmt').val(txSum);
                    var rowCountTax = $('#divTaxGrid tr').length;
                    var sumTax = 0;

                    for (var i = 1; i <= rowCountTax; i++) {

                        sumTax = parseFloat($('#txGridAmount-' + i).text()) + parseFloat($('#lblItemNetAmount').text());
                    }
                    $('#NetTotall').val(sumTax.toFixed(2));
                    $('#BaseNetTotal').val(sumTax.toFixed(2));

                    var INA = parseFloat($('#ItemNetAmount').val());
                    var TTA = parseFloat($('#TotalTaxAmt').val());
                    var NT = INA + TTA;
                    $('#NetTotal').val(NT.toFixed(2));
                    $('#BaseNetTotal').val(NT.toFixed(2));

                    if ($('#divTaxGrid').children().length == 0) {
                        var NoData = '<tr class="text-center"><td colspan="14" class="text-black-50"><strong>NO DATA ADDED</strong></td></tr>';
                        $('#divTaxGrid').html(NoData);
                        //$('#NetTotal').val(INA.toFixed(2));
                    }

                    $.notify('Item Deleted From Grid.', "info");
                    if ($('title').text().indexOf('Job Work') == 0) {
                        GetAmtAfterDiscount();
                    }
                    if ($('title').text().indexOf('Direct Purchase Bill') == 0 || $('title').text().indexOf('Purchase Rejection') == 0 || $('title').text().indexOf('Sale Rejection') == 0 || ($('title').text().indexOf('Purchase Bill') == 0 && $('title').text().indexOf('Direct') != 0) || $('title').text().indexOf('SaleInvoice') == 0 || $('title').text().indexOf('Credit Note') == 0) {
                        GetDbCrDetail();
                    }
                    $('#TotalAmtAftrDiscount').val("0.00");
                    $('#TotalDiscountPercentage').val(0);
                },
                error: function (error, status, xhr) {
                    $.notify(status + " : " + error.status + " : Cannot Delete Expenses, if Tax Exists.", { position: "top center", className: "error" });
                },
                failure: function (error, status, xhr) {
                    $.notify(error, { position: "top center", className: "error" });
                }
            });
            SeqNo = SeqNo - 1;
        }
    }
    else {
        var title = $('title').text();
        var SN = title.indexOf('Sale Order') === 0 ? 'ItemList' :
            title.indexOf('Direct Purchase Bill') === 0 ? 'DirectPurchaseBill' :
                (title.indexOf('Purchase Bill') === 0 && title.indexOf('Direct') !== 0) ? 'PurchaseBill' :
                    title.indexOf('Purchase Rejection') === 0 ? 'PurchaseRejection' :
                        title.indexOf('Sale Rejection') === 0 ? 'SaleRejection' :
                            title.indexOf('SaleInvoice') === 0 ? 'SaleInvoice' :
                                title.indexOf('Purchase Order') === 0 ? 'PurchaseOrder' :
                                    'Unknown';
        console.log("seqNo: " + SeqNo + ", " + SN);
        $.ajax({
            url: '/Tax/DeleteTaxRow',
            type: "POST",
            async: false,
            data: { "SeqNo": SeqNo, 'SN': SN },
            success: await function (data, status, xhr) {
                $('#divTaxGrid').html(data);
                ClearDRCRGrid();
                ClearAdjustmentGrid();
                var taxRowCount = $('#divTaxGrid tr').length;
                var txSum = 0;
                if ($('#divTaxGrid tr td').length > 1) {
                    for (var i = 1; i <= taxRowCount; i++) {
                        txSum += parseFloat($('#txGridAmount-' + i).text() == '.00' ? 0 : $('#txGridAmount-' + i).text());
                    }
                }
                $('#TotalTaxAmt').val(txSum);
                var rowCountTax = $('#divTaxGrid tr').length;
                var sumTax = 0;

                for (var i = 1; i <= rowCountTax; i++) {

                    sumTax = parseFloat($('#txGridAmount-' + i).text()) + parseFloat($('#lblItemNetAmount').text());
                }
                $('#NetTotall').val(sumTax.toFixed(2));
                $('#BaseNetTotal').val(sumTax.toFixed(2));

                var INA = parseFloat($('#ItemNetAmount').val());
                var TTA = parseFloat($('#TotalTaxAmt').val());
                var NT = INA + TTA;
                $('#NetTotal').val(NT.toFixed(2));
                $('#BaseNetTotal').val(NT.toFixed(2));

                if ($('#divTaxGrid').children().length == 0) {
                    var NoData = '<tr class="text-center"><td colspan="14" class="text-black-50"><strong>NO DATA ADDED</strong></td></tr>';
                    $('#divTaxGrid').html(NoData);
                    //$('#NetTotal').val(INA.toFixed(2));
                }

                $.notify('Item Deleted From Grid.', "info");
                if ($('title').text().indexOf('Job Work') == 0) {
                    GetAmtAfterDiscount();
                }
                if ($('title').text().indexOf('Direct Purchase Bill') == 0 || $('title').text().indexOf('Purchase Rejection') == 0 || $('title').text().indexOf('Sale Rejection') == 0 || ($('title').text().indexOf('Purchase Bill') == 0 && $('title').text().indexOf('Direct') != 0) || $('title').text().indexOf('SaleInvoice') == 0 || $('title').text().indexOf('Credit Note') == 0) {
                    GetDbCrDetail();
                }
                $('#TotalAmtAftrDiscount').val("0.00");
                $('#TotalDiscountPercentage').val(0);
            },
            error: function (error, status, xhr) {
                $.notify(status + " : " + error.status + " : Cannot Delete Expenses, if Tax Exists.", { position: "top center", className: "error" });
            },
            failure: function (error, status, xhr) {
                $.notify(error, { position: "top center", className: "error" });
            }
        });
    }

    if ($('#txGridName-' + SeqNo).text().includes("CGST") || $('#txGridName-' + SeqNo).text().includes("SGST")) {
        console.log("seqNo: " + SeqNo + ", " + SN + "ifCGST");
        var SN = title.indexOf('Sale Order') === 0 ? 'ItemList' :
            title.indexOf('Direct Purchase Bill') === 0 ? 'DirectPurchaseBill' :
                (title.indexOf('Purchase Bill') === 0 && title.indexOf('Direct') !== 0) ? 'PurchaseBill' :
                    title.indexOf('SaleInvoice') === 0 ? 'SaleInvoice' :
                        title.indexOf('Purchase Order') === 0 ? 'PurchaseOrder' :
                            title.indexOf('Purchase Rejection') === 0 ? 'PurchaseRejection' :
                                title.indexOf('Sale Rejection') === 0 ? 'SaleRejection' :
                                    'Unknown';
        $.ajax({
            url: '/Tax/DeleteTaxRow',
            type: "POST",
            async: false,
            data: { "SeqNo": SeqNo, 'SN': SN },
            success: await function (data, status, xhr) {
                ClearAdjustmentGrid();

                $('#divTaxGrid').html(data);
                var taxRowCount = $('#divTaxGrid tr').length;
                var txSum = 0;
                if ($('#divTaxGrid tr td').length > 1) {
                    for (var i = 1; i <= taxRowCount; i++) {
                        txSum += parseFloat($('#txGridAmount-' + i).text() == '.00' ? 0 : $('#txGridAmount-' + i).text());

                    }
                }
                $('#TotalTaxAmt').val(txSum);
                var rowCountTax = $('#divTaxGrid tr').length;
                var sumTax = 0;

                for (var i = 1; i <= rowCountTax; i++) {

                    sumTax = parseFloat($('#txGridAmount-' + i).text()) + parseFloat($('#lblItemNetAmount').text());
                }
                $('#NetTotall').val(sumTax.toFixed(2));
                $('#BaseNetTotal').val(sumTax.toFixed(2));

                var INA = parseFloat($('#ItemNetAmount').val());
                var TTA = parseFloat($('#TotalTaxAmt').val());
                var NT = INA + TTA;
                $('#BaseNetTotal').val(NT.toFixed(2));

                if ($('#divTaxGrid').children().length == 0) {
                    var NoData = '<tr class="text-center"><td colspan="14" class="text-black-50"><strong>NO DATA ADDED</strong></td></tr>';
                    $('#divTaxGrid').html(NoData);
                    //$('#NetTotal').val(INA.toFixed(2));
                }

                $.notify('Item Deleted From Grid.', "info");
                if ($('title').text().indexOf('Job Work') == 0) {
                    GetAmtAfterDiscount();
                }
                if ($('title').text().indexOf('Direct Purchase Bill') == 0 || $('title').text().indexOf('Purchase Rejection') == 0 || $('title').text().indexOf('Sale Rejection') == 0
                    || ($('title').text().indexOf('Purchase Bill') == 0 && $('title').text().indexOf('Direct') != 0) || $('title').text().indexOf('SaleInvoice') == 0) {
                    GetDbCrDetail();
                }
                $('#TotalAmtAftrDiscount').val("0.00");
                $('#TotalDiscountPercentage').val(0);
            },
            error: function (error, status, xhr) {
                $.notify(status + " : " + error.status + " : Cannot Delete Expenses, if Tax Exists.", { position: "top center", className: "error" });
            },
            failure: function (error, status, xhr) {
                $.notify(error, { position: "top center", className: "error" });
            }
        });
    }

    if (!$('#txGridName-' + SeqNo).text().includes("GST") && !$('#txGridName-' + SeqNo).text().trim().includes("IGST") && !$('#txGridName-' + SeqNo).text().includes("CGST") && !$('#txGridName-' + SeqNo).text().includes("SGST")) {
        console.log("seqNo: " + SeqNo + ", " + SN + "!=IGST=!=cgst");
        var title = $('title').text();
        var SN = title.indexOf('Sale Order') === 0 ? 'ItemList' :
            title.indexOf('Direct Purchase Bill') === 0 ? 'DirectPurchaseBill' :
                (title.indexOf('Purchase Bill') === 0 && title.indexOf('Direct') !== 0) ? 'PurchaseBill' :
                    title.indexOf('SaleInvoice') === 0 ? 'SaleInvoice' :
                        title.indexOf('Purchase Order') === 0 ? 'PurchaseOrder' :
                            title.indexOf('Purchase Rejection') === 0 ? 'PurchaseRejection' :
                                title.indexOf('Sale Rejection') === 0 ? 'SaleRejection' :
                                    'Unknown';
        console.log("seqNo: " + SeqNo + ", " + SN);

        $.ajax({
            url: '/Tax/DeleteTaxRow',
            type: "POST",
            data: { "SeqNo": SeqNo, 'SN': SN },
            success: await function (data, status, xhr) {
                ClearAdjustmentGrid();

                $('#divTaxGrid').html(data);
                var taxRowCount = $('#divTaxGrid tr').length;
                var txSum = 0;
                if ($('#divTaxGrid tr td').length > 1) {
                    for (var i = 1; i <= taxRowCount; i++) {
                        txSum += parseFloat($('#txGridAmount-' + i).text() == '.00' ? 0 : $('#txGridAmount-' + i).text());
                    }
                }
                $('#TotalTaxAmt').val(txSum);
                var rowCountTax = $('#divTaxGrid tr').length;
                var sumTax = 0;

                for (var i = 1; i <= rowCountTax; i++) {

                    sumTax = parseFloat($('#txGridAmount-' + i).text()) + parseFloat($('#lblItemNetAmount').text());
                }
                $('#NetTotall').val(sumTax.toFixed(2));
                $('#BaseNetTotal').val(sumTax.toFixed(2));

                var INA = parseFloat($('#ItemNetAmount').val());
                var TTA = parseFloat($('#TotalTaxAmt').val());
                var NT = INA + TTA;
                $('#NetTotal').val(NT.toFixed(2));
                $('#BaseNetTotal').val(NT.toFixed(2));

                if ($('#divTaxGrid').children().length == 0) {
                    var NoData = '<tr class="text-center"><td colspan="14" class="text-black-50"><strong>NO DATA ADDED</strong></td></tr>';
                    $('#divTaxGrid').html(NoData);
                    //$('#NetTotal').val(INA.toFixed(2));
                }

                $.notify('Item Deleted From Grid.', "info");
                if ($('title').text().indexOf('Job Work') == 0) {
                    GetAmtAfterDiscount();
                }
                if ($('title').text().indexOf('Direct Purchase Bill') == 0 || $('title').text().indexOf('Purchase Rejection') == 0 || $('title').text().indexOf('Sale Rejection') == 0 || ($('title').text().indexOf('Purchase Bill') == 0 && $('title').text().indexOf('Direct') != 0) || $('title').text().indexOf('SaleInvoice') == 0) {
                    GetDbCrDetail();
                }
                $('#TotalAmtAftrDiscount').val("0.00");
                $('#TotalDiscountPercentage').val(0);
            },
            error: function (error, status, xhr) {
                $.notify(status + " : " + error.status + " : Cannot Delete Expenses, if Tax Exists.", { position: "top center", className: "error" });
            },
            failure: function (error, status, xhr) {
                $.notify(error, { position: "top center", className: "error" });
            }
        });
        SeqNo = SeqNo - 1;
    }

    var taxRowCount = $('#divTaxGrid tr').length;
    var txSum = 0;
    if ($('#divTaxGrid tr td').length > 1) {
        for (var i = 1; i <= taxRowCount; i++) {
            txSum += parseFloat($('#txGridAmount-' + i).text() == '.00' ? 0 : $('#txGridAmount-' + i).text());
        }
    }

    $('#TotalTaxAmt').val(txSum);
    var INA = parseFloat($('#ItemNetAmount').val());
    var TTA = parseFloat($('#TotalTaxAmt').val());
    var NT = INA + TTA;
    $('#NetTotal').val(NT.toFixed(2));
    $('#BaseNetTotal').val(NT.toFixed(2));
}

async function GetIssueTaxInfo() {
    var isIssueTax;
    const uri = '/Tax/GetIssueTaxInfo';

    $.ajax({
        type: "POST",
        url: uri,
        async: false,
        success: await function (response) {
            isIssueTax = response.isTax;
        },
        error: function (err) {
            $.notify(err.responseText, { position: "top center", className: "error" });
        }
    });
    return isIssueTax;
}
//async function DeleteIssueTaxRow(SeqNo) {
//     
//    var SN = $('title').text().indexOf('Issue NonRetuanable') === 0 ? 'IssueNRGP' : 'PurchaseOrder';

//    if ($('#txGridName-' + SeqNo).text().includes("GST") && $('#txGridName-' + SeqNo).text() != "IGST") {
//        if ($('#txGridName-' + SeqNo).text().includes("CGST")) {
//            $.ajax({
//                url: '/Tax/DeleteIssueTaxRow',
//                type: "POST",
//                data: { "SeqNo": SeqNo, 'SN': SN },
//                success: await function (data, status, xhr) {
//                    $('#divTaxGrid').html(data);
//                    var taxRowCount = $('#divTaxGrid tr').length;
//                    var txSum = 0;
//                    if ($('#divTaxGrid tr td').length > 1) {
//                        for (var i = 1; i <= taxRowCount; i++) {
//                            txSum += parseInt($('#txGridAmount-' + i).text() == '.00' ? 0 : $('#txGridAmount-' + i).text());

//                        }
//                    }
//                    $('#TotalTaxAmt').val(txSum);
//                    var INA = parseFloat($('#ItemNetAmount').val());
//                    var TTA = parseFloat($('#TotalTaxAmt').val());
//                    var NT = INA + TTA;
//                    $('#NetTotal').val(NT.toFixed(2));

//                    if ($('#divTaxGrid').children().length == 0) {
//                        var NoData = '<tr class="text-center"><td colspan="14" class="text-black-50"><strong>NO DATA ADDED</strong></td></tr>';
//                        $('#divTaxGrid').html(NoData);
//                        //$('#NetTotal').val(INA.toFixed(2));
//                    }

//                    $.notify('Item Deleted From Grid.', "info");
//                    if ($('title').text().indexOf('Job Work') == 0) {
//                        GetAmtAfterDiscount();
//                    }
//                    $('#TotalAmtAftrDiscount').val("0.00");
//                    $('#TotalDiscountPercentage').val(0);
//                },
//                error: function (error, status, xhr) {
//                    $.notify(status + " : " + error.status + " : Cannot Delete Expenses, if Tax Exists.", { position: "top center", className: "error" });
//                },
//                failure: function (error, status, xhr) {
//                    $.notify(error, { position: "top center", className: "error" });
//                }
//            });
//        } else {
//            $.ajax({
//                url: '/Tax/DeleteIssueTaxRow',
//                type: "POST",
//                data: { "SeqNo": SeqNo, 'SN': SN },
//                success: await function (data, status, xhr) {
//                    $('#divTaxGrid').html(data);
//                    var taxRowCount = $('#divTaxGrid tr').length;
//                    var txSum = 0;
//                    if ($('#divTaxGrid tr td').length > 1) {
//                        for (var i = 1; i <= taxRowCount; i++) {
//                            txSum += parseInt($('#txGridAmount-' + i).text() == '.00' ? 0 : $('#txGridAmount-' + i).text());

//                        }
//                    }
//                    $('#TotalTaxAmt').val(txSum);
//                    var INA = parseFloat($('#ItemNetAmount').val());
//                    var TTA = parseFloat($('#TotalTaxAmt').val());
//                    var NT = INA + TTA;
//                    $('#NetTotal').val(NT.toFixed(2));

//                    if ($('#divTaxGrid').children().length == 0) {
//                        var NoData = '<tr class="text-center"><td colspan="14" class="text-black-50"><strong>NO DATA ADDED</strong></td></tr>';
//                        $('#divTaxGrid').html(NoData);
//                        //$('#NetTotal').val(INA.toFixed(2));
//                    }

//                    $.notify('Item Deleted From Grid.', "info");
//                    if ($('title').text().indexOf('Job Work') == 0) {
//                        GetAmtAfterDiscount();
//                    }
//                    $('#TotalAmtAftrDiscount').val("0.00");
//                    $('#TotalDiscountPercentage').val(0);
//                },
//                error: function (error, status, xhr) {
//                    $.notify(status + " : " + error.status + " : Cannot Delete Expenses, if Tax Exists.", { position: "top center", className: "error" });
//                },
//                failure: function (error, status, xhr) {
//                    $.notify(error, { position: "top center", className: "error" });
//                }
//            });
//        }
//    }

//    $.ajax({
//        url: '/Tax/DeleteIssueTaxRow',
//        type: "POST",
//        data: { "SeqNo": SeqNo, 'SN': SN },
//        success: await function (data, status, xhr) {
//            $('#divTaxGrid').html(data);
//            var taxRowCount = $('#divTaxGrid tr').length;
//            var txSum = 0;
//            if ($('#divTaxGrid tr td').length > 1) {
//                for (var i = 1; i <= taxRowCount; i++) {
//                    txSum += parseInt($('#txGridAmount-' + i).text() == '.00' ? 0 : $('#txGridAmount-' + i).text());

//                }
//            }
//            $('#TotalTaxAmt').val(txSum);
//            var INA = parseFloat($('#ItemNetAmount').val());
//            var TTA = parseFloat($('#TotalTaxAmt').val());
//            var NT = INA + TTA;
//            $('#NetTotal').val(NT.toFixed(2));

//            if ($('#divTaxGrid').children().length == 0) {
//                var NoData = '<tr class="text-center"><td colspan="14" class="text-black-50"><strong>NO DATA ADDED</strong></td></tr>';
//                $('#divTaxGrid').html(NoData);
//                //$('#NetTotal').val(INA.toFixed(2));
//            }

//            $.notify('Item Deleted From Grid.', "info");
//            if ($('title').text().indexOf('Job Work') == 0) {
//                GetAmtAfterDiscount();
//            }
//            $('#TotalAmtAftrDiscount').val("0.00");
//            $('#TotalDiscountPercentage').val(0);
//        },
//        error: function (error, status, xhr) {
//            $.notify(status + " : " + error.status + " : Cannot Delete Expenses, if Tax Exists.", { position: "top center", className: "error" });
//        },
//        failure: function (error, status, xhr) {
//            $.notify(error, { position: "top center", className: "error" });
//        }
//    });
//}

async function DeleteIssueTaxRow(SeqNo) {
    ;
    if ($('#txGridName-' + SeqNo).text().includes("GST") && $('#txGridName-' + SeqNo).text() != "IGST") {
        if ($('#txGridName-' + SeqNo).text().includes("CGST")) {
            var SN = $('title').text().indexOf('Issue NonRetuanable') === 0 ? 'IssueNRGP' : ($('title').text().indexOf('Direct Purchase Bill') === 0 ? 'DirectPurchaseBill' : ($('title').text().indexOf('Purchase Bill') === 0 && $('title').text().indexOf('Direct') !== 0 ? 'PurchaseBill' : 'PurchaseOrder'));
            SN = $('title').text().indexOf('Purchase Rejection') === 0 ? 'PurchaseRejection' : SN;
            SN = $('title').text().indexOf('Sale Rejection') === 0 ? 'SaleRejection' : SN;
            $.ajax({
                url: '/Tax/DeleteIssueTaxRow',
                type: "POST",
                data: { "SeqNo": SeqNo, 'SN': SN },
                success: await function (data, status, xhr) {
                    $('#divTaxGrid').html(data);
                    var taxRowCount = $('#divTaxGrid tr').length;
                    var txSum = 0;
                    if ($('#divTaxGrid tr td').length > 1) {
                        for (var i = 1; i <= taxRowCount; i++) {
                            txSum += parseFloat($('#txGridAmount-' + i).text() == '.00' ? 0 : $('#txGridAmount-' + i).text());
                        }
                    }
                    $('#TotalTaxAmt').val(txSum);
                    var rowCountTax = $('#divTaxGrid tr').length;
                    var sumTax = 0;

                    for (var i = 1; i <= rowCountTax; i++) {

                        sumTax = parseFloat($('#txGridAmount-' + i).text()) + parseFloat($('#lblItemNetAmount').text());
                    }
                    $('#NetTotall').val(sumTax.toFixed(2));
                    $('#BaseNetTotal').val(sumTax.toFixed(2));

                    var INA = parseFloat($('#ItemNetAmount').val());
                    var TTA = parseFloat($('#TotalTaxAmt').val());
                    var NT = INA + TTA;
                    $('#BaseNetTotal').val(NT.toFixed(2));

                    if ($('#divTaxGrid').children().length == 0) {
                        var NoData = '<tr class="text-center"><td colspan="14" class="text-black-50"><strong>NO DATA ADDED</strong></td></tr>';
                        $('#divTaxGrid').html(NoData);
                        //$('#NetTotal').val(INA.toFixed(2));
                    }

                    $.notify('Item Deleted From Grid.', "info");
                    if ($('title').text().indexOf('Job Work') == 0) {
                        GetAmtAfterDiscount();
                    }
                    $('#TotalAmtAftrDiscount').val("0.00");
                    $('#TotalDiscountPercentage').val(0);
                },
                error: function (error, status, xhr) {
                    $.notify(status + " : " + error.status + " : Cannot Delete Expenses, if Tax Exists.", { position: "top center", className: "error" });
                },
                failure: function (error, status, xhr) {
                    $.notify(error, { position: "top center", className: "error" });
                }
            });
        }
        else {
            var SN = $('title').text().indexOf('Issue NonRetuanable') === 0 ? 'IssueNRGP' : ($('title').text().indexOf('Direct Purchase Bill') === 0 ? 'DirectPurchaseBill' : ($('title').text().indexOf('Purchase Bill') === 0 && $('title').text().indexOf('Direct') !== 0 ? 'PurchaseBill' : 'PurchaseOrder'));
            SN = $('title').text().indexOf('Purchase Rejection') === 0 ? 'PurchaseRejection' : SN;
            SN = $('title').text().indexOf('Sale Rejection') === 0 ? 'SaleRejection' : SN;
            $.ajax({
                url: '/Tax/DeleteIssueTaxRow',
                type: "POST",
                data: { "SeqNo": SeqNo, 'SN': SN },
                success: await function (data, status, xhr) {
                    $('#divTaxGrid').html(data);
                    var taxRowCount = $('#divTaxGrid tr').length;
                    var txSum = 0;
                    if ($('#divTaxGrid tr td').length > 1) {
                        for (var i = 1; i <= taxRowCount; i++) {
                            txSum += parseFloat($('#txGridAmount-' + i).text() == '.00' ? 0 : $('#txGridAmount-' + i).text());

                        }
                    }
                    $('#TotalTaxAmt').val(txSum);
                    var rowCountTax = $('#divTaxGrid tr').length;
                    var sumTax = 0;

                    for (var i = 1; i <= rowCountTax; i++) {

                        sumTax = parseFloat($('#txGridAmount-' + i).text()) + parseFloat($('#lblItemNetAmount').text());
                    }
                    $('#NetTotall').val(sumTax.toFixed(2));
                    $('#BaseNetTotal').val(sumTax.toFixed(2));

                    var INA = parseFloat($('#ItemNetAmount').val());
                    var TTA = parseFloat($('#TotalTaxAmt').val());
                    var NT = INA + TTA;
                    $('#NetTotal').val(NT.toFixed(2));
                    $('#BaseNetTotal').val(NT.toFixed(2));

                    if ($('#divTaxGrid').children().length == 0) {
                        var NoData = '<tr class="text-center"><td colspan="14" class="text-black-50"><strong>NO DATA ADDED</strong></td></tr>';
                        $('#divTaxGrid').html(NoData);
                        //$('#NetTotal').val(INA.toFixed(2));
                    }

                    $.notify('Item Deleted From Grid.', "info");
                    if ($('title').text().indexOf('Job Work') == 0) {
                        GetAmtAfterDiscount();
                    }
                    $('#TotalAmtAftrDiscount').val("0.00");
                    $('#TotalDiscountPercentage').val(0);
                },
                error: function (error, status, xhr) {
                    $.notify(status + " : " + error.status + " : Cannot Delete Expenses, if Tax Exists.", { position: "top center", className: "error" });
                },
                failure: function (error, status, xhr) {
                    $.notify(error, { position: "top center", className: "error" });
                }
            });
            SeqNo = SeqNo - 1;
        }
    }

    var SN = $('title').text().indexOf('Issue NonRetuanable') === 0 ? 'IssueNRGP' : ($('title').text().indexOf('Direct Purchase Bill') === 0 ? 'DirectPurchaseBill' : ($('title').text().indexOf('Purchase Bill') === 0 && $('title').text().indexOf('Direct') !== 0 ? 'PurchaseBill' : 'PurchaseOrder'));
    SN = $('title').text().indexOf('Purchase Rejection') === 0 ? 'PurchaseRejection' : SN;
    SN = $('title').text().indexOf('Sale Rejection') === 0 ? 'SaleRejection' : SN;
    $.ajax({
        url: '/Tax/DeleteIssueTaxRow',
        type: "POST",
        data: { "SeqNo": SeqNo, 'SN': SN },
        success: await function (data, status, xhr) {
            $('#divTaxGrid').html(data);
            var taxRowCount = $('#divTaxGrid tr').length;
            var txSum = 0;
            if ($('#divTaxGrid tr td').length > 1) {
                for (var i = 1; i <= taxRowCount; i++) {
                    txSum += parseFloat($('#txGridAmount-' + i).text() == '.00' ? 0 : $('#txGridAmount-' + i).text());

                }
            }
            $('#TotalTaxAmt').val(txSum);
            var rowCountTax = $('#divTaxGrid tr').length;
            var sumTax = 0;

            for (var i = 1; i <= rowCountTax; i++) {

                sumTax = parseFloat($('#txGridAmount-' + i).text()) + parseFloat($('#lblItemNetAmount').text());
            }
            $('#NetTotall').val(sumTax.toFixed(2));
            $('#BaseNetTotal').val(sumTax.toFixed(2));

            var INA = parseFloat($('#ItemNetAmount').val());
            var TTA = parseFloat($('#TotalTaxAmt').val());
            var NT = INA + TTA;
            $('#NetTotal').val(NT.toFixed(2));
            $('#BaseNetTotal').val(NT.toFixed(2));

            if ($('#divTaxGrid').children().length == 0) {
                var NoData = '<tr class="text-center"><td colspan="14" class="text-black-50"><strong>NO DATA ADDED</strong></td></tr>';
                $('#divTaxGrid').html(NoData);
                //$('#NetTotal').val(INA.toFixed(2));
            }

            $.notify('Item Deleted From Grid.', "info");
            if ($('title').text().indexOf('Job Work') == 0) {
                GetAmtAfterDiscount();
            }
            $('#TotalAmtAftrDiscount').val("0.00");
            $('#TotalDiscountPercentage').val(0);
        },
        error: function (error, status, xhr) {
            $.notify(status + " : " + error.status + " : Cannot Delete Expenses, if Tax Exists.", { position: "top center", className: "error" });
        },
        failure: function (error, status, xhr) {
            $.notify(error, { position: "top center", className: "error" });
        }
    });
}
async function ApplyTax4HSN() {
    ClearAdjustmentGrid();
    var TxPageName = $('title').text();
    if ($('#TxType').val() == 'TAX' && $('#TxPartCode').prop('selectedIndex') == 0 && $('#TxItemCode').prop('selectedIndex') == 0) {
        var TxPageData;

        if (TxPageName.indexOf('Sale Order') === 0) {
            TxPageData = 'ItemList';
        }
        else if (TxPageName.indexOf('Purchase Order') == 0) {
            TxPageData = 'PurchaseOrder';
        }
        else if (TxPageName.indexOf('Issue NonRetuanable') == 0) {
            TxPageData = 'IssueNRGP';
        }
        else if (TxPageName.indexOf('Direct Purchase Bill') == 0) {
            TxPageData = 'DirectPurchaseBill';
        }
        else if (TxPageName.indexOf('Purchase Bill') == 0 && TxPageName.indexOf('Direct') != 0) {
            TxPageData = 'PurchaseBill';
        }
        else if (TxPageName.indexOf('SaleInvoice') == 0) {
            TxPageData = 'SaleInvoice';
        }
        else if (TxPageName.indexOf('Credit Note') == 0) {
            TxPageData = 'CreditNote';
        }
        else if (TxPageName.indexOf('Purchase Rejection') == 0) {
            TxPageData = 'PurchaseRejection';
        }
        else if (TxPageName.indexOf('Sale Rejection') == 0) {
            TxPageData = 'SaleRejection';
        }
        else {
            TxPageData = 'JobWorkIssue';
        }
        TxPageName = TxPageData;
        var AC = TxPageName.indexOf('SaleOrder') == -1 ? parseInt($('#AccountCode').val()) : (TxPageName.indexOf('PurchaseOrder') == 0 || TxPageName.indexOf('DirectPurchaseBill') == 0 || TxPageName.indexOf('PurchaseBill') == 0) ? parseInt($('#AccountCode').val()) : "";
        if (TxPageName.indexOf('JobWorkIssue') == 0) {
            AC = parseInt($('#AccountCode').val());
        }
        if (TxPageName.indexOf('SaleInvoice') == 0) {
            AC = parseInt($('#AccountCode').val());
        }
        if (TxPageName.indexOf('CreditNote') == 0) {
            AC = parseInt($('#AccountCode').val());
        }
        if (TxPageName.indexOf('PurchaseRejection') == 0) {
            AC = parseInt($('#AccountCode').val());
        }
        if (TxPageName.indexOf('SaleRejection') == 0) {
            AC = parseInt($('#AccountCode').val());
        }
        const RF = $('#TxRoundOff').prop('selectedIndex') === 0 || $('#TxRoundOff').prop('selectedIndex') === 1 ? 'YES' : 'NO';
        var isTax = await GetTaxInfo();
        console.log(isTax);
        if (isTax == true) {
            $.notify("Please Clear Tax Detail...!", { position: "top center", className: "info" });
            return;
        }

        var isIssueTax = await GetIssueTaxInfo();
        if (isIssueTax == true) {
            $.notify("Please Clear Tax Detail...!", { position: "top center", className: "info" });
            return;
        }

        var objData = await GetHsnTaxInfo(AC, TxPageName, RF);

        if (objData.indexOf('DeleteTaxRow(1)') !== -1) {

            if (objData.trim()) {
                $('#divTaxGrid').html(objData);
                //$('#divTaxGrid').html(resp);
                var taxRowCount = $('#divTaxGrid tr').length;
                var txSum = 0;
                if ($('#divTaxGrid tr td').length > 1) {
                    for (var i = 1; i <= taxRowCount; i++) {
                        txSum += parseFloat($('#txGridAmount-' + i).text() == '.00' ? 0 : $('#txGridAmount-' + i).text());
                    }
                }

                $('#TotalTaxAmt').val(txSum);
                var INA = parseFloat($('#ItemNetAmount').val());
                var TTA = parseFloat($('#TotalTaxAmt').val());
                var NT = INA + TTA;
                $('#NetTotal').val(NT.toFixed(2));
                $('#BaseNetTotal').val(NT.toFixed(2));
                $('#AdjPendAmt').val(parseFloat($('#NetTotal').val() || 0).toFixed(2));
                if (TxPageData == 'PurchaseBill') {
                    onInvoiceChange('InvNo');
                } else if (TxPageData == 'SaleInvoice') {
                    onInvoiceChange('SaleBillNo');
                } else if (TxPageData == 'PurchaseRejection') {
                    onInvoiceChange('PurchaseRejectionInvoiceNo');
                } else if (TxPageData == 'SaleRejection') {
                    onInvoiceChange('SalerejCreditNoteVoucherNo');
                }
                else {
                    onInvoiceChange('InvoiceNo');
                }
                ClearTax();
            }
            if ($('title').text().indexOf('Job Work') == 0) {
                GetAmtAfterDiscount();
            }
            if ($('title').text().indexOf('Direct Purchase Bill') == 0 || $('title').text().indexOf('Purchase Rejection') == 0 || ($('title').text().indexOf('Purchase Bill') == 0 && $('title').text().indexOf('Direct') != 0) || $('title').text().indexOf('SaleInvoice') == 0 ||
                $('title').text().indexOf('Sale Rejection') == 0 || $('title').text().indexOf('Credit Note') == 0) {
                GetDbCrDetail();
                AddAdjstmntDetail1();
            }
        }
        else if (objData.indexOf('DeleteIssueTaxRow(1)') !== -1) {
            if (objData.trim()) {
                $('#divTaxGrid').html(objData);
                //$('#divTaxGrid').html(resp);
                var taxRowCount = $('#divTaxGrid tr').length;
                var txSum = 0;
                if ($('#divTaxGrid tr td').length > 1) {
                    for (var i = 1; i <= taxRowCount; i++) {
                        txSum += parseFloat($('#txGridAmount-' + i).text() == '.00' ? 0 : $('#txGridAmount-' + i).text());

                    }
                }

                $('#TotalTaxAmt').val(txSum);
                var INA = parseFloat($('#ItemNetAmount').val());
                var TTA = parseFloat($('#TotalTaxAmt').val());
                var NT = INA + TTA;
                $('#NetTotal').val(NT.toFixed(2));
                $('#BaseNetTotal').val(NT.toFixed(2));
                $('#AdjPendAmt').val(parseFloat($('#NetTotal').val() || 0).toFixed(2));
                if (TxPageData == 'PurchaseBill') {
                    onInvoiceChange('InvNo');
                }
                else if (TxPageData == 'SaleInvoice') {
                    onInvoiceChange('SaleBillNo');
                }
                else if (TxPageData == 'PurchaseRejection') {
                    onInvoiceChange('PurchaseRejectionInvoiceNo');
                }
                else if (TxPageData == 'SaleRejection') {
                    onInvoiceChange('SalerejCreditNoteVoucherNo');
                }
                else {
                    onInvoiceChange('InvoiceNo');
                }
                ClearTax();
            }
            if ($('title').text().indexOf('Job Work') == 0) {
                GetAmtAfterDiscount();
            }
            if ($('title').text().indexOf('Direct Purchase Bill') == 0 || $('title').text().indexOf('Purchase Rejection') == 0 || $('title').text().indexOf('Sale Rejection') == 0 || ($('title').text().indexOf('Purchase Bill') == 0 && $('title').text().indexOf('Direct') != 0) || $('title').text().indexOf('SaleInvoice') == 0 || $('title').text().indexOf('Credit Note') == 0) {
                GetDbCrDetail();
                AddAdjstmntDetail1();
            }
        }
        else {
            console.log("error hereeeeee");
            $.notify(objData, { position: "top center", className: "error" });
        }
    }
}


//(async function () {
//    let books = await GetTaxInfo();
//    console.log(books);
//})();


async function GetTaxInfo() {
    var isTax;
    const uri = '/Tax/GetTaxInfo';

    //$.get(uri, async: false, await function (data, status) {
    //    //console.log("Data: " + data.isTax + "\nStatus: " + status);
    //    isTax = data.isTax;
    //    return isTax;
    //});

    //fetch(uri).then(function (response) {
    //    isTax = response.isTax;
    //    // return response; // <- I tried that one as well
    //});

    //var httpRequest = new XMLHttpRequest();
    //httpRequest.open('GET', "/Tax/GetTaxInfo");
    //httpRequest.send();
    //return httpRequest.responseText;

    $.ajax({
        type: "POST",
        url: uri,
        async: false,
        success: await function (response) {
            isTax = response.isTax;
        },
        error: function (err) {
            $.notify(err.responseText, { position: "top center", className: "error" });
        }
    });
    return isTax;
}


async function GetHsnTaxInfo(AC, TxPageName, RF) {

    if ($('#AccountCode').val() == 0) {
        $.notify("Please select PartyName", "error");
        return;
    }

    const uri = '/Tax/GetHsnTaxInfo';
    var objData;
    $.ajax({
        type: "POST",
        url: uri,
        //dataType: "json",
        async: false,
        data: { 'AC': AC, 'TxPageName': TxPageName, 'RF': RF },
        success: await function (resp) {
            //ClearAdjustmentGrid();

            objData = resp;
            if (resp.trim() == "") {
                $.notify('Adding Duplicate Tax Is Not Allowed...!', "info");
            }
            //if (resp.startsWith("Error") || resp.startsWith("Failed") || resp.indexOf("<") === -1) {
            //    $.notify(resp, "error");
            //    return;
            //}
            // else {
            //ClearAdjustmentGrid();
            $('#divTaxGrid').html(resp);
            var taxRowCount = $('#divTaxGrid tr').length;
            var txSum = 0;
            if ($('#divTaxGrid tr td').length > 1) {
                for (var i = 1; i <= taxRowCount; i++) {
                    txSum += parseFloat($('#txGridAmount-' + i).text() == '.00' ? 0 : $('#txGridAmount-' + i).text());
                }
            }

            $('#TotalTaxAmt').val(txSum);
            var INA = parseFloat($('#ItemNetAmount').val());
            var TTA = parseFloat($('#TotalTaxAmt').val());
            var NT = INA + TTA;

            $('#NetTotal').val(NT.toFixed(2));
            $('#BaseNetTotal').val(NT.toFixed(2));
            $('#TxType').prop('selectedIndex', 0).change();
            $('#AdjPendAmt').val(parseFloat($('#NetTotal').val() || 0).toFixed(2));
            // }
            if (TxPageName == 'JobWorkIssue') {
                GetAmtAfterDiscount();
            }
            if (TxPageName == 'DirectPurchaseBill' || TxPageName == 'PurchaseBill' || TxPageName == 'SaleInvoice' || TxPageName == 'SaleRejection' || TxPageName == 'CreditNote' || TxPageName == 'PurchaseRejection') {
                GetDbCrDetail();
            }
            ClearTax();
        },
        error: function (err) {
            console.log(err);
            $.notify(err.responseText, { position: "top center", className: "error" });
        }
    });
    return objData;
}
$.notify.defaults({
    autoHideDelay: 10000,
    position: 'top center',
    autoHide: true,
    clickToHide: true
});
var currentSearchColumn = null;
$("#taxsearch-box").on("keyup", function () {
    var value = $(this).val().toLowerCase();
    $("#divTaxGrid tr").filter(function () {
        if (currentSearchColumn !== null) {
            var columnText = $(this).find('td').eq(currentSearchColumn).text().toLowerCase();
            $(this).toggle(columnText.indexOf(value) > -1);
        } else {
            $(this).toggle($(this).text().toLowerCase().indexOf(value) > -1);
        }
    });
});

$(document).on("click", "th[data-columnno]", function () {
    currentSearchColumn = $(this).data('columnno');
    $("#taxsearch-box").val('').trigger('keyup'); // Reset search box and trigger the search
});

//******** TDS DETAIL *******//

function FillTDSTaxType() {
    $.ajax({
        type: "POST",
        url: "/TDS/FillTDSTaxType",
        data: { "Flag": "FillTaxType" },
        dataType: "json",
        async: false,
        success: function (data, status, error) {

            $('#TDSTaxType').empty();
            $('#TDSTaxType').append('<option>-Select-</option>');
            $.each(data.txType, function (key, val) {
                $('#TDSTaxType').append('<option value="' + val.value + '">' + val.text + '</option>');
            });

            //$('#TxAccountCode').empty();
            //$('#TxAccountCode').append('<option>-Select-</option>');
            //$.each(data.txName, function (key, val) {
            //    $('#TxAccountCode').append('<option value="' + val.value + '">' + val.text + '</option>');
            //});
        },
        error: function (req, status, error) {
            $.notify(error, { position: "top center", className: "error" });
        }
    }).done(function (req, status, error) {

    });
}

function ClearTDS() {
    $('#TDSTaxType').prop('selectedIndex', 0).removeClass('is-invalid'), $('#TDSAccountCode').prop('selectedIndex', 0).removeClass('is-invalid'), $('#TDSPercentg').val(0).removeAttr('readonly').removeClass('is-invalid'),
        $('#TDSRoundOff').prop('selectedIndex', 0).removeClass('is-invalid'),
        $('#TDSAmount').val(0.00).removeAttr('readonly').removeClass('is-invalid'), $('#TDSRemark').val('').removeClass('is-invalid');
    //$('#TotalDiscountPercentage').val('0');
    //$('#TotalAmtAftrDiscount').val('0.00');
}

async function GetTDSTaxTypeName(Flag) {
    $.ajax({
        type: "POST",
        url: "/TDS/GetTaxTypeName",
        data: { "Flag": Flag },
        dataType: "json",
        async: false,
        success: function (data, status, error) {
            //if (Flag == 'EXPENSES') {
            $('#TDSTaxType').empty();
            $('#TDSTaxType').append('<option>-Select-</option>');
            $.each(data.txType, function (key, val) {
                $('#TDSTaxType').append('<option value="' + val.value + '">' + val.text + '</option>');
            });
            //}

            $('#TDSAccountCode').empty();
            $('#TDSAccountCode').append('<option>-Select-</option>');
            $.each(data.txName, function (key, val) {
                $('#TDSAccountCode').append('<option value="' + val.value + '">' + val.text + '</option>');
            });
        },
        error: function (req, status, error) {
            $.notify(error, { position: "top center", className: "error" });
        }
    }).done(function (req, status, error) {

    });
}

async function GetTDSAccountName(Flag) {
    $.ajax({
        type: "POST",
        url: "/TDS/GetTDSAccountName",
        data: { "Flag": Flag, AccountCode: $('#AccountCode').val(), TDSTaxType: $('#TDSTaxType').find(":selected").text(), vendorStateCode: $('#AccountCode').find(':selected').data('state') },
        dataType: "json",
        async: false,
        success: function (data, status, error) {
            $('#TDSAccountCode').empty();
            $('#TDSAccountCode').append('<option>-Select-</option>');
            $.each(data.tdsName, function (key, val) {
                $('#TDSAccountCode').append('<option value="' + val.value + '">' + val.text + '</option>');
            });
        },
        error: function (req, status, error) {
            $.notify(error, { position: "top center", className: "error" });
        }
    }).done(function (req, status, error) {

    });
}


$('#TDSTaxType').change(function () {
    if ($(this).prop('selectedIndex') != 0) {
        $('#TDSRoundOff').prop('selectedIndex', 0);
        if ($(this).val() !== "25") {
            $('.divTDS2All').fadeOut();
        }
        else {
            $('.divTDS2All').fadeIn();
        }
        GetTDSAccountName("TDSTAX");

    }
    else {
        $('#TDSAccountCode').empty();
        $('#TDSAccountCode').append('<option>-Select-</option>');
    }
});


$('#TDSAccountCode').change(function () {
    $('#TDSRoundOff').prop('selectedIndex', 0);
    if ($(this).prop('selectedIndex') != 0) {
        $.ajax({
            type: "POST",
            url: "/TDS/GetTDSPercentage",
            data: { "TDSCode": $(this).val() },
            dataType: "json",
            success: function (data, status, error) {
                if (data) {
                    $('#TDSPercentg').val(data);
                    //var INA = parseFloat($('#lblItemNetAmount').text());
                    //var TTA = data != null && data > 0 ? parseFloat(data) : 0;
                    //TTA = TTA == "NAN" ? 0.00 : TTA;
                    //var NT = (INA * TTA) / 100;
                    //$('#TDSAmount').val(NT.toFixed(2));
                    //$('#TDSAmount').prop("readonly", "readonly");
                }
                CalculateTDSAmount();
            },
            error: function (req, status, error) {
                $.notify(error, { position: "top center", className: "error" });
            }
        });
    }
    else {
        $('#TDSPercentg').val(0);
    }
});


$('.btnAddTDS2Grid').click(function (e) {

    e.preventDefault();
    e.stopImmediatePropagation();
    e.stopPropagation();
    ClearAdjustmentGrid();

    var PageName = $('title').text();

    var Typ = $('#SOType').val();

    var isErr = 0;
    if (!$('#TDSTaxType').val() || $('#TDSTaxType').prop('selectedIndex') == 0) {
        AddErrorCls('TDSTaxType');
        isErr = 1;
    }
    else {
        $('#TDSTaxType').removeClass('is-invalid');
        if ($('#TDSTaxType').val() != "25") {
            isErr = 0;
        }
    }

    if (!$('#TDSAccountCode').val() || $('#TDSAccountCode').prop('selectedIndex') == 0) {
        AddErrorCls('TDSAccountCode');
        isErr = 1;
    }
    else {
        $('#TDSAccountCode').removeClass('is-invalid');
    }

    if ($('#TDSAccountCode').val() == 928 || $('#TDSAccountCode').val() == 944 || $('#TDSAccountCode').val() == 946 || $('#TDSAccountCode').val() == 950 || $('#TDSAccountCode').val() == 990 || $('#TDSAccountCode').val() == 1006 || $('#TDSAccountCode').val() == 1059 || $('#TDSAccountCode').val() == 1060 || $('#TDSAccountCode').val() == 1061 || $('#TDSAccountCode').val() == 1062 || $('#TDSAccountCode').val() == 1728) {
        /*$.notify('Please fill CGST Tax Detail First..!', { position: "top center", className: "error" });*/
        AddErrorCls('TDSAccountCode');
        isErr = 1;
    }
    else {
        $('#TDSAccountCode').removeClass('is-invalid');
    }

    if (!$('#TDSPercentg').val() || $('#TDSPercentg').val() <= 0) {
        AddErrorCls('TDSPercentg');
        isErr = 1;
    }
    else {
        $('#TDSPercentg').removeClass('is-invalid');
    }

    if (!$('#TDSRoundOff').val() || $('#TDSRoundOff').prop('selectedIndex') == 0) {
        AddErrorCls('TDSRoundOff');
        isErr = 1;
    }
    else {
        $('#TDSRoundOff').removeClass('is-invalid');
    }

    if (!$('#TDSAmount').val() || $('#TDSAmount').val() <= 0) {
        AddErrorCls('TDSAmount');
        isErr = 1;
    }
    else {
        $('#TDSAmount').removeClass('is-invalid');
    }

    $('#TDSPercentg').removeClass('is-invalid');

    if (!$('#TDSTaxType').val() || $('#TDSTaxType').prop('selectedIndex') == 0) {
        AddErrorCls('TDSTaxType');
        isErr = 1;
    }
    else {
        $('#TDSTaxType').removeClass('is-invalid');
    }

    if (!$('#TDSAccountCode').val() || $('#TDSAccountCode').prop('selectedIndex') == 0) {
        AddErrorCls('TDSAccountCode');
        isErr = 1;
    }
    else {
        $('#TDSAccountCode').removeClass('is-invalid');
    }

    if (!$('#TDSRoundOff').val() || $('#TDSRoundOff').prop('selectedIndex') == 0) {
        AddErrorCls('TDSRoundOff');
        isErr = 1;
    }
    else {
        $('#TDSRoundOff').removeClass('is-invalid');
    }

    if (!$('#TDSAmount').val() || $('#TDSAmount').val() <= 0) {
        AddErrorCls('TDSAmount');
        isErr = 1;
    }
    else {
        $('#TDSAmount').removeClass('is-invalid');
    }

    if (isErr == 1) {
        if ($('#TDSAccountCode').val() == 928 || $('#TDSAccountCode').val() == 944 || $('#TDSAccountCode').val() == 946 || $('#TDSAccountCode').val() == 950 || $('#TxAccountCode').val() == 990 || $('#TDSAccountCode').val() == 1006 || $('#TDSAccountCode').val() == 1059 || $('#TDSAccountCode').val() == 1060 || $('#TDSAccountCode').val() == 1061 || $('#TDSAccountCode').val() == 1062 || $('#TDSAccountCode').val() == 1728) {
            $.notify('Please fill First CGST TDS Detail..!', { position: "top center", className: "error" });
        } else {
            $.notify('Please fill TDS Detai Properly..!', { position: "top center", className: "error" });
        }
        return false;
    }
    else {

        AddTDSDetail();
    }
});

function AddTDSDetail() {

    var TxPageName = $('title').text();
    var TxPageData;
    if (TxPageName.indexOf('Sale Order') === 0) {
        TxPageData = 'ItemList';
    }
    else if (TxPageName.indexOf('Purchase Order') == 0) {
        TxPageData = 'PurchaseOrder';
    }
    else if (TxPageName.indexOf('Issue NonRetuanable') == 0) {
        TxPageData = 'IssueNRGP';
    }
    else if (TxPageName.indexOf('Direct Purchase Bill') == 0) {
        TxPageData = 'DirectPurchaseBill';
    }
    else if (TxPageName.indexOf('Purchase Bill') == 0 && TxPageName.indexOf('Direct') != 0) {
        TxPageData = 'PurchaseBill';
    }
    else {
        TxPageData = 'JobWorkIssue';
    }
    var TDSData = {
        "TDSTaxType": $('#TDSTaxType').val(),
        "TDSTaxTypeName": $('#TDSTaxType option:selected').text(),
        "TDSAccountCode": $('#TDSAccountCode').val(),
        "TDSAccountName": $('#TDSAccountCode option:selected').text(),
        "TDSPercentg": parseFloat($('#TDSPercentg').val().trim()),
        "TDSRoundOff": $('#TDSRoundOff').val(),
        "TDSRoundOffAmt": $('#TDSRoundOffAmt').val().trim() != null && $('#TDSRoundOffAmt').val().trim() != undefined && $('#TDSRoundOffAmt').val().trim() != '' ? parseFloat($('#TDSRoundOffAmt').val().trim()) : 0,
        "TDSAmount": parseFloat($('#TDSAmount').val().trim()),
        "TDSRemark": $('#TDSRemark').val(),
        "TxPageName": TxPageData
    }

    $.ajax({
        type: "POST",
        url: '/TDS/AddTDSDetail',
        data: TDSData,
        async: false,
        success: function (resp, status, error) {
            if (resp.trim() == "") {
                $.notify('Adding Duplicate TDS Is Not Allowed...!', "info");
            }
            else {
                $('#divTDSGrid').html(resp);
                var tdsRowCount = $('#divTDSGrid tr').length;
                var tdsSum = 0;
                if ($('#divTDSGrid tr td').length > 1) {
                    for (var i = 1; i <= tdsRowCount; i++) {
                        tdsSum += parseFloat($('#tdsGridAmount-' + i).text() == '.00' ? 0 : $('#tdsGridAmount-' + i).text());
                    }
                }
                //$('#TotalTDSAmt').val(txSum);
                //var INA = parseFloat($('#lblItemNetAmount').text());
                //var TTA = parseFloat($('#TDSPercentg').val());
                //var NT = (INA * TTA) / 100;
                //$('#TDSAmount').val(NT.toFixed(2));
                //$('#TDSAmount').prop("readonly", "readonly");
                CalculateTDSAmount();
                $('#TDSType').prop('selectedIndex', 0).change();


            }
            if (TxPageData == 'JobWorkIssue') {
                GetAmtAfterDiscount();
            }
            if (TxPageData == 'DirectPurchaseBill' || TxPageData == 'PurchaseBill' || TxPageData == 'SaleInvoice' || TxPageData == 'SaleRejection' || TxPageData == 'CreditNote' || TxPageData == 'PurchaseRejection') {
                CalculateNetAmountWithTDS();


                GetDbCrDetail();

                if (TxPageData == 'DirectPurchaseBill' || TxPageData == 'PurchaseBill') {
                    CalculateAdjAmt('NetTotal');
                    AddAdjstmntDetail1();
                }
            }
            ClearTDS();
            /*}*/
        },
        error: function (error, status, xhr) {
            if (error.status == 400) {
                $.notify(status + " : " + error.status + " : Cannot Add Expenses with Add In Taxable='Y', if Tax Exists.", { position: "top center", className: "error" });
            }
            else if (error.status == 501) {
                $.notify(status + " : " + error.status + " : " + error.responseText, { position: "top center", className: "error" });
            }
            else {
                $.notify(error, { position: "top center", className: "error" });
            }
        }
    })
}

function CalculateNetAmountWithTDS() {
    var INA = parseFloat($('#lblItemNetAmount').text());
    var tdsRowCount = $('#divTDSGrid tr').length;
    var tdsSum = 0;
    if ($('#divTDSGrid tr td').length > 1) {
        for (var i = 1; i <= tdsRowCount; i++) {
            tdsSum += parseFloat($('#tdsGridAmount-' + i).text() == '.00' ? 0 : $('#tdsGridAmount-' + i).text());

        }
    }
    let txGridSum = 0;
    $('[id^="txGridAmount"]').each(function () {
        let amount = parseFloat($(this).text()) || 0;
        txGridSum += amount;
    });
    INA = INA ?? 0;
    tdsSum = tdsSum ?? 0;
    txGridSum = txGridSum ?? 0;
    TotalSum = INA + txGridSum - tdsSum;
    $('#NetTotal').val(TotalSum.toFixed(2));
    $('#BaseNetTotal').val(TotalSum.toFixed(2));
    $('#AdjPendAmt').val(parseFloat($('#NetTotal').val() || 0).toFixed(2));
    var SN = $('title').text().indexOf('Direct Purchase Bill') === 0 ? 'DirectPurchaseBill' : ($('title').text().indexOf('Purchase Bill') === 0 && $('title').text().indexOf('Direct') !== 0 ? 'PurchaseBill' : 'PurchaseOrder');
    if (SN == 'PurchaseBill') {
        onInvoiceChange('InvNo');
    }
    else if (SN == 'SaleInvoice') {
        onInvoiceChange('SaleBillNo');
    }
    else if (SN == 'PurchaseRejection') {
        onInvoiceChange('PurchaseRejectionInvoiceNo');
    }
    else {
        onInvoiceChange('InvoiceNo');
    }
}

function ValidateTDSDetail() {
    var isError = 0;

    if ($('#TDSTaxType').prop('selectedIndex') == 0) {
        AddErrorCls('TDSTaxType');
        isError = 1;
    }

    if ($('#TDSAccountCode').prop('selectedIndex') == 0) {
        AddErrorCls('TDSAccountCode');
        isError = 1;
    }

    if ($('#TDSPercentg').val() <= 0) {
        AddErrorCls('TDSPercentg');
        isError = 1;
    }

    if ($('#TDSRoundOff').prop('selectedIndex') == 0) {
        AddErrorCls('TDSRoundOff');
        isError = 1;
    }

    if ($('#TDSAmount').val() <= 0) {
        AddErrorCls('TxAmount');
        isError = 1;
    }

    return isError;
}

async function CalculateTDSAmount() {
    var INA = parseFloat($('#lblItemNetAmount').text());
    var TTA = parseFloat($('#TDSPercentg').val());
    INA = (INA == "NAN" || isNaN(INA) || INA == "" || INA == "undefined") ? 0.00 : INA;
    TTA = (TTA == "NAN" || isNaN(TTA) || INA == "" || INA == "undefined") ? 0.00 : TTA;
    var NT = (TTA > 0 && INA > 0) ? (INA * TTA) / 100 : 0.00;

    if (NT != null && NT > 0) {
        $('#TDSAmount').val(NT.toFixed(2));
        $('#TDSAmount').prop("readonly", "readonly");
    }
    else {
        $('#TDSAmount').val(0.00);
        $('#TDSAmount').prop("readonly", "readonly");
    }
}

$('#TDSPercentg').change(function () {
    CalculateTDSAmount();
});

async function ApplyTDS2All() {
    var RowCount = $('#divTDSGrid tr').length;
    var ColumnCount = $('#divTDSGrid tr td').length;

    if (RowCount >= 1 && ColumnCount > 1) {
        $.notify("Please clear tds first", "error");
    } else {
        var TxPageName = $('title').text();
        var TxPageData;
        if (TxPageName.indexOf('Sale Order') === 0) {
            TxPageData = 'ItemList';
        }
        else if (TxPageName.indexOf('Purchase Order') == 0) {
            TxPageData = 'PurchaseOrder';
        }
        else if (TxPageName.indexOf('Issue NonRetuanable') == 0) {
            TxPageData = 'IssueNRGP';
        }
        else if (TxPageName.indexOf('Direct Purchase Bill') == 0) {
            TxPageData = 'DirectPurchaseBill';
        }
        else if (TxPageName.indexOf('Purchase Bill') == 0 && TxPageName.indexOf('Direct') != 0) {
            TxPageData = 'PurchaseBill';
        }
        else {
            TxPageData = 'JobWorkIssue';
        }
        //if ($('#TxType').val() == "TAX") {
        if (ValidateTDSDetail() == 1) return;
        var TDSData = {
            "TDSTaxType": $('#TDSTaxType').val(),
            "TDSTaxTypeName": $('#TDSTaxType option:selected').text(),
            "TDSAccountCode": $('#TDSAccountCode').val(),
            "TDSAccountName": $('#TDSAccountCode option:selected').text(),
            "TDSPercentg": parseFloat($('#TDSPercentg').val().trim()),
            "TDSRoundOff": $('#TDSRoundOff').val(),
            "TDSAmount": parseFloat($('#TDSAmount').val().trim()),
            "TDSRemark": $('#TDSRemark').val(),
            "TxPageName": TxPageData
        }

        $.ajax({
            url: '/TDS/ApplyTDS2All',
            type: "POST",
            data: TDSData,
            success: function (data, status, xhr) {
                if (data.trim() != "") {

                    $('#divTaxGrid').html(data);
                    var tdsRowCount = $('#divTDSGrid tr').length;
                    var tdsSum = 0;
                    if ($('#divTDSGrid tr td').length > 1) {
                        for (var i = 1; i <= tdsRowCount; i++) {
                            tdsSum += parseFloat($('#tdsGridAmount-' + i).text() == '.00' ? 0 : $('#tdsGridAmount-' + i).text());

                        }
                    }
                    $('#TotalTDSAmt').val(tdsSum);
                    //var INA = parseFloat($('#lblItemNetAmount').val());
                    //var TTA = parseFloat($('#TDSPercentg').val());
                    //var NT = (INA * TTA) / 100;
                    //$('#TDSAmount').val(NT.toFixed(2));
                    //$('#TDSAmount').prop("readonly", "readonly");
                    CalculateTDSAmount();
                }
                if ($('title').text().indexOf('Job Work') == 0) {
                    GetAmtAfterDiscount();
                }
                if ($('title').text().indexOf('Direct Purchase Bill') == 0 || ($('title').text().indexOf('Purchase Bill') == 0 && $('title').text().indexOf('Direct') != 0) || $('title').text().indexOf('SaleInvoice') == 0) {
                    GetDbCrDetail();
                }
            },
            error: function (error, status, xhr) {
                if (error.status == 400) {
                    $.notify(status + " : " + error.status + " : Cannot Add Duplicate TDS, if Same TDS Exists...!", { position: "top center", className: "error" });
                }
                else {
                    $.notify(error, { position: "top center", className: "error" });
                }
            }
        });
        //}
    }
}

$('.btnClearTDS').click(function (e) {
    e.preventDefault();
    var SN = $('title').text();
    //SN = SN.indexOf('Sale Order') === 0 ? 'ItemList' : 'PurchaseOrder';

    var TxPageData;
    if (SN.indexOf('Sale Order') === 0) {
        SN = 'ItemList';
    }
    else if (SN.indexOf('Purchase Order') == 0) {
        SN = 'PurchaseOrder';
    }
    else if (SN.indexOf('Direct Purchase Bill') == 0) {
        SN = 'DirectPurchaseBill';
    }
    else if (SN.indexOf('Purchase Bill') == 0 && SN.indexOf('Direct') != 0) {
        SN = 'PurchaseBill';
    }
    else if (SN.indexOf('Issue NonRetuanable') == 0) {
        SN = 'IssueNRGP';
    }
    else {
        SN = 'JobWorkIssue';
    }
    ClearTDS();
    $.ajax({
        url: '/TDS/ClearTDS',
        type: "GET",
        data: { 'SN': SN },
        datatype: "json",
        async: false,
        success: function (data, status, xhr) {

            if (data.trim() != "") {
                $('#divTDSGrid').html(data);
                //var INA = parseFloat($('#ItemNetAmount').val());
                //var TTA = parseFloat($('#TDSPercentg').val());
                //TTA = TTA = "NAN" ? 0.00 : TTA;
                //var NT = (INA * TTA) / 100;
                //$('#TDSAmount').val(NT.toFixed(2));
                //$('#TDSAmount').prop("readonly", "readonly");
                CalculateTDSAmount();

            }
            if ($('title').text().indexOf('Job Work') == 0) {

                GetAmtAfterDiscount();
            }
            if ($('title').text().indexOf('Direct Purchase Bill') == 0 || ($('title').text().indexOf('Purchase Bill') == 0 && $('title').text().indexOf('Direct') != 0) || $('title').text().indexOf('SaleInvoice') == 0) {
                GetDbCrDetail();
            }

        }
    }).done(function (data) {
        console.log(data);
    }).fail(function (data) {
        console.log(data);
    }).always(function (data) {
        console.log(data);
    });
});

async function TDSROF() {
    let Amt = $('#TDSAmount').val().trim() == "" ? 0 : parseFloat($('#TDSAmount').val().trim());
    Amt = Math.round(Amt);
    $('#TDSAmount').val(Amt.toFixed(2));
}

var _TA = 0.00;

$('#TDSRoundOff').change(function () {
    var SN = $('title').text();
    //SN = SN.indexOf('Sale Order') === 0 ? 'ItemList' : 'PurchaseOrder';

    var TxPageData;
    if (SN.indexOf('Sale Order') === 0) {
        SN = 'ItemList';
    }
    else if (SN.indexOf('Purchase Order') == 0) {
        SN = 'PurchaseOrder';
    }
    else if (SN.indexOf('Direct Purchase Bill') == 0) {
        SN = 'DirectPurchaseBill';
    }
    else if (SN.indexOf('Purchase Bill') == 0 && SN.indexOf('Direct') != 0) {
        SN = 'PurchaseBill';
    }
    else if (SN.indexOf('Issue NonRetuanable') == 0) {
        SN = 'IssueNRGP';
    }
    else {
        SN = 'JobWorkIssue';
    }
    if ($(this).val() == "Y") {
        if (/*$('#TxPartCode').prop('selectedIndex') != 0 && */$('#TDSTaxType').prop('selectedIndex') != 0 && $('#TDSAccountCode').prop('selectedIndex') != 0) {
            $.ajax({
                type: "POST",
                url: "/TDS/CalculateTDS",
                data: { "PC": "", "TP": $('#TDSPercentg').val(), 'SN': SN },
                dataType: "json",
                success: function (data, status, error) {

                    $('#TDSAmount').val(data.amt.toFixed(2));
                    let RoundOffAmt = 0;
                    RoundOffAmt = Math.abs(data.amt.toFixed(2) - Math.round(data.amt.toFixed(2)));
                    $('#TDSRoundOffAmt').val(RoundOffAmt.toFixed(2));
                    TDSROF();
                },
                error: function (req, status, error) {
                    $.notify(error, { position: "top center", className: "error" });
                }
            });
        }
        //else if ($('#TxType').val() == "EXPENSES") {
        //    ROF();
        //}
    }
    else if ($(this).val() == "N") {
        //if ($('#TxType').val() == "TAX") {
        $.ajax({
            type: "POST",
            url: "/TDS/CalculateTDS",
            data: { "PC": "", "TP": $('#TDSPercentg').val(), 'SN': SN },
            dataType: "json",
            success: function (data, status, error) {
                $('#TDSAmount').val(data.amt.toFixed(2));
                //$('#TxOnExp').val(data.taxOnExp.toFixed(2));
            },
            error: function (req, status, error) {
                $.notify(error, { position: "top center", className: "error" });
            }
        });
        //}
    }
    else {
        $('#TDSAmount').val('0.00');
    }
});

$('#TDSAmount').keydown(function () {
    $('#TDSRoundOff').prop('selectedIndex', 0);
});

$('#TotalDiscountPercentage ').keydown(function () {
    $('#TotalRoundOff').prop('selectedIndex', 0);
});

$('#TotalAmtAftrDiscount').keydown(function () {
    $('#TotalRoundOff').prop('selectedIndex', 0);
});

function TDSTDP() {
    const DP = $('#TotalDiscountPercentage') == "0" || $('#TotalDiscountPercentage').val() == "" ? 0 : parseFloat($('#TotalDiscountPercentage').val());
    var Amount = $('#NetTotal').val() == "0" || $('#NetTotal').val() == "" ? 0 : parseFloat($('#NetTotal').val());

    if (DP !== 0) {
        const DA = ((Amount * DP) / 100);
        //$('#TotalAmtAftrDiscount').val(DA);
        Amount = Amount - DA;
    }
    else {
        Amount = parseFloat($('#ItemNetAmount').val());
        var tdsRowCount = $('#divTDSGrid tr').length;

        var tdsSum = 0;
        if ($('#divTDSGrid tr td').length > 1) {
            for (var i = 1; i <= tdsRowCount; i++) {
                tdsSum += parseFloat($('#tdsGridAmount-' + i).text() == '.00' ? 0 : $('#tdsGridAmount-' + i).text());
            }
        }
        Amount += txSum;
        $('#TotalAmtAftrDiscount').val('0.00'), $('#TotalDiscountPercentage').val('0');
    }

    $('#NetTotal').val(Amount.toFixed(2));
    $('#BaseNetTotal').val(Amount.toFixed(2));
    $('#AdjPendAmt').val(parseFloat($('#NetTotal').val() || 0).toFixed(2));
}

//$('#TotalDiscountPercentage').change(function () {
//    TDSTDP();
//});

async function DeleteTDSRow(SeqNo) {
    if ($('#tdsGridName-' + SeqNo).text().includes("GST") && $('#tdsGridName-' + SeqNo).text() != "IGST") {
        if ($('#tdsGridName-' + SeqNo).text().includes("CGST")) {
            var SN = $('title').text().indexOf('Sale Order') === 0 ? 'ItemList' : ($('title').text().indexOf('Direct Purchase Bill') === 0 ? 'DirectPurchaseBill' : ($('title').text().indexOf('Purchase Bill') === 0 && $('title').text().indexOf('Direct') !== 0 ? 'PurchaseBill' : 'PurchaseOrder'));
            $.ajax({
                url: '/TDS/DeleteTDSRow',
                type: "POST",
                data: { "SeqNo": SeqNo, 'SN': SN },
                success: await function (data, status, xhr) {
                    $('#divTDSGrid').html(data);
                    var taxRowCount = $('#divTDSGrid tr').length;
                    var txSum = 0;
                    if ($('#divTDSGrid tr td').length > 1) {
                        for (var i = 1; i <= taxRowCount; i++) {
                            txSum += parseFloat($('#tdsGridAmount-' + i).text() == '.00' ? 0 : $('#tdsGridAmount-' + i).text());
                        }
                    }
                    $('#TotalTDSAmt').val(txSum);
                    var rowCountTds = $('#divTDSGrid tr').length;
                    var sumTds = 0;

                    for (var i = 1; i <= rowCountTds; i++) {

                        sumTds = parseFloat($('#tdsGridAmount-' + i).text()) + parseFloat($('#lblItemNetAmount').text());
                    }
                    //$('#NetTotall').val(sumTds.toFixed(2));

                    //var INA = parseFloat($('#ItemNetAmount').val());
                    //var TTA = parseFloat($('#TDSPercentg').val());
                    //var NT = (INA * TTA) / 100;
                    //$('#TDSAmount').val(NT.toFixed(2));
                    //$('#TDSAmount').prop("readonly", "readonly");
                    CalculateTDSAmount();

                    if ($('#divTDSGrid').children().length == 0) {
                        var NoData = '<tr class="text-center"><td colspan="14" class="text-black-50"><strong>NO DATA ADDED</strong></td></tr>';
                        $('#divTDSGrid').html(NoData);
                        //$('#NetTotal').val(INA.toFixed(2));
                    }

                    $.notify('Item Deleted From Grid.', "info");
                    if ($('title').text().indexOf('Job Work') == 0) {
                        GetAmtAfterDiscount();
                    }
                    if ($('title').text().indexOf('Direct Purchase Bill') == 0 || ($('title').text().indexOf('Purchase Bill') == 0 && $('title').text().indexOf('Direct') != 0) || $('title').text().indexOf('SaleInvoice') == 0) {
                        CalculateNetAmountWithTDS()
                        GetDbCrDetail();
                    }
                    //$('#TotalAmtAftrDiscount').val("0.00");
                    //$('#TotalDiscountPercentage').val(0);
                },
                error: function (error, status, xhr) {
                    $.notify(status + " : " + error.status + " : Cannot Delete Expenses, if TDS Exists.", { position: "top center", className: "error" });
                },
                failure: function (error, status, xhr) {
                    $.notify(error, { position: "top center", className: "error" });
                }
            });
        }
        else {
            var SN = $('title').text().indexOf('Sale Order') === 0 ? 'ItemList' : ($('title').text().indexOf('Direct Purchase Bill') === 0 ? 'DirectPurchaseBill' : ($('title').text().indexOf('Purchase Bill') === 0 && $('title').text().indexOf('Direct') !== 0 ? 'PurchaseBill' : 'PurchaseOrder'));
            $.ajax({
                url: '/TDS/DeleteTDSRow',
                type: "POST",
                data: { "SeqNo": SeqNo, 'SN': SN },
                success: await function (data, status, xhr) {
                    $('#divTDSGrid').html(data);
                    var tdsRowCount = $('#divTDSGrid tr').length;
                    var tdsSum = 0;
                    if ($('#divTDSGrid tr td').length > 1) {
                        for (var i = 1; i <= tdsRowCount; i++) {
                            tdsSum += parseFloat($('#tdsGridAmount-' + i).text() == '.00' ? 0 : $('#tdsGridAmount-' + i).text());

                        }
                    }
                    $('#TotalTDSAmt').val(tdsSum);
                    var rowCountTds = $('#divTDSGrid tr').length;
                    var sumTds = 0;

                    for (var i = 1; i <= rowCountTds; i++) {

                        sumTds = parseFloat($('#tdsGridAmount-' + i).text()) + parseFloat($('#lblItemNetAmount').text());
                    }
                    //$('#NetTotall').val(sumTax.toFixed(2));

                    //var INA = parseFloat($('#ItemNetAmount').val());
                    //var TTA = parseFloat($('#TDSPercentg').val());
                    //var NT = (INA * TTA) / 100;
                    //$('#TDSAmount').val(NT.toFixed(2));
                    //$('#TDSAmount').prop("readonly", "readonly");
                    CalculateTDSAmount();

                    if ($('#divTDSGrid').children().length == 0) {
                        var NoData = '<tr class="text-center"><td colspan="14" class="text-black-50"><strong>NO DATA ADDED</strong></td></tr>';
                        $('#divTDSGrid').html(NoData);
                        //$('#NetTotal').val(INA.toFixed(2));
                    }

                    $.notify('Item Deleted From Grid.', "info");
                    if ($('title').text().indexOf('Job Work') == 0) {
                        GetAmtAfterDiscount();
                    }
                    if ($('title').text().indexOf('Direct Purchase Bill') == 0 || ($('title').text().indexOf('Purchase Bill') == 0 && $('title').text().indexOf('Direct') != 0) || $('title').text().indexOf('SaleInvoice') == 0) {
                        GetDbCrDetail();
                    }
                    //$('#TotalAmtAftrDiscount').val("0.00");
                    //$('#TotalDiscountPercentage').val(0);
                },
                error: function (error, status, xhr) {
                    $.notify(status + " : " + error.status + " : Cannot Delete Expenses, if TDS Exists.", { position: "top center", className: "error" });
                },
                failure: function (error, status, xhr) {
                    $.notify(error, { position: "top center", className: "error" });
                }
            });
            SeqNo = SeqNo - 1;
        }
    }

    var SN = $('title').text().indexOf('Sale Order') === 0 ? 'ItemList' : ($('title').text().indexOf('Direct Purchase Bill') === 0 ? 'DirectPurchaseBill' : ($('title').text().indexOf('Purchase Bill') === 0 && $('title').text().indexOf('Direct') !== 0 ? 'PurchaseBill' : 'PurchaseOrder'));
    $.ajax({
        url: '/TDS/DeleteTDSRow',
        type: "POST",
        data: { "SeqNo": SeqNo, 'SN': SN },
        success: await function (data, status, xhr) {
            $('#divTDSGrid').html(data);
            var tdsRowCount = $('#divTDSGrid tr').length;
            var tdsSum = 0;
            if ($('#divTDSGrid tr td').length > 1) {
                for (var i = 1; i <= tdsRowCount; i++) {
                    tdsSum += parseFloat($('#tdsGridAmount-' + i).text() == '.00' ? 0 : $('#tdsGridAmount-' + i).text());

                }
            }
            $('#TotalTDSAmt').val(tdsSum);
            var rowCountTds = $('#divTDSGrid tr').length;
            var sumTds = 0;

            for (var i = 1; i <= rowCountTds; i++) {

                sumTds = parseFloat($('#tdsGridAmount-' + i).text()) + parseFloat($('#lblItemNetAmount').text());
            }
            //$('#NetTotall').val(sumTax.toFixed(2));

            //var INA = parseFloat($('#ItemNetAmount').val());
            //var TTA = parseFloat($('#TDSPercentg').val());
            //var NT = (INA * TTA) / 100;
            //$('#TDSAmount').val(NT.toFixed(2));
            //$('#TDSAmount').prop("readonly", "readonly");
            CalculateTDSAmount();

            if ($('#divTDSGrid').children().length == 0) {
                var NoData = '<tr class="text-center"><td colspan="14" class="text-black-50"><strong>NO DATA ADDED</strong></td></tr>';
                $('#divTDSGrid').html(NoData);
                //$('#NetTotal').val(INA.toFixed(2));
            }

            $.notify('Item Deleted From Grid.', "info");
            if ($('title').text().indexOf('Job Work') == 0) {
                GetAmtAfterDiscount();
            }
            if ($('title').text().indexOf('Direct Purchase Bill') == 0 || ($('title').text().indexOf('Purchase Bill') == 0 && $('title').text().indexOf('Direct') != 0) || $('title').text().indexOf('SaleInvoice') == 0) {
                GetDbCrDetail();
            }
            //$('#TotalAmtAftrDiscount').val("0.00");
            //$('#TotalDiscountPercentage').val(0);
        },
        error: function (error, status, xhr) {
            $.notify(status + " : " + error.status + " : Cannot Delete Expenses, if TDS Exists.", { position: "top center", className: "error" });
        },
        failure: function (error, status, xhr) {
            $.notify(error, { position: "top center", className: "error" });
        }
    });
    SeqNo = SeqNo - 1;
}

async function ApplyTDS4HSN() {
    var TxPageName = $('title').text();
    //if ($('#TxType').val() == 'TAX' && $('#TxPartCode').prop('selectedIndex') == 0 && $('#TxItemCode').prop('selectedIndex') == 0) {
    var TxPageData;
    if (TxPageName.indexOf('Sale Order') === 0) {
        TxPageData = 'ItemList';
    }
    else if (TxPageName.indexOf('Purchase Order') == 0) {
        TxPageData = 'PurchaseOrder';
    }
    else if (TxPageName.indexOf('Issue NonRetuanable') == 0) {
        TxPageData = 'IssueNRGP';
    }
    else if (TxPageName.indexOf('Direct Purchase Bill') == 0) {
        TxPageData = 'DirectPurchaseBill';
    }
    else if (TxPageName.indexOf('Purchase Bill') == 0 && TxPageName.indexOf('Direct') != 0) {
        TxPageData = 'PurchaseBill';
    }
    else {
        TxPageData = 'JobWorkIssue';
    }
    TxPageName = TxPageData;
    var AC = TxPageName.indexOf('SaleOrder') == -1 ? parseInt($('#AccountCode').val()) : (TxPageName.indexOf('PurchaseOrder') == 0 || TxPageName.indexOf('DirectPurchaseBill') == 0 || TxPageName.indexOf('PurchaseBill') == 0) ? parseInt($('#AccountCode').val()) : "";
    if (TxPageName.indexOf('JobWorkIssue') == 0) {
        AC = parseInt($('#AccountCode').val());
    }
    const RF = $('#TDSRoundOff').prop('selectedIndex') === 0 || $('#TDSRoundOff').prop('selectedIndex') === 1 ? 'YES' : 'NO';
    var isTDS = await GetTDSInfo();
    console.log(isTDS);
    if (isTDS == true) {
        $.notify("Please Clear TDS Detail...!", { position: "top center", className: "info" });
        return;
    }

    var objData = await GetHsnTDSInfo(AC, TxPageName, RF);

    if (objData.indexOf('DeleteTDSRow(1)') !== -1) {

        if (objData.trim()) {
            $('#divTDSGrid').html(objData);
            //$('#divTaxGrid').html(resp);
            var tdsRowCount = $('#divTDSGrid tr').length;
            var tdsSum = 0;
            if ($('#divTDSGrid tr td').length > 1) {
                for (var i = 1; i <= tdsRowCount; i++) {
                    tdsSum += parseFloat($('#tdsGridAmount-' + i).text() == '.00' ? 0 : $('#tdsGridAmount-' + i).text());

                }
            }

            //var INA = parseFloat($('#ItemNetAmount').val());
            //var TTA = parseFloat($('#TDSPercentg').val());
            //var NT = (INA * TTA) / 100;
            //$('#TDSAmount').val(NT.toFixed(2));
            //$('#TDSAmount').prop("readonly", "readonly");
            CalculateTDSAmount();
            ClearTDS();
        }
        if ($('title').text().indexOf('Job Work') == 0) {
            GetAmtAfterDiscount();
        }
        if ($('title').text().indexOf('Direct Purchase Bill') == 0 || ($('title').text().indexOf('Purchase Bill') == 0 && $('title').text().indexOf('Direct') != 0) || $('title').text().indexOf('SaleInvoice') == 0) {
            GetDbCrDetail();
        }
    }
    else if (objData.indexOf('DeleteIssueTDSRow(1)') !== -1) {
        if (objData.trim()) {
            $('#divTDSGrid').html(objData);
            //$('#divTaxGrid').html(resp);
            var tdsRowCount = $('#divTDSGrid tr').length;
            var tdsSum = 0;
            if ($('#divTDSGrid tr td').length > 1) {
                for (var i = 1; i <= tdsRowCount; i++) {
                    tdsSum += parseFloat($('#tdsGridAmount-' + i).text() == '.00' ? 0 : $('#tdsGridAmount-' + i).text());

                }
            }

            var INA = parseFloat($('#ItemNetAmount').val());
            var TTA = parseFloat($('#TDSPercentg').val());
            var NT = (INA * TTA) / 100;
            $('#TDSAmount').val(NT.toFixed(2));
            $('#TDSAmount').prop("readonly", "readonly");
            ClearTDS();
        }
        if ($('title').text().indexOf('Job Work') == 0) {
            GetAmtAfterDiscount();
        }
        if ($('title').text().indexOf('Direct Purchase Bill') == 0 || ($('title').text().indexOf('Purchase Bill') == 0 && $('title').text().indexOf('Direct') != 0) || $('title').text().indexOf('SaleInvoice') == 0) {
            GetDbCrDetail();
        }
    }
    else {
        console.log(error);
        console.log("error hereeeeee");
        $.notify(objData, { position: "top center", className: "error" });
    }
    //}
}

async function GetTDSInfo() {
    var isTDS;
    const uri = '/TDS/GetTDSInfo';

    //$.get(uri, async: false, await function (data, status) {
    //    //console.log("Data: " + data.isTax + "\nStatus: " + status);
    //    isTax = data.isTax;
    //    return isTax;
    //});

    //fetch(uri).then(function (response) {
    //    isTax = response.isTax;
    //    // return response; // <- I tried that one as well
    //});

    //var httpRequest = new XMLHttpRequest();
    //httpRequest.open('GET', "/Tax/GetTaxInfo");
    //httpRequest.send();
    //return httpRequest.responseText;

    $.ajax({
        type: "POST",
        url: uri,
        async: false,
        success: await function (response) {
            isTax = response.isTax;
        },
        error: function (err) {
            $.notify(err.responseText, { position: "top center", className: "error" });
        }
    });
    return isTax;
}

async function GetHsnTDSInfo(AC, TxPageName, RF) {
    if ($('#AccountCode').val() == 0) {
        $.notify("Please select PartyName", "error");
        return;
    }

    const uri = '/TDS/GetHsnTDSInfo';
    var objData;
    $.ajax({
        type: "POST",
        url: uri,
        //dataType: "json",
        async: false,
        data: { 'AC': AC, 'TxPageName': TxPageName, 'RF': RF },
        success: await function (data) {

            objData = data;
        },
        error: function (err) {
            console.log(err);
            $.notify(err.responseText, { position: "top center", className: "error" });
        }
    });
    return objData;
}

var currentSearchColumn = null;
$("#tdssearch-box").on("keyup", function () {
    var value = $(this).val().toLowerCase();
    $("#divTDSGrid tr").filter(function () {
        if (currentSearchColumn !== null) {
            var columnText = $(this).find('td').eq(currentSearchColumn).text().toLowerCase();
            $(this).toggle(columnText.indexOf(value) > -1);
        } else {
            $(this).toggle($(this).text().toLowerCase().indexOf(value) > -1);
        }
    });
});

$(document).on("click", "th[data-columnno]", function () {
    currentSearchColumn = $(this).data('columnno');
    $("#tdssearch-box").val('').trigger('keyup'); // Reset search box and trigger the search
});

/**** End TDS ****/

/**** Start DRCR ****/
async function GetDbCrDetail() {
    var DbCrPageName = $('title').text();
    var DbCrPageData;
    var AccountCode = 0;
    var docAccountCode = 0;
    var NetAmt = 0;
    var BillAmt = 0;
    if (DbCrPageName.indexOf('Sale Order') === 0) {
        DbCrPageData = 'ItemList';
    }
    else if (DbCrPageName.indexOf('Purchase Order') == 0) {
        DbCrPageData = 'PurchaseOrder';
    }
    else if (DbCrPageName.indexOf('Issue NonRetuanable') == 0) {
        DbCrPageData = 'IssueNRGP';
    }
    else if (DbCrPageName.indexOf('Direct Purchase Bill') == 0) {
        DbCrPageData = 'DirectPurchaseBill';
        AccountCode = $('#AccountCode').val();
        BillAmt = $('#lblItemNetAmount').text() != '' ? parseFloat($('#lblItemNetAmount').text()) : 0;
        NetAmt = $('#NetTotal').val() != '' ? parseFloat($('#NetTotal').val()) : 0;
    }
    else if (DbCrPageName.indexOf('Purchase Bill') == 0) {
        DbCrPageData = 'PurchaseBill';
        AccountCode = $('#AccountCode').val();
        BillAmt = $('#lblItemNetAmount').text() != '' ? parseFloat($('#lblItemNetAmount').text()) : 0;
        NetAmt = $('#NetTotal').val() != '' ? parseFloat($('#NetTotal').val()) : 0;
    }
    else if (DbCrPageName.indexOf('SaleInvoice') == 0) {

        DbCrPageData = 'SaleInvoice';
        AccountCode = $('#AccountCode').val();
        docAccountCode = $('#DocTypeAccountCode').val();
        BillAmt = $('#lblItemNetAmount').text() != '' ? parseFloat($('#lblItemNetAmount').text()) : 0;
        NetAmt = $('#NetTotal').val() != '' ? parseFloat($('#NetTotal').val()) : 0;
    }
    else if (DbCrPageName.indexOf('SaleBillOnCounter') == 0) {

        DbCrPageData = 'SaleBillOnCounter';
        AccountCode = $('#AccountCode').val();
        docAccountCode = $('#DocTypeAccountCode').val();
        BillAmt = $('#lblItemNetAmount').text() != '' ? parseFloat($('#lblItemNetAmount').text()) : 0;
        NetAmt = $('#NetTotal').val() != '' ? parseFloat($('#NetTotal').val()) : 0;
    }
    else if (DbCrPageName.indexOf('Credit Note') == 0) {

        DbCrPageData = 'CreditNote';
        AccountCode = $('#AccountCode').val();
        docAccountCode = $('#AccountCode').find(":selected").val();
        BillAmt = $('#lblItemGridNetAmount').text() != '' ? parseFloat($('#lblItemGridNetAmount').text()) : 0;
        NetAmt = $('#NetTotal').val() != '' ? parseFloat($('#NetTotal').val()) : 0;
    }
    else if (DbCrPageName.indexOf('Purchase Rejection') == 0) {
        var docacccode = (($('#Mode').val() == "U" || $('#Mode').val() == "V") && ($('#DocAccountCode').val() == null || $('#DocAccountCode').val() == "0" || $('#DocAccountCode').val() == "")) ? $('#hdnDocAccountCode').val() : $('#DocAccountCode').val();
        DbCrPageData = 'PurchaseRejection';
        AccountCode = $('#AccountCode').find(":selected").val();
        docAccountCode = docacccode;
        BillAmt = $('#lblItemGridNetAmount').text() != '' ? parseFloat($('#lblItemGridNetAmount').text()) : 0;
        NetAmt = $('#NetTotal').val() != '' ? parseFloat($('#NetTotal').val()) : 0;
    }
    else if (DbCrPageName.indexOf('Sale Rejection') == 0) {
        DbCrPageData = 'SaleRejection';
        AccountCode = $('#AccountCode').val();
        if ($('#Mode').val() == "U" || $('#Mode').val() == "V") {
            docAccountCode = $('#hiddenDocType').val();
        } else {
            docAccountCode = $('#DocTypeAccountCode').val();
        }
        BillAmt = $('#lblItemNetAmount').text() != '' ? parseFloat($('#lblItemNetAmount').text()) : 0;
        NetAmt = $('#NetTotal').val() != '' ? parseFloat($('#NetTotal').val()) : 0;
    }
    else {
        DbCrPageData = '';
    }
    DbCrPageName = DbCrPageData;
    if (DbCrPageData != null && DbCrPageData != undefined && DbCrPageData != '') {
        $.ajax({
            url: '/Common/GetDbCrDataGrid',
            type: "POST",
            data: { "PageName": DbCrPageName, "docAccountCode": docAccountCode, "AccountCode": AccountCode, "BillAmt": BillAmt, "NetAmt": NetAmt },
            async: false,
            success: function (result, status, xhr) {
                //console.log(result);
                //console.log(data);
                $('#divdbCrItemList').empty();

                // Check if there is any data
                var data = JSON.parse(result);
                if (data.length === 0) {
                    // If no data, show "No Data Added" message
                    var NoData = '<tr class="text-center"><td colspan="5" class="text-black-50"><strong>NO DATA ADDED</strong></td></tr>';
                    $('#divdbCrItemList').html(NoData);
                } else {
                    // Otherwise, populate table with data
                    var rows = '';
                    var totalDr = 0;
                    var totalCr = 0;
                    $.each(data.Result, function (index, item) {
                        //var debitAmount = (item.DrAmt != null && item.DrAmt !== '' && item.DrAmt !== undefined) ? Math.round(item.DrAmt, 2) : '0';
                        //var creditAmount = (item.CrAmt != null && item.CrAmt !== '' && item.CrAmt !== undefined) ? Math.round(item.CrAmt, 2) : '0';
                        var debitAmount = item.DrAmt;
                        var creditAmount = item.CrAmt;

                        rows += '<tr id="drcrRow-' + (index + 1) + '">';
                        //rows += '<td>' + item.AccountCode + '</td>';
                        rows += '<td>' + item.AccountName + '</td>';
                        rows += '<td class="dramt">' + parseFloat(debitAmount).toFixed(2) + '</td>';
                        rows += '<td class="cramt">' + parseFloat(creditAmount).toFixed(2) + '</td>';
                        rows += '</tr>';
                        totalDr += debitAmount;
                        totalCr += creditAmount;
                    });
                    // Append rows to tbody
                    $('#divdbCrItemList').html(rows);
                    //$('#TotalDr').text(Math.round(totalDr, 2));
                    //$('#TotalCr').text(Math.round(totalCr, 2));
                    $('#TotalDr').text(totalDr.toFixed(2));
                    $('#TotalCr').text(totalCr.toFixed(2));
                }
            },
            error: function (response, status, xhr) {
                console.log("DbCrItem_" + response.responseText, "error");
            },
            failure: function (response, status, xhr) {
                console.log("DbCrItem_" + response.responseText, "error");
            }
        });
    }
}

async function RefreshDbCrDetail() {
    await GetDbCrDetail();
    $.notify("Debit/Credit Detail Grid Loaded Successfully", { position: "top center", className: "success" });
}
/**** End DRCR ****/

/**** Start Adjstment ****/
function AddAdjstmntDetail1() {

    var AdjPendAmt = $('#AdjPendAmt').val();
    AdjPendAmt = (AdjPendAmt != null && AdjPendAmt != '' && AdjPendAmt != undefined) ? parseFloat(AdjPendAmt) : 0;
    var result = CheckAndValidateAdjAmt('NetTotal', AdjPendAmt);
    var modeofadjst = $('#AdjModeOfAdjstment option:selected').text();
    var AdjPurchOrderNo = $('#AdjPurchOrderNo option:selected').val();
    var AdjPOYear = $('#AdjPOYear').val().trim() != null &&
        $('#AdjPOYear').val().trim() != undefined &&
        $('#AdjPOYear').val().trim() != ''
        ? parseInt($('#AdjPOYear').val().trim())
        : 0;
    var isErr = 0;
    if ($('#AdjDescription').val() == "") {
        isErr = 1;
        $.notify('Adjust description is manadatory...!', "error");
    }
    else if ($('#AdjModeOfAdjstment').val() == "") {
        isErr = 1;
        $.notify('Adjust description is manadatory...!', "error");
    }
    else if ($('#AdjDueDate').val() == '') {
        isErr = 1;
        $.notify('Adjust Due Date is manadatory...!', "error");
    }
    else if ($('#AdjNewRefNo').val() == '') {
        isErr = 1;
        $.notify('Adjust new RefNo is manadatory...!', "error");
    }
    else if ($('#AdjDrCr').val() == '') {
        isErr = 1;
        $.notify('Adjust DRCR is manadatory...!', "error");
    }
    else if ((AdjPurchOrderNo == null ||
        AdjPurchOrderNo == undefined ||
        AdjPurchOrderNo == '' ||
        AdjPurchOrderNo == '-Select-' ||
        AdjPurchOrderNo == '0') && modeofadjst != null && modeofadjst == "Advance") {
        isErr = 1;
        $.notify('Adjust Purchase Order No is manadatory...!', "error");
    }
    else if (AdjPOYear == 0 && modeofadjst != null && modeofadjst == "Advance") {
        isErr = 1;
        $.notify('Adjust PO Year is manadatory...!', "error");
    }
    else if (AdjPendAmt == 0) {
        if ($('#AllowToAdjZeroAmt').val() == 'Y') {
            //isErr = 0;
        }
        else {
            isErr = 1;
            $.notify('Adjust Pend Amount must be greater than 0...!', "error");
        }
    }
    //result.toString().toLowerCase() == "false" &&
    if (result.toString().toLowerCase() == "false" && modeofadjst != null && modeofadjst != "AgainstRef" && isErr != 1) {
        AddAdjstmntDetail();
    }
}
function AddAdjstmntDetail() {

    var AdjPageName = $('title').text();
    var modeofadjst = $('#AdjModeOfAdjstment option:selected').text();
    var AdjPageData;

    if (AdjPageName.indexOf('Sale Order') === 0) {
        AdjPageData = 'ItemList';
    }
    else if (AdjPageName.indexOf('Purchase Order') == 0) {
        AdjPageData = 'PurchaseOrder';
    }
    else if (AdjPageName.indexOf('Issue NonRetuanable') == 0) {
        AdjPageData = 'IssueNRGP';
    }
    else if (AdjPageName.indexOf('Direct Purchase Bill') == 0) {
        AdjPageData = 'DirectPurchaseBill';
    }
    else if (AdjPageName.indexOf('Purchase Bill') == 0) {
        AdjPageData = 'PurchaseBill';
    }
    else if (AdjPageName.indexOf('SaleInvoice') == 0) {
        AdjPageData = 'SaleInvoice';
    }
    else if (AdjPageName.indexOf('SaleBillOnCounter') == 0) {
        AdjPageData = 'SaleBillOnCounter';
    }
    else if (AdjPageName.indexOf('Sale Rejection') == 0) {
        AdjPageData = 'SaleRejection';
    }
    else if (AdjPageName.indexOf('Credit Note') == 0) {
        AdjPageData = 'CreditNote';
    }
    else if (AdjPageName.indexOf('Purchase Rejection') == 0) {
        AdjPageData = 'PurchaseRejection';
    }
    else {
        AdjPageData = 'JobWorkIssue';
    }
    let dueDateString = $('#AdjDueDate').val(); // Example: "05/12/2024"
    let regex = /(\d{2})\/(\d{2})\/(\d{4})/; // Matches DD/MM/YYYY
    let match = regex.exec(dueDateString);
    let dueDate = new Date();
    if (match) {
        let day = parseInt(match[1], 10);
        let month = parseInt(match[2], 10) - 1;
        let year = parseInt(match[3], 10);
        dueDate = new Date(year, month, day);
    }

    var AdjustmentData = {
        "AdjModeOfAdjstment": $('#AdjModeOfAdjstment option:selected').val(),
        "AdjModeOfAdjstmentName": $('#AdjModeOfAdjstment option:selected').text(),
        "AdjDescription": $('#AdjDescription').val(),
        "AdjDueDate": $('#AdjDueDate').val(),
        "DueDate": $('#AdjDueDate').val(),
        "AdjNewRefNo": $('#AdjNewRefNo').val(),
        "AdjPendAmt": parseFloat($('#AdjPendAmt').val() || 0).toFixed(2),
        "AdjDrCr": $('#AdjDrCr option:selected').val(),
        "AdjDrCrName": $('#AdjDrCr option:selected').text(),
        "AdjAgnstAccEntryID": 0,
        "AdjAgnstAccYearCode": 0,
        "AdjPageName": AdjPageData
    }

    if (modeofadjst === "AgainstRef") {
        AdjustmentData.AdjOpenEntryID = $('#AdjOpenEntryID').val().trim() != null &&
            $('#AdjOpenEntryID').val().trim() != undefined &&
            $('#AdjOpenEntryID').val().trim() != ''
            ? parseFloat($('#AdjOpenEntryID').val().trim())
            : 0;

        AdjustmentData.AdjOpeningYearCode = $('#AdjOpeningYearCode').val().trim() != null &&
            $('#AdjOpeningYearCode').val().trim() != undefined &&
            $('#AdjOpeningYearCode').val().trim() != ''
            ? parseFloat($('#AdjOpeningYearCode').val().trim())
            : 0;
    }
    else if (modeofadjst === "Advance") {
        AdjustmentData.AdjPurchOrderNo = $('#AdjPurchOrderNo option:selected').val();
        AdjustmentData.AdjPOYear = $('#AdjPOYear').val().trim() != null &&
            $('#AdjPOYear').val().trim() != undefined &&
            $('#AdjPOYear').val().trim() != ''
            ? parseInt($('#AdjPOYear').val().trim())
            : 0;

        AdjustmentData.AdjPODate = $('#AdjPODate').val();
    }
    console.log(AdjustmentData);
    $.ajax({
        type: "POST",
        url: '/Common/AddAdjstmntDetail',
        data: AdjustmentData,
        async: false,
        success: function (resp, status, error) {

            if (resp.trim() == "") {
                $.notify('Adding Duplicate Adjustment Is Not Allowed...!', "info");
            }
            else {
                $('#divAdjItemList').html(resp);
                var adjRowCount = $('#divAdjItemList tr').length;
                var adjSum = 0;

                CalculateAdjAmt('NetTotal');
                //$('#TDSType').prop('selectedIndex', 0).change();
            }
            //if (TxPageData == 'JobWorkIssue') {
            //    GetAmtAfterDiscount();
            //}
            //if (TxPageData == 'DirectPurchaseBill') {
            //    CalculateNetAmountWithTDS();
            //    GetDbCrDetail();
            //}
            //ClearTDS();
            /*}*/
        },
        error: function (error, status, xhr) {
            if (error.status == 501) {
                $.notify(status + " : " + error.status + " : " + error.responseText, { position: "top center", className: "error" });
            }
            else {
                $.notify(error, { position: "top center", className: "error" });
            }
        }
    });
}

function onInvoiceChange(invid) {
    $('#AdjDescription').val($('#' + invid).val());
    $('#AdjNewRefNo').val($('#' + invid).val());
    $('#AdjAgnstVouchNo').val($('#' + invid).val());
    $('#AdjAgnstNewRefNo').val($('#' + invid).val());
}

$('#AdjModeOfAdjstment').change(function () {
    var SN = $('title').text().indexOf('Direct Purchase Bill') === 0 ? 'DirectPurchaseBill' :
        ($('title').text().indexOf('Purchase Bill') === 0 && $('title').text().indexOf('Direct') !== 0 ? 'PurchaseBill' :
            ($('title').text().indexOf('Credit Note') === 0 ? 'CreditNote' : 'PurchaseOrder'));

    if (SN == 'PurchaseBill') {
        onInvoiceChange('InvNo');
    }
    else if (SN == 'SaleInvoice') {
        onInvoiceChange('SaleBillNo');
    }
    else if (SN == 'CreditNote') {
        onInvoiceChange('CreditNoteInvoiceNo');
    }
    else if (SN == 'PurchaseRejection') {
        onInvoiceChange('PurchaseRejectionInvoiceNo');
    }
    else {
        onInvoiceChange('InvoiceNo');
    }
    CalculateAdjAmt('NetTotal');
    var val = this.value;
    if (val == "AgainstRef") {
        //AdjHideshow('Adjar', 'show');
        AdjHideshow('Adjarbtn', 'show');
        AdjHideshow('Adjadv', 'hide');
        $('#DisplayAdjDetailModal').modal('show');
        DisplayAdjustmentRefDetail();
        $('.btnAddAdjustment2Grid').attr('disabled', true);
    }
    else if (val == "Advance") {
        AdjHideshow('Adjadv', 'show');
        AdjHideshow('Adjar', 'hide');
        AdjHideshow('Adjarbtn', 'hide');
        $('.btnAddAdjustment2Grid').attr('disabled', false);
    }
    else {
        AdjHideshow('Adjar', 'hide');
        AdjHideshow('Adjadv', 'hide');
        AdjHideshow('Adjarbtn', 'hide');
        $('.btnAddAdjustment2Grid').attr('disabled', false);
    }
});

function CalculateAdjAmt(netamtid) {
    // get net amount
    var netamt = (netamtid != undefined && netamtid != '' &&
        $('#' + netamtid).val() != '' &&
        $('#' + netamtid).val() != undefined &&
        $('#' + netamtid).val() != 0)
        ? parseFloat($('#' + netamtid).val())
        : 0;

    var rowCount = $('#divAdjItemList tr').length;
    var textContent = $('#divAdjItemList tr').text().trim();

    var sum = 0;
    if (rowCount > 0 && !textContent.includes('NO DATA ADDED')) {
        for (var i = 1; i <= rowCount; i++) {
            var val = $('#GridAdjPendAmount-' + i).text();
            val = (val == '.00' ? 0 : val);
            sum += parseFloat(val || 0);
        }
    }

    var resultpendamt = netamt - sum;
    resultpendamt = resultpendamt < 0 ? 0 : resultpendamt;

    // ✅ only apply .toFixed(2) at the end when displaying
    $('#AdjPendAmt').val(resultpendamt.toFixed(2));
    $('#AdjRemainingAmt').val(resultpendamt.toFixed(2));
    $('#AdjTotalAmt').val(netamt.toFixed(2));
    $('#AdjAdjstedAmt').val(sum.toFixed(2));

    // Update the footer values
    $('#AdjTotalAmt1').text(netamt.toFixed(2));
    $('#AdjAdjstedAmt1').text(sum.toFixed(2));
    $('#AdjRemainingAmt1').text(resultpendamt.toFixed(2));
}

function CheckAndValidateAdjAmt(netamtid, pendAmt) {
    var netamt = (netamtid != undefined && netamtid != '' && $('#' + netamtid).val() != '' && $('#' + netamtid).val() != undefined && $('#' + netamtid).val() != 0) ? parseFloat($('#' + netamtid).val()) : 0;
    var rowCount = $('#divAdjItemList tr').length;
    var textContent = $('#divAdjItemList tr').text().trim();
    var sum = 0;

    if (rowCount > 0 && !textContent.includes('NO DATA ADDED')) {
        for (var i = 1; i <= rowCount; i++) {

            sum += parseFloat($('#GridAdjPendAmount-' + i).text() == '.00' ? 0 : $('#GridAdjPendAmount-' + i).text());
        }
    }
    var amtforadd = pendAmt + sum;
    if (amtforadd > netamt) {
        $.notify("Please add Adjust amount properly, And total should be less then or equal to Net Total.", { position: "top center", className: "error" });
        return true;
    }
    if (amtforadd < netamt || amtforadd.toString() == netamt.toString()) {
        return false;
    }
    return true;
}

function CheckAndValidateAdjAmtAtTimeofAdd(netamtid, pendAmt) {
    var netamt = (netamtid != undefined && netamtid != '' && $('#' + netamtid).val() != '' && $('#' + netamtid).val() != undefined && $('#' + netamtid).val() != 0) ? parseFloat($('#' + netamtid).val()) : 0;
    var rowCount = $('#divAdjItemList tr').length;
    var textContent = $('#divAdjItemList tr').text().trim();
    var sum = 0;
    if (rowCount > 0 && !textContent.includes('NO DATA ADDED')) {
        for (var i = 1; i <= rowCount; i++) {

            sum += parseFloat($('#GridAdjPendAmount-' + i).text() == '.00' ? 0 : $('#GridAdjPendAmount-' + i).text());
        }
    }
    var amtforadd = pendAmt + sum;
    amtforadd = parseFloat(amtforadd.toFixed(2));
    if (amtforadd > netamt || amtforadd < netamt) {
        $.notify("Please add Adjust amount properly, And total should be less then or equal to Net Total.", { position: "top center", className: "error" });
        return true;
    }
    if (amtforadd = netamt) {
        return false;
    }
    return true;
}

async function DeleteAdjRow(SeqNo) {
    var SN = $('title').text().indexOf('Sale Order') === 0 ? 'ItemList' : ($('title').text().indexOf('Direct Purchase Bill') === 0 ? 'DirectPurchaseBill' : ($('title').text().indexOf('SaleInvoice')) === 0 ? 'SaleInvoice' : ($('title').text().indexOf('Purchase Bill') === 0 ? 'PurchaseBill' : 'PurchaseOrder'));
    SN = $('title').text().indexOf('Purchase Rejection') === 0 ? 'PurchaseRejection' : SN;
    SN = $('title').text().indexOf('Sale Rejection') === 0 ? 'SaleRejection' : SN;
    $.ajax({
        url: '/Common/DeleteAdjRow',
        type: "POST",
        data: { "SeqNo": SeqNo, 'SN': SN },
        success: await function (data, status, xhr) {
            $('#divAdjItemList').html(data);
            CalculateAdjAmt('NetTotal');

            if ($('#divAdjItemList').children().length == 0) {
                var NoData = '<tr class="text-center"><td colspan="14" class="text-black-50"><strong>NO DATA ADDED</strong></td></tr>';
                $('#divAdjItemList').html(NoData);
            }

            $.notify('Item Deleted From Grid.', "info");
        },
        error: function (error, status, xhr) {
            $.notify(status + " : " + error.status + " : Cannot Delete Adj.", { position: "top center", className: "error" });
        },
        failure: function (error, status, xhr) {
            $.notify(error, { position: "top center", className: "error" });
        }
    });
}

async function EditAdjRow(SeqNo) {
    var SN = $('title').text().indexOf('Sale Order') === 0 ? 'ItemList' : ($('title').text().indexOf('Direct Purchase Bill') === 0 ? 'DirectPurchaseBill' : ($('title').text().indexOf('Purchase Bill') === 0 ? 'PurchaseBill' : 'PurchaseOrder'));
    SN = $('title').text().indexOf('Purchase Rejection') === 0 ? 'PurchaseRejection' : SN;
    SN = $('title').text().indexOf('Sale Rejection') === 0 ? 'SaleRejection' : SN;
    $.ajax({
        url: '/Common/EditAdjRow',
        type: "POST",
        data: { "SeqNo": SeqNo, 'SN': SN },
        success: await function (data, status, xhr) {
            //$('#divAdjItemList').html(data);
            if (data === "Duplicate" && (xhr.statusCode === 207 || xhr.responseText === "Duplicate")) {
                $.notify("Adjustment Detail Cannot Be Edited...!", "warning");
            }
            else {
                var isEditAllowed = "true";
                var obj = $.parseJSON(data);
                DeleteAdjRow(SeqNo);
                CalculateAdjAmt('NetTotal');
                if (isEditAllowed == "false") {
                    return false;
                }
                else {
                    if (obj != null && obj.length == 1) {

                        $('#AdjModeOfAdjstment').val(obj[0].AdjModeOfAdjstment).change();
                        $('#AdjDescription').val(obj[0].AdjDescription);
                        if (obj[0].AdjDueDate) {
                            let date = new Date(obj[0].AdjDueDate);
                            let formattedDate =
                                ("0" + date.getDate()).slice(-2) + "/" +
                                ("0" + (date.getMonth() + 1)).slice(-2) + "/" +
                                date.getFullYear();
                            $('#AdjDueDate').val(formattedDate);
                        } else {
                            $('#AdjDueDate').val(''); // handle null case
                        }
                        $('#AdjNewRefNo').val(obj[0].AdjNewRefNo);
                        $('#AdjPendAmt').val(obj[0].AdjPendAmt);
                        $('#AdjDrCr').val(obj[0].AdjDrCr).trigger('change');
                    }
                }
            }
        },
        error: function (error, status, xhr) {
            $.notify(status + " : " + error.status + " : Cannot Delete Adj.", { position: "top center", className: "error" });
        },
        failure: function (error, status, xhr) {
            $.notify(error, { position: "top center", className: "error" });
        }
    });
}

function ClearAdj() {

    $('#AdjModeOfAdjstment').prop('selectedIndex', 0).removeClass('is-invalid'), $('#AdjDescription').val(''), $('#AdjNewRefNo').val(''),
        $('#AdjDrCr').prop('selectedIndex', 0).removeClass('is-invalid'),
        $('#AdjPendAmt').val(0.00).removeAttr('readonly').removeClass('is-invalid'), $('#AdjOpenEntryID').val('').removeClass('is-invalid'), $('#AdjOpeningYearCode').val('').removeClass('is-invalid'), $('#AdjPurchOrderNo').val('').removeClass('is-invalid'), $('#AdjPOYear').val('0'), $('#AdjPODate').val('0');
}
$('.btnClearAdj').click(function () {

    //ClearAdj();
    ClearAdjustmentGrid();
});

function ClearAdjustmentGrid() {
    $.ajax({
        type: "POST",
        url: "/Tax/ClearAdjGrid",
        dataType: "json",
        async: false,
        success: function (result, status, error) {

            $('#divAdjItemList').empty();
            var NoData = '<tr class="text-center"><td colspan="32" class="text-black-50"><strong>NO DATA ADDED</strong></td></tr>';
            $('#divAdjItemList').html(NoData);
            //BasicTotal();
            CalculateAdjAmt('NetTotal');
            // Total Calculation
        },
        error: function (req, status, error) {
            alert(error);
        }
    });
}

function AdjHideshow(cntrlcls, cmdHideShow) {
    if (cmdHideShow.toLowerCase() == "hide") {
        $('.' + cntrlcls).each(function () {
            $(this).hide();
        });
    }
    else if (cmdHideShow.toLowerCase() == "show") {
        $('.' + cntrlcls).each(function () {
            $(this).show();
        });
    }
    else {

    }
}

function DisplayAdjustmentRefDetail() {

    var DbCrPageName = $('title').text();
    var DbCrPageData;
    var AccountCode = 0;
    var TransVouchType = "";
    if (DbCrPageName.indexOf('Sale Order') === 0) {
        DbCrPageData = 'ItemList';
    }
    else if (DbCrPageName.indexOf('Purchase Order') == 0) {
        DbCrPageData = 'PurchaseOrder';
    }
    else if (DbCrPageName.indexOf('Issue NonRetuanable') == 0) {
        DbCrPageData = 'IssueNRGP';
    }
    else if (DbCrPageName.indexOf('Direct Purchase Bill') == 0) {
        DbCrPageData = 'DirectPurchaseBill';
        AccountCode = $('#AccountCode').find(":selected").val();
        TransVouchType = "PURCHASE-DIRECT";
    }
    else if (DbCrPageName.indexOf('Purchase Bill') == 0) {
        DbCrPageData = 'PurchaseBill';
        AccountCode = $('#AccountCode').find(":selected").val();
        TransVouchType = "PURCHASE-DIRECT";
    }
    else if (DbCrPageName.indexOf('SaleInvoice') == 0) {
        DbCrPageData = 'SaleInvoice';
        AccountCode = $('#AccountCode').val();
        TransVouchType = "SaleInvoice";
    }
    else if (DbCrPageName.indexOf('Against Adjust Voucher') == 0) {
        DbCrPageData = 'Against Adjust Voucher';
        AccountCode = $('#LedgerName').find(":selected").val();
        TransVouchType = $("#VoucherType").val();
    }
    else if (DbCrPageName.indexOf('Credit Note') == 0) {
        DbCrPageData = 'CreditNote';
        AccountCode = $('#AccountCode').find(":selected").val();
        TransVouchType = "CREDIT-NOTE";
    }
    else {
        DbCrPageData = '';
    }
    DbCrPageName = DbCrPageData;

    var yearCode = 0;
    var DRCR = "";
    var VouchDate = "";
    if (DbCrPageName.indexOf('SaleInvoice') == 0) {
        yearCode = $('#SaleBillYearCode').val();
        DRCR = "DR";
        VouchDate = $('#SaleBillDate').val();
    }
    else if (DbCrPageName.indexOf('Against Adjust Voucher') == 0) {
        yearCode = $('#YearCode').val();
        DRCR = "DR";
        VouchDate = $('#EntryDate').val();
    }
    else if (DbCrPageName.indexOf('CreditNote') == 0) {
        yearCode = $('#CreditNoteYearCode').val();
        DRCR = "CR";
        VouchDate = $('#CreditNoteInvoiceDate').val();
    }
    else {
        yearCode = $('#YearCode').val();
        DRCR = $('#AdjDrCr').val();
        VouchDate = $('#VouchDate').val();
    }
    if (DbCrPageData != null && DbCrPageData != undefined && DbCrPageData != '') {

        $('#DisplayAdjDetailModal').modal('show');
        $.ajax({
            type: "POST",
            url: "/Common/GetPendVouchBillAgainstRefPopupByID",
            dataType: "json",
            data: {
                "AC": AccountCode, "YC": yearCode, "PayRecEntryId": 0, "PayRecYearcode": 0, "DRCR": DRCR, "TransVouchType": TransVouchType, "TransVouchDate": VouchDate
            },
            success: function (result, status, error) {
                if (result != null) {
                    var obj = $.parseJSON(result);
                    var html = '';
                    $('#divDisplayAdjustmntDetail').empty();
                    var i = 1;
                    if (obj.AdjAdjustmentDetailGrid != null) {
                        $.each(obj.AdjAdjustmentDetailGrid, function (index, val) {
                            html += '<tr id="DisplayAdjustmntRow-' + index + '">' +
                                /*'<input type="hidden" value="' + val.AdjAgnstAccEntryID + '" id="AdjAgnstAccEntryID_' + index + '" />' +*/
                                '<td>' + i + '</td>' +
                                '<td><input id="AgnstRefCheckbox_' + index + '"  type="checkbox" onclick="onAgnstcheckcliclunclick(' + index + ')"></td>' +
                                '<td><span class="edit-icon" id="AdjAgnstRefEdit_' + index + '" onclick="AdjAgnstRefEdit(this)" data-index="' + index + '">&#9998;</span><span class="save-button" id="AdjAgnstRefSave_' + index + '" onclick="AdjAgnstRefOnGridSave(this)" data-index="' + index + '" style="display:none;background: none; border: none;">&#10004;</span></td>' +
                                '<td><input id="AdjAgnstVouchNo_' + index + '" value=' + val.AdjAgnstVouchNo + ' readonly style="width:190px;background: none;border: none;white-space: break-spaces;text-overflow: ellipsis;"></td>' +
                                '<td><input id="AdjAgnstVouchDate_' + index + '" value=' + formatDateToDDMMYYYY(val.AdjAgnstVouchDate) + ' readonly style="width:120px;background: none;border: none;"></td>' +
                                '<td><input id="AdjAgnstModeOfAdjstment_' + index + '" value="' + val.AdjAgnstModeOfAdjstment + '" readonly style="width:120px;background: none;border: none;white-space: break-spaces;text-overflow: ellipsis;"></td>' +
                                '<td><input id="AdjAgnstVouchType_' + index + '" value=' + val.AdjAgnstVouchType + ' readonly style="width:125px;background: none;border: none;white-space: break-spaces;text-overflow: ellipsis;"></td>' +
                                '<td><input id="AdjAgnstPendAmt_' + index + '" value="' + val.AdjAgnstPendAmt + '" ' +
                                'data-original="' + val.AdjAgnstPendAmt + '" readonly style="width:50px;background: none;border: none;"></td>' +
                                '<td><input  id="AdjAgnstRemainingAmt_' + index + '" value=' + val.AdjAgnstRemainingAmt + ' readonly style="width:50px;background: none;border: none;"></td>' +
                                '<td><input class="adjstedamt" id="AdjAgnstAdjstedAmt_' + index + '" value=' + val.AdjAgnstAdjstedAmt + ' style="width:50px;background: none;border: none;" onchange="ChangeAdjustAmt(' + index + ')"></td>' +
                                '<td><input id="AdjAgnstDrCr_' + index + '" value=' + val.AdjAgnstDrCr + ' readonly style="width:40px;background: none;border: none;"></td>' +
                                '<td><input id="AdjAgnstAccEntryIDVal_' + index + '" value=' + val.AdjAgnstAccEntryID + ' readonly style="width:50px;background: none;border: none;"></td>' +
                                '<td><input id="AdjAgnstAccYearCode_' + index + '" value=' + val.AdjAgnstAccYearCode + ' readonly style="width:50px;background: none;border: none;"></td>' +
                                '<td><input id="AdjAgnstOpenEntryID_' + index + '" value=' + val.AdjAgnstOpenEntryID + ' readonly style="width:50px;background: none;border: none;"></td>' +
                                '<td><input id="AdjAgnstOpeningYearCode_' + index + '" value=' + val.AdjAgnstOpeningYearCode + ' readonly style="width:50px;background: none;border: none;"></td>' +
                                '</tr>';
                            i++;
                        });
                    }
                    else {
                        html += '<tr class="text-center"><td colspan="12" class="text-black-50"><strong>NO DATA FOUND</strong></td></tr>'
                    }
                    $('#divDisplayAdjustmntDetail').append(html);
                    $('#AdjustmentHeaderError').hide();
                    var totals = CalculateTotals();
                    $('#TotalBillAmount').val(parseFloat($('#NetTotal').val()));
                    $('#TotalRemainingAmount').val(totals)
                    $('#PendingToAdjustAmount').val(parseFloat($('#AdjRemainingAmt1').text()))
                    var RowCount = $('#divDisplayAdjustmntDetail tr').length;
                    var TdRow = $('#divDisplayAdjustmntDetail tr td').length;

                    if (TdRow > 1) {
                        $('#AdjlblTotalNoOfItems').text(RowCount);
                    }
                }
            }
        });
    }
}
function CalculateTotals() {
    var remainingTotal = 0;

    // Remaining Amount
    $('#divDisplayAdjustmntDetail input[id^="AdjAgnstRemainingAmt_"]').each(function () {
        var val = $(this).val().trim();
        if (val) {
            var num = parseFloat(val.replace(/,/g, ''));
            if (!isNaN(num)) {
                remainingTotal += num;
            }
        }
    });

    return remainingTotal;
}
function ChangeAdjustAmount() {
    var rowCount = $('#divDisplayAdjustmntDetail tr').length - 1; // exclude header
    var totalAdjustStr = $('#TotalAdjustAmount').val();

    // Validation
    if (!totalAdjustStr || totalAdjustStr.includes('-')) return;
    var totalAdjust = parseFloat(totalAdjustStr);
    if (isNaN(totalAdjust) || totalAdjust <= 0) return;

    // Step 1: Store original balances once
    for (let i = 0; i <= rowCount; i++) {
        const $bal = $('#AdjAgnstPendAmt_' + i); // original balance column
        if ($bal.data('original') === undefined) {
            const original = parseFloat($bal.text()) || 0;
            $bal.data('original', original);
        }
    }

    // Step 2: Reset all rows to original
    for (let i = 0; i <= rowCount; i++) {
        const $bal = $('#AdjAgnstPendAmt_' + i);
        const $adjAmt = $('#AdjAgnstAdjstedAmt_' + i);
        const $remAmt = $('#AdjAgnstRemainingAmt_' + i);
        const $chk = $('#AgnstRefCheckbox_' + i);

        const original = parseFloat($bal.data('original')) || 0;

        $adjAmt.val("0.00");
        $remAmt.val(original.toFixed(2));   // reset remaining input
        $chk.prop('checked', false);
        $('#DisplayAdjustmntRow-' + i).css("background-color", "");
    }

    // Step 3: Distribute adjustments row by row
    let remainingQty = totalAdjust;

    for (let i = 0; i <= rowCount; i++) {
        if (remainingQty <= 0) break;

        const $bal = $('#AdjAgnstPendAmt_' + i);
        const $adjAmt = $('#AdjAgnstAdjstedAmt_' + i);
        const $remAmt = $('#AdjAgnstRemainingAmt_' + i);
        const $chk = $('#AgnstRefCheckbox_' + i);

        const original = parseFloat($bal.data('original')) || 0;
        if (original <= 0) continue;

        let adjustHere = (remainingQty >= original) ? original : remainingQty;
        remainingQty -= adjustHere;

        // Update row
        $adjAmt.val(adjustHere.toFixed(2));
        $remAmt.val((original - adjustHere).toFixed(2)); // Remaining after adjustment
        $chk.prop('checked', adjustHere > 0);

        if (adjustHere > 0) {
            $('#DisplayAdjustmntRow-' + i).css("background-color", "rgb(161 184 161)");
        }

        CheckUnCheckCheck(i);
    }

    // Step 4: Reset bg for unchecked rows
    for (let i = 0; i <= rowCount; i++) {
        if (!$('#AgnstRefCheckbox_' + i).is(':checked')) {
            $('#DisplayAdjustmntRow-' + i).css("background-color", "");
        }
    }
}
function ChangeAdjustAmt(i) {
    let adjustAmtInput = $('#AdjAgnstAdjstedAmt_' + i);
    let remainingAmtInput = $('#AdjAgnstRemainingAmt_' + i);
    let errorHeader = $('#AdjustmentHeaderError');

    // 🔑 Original total pending amount (base)
    let pendingToAdjust = parseFloat($('#AdjRemainingAmt1').text());

    let remainingBalance = parseFloat(remainingAmtInput.val()) || 0;
    let adjustAmt = parseFloat(adjustAmtInput.val()) || 0;

    // 🧩 NEW VALIDATION: if PendingToAdjustAmount is 0, adjustment not allowed
    let currentPending = parseFloat($('#PendingToAdjustAmount').val()) || 0;
    if (currentPending <= 0 && adjustAmt > 0) {
        adjustAmtInput.val(0);
        errorHeader.show();
        $('#AgnstRefCheckbox_' + i).prop('checked', false);
        $('#DisplayAdjustmntRow-' + i).css("background-color", "");
        return;
    }

    // Validation: adjustAmt cannot exceed remainingBalance
    if (adjustAmt > remainingBalance) {
        adjustAmtInput.val(0);
        remainingAmtInput.val(remainingBalance.toFixed(2));
        errorHeader.show();
        $('#AgnstRefCheckbox_' + i).prop('checked', false);
        $('#DisplayAdjustmntRow-' + i).css("background-color", "");
        return;
    } else {
        errorHeader.hide();
    }

    // Update remaining amount after adjustment
    let newRemaining = remainingBalance - adjustAmt;
    remainingAmtInput.val(newRemaining.toFixed(2));

    // Update row checkbox & background color
    if (adjustAmt > 0) {
        $('#AgnstRefCheckbox_' + i).prop('checked', true);
        $('#DisplayAdjustmntRow-' + i).css("background-color", "rgb(161 184 161)");
    } else {
        $('#AgnstRefCheckbox_' + i).prop('checked', false);
        $('#DisplayAdjustmntRow-' + i).css("background-color", "");
    }

    // 🔑 Recalculate total adjusted amount from ALL rows
    let totalAdjusted = 0;
    $('input[id^="AdjAgnstAdjstedAmt_"]').each(function () {
        totalAdjusted += parseFloat($(this).val()) || 0;
    });

    // Update PendingToAdjustAmount = Original - Sum(All Adjustments)
    $('#PendingToAdjustAmount').val((pendingToAdjust - totalAdjusted).toFixed(2));
    $('#TotalAdjustAmount').val(totalAdjusted.toFixed(2));

    CheckUnCheckCheck(i);
}
function CheckUnCheckCheck(i) {
    var RowCount = $('#divDisplayAdjustmntDetail tr').length;
    var isChecked = $('#AgnstRefCheckbox_' + i).is(':checked');

    if (isChecked) {
        if (parseFloat($('#AdjAgnstAdjstedAmt_' + i).val()) == 0) {
            $('#AdjAgnstAdjstedAmt_' + i).val($('#AdjAgnstPendAmt_' + i).text());
            $('#AdjAgnstPendAmt_' + i).text(0);
        }
        $('#DisplayAdjustmntRow-' + i).css("background-color", "rgb(161 184 161)");
    } else {
        var adjustedValue = $('#AdjAgnstAdjstedAmt_' + i).val();
        if (adjustedValue && adjustedValue !== "0") {
            $('#AdjAgnstPendAmt_' + i).text(adjustedValue);
            $('#AdjAgnstAdjstedAmt_' + i).val(0);
        }
        $('#DisplayAdjustmntRow-' + i).css("background-color", "");
    }
}
function Agnstrefonsave() {
    var AdjPageName = $('title').text();
    var PaymentDays = ($('#PaymentDays').val()) ? parseInt($('#PaymentDays').val()) : 0;
    var AdjPageData = '';

    if (AdjPageName.indexOf('Sale Order') === 0) AdjPageData = 'ItemList';
    else if (AdjPageName.indexOf('Purchase Order') === 0) AdjPageData = 'PurchaseOrder';
    else if (AdjPageName.indexOf('Issue NonRetuanable') === 0) AdjPageData = 'IssueNRGP';
    else if (AdjPageName.indexOf('SaleInvoice') === 0) AdjPageData = 'SaleInvoice';
    else if (AdjPageName.indexOf('Direct Purchase Bill') === 0) AdjPageData = 'DirectPurchaseBill';
    else if (AdjPageName.indexOf('Purchase Bill') === 0) AdjPageData = 'PurchaseBill';
    else if (AdjPageName.indexOf('Against Adjust Voucher') === 0) AdjPageData = $("#VoucherType").val();
    else AdjPageData = 'JobWorkIssue';

    var selectedItems1 = [];

    $('tr[id^="DisplayAdjustmntRow-"]').each(function () {
        var rowIndex = $(this).attr('id').split('-')[1];
        if ($('#AgnstRefCheckbox_' + rowIndex).is(':checked')) {
            var rawDate = $('#AdjAgnstVouchDate_' + rowIndex).val();
            var formattedDate = null;

            if (rawDate) {
                // Assume rawDate is in 'DD/MM/YYYY' format
                var parts = rawDate.split('/');
                if (parts.length === 3) {
                    // Create a valid date: months are 0-based in JS
                    var day = parseInt(parts[0], 10);
                    var month = parseInt(parts[1], 10) - 1;
                    var year = parseInt(parts[2], 10);

                    var dateObj = new Date(year, month, day);
                    if (!isNaN(dateObj.getTime())) {
                        formattedDate = dateObj.toISOString();
                    }
                }
            }

            console.log(formattedDate);
            if (AdjPageName = 'Against Adjust Voucher') {
                selectedItems1.push({
                    AdjAgnstAccEntryID: parseInt($('#AdjAgnstAccEntryIDVal_' + rowIndex).val()),
                    AdjAgnstAccYearCode: parseInt($('#AdjAgnstAccYearCode_' + rowIndex).val()),
                    AdjAgnstOpenEntryID: parseInt($('#AdjAgnstOpenEntryID_' + rowIndex).val()),
                    AdjAgnstOpeningYearCode: parseInt($('#AdjAgnstOpeningYearCode_' + rowIndex).val()),
                    AdjAgnstVouchNo: $('#AdjAgnstVouchNo_' + rowIndex).val(),
                    AdjAgnstVouchDate: formattedDate,
                    AdjDescription: $('#VoucherNo').val(),
                    AdjNewRefNo: $('#VoucherNo').val(),
                    AdjAgnstModeOfAdjstment: "AgainstRef",
                    AdjAgnstVouchType: $('#AdjAgnstVouchType_' + rowIndex).val(),
                    AdjAgnstPendAmt: parseFloat($('#AdjAgnstPendAmt_' + rowIndex).val()) || 0,
                    AdjAgnstRemainingAmt: parseFloat($('#AdjAgnstRemainingAmt_' + rowIndex).val()) || 0,
                    AdjAgnstAdjstedAmt: parseFloat($('#AdjAgnstAdjstedAmt_' + rowIndex).val()) || 0,
                    AdjAgnstDrCr: $('#AdjAgnstDrCr_' + rowIndex).val(),
                    AdjPageName: AdjPageData
                });
            } else {
                selectedItems1.push({
                    AdjAgnstAccEntryID: parseInt($('#AdjAgnstAccEntryIDVal_' + rowIndex).val()),
                    AdjAgnstAccYearCode: parseInt($('#AdjAgnstAccYearCode_' + rowIndex).val()),
                    AdjAgnstOpenEntryID: parseInt($('#AdjAgnstOpenEntryID_' + rowIndex).val()),
                    AdjAgnstOpeningYearCode: parseInt($('#AdjAgnstOpeningYearCode_' + rowIndex).val()),
                    AdjAgnstVouchNo: $('#AdjAgnstVouchNo_' + rowIndex).val(),
                    AdjAgnstVouchDate: formattedDate,
                    AdjDescription: $('#AdjDescription').val(),
                    AdjNewRefNo: $('#AdjNewRefNo').val(),
                    AdjAgnstModeOfAdjstment: "AgainstRef",
                    AdjAgnstVouchType: $('#AdjAgnstVouchType_' + rowIndex).val(),
                    AdjAgnstPendAmt: parseFloat($('#AdjAgnstPendAmt_' + rowIndex).val()) || 0,
                    AdjAgnstRemainingAmt: parseFloat($('#AdjAgnstRemainingAmt_' + rowIndex).val()) || 0,
                    AdjAgnstAdjstedAmt: parseFloat($('#AdjAgnstAdjstedAmt_' + rowIndex).val()) || 0,
                    AdjAgnstDrCr: $('#AdjAgnstDrCr_' + rowIndex).val(),
                    AdjPageName: AdjPageData
                });
            }
            // Push a full AdjustmentModel object into the list

        }
    });

    // Parent AdjustmentModel
    var model = {
        AdjPageName: AdjPageData,
        AdjAgnstModeOfAdjstment: "AgainstRef",
        AdjAdjustmentDetailGrid: selectedItems1
    };

    console.log("Payload:", JSON.stringify(model, null, 2));

    $.ajax({
        type: "POST",
        url: '/Common/AddAgnstRefToAdjstmntDetail',
        data: JSON.stringify(model),
        contentType: 'application/json; charset=utf-8',
        dataType: 'json',
        success: function (resp) {
            console.log('Saved successfully', resp);
            $('#DisplayAdjDetailModal').modal('hide');
            $('#AdjModeOfAdjstment').val("NewRef").trigger('change');
            $.ajax({
                type: "GET",
                url: '/Common/GetUpdatedAdjGridData', // Adjust the URL to match your endpoint
                success: function (updatedData) {
                    // Update the relevant section of the partial view with new data
                    updateAdjGridTable(updatedData);
                    CalculateAdjAmt('NetTotal');
                },
                error: function (error) {
                    console.log('Failed to load updated data', error);
                }
            });
        },
        error: function (error) {
            console.log('Save failed', error);
        }
    });
}
function AdjAgnstRefOnGridSave(element) {
    // Get the index from the data attribute
    var index = element.id.split('_')[1];

    if (!ValidateAdjAgnstRefPopupOnSave(index)) {
        $('#DisplayAdjustmntRow-' + index + ' input').each(function () {
            $(this).prop('readonly', true).css('background', 'none').css('border', 'none').removeClass('is-invalid').removeClass('valid');
        });

        // Hide the save button and show the edit button again
        $('#AdjAgnstRefSave_' + index).hide();
        $('#AdjAgnstRefEdit_' + index).show();

        // Collect and optionally save data
        var updatedItem = {
            AdjAgnstAccEntryID: $('#AdjAgnstAccEntryIDVal_' + index).val(),
            AdjAgnstAccYearCode: $('#AdjAgnstAccYearCode_' + index).val(),
            AdjAgnstOpenEntryID: $('#AdjAgnstOpenEntryID_' + index).val(),
            AdjAgnstOpeningYearCode: $('#AdjAgnstOpeningYearCode_' + index).val(),
            AdjAgnstVouchNo: $('#AdjAgnstVouchNo_' + index).val(),
            AdjAgnstVouchDate: $('#AdjAgnstVouchDate_' + index).val(),
            AdjAgnstModeOfAdjstment: $('#AdjAgnstModeOfAdjstment_' + index).val(),
            AdjAgnstVouchType: $('#AdjAgnstVouchType_' + index).val(),
            AdjAgnstPendAmt: $('#AdjAgnstPendAmt_' + index).val(),
            AdjAgnstRemainingAmt: $('#AdjAgnstRemainingAmt_' + index).val(),
            AdjAgnstAdjstedAmt: $('#AdjAgnstAdjstedAmt_' + index).val(),
            AdjAgnstDrCr: $('#AdjAgnstDrCr_' + index).val()
        };
        //console.log(updatedItem);
    }
}

function AdjAgnstRefEdit(element) {
    // Get the index from the data attribute
    var index = element.id.split('_')[1];

    // Make all inputs in the row editable
    $('#DisplayAdjustmntRow-' + index + ' input').each(function () {
        var id = $(this).attr('id');
        if (id.includes('AdjAgnstAdjstedAmt_')) {
            $(this).prop('readonly', false).css('background', '#fff').css('border', '1px solid #ddd');
        }
    });

    // Show the save button and hide the edit button
    $('#AdjAgnstRefEdit_' + index).hide();
    $('#DisplayAdjustmntRow-' + index + ' .save-button').show();
}

function formatDateToDDMMYYYY(dateStr) {
    const date = new Date(dateStr);

    // Ensure date is valid
    if (isNaN(date)) {
        return ''; // Handle invalid date here
    }

    // Extract day, month, and year
    const day = String(date.getDate()).padStart(2, '0');   // Get day and pad with leading zero if needed
    const month = String(date.getMonth() + 1).padStart(2, '0'); // Months are zero-based, so +1
    const year = date.getFullYear();

    // Format as dd/MM/yyyy
    return `${day}/${month}/${year}`;
}

function formatDate(dateString) {
    if (dateString) {
        var date = new Date(dateString);
        if (!isNaN(date.getTime())) {
            // Convert to ISO string format
            return date.toISOString(); // "yyyy-MM-ddTHH:mm:ss.sssZ"
        }
    }
    return null; // Return null if the date is invalid or empty
}
function addDaysToDate(dateStr, daysToAdd) {
    var date = new Date(dateStr);
    date.setDate(date.getDate() + daysToAdd);
    return formatDateToISOWithoutUTC(date); // Return the date in ISO format
}
function formatDateToISOWithoutUTC(date) {
    // Get the components of the date
    var year = date.getFullYear();
    var month = (date.getMonth() + 1).toString().padStart(2, '0'); // Months are 0-indexed
    var day = date.getDate().toString().padStart(2, '0');
    var hours = date.getHours().toString().padStart(2, '0');
    var minutes = date.getMinutes().toString().padStart(2, '0');
    var seconds = date.getSeconds().toString().padStart(2, '0');

    // Combine them into the desired format
    var isoString = `${year}-${month}-${day}T${hours}:${minutes}:${seconds}.000`;

    return isoString; // Return the formatted string without "Z" as it's not UTC
}

function updateAdjGridTable(data) {
    var tableBody = $('#divAdjItemList'); // Adjust this selector based on your actual table ID or class
    tableBody.empty(); // Clear the existing table rows

    // Iterate over the data and append rows to the table
    data.forEach(function (item) {

        var row = `<tr class="small ${item.adjSeqNo}" style="white-space:nowrap">
            <td style="white-space:nowrap;">
                ${$("#Mode").val() === "V" && $("#ID").val() > 0 ?
                `<a class="table-link link-primary noCursor" disabled>
                        <span class="fa-stack">
                            <i class="fa fa-square fa-stack-2x"></i>
                            <i class="fa fa-pencil fa-stack-1x fa-inverse"></i>
                        </span>
                    </a>
                    <a class="table-link link-danger noCursor" disabled>
                        <span class="fa-stack">
                            <i class="fa fa-square fa-stack-2x"></i>
                            <i class="fa-solid fa-trash fa-stack-1x fa-inverse"></i>
                        </span>
                    </a>` :
                `<a class="table-link link-primary" onclick="EditAdjRow(${item.adjSeqNo});">
                        <span class="fa-stack">
                            <i class="fa fa-square fa-stack-2x"></i>
                            <i class="fa fa-pencil fa-stack-1x fa-inverse"></i>
                        </span>
                    </a>
                    <a class="table-link link-danger" onclick="DeleteAdjRow(${item.adjSeqNo});">
                        <span class="fa-stack">
                            <i class="fa fa-square fa-stack-2x"></i>
                            <i class="fa-solid fa-trash fa-stack-1x fa-inverse"></i>
                        </span>
                    </a>`
            }
            </td>
            <td>${item.adjSeqNo}</td>
            <td>${item.adjModeOfAdjstment}</td>
            <td>${item.adjDescription}</td>
            <td>${item.adjDueDate ? formatDateToDDMMYYYY(item.adjDueDate) : "N/A"}</td>
            <td>${item.adjNewRefNo}</td>
            <td id="GridAdjPendAmount-${item.adjSeqNo}">${item.adjPendAmt ? item.adjPendAmt.toFixed(2) : "0.00"}</td>
            <td>${item.adjDrCr && item.adjDrCr !== "" && !item.adjDrCr.includes("Select") ? item.adjDrCr : ""}</td>
            <td>${item.adjPurchOrderNo || ""}</td>
            <td>${item.adjPOYear || 0}</td>
            <td>${item.adjPODate ? new Date(item.adjPODate).toLocaleDateString() : ""}</td>
            <td>${item.adjAgnstVouchNo || ""}</td>
            <td>${item.adjAgnstVouchType || ""}</td>
            <td>${item.adjOpenEntryID || 0}</td>
            <td>${item.adjOpeningYearCode || 0}</td>
            <td>${item.adjAgnstAccEntryID || 0}</td>
            <td>${item.adjAgnstAccYearCode || 0}</td>
        </tr>`;
        tableBody.append(row);
    });
}

function ValidateAdjAgnstRefPopupOnSave(index) {
    var iserror = false;
    var billamt = $('#AdjAgnstPendAmt_' + index).val();
    billamt = (billamt != null && billamt != undefined && billamt != 0) ? parseFloat(billamt) : 0;
    var adjamt = $('#AdjAgnstAdjstedAmt_' + index).val();
    adjamt = (adjamt != null && adjamt != undefined && adjamt != 0) ? parseFloat(adjamt) : 0;
    if (parseFloat(adjamt.toFixed(2)) > parseFloat(billamt.toFixed(2))) {
        iserror = true;
        $.notify("ADJUST AMT CAN NOT BE GREATER THEN REMAINING AMT", { position: "top center", width: "20px", className: "error" });
        //alert('ADJUST AMT CAN NOT BE GREATER THEN REMAINING AMT');
    }
    return iserror;
}
function onAgnstcheckcliclunclick(index) {
    var PendingToAdjustAmount = parseFloat($('#PendingToAdjustAmount').val()) || 0;
    var alreadyRemaining = parseFloat($('#AdjAgnstRemainingAmt_' + index).val()) || 0;
    var totalAdjusted = parseFloat($('#TotalAdjustAmount').val()) || 0; // get current total

    if ($('#AgnstRefCheckbox_' + index).is(':checked')) {
        // jitlu adjust kari shakiye (pending vs remaining)
        var amtToAdjust = (PendingToAdjustAmount >= alreadyRemaining) ? alreadyRemaining : PendingToAdjustAmount;

        $('#AdjAgnstAdjstedAmt_' + index).val(amtToAdjust);
        $('#AdjAgnstRemainingAmt_' + index).val(alreadyRemaining - amtToAdjust);
        $('#PendingToAdjustAmount').val(PendingToAdjustAmount - amtToAdjust);

        totalAdjusted += amtToAdjust; // increase total adjusted
        $('#DisplayAdjustmntRow-' + index).css("background-color", "rgb(161 184 161)");
    } else {
        var adjusted = parseFloat($('#AdjAgnstAdjstedAmt_' + index).val()) || 0;

        $('#AdjAgnstAdjstedAmt_' + index).val(0);
        $('#AdjAgnstRemainingAmt_' + index).val(alreadyRemaining + adjusted);
        $('#PendingToAdjustAmount').val(PendingToAdjustAmount + adjusted);

        totalAdjusted -= adjusted; // decrease total adjusted
        $('#DisplayAdjustmntRow-' + index).css("background-color", "");
    }

    // update total adjusted amount
    $('#TotalAdjustAmount').val(totalAdjusted);
}
function toggleAll(masterCheckbox) {
    var PendingToAdjustAmount = parseFloat($('#PendingToAdjustAmount').val()) || 0;
    var totalRows = $('#divDisplayAdjustmntDetail tr').length;
    var totalAdjusted = 0; // new variable to track total adjustment

    for (var i = 0; i < totalRows; i++) {
        var rowCheckbox = $('#AgnstRefCheckbox_' + i);
        var alreadyRemaining = parseFloat($('#AdjAgnstRemainingAmt_' + i).val()) || 0;

        if (masterCheckbox.checked && PendingToAdjustAmount > 0 && alreadyRemaining > 0) {
            // adjust as much as possible without exceeding pending or remaining
            var amtToAdjust = (PendingToAdjustAmount >= alreadyRemaining) ? alreadyRemaining : PendingToAdjustAmount;

            $('#AdjAgnstAdjstedAmt_' + i).val(amtToAdjust);
            $('#AdjAgnstRemainingAmt_' + i).val(alreadyRemaining - amtToAdjust);
            $('#DisplayAdjustmntRow-' + i).css("background-color", "rgb(161 184 161)");

            rowCheckbox.prop('checked', true);
            PendingToAdjustAmount -= amtToAdjust;  // reduce pending
            totalAdjusted += amtToAdjust; // accumulate total adjustment
        } else {
            // uncheck rows or reset if master unchecked
            var adjusted = parseFloat($('#AdjAgnstAdjstedAmt_' + i).val()) || 0;

            $('#AdjAgnstAdjstedAmt_' + i).val(0);
            $('#AdjAgnstRemainingAmt_' + i).val(alreadyRemaining + adjusted);
            $('#DisplayAdjustmntRow-' + i).css("background-color", "");

            rowCheckbox.prop('checked', false);
            PendingToAdjustAmount += adjusted;
            totalAdjusted -= adjusted; // decrease total adjustment
        }
    }

    $('#PendingToAdjustAmount').val(PendingToAdjustAmount);
    $('#TotalAdjustAmount').val(totalAdjusted); // fill total adjusted amount
}
function Openagnstrefpopup() {
    $('#DisplayAdjDetailModal').modal('show');
    DisplayAdjustmentRefDetail();
}
function onNetTotalChange() {
    CalculateAdjAmt('NetTotal');
}
/**** End ADJ ****/

function ValidateNull(Value) {
    try {
        // Check if the field exists and if it's null, undefined, or empty
        if (!Value || Value === null || Value === undefined) {
            return false;
        }
        return true;
    } catch (error) {
        console.error(`Error validating field ${Value}:`, error);
        return false;
    }
}

function formatUniversalDate(date) {
    var d = new Date(date),
        month = '' + (d.getMonth() + 1),
        day = '' + d.getDate(),
        year = d.getFullYear();

    if (month.length < 2)
        month = '0' + month;
    if (day.length < 2)
        day = '0' + day;

    return [day, month, year].join('/');
}

function parseISTDate(dateStr) {
    if (!dateStr) return null; // Return null for empty or invalid input
    const [day, month, year] = dateStr.split("/").map(Number);
    return new Date(year, month - 1, day); // Month is 0-indexed in JavaScript
}

async function DeleteTaxRowByItemCode(itemCode) {

    const title = $('title').text();
    const SN = title.indexOf('Sale Order') === 0 ? 'ItemList' :
        title.indexOf('Direct Purchase Bill') === 0 ? 'DirectPurchaseBill' :
            title.indexOf('Purchase Bill') === 0 && title.indexOf('Direct') !== 0 ? 'PurchaseBill' :
                title.indexOf('Purchase Rejection') === 0 ? 'PurchaseRejection' :
                    title.indexOf('Sale Rejection') === 0 ? 'SaleRejection' :
                        title.indexOf('SaleInvoice') === 0 ? 'SaleInvoice' :
                            title.indexOf('Purchase Order') === 0 ? 'PurchaseOrder' :
                                title.indexOf('Credit Note') === 0 ? 'CreditNote' :
                                    title.indexOf('Sale Rejection') === 0 ? 'SaleRejection' : 'Unknown';

    try {
        const response = await $.ajax({
            url: '/Tax/DeleteTaxRowByItemCode',
            type: 'POST',
            data: { ItemCode: itemCode, SN: SN }
        });

        $('#divTaxGrid').html(response);
        ClearDRCRGrid();
        ClearAdjustmentGrid();

        let taxRowCount = $('#divTaxGrid tr').length;
        let txSum = 0;
        for (let i = 1; i <= taxRowCount; i++) {
            const val = parseFloat($('#txGridAmount-' + i).text() || 0);
            txSum += isNaN(val) ? 0 : val;
        }

        $('#TotalTaxAmt').val(txSum.toFixed(2));

        const INA = parseFloat($('#ItemNetAmount').val()) || 0;
        const TTA = parseFloat($('#TotalTaxAmt').val()) || 0;
        $('#NetTotal').val((INA + TTA).toFixed(2));
        $('#BaseNetTotal').val((INA + TTA).toFixed(2));

        if ($('#divTaxGrid').children().length === 0) {
            $('#divTaxGrid').html('<tr class="text-center"><td colspan="14" class="text-black-50"><strong>NO DATA ADDED</strong></td></tr>');
        }

        $.notify('Item Deleted From Grid.', "info");

        if (title.indexOf('Job Work') === 0) {
            GetAmtAfterDiscount();
        }

        if (['Direct Purchase Bill', 'Purchase Rejection', 'Sale Rejection', 'Purchase Bill', 'SaleInvoice', 'Credit Note'].some(str => title.includes(str))) {
            GetDbCrDetail();
        }

        $('#TotalAmtAftrDiscount').val("0.00");
        $('#TotalDiscountPercentage').val(0);

    } catch (error) {
        $.notify("Error: " + error.status + " - " + error.statusText, { position: "top center", className: "error" });
    }
}

// ======================================================
// ✅ DrilldownManager — Full Enhanced Version
// (Supports state restore + back navigation + filters)
// ======================================================
const DrilldownManager = (() => {

    const STACK_KEY = "DRILL_STACK";
    const FILTER_KEY = "DRILL_FILTER_";

    // --- 🔹 Stack Management ---
    function getStack() {
        return JSON.parse(sessionStorage.getItem(STACK_KEY) || "[]");
    }

    function setStack(list) {
        sessionStorage.setItem(STACK_KEY, JSON.stringify(list || []));
    }

    function push(nav) {
        const s = getStack();
        s.push(nav);
        setStack(s);
    }

    function pop() {
        debugger
        const s = getStack();
        const last = s.pop();
        setStack(s);
        return last;
    }

    function peek() {
        const s = getStack();
        return s.length ? s[s.length - 1] : null;
    }

    function getPrevious() {
        const s = getStack();
        return s.length >= 2 ? s[s.length - 2] : null;
    }

    // --- 🔹 Filter Save/Load ---
    function saveFormFilters(formName, filters) {
        debugger
        if (!formName) return;
        sessionStorage.setItem(FILTER_KEY + formName, JSON.stringify(filters || {}));
    }

    function loadFormFilters(formName) {
        debugger
        if (!formName) return null;
        const raw = sessionStorage.getItem(FILTER_KEY + formName);
        try {
            return raw ? JSON.parse(raw) : null;
        } catch (e) {
            console.error("DrilldownManager.loadFormFilters parse error:", e);
            return null;
        }
    }

    // --- 🔹 Restore Filters to UI ---
    function restoreFormFilters(formName) {
        debugger;
        const filters = loadFormFilters(formName);
        if (!filters) return;

        for (const [id, value] of Object.entries(filters)) {
            const $el = $("#" + id);
            if (!$el.length) continue;

            if ($el.attr("type") === "checkbox") {
                $el.prop("checked", !!value);
            } else if ($el.hasClass("hasDatepicker")) {
                $el.datepicker("setDate", value);
            } else {
                $el.val(value);
            }

            // Trigger UI refresh for select2 or normal fields
            if ($el.data("select2") || $el.hasClass("custom-select2")) {
                $el.trigger("change.select2");
            } else {
                $el.trigger("change");
            }
        }
    }

    // --- 🔹 Back Navigation ---
    function goBack(rootUrl = "/") {
        const stack = getStack();

        // 🧭 No navigation history? Go to root
        if (!stack || !stack.length) {
            window.location.href = rootUrl;
            return;
        }

        // 🧱 Remove the current page entry first
        const current = stack.pop();

        // ✅ If the popped item was root, clear everything and go home
        if (current && current.isRoot) {
            setStack([]); // clear all navigation history
            window.location.href = rootUrl;
            return;
        }

        // 🧩 Update stack after popping current page
        setStack(stack);

        // 🔹 Get the previous page data
        const prev = stack.length ? stack[stack.length - 1] : null;

        // 🚪 No previous entry left — go to root
        if (!prev) {
            window.location.href = rootUrl;
            return;
        }

        const prevForm = prev.currentForm || null;
        const prevUrl = prev.url || rootUrl;

        // 🔍 Compare only the path (ignore query strings, anchors)
        const currentPath = location.pathname;
        const prevPath = new URL(prevUrl, window.location.origin).pathname;

        // ✅ If same page, just restore filters
        if (currentPath === prevPath) {
            if (prevForm) {
                DrilldownManager.restoreFormFilters(prevForm);
            }

            // Small delay for UI consistency (ensure DOM ready)
            setTimeout(() => {
                if (prevForm && $('#ReportType').length) {
                    $('#ReportType').val(prevForm).trigger('change');
                }
                DrilldownManager.toggleBackButton();
            }, 100);
        } else {
            // ✅ Different page — navigate to previous URL
            window.location.href = prevUrl;
        }
    }

    // --- 🔹 Back Button Visibility ---
    function toggleBackButton(selector = "#BackButton") {
        const stack = getStack();
        if (stack.length > 1) {
            $(selector).show();
        } else {
            $(selector).hide();
        }
    }

    // --- 🔹 Public API ---
    return {
        getStack,
        setStack,
        push,
        pop,
        peek,
        getPrevious,
        saveFormFilters,
        loadFormFilters,
        restoreFormFilters,
        goBack,
        toggleBackButton,

        // Aliases for compatibility
        pushNavigation: push,
        popNavigation: pop,
        saveFilters: saveFormFilters,
        restoreFilters: loadFormFilters,
        getLastNextForm: () => {
            const s = getStack();
            return s.length ? s[s.length - 1].nextForm || null : null;
        },
        restoreIfAvailable: (formName) => loadFormFilters(formName) || null
    };
})();

// ======================================================
// ✅ Common Back Button Handler (Global)
// ======================================================
window.goBack = function () {
    DrilldownManager.goBack();
};