@model eTactWeb.DOM.Models.ImportToTallyReportModel
@{
    ViewData["Title"] = "Import To Tally Register";
    Layout = "~/Views/Shared/_LayoutMain.cshtml";
}
<style>

    .select2-container--default .select2-selection--single {
        background-color: #e0f2f1;
        border: 1.5px solid #0a0a0a !important;
        border-radius: 4px;
    }

        .select2-container--default .select2-selection--single .select2-selection__rendered {
            /* border-bottom: 1.5px solid #000 !important; */
            border-bottom: none !important;
        }

    .select2-container--default .select2-results > .select2-results__options {
        background-color: #e0f2f1; /* Dropdown background color */
        color: #000;
</style>

<div class="card bg-gradient mb-3 border-light shadow-lg">

    <div class="card-header card-headerBG text-light bg-gradient">
        <h5>
            <strong>Import To Tally Register</strong>
            <span class="d-flex float-end" style="margin-top:-2px;">
            </span>
        </h5>
    </div>
    <div>
    </div>
    <div class="card-body bg-light pt-0">
        <div class="accordion shadow-lg">
            <div class="card-body">
                <div class="card overflow-auto">
                    <div class="card-body">
                        <form id="SParam">
                            <div class="row">
                                <div class="col-xxl-2 col-xl-3 col-lg-3 col-md-6 col-sm-12 col-xs-12">
                                    <div class="row">
                                        <div class="col">
                                            <label class="form-label">From Date</label>
                                            <input asp-for="FromDate" class="form-control" />
                                        </div>
                                        <div class="col">
                                            <label class="form-label">To Date</label>
                                            <input asp-for="ToDate" class="form-control" />
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="col-xxl-2 col-xl-3 col-lg-3 col-md-6 col-sm-6 col-xs-12">
                                    <label asp-for="ReportType" class="form-label">Report Type</label>
                                    <select asp-for="ReportType" id="ReportType" class="form-select">
                                        <option disabled value="">-Select-</option>
                                    </select>
                                </div>

                                <div class="col-xl-2 col-lg-6 col-md-6 col-sm-6 col-xs-12">
                                    <label  class="form-label" >Bill No</label>

                                    <input type="text" id="BillNo" class="form-control" />
                                   
                                </div>

                                <div class="col-xl-2 col-lg-6 col-md-6 col-sm-6 col-xs-12">
                                    <label asp-for="AccountCode" class="form-label" >Customer Name</label>
                                    
                                        <input type="text"  id="AccountCodeText" class="form-control"  placeholder="Type Customer Name..." />
                                        <input type="hidden" asp-for="AccountCode"  id="AccountCode" />
                                   
                                </div>
                              
                               
                                <div class=" d-flex justify-content-center mt-3 col-sm-5 col-md-8 col-lg-6 col-xl-4" width="inherit">
                                  
                                    <button class="btn btn-sm btn-outline-success" style="padding:3px;height:30px;width:100px;margin-left:20px;" type="button" id="ImportExcel">
                                        <i class="fa-solid fa-upload fa-fw fa-lg "></i>EXCEL
                                    </button>
                                   
                                </div>
                            </div>
                            <div class="progress my-2 mb-3" style="height: 4px;">
                                <div class="progress-bar progress-bar-striped bg-secondary progress-bar-animated" role="progressbar" style="width: 100%" aria-valuenow="100" aria-valuemin="0" aria-valuemax="100"></div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

</div>
<style>
    .color-box {
        width: 10px;
        height: 10px;
    }
</style>


@section Scripts {
    <script>
        $(document).ready(function () {

            var ReportType = $('#ReportType').val();
            FillReportType("AccSPExportToTallyFormat", ReportType);
            AutoFillPARTYNAMELIST();
            var currentDate = new Date();
            var firstDayOfMonth = new Date(currentDate.getFullYear(), currentDate.getMonth(), 1);

            $('#FromDate').datepicker({ dateFormat: 'dd/mm/yy' }).datepicker("setDate", formatDate1(firstDayOfMonth));
            $('#ToDate').datepicker({ dateFormat: 'dd/mm/yy' }).datepicker("setDate", 'now');

            $('#ImportExcel').on('click', function () {

                var fromDate = $('#FromDate').val();
                var toDate = $('#ToDate').val();
                var reportType = $('#ReportType').val();
                var AccountCode = $('#AccountCode').val();
                var BillNo = $('#BillNo').val();

                // Basic validation
                if (!fromDate || !toDate) {
                    alert('Please select From Date and To Date');
                    return;
                }

                if (!reportType) {
                    alert('Please select Report Type');
                    return;
                }

                // Build query string
                var url = '/ImportToTallyReport/GetReportData'
                    + '?Flag=' + encodeURIComponent(reportType)
                    + '&FromDate=' + encodeURIComponent(fromDate)
                    + '&Todate=' + encodeURIComponent(toDate)
                    + '&BillNo=' + encodeURIComponent(BillNo)
                    + '&AccountCode=' + encodeURIComponent(AccountCode);

                // 🔥 Trigger Excel download
                window.location.href = url;
            });

        });


        function formatDate1(date) {
            var day = ("0" + date.getDate()).slice(-2);
            var month = ("0" + (date.getMonth() + 1)).slice(-2);
            var year = date.getFullYear();
            var dateString = day + "/" + month + "/" + year;
            return dateString;
        }


        function AutoFillPARTYNAMELIST() {
            // Source for PartCodeText
            const AccountCodeSourse = function (request, response) {
                $.ajax({
                    url: '@Url.Action("AutoFillPARTYNAMELIST", "SaleOrder")',
                    type: 'POST',
                    data: {

                        SearchAccount: request.term
                    },
                    success: function (result) {
                        let obj = typeof result === "string" ? JSON.parse(result) : result;

                        if (obj.StatusCode === 200 && obj.StatusText === 'Success' && Array.isArray(obj.Result.Table)) {
                            let filtered = obj.Result.Table.filter(function (item) {
                                let term = request.term.toLowerCase();
                                return item.Account_Name.toLowerCase().includes(term);
                            });

                            response($.map(filtered, function (item) {
                                return {
                                    label: item.Account_Name,
                                    value: item.Account_Name,
                                    accountCode: item.Account_Code,

                                };
                            }));
                        } else {
                            response([]);
                        }
                    }
                });
            };



            // Autocomplete for PartCodeText
            $("#AccountCodeText").autocomplete({
                source: AccountCodeSourse,
                select: function (event, ui) {
                    $("#AccountCodeText").val(ui.item.value).data("Account_Code", ui.item.accountCode);

                    $('#AccountCode').val(ui.item.accountCode);

                   

                   
                    return false;
                },
                focus: function (event, ui) {
                    $("#AccountCodeText").val(ui.item.value);

                    return false;
                },
                minLength: 2
            });


        }

    </script>
}