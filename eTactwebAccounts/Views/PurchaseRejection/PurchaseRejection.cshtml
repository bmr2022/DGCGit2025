@using static eTactWeb.DOM.Models.Common
@model eTactWeb.DOM.Models.AccPurchaseRejectionModel

@{
    ViewData["Title"] = "Purchase Rejection";
    Layout = "~/Views/Shared/_LayoutMain.cshtml";
    ViewData["PageName"] = "Purchase Rejection";
}
<style>

    .select2-container--default .select2-selection--single {
        background-color: #e0f2f1;
        border: 1.5px solid #0a0a0a !important;
        border-radius: 4px;
    }

        .select2-container--default .select2-selection--single .select2-selection__rendered {
            /* border-bottom: 1.5px solid #000 !important; */
            border-bottom: none !important;
        }

    .select2-container--default .select2-results > .select2-results__options {
        background-color: #e0f2f1; /* Dropdown background color */
        color: #000;
</style>

<div class="card bg-gradient mb-3 border-light shadow-lg">
    <form asp-action="PurchaseRejection" asp-controller="PurchaseRejection" autocomplete="off" method="post" class="form-horizontal" enctype="multipart/form-data">
        @Html.AntiForgeryToken()
        <input type="hidden" asp-for="Mode" value="@Model.Mode" />
        <input type="hidden" asp-for="EID" />
        <div class="card-header card-headerBG text-light bg-gradient">
            <h5>
                <strong>@ViewData["Title"] - @Model.PurchaseRejYearCode</strong>
                <span class="d-flex float-end" style="margin-top:-2px;">
                    <a type="button" class="btn btn-sm btn-outline-light bg-gradient" asp-action="PrintVoucher"
                       asp-controller="PurchaseRejection" asp-route-EntryId="@Model.PurchaseRejEntryId" asp-route-YearCode="@Model.PurchaseRejEntryId">
                        <i class="fa fa-pencil-square fa-fw fa-lg" aria-hidden="true"></i>
                        PRINT VOUCHER
                    </a>
                    <a type="button" class="btn btn-sm btn-outline-light bg-gradient" asp-action="PrintReport"
                       asp-controller="PurchaseRejection" asp-route-EntryId="@Model.PurchaseRejEntryId" asp-route-YearCode="@Model.PurchaseRejEntryId">
                        <i class="fa fa-pencil-square fa-fw fa-lg" aria-hidden="true"></i>
                        PRINT INVOICE
                    </a>
                    @if (Model.Mode == "U" && Model.Mode != "V")
                    {
                    }
                    <a asp-action="PurchaseRejection" asp-controller="PurchaseRejection" asp-route-ID="0" class="btn btn-sm btn-outline-light bg-gradient">
                        <i class="fa fa-plus-circle fafw fa-lg" aria-hidden="true"></i>
                        Add New
                    </a>
                    <a asp-action="PRDashboard" class="btn btn-sm btn-outline-light bg-gradient" style="margin-right:5px;">
                        <i class="fa-solid fa-grip fa-lg fa-fw fa-beat" style="--fa-animation-duration: 2s;"></i>
                        Dashboard
                    </a>

                    <partial name="_AddPurchaseRejectionPopUp" />
                    <div class="row justify-content-between g-2">
                        <input asp-for="FromDateBack" type="hidden" value="@Model.FromDateBack" />
                        <input asp-for="ToDateBack" type="hidden" value="@Model.ToDateBack" />
                        <input asp-for="VendorNameBack" type="hidden" value="@Model.VendorNameBack" />
                        <input asp-for="VoucherNoBack" type="hidden" value="@Model.VoucherNoBack" />
                        <input asp-for="InvoiceNoBack" type="hidden" value="@Model.InvoiceNoBack" />
                        <input asp-for="PartCodeBack" type="hidden" value="@Model.PartCodeBack" />
                        <input asp-for="GlobalSearchBack" type="hidden" value="@Model.GlobalSearchBack" />
                        <div class="col-auto">
                            <a href="#" class=" btn btn-primary btn-sm" onclick="PressBack();">
                                <i class="fa fa-chevron-circle-left fa-fw fa-lg" aria-hidden="true"></i>
                                BACK
                            </a>
                        </div>
                        @if (Model.Mode != "V")
                        {
                            <div class="col-auto">
                                <a class="btn btn-secondary btn-sm" onclick="location.href=$('form')[0].action">
                                    <i class="fa fa-refresh fa-fw fa-lg" aria-hidden="true"></i>
                                    REFRESH
                                </a>
                            </div>
                            @if (Model.Mode == "U")
                            {
                                <div class="col-auto">
                                    <button type="submit" class="btn btn-sm btn-outline-light bg-gradient" id="UpdateButton">
                                        <i class="fa fa-pencil-square fa-fw fa-lg" aria-hidden="true"></i>
                                        UPDATE
                                    </button>
                                </div>
                            }

                            else
                            {
                                <div class="col-auto">
                                    <button type="submit" class="btn btn-primary btn-sm" id="submitBTN">
                                        <i class="fa-solid fa-chevron-circle-right"></i>
                                        SUBMIT
                                    </button>
                                </div>
                            }
                        }
                    </div>

                </span>
            </h5>
        </div>
        <div class="card-body bg-light pt-0">
            @*<div asp-validation-summary="All" class="text-danger pt-1"></div>*@
            <div class="accordion shadow-lg">
                <div class="accordion-item">
                    <h2 class="accordion-header" id="HPanel1">
                        <button class="accordion-button text-light pnl4BG bg-gradient" type="button" data-bs-toggle="collapse" data-bs-target="#BPanel1" aria-expanded="true" aria-controls="BPanel1">
                            <i class="fa-brands fa-wpforms fa-lg fa-fw pr35"></i>
                            Required Parameter
                            <small class="p-3"></small>
                        </button>
                    </h2>
                    <div id="BPanel1" class="accordion-collapse collapse show pnl4 bg-gradient" aria-labelledby="HPanel1">
                        <partial name="_PurchaseRejectionMain" />
                    </div>
                </div>
                <div class="accordion-item">
                    <h2 class="accordion-header" id="HPanel2">
                        <button class="accordion-button collapsed text-light pnl1BG bg-gradient" type="button" data-bs-toggle="collapse" data-bs-target="#BPanel2" aria-expanded="true" aria-controls="BPanel2">
                            <strong style="text-transform:uppercase"><i class="fa-solid fa-table-list fa-lg fa-fw pr35 fa-fade" style="--fa-animation-duration: 2s; --fa-fade-opacity: 0.6;"></i>Item Detail Grid</strong>
                        </button>
                    </h2>
                    <div id="BPanel2" class="accordion-collapse collapse pnl1 bg-gradient" aria-labelledby="HPanel2">
                        <div class="accordion-body">
                            <partial name="_PurchaseRejectionItemDetail" />

                            <div class="progress my-2 mb-3" style="height: 4px;">
                                <div class="progress-bar progress-bar-striped bg-secondary progress-bar-animated" role="progressbar" style="width: 100%" aria-valuenow="100" aria-valuemin="0" aria-valuemax="100"></div>
                            </div>
                            <div class="card">
                                <div class="d-flex justify-content-end align-items-center mt-3">

                                    <div class="col-auto ms-3">
                                        <input type="text" class="form-control" id="search-box" style="background-color: #FFFACD;" placeholder="Search...">
                                    </div>
                                </div>

                                <div class="table-responsive" style="max-height:150px;">
                                    <table class="table table-hover table-bordered table-striped" id="poTable">
                                        <thead class="bg-gradient card-headerBG text-light small" id="poThead" style="white-space:nowrap; font-size: 12px; position: sticky; top: 0; z-index: 10;">
                                            <tr id="headerRow">
                                                <th>Action</th>
                                                <th data-columnno="1" data-sortorder="asc" class="sortCol">
                                                    <span style="padding:5px;margin:5px" class="sort-icon">
                                                        <i class="fa" aria-hidden="true"></i>
                                                    </span>PartCode
                                                </th>
                                                <th data-columnno="2" data-sortorder="asc" class="sortCol">
                                                    <span style="padding:5px;margin:5px" class="sort-icon">
                                                        <i class="fa" aria-hidden="true"></i>
                                                    </span>ItemName
                                                </th>
                                                <th data-columnno="3" data-sortorder="asc" class="sortCol">
                                                    <span style="padding:5px;margin:5px" class="sort-icon">
                                                        <i class="fa" aria-hidden="true"></i>
                                                    </span>HSNNo
                                                </th>
                                                <th data-columnno="4" data-sortorder="asc" class="sortCol">
                                                    <span style="padding:5px;margin:5px" class="sort-icon">
                                                        <i class="fa" aria-hidden="true"></i>
                                                    </span>BillQty
                                                </th>
                                                <th data-columnno="5" data-sortorder="asc" class="sortCol">
                                                    <span style="padding:5px;margin:5px" class="sort-icon">
                                                        <i class="fa" aria-hidden="true"></i>
                                                    </span>RejectedQty
                                                </th>
                                                <th data-columnno="6" data-sortorder="asc" class="sortCol">
                                                    <span style="padding:5px;margin:5px" class="sort-icon">
                                                        <i class="fa" aria-hidden="true"></i>
                                                    </span>Unit
                                                </th>
                                                <th data-columnno="7" data-sortorder="asc" class="sortCol">
                                                    <span style="padding:5px;margin:5px" class="sort-icon">
                                                        <i class="fa" aria-hidden="true"></i>
                                                    </span>AltQty
                                                </th>
                                                <th data-columnno="8" data-sortorder="asc" class="sortCol">
                                                    <span style="padding:5px;margin:5px" class="sort-icon">
                                                        <i class="fa" aria-hidden="true"></i>
                                                    </span>AltUnit
                                                </th>
                                                <th data-columnno="9" data-sortorder="asc" class="sortCol">
                                                    <span style="padding:5px;margin:5px" class="sort-icon">
                                                        <i class="fa" aria-hidden="true"></i>
                                                    </span>PRRate
                                                </th>
                                                <th data-columnno="10" data-sortorder="asc" class="sortCol">
                                                    <span style="padding:5px;margin:5px" class="sort-icon">
                                                        <i class="fa" aria-hidden="true"></i>
                                                    </span>BillRate
                                                </th>
                                                <th data-columnno="11" data-sortorder="asc" class="sortCol">
                                                    <span style="padding:5px;margin:5px" class="sort-icon">
                                                        <i class="fa" aria-hidden="true"></i>
                                                    </span>UnitRate
                                                </th>
                                                <th data-columnno="12" data-sortorder="asc" class="sortCol">
                                                    <span style="padding:5px;margin:5px" class="sort-icon">
                                                        <i class="fa" aria-hidden="true"></i>
                                                    </span>AltRate
                                                </th>
                                                <th data-columnno="13" data-sortorder="asc" class="sortCol">
                                                    <span style="padding:5px;margin:5px" class="sort-icon">
                                                        <i class="fa" aria-hidden="true"></i>
                                                    </span>NoOfCase
                                                </th>
                                                <th data-columnno="14" data-sortorder="asc" class="sortCol">
                                                    <span style="padding:5px;margin:5px" class="sort-icon">
                                                        <i class="fa" aria-hidden="true"></i>
                                                    </span>CostCenterId
                                                </th>
                                                <th data-columnno="15" data-sortorder="asc" class="sortCol">
                                                    <span style="padding:5px;margin:5px" class="sort-icon">
                                                        <i class="fa" aria-hidden="true"></i>
                                                    </span>DocAccountName
                                                </th>
                                                <th data-columnno="16" data-sortorder="asc" class="sortCol">
                                                    <span style="padding:5px;margin:5px" class="sort-icon">
                                                        <i class="fa" aria-hidden="true"></i>
                                                    </span>ItemAmount
                                                </th>
                                                <th data-columnno="17" data-sortorder="asc" class="sortCol">
                                                    <span style="padding:5px;margin:5px" class="sort-icon">
                                                        <i class="fa" aria-hidden="true"></i>
                                                    </span>StoreName
                                                </th>
                                                <th data-columnno="18" data-sortorder="asc" class="sortCol">
                                                    <span style="padding:5px;margin:5px" class="sort-icon">
                                                        <i class="fa" aria-hidden="true"></i>
                                                    </span>Batch No
                                                </th>
                                                <th data-columnno="19" data-sortorder="asc" class="sortCol">
                                                    <span style="padding:5px;margin:5px" class="sort-icon">
                                                        <i class="fa" aria-hidden="true"></i>
                                                    </span>Unique BatchNo
                                                </th>
                                                <th data-columnno="20" data-sortorder="asc" class="sortCol">
                                                    <span style="padding:5px;margin:5px" class="sort-icon">
                                                        <i class="fa" aria-hidden="true"></i>
                                                    </span>Lot Stock
                                                </th>
                                                <th data-columnno="21" data-sortorder="asc" class="sortCol">
                                                    <span style="padding:5px;margin:5px" class="sort-icon">
                                                        <i class="fa" aria-hidden="true"></i>
                                                    </span>Total Stock
                                                </th>
                                                <th data-columnno="22" data-sortorder="asc" class="sortCol">
                                                    <span style="padding:5px;margin:5px" class="sort-icon">
                                                        <i class="fa" aria-hidden="true"></i>
                                                    </span>DiscountPer
                                                </th>
                                                <th data-columnno="23" data-sortorder="asc" class="sortCol">
                                                    <span style="padding:5px;margin:5px" class="sort-icon">
                                                        <i class="fa" aria-hidden="true"></i>
                                                    </span>DiscountAmt
                                                </th>
                                                <th data-columnno="24" data-sortorder="asc" class="sortCol">
                                                    <span style="padding:5px;margin:5px" class="sort-icon">
                                                        <i class="fa" aria-hidden="true"></i>
                                                    </span>ItemSize
                                                </th>
                                                <th data-columnno="25" data-sortorder="asc" class="sortCol">
                                                    <span style="padding:5px;margin:5px" class="sort-icon">
                                                        <i class="fa" aria-hidden="true"></i>
                                                    </span>ItemDescription
                                                </th>
                                                <th data-columnno="26" data-sortorder="asc" class="sortCol">
                                                    <span style="padding:5px;margin:5px" class="sort-icon">
                                                        <i class="fa" aria-hidden="true"></i>
                                                    </span>Remark
                                                </th>
                                                <th data-columnno="27" data-sortorder="asc" class="sortCol">
                                                    <span style="padding:5px;margin:5px" class="sort-icon">
                                                        <i class="fa" aria-hidden="true"></i>
                                                    </span>MIRNo
                                                </th>
                                                <th data-columnno="28" data-sortorder="asc" class="sortCol">
                                                    <span style="padding:5px;margin:5px" class="sort-icon">
                                                        <i class="fa" aria-hidden="true"></i>
                                                    </span>MIR Entry Id
                                                </th>
                                                <th data-columnno="29" data-sortorder="asc" class="sortCol">
                                                    <span style="padding:5px;margin:5px" class="sort-icon">
                                                        <i class="fa" aria-hidden="true"></i>
                                                    </span>MIR Year Code
                                                </th>
                                                <th data-columnno="30" data-sortorder="asc" class="sortCol">
                                                    <span style="padding:5px;margin:5px" class="sort-icon">
                                                        <i class="fa" aria-hidden="true"></i>
                                                    </span>MIR Date
                                                </th>
                                                <th data-columnno="31" data-sortorder="asc" class="sortCol">
                                                    <span style="padding:5px;margin:5px" class="sort-icon">
                                                        <i class="fa" aria-hidden="true"></i>
                                                    </span>In Process No
                                                </th>
                                                <th data-columnno="32" data-sortorder="asc" class="sortCol">
                                                    <span style="padding:5px;margin:5px" class="sort-icon">
                                                        <i class="fa" aria-hidden="true"></i>
                                                    </span>In Process Entry Id
                                                </th>
                                                <th data-columnno="33" data-sortorder="asc" class="sortCol">
                                                    <span style="padding:5px;margin:5px" class="sort-icon">
                                                        <i class="fa" aria-hidden="true"></i>
                                                    </span>In Process Year Code
                                                </th>
                                                <th data-columnno="34" data-sortorder="asc" class="sortCol">
                                                    <span style="padding:5px;margin:5px" class="sort-icon">
                                                        <i class="fa" aria-hidden="true"></i>
                                                    </span>In Process Date
                                                </th>
                                            </tr>
                                        </thead>
                                        <tbody id="divAddPurchaseRejectionList">
                                            <partial name="_PurchaseRejectionGrid" />
                                            <input type="hidden" value="@Model.DocAccountCode" id="hdnDocAccountCode" />
                                        </tbody>
                                    </table>
                                </div>
                                <div class="row g-2 gx-3">
                                    <div class="col-12 text-center">
                                        <strong>BASIC TOTAL : <i class="fa-solid fa-indian-rupee-sign fa-fw fa-1x"></i><span id="lblItemGridNetAmount"></span></strong>
                                        <strong>, TOTAL NO OF ITEMS : <span id="lblItemGridCount"></span></strong>
                                    </div>
                                </div>

                                <div class="table-responsive" style="max-height:150px;">
                                    <table class="table table-hover table-bordered table-striped mt-3" id="poTable">
                                        <thead class="bg-gradient card-headerBG text-light small" id="poThead" style="white-space:nowrap; font-size: 12px; position: sticky; top: 0; z-index: 10;">
                                            <tr id="headerRow">
                                                <th>Sr#</th>
                                                <th data-columnno="0" data-sortorder="asc" class="sortCol"><span style="padding:5px;margin:5px" class="sort-icon"><i class="fa" aria-hidden="true"></i></span>Part Code</th>
                                                <th data-columnno="1" data-sortorder="asc" class="sortCol"><span style="padding:5px;margin:5px" class="sort-icon"><i class="fa" aria-hidden="true"></i></span>Item Name</th>
                                                @* <th data-columnno="0" data-sortorder="asc" class="sortCol"><span style="padding:5px;margin:5px" class="sort-icon"><i class="fa" aria-hidden="true"></i></span>SaleBill EntryId</th>
                                                <th data-columnno="1" data-sortorder="asc" class="sortCol"><span style="padding:5px;margin:5px" class="sort-icon"><i class="fa" aria-hidden="true"></i></span>SaleBill YearCode</th>
                                                <th data-columnno="2" data-sortorder="asc" class="sortCol"><span style="padding:5px;margin:5px" class="sort-icon"><i class="fa" aria-hidden="true"></i></span>Sale BillNo</th>
                                                <th data-columnno="3" data-sortorder="asc" class="sortCol"><span style="padding:5px;margin:5px" class="sort-icon"><i class="fa" aria-hidden="true"></i></span>Sale BillDate</th> *@
                                                <th data-columnno="2" data-sortorder="asc" class="sortCol"><span style="padding:5px;margin:5px" class="sort-icon"><i class="fa" aria-hidden="true"></i></span>PurchBill EntryId</th>
                                                <th data-columnno="3" data-sortorder="asc" class="sortCol"><span style="padding:5px;margin:5px" class="sort-icon"><i class="fa" aria-hidden="true"></i></span>PurchBill YearCode</th>
                                                <th data-columnno="4" data-sortorder="asc" class="sortCol"><span style="padding:5px;margin:5px" class="sort-icon"><i class="fa" aria-hidden="true"></i></span>Invoice No</th>
                                                <th data-columnno="5" data-sortorder="asc" class="sortCol"><span style="padding:5px;margin:5px" class="sort-icon"><i class="fa" aria-hidden="true"></i></span>Invoice Date</th>
                                                <th data-columnno="6" data-sortorder="asc" class="sortCol"><span style="padding:5px;margin:5px" class="sort-icon"><i class="fa" aria-hidden="true"></i></span>Item Name</th>
                                                <th data-columnno="7" data-sortorder="asc" class="sortCol"><span style="padding:5px;margin:5px" class="sort-icon"><i class="fa" aria-hidden="true"></i></span>Part Code</th>
                                                <th data-columnno="8" data-sortorder="asc" class="sortCol"><span style="padding:5px;margin:5px" class="sort-icon"><i class="fa" aria-hidden="true"></i></span>INV NetAmt</th>
                                                <th data-columnno="9" data-sortorder="asc" class="sortCol"><span style="padding:5px;margin:5px" class="sort-icon"><i class="fa" aria-hidden="true"></i></span>Due Date</th>
                                                <th data-columnno="10" data-sortorder="asc" class="sortCol"><span style="padding:5px;margin:5px" class="sort-icon"><i class="fa" aria-hidden="true"></i></span>Paid Amt</th>
                                                <th data-columnno="11" data-sortorder="asc" class="sortCol"><span style="padding:5px;margin:5px" class="sort-icon"><i class="fa" aria-hidden="true"></i></span>Remaining Amt</th>
                                                <th data-columnno="12" data-sortorder="asc" class="sortCol"><span style="padding:5px;margin:5px" class="sort-icon"><i class="fa" aria-hidden="true"></i></span>Bill Qty</th>
                                                <th data-columnno="13" data-sortorder="asc" class="sortCol"><span style="padding:5px;margin:5px" class="sort-icon"><i class="fa" aria-hidden="true"></i></span>Bill Rate</th>
                                                <th data-columnno="14" data-sortorder="asc" class="sortCol"><span style="padding:5px;margin:5px" class="sort-icon"><i class="fa" aria-hidden="true"></i></span>Item Amount</th>
                                                <th data-columnno="15" data-sortorder="asc" class="sortCol"><span style="padding:5px;margin:5px" class="sort-icon"><i class="fa" aria-hidden="true"></i></span>Disc Per</th>
                                                <th data-columnno="16" data-sortorder="asc" class="sortCol"><span style="padding:5px;margin:5px" class="sort-icon"><i class="fa" aria-hidden="true"></i></span>Dis Amt</th>
                                                @* <th data-columnno="17" data-sortorder="asc" class="sortCol"><span style="padding:5px;margin:5px" class="sort-icon"><i class="fa" aria-hidden="true"></i></span>SONO</th>
                                                <th data-columnno="18" data-sortorder="asc" class="sortCol"><span style="padding:5px;margin:5px" class="sort-icon"><i class="fa" aria-hidden="true"></i></span>CustOrderNo</th>
                                                <th data-columnno="19" data-sortorder="asc" class="sortCol"><span style="padding:5px;margin:5px" class="sort-icon"><i class="fa" aria-hidden="true"></i></span>SO Date</th>
                                                <th data-columnno="20" data-sortorder="asc" class="sortCol"><span style="padding:5px;margin:5px" class="sort-icon"><i class="fa" aria-hidden="true"></i></span>PO NO</th> 
                                                <th data-columnno="15" data-sortorder="asc" class="sortCol"><span style="padding:5px;margin:5px" class="sort-icon"><i class="fa" aria-hidden="true"></i></span>PO Date</th>
                                                <th data-columnno="16" data-sortorder="asc" class="sortCol"><span style="padding:5px;margin:5px" class="sort-icon"><i class="fa" aria-hidden="true"></i></span>PO EntryId</th>
                                                <th data-columnno="17" data-sortorder="asc" class="sortCol"><span style="padding:5px;margin:5px" class="sort-icon"><i class="fa" aria-hidden="true"></i></span>PO Yearcode</th>*@
                                            </tr>
                                        </thead>
                                        <tbody id="divAddPurchaseRejectionPopupDataGrid">
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                        <div class="progress my-3 mb-3" style="height: 4px;">
                            <div class="progress-bar progress-bar-striped bg-warning" role="progressbar" style="width: 100%" aria-valuenow="100" aria-valuemin="0" aria-valuemax="100"></div>
                        </div>
                        <div class="row g-2 gx-3">
                            <div class="col-12 text-center">
                                <strong> TOTAL NO OF ITEMS : <span id="lblItemCount"></span></strong>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="accordion-item">
                    <h2 class="accordion-header" id="H_TaxDetail">
                        <button class="accordion-button collapsed text-light pnl4BG bg-gradient" type="button" data-bs-toggle="collapse" data-bs-target="#B_TaxDetail" aria-expanded="true" aria-controls="B_TaxDetail">
                            <strong style="text-transform:uppercase"><i class="fa-solid fa-table-list fa-lg fa-fw pr35 fa-fade" style="--fa-animation-duration: 2s; --fa-fade-opacity: 0.6;"></i>Tax Detail</strong>
                        </button>
                    </h2>
                    <div id="B_TaxDetail" class="accordion-collapse collapse pnl4 bg-gradient" aria-labelledby="H_TaxDetail">
                        <div class="accordion-body">
                            <partial name="_TaxDetail" />
                            <div class="row g-2 gx-3 justify-content-around">
                                @*<div class="col-xl-2 col-lg-3 col-md-3 col-sm-6 col-xs-12">
                                <label asp-for="TotalRoundOff" class="form-label">RoundOff</label>
                                    <select class="form-select" asp-for="TotalRoundOff" asp-items="Model.YesNoList" onchange="onNetTotalChange()">
                                    <option value="">-Select-</option>
                                </select>
                            </div>
                            <div class="col-xl-2 col-lg-3 col-md-3 col-sm-6 col-xs-12">
                                <label asp-for="TotalDiscountPercentage" class="form-label">Discount %</label>
                                    <input asp-for="TotalDiscountPercentage" class="form-control" onchange="onNetTotalChange()" min="0" max="100" />
                            </div>
                            <div class="col-xl-2 col-lg-3 col-md-3 col-sm-6 col-xs-12">
                                <label asp-for="TotalAmtAftrDiscount" class="form-label">Amt Aftr Discount</label>
                                <input asp-for="TotalAmtAftrDiscount" class="form-control" readonly />
                            </div>*@
                                <div class="col-xl-2 col-lg-3 col-md-3 col-sm-6 col-xs-12">
                                    <label asp-for="NetTotal" class="form-label">Net Total</label>
                                    <input asp-for="NetTotal" class="form-control" onchange="onNetTotalChange()" readonly />
                                </div>
                            </div>
                            <div class="progress my-3" style="height: 4px;">
                                <div class="progress-bar progress-bar-striped bg-danger" role="progressbar" style="width: 100%" aria-valuenow="100" aria-valuemin="0" aria-valuemax="100"></div>
                            </div>
                            @*    <div class="row g-2 gx-3 justify-content-around">
                        <div class="col-xl-2 col-lg-3 col-md-3 col-sm-6 col-xs-12">
                        <label asp-for="TotalRoundOff" class="form-label">RoundOff</label>
                        <select class="form-select" asp-for="TotalRoundOff" asp-items="Model.YesNoList">
                        <option value="">-Select-</option>
                        </select>
                        </div>
                        <div class="col-xl-2 col-lg-3 col-md-3 col-sm-6 col-xs-12">
                        <label asp-for="TotalDiscountPercentage" class="form-label">Discount %</label>
                        <input asp-for="TotalDiscountPercentage" class="form-control" min="0" max="100" />
                        </div>
                        <div class="col-xl-2 col-lg-3 col-md-3 col-sm-6 col-xs-12">
                        <label asp-for="TotalAmtAftrDiscount" class="form-label">Amt Aftr Discount</label>
                        <input asp-for="TotalAmtAftrDiscount" class="form-control" readonly />
                        </div>
                        <div class="col-xl-2 col-lg-3 col-md-3 col-sm-6 col-xs-12">
                        <label asp-for="NetTotal" class="form-label">Net Total</label>
                        <input asp-for="NetTotal" class="form-control" readonly />
                        </div>
                        </div> *@
                        </div>
                    </div>
                </div>
                <div class="accordion-item">
                    @* <partial name="_DrCrTable" /> *@
                    @await Html.PartialAsync("_DrCrTable", Model)
                </div>
                <div class="accordion-item">
                    @await Html.PartialAsync("_AdjustmentGrid", Model.adjustmentModel == null ? new AdjustmentModel() : Model.adjustmentModel)
                </div>
                <div class="accordion-item">
                    <h2 class="accordion-header" id="HPanel4">
                        <button class="accordion-button collapsed text-light pnl1BG bg-gradient" type="button" data-bs-toggle="collapse" data-bs-target="#BPanel4" aria-expanded="true" aria-controls="BPanel4">
                            <strong style="text-transform:uppercase"><i class="fa-solid fa-table-list fa-lg fa-fw pr35 fa-fade" style="--fa-animation-duration: 2s; --fa-fade-opacity: 0.6;"></i>Other Detail</strong>
                            <small class="p-3"></small>
                        </button>
                    </h2>
                    <div id="BPanel4" class="accordion-collapse collapse pnl1 bg-gradient" aria-labelledby="HPanel4">
                        <partial name="_PurchaseRejectionOtherDetail" />
                    </div>

                </div>
            </div>
        </div>

        <div class="card-footer p-3">
            <div class="card-header card-headerBG text-light bg-gradient">
                <h5>
                    <strong>@ViewData["Title"] - @Model.PurchaseRejYearCode</strong>
                    <span class="d-flex float-end" style="margin-top:-2px;">
                        @*<a asp-action="Dashboard" asp-route-ID="0" class="btn btn-sm btn-outline-light bg-gradient">*@
                        <div class="row justify-content-between g-2">
                            <div class="col-auto">
                                @*<a href="#" class="btn offer-listbtn hvr-sweep-to-right btn-sm btn-secondary" onclick="back();">*@

                                <a asp-action="PendingSaleRejection" asp-controller="PendingSaleRejection" asp-route-ID="0" class="btn btn-sm btn-outline-light bg-gradient">
                                    <i class="fa fa-plus-circle fafw fa-lg" aria-hidden="true"></i>
                                    Add New
                                </a>
                                <a asp-action="PRDashboard" asp-route-ID="0" class="btn btn-secondary btn-sm">
                                    <i class="fa-solid fa-grid-horizontal fa-lg fa-fw fa-beat" style="--fa-animation-duration: 2s;"></i>
                                    Dashboard
                                </a>
                                <a href="#" class=" btn btn-primary btn-sm">
                                    <i class="fa fa-chevron-circle-left fa-fw fa-lg" aria-hidden="true"></i>
                                    BACK
                                </a>
                            </div>
                            @if (Model.Mode != "V")
                            {
                                <div class="col-auto">
                                    @*  <a class="btn btn-sm btn-outline-danger" onclick="location.href=$('form')[0].action">*@
                                    <a class="btn btn-secondary btn-sm" asp-action="SaleRejection" asp-controller="SaleRejection">
                                        @* <i class="fa-solid fa-grip fa-lg fa-fw fa-beat" style="--fa-animation-duration: 2s;"></i>*@
                                        <i class="fa fa-refresh fa-fw fa-lg" aria-hidden="true"></i>
                                        REFRESH
                                    </a>
                                </div>
                                @if (Model.Mode == "U")
                                {
                                    @*Model.Mode = "U";*@
                                    <div class="col-auto">
                                        @* <button type="submit" class="btn btn-sm btn-outline-warning">*@
                                        <button type="submit" class="btn btn-sm btn-outline-light bg-gradient" id="UpdateButton">
                                            <i class="fa fa-pencil-square fa-fw fa-lg" aria-hidden="true"></i>
                                            UPDATE
                                        </button>
                                    </div>
                                }
                                else
                                {
                                    <div class="col-auto">
                                        @*   <button type="submit" class="btn btn-sm btn-outline-primary">*@
                                        <button type="submit" class="btn btn-primary btn-sm" id="submitBTNfooter">
                                            <i class="fa-solid fa-chevron-circle-right"></i>
                                            SUBMIT
                                        </button>
                                    </div>
                                }
                            }
                        </div>
                    </span>
                </h5>
            </div>
        </div>

    </form>
</div>
<style>
    #divTaxGrid tr td {
        font-weight: 300;
    }

    #divAddPurchaseRejectionList tr td {
        font-weight: 300;
    }
</style>

@section Scripts
{
    <script>
            function FillPopUpGridDetails(modeId) {
            var html = '';
            if (modeId === 'U' || modeId === 'V') {
                var data = @Html.Raw(Json.Serialize(Model.AccPurchaseRejectionAgainstBillDetails));
                j = 1;
                if (data && data.length > 0) {
                    data.forEach((item, index) => {
                        html += `<tr id="PRPopUpDataRow-j" style="font-size: 12px;">
                        <td> ` + j + `</td>
                        <td id="partCode-` + j + `">${item.partCode || ''}<input type="hidden" id="popupItemCode-` + j + `" value="${item.itemCode || ''}" /></td>
                        <td id="popUpItemCodeName-` + j + `">${item.itemName || ''}</td>
                        <td id="popUpPurchBillEntryId-` + j + `">${item.againstPurchaseBillEntryId || ''}</td>
                        <td id="popUpPurchBillYearCode-` + j + `">${item.againstPurchaseBillYearCode || ''}</td>
                        <td id="popUpInvoiceNo-` + j + `">${item.purchaseRejectionInvoiceNo || ''}</td>
                        <td id="popUpInvoiceDate-` + j + `">${item.againstPurchaseBillDate || ''}</td>
                        <td id="popUpItemName-` + j + `">${item.itemName || ''}</td>
                        <td id="popUpPartCode-` + j + `">${item.partCode || ''}</td>
                        <td id="popUpINVNetAmt-` + j + `">${item.itemNetAmount || 0}</td>
                        <td id="popUpDueDate-` + j + `">${item.poDate || ''}</td>
                        <td id="popUpPaidAmt-` + j + `">0</td>
                        <td id="popUpRemainingAmt-` + j + `">0</td>
                        <td id="popUpBillQty-` + j + `">${item.billQty || 0}</td>
                        <td id="popUpBillRate-` + j + `">${item.billRate || 0}</td>
                        <td id="popUpItemAmount-` + j + `">${item.amount || 0}</td>
                        <td id="popUpdisPer-` + j + `">${item.discountPer || 0}</td>
                        <td id="popUpDisAmt-` + j + `">${item.discountAmt || 0}</td>
                    </tr>`;
                        billQty += parseFloat(item.BillQty) || 0;
                        billRate += parseFloat(item.BillRate) || 0;
                    });
                } else {
                    html = '<tr class="text-center"><td colspan="32" class="text-black-50"><strong>NO DATA ADDED</strong></td></tr>';
                }
                $('#BillQty').val(billQty.toFixed(2));
                $('#BillRate').val(billRate.toFixed(2));
                $('#RejectedQty').val($('#BillQty').val());
                $('#PRRate').val($('#BillRate').val());
                CalculateItemAmount();
                BasicTotal();
                $('#divAddPurchaseRejectionPopupDataGrid').html(html);
            }
        }
        $(document).ready(function () {
            GetServerDate();
            if ($('#Mode').val() != "U" && $('#Mode').val() != "V") {
                NewEntryId();
                $('#divAddPurchaseRejectionPopupDataGrid').empty();
            }
             $("input, select, textarea").each(function () {
                var $field = $(this);
                var rules = $field.rules();
                if (rules && rules.required) {
                    $field.rules("remove", "required");
                }
            });
            $("form").validate().resetForm();
            $('#PartCode').select2();
            $('#ItemCode').select2();
            $('#AccountCode').select2();
            // FillCustomerName();
            FillCustomerName("N");
            FillSubvoucher();
            FillCurrency();
            GetExchnageRate();
            FillDocument("F");
            FillItems($('#ItemSA').is(':checked'));
            FillStore();
            FillPopUpGridDetails($('#Mode').val());
            BasicTotal();
            BasicPopUpItemGrid();
            BasicItemGridTotal();
            GetCostCenter();
            DueDateCalculation();
            $('#GstRegUnreg').rules("remove", "required");
            $('#Transporter').rules("remove", "required");
            $('#HSNNo').rules("remove", "required");
            $('#Unit').rules("remove", "required");
            $('#AltUnit').rules("remove", "required");
            $('#UnitRate').rules("remove", "required");
            $('#ItemSize').rules("remove", "required");
            $('#ItemDescription').rules("remove", "required");
            $('#Remark').rules("remove", "required");
            $('#PurchaserejRemark').rules("remove", "required");
            $('#RoundoffType').rules("remove", "required");
            $('#ItemService').rules("remove", "required");
            $('#INVOICETYPE').rules("remove", "required");
            $('#MachineName').rules("remove", "required");
            $('#ActualEntryDate').rules("remove", "required");
            $('#ActualEnteredBy').rules("remove", "required");
            $('#ActualEnteredByName').rules("remove", "required");
            $('#LastUpdatedByName').rules("remove", "required");
            $('#LastUpdationDate').rules("remove", "required");
            $('#EntryFreezToAccounts').rules("remove", "required");
            $('#BalanceSheetClosed').rules("remove", "required");
            $('#EInvNo').rules("remove", "required");
            $('#EinvGenerated').rules("remove", "required");
            $('#AttachmentFilePath1').rules("remove", "required");
            $('#AttachmentFilePath2').rules("remove", "required");
            $('#AttachmentFilePath3').rules("remove", "required");
            $('#PaymentTerm').rules("remove", "required");
            $('#Vehicleno').rules("remove", "required");

            var taxRowCount = $('#divTaxGrid tr').length;

            var txSum = 0;
            if ($('#divTaxGrid tr td').length > 1) {
                for (var i = 0; i < taxRowCount; i++) {
                    txSum += parseFloat($('#txGridAmount-' + (i + 1)).text()) == '.00' || $('#txGridAmount-' + (i + 1)).text() == '' ? 0 : parseFloat($('#txGridAmount-' + (i + 1)).text());
                }
            }

            var txTotal = sum + txSum;
            $('#NetTotal').val(txTotal.toFixed(2));
            $('#AdjPendAmt').val($('#NetTotal').val());
            $('#CostCenterId').select2();

            $('#AdjNewRefNo').val($('#PurchaseRejectionInvoiceNo').val());
            $('#AdjDescription').val($('#PurchaseRejectionInvoiceNo').val());
            if ($('#Mode').val() == "U" || $('#Mode').val() == "V" || $('#Mode').val() == "INSERT") {
                onInvoiceChange('PurchaseRejectionInvoiceNo');
                setInterval(checkNetTotalChange, 500);
            }
            if ($('#Mode').val() == "V" || $('#Mode').val() == "U")
            {
                GetDbCrDetail();
            }
        });

        $('#AdjModeOfAdjstment').change(function () {
            $('#AdjNewRefNo').val($('#PurchaseRejectionInvoiceNo').val());
            $('#AdjDescription').val($('#PurchaseRejectionInvoiceNo').val());
            $('#AdjPendAmt').val($('#NetTotal').val());
        });

        $('#PurchaseRejectionInvoiceNo').change(function () {
            $('#AdjNewRefNo').val($('#PurchaseRejectionInvoiceNo').val());
            $('#AdjDescription').val($('#PurchaseRejectionInvoiceNo').val());
        });

        var currentSearchColumn = null;

        $("#popup-search-box").on("keyup", function () {

            var value = $(this).val().toLowerCase();
            $("#divPurchaseRejectionDataGrid tr").filter(function () {
                if (currentSearchColumn !== null) {
                    var columnText = $(this).find('td').eq(currentSearchColumn).text().toLowerCase();
                    $(this).toggle(columnText.indexOf(value) > -1);
                } else {
                    $(this).toggle($(this).text().toLowerCase().indexOf(value) > -1);
                }
            });
        });

        $(document).on("click", "th[data-columnno]", function () {
            currentSearchColumn = $(this).data('columnno');
            $("#popup-search-box").val('').trigger('keyup');
        });

        $('#Vehicleno').on('input', function () {
            var inputValue = $(this).val();
            if (inputValue.length > 10) {
                $(this).val(inputValue.substring(0, 10));
            }
        });

        function GetCostCenter() {
            $.ajax({
                type: "POST",
                url: "@Url.Action("GetCostCenter")",
                dataType: "json",
                async: false,
                success: function (result, status, error) {

                    if (result != null) {
                        var obj = $.parseJSON(result);
                        if (obj.Result != null) {
                            $('#CostCenterId').empty();
                            $('#CostCenterId').append('<option value="0">-Select-</option>');
                            if (obj.StatusCode != 500) {
                                $.each(obj.Result.Table, function (index, val) {
                                    $('#CostCenterId').append("<option value=" + val.CostCenterId + ">" + val.costcentername + "</option>");
                                });
                            }
                        }
                    }
                }
            });
        }

        function NewEntryId() {
            var YearCode = $('#PurchaseRejYearCode').val();
            $.ajax({
                type: "POST",
                data: { "YearCode": YearCode },
                url: "@Url.Action("NewEntryId")",
                dataType: "json",
                async: false,
                success: function (result, status, error) {

                    if (result != null) {
                        var obj = $.parseJSON(result);
                        if (obj.Result != null) {
                            $('#PurchaseRejEntryId').val("");
                            $('#PurchaseRejEntryId').val(obj.Result.Table[0].EntryId);
                            $('#PurchaseRejectionVoucherNo').val("");
                            $('#PurchaseRejectionVoucherNo').val(obj.Result.Table[0].creditNoteNo);
                            $('#VoucherNo').val("");
                            $('#VoucherNo').val(obj.Result.Table[0].creditNoteNo);
                            $('#AdjDescription').val($('#PurchaseRejectionInvoiceNo').val());
                            $('#AdjNewRefNo').val($('#PurchaseRejectionInvoiceNo').val());
                        }
                    }
                }
            });
        }

        function PopUpDataGrid() {
            $.ajax({
                type: "POST",
                data: { "itemCode": $('#ItemCode').val() },
                url: "@Url.Action("PopUpDataGrid")",
                dataType: "json",
                async: false,
                success: function (result, status, error) {
                    if (result != null) {
                        var obj = $.parseJSON(result);
                        if (obj.Result != null) {
                            $('#PurchaseRejEntryId').val("");
                            $('#PurchaseRejEntryId').val(obj.Result.Table[0].EntryId);
                            $('#PurchaseRejectionVoucherNo').val("");
                            $('#PurchaseRejectionVoucherNo').val(obj.Result.Table[0].purchaseRejectionNo);
                        }
                    }
                }
            });
        }
        var purchaseRejectionPopupGrid = [];
        var EditEachItem = false;
        function EditItemRows(itemCode, seq) {
            var RowCount = $('#divAddPurchaseRejectionList tr').length;
            if (EditEachItem) {
                $.notify('Cannot Edit item while AddtoGrid  Existing Item!!!', "error");
                $('#editButton-' + RowCount).prop("disabled", true);
            }
            else {
                $.ajax({
                    url: '/PurchaseRejection/EditItemRows',
                    type: "POST",
                    data: { itemCode: itemCode, Seq: seq },
                    success: function (data) {
                        var obj = $.parseJSON(data);
                        if (obj != null) {
                            ClearTax();
                            ClearDRCRGrid();
                            ClearAdjustmentGrid();
                            EditEachItem = true;
                            purchaseRejectionPopupGrid = obj.PurchaseRejectionPopupGrid;
                            obj = obj.PurchaseRejectionGrid;
                            $('#PartCode').val(obj[0].ItemCode).trigger("change")
                            $('#ItemCode').val(obj[0].ItemCode).trigger("change")
                            $('#AltQty').val(obj[0].AltQty);
                            $('#AltRate').val(obj[0].AltRate);
                            $('#AltUnit').val(obj[0].AltUnit);
                            $('#Amount').val(obj[0].Amount);
                            $('#BillQty').val(obj[0].BillQty);
                            $('#BillRate').val(obj[0].BillRate);
                            $('#PRRate').val(obj[0].PRRate);
                            $('#CostCenterId').val(obj[0].CostCenterId).trigger("change");
                            $('#DocAccountCode').val(obj[0].DocAccountCode);
                            $('#HSNNo').val(obj[0].HSNNo);
                            $('#ItemAmount').val(obj[0].ItemAmount);
                            $('#ItemCode').val(obj[0].ItemCode);
                            $('#ItemDescription').val(obj[0].ItemDescription);
                            $('#ItemSize').val(obj[0].ItemSize);
                            $('#NoOfCase').val(obj[0].NoOfCase);
                            $('#RejectedQty').val(obj[0].RejectedQty);
                            $('#UnitRate').val(obj[0].UnitRate);
                            $('#Unit').val(obj[0].Unit);
                            $('#DiscountAmt').val(obj[0].DiscountAmt);
                            $('#DiscountPer').val(obj[0].DiscountPer);
                            $('#StoreId').val(obj[0].StoreId);
                            FillCurrentBatchINStore();
                           // $('#Batchno').val(obj[0].Batchno);
                           if (obj[0].Batchno != '0' && obj[0].Batchno != null && obj[0].Batchno != 0) {
                               $('#Batchno').append('<option value="' + obj[0].Batchno + '" selected>' + obj[0].Batchno + '</option>');
                           }
                            $('#LotStock').val(obj[0].LotStock);
                            $('#TotalStock').val(obj[0].TotalStock);
                            $('#Remark').val(obj[0].Remark);
                            $('#MIRNo').val(obj[0].MIRNo);
                            $('#MIREntryID').val(obj[0].MIREntryID);
                            $('#MIRYearCode').val(obj[0].MIRYearCode);
                            $('#MIRDate').val(obj[0].MIRDate);
                            $('#InprocessNo').val(obj[0].InprocessNo);
                            $('#InprocessEntryID').val(obj[0].InprocessEntryID);
                            $('#InprocessYearCode').val(obj[0].InprocessYearCode);
                            $('#InprocessDate').val(obj[0].InprocessDate);
                            FillUniqueBatchNo();
                            $('#Uniquebatchno').val(obj[0].Uniquebatchno);

                            var rowCount = $('#divStockGrid tr').length;
                            for (var i = 1; i <= rowCount + 1; i++) {
                                $('#editItemGrid-' + i).css("pointer-events", "none");
                                $('#editItemGrid-' + i).css("cursor", "not-allowed");
                            }
                            DeleteItemRow(itemCode, seq);
                        }
                    },
                    error: function (response) {
                        $.notify(response.responseText, "error");
                    },
                    failure: function (response) {
                        $.notify(response.responseText, "error");
                    }
                }).done(function () {
                    GetDbCrDetail();
                });
            }
        }

        function ClearDRCRGrid() {
            $.ajax({
                type: "POST",
                url: "@Url.Action("ClearDRCRGrid", "SaleInvoice")",
                dataType: "json",
                success: function (result, status, error) {

                    $('#divdbCrItemList').empty();
                    var NoData = '<tr class="text-center"><td colspan="32" class="text-black-50"><strong>NO DATA ADDED</strong></td></tr>';
                    $('#divdbCrItemList').html(NoData);
                    BasicTotal();
                },
                error: function (req, status, error) {
                    alert(error);
                }
            });
        }

        function ClearPopupItemGrid() {
           const existingItemKeys = [];
           $('#divAddPurchaseRejectionList').find('tr').each(function (index) {
                const row = $(this);
                const key = index + 1;
                const uniqueKey = $('#hdnuniquekey-' + key).val();
                if (!existingItemKeys.includes(uniqueKey)) {
                        existingItemKeys.push(uniqueKey);
                }
            });
            $('#divAddPurchaseRejectionPopupDataGrid').find('tr').each(function (index) {
                 const i = index + 1;
                 const $row = $(this);
                 const entryId   = ($row.find('#popUpPurchBillEntryId-' + i).text() || '').trim();
                 const yearCode  = ($row.find('#popUpPurchBillYearCode-' + i).text() || '').trim();
                 const invoiceNo = ($row.find('#popUpInvoiceNo-' + i).text() || '').trim();
                 const itemCode  = ($row.find('#popupItemCode-' + i).val() || '').trim();
                 if (entryId && yearCode && invoiceNo && itemCode) {
                     const uniqueKey = entryId + '_' + yearCode + '_' + invoiceNo + '_' + itemCode;
                     if (!existingItemKeys.includes(uniqueKey)) {
                        $row.remove(); // Remove only if not found in main grid
                    }
                 }
             });

            if ($('#divAddPurchaseRejectionPopupDataGrid tr').length === 0) {
                const NoData = '<tr class="text-center"><td colspan="32" class="text-black-50"><strong>NO DATA ADDED</strong></td></tr>';
                $('#divAddPurchaseRejectionPopupDataGrid').html(NoData);
            }
            BasicItemGridTotal();
            BasicTotal();
        }

        function DeleteItemRow(itemCode, seq) {
            $.ajax({
                url: '@Url.Action("DeleteItemRow")',
                type: "POST",
                async: false,
                data: { "itemCode": itemCode, "Mode": $('#Mode').val(), "Seq":  seq},
                success: function (data, status, xhr) {
                    $('#divAddPurchaseRejectionList').html(data);

                    ClearDRCRGrid();
                    ClearAdjustmentGrid();

                    var rowCount = $('#divAddPurchaseRejectionList tr td').length;
                    ClearPopupItemGrid();
                    BasicTotal();
                    if (rowCount <= 1) {
                        $('#DiscountPer').val(0);
                        $('#DiscountPer').prop("readonly", false);
                        $('#DiscountAmt').val(0);
                        $('#DiscountAmt').prop("readonly", false);
                    }
                },
                error: function (response, status, xhr) {
                    alert(response.responseText);
                    $.notify(response.responseText, "error");
                },
                failure: function (response, status, xhr) {
                    alert(response.responseText);
                    $.notify(response.responseText, "error");
                }
            }).done(function () {
                GetTaxPartItem();
                GetDbCrDetail();
            });
        }

        $('#DA').change(function () {
            var showAllDoc = document.getElementById('DA').checked ? "T" : "F";
            FillDocument(showAllDoc);
        });

        function FillDocument(showAllDoc) {
            $.ajax({
                type: "POST",
                data: { "ShowAllDoc": showAllDoc },
                url: "@Url.Action("FillDocument", "PurchaseRejection")",
                dataType: "json",
                async: false,
                success: function (result, status, error) {
                    if (result != null) {
                        var obj = $.parseJSON(result);
                        if (obj.Result != null) {
                            $('#DocAccountCode').empty();
                            $('#DocAccountCode').append('<option value="0">-Select-</option>');
                            if (obj.StatusCode != 500) {
                                $.each(obj.Result.Table, function (index, val) {
                                    $('#DocAccountCode').append("<option value=" + val.Account_Code + ">" + val.Account_Name + "</option>");
                                });
                                if($('#Mode').val() == "U" || $('#Mode').val() == "V") {
                                    var hdnDocAccountCode= $('#hdnDocAccountCode').val();
                                }
                            }
                        }
                    }
                }
            });
        }

        function FillStore() {
            $.ajax({
                type: "POST",
                url: "@Url.Action("FillStore", "PurchaseRejection")",
                dataType: "json",
                success: function (result, status, error) {
                    if (result != null) {
                        var obj = $.parseJSON(result);
                        $('#StoreId').empty();
                        $('#StoreId').append('<option value="0">-Select-</option>');
                        if (obj.StatusCode != 500) {
                            $.each(obj.Result, function (index, val) {
                                $('#StoreId').append("<option value=" + val.StoreId + ">" + val.Store_Name + "</option>");
                            });
                        }
                    }
                }
            });
        }

        function ValidateSubmit() {
            if ($('#PaymentCreditDay').val() == '') {
                $.notify("Please enter payment Credit days..!", "error");
                return false;
            }
            return true;
        }

        $('#submitBTN,#submitBTNfooter,#UpdateButton').click(function (e) {

            e.preventDefault();

            if (!ValidateSubmit()) return;

            if ($('#divAddPurchaseRejectionList tr td').length <= 1) {
                $.notify('Purchase Rejection Grid Should Have Atleast 1 Item...!', "error");
            }
            else if ($('#divAdjItemList tr td').length <= 1) {
                $.notify('Adjust Grid Should Have Atleast 1 Item...!', "error");
            }
            else if ($('#divdbCrItemList tr td').length <= 1) {
                $.notify('DRCR Grid Should Have Atleast 1 Item...!', "error");
            }
            else if ($('#GSTRegistered').val() == 'Y') {
                if ($('#divTaxGrid tr td').length <= 1) {
                    $.notify('Tax Grid Should Have Atleast 1 Item...!', "error");
                } else {

                    $("form").submit();
                }
            }
            else {

                $("form").submit();
            }
        });

        $("#RejectedQty,#PRRate,#DiscountPer,#DiscountAmt,#AltQty,#NoOfCase").on("input", function (e) {
            var inputValue = $(this).val();

            inputValue = inputValue.replace(/[^0-9.]/g, '');

            var dotCount = inputValue.split('.').length - 1;
            if (dotCount > 1) {
                inputValue = inputValue.slice(0, -1);
            }
            $(this).val(inputValue);
        });

        function FillCustomerDetails() {
            $.ajax({
                type: "POST",
                data: { "Code": $('#AccountCode').val() },
                url: "@Url.Action("GetStateGST", "PurchaseRejection")",
                dataType: "json",
                async: false,
                success: function (result, status, error) {
                    if (result != null) {
                        var obj = $.parseJSON(result);
                        if (obj.Result != null) {//GSTRegistered, GSTType
                            $('#CustVendAddress').empty();
                            $('#CustVendAddress').val(obj.Result.Table[0].Address);
                            $('#GSTNO').empty();
                            $('#GSTNO').val(obj.Result.Table[0].GSTNO);
                            $('#GSTType').empty();
                            $('#GSTType').val(obj.Result.Table[0].GSTType);
                            $('#GSTRegistered').empty();
                            $('#GSTRegistered').val(obj.Result.Table[0].GSTRegistered);
                            $('#StateCode').empty();
                            $('#StateCode').val(obj.Result.Table[0].StateCode);
                            $('#StateNameofSupply').empty();
                            $('#StateNameofSupply').val(obj.Result.Table[0].StateName);
                            $('#CityofSupply').empty();
                            $('#CityofSupply').val(obj.Result.Table[0].City);
                            $('#CountryOfSupply').empty();
                            $('#CountryOfSupply').val(obj.Result.Table[0].Country);
                            $('#PaymentCreditDay').empty();
                            $('#PaymentCreditDay').val(obj.Result.Table[0].PaymentCreditDays);
                        }
                    }
                }
            });
        }

        $('#AccountCode').change(function () {
            FillItems($('#ItemSA').is(':checked'));
            FillCustomerDetails();
            FillCurrency();
        });

        function FillPurchaseRejectionPopUp() {
            var showAllBill = $('#ShowAllBill').is(':checked') ? 'Y' : 'N';
            var DebitNotePurchaseRejection = $('#DebitNotePurchaseRejection').val();
            $.ajax({
                type: "POST",
                url: "@Url.Action("FillPurchaseRejectionPopUp")",
                data: { "DebitNotePurchaseRejection": DebitNotePurchaseRejection, "fromBillDate": $('#fromBillDate').val(), "toBillDate": $('#toBillDate').val(), "itemCode": $('#ItemCode').val(), "accountCode": $('#AccountCode').val(), "yearCode": $('#PurchaseRejYearCode').val(), "showAllBill": showAllBill },
                dataType: "json",
                async: false,
                success: function (result, status, error) {
                    if (result != null) {
                        var obj = $.parseJSON(result);
                        var i = 1;
                        if (obj.Result != null) {
                            var html = '';
                            $('#divPurchaseRejectionDataGrid').empty();
                            $.each(obj.Result.Table, function (index, val) {
                                // var saleBillDate = val.SaleBillDate == null ? "" : val.SaleBillDate.split("T")[0];
                                var invoiceDate = val.InvoiceDate == null ? "" : val.InvoiceDate.split("T")[0];
                                var dueDate = val.DueDate == null ? "" : val.DueDate.split("T")[0];
                                // var soDate = val.SOdate == null ? "" : val.SOdate.split("T")[0];
                                // var poDate = val.PODate == null ? "" : val.PODate.split("T")[0];

                                html += '<tr id="PRPopUpRow-' + i + '" style="font-size: 12px;">' +
                                    '<td><input type="checkBox" id="chkPurchaseRejection-' + i + '" value="' + i + '" onchange="BasicPopUpItemGrid()"/></td>' +
                                    '<td>' + i + '</td>' +
                                    '<td id="PurchBillEntryId-' + i + '">' + val.PurchBillEntryId + ' <input type="hidden" id="itemCode-' + i + '" value="' + val.ItemCode + '"/></td>' +
                                    '<td id="PurchBillYearCode-' + i + '">' + val.PurchBillYearCode + '</td>' +
                                    '<td id="InvoiceNo-' + i + '">' + val.InvoiceNo + '</td>' +
                                    '<td id="InvoiceDate-' + i + '">' + invoiceDate + '</td>' +
                                    '<td id="ItemName-' + i + '">' + val.item_Name + '</td>' +
                                    '<td id="PartCode-' + i + '">' + val.PartCode + '</td>' +
                                    '<td id="INVNetAmt-' + i + '">' + val.INVNetAmt + '</td>' +
                                    '<td id="DueDate-' + i + '">' +dueDate + '</td>' +
                                    '<td id="PaidAmt-' + i + '">' + val.PaidAmt + '</td>' +
                                    '<td id="RemainingAmt-' + i + '">' + val.RemainingAmt + '</td>' +
                                     '<td id="BillQty-' + i + '">' + val.BillQty + '</td>' +
                                     '<td id="BillRate-' + i + '">' + val.BillRate + '</td>' +
                                     '<td id="ItemAmount-' + i + '">' + val.ItemAmount + '</td>' +
                                     '<td id="disPer-' + i + '">' + val.disPer + '</td>' +
                                     '<td id="DisAmt-' + i + '">' + val.DisAmt + '</td>' +
                                    '</tr>';
                                i++;
                            });
                        } else {
                            html += '<tr id="Row-' + i + '">' +
                                '<td colspan="10" class="text-black-50 text-center"><strong class="text-danger">NO DATA ADDED</strong></td>' +
                                '</tr>';
                        }
                        $('#divPurchaseRejectionDataGrid').append(html);

                        if (EditEachItem) {
                            var popUpGrid = purchaseRejectionPopupGrid.length;
                            for (var j = 0; j < popUpGrid; j++) {
                                $('#chkPurchaseRejection-' + purchaseRejectionPopupGrid[j].CheckBoxNo).prop("checked", true);
                            }
                        }

                        if ($('#AgainstSalePurchase').val() == 'SALE') {
                            $('.hnPOfields').hide();
                            $('.hnSOfields').show();

                        } else {
                            $('.hnSOfields').hide();
                            $('.hnPOfields').show();
                        }
                    }
                }
            });
        }

        $('#ShowAllBill').change(function () {
            FillPurchaseRejectionPopUp();
        });

        function CalculateItemAmount() {
            var prRate = $('#PRRate').val() != '' ? parseFloat($('#PRRate').val()) : 0;
            var rejQty = $('#RejectedQty').val() != '' ? parseFloat($('#RejectedQty').val()) : 0;
            if (rejQty == 0) {
                $('#ItemAmount').val(prRate);
            } else {
                $('#ItemAmount').val(prRate * rejQty);
            }
            onDiscountChange();
        }

        function FillItemsRelatedDetails() {
            $.ajax({
                type: "POST",
                data: { "itemCode": $('#ItemCode').val() },
                url: "@Url.Action("GetHSNUNIT")",
                dataType: "json",
                async: false,
                success: function (result, status, error) {
                    if (result != null) {
                        var obj = $.parseJSON(result);
                        if (obj.Result != null) {
                            $('#Unit').val("");
                            $('#Unit').val(obj.Result.Table[0]?.Unit);
                            $('#AltUnit').val("");
                            $('#AltUnit').val(obj.Result.Table[0]?.AlternateUnit);
                            $('#HSNNo').val("");
                            $('#HSNNo').val(obj.Result.Table[0]?.HsnNo);
                        }
                    }
                }
            });
        }
        var billQty = 0;
        var billRate = 0;
        var popupbillQty = 0;
        var popupbillRate = 0;
        var html = '';
        var popUpItems = [];
        function FillDetailFromPopupGrid(e) {
            let data = [];
            e.preventDefault();
            let rowCount = $('#divPurchaseRejectionDataGrid tr').length;
            for (let i = 1; i <= rowCount; i++) {
                let row = $('#PRPopUpRow-' + i);
                if (row.length === 0) continue;
                if ($('#chkPurchaseRejection-' + i).is(':checked')) {
                    let dataObj = {
                        "CheckBoxNo": $('#chkPurchaseRejection-' + i).val(),
                        "PurchaseRejectionInvoiceNo": $('#PurchaseRejectionInvoiceNo').val() || "",
                        "InvoiceNo": row.find('#InvoiceNo-' + i).text(),
                        "PurchaseRejectionVoucherNo": $('#PurchaseRejectionVoucherNo').val() || "",
                        "AgainstPurchaseBillBillNo": "",
                        "AgainstPurchaseBillYearCode": row.find('#PurchBillYearCode-' + i).text() || "",
                        "AgainstPurchaseBillDate": "",
                        "AgainstPurchaseBillEntryId": row.find('#PurchBillEntryId-' + i).text() || "",
                        "AgainstPurchaseVoucherNo": "",
                        "PurchaseBillType": "",
                        "ItemCode": $('#ItemCode').val() || "",
                        "PartCode": $('#PartCode').find(':selected').text() !== '-Select-' ? $('#PartCode').find(':selected').text() : "",
                        "ItemName": $('#ItemName').find(':selected').text() !== '-Select-' ? $('#ItemName').find(':selected').text() : "",
                        "BillQty": row.find('#BillQty-' + i).text() || "",
                        "Unit": $('#Unit').val() || "",
                        "BillRate": row.find('#BillRate-' + i).text() || "",
                        "DiscountPer": row.find('#disPer-' + i).text() || "",
                        "DiscountAmt": row.find('#DisAmt-' + i).text() || "",
                        "ItemSize": $('#ItemSize').val() || "",
                        "Amount": $('#ItemAmount-' + i).val() || "",
                        "PONO": row.find('#pono-' + i).text() || "",
                        "PODate": row.find('#poDate-' + i).text() || "",
                        "POEntryId": row.find('#poEntryId-' + i).text() || "",
                        "POYearCode": row.find('#poYearCode-' + i).text() || "",
                        "PoRate": 0,
                        "PoAmmNo": "",
                        "BatchNo": "",
                        "UniqueBatchNo": "",
                        "AltQty": 0,
                        "AltUnit": ""
                    };
                    data.push(dataObj);
                }
            }
            $.ajax({
                type: "POST",
                data: { "model": data, "itemCode": $('#ItemCode').val(), "popCt": 1 },
                url: "@Url.Action("FillDetailFromPopupGrid")",
                dataType: "json",
                async: false,
                success: function (result, status, error) {
                    if (result != null) {
                        var obj = $.parseJSON(result);
                        var rowCount = $('#divAddPurchaseRejectionList tr').length;
                        for (var i = 1; i <= rowCount; i++) {
                            $('#discAmt-' + i).text((obj.Result[i - 1] == null || obj.Result[i - 1] == undefined || obj.Result[i - 1].DiscountAmt == null) ? 0 : (obj.Result[i - 1].DiscountAmt).toFixed(2));
                            $('#billQty-' + i).text((obj.Result[i - 1] == null || obj.Result[i - 1] == undefined || obj.Result[i - 1].BillQty == null) ? 0 : (obj.Result[i - 1].BillQty).toFixed(2));
                            $('#discPer-' + i).text((obj.Result[i - 1] == null || obj.Result[i - 1] == undefined || obj.Result[i - 1].DiscountPer == null) ? 0 : (obj.Result[i - 1].DiscountPer).toFixed(2));
                            $('#billRate-' + i).text((obj.Result[i - 1] == null || obj.Result[i - 1] == undefined || obj.Result[i - 1].BillRate == null) ? 0 : (obj.Result[i - 1].BillRate).toFixed(2));
                        }
                        if (obj.Result != null) {
                            let existingRowCount = $('#divAddPurchaseRejectionPopupDataGrid tr').length;
                            var j = existingRowCount > 0 ? existingRowCount : 0;
                            var checkedRowsCount = $('#divPurchaseRejectionDataGrid tr').length;
                            /* if(html == null) { */
                                popUpItems = [];
                            /* } */
                            if (html != null) {
                                $('#divAddPurchaseRejectionPopupDataGrid').find('tr').each(function (index) {
                                    const i = index + 1;
                                    const $row = $(this);
                                    const entryId   = ($row.find('#popUpPurchBillEntryId-' + i).text() || '').trim();
                                    const yearCode  = ($row.find('#popUpPurchBillYearCode-' + i).text() || '').trim();
                                    const invoiceNo = ($row.find('#popUpInvoiceNo-' + i).text() || '').trim();
                                    const itemCode  = ($row.find('#popupItemCode-' + i).val() || '').trim();
                                    if (entryId && yearCode && invoiceNo && itemCode) {
                                        const uniqueKey = entryId + '_' + yearCode + '_' + invoiceNo + '_' + itemCode;
                                        popUpItems.push({
                                            key: $('#DocAccountCode').val() + '_' + $('#ItemCode').val(),
                                            value: uniqueKey
                                        });
                                    }
                                });
                            }
                            for (var i = 1; i <= checkedRowsCount; i++) {/*  && popUpItems.indexOf($('#itemCode-' + j).val()) == -1 */
                                if ($('#chkPurchaseRejection-' + i).is(':checked'))   {
                                    let entryId   = ($('#PurchBillEntryId-' + i).text() || '').trim();
                                    let yearCode  = ($('#PurchBillYearCode-' + i).text() || '').trim();
                                    let invoiceNo = ($('#InvoiceNo-' + i).text() || '').trim();
                                    let itemCode = $('#itemCode-' + i).val();
                                    let uniqueKey = entryId + '_' + yearCode + '_' + invoiceNo + '_' + itemCode;
                                    let keyToCheck = $('#DocAccountCode').val() + '_' + $('#ItemCode').val();
                                    let exists = popUpItems.some(x => x.key === keyToCheck && x.value === uniqueKey);
                                    if (uniqueKey) {
                                        if (!exists) {
                                            j++;
                                            popUpItems.push({key: $('#DocAccountCode').val() + '_' + $('#ItemCode').val(), value: uniqueKey});
                                            //popUpItems.push($('#itemCode-' + j).val());
                                            html += '<tr id="PRPopUpDataRow-' + j + '" style="font-size: 12px;">' +
                                                '<td>' + j + '</td>' +
                                                '<td id="partCode-' + j + '">' + $('#PartCode').find(':selected').text() + '<input type="hidden" id="popupItemCode-' + j + '" value="' + $('#itemCode-' + i).val() + '"/></td>' +
                                                '<td id="popUpItemCodeName-' + j + '"> ' + $('#ItemCode').find(':selected').text() + '</td>' +
                                                '<td id="popUpPurchBillEntryId-' + j + '">' + $('#PurchBillEntryId-' + i).text() + '</td>' +
                                                '<td id="popUpPurchBillYearCode-' + j + '">' + $('#PurchBillYearCode-' + i).text() + '</td>' +
                                                '<td id="popUpInvoiceNo-' + j + '">' + $('#InvoiceNo-' + i).text() + '</td>' +
                                                '<td id="popUpInvoiceDate-' + j + '">' + $('#InvoiceDate-' + i).text() + '</td>' +
                                                '<td id="popUpItemName-' + j + '">' + $('#ItemName-' + i).text() + '</td>' +
                                                '<td id="popUpPartCode-' + j + '">' + $('#PartCode-' + i).text() + '</td>' +
                                                '<td id="popUpINVNetAmt-' + j + '">' + $('#INVNetAmt-' + i).text() + '</td>' +
                                                '<td id="popUpDueDate-' + j + '">' + $('#DueDate-' + i).text() + '</td>' +
                                                '<td id="popUpPaidAmt-' + j + '">' + $('#PaidAmt-' + i).text() + '</td>' +
                                                '<td id="popUpRemainingAmt-' + j + '">' + $('#RemainingAmt-' + i).text() + '</td>' +
                                                '<td id="popUpBillQty-' + j + '">' + $('#BillQty-' + i).text() + '</td>' +
                                                '<td id="popUpBillRate-' + j + '">' + $('#BillRate-' + i).text() + '</td>' +
                                                '<td id="popUpItemAmount-' + j + '">' + $('#ItemAmount-' + i).text() + '</td>' +
                                                '<td id="popUpdisPer-' + j + '">' + $('#disPer-' + i).text() + '</td>' +
                                                '<td id="popUpDisAmt-' + j + '">' + $('#DisAmt-' + i).text() + '</td>' +
                                                '</tr>';
                                        }
                                    }
                                    billQty += ($('#BillQty-' + i).text() == '' ? 0 : parseFloat($('#BillQty-' + i).text()));
                                    billRate += ($('#BillRate-' + i).text() == '' ? 0 : parseFloat($('#BillRate-' + i).text()));
                                }
                            }
                            $('#addPurchaseRejectionPopupModel').modal("hide");
                        } else {
                            html += '<tr id="Row-' + i + '">' +
                                '<td colspan="10" class="text-black-50 text-center"><strong class="text-danger">NO DATA ADDED</strong></td>' +
                                '</tr>';
                        }
                        // $('#divAddPurchaseRejectionPopupDataGrid').append(html);

                        $('#BillQty').val(billQty.toFixed(2));
                        $('#BillRate').val(billRate.toFixed(2));

                        $('#RejectedQty').val($('#BillQty').val());
                        $('#PRRate').val($('#BillRate').val());
                        CalculateItemAmount();

                        BasicTotal();
                    }
                }

            });
        }

        $('#CheckAll').click(function () {
            $('#divPurchaseRejectionDataGrid tr:visible').each(function () {
                var checkbox = $(this).find('input[type="checkbox"]');
                checkbox.prop("checked", !checkbox.prop("checked"));
            });
            BasicPopUpItemGrid();
        });

        let previousValue = document.getElementById('NetTotal').value;

        function checkNetTotalChange() {
            const netTotalInput = document.getElementById('NetTotal');
            const currentValue = netTotalInput.value;

            if (currentValue !== previousValue) {
                previousValue = currentValue;

                const netTotalValue = parseFloat(currentValue);
                onNetTotalChange();
            }
        }

        function ValidateGrid() {

            var Err = 0;

            if ($('#PartCode').prop('selectedIndex') == 0) {
                AddErrorCls('PartCode');
                $.notify('please select ItemName...!', "error");
                Err = 1;
            }
            else {
                RemoveErrorCls('PartCode');
            }

            if ($('#Batchno').prop('selectedIndex') == 0) {
                AddErrorCls('Batchno');
                $.notify('please select Batchno...!', "error");
                Err = 1;
            }
            else {
                RemoveErrorCls('Batchno');
            }

            if ($('#Uniquebatchno').prop('selectedIndex') == 0) {
                AddErrorCls('Uniquebatchno');
                $.notify('please select Uniquebatchno...!', "error");
                Err = 1;
            }
            else {
                RemoveErrorCls('Uniquebatchno');
            }

            if ($('#DocAccountCode').prop('selectedIndex') == 0) {
                AddErrorCls('DocAccountCode');
                $.notify('please select Doc Head...!', "error");
                Err = 1;
            }
            else {
                RemoveErrorCls('DocAccountCode');
            }

            if ($('#DocAccountCode').val() == 0) {
                AddErrorCls('DocAccountCode');
                $.notify('please select Doc Account Name...!', "error");
                Err = 1;
            }
            else {
                RemoveErrorCls('DocAccountCode');
            }

            if ($('#ItemAmount').val() == 0) {
                AddErrorCls('ItemAmount');
                $.notify('please add Item Amount...!', "error");
                Err = 1;
            }
            else {
                RemoveErrorCls('ItemAmount');
            }

            if ($('#BillQty').val() == null) {
                AddErrorCls('BillQty');
                $.notify('please add Bill Qty...!', "error");
                Err = 1;
            }
            else {
                RemoveErrorCls('BillQty');
            }

            if ($('#RejectedQty').val() == null) {
                AddErrorCls('RejectedQty');
                $.notify('please add Rejected Qty...!', "error");
                Err = 1;
            }
            else {
                RemoveErrorCls('RejectedQty');
            }

            if ($('#LotStock').val() == null) {
                AddErrorCls('LotStock');
                $.notify('please add Lot Stock...!', "error");
                Err = 1;
            }
            else {
                RemoveErrorCls('LotStock');
            }

            if ($('#TotalStock').val() == null) {
                AddErrorCls('TotalStock');
                $.notify('please add Total Stock...!', "error");
                Err = 1;
            }
            else {
                RemoveErrorCls('TotalStock');
            }

            if ($('#BillQty').val() != null && $('#RejectedQty').val() != null && $('#LotStock').val() != null && $('#TotalStock').val() != null && (parseFloat($('#BillQty').val()) < parseFloat($('#RejectedQty').val()))
            || (parseFloat($('#LotStock').val()) < parseFloat($('#RejectedQty').val()))
            || (parseFloat($('#TotalStock').val()) < parseFloat($('#RejectedQty').val()))) {
                AddErrorCls('RejectedQty');
                $.notify('Rej Qty can not greter then billQty or LotStock or TotalStock...!', "error");
                Err = 1;
            }
            else {
                RemoveErrorCls('RejectedQty');
            }

             var error = false;
             var rowcount = $('#divaddpurchaserejectionpopupdatagrid tr').length;
             //var rowcount = popupitems.length;
             for (var i = 0; i < rowcount; i++) {
                 if ($('#itemcode').val() != popupitems[i]) {
                     error = true;
                     err = 1;
                     break;
                 } else {
                     error = false;
                 }
             }

             if (error) {
                 $.notify('cannot add item which is not in popup data grid...!', "error");
             }

            Err == 1 ? ShowErrorFld('H_Panel2') : HideErrorFld('H_Panel2');
            if (Err == 1) return false;

            return true;
        }

        var sum = 0;
        $('.ItemBtn').click(function (e) {
            AddToItemsGrid(e);
            if (isAddItem) {
                $('#divAddPurchaseRejectionPopupDataGrid').empty();
                $('#divAddPurchaseRejectionPopupDataGrid').append(html);
            }
            BasicTotal();
        });
        
        $('#AddPopDataInGrid').click(function (e) {
            FillDetailFromPopupGrid(e);
        });
        var isAddItem = false;
        function AddToItemsGrid(e) {
            e.preventDefault();
            EditEachItem = false;
            if (ValidateGrid()) {
                let matchKey = $('#DocAccountCode').val() + '_' + $('#ItemCode').val();
                let matchingItems = popUpItems.filter(x => x.key === matchKey);
                let lastMatch = '';
                if (matchingItems.length > 0) {
                lastMatch = matchingItems[matchingItems.length - 1];
            }
                var purchaseRejectionData = {
                "PartCode": $('#PartCode').find(':selected').text() == "-Select-" ? "" : $('#PartCode').find(':selected').text(),
                "ItemName": $('#ItemCode').find(':selected').text() == "-Select-" ? "" : $('#ItemCode').find(':selected').text(),
                "DocAccountName": $('#DocAccountCode').find(':selected').text() == "-Select-" ? "" : $('#DocAccountCode').find(':selected').text(),
                "DocAccountCode": $('#DocAccountCode').val(),
                "HSNNo": $('#HSNNo').val(),
                "ItemCode": $('#ItemCode').val(),
                "hdnuniquekey": lastMatch.value,
                "BillQty": $('#BillQty').val(),
                "RejectedQty": $('#RejectedQty').val(),
                "Unit": $('#Unit').val(),
                "AltQty": $('#AltQty').val(),
                "AltUnit": $('#AltUnit').val(),
                "PRRate": $('#PRRate').val(),
                "BillRate": $('#BillRate').val(),
                "UnitRate": $('#UnitRate').val(),
                "AltRate": $('#AltRate').val(),
                "NoOfCase": $('#NoOfCase').val(),
                "CostCenterId": $('#CostCenterId').val(),
                "ItemAmount": $('#ItemAmount').val(),
                "Amount": $('#ItemAmount').val(),
                "DiscountPer": $('#DiscountPer').val(),
                "DiscountAmt": $('#DiscountAmt').val(),
                "StoreId": $('#StoreId').val(),
                "StoreName": $('#StoreId').find(':selected').text() == "-Select-" ? "" : $('#StoreId').find(':selected').text(),
                /* "Batchno": $('#Batchno').val(),
                "Uniquebatchno": $('#Uniquebatchno').val(), */
                    "Batchno": $('#Batchno').find(':selected').text().trim(),
                    "Uniquebatchno": $('#Uniquebatchno').find(':selected').text().trim(),
                "LotStock": $('#LotStock').val(),
                "TotalStock": $('#TotalStock').val(),
                "ItemSize": $('#ItemSize').val(),
                "ItemDescription": $('#ItemDescription').val(),
                "Remark": $('#Remark').val(),
                "MIRNo": $('#MIRNo').val(),
                "MIREntryID": $('#MIREntryID').val(),
                "MIRYearCode": $('#MIRYearCode').val(),
                "MIRDate": $('#MIRDate').val(),
                "InprocessNo": $('#InprocessNo').val(),
                "InprocessEntryID": $('#InprocessEntryID').val(),
                "InprocessYearCode": $('#InprocessYearCode').val(),
                "InprocessDate": $('#InprocessDate').val()
            }

                $.ajax({
                type: "POST",
                url: '@Url.Action("AddPurchaseRejectionDetail")',
                data: purchaseRejectionData,
                async: false,
                statusCode: {
                    207: function () {
                        $.notify('Duplicate Item...!', "info");
                    }
                },
                success: function (result, status, xhr) {
                    if (xhr.status == 200 && xhr.responseText == result) {
                        isAddItem = true;
                        $('#divAddPurchaseRejectionList').html(result);
                        $('#PartCode,#ItemCode').val(0).trigger("change");
                        $('#Uniquebatchno,#Batchno,#Qty').val(0);
                        $('#LotStock,#TotalStock').val("");
                        $('#HSNNo').val("");
                        $('#Unit,#AltUnit').val("");
                        $('#TotalStock,#LotStock,#AltQty,#ActualStockQty,#AdjQty,#Rate,#Amount').val(0);
                        BasicItemGridTotal();

                        //$('#Storeid,#Wcid').prop("disabled", false);

                        if ($('#DiscountPer').val() != 0 && $('#DiscountPer').val() != '0' && $('#DiscountPer').val() != '' && $('#DiscountPer').val() != undefined) {
                            $('#DiscountPer').prop("readonly", "true");
                        }

                        if ($('#DiscountAmt').val() != 0 && $('#DiscountAmt').val() != '0' && $('#DiscountAmt').val() != '' && $('#DiscountAmt').val() != undefined) {
                            $('#DiscountAmt').prop("readonly", "true");
                        }

                        $('#SONO').focus();
                        ClearAdjustmentGrid();
                        var rowCount = $('#divAddPurchaseRejectionList tr').length;
                        sum = 0;
                        for (var i = 1; i <= rowCount; i++) {

                            sum += parseFloat($('#gridAmount-' + i).text() == '.00' ? 0 : $('#gridAmount-' + i).text());
                        }

                        $('#ItemNetAmount').val(sum);

                        // $('#lblItemNetAmount').text(sum.toFixed(2));

                        var txSum = 0;
                        var taxRowCount = $('#divTaxGrid tr').length;
                        if ($('#divTaxGrid tr td').length > 1) {
                            for (var i = 1; i <= taxRowCount; i++) {
                                txSum += parseFloat($('#txGridAmount-' + i).text() == '.00' ? 0 : $('#txGridAmount-' + i).text());
                            }
                        }

                        var txTotal = sum + txSum;

                        $('#NetTotal').val(txTotal.toFixed(2));
                        $('#AdjPendAmt').val($('#NetTotal').val());

                        DueDateCalculation();
                        ClearAdjustmentGrid();
                        // $('#TotalDiscountPercentage').val(0);
                        // $('#TotalAmtAftrDiscount').val(0);

                        //var rowCount = $('#divAddPurchaseRejectionList tr').length;
                         //for (var i = 1; i <= rowCount; i++) {
                        //    var itemCodee = parseInt($('#GridIC-' + i).val());
                        //    var batchNoo = $('#GridBatchNo-' + i).text();
                        //    var uniquebatchnoo = $('#GridUniqueBatchNo-' + i).text();
                        //    var Seqno = $('#SeqNo-' + i).val();
                        //    itemBatchArray.push({
                        //        "SeqNo": parseInt(Seqno),
                        //        "itemcode": itemCodee,
                         //         "batchno": batchNoo,
                         //         "uniquebatchno": uniquebatchnoo
                        //    });
                        //}
                    }
                },
                error: function (result, status, xhr) {
                    $.notify('Something Went Wrong, Please Try Again.', "error");
                }
            }).done(function () {
                    GetTaxPartItem();
                    GetDbCrDetail();
                }).fail(function () {
                    alert("error");
                }).always(function () {
                });
            }
        }

        function DueDateCalculation() {
            var dueDate = $('#AdjDueDate').val();
            // var SaleBillDate = new Date($('#SaleBillDate').val());

            var dateStr = parseDateToFormat($('#PurchaseRejectionInvoiceDate').val().split(" ")[0]);
            var [day, month, year] = dateStr.split('/').map(Number);
            var SaleBillDate = new Date(year, month - 1, day);

            var creaditDays = $('#PaymentCreditDay').val() == "" ? 0 : parseInt($('#PaymentCreditDay').val(), 10);

            SaleBillDate.setDate(SaleBillDate.getDate() + creaditDays);

            var formattedDueDate = $.datepicker.formatDate('dd/mm/yy', SaleBillDate);
            $('#AdjDueDate').datepicker({ dateFormat: 'dd/mm/yy' }).datepicker("setDate", formattedDueDate);
            $('#AdjDueDate').datepicker("option", "minDate", ($('#PurchaseRejectionInvoiceDate').val()).split(" ")[0]);
        }

        $('#PaymentCreditDay').change(function () {
            $('#divAdjItemList').empty();
            var NoData = '<tr class="text-center"><td colspan="32" class="text-black-50"><strong>NO DATA ADDED</strong></td></tr>';
            $('#divAdjItemList').html(NoData);
            CalculateAdjAmt('NetTotal');
            DueDateCalculation();
        });


        function BasicPopUpItemGrid() {
            var columnCount = $('#divPurchaseRejectionDataGrid tr td').length;
            var invAmount = 0;
            var totalBillQty = 0;
            //noofitems
            var checkedRowCount = $('#divPurchaseRejectionDataGrid tr input[type="checkbox"]:checked').length;

            if (columnCount > 1)
                $('#lblPopupItemGridCount').text(checkedRowCount);
            else
                $('#lblPopupItemGridCount').text(0);


            var rowCount = $('#divPurchaseRejectionDataGrid tr').length;
            for (var i = 1; i <= rowCount; i++) {
                if ($('#chkPurchaseRejection-' + i).is(':checked')) {
                    invAmount += parseFloat($('#INVNetAmt-' + i).text() == '.00' ? 0 : $('#INVNetAmt-' + i).text());
                    totalBillQty += parseFloat($('#BillQty-' + i).text() == '.00' ? 0 : $('#BillQty-' + i).text());
                }
            }

            $('#lblItemPopupNetInvAmount').text(invAmount.toFixed(2));
            $('#lblItemPopupTotalBillQty').text(totalBillQty.toFixed(2));
        }

        function BasicTotal() {
            var columnCount = $('#divAddPurchaseRejectionPopupDataGrid tr td').length;
            //var taxRowCount = $('#divTaxGrid tr').length;
            sum = 0;
            var rowCount = $('#divAddPurchaseRejectionPopupDataGrid tr').length;
            //noofitems
            if (columnCount > 1)
                $('#lblItemCount').text(rowCount);
            else
                $('#lblItemCount').text(0);
            for (var i = 1; i <= rowCount; i++) {
                sum += parseFloat($('#popUpItemAmount-' + i).text() == '.00' ? 0 : $('#popUpItemAmount-' + i).text());
            }

            $('#lblItemNetAmount').text(sum.toFixed(2));
        }

        function onDiscountChange(){
              const DP = $('#DiscountPer') === "0" || $('#DiscountPer').val() === "" ? 0 : parseFloat($('#DiscountPer').val());
              var PRRate = $('#PRRate').val() === "0" || $('#PRRate').val() === "" ? 0 : parseFloat($('#PRRate').val());
              var Amount = $('#ItemAmount').val() === "0" || $('#ItemAmount').val() === "" ? 0 : parseFloat($('#ItemAmount').val());
              const RejectedQty = $('#RejectedQty').val() == "0" || $('#RejectedQty').val() === "" ? 0 : parseInt($('#RejectedQty').val());

               if (RejectedQty > 0 && PRRate > 0) {
                Amount = RejectedQty * PRRate;
            }
            else {
                Amount;
            }

            if (DP !== 0) {
                const DA = ((Amount * DP) / 100);
                $('#DiscountAmt').val(DA.toFixed(2));
                Amount = Amount - DA;
            }
            //$('#ItemAmount').val(Amount.toFixed(2))
        }

        function BasicItemGridTotal() {
            var columnCount = $('#divAddPurchaseRejectionList tr td').length;
            sum = 0;
            var rowCount = $('#divAddPurchaseRejectionList tr').length;
            //noofitems

            if (columnCount > 1)
                $('#lblItemGridCount').text(rowCount);
            else
                $('#lblItemGridCount').text(0);
            for (var i = 1; i <= rowCount; i++) {
                sum += parseFloat($('#gridAmount-' + i).text() == '.00' ? 0 : $('#gridAmount-' + i).text());
            }

            $('#lblItemGridNetAmount').text(sum.toFixed(2));
            $('#NetAmt').val(sum.toFixed(2));
        }

        async function GetTaxPartItem() {
            $.ajax({
                type: "GET",
                url: '@Url.Action("GetTaxPartItem", "Tax")',
                data: { SessionName: "PurchaseRejection", Mode: $('#Mode').val() },
                dataType: "json",
                success: await function (data, status, error) {

                    $('#TxPartCode').empty();
                    $('#TxPartCode').append('<option>-Select-</option>');
                    var PartCode = 0;
                    var arrayPartCode = [];
                    $.each(data.partCode, function (key, val) {
                        if (arrayPartCode.includes(val.text)) {
                            //do nothing
                        }
                        else {
                            $('#TxPartCode').append('<option value="' + val.value + '">' + val.text + '</option>');
                            arrayPartCode.push(val.text);
                        }
                    });
                    $("[id='TxItemCode']").empty();
                    $("[id='TxItemCode']").append('<option>-Select-</option>');
                    var ItemText = 0;
                    var arrayitemCode = [];
                    $.each(data.itemCode, function (key, val) {
                        if (arrayitemCode.includes(val.text)) {
                            //do nothing
                        }
                        else {
                            $("[id='TxItemCode']").append('<option value="' + val.value + '">' + val.text + '</option>');
                            arrayitemCode.push(val.text);
                        }

                    });
                },
                error: function (req, status, error) {
                    alert(error);
                }
            });
        }

        // $('#AgainstSalePurchase').change(function () {
        //     FillCustomerName();
        // }); by M

        $('#DebitNotePurchaseRejection').change(function () {
            FillCustomerName();
            FillSubvoucher();
        });

        $('#DiscountAmt' ).change(function () {
            onDiscountChange();
        });

        $('#DiscountPer' ).change(function () {
            onDiscountChange();
        });

        $('#SA').change(function () {
            var showAllParty = document.getElementById('SA').checked ? "Y" : "N";
            FillCustomerName(showAllParty);
        });
        function FillCustomerName(showAllParty) {
            // var againstSalePurchase = $('#AgainstSalePurchase').val();
            var DebitNotePurchaseRejection = $('#DebitNotePurchaseRejection').val();
            $.ajax({
                type: "POST",
                url: "@Url.Action("FillCustomerName")",
                data: { "ShowAllParty": showAllParty, "PurchaseRejYearCode": $('#PurchaseRejYearCode').val(), "DebitNotePurchaseRejection": DebitNotePurchaseRejection },
                dataType: "json",
                async: false,
                success: function (result, status, error) {
                    if (result != null) {
                        var obj = $.parseJSON(result);
                        if (obj.Result != null) {
                            $('#AccountCode').empty();
                            $('#AccountCode').append('<option value="0">-Select-</option>');
                            if (obj.StatusCode != 500) {
                                $.each(obj.Result.Table, function (index, val) {
                                    $('#AccountCode').append("<option value=" + val.account_code + ">" + val.account_name/* val.CustomerName */ + "</option>");
                                });
                            }
                            if ($('#Mode').val() == "U" || $('#Mode').val() == "V") {
                               $('#AccountCode').val('@Model.AccountCode');
                            }
                        }
                    }
                }
            });
        }
        function FillSubvoucher() {
            var DebitNotePurchaseRejection = $('#DebitNotePurchaseRejection').val();
            $.ajax({
                type: "POST",
                url: "@Url.Action("FillSubvoucher")",
                data: { "PurchaseRejYearCode": $('#PurchaseRejYearCode').val(), "DebitNotePurchaseRejection": DebitNotePurchaseRejection },
                dataType: "json",
                async: false,
                success: function (result, status, error) {
                    if (result != null) {
                        var obj = $.parseJSON(result);
                        if (obj.Result != null) {
                            $('#SubVoucherName').empty();
                            $('#SubVoucherName').append('<option value="0">-Select-</option>');
                            if (obj.StatusCode != 500) {
                                $.each(obj.Result.Table, function (index, val) {
                                    $('#SubVoucherName').append("<option value=" + val.PrefixEntryId + ">" + val.SubVoucherName/* val.CustomerName */ + "</option>");
                                });
                            }
                            if ($('#Mode').val() == "U" || $('#Mode').val() == "V") {
                               $('#SubVoucherName').val('@Model.SubVoucherName');
                            }
                        }
                    }
                }
            });
        }

        function FillCurrency() {
            $.ajax({
                type: "GET",
                url: "@Url.Action("FillCurrency")",
                async: false,
                dataType: "json",
                data: { AccountCode: $('#AccountCode').val() },
                success: function (result, status, error) {
                    if (result != null) {
                        var obj = $.parseJSON(result);
                        $.each(obj.Result.Table, function (index, val) {
                            $('#Currency').val(val.Currency);
                            $('#CurrencyId').val(val.entry_id);
                            $('#DomesticExportNEPZ').val(val.DomExport);
                            GetExchnageRate();
                            return false;
                        });
                    }
                }
            });
        }
        function GetExchnageRate() {
            $.ajax({
                type: "POST",
                url: "@Url.Action("GetExchangeRate")",
                data: { Currency: $('#Currency').val() },
                async: false,
                dataType: "json",
                success: function (data, status, error) {
                    var obj = $.parseJSON(data);
                    if (obj != null && obj.Result != null && obj.Result.length > 0) {
                        var rate = obj.Result[0].IndianValue;
                        rate = rate != null && rate != undefined ? rate : 1;
                        $('#ExchangeRate').val(rate);
                        // otherratecurr = $('#OtherRateCurr').val() != null && $('#OtherRateCurr').val() != undefined ? $('#OtherRateCurr').val() : 1;
                        // var rateinOther = parseFloat($(otherratecurr);
                        // $('#Rate').val(rate * rateinOther);
                    }
                },
                error: function (req, status, error) {
                    alert(error);
                }
            });
        }

        $(document).on('select2:select', '#PartCode,#ItemCode', function (e) {
            var cntId = e.target.id;
            if (cntId == 'PartCode') {
                SetPartCodeItemName('PartCode');
            }
            else {
                SetPartCodeItemName('ItemCode');
            }
            FillItemsRelatedDetails();
            FillCurrentBatchINStore();
            FillTotalStock();
            $('#BillQty').val(0);
            $('#BillRate').val(0);

            $('#RejectedQty').val(0);
            $('#PRRate').val(0);
        });

        $('#StoreId').change(function () {
            FillCurrentBatchINStore();
            FillTotalStock();
        });

        $('#Batchno').change(function (event) {

            event.preventDefault();
            FillUniqueBatchNo();
            FillTotalStock();
        });

        function FillTotalStock() {
            $.ajax({
                type: "POST",
                url: "@Url.Action("GetStoreTotalStock", "NRGP")",
                data: { ItemCode: $('#ItemCode').val(), StoreId: $('#StoreId').val(), TillDate: $('#PurchaseRejectionVoucherDate').val() },
                dataType: "json",
                success: function (result, status, error) {
                    if (result != null) {
                        var obj = $.parseJSON(result);
                        $('#TotalStock').val(obj.Result[0].STOCK);
                    }
                }
            });
        }

        function FillCurrentBatchINStore() {

            var ItemCode = $('#ItemCode').val();
            var YearCode = $('#PurchaseRejYearCode').val();
            var StoreName = $('#StoreId').find(':selected').text();
            var batchno = "";
            if ($('#Batchno').prop('selectedIndex') != 0) {
                batchno = $('#Batchno').val();
            }
            $.ajax({
                type: "POST",
                url: "@Url.Action("FillCurrentBatchINStore", "NRGP")",
                data: { "ItemCode": ItemCode, "YearCode": YearCode, "StoreName": StoreName, "batchno": batchno },
                dataType: "json",
                async: false,
                success: function (result, status, error) {
                    if (result != null) {
                        var obj = $.parseJSON(result);
                        if (obj.StatusCode == 200 && obj.StatusText == 'Success') {
                            $('#Batchno').empty();
                            $('#Batchno').append('<option value="0" selected>-Select-</option>');

                            var seenValues = {};
                            $.each(obj.Result, function (index, val) {
                                if (!seenValues[val.batchno]) {
                                    seenValues[val.batchno] = true;
                                    $('#Batchno').append('<option value="' + val.batchno + '">' + val.batchno + '</option>');
                                }
                            });

                            //GetBatchInventory();

                            var selectListLength = $('#Batchno option').length - 1;
                           //var itemArrayLength = itemBatchArray.length;
                           //if (itemArrayLength > 0) {
                          //     var itemsWithCode16 = itemBatchArray.filter(function (item) {
                          //         return item.itemcode === parseInt(ItemCode);
                          //     });
                          //     var selectList = $('#Batchno');
                          //     selectList.find('option').each(function () {
                          //         var optionValue = $(this).val();
                          //         var existsInItemsWithCode16 = itemsWithCode16.some(function (item) {
                          //             return item.batchno === optionValue;
                          //         });
                          //
                          //         if (existsInItemsWithCode16) {
                          //             $(this).remove();
                          //         }
                          //     });
                          //
                          //     //}
                          //     //if (itemBatchArray.length > 0) {
                          //     //    $('#BatchNo option[value="' + itemBatchArray[0].batchno + '"]').remove();
                          //     //    $('#uniquebatchno option[value="' + itemBatchArray[0].uniquebatchno + '"]').remove();
                          //     //}
                          //}
                        } else {
                            $('#Batchno').empty();
                            $('#Batchno').append('<option value="0" disabled selected>-Select-</option>');
                            $('#Uniquebatchno').empty();
                            $('#Uniquebatchno').append('<option value="0" disabled selected>-Select-</option>');
                        }

                    }
                }
            });
        }

        function GetBatchInventory() {
            $.ajax({
                type: "POST",
                url: "@Url.Action("GetBatchInventory", "SaleBill")",
                dataType: "json",
                success: function (result, status, error) {

                    if (result != null) {
                        var obj = $.parseJSON(result);
                        //$('#EntryId').val(obj.Result[0].EntryId);
                        if (obj.Result.Table[0].AllowBAtchEditable == 'Y') {
                            $("#Batchno option:not(:eq(1))").prop("disabled", true);
                            $('#Batchno').css('background-color', 'rgb(248 255 178)');
                        }
                    }
                }
            });
        }

        function FillUniqueBatchNo() {
            $.ajax({
                type: "POST",
                url: '@Url.Action("GetBatchNumber", "NRGP")',
                data: { StoreId: $('#StoreId').val(), StoreName: $('#StoreId').find(':selected').text(), ItemCode: $('#ItemCode').val(), TransDate: $('#PurchaseRejectionVoucherDate').val(), YearCode: $('#PurchaseRejYearCode').val(), BatchNo: $('#Batchno').val() },
                dataType: "json",
                async: false,
                success: function (result, status, error) {
                    $('#Uniquebatchno').empty();
                    $('#Uniquebatchno').append('<option value="0" selected>-Select-</option>');
                    if (result != null) {
                        var obj = $.parseJSON(result);
                        if (obj.StatusCode == 200 && obj.StatusText == 'Success') {
                            $.each(obj.Result, function (index, val) {
                                if ($("#Uniquebatchno option[value='" + val.UniqueBatchNo + "']").length == 0) {
                                    $('#Uniquebatchno').append('<option value="' + val.UniqueBatchNo + '" data-stock="' + val.stock + '" selected>' + val.UniqueBatchNo + '</option>');
                                }
                            });
                            FillLotStock();
                            // $('#DiscountAmt').val(0);
                            // $('#DiscountPer').val(0);
                        }
                    }
                },
                error: function (req, status, error) {
                    alert(error);
                }
            });
        }

        $('#Uniquebatchno').change(function () {
            FillLotStock();
        });

        function FillLotStock() {
            $.ajax({
                type: "POST",
                url: "@Url.Action("FillLotStock", "StockAdjustment")",
                data: { ItemCode: $('#ItemCode').val(), StoreId: $('#StoreId').val(), TillDate: $('#SaleBillDate').val(), BatchNo: $('#Batchno').val(), UniqueBatchNo: $('#Uniquebatchno').val() },
                dataType: "json",
                async: false,
                success: function (result, status, error) {

                    if (result != null) {
                        var obj = $.parseJSON(result);
                        $('#LotStock').val($.parseJSON(result).Result[0].STOCK);
                        BatchStock = $.parseJSON(result).Result[0].STOCK;
                    }
                    // SetminQty();
                    CalculateAmount();
                }
            });
        }
         $('#RejectedQty').change(function () {
            CalculateAmount();
            FillAltQty();
        });

        $('#AltQty').change(function () {
            FillAltQty();
        });

        $('#PRRate').change(function () {
            CalculateAmount();
        });

        function CalculateAmount() {

            var rate = $('#PRRate').val();
            var Qty = $('#RejectedQty').val();

            $('#ItemAmount').val(rate * Qty);
            onDiscountChange()
        }
        function FillAltQty() {
            var ItemCode = parseInt($('#ItemCode').val());
            var AltQty = $('#AltQty').val();
            var UnitQty = parseFloat($('#TotalStock').val());
            $.ajax({
                type: "POST",
                data: { "ItemCode": ItemCode, "AltQty": AltQty, "UnitQty": UnitQty },
                url: "@Url.Action("GetAltUnitQty", "StockAdjustment")",
                dataType: "json",
                success: function (result, status, error) {
                    if (result != null) {
                        var obj = $.parseJSON(result);
                        if (obj.Result.length > 0) {
                            $('#AltQty').val("");
                            $('#AltQty').val(obj.Result[0].AltUnitValue);
                        }
                    }
                }
            });
        }
        function SetPartCodeItemName(ID) {

            if (!ID) return;
            else {
                var v = $('#' + ID).val();
                var t = $('#' + ID + ' option:selected').text();

                if (ID == "PartCode") {
                    v == "" ? $('#ItemCode').val("").trigger("change") : $('#ItemCode').val(v).trigger("change");
                }

                if (ID == "ItemCode") {
                    v == "" ? $('#PartCode').val("").trigger("change") : $('#PartCode').val(v).trigger("change");
                }
            }
        }

        $('#ItemSA').change(function () {
            FillItems($('#ItemSA').is(':checked'));
        });

        function FillItems(itemType) {
            var showAll = $('#ItemSA').prop('checked') ? 'Y' : 'N';
            var YearCode = $('#PurchaseRejYearCode').val();
            var accountCode = $('#AccountCode').val();
            $.ajax({
                type: "POST",
                data: { "YearCode": YearCode, "accountCode": accountCode, "showAllItems": showAll, "Flag": "FillItemName" },
                url: "@Url.Action("FillItems")",
                dataType: "json",
                async: false,
                success: function (result, status, error) {
                    if (result != null) {
                        var obj = $.parseJSON(result);
                        if (obj.Result != null) {
                            $('#ItemCode').empty();
                            $('#ItemCode').append('<option value="0">-Select-</option>');
                            if (obj.StatusCode != 500) {
                                if (obj != null && obj.Result != null) {
                                    $.each(obj.Result.Table, function (index, val) {
                                        $('#ItemCode').append("<option value=" + val.Itemcode + ">" + val.ItemName + "</option>");
                                    });
                                }
                            }
                        }
                    }
                }
            });
            $.ajax({
                type: "POST",
                data: { "YearCode": YearCode, "accountCode": accountCode, "showAllItems": showAll, "Flag": "FillPartCode" },
                url: "@Url.Action("FillItems")",
                dataType: "json",
                async: false,
                success: function (result, status, error) {
                    if (result != null) {
                        var obj = $.parseJSON(result);
                        if (obj.Result != null) {
                            $('#PartCode').empty();
                            $('#PartCode').append('<option value="0">-Select-</option>');
                            if (obj.StatusCode != 500) {
                                if (obj != null && obj.Result != null) {
                                    $.each(obj.Result.Table, function (index, val) {
                                        $('#PartCode').append("<option value=" + val.Itemcode + ">" + val.PartCode + "</option>");
                                    });
                                }
                            }
                        }
                    }
                }
            });
        }

        $('.btnItemData').click(function () {
            $('#addPurchaseRejectionPopupModel').modal("show");
            FillPurchaseRejectionPopUp();

            $('#popUpPartCodeTop').val($('#PartCode').find(':selected').text());
            $('#popUpItemNameTop').val($('#ItemCode').find(':selected').text());
        });

        $('#PurchaseRejectionInvoiceDate').change(function () {
            var invoiceDate = parseDateToFormat($('#PurchaseRejectionInvoiceDate').val());
            $('#PurchaseRejectionVoucherDate').datepicker("option", "minDate", invoiceDate);
        });

        $('#fromBillDate').change(function () {

            $('#toBillDate').datepicker("option", "minDate", $('#fromBillDate').val());
        });

        function GetServerDate() {
            $.ajax({
                type: "GET",
                url: "@Url.Action("GetServerDate", "SaleOrder")",
                async: false,
                success: function (result, status, error) {

                    result = parseDateToFormat(result);

                    const [day, month, year] = result.split("/").map(Number);
                    const currentDate = new Date(year, month - 1, day);
                    var past2Month = currentDate.setMonth(currentDate.getMonth() - 2);
                    var formattedPastDate = parseDateToFormat(new Date(past2Month).toISOString().split('T')[0]);

                    var finFromDate = parseDateToFormat($('#FinFromDate').val().split(" ")[0]);
                    var finToDate = parseDateToFormat($('#FinToDate').val().split(" ")[0]);

                    var past2Year = currentDate.setYear(currentDate.getFullYear() - 2);
                    var formattedYear = parseDateToFormat(new Date(past2Year).toISOString().split("T")[0]);

                    // $('#fromBillDate').datepicker({ dateFormat: 'dd/mm/yy' }).datepicker("setDate", result);
                    $('#fromBillDate').datepicker({ dateFormat: 'dd/mm/yy' }).datepicker("setDate", result).datepicker("option", { changeMonth: true, changeYear: true });
                    $('#toBillDate').datepicker({ dateFormat: 'dd/mm/yy' }).datepicker("setDate", result).datepicker("option", { changeMonth: true, changeYear: true });

                    $('#fromBillDate').datepicker("option", "minDate", formattedYear);
                    $('#toBillDate').datepicker("option", "minDate", formattedYear);
                    $('#fromBillDate').datepicker({ dateFormat: 'dd/mm/yy' }).datepicker("setDate", finFromDate);
                    $('#toBillDate').datepicker({ dateFormat: 'dd/mm/yy' }).datepicker("setDate", finToDate);

                    $('#PurchaseRejectionInvoiceDate').datepicker({ dateFormat: 'dd/mm/yy' }).datepicker("setDate", result).datepicker("option", { changeMonth: true, changeYear: true });
                    $('#PurchaseRejectionInvoiceDate').datepicker("option", "minDate", formattedPastDate);
                    $('#PurchaseRejectionInvoiceDate').datepicker("option", "maxDate", result);

                    if($('#Mode').val() == "U" || $('#Mode').val() == "V"){
                            var vouchDate = $('#PurchaseRejectionVoucherDate').val() != "" ? parseDateToFormat($('#PurchaseRejectionVoucherDate').val()) : result;
                            $('#PurchaseRejectionVoucherDate').datepicker({ dateFormat: 'dd/mm/yy' }).datepicker("setDate", vouchDate).datepicker("option", { changeMonth: true, changeYear: true });
                            $('#PurchaseRejectionVoucherDate').datepicker({ dateFormat: 'dd/mm/yy' }).datepicker("setDate", vouchDate);
                            $('#PurchaseRejectionVoucherDate').datepicker("option", "minDate", formattedPastDate);
                            $('#PurchaseRejectionVoucherDate').datepicker("option", "maxDate", finToDate);

                            var entryDate = $('#PurchaseRejEntryDate').val() != "" ? parseDateToFormat($('#PurchaseRejEntryDate').val()) : result;
                            $('#PurchaseRejEntryDate').datepicker({ dateFormat: 'dd/mm/yy' }).datepicker("setDate", entryDate).datepicker("option", { changeMonth: true, changeYear: true });
                            $('#PurchaseRejEntryDate').datepicker({ dateFormat: 'dd/mm/yy' }).datepicker("setDate", entryDate);
                            $('#PurchaseRejEntryDate').datepicker("option", "minDate", formattedPastDate);
                            $('#PurchaseRejEntryDate').datepicker("option", "maxDate", finToDate);

                            var mirDate = $('#MIRDate').val() != "" ? parseDateToFormat($('#MIRDate').val()) : result;
                            $('#MIRDate').datepicker({ dateFormat: 'dd/mm/yy' }).datepicker("setDate", mirDate).datepicker("option", { changeMonth: true, changeYear: true });
                            $('#MIRDate').datepicker({ dateFormat: 'dd/mm/yy' }).datepicker("setDate", mirDate);
                            $('#MIRDate').datepicker("option", "minDate", formattedPastDate);
                            $('#MIRDate').datepicker("option", "maxDate", finToDate);

                            var ActualEntryDate = $('#ActualEntryDate').val() != "" ? parseDateToFormat($('#ActualEntryDate').val()) : result;
                            $('#ActualEntryDate').datepicker({ dateFormat: 'dd/mm/yy' }).datepicker("setDate", ActualEntryDate).datepicker("option", { changeMonth: true, changeYear: true });
                            $('#ActualEntryDate').datepicker({ dateFormat: 'dd/mm/yy' }).datepicker("setDate", ActualEntryDate);
                            $('#ActualEntryDate').datepicker("option", "minDate", formattedPastDate);
                            $('#ActualEntryDate').datepicker("option", "maxDate", finToDate);

                            var LastUpdationDate = $('#LastUpdationDate').val() != "" ? parseDateToFormat($('#LastUpdationDate').val()) : result;
                            $('#LastUpdationDate').datepicker({ dateFormat: 'dd/mm/yy' }).datepicker("setDate", LastUpdationDate).datepicker("option", { changeMonth: true, changeYear: true });
                            $('#LastUpdationDate').datepicker({ dateFormat: 'dd/mm/yy' }).datepicker("setDate", LastUpdationDate);
                            $('#LastUpdationDate').datepicker("option", "minDate", formattedPastDate);
                            $('#LastUpdationDate').datepicker("option", "maxDate", finToDate);
                    }
                    else {
                           $('#PurchaseRejectionVoucherDate').datepicker({ dateFormat: 'dd/mm/yy' }).datepicker("setDate", result).datepicker("option", { changeMonth: true, changeYear: true });
                           $('#PurchaseRejectionVoucherDate').datepicker({ dateFormat: 'dd/mm/yy' }).datepicker("setDate", result);
                           $('#PurchaseRejectionVoucherDate').datepicker("option", "minDate", formattedPastDate);
                           $('#PurchaseRejectionVoucherDate').datepicker("option", "maxDate", finToDate);

                           $('#PurchaseRejEntryDate').datepicker({ dateFormat: 'dd/mm/yy' }).datepicker("setDate", result).datepicker("option", { changeMonth: true, changeYear: true });
                           $('#PurchaseRejEntryDate').datepicker({ dateFormat: 'dd/mm/yy' }).datepicker("setDate", result);
                           $('#PurchaseRejEntryDate').datepicker("option", "minDate", formattedPastDate);
                           $('#PurchaseRejEntryDate').datepicker("option", "maxDate", finToDate);

                           $('#MIRDate').datepicker({ dateFormat: 'dd/mm/yy' }).datepicker("setDate", result).datepicker("option", { changeMonth: true, changeYear: true });
                           $('#MIRDate').datepicker({ dateFormat: 'dd/mm/yy' }).datepicker("setDate", result);
                           $('#MIRDate').datepicker("option", "minDate", formattedPastDate);
                           $('#MIRDate').datepicker("option", "maxDate", finToDate);

                           $('#InprocessDate').datepicker({ dateFormat: 'dd/mm/yy' }).datepicker("setDate", result).datepicker("option", { changeMonth: true, changeYear: true });
                           $('#InprocessDate').datepicker({ dateFormat: 'dd/mm/yy' }).datepicker("setDate", result);
                           $('#InprocessDate').datepicker("option", "minDate", formattedPastDate);
                           $('#InprocessDate').datepicker("option", "maxDate", finToDate);

                           $('#ActualEntryDate').datepicker({ dateFormat: 'dd/mm/yy' }).datepicker("setDate", result).datepicker("option", { changeMonth: true, changeYear: true });
                            $('#ActualEntryDate').datepicker({ dateFormat: 'dd/mm/yy' }).datepicker("setDate",result);
                            $('#ActualEntryDate').datepicker("option", "minDate", formattedPastDate);
                            $('#ActualEntryDate').datepicker("option", "maxDate", finToDate);

                            $('#LastUpdationDate').datepicker({ dateFormat: 'dd/mm/yy' }).datepicker("setDate", result).datepicker("option", { changeMonth: true, changeYear: true });
                            $('#LastUpdationDate').datepicker({ dateFormat: 'dd/mm/yy' }).datepicker("setDate", result);
                            $('#LastUpdationDate').datepicker("option", "minDate", formattedPastDate);
                            $('#LastUpdationDate').datepicker("option", "maxDate", finToDate);
                    }
                }
            });

        }
        function PressBack() {

            sessionStorage.setItem('FromDateBack', $('#FromDateBack').val());
            sessionStorage.setItem('ToDateBack', $('#ToDateBack').val());
            sessionStorage.setItem('VendorNameBack', $('#VendorNameBack').val());
            sessionStorage.setItem('VoucherNoBack', $('#VoucherNoBack').val());
            sessionStorage.setItem('InvoiceNoBack', $('#InvoiceNoBack').val());
            sessionStorage.setItem('PartCodeBack', $('#PartCodeBack').val());
            sessionStorage.setItem('GlobalSearchBack', $('#GlobalSearchBack').val());

            window.history.back();
        }

        $(document).on('keypress', ':input:not(textarea):not([type=button])', function (e) {
            if (e.which == 13) e.preventDefault();
        });
    </script>
    <script src="https://cdn.jsdelivr.net/gh/linways/table-to-excel@v1.0.4/dist/tableToExcel.js"></script>
}
