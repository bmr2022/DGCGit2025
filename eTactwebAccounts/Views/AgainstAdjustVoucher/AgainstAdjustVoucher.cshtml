@using eTactWeb.DOM.Models
 @model eTactWeb.DOM.Models.AgainstAdjustVoucherModel;
@{
    ViewData["Title"] = "Against Adjust Voucher";
    Layout = "~/Views/Shared/_LayoutMain.cshtml";
}
<style>
    #container {
        display: flex;
    }

        #container > div {
            flex: 1;
            margin-right: 10px;
        }

    #GateDataTable {
        width: 100%;
        border-collapse: collapse;
    }

    #dashGateThead th {
        background-color: #127387;
        position: sticky;
        top: -2px;
        z-index: 1;
    }

    tbody td {
        /* Table cell styles */
    }

    .sort-icon {
        padding: 5px;
        margin: 5px;
        vertical-align: top;
    }

    .ascCol {
        font-size: 15px;
        vertical-align: bottom;
    }

    .descCol {
        font-size: 15px;
        vertical-align: super;
    }

    .select2-container--default .select2-selection--single {
        background-color: #e0f2f1;
        border: 1.5px solid #0a0a0a !important;
        border-radius: 4px;
    }

        .select2-container--default .select2-selection--single .select2-selection__rendered {
            /* border-bottom: 1.5px solid #000 !important; */
            border-bottom: none !important;
        }

    .select2-container--default .select2-results > .select2-results__options {
        background-color: #e0f2f1; /* Dropdown background color */
        color: #000;
        .tiny-switch

    {
        position: relative;
        display: inline-block;
        width: 28px;
        height: 14px;
    }

    .tiny-switch input {
        opacity: 0;
        width: 0;
        height: 0;
    }

    .tiny-slider {
        position: absolute;
        cursor: pointer;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: #ccc;
        transition: .4s;
        border-radius: 14px;
    }

        .tiny-slider:before {
            position: absolute;
            content: "";
            height: 10px;
            width: 10px;
            left: 2px;
            bottom: 2px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

    input:checked + .tiny-slider {
        background-color: #0dcaf0;
    }

        input:checked + .tiny-slider:before {
            transform: translateX(14px);
        }
</style>

<div class="card bg-gradient mb-3 border-light shadow-lg">
    <form asp-action="AgainstAdjustVoucher" asp-controller="AgainstAdjustVoucher" method="post" class="form-horizontal">
        <div class="card-header card-headerBG text-light justify-content-center bg-gradient">
            <h5>
                <strong>
                    Against Adjust Voucher/strong>
                    <span class="d-flex float-end" style="margin-top:-2px;">
                        <a asp-controller="AgainstAdjustVoucher" asp-action="AgainstAdjustVoucherDashBoard" asp-route-ID="0" class="btn btn-sm btn-outline-light bg-gradient">
                            <i class="fa-solid fa-grip fa-fw fa-lg fa-beat" aria-hidden="true"></i>
                            Dashboard
                        </a>
                        <div class="row justify-content-between g-2">
                            <div class="col-auto">
                                <input asp-for="FromDateBack" type="hidden" value="@Model.FromDateBack" />
                                <input asp-for="ToDateBack" type="hidden" value="@Model.ToDateBack" />
                                <input asp-for="LedgerNameBack" type="hidden" value="@Model.LedgerNameBack" />
                                <input asp-for="VoucherNoBack" type="hidden" value="@Model.VoucherNoBack" />
                                <input asp-for="AgainstVoucherRefNoBack" type="hidden" value="@Model.AgainstVoucherRefNoBack" />
                                <input asp-for="AgainstVoucherNoBack" type="hidden" value="@Model.AgainstVoucherNoBack" />
                                <input asp-for="GlobalSearchBack" type="hidden" value="@Model.GlobalSearchBack" />
                                <input asp-for="DashboardTypeBack" type="hidden" value="@Model.DashboardTypeBack" />
                                <input asp-for="AccEntryId" type="hidden" />
                                <input asp-for="DocEntryId" type="hidden" />
                                <a href="#" class="btn btn-primary btn-sm" onclick="PressBack();">
                                    <i class="fa fa-chevron-circle-left fa-fw fa-lg" aria-hidden="true"></i>
                                    BACK
                                </a>
                            </div>
                            <div class="col-auto">
                                <a type="button" class="btn btn-sm btn-outline-light bg-gradient" asp-action="PrintReport" asp-controller="BankReceipt" asp-route-EntryId="@Model.EntryId" asp-route-YearCode="@Model.YearCode" asp-route-VoucherName="@Model.SubVoucherName">
                                    <i class="fa fa-pencil-square fa-fw fa-lg" aria-hidden="true"></i>
                                    PRINT
                                </a>
                            </div>
                            @if (Model.Mode != "V")
                            {
                                <div class="col-auto">
                                    <a class="btn btn-secondary btn-sm" onclick="location.href=$('form')[0].action">
                                        <i class="fa fa-refresh fa-fw fa-lg" aria-hidden="true"></i>
                                        REFRESH
                                    </a>
                                </div>
                                @if (Model.Mode == "U")
                                {
                                    Model.Mode = "U";
                                    <div class="col-auto">
                                        <button type="submit" class="UpdateButton btn btn-sm btn-outline-light bg-gradient submitBTN">
                                            <i class="fa fa-pencil-square fa-fw fa-lg" aria-hidden="true"></i>
                                            UPDATE
                                        </button>
                                    </div>
                                }
                                else
                                {
                                    <div class="col-auto">
                                        <button type="submit" class="btn btn-primary btn-sm submitBTN">
                                            <i class="fa-solid fa-chevron-circle-right"></i>
                                            SUBMIT
                                        </button>
                                    </div>
                                }
                            }
                        </div>
                    </span>
            </h5>
        </div>
        <div class="card-body bg-light">
            <div class="accordion shadow-lg" id="accordionItemCategory">
                <div class="accordion-item">
                    <h2 class="accordion-header" id="H_ItemCategoryDetail">
                        <button class="accordion-button text-light pnl1BG bg-gradient" type="button" data-bs-toggle="collapse" data-bs-target="#B_ItemCategoryDetail"
                                aria-expanded="true" aria-controls="B_ItemCategoryDetail">
                            <strong><i class="fa fa-fw pr35 fa-book fa-lg" aria-hidden="true"></i>Against Adjust Voucher Detail</strong>
                            <small class="p-3"></small>
                        </button>
                    </h2>
                    <div id="B_ItemCategoryDetail" class="accordion-collapse collapse pnl1 bg-gradient show" aria-labelledby="H_ItemCategoryDetail">
                        <div class="accordion-body">
                            <div class="row g-2 gx-3" id="_ItemGrid">
                                <input type="hidden" value="@Model.Mode" asp-for="Mode" />
                                @* <input asp-for="FromDate" value="@Model.FromDate" class="form-control" type="hidden" />
                                <input asp-for="ToDate" value="@Model.ToDate" class="form-control" type="hidden" /> *@
                                <input type="hidden" asp-for="SrNO" />
                                <div class="col-xl-1 col-lg-3 col-md-3 col-sm-6 col-xs-12">
                                    <label asp-for="CC" class="form-label">Branch</label>
                                    <input asp-for="CC" class="form-control" readonly />
                                </div>
                                <div class="col-xl-1 col-lg-3 col-md-3 col-sm-6 col-xs-12">
                                    <label asp-for="EntryId" class="form-label">Entry Id</label>
                                    <input asp-for="EntryId" class="form-control" readonly />
                                </div>
                                <div class="col-xl-1 col-lg-3 col-md-3 col-sm-6 col-xs-12">
                                    <label asp-for="EntryDate" class="form-label">Entry Date</label>
                                    <input asp-for="EntryDate" class="form-control" readonly />
                                </div>
                                <div class="col-xl-1 col-lg-3 col-md-3 col-sm-6 col-xs-12">
                                    <label asp-for="YearCode" class="form-label">YearCode</label>
                                    <input asp-for="YearCode" class="form-control" readonly />
                                </div>
                                <div class="col-xl-1 col-lg-3 col-md-3 col-sm-6 col-xs-12">
                                    <label class="form-label">From Date</label>
                                    <input asp-for="FromDate" class="form-control" />
                                </div>
                                <div class="col-xl-1 col-lg-3 col-md-3 col-sm-6 col-xs-12">
                                    <label class="form-label">To Date</label>
                                    <input asp-for="ToDate" class="form-control" />
                                </div>
                                <div class="col-xl-2 col-lg-3 col-md-3 col-sm-6 col-xs-12">
                                    <label asp-for="VoucherType" class="form-label" style="color:red;">Voucher Type*</label>
                                    <select class="form-control" asp-for="VoucherType">
                                    </select>
                                </div>
                                <div class="col-xl-3 col-lg-3 col-md-3 col-sm-6 col-xs-12">
                                    <label asp-for="LedgerName" class="form-label" style="color:red;">Ledger Name</label>
                                    <select class="form-control" asp-for="LedgerName">
                                    </select>
                                </div>
                                <div class="col-xl-2 col-lg-3 col-md-3 col-sm-6 col-xs-12">
                                    <label asp-for="VoucherNo" class="form-label" style=" color:red;">VoucherNo*</label>
                                    <select class="form-control" asp-for="VoucherNo">
                                    </select>
                                </div>
                                <div class="col-xl-2 col-lg-3 col-md-3 col-sm-6 col-xs-12">
                                    <label asp-for="InVoiceNo" class="form-label" style=" color:red;">InVoice No</label>
                                    <select class="form-control" asp-for="InVoiceNo">
                                    </select>
                                </div>
                                @*    <div class="col-xl-2 col-lg-3 col-md-3 col-sm-6 col-xs-12" style="width:120px;">
                                    <label asp-for="VoucherDate" class="form-label" style=" color:red;">Voucher Date*</label>
                                    <input asp-for="VoucherDate" class="form-control" readonly />
                                </div> *@

                                <div class="col-xl-1 col-lg-3 col-md-3 col-sm-6 col-xs-12">
                                    <label asp-for="BillAmount" class="form-label">Bill Amount</label>
                                    <input asp-for="BillAmount" class="form-control" readonly />
                                </div>
                                <div class="col-xl-1 col-lg-3 col-md-3 col-sm-6 col-xs-12">
                                    <label asp-for="NetAmount" class="form-label">Net Amount</label>
                                    <input asp-for="NetAmount" class="form-control" readonly />
                                </div>
                                <div class="col-xl-1 col-lg-3 col-md-3 col-sm-6 col-xs-12">
                                    <button type="button" class="btn btn-outline-success btn-sm mt-3 Adjarbtn" onclick="Openagnstrefpopup()" >
                                        <i class="fa-solid fa-angles-down me-1"></i>
                                        Add More <br> Against Ref
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="accordion-item">
                    <h2 class="accordion-header">
                        <button id="H_SAGrid" class="accordion-button collapsed text-light pnl4BG " type="button" data-bs-toggle="collapse" data-bs-target="#B_SAGrid" aria-expanded="true" aria-controls="B_SAGrid" style="width: 90%;">
                            <strong style="text-transform:uppercase"><i class="fa-solid fa-table-list fa-lg fa-fw pr35 fa-fade" style="--fa-animation-duration: 2s; --fa-fade-opacity: 0.6;"></i>Against Adjust Voucher Grid</strong>
                        </button>
                        <button class="btn btn-sm btn-outline-danger GridButton" style="width:150px;" type="button" onclick="GridButton()">
                            <i class="fa-solid fa-angles-down fa-fw fa-lg "></i>ADD TO GRID
                        </button>
                    </h2>

                    <div id="B_SAGrid" class="accordion-collapse collapse pnl4 bg-gradient" aria-labelledby="H_SAGrid">
                        <div class="accordion-body">
                            <div class="row g-2 gx-3" id="_ItemGrid">
                            </div>
                            <div class="progress my-2 mb-3" style="height: 4px;">
                                <div class="progress-bar progress-bar-striped bg-secondary progress-bar-animated" role="progressbar" style="width: 100%" aria-valuenow="100" aria-valuemin="0" aria-valuemax="100"></div>
                            </div>
                            <div class="card">
                                <div class="card-body overflow-auto pb-0">
                                    <div style="overflow-x:auto; overflow-y:auto; max-height:340px; border:1px solid #ccc;">
                                        <table class="table table-hover table-bordered table-striped" id="tblAgainstAdjustVoucher">
                                            <thead class="bg-gradient card-headerBG text-light small" style="white-space:nowrap" id="dashGateThead">
                                                <tr id="headerRow">
                                                    <th>Action</th>
                                                    <th>Sr#</th>
                                                    <th>Mode Of Adjustment</th>
                                                    <th>Description</th>
                                                    <th>Due Date</th>
                                                    <th>New Ref No</th>
                                                    <th>Adjusted Amount</th>
                                                    <th>Dr/Cr</th>
                                                    <th>Purch Order No</th>
                                                    <th>PO Year</th>
                                                    <th>PO Date</th>
                                                    <th>Voucher No</th>
                                                    <th>Voucher Type</th>
                                                    <th>OpenEntryID</th>
                                                    <th>Opening YearCode</th>
                                                    <th>Acc Entry ID</th>
                                                    <th>Acc YearCode</th>
                                                </tr>
                                            </thead>
                                            <tbody id="divAdjItemList">
                                                <partial name="_AgainstAdjustVoucher" />
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="progress my-3 mb-3" style="height: 4px;">
                            <div class="progress-bar progress-bar-striped bg-warning" role="progressbar" style="width: 100%" aria-valuenow="100" aria-valuemin="0" aria-valuemax="100"></div>
                        </div>
                        <div class="card">
                            <div class="card-body overflow-auto pb-0">
                                <div style="overflow-x:auto; overflow-y:auto; max-height:190px; border:1px solid #ccc;">
                                    <table class="table table-hover table-bordered table-striped">
                                        <thead class="bg-gradient card-headerBG text-light small" style="white-space:nowrap" id="dashGateThead">
                                            @* <tr>
                                                <th>Action</th>
                                                <th>Sr NO</th>
                                                <th>Ledger Name</th>
                                                <th>Balance&nbsp;DR/CR</th>
                                                <th title="Mode of Adjustment">Mode of Adj</th>
                                                <th>Amount&nbsp;Type</th>
                                                <th>Amount (OC)</th>
                                                <th>Cost Center</th>
                                                <th>Party-Wise Narr</th>
                                                <th title="Against Voucher No">Agst Vch No</th>
                                                <th title="Against Voucher Code">Agst Vch Code</th>
                                                <th title="Against Voucher Date">Agst Vch Date</th>
                                                <th title="Against Voucher Type">Agst Vch Type</th>
                                                <th title="Against Voucher Entry ID">Agst Vch ID</th>
                                                <th title="Voucher Bill Amount">Vch Bill Amt</th>
                                                <th title="Pending Bill Amount">Pending Bill Amt</th>
                                            </tr> *@
                                            <tr id="headerRow">
                                                <th>Action</th>
                                                <th>Sr#</th>
                                                <th>Mode Of Adjustment</th>
                                                <th>Description</th>
                                                <th>Due Date</th>
                                                <th>New Ref No</th>
                                                <th>Adjusted Amount</th>
                                                <th>Dr/Cr</th>
                                                <th>Purch Order No</th>
                                                <th>PO Year</th>
                                                <th>PO Date</th>
                                                <th>Voucher No</th>
                                                <th>Voucher Type</th>
                                                <th>OpenEntryID</th>
                                                <th>Opening YearCode</th>
                                                <th>Acc Entry ID</th>
                                                <th>Acc YearCode</th>
                                            </tr>
                                        </thead>
                                        <tbody id="divBankReceiptDetail">
                                            <partial name="_AgainstAdjustVoucherGrid" />
                                        </tbody>
                                    </table>
                                </div>
                                <div class="d-flex flex-wrap align-items-center gap-3">
                                    <div class="text-center">
                                        <strong>Total No Of Items: <span id="lblTotalNoOfBelowItems"></span></strong>
                                    </div>

                                    <div style="width:170px;">
                                        <label asp-for="Naration" class="form-label">Naration</label>
                                        <input asp-for="Naration" class="form-control" data-val="false" />
                                    </div>

                                    <div style="width:170px;">
                                        <label asp-for="DrAmt" class="form-label">Dr Amt</label>
                                        <input asp-for="DrAmt" class="form-control" readonly />
                                    </div>

                                    <div style="width:170px;">
                                        <label asp-for="CrAmt" class="form-label">Cr Amt</label>
                                        <input asp-for="CrAmt" class="form-control" readonly data-val="false" />
                                    </div>

                                    <div style="width:170px;">
                                        <label asp-for="VoucherAmt" class="form-label">Voucher Amt</label>
                                        <input asp-for="VoucherAmt" class="form-control" data-val="false" readonly />
                                    </div>
                                </div>
                                <br />
                            </div>
                        </div>
                        <div class="progress my-2 mb-3" style="height: 4px;">
                            <div class="progress-bar progress-bar-striped bg-secondary progress-bar-animated" role="progressbar" style="width: 100%" aria-valuenow="100" aria-valuemin="0" aria-valuemax="100"></div>
                        </div>
                    </div>
                </div>

                <div class="accordion-item">
                    <h2 class="accordion-header" id="OtherGrid">
                        <button class="accordion-button collapsed text-light pnl4BG bg-gradient" type="button" data-bs-toggle="collapse" data-bs-target="#OtherGridDetail" aria-expanded="true" aria-controls="OtherGridDetail">
                            <strong style="text-transform:uppercase"><i class="fa-solid fa-table-list fa-lg fa-fw pr35 fa-fade" style="--fa-animation-duration: 2s; --fa-fade-opacity: 0.6;"></i>Other Detail</strong>
                        </button>
                    </h2>
                    <div id="OtherGridDetail" class="accordion-collapse collapse pnl4 bg-gradient" aria-labelledby="OtherGrid">
                        <div class="accordion-body">
                            <div class="progress my-2 mb-3" style="height: 4px;">
                                <div class="progress-bar progress-bar-striped bg-secondary progress-bar-animated" role="progressbar" style="width: 100%" aria-valuenow="100" aria-valuemin="0" aria-valuemax="100"></div>
                            </div>
                            <div class="accordion-body">
                                <div class="row g-2 gx-3" id="_ItemGrid">
                                    <div class="col-xl-2  col-lg-6 col-md-6 col-sm-6 col-xs-12">
                                        <label asp-for="ActualEntryDate" class="form-label">Actual Entry Date </label>
                                        <input asp-for="ActualEntryDate" class="form-control" readonly />
                                    </div>
                                    <div class="col-xl-2  col-lg-6 col-md-6 col-sm-6 col-xs-12">
                                        <label asp-for="ActualEntryBy" class="form-label">Actual Entry By </label>
                                        <input asp-for="ActualEntryBy" class="form-label" type="hidden" />
                                        <input asp-for="UID" class="form-label" type="hidden" />
                                        <input asp-for="ActualEntryBy" class="form-control" readonly />
                                    </div>
                                    <div class="col-xl-2  col-lg-6 col-md-6 col-sm-6 col-xs-12">
                                        <label asp-for="UpdatedOn" class="form-label">Last Update Date </label>
                                        <input asp-for="UpdatedOn" class="form-control" readonly />
                                    </div>
                                    <div class="col-xl-2 col-lg-3 col-md-3 col-sm-6 col-xs-12">
                                        <label asp-for="UpdatedBy" class="form-label">Last Update By</label>
                                        <input asp-for="UpdatedBy" class="form-control" readonly type="hidden" />
                                        <input asp-for="UpdatedByEmp" class="form-control" readonly />
                                    </div>
                                    <div class="col-xl-2 col-lg-3 col-md-3 col-sm-6 col-xs-12">
                                        <label asp-for="EntryByMachine" class="form-label">MachineName</label>
                                        <input asp-for="EntryByMachine" class="form-control" value="@Environment.MachineName" readonly />
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="card-footer p-3">
                    <div class="row justify-content-between g-2">
                        <div class="card-header card-headerBG text-light bg-gradient">
                            <h5>
                                <strong>Against Adjust Voucher</strong>
                                <span class="d-flex float-end" style="margin-top:-2px;">
                                    <div class="col-auto">
                                        <a type="button" class="btn btn-sm btn-outline-light bg-gradient" asp-action="PrintReport" asp-controller="BankReceipt" asp-route-EntryId="@Model.EntryId" asp-route-YearCode="@Model.YearCode" asp-route-VoucherName="@Model.SubVoucherName">
                                            <i class="fa fa-pencil-square fa-fw fa-lg" aria-hidden="true"></i>
                                            PRINT
                                        </a>
                                    </div>
                                    @*<a asp-action="Dashboard" asp-route-ID="0" class="btn btn-sm btn-outline-light bg-gradient">*@
                                    <a asp-controller="AgainstAdjustVoucher" asp-action="AgainstAdjustVoucherDashBoard" tabindex="-1" asp-route-ID="0" class="btn btn-secondary btn-sm">
                                        <i class="fa-solid fa-grip fa-lg fa-fw fa-beat" style="--fa-animation-duration: 2s;"></i>
                                        Dashboard
                                    </a>
                                    @*<partial name="_FormsButton" />*@
                                    <div class="row justify-content-between g-2">
                                        <div class="col-auto">
                                            <a href="#" class=" btn btn-primary btn-sm" onclick="PressBack();">
                                                <i class="fa fa-chevron-circle-left fa-fw fa-lg" aria-hidden="true"></i>
                                                BACK
                                            </a>
                                        </div>
                                        @if (Model.Mode != "V" && Model.Mode != "SOC" && Model.Mode != "POC")
                                        {
                                            <div class="col-auto">
                                                @*  <a class="btn btn-sm btn-outline-danger" onclick="location.href=$('form')[0].action">*@
                                                <a class="btn btn-secondary btn-sm" onclick="location.href=$('form')[0].action">
                                                    @* <i class="fa-solid fa-grip fa-lg fa-fw fa-beat" style="--fa-animation-duration: 2s;"></i>*@
                                                    <i class="fa fa-refresh fa-fw fa-lg" aria-hidden="true"></i>
                                                    REFRESH
                                                </a>
                                            </div>
                                            @if (Model.Mode == "U")
                                            {
                                                @*Model.Mode = "U";*@
                                                <div class="col-auto">
                                                    @* <button type="submit" class="btn btn-sm btn-outline-warning">*@
                                                    <button type="submit" class="UpdateButton btn btn-sm btn-outline-light bg-gradient submitBTN">
                                                        <i class="fa fa-pencil-square fa-fw fa-lg" aria-hidden="true"></i>
                                                        UPDATE
                                                    </button>
                                                </div>
                                            }
                                            else
                                            {
                                                <div class="col-auto">
                                                    <button type="submit" class="btn btn-primary btn-sm submitBTN">
                                                        <i class="fa-solid fa-chevron-circle-right"></i>
                                                        SUBMIT
                                                    </button>
                                                </div>
                                            }
                                        }
                                    </div>
                                </span>
                            </h5>
                        </div>
                    </div>
                </div>
    </form>
    <div class="accordion-item">
        @await Html.PartialAsync("_AdjAgnstPopup", Model.adjustmentModel ?? new Common.AdjustmentModel())
        @*  <partial name="_AdjustmentGrid" /> *@
    </div>
</div>

@*<div class="modal fade" style="padding-right:100px;" id="DisplayRoutingDetailModal" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="staticBackdropLabel">
    <div class="modal-dialog modal-xl">
        <div class="modal-content" style="width:1280px;">
            <div class="modal-header">
                <h5 class="modal-title" id="staticBackdropLabel">Pending Vouchers</h5>
                <div class="d-flex align-items-center gap-3" style="margin-left:70px">
                    <button type="button" class="btn btn-sm btn-primary" onclick="AdjustButton()">Adjust</button>
                    <input type="text" class="form-control" id="search-box" style="background-color:#FFFACD;" placeholder="Search...">
                    <div class="col-xl-2 col-lg-3 col-md-3 col-sm-6 col-xs-12">
                        <label asp-for="AdjustAmount" class="form-label me-2">Total Adjst Amt</label>
                        <input asp-for="AdjustAmount" class="form-control" onchange="ChangeAdjustAmount()" type="number" min="0" />
                    </div>
                    <div class="col-xl-2 col-lg-3 col-md-3 col-sm-6 col-xs-12">
                        <label asp-for="PopUpBalance" class="form-label me-2">Total Pending Amount to Adjust</label>
                        <input asp-for="PopUpBalance" class="form-control" readonly />
                    </div>
                    <div class="col-xl-2 col-lg-3 col-md-3 col-sm-6 col-xs-12">
                        <label asp-for="TotalPopDrAmt" class="form-label me-2">Total DrAmt</label>
                        <input asp-for="TotalPopDrAmt" class="form-control" readonly />
                    </div>
                    <div class="col-xl-2 col-lg-3 col-md-3 col-sm-6 col-xs-12">
                        <label asp-for="TotalPopCrAmt" class="form-label me-2">Total CrAmt</label>
                        <input asp-for="TotalPopCrAmt" class="form-control" readonly />
                    </div>
                </div>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="card">
                    <div class="card-body">
                        <div class="row g-2 gx-3">
                            <div class="card-body text-center overflow-auto pb-0">
                                <div class="table-responsive" style="max-height:350px;">
                                    <table class="table table-hover table-bordered table-striped mb-0 BomDetailtable" id="GateDataTable">
                                        <thead class="bg-gradient card-headerBG text-light small" style="white-space:nowrap" id="dashGateThead">
                                            <tr>
                                                <th>Action</th>
                                                <th>Add <input id="CheckUnCheckAll" class="form-check-input me-1 mt-2" type="checkbox" role="switch" /></th>
                                                <th data-columnno="2" data-sortorder="asc" class="sortCol"><span style="padding:5px;margin:5px" class="sort-icon"><i class="fa" aria-hidden="true"></i></span>Sr#</th>
                                                <th data-columnno="3" data-sortorder="asc" class="sortCol"><span style="padding:5px;margin:5px" class="sort-icon"><i class="fa" aria-hidden="true"></i></span>Voucher Type</th>
                                                <th data-columnno="4" data-sortorder="asc" class="sortCol"><span style="padding:5px;margin:5px" class="sort-icon"><i class="fa" aria-hidden="true"></i></span>Voucher No</th>
                                                <th data-columnno="5" data-sortorder="asc" class="sortCol"><span style="padding:5px;margin:5px" class="sort-icon"><i class="fa" aria-hidden="true"></i></span>Invoice No</th>
                                                <th data-columnno="6" data-sortorder="asc" class="sortCol"><span style="padding:5px;margin:5px" class="sort-icon"><i class="fa" aria-hidden="true"></i></span>Voucher Date</th>
                                                <th data-columnno="7" data-sortorder="asc" class="sortCol"><span style="padding:5px;margin:5px" class="sort-icon"><i class="fa" aria-hidden="true"></i></span>Due Date</th>
                                                <th data-columnno="8" data-sortorder="asc" class="sortCol"><span style="padding:5px;margin:5px" class="sort-icon"><i class="fa" aria-hidden="true"></i></span>Balance</th>
                                                <th data-columnno="9" data-sortorder="asc" class="sortCol"><span style="padding:5px;margin:5px" class="sort-icon"><i class="fa" aria-hidden="true"></i></span>Type</th>
                                                <th data-columnno="10" data-sortorder="asc" class="sortCol"><span style="padding:5px;margin:5px" class="sort-icon"><i class="fa" aria-hidden="true"></i></span>Adj Amt</th>
                                                <th data-columnno="11" data-sortorder="asc" class="sortCol"><span style="padding:5px;margin:5px" class="sort-icon"><i class="fa" aria-hidden="true"></i></span>Adjusted</th>
                                                <th data-columnno="12" data-sortorder="asc" class="sortCol"><span style="padding:5px;margin:5px" class="sort-icon"><i class="fa" aria-hidden="true"></i></span>Dr Amt</th>
                                                <th data-columnno="13" data-sortorder="asc" class="sortCol"><span style="padding:5px;margin:5px" class="sort-icon"><i class="fa" aria-hidden="true"></i></span>Cr Amt</th>
                                                <th data-columnno="14" data-sortorder="asc" class="sortCol"><span style="padding:5px;margin:5px" class="sort-icon"><i class="fa" aria-hidden="true"></i></span>YearCode</th>
                                                <th data-columnno="15" data-sortorder="asc" class="sortCol"><span style="padding:5px;margin:5px" class="sort-icon"><i class="fa" aria-hidden="true"></i></span>BillNet Amt</th>
                                                <th data-columnno="16" data-sortorder="asc" class="sortCol"><span style="padding:5px;margin:5px" class="sort-icon"><i class="fa" aria-hidden="true"></i></span>>New RefNo</th>
                                                <th data-columnno="17" data-sortorder="asc" class="sortCol"><span style="padding:5px;margin:5px" class="sort-icon"><i class="fa" aria-hidden="true"></i></span>Mode Of Adjust</th>
                                                <th data-columnno="18" data-sortorder="asc" class="sortCol"><span style="padding:5px;margin:5px" class="sort-icon"><i class="fa" aria-hidden="true"></i></span>Acc EntryId</th>
                                                <th data-columnno="19" data-sortorder="asc" class="sortCol"><span style="padding:5px;margin:5px" class="sort-icon"><i class="fa" aria-hidden="true"></i></span>Actual DrCr Type</th>
                                            </tr>
                                        </thead>
                                        <tbody id="divDisplayPopupForPendingVouchersDetail">
                                        
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="progress my-2" style="height: 4px;">
                        <div class="progress-bar progress-bar-striped bg-danger" role="progressbar" style="width: 100%" aria-valuenow="100" aria-valuemin="0" aria-valuemax="100"></div>
                    </div>
                    <div class="row g-2 gx-3">
                        <div class="col-12 text-center">
                            <strong>Total No Of Items : <span id="lblroutingtotal"></span></strong>
                            &nbsp;
                            <strong>Checked Rows : <span id="lblcheckitem"></span></strong>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <div class="d-flex align-items-center gap-3" style="margin-bottom:-15px">
                        <button type="button" class="btn btn-sm btn-primary" onclick="AdjustButton()" style="width:100px;">Adjust</button>
                    </div>
                    <div class="col-xl-1 col-lg-3 col-md-3 col-sm-6 col-xs-12">
                        <label asp-for="PopDrAmt" class="form-label">Dr Amt</label>
                        <input asp-for="PopDrAmt" class="form-control" readonly />
                    </div>
                    <div class="col-xl-1 col-lg-3 col-md-3 col-sm-6 col-xs-12">
                        <label asp-for="PopCrAmt" class="form-label">Cr Amt</label>
                        <input asp-for="PopCrAmt" class="form-control" readonly />
                    </div>
                    <div class="col-xl-1 col-lg-3 col-md-3 col-sm-6 col-xs-12">
                        <label asp-for="PopAdjustmentAmt" class="form-label">Adj Amt</label>
                        <input asp-for="PopAdjustmentAmt" class="form-control" readonly />
                    </div>
                    <button class="btn btn-sm btn-outline-success me-3" style="padding:3px;height:30px;width:100px;margin-top: 25px;" type="button" id="btnRoutingExcel">
                        <i class="fa-solid fa-upload fa-fw fa-lg "></i>EXCEL
                    </button>
                    <button type="button" class="btn btn-sm btn-danger" style="padding:3px;height:30px;width:100px;margin-top: 25px;" data-bs-dismiss="modal">Close</button>
                </div>
            </div> 
        </div>
    </div>
  
    
</div>*@

@section Scripts {
    <script>
        //         function Openagnstrefpopup() {
        //     $('#DisplayAdjDetailModal').modal('show');
        //     DisplayAdjustmentRefDetail();
        // }
        //             function DisplayAdjustmentRefDetail() {

        //     var DbCrPageName = $('#VoucherType').val();
        //     var DbCrPageData;
        //     var AccountCode = 0;
        //     var TransVouchType = "";
        //     if (DbCrPageName.indexOf('Sale Order') === 0) {
        //         DbCrPageData = 'ItemList';
        //     }
        //     else if (DbCrPageName.indexOf('Purchase Order') == 0) {
        //         DbCrPageData = 'PurchaseOrder';
        //     }
        //     else if (DbCrPageName.indexOf('Issue NonRetuanable') == 0) {
        //         DbCrPageData = 'IssueNRGP';
        //     }
        //     else if (DbCrPageName.indexOf('Direct Purchase Bill') == 0) {
        //         DbCrPageData = 'DirectPurchaseBill';
        //         AccountCode = $('#AccountCode').find(":selected").val();
        //         TransVouchType = "PURCHASE-DIRECT";
        //     }
        //     else if (DbCrPageName.indexOf('Purchase Bill') == 0) {
        //         DbCrPageData = 'PurchaseBill';
        //         AccountCode = $('#AccountCode').find(":selected").val();
        //         TransVouchType = "PURCHASE-DIRECT";
        //     }
        //     else if (DbCrPageName.indexOf('SALE-BILL') == 0) {
        //         DbCrPageData = 'SALE-BILL';
        //         AccountCode = $('#LedgerName').find(":selected").val();
        //         TransVouchType = "SaleInvoice";
        //     }
        //     else {
        //         DbCrPageData = '';
        //     }
        //     DbCrPageName = DbCrPageData;

        //     var yearCode = 0;
        //     var DRCR = "";
        //     var VouchDate = "";
        //     if (DbCrPageName.indexOf('SALE-BILL') == 0) {
        //         yearCode = $('#YearCode').val();
        //         DRCR = "DR";
        //         VouchDate = $('#EntryDate').val();
        //     } else {
        //         yearCode = $('#YearCode').val();
        //         DRCR = $('#AdjDrCr').val();
        //         VouchDate = $('#EntryDate').val();
        //     }
        //     if (DbCrPageData != null && DbCrPageData != undefined && DbCrPageData != '') {

        //         $('#DisplayAdjDetailModal').modal('show');
        //         $.ajax({
        //             type: "POST",
        //             url: "/Common/GetPendVouchBillAgainstRefPopupByID",
        //             dataType: "json",
        //             data: {
        //                 "AC": AccountCode, "YC": yearCode, "PayRecEntryId": 0, "PayRecYearcode": 0, "DRCR": DRCR, "TransVouchType": TransVouchType, "TransVouchDate": VouchDate
        //             },
        //             success: function (result, status, error) {
        //                 if (result != null) {
        //                     var obj = $.parseJSON(result);
        //                     var html = '';
        //                     $('#divDisplayAdjustmntDetail').empty();
        //                     var i = 1;
        //                     if (obj.AdjAdjustmentDetailGrid != null) {
        //                         $.each(obj.AdjAdjustmentDetailGrid, function (index, val) {
        //                             html += '<tr id="DisplayAdjustmntRow-' + index + '">' +
        //                                 /*'<input type="hidden" value="' + val.AdjAgnstAccEntryID + '" id="AdjAgnstAccEntryID_' + index + '" />' +*/
        //                                 '<td>' + i + '</td>' +
        //                                 '<td><input id="AgnstRefCheckbox_' + index + '"  type="checkbox" onclick="onAgnstcheckcliclunclick(' + index + ')"></td>' +
        //                                 '<td><span class="edit-icon" id="AdjAgnstRefEdit_' + index + '" onclick="AdjAgnstRefEdit(this)" data-index="' + index + '">&#9998;</span><span class="save-button" id="AdjAgnstRefSave_' + index + '" onclick="AdjAgnstRefOnGridSave(this)" data-index="' + index + '" style="display:none;background: none; border: none;">&#10004;</span></td>' +
        //                                 '<td><input id="AdjAgnstVouchNo_' + index + '" value=' + val.AdjAgnstVouchNo + ' readonly style="width:190px;background: none;border: none;white-space: break-spaces;text-overflow: ellipsis;"></td>' +
        //                                 '<td><input id="AdjAgnstVouchDate_' + index + '" value=' + formatDateToDDMMYYYY(val.AdjAgnstVouchDate) + ' readonly style="width:120px;background: none;border: none;"></td>' +
        //                                 '<td><input id="AdjAgnstModeOfAdjstment_' + index + '" value="' + val.AdjAgnstModeOfAdjstment + '" readonly style="width:120px;background: none;border: none;white-space: break-spaces;text-overflow: ellipsis;"></td>' +
        //                                 '<td><input id="AdjAgnstVouchType_' + index + '" value=' + val.AdjAgnstVouchType + ' readonly style="width:125px;background: none;border: none;white-space: break-spaces;text-overflow: ellipsis;"></td>' +
        //                                 '<td><input id="AdjAgnstPendAmt_' + index + '" value="' + val.AdjAgnstPendAmt + '" ' +
        //                                 'data-original="' + val.AdjAgnstPendAmt + '" readonly style="width:50px;background: none;border: none;"></td>' +
        //                                 '<td><input  id="AdjAgnstRemainingAmt_' + index + '" value=' + val.AdjAgnstRemainingAmt + ' readonly style="width:50px;background: none;border: none;"></td>' +
        //                                 '<td><input class="adjstedamt" id="AdjAgnstAdjstedAmt_' + index + '" value=' + val.AdjAgnstAdjstedAmt + ' style="width:50px;background: none;border: none;" onchange="ChangeAdjustAmt(' + index + ')"></td>' +
        //                                 '<td><input id="AdjAgnstDrCr_' + index + '" value=' + val.AdjAgnstDrCr + ' readonly style="width:40px;background: none;border: none;"></td>' +
        //                                 '<td><input id="AdjAgnstAccEntryIDVal_' + index + '" value=' + val.AdjAgnstAccEntryID + ' readonly style="width:50px;background: none;border: none;"></td>' +
        //                                 '<td><input id="AdjAgnstAccYearCode_' + index + '" value=' + val.AdjAgnstAccYearCode + ' readonly style="width:50px;background: none;border: none;"></td>' +
        //                                 '<td><input id="AdjAgnstOpenEntryID_' + index + '" value=' + val.AdjAgnstOpenEntryID + ' readonly style="width:50px;background: none;border: none;"></td>' +
        //                                 '<td><input id="AdjAgnstOpeningYearCode_' + index + '" value=' + val.AdjAgnstOpeningYearCode + ' readonly style="width:50px;background: none;border: none;"></td>' +
        //                                 '</tr>';
        //                             i++;
        //                         });
        //                     }
        //                     else {
        //                         html += '<tr class="text-center"><td colspan="12" class="text-black-50"><strong>NO DATA FOUND</strong></td></tr>'
        //                     }
        //                     $('#divDisplayAdjustmntDetail').append(html);
        //                     $('#AdjustmentHeaderError').hide();
        //                     var totals = CalculateTotals();
        //                     $('#TotalBillAmount').val(parseFloat($('#NetTotal').val()));
        //                     $('#TotalRemainingAmount').val(totals)
        //                     $('#PendingToAdjustAmount').val(parseFloat($('#AdjRemainingAmt1').text()))
        //                     var RowCount = $('#divDisplayAdjustmntDetail tr').length;
        //                     var TdRow = $('#divDisplayAdjustmntDetail tr td').length;

        //                     if (TdRow > 1) {
        //                         $('#AdjlblTotalNoOfItems').text(RowCount);
        //                     }
        //                 }
        //             }
        //         });
        //     }
        // }
        //                               function Agnstrefonsave() {
        //     var AdjPageName = $('#VoucherType').val();
        //     var PaymentDays = ($('#PaymentDays').val()) ? parseInt($('#PaymentDays').val()) : 0;
        //     var AdjPageData = '';

        //     if (AdjPageName.indexOf('Sale Order') === 0) AdjPageData = 'ItemList';
        //     else if (AdjPageName.indexOf('Purchase Order') === 0) AdjPageData = 'PurchaseOrder';
        //     else if (AdjPageName.indexOf('Issue NonRetuanable') === 0) AdjPageData = 'IssueNRGP';
        //     else if (AdjPageName.indexOf('SALE-BILL') === 0) AdjPageData = 'SaleInvoice';
        //     else if (AdjPageName.indexOf('Direct Purchase Bill') === 0) AdjPageData = 'DirectPurchaseBill';
        //     else if (AdjPageName.indexOf('Purchase Bill') === 0) AdjPageData = 'PurchaseBill';
        //     else AdjPageData = 'JobWorkIssue';

        //     var selectedItems1 = [];

        //     $('tr[id^="DisplayAdjustmntRow-"]').each(function () {
        //         var rowIndex = $(this).attr('id').split('-')[1];
        //         if ($('#AgnstRefCheckbox_' + rowIndex).is(':checked')) {
        //             var rawDate = $('#AdjAgnstVouchDate_' + rowIndex).val();
        //             var formattedDate = null;

        //             if (rawDate) {
        //                 // Assume rawDate is in 'DD/MM/YYYY' format
        //                 var parts = rawDate.split('/');
        //                 if (parts.length === 3) {
        //                     // Create a valid date: months are 0-based in JS
        //                     var day = parseInt(parts[0], 10);
        //                     var month = parseInt(parts[1], 10) - 1;
        //                     var year = parseInt(parts[2], 10);

        //                     var dateObj = new Date(year, month, day);
        //                     if (!isNaN(dateObj.getTime())) {
        //                         formattedDate = dateObj.toISOString();
        //                     }
        //                 }
        //             }

        //             console.log(formattedDate);

        //             // Push a full AdjustmentModel object into the list
        //             selectedItems1.push({
        //                 AdjAgnstAccEntryID: parseInt($('#AdjAgnstAccEntryIDVal_' + rowIndex).val()),
        //                 AdjAgnstAccYearCode: parseInt($('#AdjAgnstAccYearCode_' + rowIndex).val()),
        //                 AdjAgnstOpenEntryID: parseInt($('#AdjAgnstOpenEntryID_' + rowIndex).val()),
        //                 AdjAgnstOpeningYearCode: parseInt($('#AdjAgnstOpeningYearCode_' + rowIndex).val()),
        //                 AdjAgnstVouchNo: $('#AdjAgnstVouchNo_' + rowIndex).val(),
        //                 AdjAgnstVouchDate: formattedDate,
        //                 AdjDescription: $('#AdjDescription').val(),
        //                 AdjNewRefNo: $('#AdjNewRefNo').val(),
        //                 AdjAgnstModeOfAdjstment: "AgainstRef",
        //                 AdjAgnstVouchType: $('#AdjAgnstVouchType_' + rowIndex).val(),
        //                 AdjAgnstPendAmt: parseFloat($('#AdjAgnstPendAmt_' + rowIndex).val()) || 0,
        //                 AdjAgnstRemainingAmt: parseFloat($('#AdjAgnstRemainingAmt_' + rowIndex).val()) || 0,
        //                 AdjAgnstAdjstedAmt: parseFloat($('#AdjAgnstAdjstedAmt_' + rowIndex).val()) || 0,
        //                 AdjAgnstDrCr: $('#AdjAgnstDrCr_' + rowIndex).val(),
        //                 AdjPageName: AdjPageData
        //             });
        //         }
        //     });

        //     // Parent AdjustmentModel
        //     var model = {
        //         AdjPageName: AdjPageData,
        //         AdjAgnstModeOfAdjstment: "AgainstRef",
        //         AdjAdjustmentDetailGrid: selectedItems1
        //     };

        //     console.log("Payload:", JSON.stringify(model, null, 2));

        //     $.ajax({
        //         type: "POST",
        //         url: '/AgainstAdjustVoucher/AddAgnstRefToAdjstmntDetail',
        //         data: JSON.stringify(model),
        //         contentType: 'application/json; charset=utf-8',
        //         dataType: 'json',
        //                 success: function (resp) {
        //     console.log('Saved successfully', resp);
        //     $('#DisplayAdjDetailModal').modal('hide');
        //     $('#AdjModeOfAdjstment').val("NewRef").trigger('change');

        //     // Clear current table body
            

        //     // Populate table dynamically from returned JSON
        //     if (resp && resp.length > 0) {
        // //         resp.forEach(function (item, index) {
        // //             var voucherDate = item.AdjAgnstVouchDate ? new Date(item.AdjAgnstVouchDate).toLocaleDateString() : '';
        // //                     var ledgerVal = $("#LedgerName").val(); // get selected value
        // // var ledgerText = $("#LedgerName option:selected").text(); // get selected text
        // //             var rowHtml = '<tr class="small" style="white-space:nowrap" data-srno="' + (index + 1) + '">' +
        // //                 '<td><select class="form-control type-select" style="width:50px;">' +
        // //                 '<option value="DR"' + (item.adjAgnstDrCr === 'DR' ? ' selected' : '') + '>DR</option>' +
        // //                 '<option value="CR"' + (item.adjAgnstDrCr === 'CR' ? ' selected' : '') + '>CR</option>' +
        // //                 '</select></td>' +

        // //                 '<td>' +
        // //                 '<input type="hidden" value="' + (ledgerVal|| '') + '" />' +
        // //                 '<input type="hidden" value="' + (item.BankType || '') + '" />' +
        // //                   '<select class="form-control ledger-select" style="width:250px;">' +
        // //                     '<option value="' + ledgerVal + '" selected>' + ledgerText + '</option>' +
        // //                     '</select></td>' +
        // //                 '<td>' +
        // //                 '<div class="d-flex align-items-center">' +
        // //                 '<input class="form-control me-2" style="width:70px;" readonly value="' + (item.Balance || 0) + '" />' +
        // //                 '<input class="form-control" style="width:50px;" readonly value="' + (item.DRCR || '') + '" />' +
        // //                 '</div></td>' +

        // //                 '<td><select class="form-control mode-select" style="width:100px;">' +
        // //                 '<option value="' + (item.adjModeOfAdjstment || '') + '" selected>' + (item.adjModeOfAdjstment || '') + '</option>' +
        // //                 '</select></td>' +

        // //                 '<td><input class="form-control adjamt-input" type="number" min="0" style="width:70px;" value="' + (item.adjAgnstPendAmt || 0) + '" /></td>' +
        // //                 '<td><input class="form-control" readonly value="' + (item.adjAgnstPendAmt || 0) + '" /></td>' +

        // //                 '<td><input type="hidden" value="' + (item.CostCenterId || 0) + '" />' +
        // //                 '<select class="form-control costcenter-select" style="width:140px;">' +
        // //                 '<option value="' + (item.CostCenterId || 0) + '">' + (item.CostCenterName || '') + '</option>' +
        // //                 '</select></td>' +

        // //                 '<td><input class="form-control" value="' + (item.PartyWiseNaration || '') + '" /></td>' +
        // //                 '<td><input class="form-control" readonly value="' + (item.adjAgnstVouchNo || '') + '" /></td>' +
        // //                 '<td><input class="form-control" readonly value="' + (item.adjAgnstAccYearCode || 0) + '" /></td>' +
        // //                 '<td><input class="form-control" readonly value="' + (item.adjAgnstVouchDate || '')  + '" /></td>' +
        // //                 '<td><input class="form-control" readonly value="' + (item.adjAgnstVouchType || '') + '" /></td>' +
        // //                 '<td><input class="form-control" readonly value="' + (item.adjAgnstAccEntryID || 0) + '" /></td>' +
        // //                 '<td><input class="form-control" readonly value="' + (item.VoucherBillAmt || 0) + '" /></td>' +
        // //                 '<td><input class="form-control" readonly value="' + (item.PendBillAmt || 0) + '" /></td>' +
        // //                 '</tr>';

        // //             $('#divBankReceipt').append(rowHtml);
        // //         });
        //         resp.forEach(function (item, index) {
        //     var voucherDate = item.AdjAgnstVouchDate ? new Date(item.AdjAgnstVouchDate).toLocaleDateString() : '';
        //     var ledgerVal = $("#LedgerName").val(); // get selected value
        //     var ledgerText = $("#LedgerName option:selected").text(); // get selected text

        //     var rowHtml = '<tr class="small" style="white-space:nowrap" data-srno="' + (index + 1) + '">' +
        //         // DR/CR select
        //         '<td><select class="form-control type-select" style="width:50px;" name="AgainstAdjustVoucherList[' + index + '].Type">' +
        //         '<option value="DR"' + (item.adjAgnstDrCr === 'DR' ? ' selected' : '') + '>DR</option>' +
        //         '<option value="CR"' + (item.adjAgnstDrCr === 'CR' ? ' selected' : '') + '>CR</option>' +
        //         '</select></td>' +

        //         // Ledger & BankType
        //         '<td>' +
        //         '<input type="hidden" name="AgainstAdjustVoucherList[' + index + '].LedgerName" value="' + (ledgerVal || '') + '" />' +
        //         '<input type="hidden" name="AgainstAdjustVoucherList[' + index + '].BankType" value="' + (item.BankType || '') + '" />' +
        //         '<select class="form-control ledger-select" style="width:250px;" name="AgainstAdjustVoucherList[' + index + '].LedgerName">' +
        //         '<option value="' + ledgerVal + '" selected>' + ledgerText + '</option>' +
        //         '</select></td>' +

        //         // Balance & DRCR
        //         '<td>' +
        //         '<div class="d-flex align-items-center">' +
        //         '<input class="form-control me-2" style="width:70px;" readonly name="AgainstAdjustVoucherList[' + index + '].Balance" value="' + (item.Balance || 0) + '" />' +
        //         '<input class="form-control" style="width:50px;" readonly name="AgainstAdjustVoucherList[' + index + '].DRCR" value="' + (item.DRCR || '') + '" />' +
        //         '</div></td>' +

        //         // ModeOfAdjustment
        //         '<td><select class="form-control mode-select" style="width:100px;" name="AgainstAdjustVoucherList[' + index + '].ModeOfAdjustment">' +
        //         '<option value="' + (item.adjModeOfAdjstment || '') + '" selected>' + (item.adjModeOfAdjstment || '') + '</option>' +
        //         '</select></td>' +

        //         // AdjustmentAmt
        //         '<td><input class="form-control adjamt-input" type="number" min="0" style="width:70px;" name="AgainstAdjustVoucherList[' + index + '].AdjustmentAmt" value="' + (item.adjAgnstPendAmt || 0) + '" /></td>' +
        //         '<td><input class="form-control" readonly name="AgainstAdjustVoucherList[' + index + '].AdjustmentAmtOthCur" value="' + (item.adjAgnstPendAmt || 0) + '" /></td>' +

        //         // CostCenter
        //         '<td>' +
        //         '<input type="hidden" name="AgainstAdjustVoucherList[' + index + '].CostCenterId" value="' + (item.CostCenterId || 0) + '" />' +
        //         '<select class="form-control costcenter-select" style="width:140px;" name="AgainstAdjustVoucherList[' + index + '].CostCenterName">' +
        //         '<option value="' + (item.CostCenterId || 0) + '">' + (item.CostCenterName || '') + '</option>' +
        //         '</select></td>' +

        //         // PartyWiseNaration
        //         '<td><input class="form-control" name="AgainstAdjustVoucherList[' + index + '].PartyWiseNaration" value="' + (item.PartyWiseNaration || '') + '" /></td>' +

        //         // Readonly fields
        //         '<td><input class="form-control" readonly name="AgainstAdjustVoucherList[' + index + '].AgainstVoucherNo" value="' + (item.adjAgnstVouchNo || '') + '" /></td>' +
        //         '<td><input class="form-control" readonly name="AgainstAdjustVoucherList[' + index + '].AgainstVoucherCode" value="' + (item.adjAgnstAccYearCode || 0) + '" /></td>' +
        //         '<td><input class="form-control" readonly name="AgainstAdjustVoucherList[' + index + '].AgainstVoucherDate" value="' + (item.adjAgnstVouchDate || '') + '" /></td>' +
        //         '<td><input class="form-control" readonly name="AgainstAdjustVoucherList[' + index + '].AgainstVoucherType" value="' + (item.adjAgnstVouchType || '') + '" /></td>' +
        //         '<td><input class="form-control" readonly name="AgainstAdjustVoucherList[' + index + '].AgainstVoucherEntryId" value="' + (item.adjAgnstAccEntryID || 0) + '" /></td>' +
        //         '<td><input class="form-control" readonly name="AgainstAdjustVoucherList[' + index + '].VoucherBillAmt" value="' + (item.adjAgnstPendAmt || 0) + '" /></td>' +
        //         '<td><input class="form-control" readonly name="AgainstAdjustVoucherList[' + index + '].PendBillAmt" value="' + (item.adjAgnstPendAmt || 0) + '" /></td>' +
        //         '</tr>';

        //     $('#divBankReceipt').append(rowHtml);
        // });

        //     } else {
        //         $('#divBankReceipt').html('<tr><td colspan="15" class="text-center">No adjustment details found</td></tr>');
        //     }
        // },

        //         error: function (error) {
        //             console.log('Save failed', error);
        //         }
        //     });
        // }

                function Validate_Submit() {

                            var Err = 0;
                            var DrAmt = parseFloat($('#DrAmt').val()) || 0;
                            var CrAmt = parseFloat($('#CrAmt').val()) || 0;

                            // if (DrAmt != CrAmt) {
                            //     $.notify("DrAmt and CrAmt must be equal to proceed.", "error");
                            //     Err = 1;
                            // }

                            var Row = $('#divBankReceiptDetail tr').length;
                            if ($('#divBankReceiptDetail tr').text().trim() == "NO DATA ADDED") {
                                $.notify("Grid should have at least one item.", "error");
                                Err = 1;
                            }

                            // Collect unique ledger (party) names
                            let partySet = new Set();
                            $("[id^='GridLedgerName-']").each(function () {
                                var partyName = $(this).text().trim();
                                if (partyName) {
                                    partySet.add(partyName);
                                }
                            });

                            // if (partySet.size === 1) {
                            //     $.notify("Same party Dr & Cr with same amount is not feasible add at least one more ledger", "error");
                            //     Err = 1;
                            // }

                            // Existing validation for ModeOfAdjustment
                            // for (let i = 1; i <= Row; i++) {
                            //     var ModeOfAdjust = $('#ModeOfAdjustment-' + i).text();
                            //     if (ModeOfAdjust == "Against Ref") {
                            //         CheckAmountBeforeSave(i);
                            //     }
                            // }

                            Err == 1 ? ShowErrorFld('H_SAGrid') : HideErrorFld('H_SAGrid');
                            return Err === 0;
                        }

                        $('.submitBTN').click(function (e) {

                            e.preventDefault();
                            if (!Validate_Submit()) return;
                            $('form').submit();
                        });

                                               function ChangeAdjustAmount() {
                                    var rowCount = $('#divDisplayPopupForPendingVouchersDetail tr').length;
                                    var AdjustQtyStr = $('#AdjustAmount').val();

                                    // Step 1: Validation
                                    if (AdjustQtyStr.includes('-')) return;
                                    var AdjustQty = parseFloat(AdjustQtyStr);
                                    if (isNaN(AdjustQty) || AdjustQty <= 0) return;

                                    // Step 2: Store original balances (only once)
                                    for (let i = 1; i <= rowCount; i++) {
                                        const $bal = $('#BalanceAmt-' + i);
                                        if ($bal.data('original') === undefined) {
                                            const original = parseFloat($bal.text());
                                            $bal.data('original', original);
                                        }
                                    }

                                    // Step 3: Reset all rows to original state
                                    for (let i = 1; i <= rowCount; i++) {
                                        const $bal = $('#BalanceAmt-' + i);
                                        const $adjAmt = $('#AdjustAmt-' + i);
                                        const $chk = $('#CheckUnCheck-' + i);
                                        const original = parseFloat($bal.data('original'));

                                        $bal.text(original.toFixed(2));
                                        $adjAmt.val("0.00");
                                        $chk.prop('checked', false);

                                        // Reset background color of full row to white
                                        $('#AdjustData-' + i).css("background-color", "");
                                    }

                                    // Step 4: Distribute AdjustAmount
                                    let RemainingQty = AdjustQty;

                                    for (let i = 1; i <= rowCount; i++) {
                                        if (RemainingQty <= 0) break;

                                        const $bal = $('#BalanceAmt-' + i);
                                        const $adjAmt = $('#AdjustAmt-' + i);
                                        const $chk = $('#CheckUnCheck-' + i);
                                        const original = parseFloat($bal.data('original'));

                                        if (isNaN(original) || original <= 0) continue;

                                        const adjustHere = Math.min(RemainingQty, original);
                                        RemainingQty -= adjustHere;

                                        $chk.prop('checked', true);
                                        $adjAmt.val(adjustHere.toFixed(2));
                                        $bal.text((original - adjustHere).toFixed(2));

                                        // Optional: highlight adjusted rows (light blue)
                                        $('#AdjustData-' + i).css("background-color", "");

                                        CheckUnCheckCheck(i);
                                    }

                                    // Step 5: Ensure background color of unchecked rows is white
                                    for (let i = 1; i <= rowCount; i++) {
                                        if (!$('#CheckUnCheck-' + i).is(':checked')) {
                                            $('#AdjustData-' + i).css("background-color", "");
                                        }
                                    }
                                }

                        $(document).ready(function () {
                            $('#VoucherType').select2();
                            $('#Intrument').select2();
                            $('#LedgerName').select2();
                            $('#ModeOfAdjustment').select2();
                            $('#CostCenterName').select2();
                                    $('#VoucherNo').select2();
                                    $('#InVoiceNo').select2();
                            FillCostCenterName();
                                    FillVoucherType();
                         // FillInvoiceNo();
                         //         FillVoucherNo();
                            BindModeOfAdjust();
                            FillLedgerName();
                            FillAccountName();
                                $('#VoucherType').change(function () {
                                FillVoucherNo();
                                            FillInvoiceNo();
                                    });
                                $('#LedgerName').change(function () {
                                FillVoucherNo();
                               FillInvoiceNo();
                                  });
                                $('#VoucherNo').change(function () {
                                            FillInvoiceNo();
                                });
                               $('#InVoiceNo').change(function () {
                                    GetAccEntryId() ;
                                   GetAdjustedData();
                                });

                            $('#CostCenterName').change(function () {
                                $('#CostCenterId').val($('#CostCenterName').val());
                            });
                                     if ($('#Mode').val() != "U" && $('#Mode').val() != "V") {
                                                       var FromDate = $('#FromDate').val().split(" ")[0];
                        var ToDate = $('#ToDate').val().split(" ")[0];

                        var fromDateObj = new Date(FromDate);
                        var toDateObj = new Date(ToDate);

                        $('#FromDate').datepicker({ dateFormat: 'dd/mm/yy' }).datepicker("setDate", fromDateObj);
                        $('#ToDate').datepicker({ dateFormat: 'dd/mm/yy' }).datepicker("setDate", toDateObj);

                                    } else {
                                        //         var FromDate = $('#FromDate').val().split(" ")[0].replace(/-/g, "/");
                                        // var ToDate = $('#EffectiveTill').val().split(" ")[0].replace(/-/g, "/");
                                        //                 $('#FromDate').datepicker({ dateFormat: 'dd/mm/yy' }).datepicker("setDate", FromDate);
                                        //                 $('#ToDate').datepicker({ dateFormat: 'dd/mm/yy' }).datepicker("setDate", ToDate);

                                    }
                            $('#LedgerName').rules("remove", "required");
                            $('#DRCR').rules("remove", "required");
                            $('#Intrument').rules("remove", "required");
                            $('#InsNo').rules("remove", "required");
                            $('#InsDate').rules("remove", "required");
                            $('#ModeOfAdjustment').rules("remove", "required");
                            $('#AdjustmentAmt').rules("remove", "required");
                            $('#AdjustmentAmtOthCur').rules("remove", "required");
                            $('#CostCenterName').rules("remove", "required");
                            $('#PartyWiseNaration').rules("remove", "required");
                            $('#SoDate').rules("remove", "required");
                            $('#SONo').rules("remove", "required");
                            $('#SOYear').rules("remove", "required");
                            $('#SeqNo').rules("remove", "required");
                            $('#CustOrderNo').rules("remove", "required");
                            $('#AgainstVoucherNo').rules("remove", "required");
                            $('#AgainstVoucherDate').rules("remove", "required");
                            $('#AgainstVoucheryearCode').rules("remove", "required");
                            $('#AgainstVoucherType').rules("remove", "required");
                            $('#AgainstVoucherEntryId').rules("remove", "required");
                            $('#VoucherBillAmt').rules("remove", "required");
                            $('#PendBillAmt').rules("remove", "required");
                            $('#Branch').rules("remove", "required");
                            $('#EntryId').rules("remove", "required");
                            $('#EntryDate').rules("remove", "required");
                            $('#YearCode').rules("remove", "required");
                            $('#SubVoucherName').rules("remove", "required");
                            $('#VoucherNo').rules("remove", "required");
                            $('#VoucherDate').rules("remove", "required");
                            $('#Currency').rules("remove", "required");
                            $('#ExRate').rules("remove", "required");
                            $('#BankRECO').rules("remove", "required");
                            $('#Balance').rules("remove", "required");
                            $('#InsDate').rules("remove", "required");
                            $('#AdjustmentAmt').rules("remove", "required");
                            $('#AdjustmentAmtOthCur').rules("remove", "required");
                            $('#SoDate').rules("remove", "required");
                            $('#SOYear').rules("remove", "required");
                            $('#AgainstVoucherNo').rules("remove", "required");
                            $('#AgainstVoucherDate').rules("remove", "required");
                            $('#AgainstVoucheryearCode').rules("remove", "required");
                            $('#AgainstVoucherEntryId').rules("remove", "required");
                            $('#VoucherBillAmt').rules("remove", "required");
                            $('#PendBillAmt').rules("remove", "required");
                            $('#PRODSTATUSProdUnProdRej').rules("remove", "required");
                            $('#PRODSTATUSProdUnProdRej').rules("remove", "required");

                                     if ($('#Mode').val() != "U" && $('#Mode').val() != "V") {

                                                var date = $('#EntryDate').datepicker({ dateFormat: 'dd/mm/yy' }).datepicker("setDate", 'now');
                                    var VoucherDate = $('#VoucherDate').datepicker({ dateFormat: 'dd/mm/yy' }).datepicker("setDate", 'now');
                                    var AgainstVoucherDate = $('#AgainstVoucherDate').datepicker({ dateFormat: 'dd/mm/yy' }).datepicker("setDate", 'now');
                                    var soDate = $('#SoDate').datepicker({ dateFormat: 'dd/mm/yy' }).datepicker("setDate", 'now');
                                                  FillEntryID();
                                    }
                                    var finFromDate = $('#FromDate').val();
                                var finToDate = $('#ToDate').val();

                                var dateParts1 = finFromDate.split("/");
                                var monthNames = {
                                    "Jan": "01",
                                    "Feb": "02",
                                    "Mar": "03",
                                    "Apr": "04",
                                    "May": "05",
                                    "Jun": "06",
                                    "Jul": "07",
                                    "Aug": "08",
                                    "Sep": "09",
                                    "Oct": "10",
                                    "Nov": "11",
                                    "Dec": "12"
                                };

                                var formattedDate1 = dateParts1[0] + "/" + monthNames[dateParts1[1]] + "/" + dateParts1[2];
                                var dateParts2 = finToDate.split("/");

                                var formattedDate2 = dateParts2[0] + "/" + monthNames[dateParts2[1]] + "/" + dateParts2[2];

                                     $('#EntryDate').on('change', function () {
                                    var entryDateVal = $(this).val(); // Get selected EntryDate
                                    $('#VoucherDate').datepicker("setDate", entryDateVal); // Set same date in VoucherDate
                                        //   FillEntryID();
                                                            $('#divBankReceiptDetail').empty()
                                });
                                $('#VoucherDate').on('change', function () {
                                    var voucherDateVal = $(this).val(); // Get selected EntryDate
                                    $('#EntryDate').datepicker("setDate", voucherDateVal); // Set same date in VoucherDate
                                        //    FillEntryID();
                                                        $('#divBankReceiptDetail').empty()
                                });
                            $('#EntryDate,#VoucherDate,#AgainstVoucherDate,#SoDate').datepicker("option", "minDate", parseDateToFormat(formattedDate1));
                            $('#EntryDate,#VoucherDate,#AgainstVoucherDate,#SoDate').datepicker("option", "maxDate", parseDateToFormat(formattedDate2));

                            var currentDate = new Date();

                            $('#ActualEntryDate').datepicker({
                                dateFormat: 'dd/mm/yy',
                                minDate: currentDate,
                                maxDate: currentDate
                            }).datepicker("setDate", currentDate);


                            //$('#BankRECO').datepicker({ dateFormat: 'dd/mm/yy' });
                            var BankRecoDate = $('#BankRECO').val();
                            if (BankRecoDate === "01/01/1900") {
                                $('#BankRECO').val("");
                            }

                            if ($('#Mode').val() == "U" || $('#Mode').val() == "V") {

                            }
                            $('#AdjustmentAmt').on('input', function () {

                                let adjustmentAmt = $(this).val();
                                $('#AdjustmentAmtOthCur').val(adjustmentAmt);
                            });
                            $("#AdjustmentAmtOthCur").on("input", function () {
                                var value = $(this).val();

                                if (!/^\d+$/.test(value)) {
                                    $.notify("Adjustment amount must be a positive number.", "error");

                                    $(this).val('');
                                }
                            });

                            function checkModeOfAdjustment() {

                                const modeOfAdjustment = $("#ModeOfAdjustment").val(); // Assuming this is the ID of the field
                                // Show/Hide Advance Fields
                                if (modeOfAdjustment === "Advance") {
                                    $("#advanceFieldsSOYear").show();
                                    $("#advanceFieldsSeqNo").show();
                                    $("#advanceFieldsCustOrderNo").show();
                                    $("#againstFieldsVoucherNo").hide();
                                    $("#againstFieldsVoucherDate").hide();
                                    $("#againstFieldsVoucheryearCode").hide();
                                    $("#againstFieldsVoucherType").hide();
                                    $("#againstFieldsVoucherEntryId").hide();
                                    $("#againstFieldsVoucherBillAmt").hide();
                                    $("#againstFieldsVoucherPendAmt").hide();
                                    $('#CustOrderNo').prop('disabled', false);
                                    $('#SoNo').prop('disabled', false);
                                    $('#SOYear').prop('disabled', false);
                                }
                                // Show/Hide Against Fields
                                else if (modeOfAdjustment === "Against Ref") {
                                    if ($('#BankType').val() == "Bank" && $('#ModeOfAdjustment').find(":selected").text() == "Against Ref") {
                                        $('#DisplayRoutingDetailModal').modal('hide');
                                    }
                                    $("#againstFieldsVoucherNo").show();
                                    $("#againstFieldsVoucherDate").show();
                                    $("#againstFieldsVoucheryearCode").show();
                                    $("#againstFieldsVoucherType").show();
                                    $("#againstFieldsVoucherEntryId").show();
                                    $("#againstFieldsVoucherBillAmt").show();
                                    $("#againstFieldsVoucherPendAmt").show();
                                    $("#advanceFieldsSOYear").hide();
                                    $("#advanceFieldsSeqNo").hide();
                                    $("#advanceFieldsCustOrderNo").hide();
                                    $('#CustOrderNo').prop('disabled', true);
                                    $('#SoNo').prop('disabled', true);
                                    $('#SOYear').prop('disabled', true);
                                    if ($('#LedgerName').prop('selectedIndex') == 0) {
                                        $.notify("Please select LedgerName First..!", "error");
                                    }
                                    else {
                                        PopUpForPendingVouchers("AddMode");
                                    }
                                }
                                // Hide all fields for other values
                                else {
                                    $("#advanceFieldsSOYear").hide();
                                    $("#advanceFieldsSeqNo").hide();
                                    $("#advanceFieldsCustOrderNo").hide();
                                    $("#againstFieldsVoucherNo").hide();
                                    $("#againstFieldsVoucherDate").hide();
                                    $("#againstFieldsVoucheryearCode").hide();
                                    $("#againstFieldsVoucherType").hide();
                                    $("#againstFieldsVoucherEntryId").hide();
                                    $("#againstFieldsVoucherBillAmt").hide();
                                    $("#againstFieldsVoucherPendAmt").hide();
                                    $('#CustOrderNo').prop('disabled', true);
                                    $('#SoNo').prop('disabled', true);
                                    $('#SOYear').prop('disabled', true);
                                }
                                if ($("#AccountCode").val() != "" && $("#ModeOfAdjustment").val() == "Advance") {

                                    FillSONO();
                                }


                            }
                            $("#SONo").on("change", function () {
                                GetSOYear();
                                GetSODate();
                            });
                            $("#ModeOfAdjustment").on("change", function () {
                                checkModeOfAdjustment();
                            });



                            // Initial check on page load
                            checkModeOfAdjustment();
                                                    let lastEnterTime = 0;
                        const doubleEnterThreshold = 400; // milliseconds

                        document.addEventListener("keydown", function (e) {
                            if (e.key === "Enter") {
                                const now = Date.now();

                                const active = document.activeElement;

                                // Let Select2 handle selection first
                                if ($('.select2-container--open').length) {
                                    return;
                                }

                                e.preventDefault();

                                const form = document.querySelector("form");

                                const focusable = Array.from(form.querySelectorAll("input, select, textarea"))
                                    .filter(el =>
                                        el.offsetParent !== null &&
                                        el.type !== "hidden" &&
                                        !el.disabled &&
                                        !el.readOnly
                                    );

                                let current = active;
                                if (current.classList.contains("select2-selection") || current.closest(".select2-selection")) {
                                    const container = current.closest(".select2-container");
                                    if (container && container.previousElementSibling) {
                                        current = container.previousElementSibling;
                                    }
                                }

                                const index = focusable.indexOf(current);

                                // Double Enter pressed
                                if (now - lastEnterTime < doubleEnterThreshold) {
                                    // Trigger GridButton click
                                    const gridBtn = document.querySelector(".GridButton");
                                    if (gridBtn) gridBtn.click();
                                    lastEnterTime = 0; // reset
                                    return;
                                }

                                lastEnterTime = now;

                                // Move to next field
                                if (index > -1 && index < focusable.length - 1) {
                                    let next = focusable[index + 1];
                                    next.focus();

                                    if (next.classList.contains("select2-hidden-accessible")) {
                                        $(next).select2("open");
                                    }
                                }
                            }
                        });

                        $(document).on('select2:select', function (e) {
                            const current = e.target;
                            const form = current.closest("form");

                            const focusable = Array.from(form.querySelectorAll("input, select, textarea"))
                                .filter(el =>
                                    el.offsetParent !== null &&
                                    el.type !== "hidden" &&
                                    !el.disabled
                                );

                            const index = focusable.indexOf(current);

                            if (index > -1 && index < focusable.length - 1) {
                                const next = focusable[index + 1];
                                setTimeout(() => {
                                    next.focus();
                                    if (next.classList.contains("select2-hidden-accessible")) {
                                        $(next).select2("open");
                                    }
                                }, 100);
                            }
                        });


                        });

                        function calculateTotalBalance() {

                            let drTotal = 0;
                            let crTotal = 0;

                            const rowCount = $('#divBankReceiptDetail tr').length;
                            for (let i = 1; i <= rowCount; i++) {

                                const drcr = $(`#Type-${i}`).text().trim();
                                const AdjAmt = parseFloat($(`#AdjAmtG-${i}`).text().trim()) || 0;

                                if (drcr.toLowerCase() === "dr") {
                                    drTotal += AdjAmt;


                                } else if (drcr.toLowerCase() === "cr") {
                                    crTotal += AdjAmt;
                                }
                            }

                            $('#DrAmt').val(drTotal.toFixed(2));
                            $('#CrAmt').val(crTotal.toFixed(2));
                            $('#VoucherAmt').val(crTotal.toFixed(2));
                        }

                        function ClearGrid() {

                       //     $('#LedgerName').prop('selectedIndex', 0).trigger("change");
                            $('#Balance').val(0);
                            $('#DRCR').val('');
                            $('#AdjustmentAmt').val(0);
                            $('#AdjustmentAmtOthCur').val(0);
                            $('#CostCenterName').prop('selectedIndex', 0).trigger("change");
                            $('#PartyWiseNaration').val('');
                        }

                        function BindModeOfAdjust() {
                            $('#ModeOfAdjustment').append(`
                                                                    <option selected value="New Ref">New Ref</option>
                                                                    <option value="Advance">Advance</option>
                                                                    <option value="Against Ref">Against Ref</option>
                                                                `);
                        }

                        $('#LedgerName').change(function () {

                            $('#AccountCode').val($('#LedgerName').val())
                            GetLedgerBalance();
                            /* BindModeOfAdjust(); */
                            CheckBankType();
                            AdjustAmountForAddToGridForDRCR();
                        });

                        function TotalNoOfRows() {

                            var Row = $('#divBankReceiptDetail tr').length;
                            var tdCount = $('#divBankReceiptDetail tr td').length;
                            if (tdCount >= 1) {
                                $('#lblTotalNoOfBelowItems').text(Row);
                            } else {
                                $('#lblTotalNoOfBelowItems').text(0);
                            }
                        }

                        function FillEntryID() {

                            var VoucherDate = $('#VoucherDate').val();

                            if (VoucherDate) {
                                var dateParts = VoucherDate.split("/"); // Split by "/"
                                if (dateParts.length === 3) {
                                    var day = dateParts[0]; // Get day
                                    var monthNumber = parseInt(dateParts[1], 10); // Convert month to number
                                    var year = dateParts[2]; // Get year

                                    // Convert month number to short month name (e.g., "Jan", "Feb", "Mar")
                                    var monthNames = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
                                    var monthShort = monthNames[monthNumber - 1]; // Get short month name

                                    // Construct new formatted date
                                    VoucherDate = `${day}/${monthShort}/${year}`;
                                } else {
                                    console.error("Invalid date format:", VoucherDate);
                                    return; // Stop execution if format is incorrect
                                }
                            }
                            $.ajax({
                                url: '@Url.Action("FillEntryID", "AgainstAdjustVoucher")',
                                type: 'POST',
                                data: { "YearCode": $('#YearCode').val(), "VoucherDate": VoucherDate },
                                async: false,
                                success: function (data, status, xhr) {
                                    var obj = $.parseJSON(data);
                                    if (obj.StatusCode == 200 && obj.StatusText === 'Success') {
                                        $('#EntryId').val(obj.Result[0].EntryId || 0);
                                        // $('#VoucherNo').val(obj.Result[0].VoucherNo || 0);
                                    }
                                },
                                error: function (xhr, status, error) {
                                  //  //alert('Failed to load Entry ID.');
                                }
                            });
                        }

                        function GetLedgerBalance() {
                            var OpeningYearCode = $('#YearCode').val();
                            var AccountCode = $('#AccountCode').val();
                            var VoucherDate = $('#EntryDate').val();
                            $.ajax({
                                url: '@Url.Action("GetLedgerBalance", "AgainstAdjustVoucher")',
                                type: 'POST',
                                data: {
                                    OpeningYearCode: OpeningYearCode,
                                    AccountCode: AccountCode,
                                    VoucherDate: VoucherDate
                                },
                                async: false,
                                success: function (data, status, xhr) {
                                    var obj = $.parseJSON(data);
                                    if (obj.StatusCode == 200 && obj.StatusText === 'Success') {

                                        $('#Balance').val(parseFloat(obj.Result[0].OpeningBal).toFixed(2));
                                        // $('#VoucherAmt').val(parseFloat(obj.Result[0].OpeningBal).toFixed(2));
                                        $('#DRCR').val(obj.Result[0].TypeDrCr);
                                    }
                                    else {
                                        $('#Balance').val(0);
                                    }
                                },
                                error: function (xhr, status, error) {
                                  //  //alert('Failed to load opening amount.');
                                }
                            });
                        }

                        $('#Type').change(function () {
                            AdjustAmountForAddToGridForDRCR();
                        })

                        function GetOpeningAmtDRCR() {
                            var OpeningYearCode = $('#YearCode').val();
                            var AccountCode = $('#AccountCode').val();
                            var VoucherDate = $('#VoucherDate').val();

                            $.ajax({
                                url: '@Url.Action("GetLedgerBalance", "AgainstAdjustVoucher")',
                                type: 'POST',
                                data: {
                                    OpeningYearCode: OpeningYearCode,
                                    AccountCode: AccountCode, VoucherDate: VoucherDate
                                },
                                async: false,
                                success: function (data, status, xhr) {
                                    var obj = $.parseJSON(data);
                                    if (obj.StatusCode == 200 && obj.StatusText === 'Success') {

                                        $('#Type').val(obj.Result[0].DrCr || 0);
                                    }
                                    else {
                                        $('#Type').val('Dr');
                                    }
                                },
                                error: function (xhr, status, error) {
                                //    //alert('Failed to load opening amount.');
                                }
                            });
                        }

                        $("#AdjustmentAmt").on("keydown", function (event) {
                            if (event.key.toLowerCase() === 'e' || event.key === '-') {
                                event.preventDefault();
                            }
                        });

                        function FillSONO() {

                            var accountcode = $('#AccountCode').val();
                            var VoucherDate = $('#VoucherDate').val();

                            if (VoucherDate) {
                                var dateParts = VoucherDate.split("/"); // Split by "/"
                                if (dateParts.length === 3) {
                                    var day = dateParts[0]; // Get day
                                    var monthNumber = parseInt(dateParts[1], 10); // Convert month to number
                                    var year = dateParts[2]; // Get year

                                    // Convert month number to short month name (e.g., "Jan", "Feb", "Mar")
                                    var monthNames = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
                                    var monthShort = monthNames[monthNumber - 1]; // Get short month name

                                    // Construct new formatted date
                                    VoucherDate = `${day}/${monthShort}/${year}`;
                                } else {
                                    console.error("Invalid date format:", VoucherDate);
                                    return; // Stop execution if format is incorrect
                                }
                            }

                            $.ajax({
                                url: '@Url.Action("FillSONO", "AgainstAdjustVoucher")',
                                type: 'POST',
                                async: false,
                                data: {

                                    accountcode: accountcode,
                                    VoucherDate: VoucherDate

                                },
                                success: function (response, status, error) {

                                    var SONoDropdown = $('#SONo');
                                    var obj = $.parseJSON(response);
                                    SONoDropdown.empty();
                                    SONoDropdown.append('<option value="">--Select--</option>');
                                    $.each(obj.Result, function (index, sono) {
                                        SONoDropdown.append('<option value="' + sono.SONO + '">' + sono.SONO + '</option>');
                                    });

                                    if ($('#Mode').val() == "U" || $('#Mode').val() == "V") {

                                        var SONo = '@Model.SONo';
                                        $('#SONo').val(SONo).trigger("change");
                                        $('#SONo').val(SONo);
                                    }
                                },
                                error: function (xhr, status, error) {
                                    ////alert('Failed to load ledger names.');
                                }
                            });
                        }

                        function GetSOYear() {
                            ;
                            var SONO = $("#SONo").val();
                            var accountcode = $("#AccountCode").val();
                            var VoucherDate = $("#VoucherDate").val();
                            if (!SONO) return;

                            if (VoucherDate) {
                                var dateParts = VoucherDate.split("/"); // Split by "/"
                                if (dateParts.length === 3) {
                                    var day = dateParts[0]; // Get day
                                    var monthNumber = parseInt(dateParts[1], 10); // Convert month to number
                                    var year = dateParts[2]; // Get year

                                    // Convert month number to short month name (e.g., "Jan", "Feb", "Mar")
                                    var monthNames = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
                                    var monthShort = monthNames[monthNumber - 1]; // Get short month name

                                    // Construct new formatted date
                                    VoucherDate = `${day}/${monthShort}/${year}`;
                                } else {
                                    console.error("Invalid date format:", VoucherDate);
                                    return; // Stop execution if format is incorrect
                                }
                            }

                            $.ajax({
                                url: '@Url.Action("GetSODetail", "AgainstAdjustVoucher")',
                                type: 'GET',
                                data: {
                                    SONO: SONO,
                                    accountcode: accountcode,
                                    VoucherDate: VoucherDate

                                },
                                success: function (data) {


                                    // Parse JSON if response is a string
                                    if (typeof data === "string") {
                                        try {
                                            data = JSON.parse(data);
                                        } catch (error) {

                                            return;
                                        }
                                    }

                                    // Extract the first result from the array
                                    if (data && data.Result && data.Result.length > 0) {
                                        var SOYear = data.Result[0]; // Extract first object
                                        var SoDate = data.Result[0];
                                        var CONO = data.Result[0];


                                        $("#SOYear").prop("disabled", false).val(SOYear.SOYearCode).trigger("input");
                                        // $("#SoDate").prop("disabled", false).val(SoDate.SODate).trigger("input");
                                        if (SoDate.SODate) {
                                            var dateObj = new Date(SoDate.SODate);
                                            var formattedDate = ("0" + dateObj.getDate()).slice(-2) + "/" +
                                                ("0" + (dateObj.getMonth() + 1)).slice(-2) + "/" +
                                                dateObj.getFullYear();
                                            $("#SoDate").prop("disabled", false).val(formattedDate).trigger("input");
                                        }
                                        $("#CustOrderNo").prop("disabled", false).val(CONO.CustOrderNo).trigger("input");


                                    } else {

                                    }
                                },
                                error: function (xhr, status, error) {
                                    console.error("Error fetching employee details:", xhr.responseText || error);

                                }
                            });
                        }

                        function GetSODate() {

                            var SONO = $("#SONo").val();
                            var accountcode = $("#AccountCode").val();
                            var VoucherDate = $("#VoucherDate").val();
                            var SOYearCode = $("#SOYear").val();
                            if (!SONO) return;
                            if (VoucherDate) {
                                var dateParts = VoucherDate.split("/"); // Split by "/"
                                if (dateParts.length === 3) {
                                    var day = dateParts[0]; // Get day
                                    var monthNumber = parseInt(dateParts[1], 10); // Convert month to number
                                    var year = dateParts[2]; // Get year

                                    // Convert month number to short month name (e.g., "Jan", "Feb", "Mar")
                                    var monthNames = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
                                    var monthShort = monthNames[monthNumber - 1]; // Get short month name

                                    // Construct new formatted date
                                    VoucherDate = `${day}/${monthShort}/${year}`;
                                } else {
                                    console.error("Invalid date format:", VoucherDate);
                                    return; // Stop execution if format is incorrect
                                }
                            }

                            $.ajax({
                                url: '@Url.Action("GetPODate", "AgainstAdjustVoucher")',
                                type: 'GET',
                                data: {
                                    PONO: PONO,
                                    accountcode: accountcode,
                                    VoucherDate: VoucherDate,
                                    POYearCode: POYearCode,
                                    PoDate: PoDate

                                },
                                success: function (data) {


                                    // Parse JSON if response is a string
                                    if (typeof data === "string") {
                                        try {
                                            data = JSON.parse(data);
                                        } catch (error) {

                                            return;
                                        }
                                    }

                                    // Extract the first result from the array
                                    if (data && data.Result && data.Result.length > 0) {
                                        var PoDate = data.Result[0]; // Extract first object


                                        $("#PoDate").prop("disabled", false).val(PoDate.PODate).trigger("input");

                                    } else {

                                    }
                                },
                                error: function (xhr, status, error) {
                                    console.error("Error fetching employee details:", xhr.responseText || error);

                                }
                            });
                        }

                        function FillCurrency() {

                            $.ajax({
                                url: '@Url.Action("FillCurrency", "AgainstAdjustVoucher")',
                                type: 'POST',
                                async: false,
                                success: function (response, status, error) {

                                    var CurrencyDropdown = $('#Currency');
                                    var obj = $.parseJSON(response);
                                    CurrencyDropdown.empty();
                                    $.each(obj.Result, function (index, Currency) {
                                        CurrencyDropdown.append('<option value="' + Currency.CurrencyId + '">' + Currency.Currency + '</option>');
                                    });
                                    $('#CurrencyId').val(parseInt($('#Currency').val()))
                                    if ($('#Mode').val() == "U" || $('#Mode').val() == "V") {

                                        var Currency = '@Model.CurrencyId';
                                        $('#Currency').val(Currency).trigger("change");
                                        $('#Currency').val(Currency);
                                    }
                                },
                                error: function (xhr, status, error) {
                                    ////alert('Failed to load ledger names.');
                                }
                            });
                        }

                        function CheckAmountBeforeSave(i) {

                            $.ajax({
                                url: '@Url.Action("CheckAmountBeforeSave", "AgainstAdjustVoucher")',
                                type: 'POST',
                                async: false,
                                data: { "VoucherDate": $('#VoucherDate').val(), "YearCode": $('#YearCode').val(), "AgainstVoucherYearCode": $('#AgainstVoucheryearCode-' + i).text(), "AgainstVoucherEntryId": $('#AgainstVoucherEntryId-' + i).text(), "AgainstVoucherNo": $('#AgainstVoucherNo-' + i).text(), "AccountCode": $('#AccountCode-' + i).val() },
                                success: function (response, status, error) {

                                    var CurrencyDropdown = $('#Currency');
                                    var obj = $.parseJSON(response);
                                    CurrencyDropdown.empty();
                                    $.each(obj.Result, function (index, Currency) {
                                        CurrencyDropdown.append('<option value="' + Currency.CurrencyId + '">' + Currency.Currency + '</option>');
                                    });
                                    $('#CurrencyId').val(parseInt($('#Currency').val()))
                                    if ($('#Mode').val() == "U" || $('#Mode').val() == "V") {

                                        var Currency = '@Model.CurrencyId';
                                        $('#Currency').val(Currency).trigger("change");
                                        $('#Currency').val(Currency);
                                    }
                                },
                                error: function (xhr, status, error) {
                                    ////alert('Failed to load ledger names.');
                                }
                            });
                        }

                        function FillLedgerName() {

                                    var ShowAll = $('#ShowAll').is(':checked') ? 'Y' : 'N';
                            $.ajax({
                                url: '@Url.Action("FillLedgerName", "AgainstAdjustVoucher")',
                                type: 'POST',
                                data: {
                                            ShowAll: ShowAll
                                },
                                async: false,
                                success: function (response, status, error) {

                                    var LedgerNameDropdown = $('#LedgerName');
                                    var obj = $.parseJSON(response);
                                    LedgerNameDropdown.empty();
                                    LedgerNameDropdown.append('<option value="">--Select--</option>');
                                    $.each(obj.Result, function (index, LedgerName) {
                                        LedgerNameDropdown.append('<option value="' + LedgerName.Account_Code + '">' + LedgerName.Account_Name + '</option>');
                                    });

                                    if ($('#Mode').val() == "U" || $('#Mode').val() == "V") {

                                        var LedgerName = '@Model.AccountCode';
                                        $('#LedgerName').val(LedgerName).trigger("change");
                                        $('#LedgerName').val(LedgerName);
                                    }
                                },
                                error: function (xhr, status, error) {
                                  //  //alert('Failed to load ledger names.');
                                }
                            });
                        }
                           function FillAccountName() {

                    var ShowAll = $('#ShowAll').is(':checked') ? 'Y' : 'N';
            $.ajax({
                url: '@Url.Action("FillLedgerName", "AgainstAdjustVoucher")',
                type: 'POST',
                data: {
                            ShowAll: ShowAll
                },
                async: false,
                success: function (response, status, error) {

                    var LedgerNameDropdown = $('#AccountCode');
                    var obj = $.parseJSON(response);
                    LedgerNameDropdown.empty();
                    LedgerNameDropdown.append('<option value="">--Select--</option>');
                    $.each(obj.Result, function (index, LedgerName) {
                        LedgerNameDropdown.append('<option value="' + LedgerName.Account_Code + '">' + LedgerName.Account_Name + '</option>');
                    });

                    if ($('#Mode').val() == "U" || $('#Mode').val() == "V") {

                        var LedgerName = '@Model.AccountCode';
                        $('#AccountCode').val(LedgerName).trigger("change");
                        $('#AccountCode').val(LedgerName);
                    }
                },
                error: function (xhr, status, error) {
                    alert('Failed to load ledger names.');
                }
            });
        }

                                function FillVoucherType() {
                            var VoucherType = $('#VoucherType').val();
                            $.ajax({
                                        url: '@Url.Action("FillVoucherType", "AgainstAdjustVoucher")',
                                type: 'POST',
                                async: false,
                                success: function (response, status, error) {
                                                    var VoucherTypeDropdown = $('#VoucherType');
                                    var obj = $.parseJSON(response);
                                    VoucherTypeDropdown.empty();

                                    $.each(obj.Result, function (index, VoucherType) {
                                                                                VoucherTypeDropdown.append('<option value="' + VoucherType.VoucherType + '">' + VoucherType.VoucherType + '</option>');
                                    });

                                    if ($('#Mode').val() == "U" || $('#Mode').val() == "V") {

                                                        var VoucherType = '@Model.VoucherType';
                                                        $('#VoucherType').val(VoucherType).trigger("change");
                                                        $('#VoucherType').val(VoucherType);
                                    }
                                },
                                error: function (xhr, status, error) {
                                  //  //alert('Failed to load SubVoucher names.');
                                }
                            });
                                }
                                function FillVoucherNo() {


                            $.ajax({
                                url: '@Url.Action("FillVoucherNo", "AgainstAdjustVoucher")',
                                type: 'POST',
                                data: {
                                            YearCode: $('#YearCode').val(), // or from session if hidden
                                                    VoucherType: $('#VoucherType').val(),
                                                    FromDate: $('#FromDate').val(),
                                                    ToDate:$('#ToDate').val(),
                                                     AccountCode: $('#LedgerName').val()

                                },
                                success: function (response) {
                                            var VoucherDropdown = $('#VoucherNo'); // better to bind numbers to a separate dropdown

                                             var obj = $.parseJSON(response);
                                                    VoucherDropdown.empty();

                                            $.each(obj.Result, function (index, VoucherType) {
                                                                                      VoucherDropdown.append('<option value="' + VoucherType.VoucherDocNo + '">' + VoucherType.VoucherDocNo + '</option>');
                                            });




                                    // If update/view mode, set default selection
                                    if ($('#Mode').val() == "U" || $('#Mode').val() == "V") {
                                                var selectedVoucher = '@Model.VoucherNo';
                                        VoucherDropdown.val(selectedVoucher).trigger("change");
                                    }
                                },
                                error: function (xhr, status, error) {
                                    ////alert('Failed to load Voucher numbers.');
                                }
                            });
                        }
                                function FillInvoiceNo() {
                            var YearCode = $('#YearCode').val();   // or from hidden/session
                            var VoucherType = $('#VoucherType').val();
                            var FromDate = $('#FromDate').val();
                            var ToDate = $('#ToDate').val();
                            var VoucherNo = $('#VoucherNo').val();
                                    var AccountCode = $('#LedgerName').val();

                            $.ajax({
                                url: '@Url.Action("FillInvoiceNo", "AgainstAdjustVoucher")',
                                type: 'POST',
                                data: {
                                    YearCode: YearCode,
                                    VoucherType: VoucherType,
                                    FromDate: FromDate,
                                    ToDate: ToDate,
                                    VoucherNo: VoucherNo,
                                    AccountCode: AccountCode
                                },
                                success: function (response) {
                                            var InvoiceDropdown = $('#InVoiceNo'); // assuming you have an InvoiceNo dropdown

                                                     var obj = $.parseJSON(response);
                                                                    InvoiceDropdown.empty();

                                                    $.each(obj.Result, function (index, VoucherType) {
                                                                                           InvoiceDropdown.append('<option value="' + VoucherType.InvoiceNo + '">' + VoucherType.InvoiceNo + '</option>');
                                                                                              $('#AccEntryId').val(VoucherType.AccEntryId);
                                                    });
                                                       
                                                   GetAdjustedData();
                                    // $.each(response, function (index, item) {
                                    //     InvoiceDropdown.append('<option value="' + item.InvoiceNo + '">' + item.InvoiceNo + '</option>');
                                    // });

                                    // If in update/view mode, preselect value
                                    if ($('#Mode').val() === "U" || $('#Mode').val() === "V") {
                                                var selectedInvoice = '@Model.InVoiceNo';
                                        InvoiceDropdown.val(selectedInvoice).trigger("change");
                                    }
                                },
                                error: function (xhr, status, error) {
                                    ////alert('Failed to load Invoice numbers.');
                                }
                            });
                        }
                                           function GetAccEntryId() {
                                                   var InvoiceNo = $("#InVoiceNo").val();
                            var YearCode = $('#YearCode').val();
                            var VoucherType = $('#VoucherType').val();
                            var VoucherNo = $('#VoucherNo').val();
                            var AccountCode = $('#LedgerName').val();

                                    $.ajax({
                                                url: '@Url.Action("GetAccEntryId", "AgainstAdjustVoucher")',
                                        type: 'POST',
                                        data: {
                                                      YearCode: YearCode,
                                        VoucherType: VoucherType,
                                        VoucherNo: VoucherNo,
                                        AccountCode: AccountCode,
                                        InvoiceNo: InvoiceNo
                                        },
                                        success: function (response) {
                                                             var obj = $.parseJSON(response);
                                                                                   $('#AccEntryId').val(obj.AccEntryId);


                                            if ($('#Mode').val() === "U" || $('#Mode').val() === "V") {
                                                                        var AccEntryId = '@Model.AccEntryId';
                                                         $('#AccEntryId').val(AccEntryId);
                                            }
                                        },
                                        error: function (xhr, status, error) {
                                            ////alert('Failed to load Invoice numbers.');
                                        }
                                    });
                                }

                        function FillIntrument() {
                            $.ajax({
                                url: '@Url.Action("FillIntrument", "AgainstAdjustVoucher")',
                                type: 'POST',
                                async: false,
                                success: function (response, status, error) {
                                    var InsDropdown = $('#Intrument');
                                    var obj = $.parseJSON(response);
                                    InsDropdown.empty();
                                    InsDropdown.append('<option value="">--Select--</option>');
                                    $.each(obj.Result, function (index, Ins) {
                                        InsDropdown.append('<option selected value="' + Ins.InstrumentName + '">' + Ins.InstrumentName + '</option>');
                                    });

                                    if ($('#Mode').val() == "U" || $('#Mode').val() == "V") {
                                        var Intrument = '@Model.Intrument';
                                        $('#Intrument').val(Intrument).trigger("change");
                                        $('#Intrument').val(Intrument);
                                    }
                                },
                                error: function (xhr, status, error) {
                                    ////alert('Failed to load ledger names.');
                                }
                            });
                        }

                        function FillCostCenterName() {
                            ;
                            $.ajax({
                                url: '@Url.Action("FillCostCenterName", "AgainstAdjustVoucher")',
                                type: 'POST',
                                async: false,
                                success: function (response, status, error) {
                                    console.log("Raw Response:", response);
                                    var CostCenterNameDropdown = $('#CostCenterName');
                                    var obj = $.parseJSON(response);
                                    CostCenterNameDropdown.empty();
                                    CostCenterNameDropdown.append('<option value="">--Select--</option>');
                                    $.each(obj.Result, function (index, CostCenter) {
                                        CostCenterNameDropdown.append('<option value="' + CostCenter.CostcenterId + '">' + CostCenter.CostCenterName + '</option>');
                                    });

                                    if ($('#Mode').val() == "U" || $('#Mode').val() == "V") {
                                        var CostCenterName = '@Model.CostCenterId';
                                        $('#CostCenterName').val(CostCenterName).trigger("change");
                                        $('#CostCenterName').val(CostCenterName);
                                    }
                                },
                                error: function (xhr, status, error) {
                                   // //alert('Failed to load ledger names.');
                                }
                            });
                        }

                        function CheckBeforeUpdate() {
                            $.ajax({
                                url: '@Url.Action("CheckBeforeUpdate")',
                                type: "POST",
                                data: { "Type": $('#Entry_id').val() },
                                success: function (data) {
                                    console.log("success");
                                    if (data != null) {
                                        var obj = $.parseJSON(data);
                                        if (obj.Result != null) {
                                            if (obj.Result.Table[0].Column1 > 0) {
                                                $.notify("You cannot update this Category as Item with this category already exists", "error");
                                            }
                                            else {
                                                $('form').submit();
                                            }
                                        }
                                    }
                                },
                                error: function (response) {
                                    //alert(response.responseText);
                                },
                                failure: function (response) {
                                    //alert(response.responseText);
                                }
                            });
                        }
                               function GetAdjustedData() {
            var InvoiceNo = $('#InVoiceNo').val();
            var YearCode = $('#YearCode').val();
            var VoucherType = $('#VoucherType').val();
            var VoucherNo = $('#VoucherNo').val();
            var AccountCode = $('#LedgerName').val();
            var AccEntryId = $('#AccEntryId').val() || 0;

            if (InvoiceNo) {
                $.ajax({
                    url: '@Url.Action("GetAdjustedData", "AgainstAdjustVoucher")',
                    type: 'POST',
                    data: {
                        YearCode: YearCode,
                        VoucherType: VoucherType,
                        VoucherNo: VoucherNo,
                        AccountCode: AccountCode,
                        InvoiceNo: InvoiceNo,
                        AccEntryId: AccEntryId
                    },
                     success: function (data, status, xhr) {
                            if (data != null) {

                                $('#divAdjItemList').empty();
                                $('#divAdjItemList').append(data);
                                GetLedgerBalance() ;

                            }

                        },
                });
            }

        }

                        function CheckBankType() {

                            $.ajax({
                                url: '@Url.Action("FillBankType", "AgainstAdjustVoucher")',
                                type: 'POST',
                                async: false,
                                data: { "AccountCode": $('#AccountCode').val(), },
                                success: function (data, status, xhr) {

                                    if (data != null) {
                                        var obj = $.parseJSON(data);
                                        if (obj.StatusCode == 200 && obj.StatusText === 'Success') {
                                            $('#BankType').val(obj.Result[0].UnderGroup);
                                            if (obj.Result[0].UnderGroup == "Bank") {
                                                $('#Type option').filter(function () {
                                                    return $(this).val() === "DR";
                                                }).prop('selected', true);
                                                $('#Type').prop('disabled', true);
                                                var options = [
                                                    { value: "New Ref", text: "New Ref" },
                                                    { value: "Advance", text: "Advance" },
                                                ];
                                                $('#ModeOfAdjustment').empty();
                                                options.forEach(option => {
                                                    $('#ModeOfAdjustment').append(`<option value="${option.value}">${option.text}</option>`);
                                                });
                                            }
                                            else {
                                                if ($('#ModeOfAdjustment').find(":selected").text() == "Against Ref") {
                                                    $('#DisplayRoutingDetailModal').modal('show');
                                                    PopUpForPendingVouchers("AddMode");
                                                }
                                                $('#Type option').filter(function () {
                                                    return $(this).val() === "CR";
                                                }).prop('selected', true);
                                                $('#Type').prop('disabled', false);
                                                $('#Type').trigger('change');
                                                var options = [
                                                    { value: "New Ref", text: "New Ref" },
                                                    { value: "Advance", text: "Advance" },
                                                    { value: "Against Ref", text: "Against Ref" },
                                                ];
                                                $('#ModeOfAdjustment').empty();
                                                options.forEach(option => {
                                                    $('#ModeOfAdjustment').append(`<option value="${option.value}">${option.text}</option>`);
                                                });
                                            }
                                        }
                                    }
                                },
                                error: function (xhr, status, error) {
                                   // //alert('Failed to load ledger names.');
                                }
                            });
                        }

                        function convertDateFormat(dateStr) {
                            let parts = dateStr.split("/");
                            return `${parts[2]}-${parts[1]}-${parts[0]}`;
                        }

                        function PopUpForPendingVouchers(Action, SrNO) {

                            $('#CheckUnCheckAll').prop('checked', false);
                            if ($('#BankType').val() == "Bank" && $('#ModeOfAdjustment').find(":selected").text() == "Against Ref") {
                                $('#DisplayRoutingDetailModal').modal('hide');
                            }
                            else {
                                $('#DisplayRoutingDetailModal').modal('show');
                            }
                            var DataTable = {};
                            if (Action == "AddMode") {
                                DataTable = { "VoucherType": $('#SubVoucherName').find(":selected").text(), "Flag": "PopupData", "SumDetail": "", "AccountCode": $('#LedgerName').val(), "YearCode": $('#YearCode').val(), "VoucherDate": convertDateFormat($('#VoucherDate').val()), "AccEntryId": $('#AccEntryId').val(), "AccYearCode": $('#YearCode').val() }
                            } else {
                                DataTable = { "VoucherType": $('#SubVoucherName').find(":selected").text(), "Flag": "PopupData", "SumDetail": "", "AccountCode": $('#AccountCode-' + SrNO).val(), "YearCode": $('#YearCode').val(), "VoucherDate": convertDateFormat($('#VoucherDate').val()), "AccEntryId": $('#AccEntryId').val(), "AccYearCode": $('#YearCode').val() };
                            }
                            $.ajax({
                                url: '@Url.Action("PopUpForPendingVouchers", "AgainstAdjustVoucher")',
                                type: 'POST',
                                async: false,
                                data: { "DataTable": DataTable },
                                success: function (data, status, xhr) {
                                    if (data != null) {

                                        $('#divDisplayPopupForPendingVouchersDetail').empty();
                                        $('#divDisplayPopupForPendingVouchersDetail').append(data);
                                        CheckUnCheckEdit();
                                        var RowCount = $('#divDisplayPopupForPendingVouchersDetail tr').length;
                                        var TdRow = $('#divDisplayPopupForPendingVouchersDetail tr td').length;

                                        if (TdRow > 1) {
                                            $('#lblroutingtotal').text(RowCount);
                                        }
                                        else {
                                            $('#divDisplayPopupForPendingVouchersDetail').empty();
                                        }
                                    }
                                    AdjustAmount();
                                },
                                error: function (xhr, status, error) {
                                    //alert('Failed to load ledger names.');
                                }
                            });
                        }

                        function AdjustAmount() {

                            var rowCount = $('#divDisplayPopupForPendingVouchersDetail tr').length;
                            var DRAmt = 0;
                            var CRAmt = 0;
                            var TotalDRAmt = 0;
                            var TotalCrAmt = 0;
                            for (var i = 1; i <= rowCount; i++) {

                                if ($('#CheckUnCheck-' + i).is(':checked') == true) {
                                    var drcr = $(`#PopUpType-${i}`).text().trim();

                                    if (drcr.toLowerCase() === "dr") {
                                        var DRAmtrow = parseFloat($(`#AdjustAmt-${i}`).val());
                                        DRAmt += DRAmtrow;
                                    } else if (drcr.toLowerCase() === "cr") {
                                        var CRAmtrow = parseFloat($(`#AdjustAmt-${i}`).val());
                                        CRAmt += CRAmtrow;
                                    }
                                }
                                var drcr = $(`#PopUpType-${i}`).text().trim();
                                var DRAmtrow = parseFloat($(`#PopUpDrAmt-${i}`).text().trim());
                                var CRAmtrow = parseFloat($(`#PopUpCrAmt-${i}`).text().trim());

                                if (drcr.toLowerCase() === "dr") {
                                    TotalDRAmt += DRAmtrow;
                                } else if (drcr.toLowerCase() === "cr") {
                                    TotalCrAmt += CRAmtrow;
                                }
                            }
                            $('#PopDrAmt').val(CRAmt.toFixed(2));
                            $('#PopCrAmt').val(DRAmt.toFixed(2));
                            $('#TotalPopDrAmt').val(TotalDRAmt.toFixed(2));
                            $('#TotalPopCrAmt').val(TotalCrAmt.toFixed(2));
                            $('#PopUpBalance').val((TotalDRAmt - TotalCrAmt).toFixed(2));
                            $('#PopAdjustmentAmt').val((DRAmt - CRAmt).toFixed(2));

                        }

                        var isEditAllowed = "false";

                        function DeleteItemRow(SeqNo, PopUpData) {

                            return new Promise((resolve, reject) => {
                                $.ajax({
                                    url: '@Url.Action("DeleteItemRow")',
                                    type: "POST",
                                    data: { "SeqNo": SeqNo, "Mode": $('#Mode').val(), "PopUpData": PopUpData },
                                    async: false,
                                    success: function (data) {

                                        if (PopUpData == "PopUpData") {
                                            $('#divDisplayPopupForPendingVouchersDetail').html(data);
                                            var RowCount = $('#divDisplayPopupForPendingVouchersDetail tr').length;
                                            $('#lblroutingtotal').text(RowCount);
                                        }
                                        else {
                                            $('#divBankReceiptDetail').html(data);
                                            var TotalRow = $('#divBankReceiptDetail tr').length;
                                            $('#lblTotalNoOfBelowItems').text(TotalRow);
                                        }
                                        calculateTotalBalance();
                                        $.notify("Item Deleted from Grid", "info");
                                        isEditAllowed = "true";
                                        resolve();
                                    },
                                    error: function (response) {
                                        reject(response.responseText);
                                    }
                                });
                            });
                        }

                        function ChangeAdjustAmt(i) {
                             ;
                            let adjustAmtInput = $('#AdjustAmt-' + i);
                            let balanceAmtLabel = $('#BalanceAmt-' + i);
                            let originalBalance = parseFloat(balanceAmtLabel.data("original")); // <-- original balance
                            if (isNaN(originalBalance)) {
                                originalBalance = parseFloat(balanceAmtLabel.text()) || 0;
                                balanceAmtLabel.data("original", originalBalance); // store first time
                            }

                            let adjustAmt = parseFloat(adjustAmtInput.val()) || 0;
                            let balanceAmt = originalBalance; // always start from original
                            let errorSpan = $('#AdjustAmtError-' + i);

                            if (adjustAmt > balanceAmt) {
                                balanceAmtLabel.text(balanceAmt.toFixed(2));
                                adjustAmtInput.val(0);
                                errorSpan.text('Adjustment amount cannot be greater than Actual Balance.').show();
                                return;
                            } else {
                                errorSpan.hide();
                            }

                            if (adjustAmt > 0) {
                                let newBalance = balanceAmt - adjustAmt;
                                balanceAmtLabel.text(newBalance.toFixed(2));
                                $('#CheckUnCheck-' + i).prop('checked', true);
                                $('#AdjustData-' + i).css("background-color", "rgb(161 184 161)");
                            } else {
                                // Reset to original balance
                                balanceAmtLabel.text(balanceAmt.toFixed(2));
                                $('#CheckUnCheck-' + i).prop('checked', false);
                                $('#AdjustData-' + i).css("background-color", "");
                            }

                            AdjustAmount();
                            CheckUnCheckCheck(i);
                        }

                        function Validate_AdjustButton() {

                            var Err = 0;
                            var RowCount = $('#lblcheckitem').text();
                            if (RowCount <= 0) {
                                $.notify("Please check at least one row to adjust", "error");
                                Err = 1;
                            }
                            if ($('#Balance').val() == 0) {
                                AddErrorCls('Balance');
                                $.notify("Balance is must be greater than 0.", "error");
                                Err = 1;
                            }
                            else {
                                RemoveErrorCls('Balance');
                            }
                            Err == 1 ? ShowErrorFld('H_SAGrid') : HideErrorFld('H_SAGrid');
                            if (Err == 1) return false;
                            return true;
                        }

                        function AdjustButton() {

                            if (!Validate_AdjustButton()) return;
                            var rowCount = $('#divDisplayPopupForPendingVouchersDetail tr').length;
                            var ItemData = [];
                            for (var i = 1; i <= rowCount + 1; i++) {

                                if ($('#CheckUnCheck-' + i).is(':checked') == true) {

                                    var type = $('#PopUpType-' + i).text().trim().toLowerCase();
                                    var adjAmt = parseFloat($('#AdjustAmt-' + i).val()) || 0; // Convert to float, default to 0

                                    var DrAmt = "0.00";
                                    var CrAmt = "0.00";

                                    if (type === "dr") {
                                        CrAmt = adjAmt.toFixed(2);
                                    } else if (type === "cr") {
                                        DrAmt = adjAmt.toFixed(2);
                                    }
                                    ItemData.push({
                                        "LedgerName": $('#LedgerName').find(":selected").text() == '--Select--' ? '' : $('#LedgerName').find(":selected").text(),
                                        "AccountCode": $('#AccountCode').val(),
                                        "Type": $('#PopUpType-' + i).text(),
                                        "Balance": $('#BalanceAmt-' + i).text(),
                                        "DRCR": $('#PopUpType-' + i).text(),
                                        "DrAmt": DrAmt,
                                        "CrAmt": CrAmt,
                                                "ActualEntryby": parseInt($('#ActualEntryby').val()),
                        "UID": parseInt($('#UID').val()),
                                        "EntryByMachine": $('#EntryByMachine').val(),
                                        "AgainstVoucherNo": $('#PopUpVoucherNo-' + i).text(),
                                        "AgainstVoucheryearCode": $('#PopUpYearCode-' + i).text(),
                                        "AgainstVoucherDate": $('#popUpVoucherDate-' + i).text(),
                                        "AgainstVoucherType": $('#PopUpVoucherType-' + i).text(),
                                        "AgainstVoucherEntryId": $('#PopUpAccEntryId-' + i).text(),
                                        "VoucherBillAmt": $('#ActualBalance-' + i).text(),
                                        "InVoiceNo": $('#PopUpInVoiceNo-' + i).text(),
                                        "PendBillAmt": $('#BalanceAmt-' + i).text(),
                                        "Intrument": $('#Intrument').find(":selected").text() == '--Select--' ? '' : $('#Intrument').find(":selected").text(),
                                        "InsNo": $('#InsNo').val(),
                                        "InsDate": $('#InsDate').val(),
                                        "CurrencyId": parseInt($('#CurrencyId').val()),
                                        "ActualEntryDate": $('#ActualEntryDate').val(),
                                        "Mode": $('#Mode').val(),
                                        "ModeOfAdjustment": $('#ModeOfAdjustment').find(":selected").text() == '--Select--' ? '' : $('#ModeOfAdjustment').find(":selected").text(),
                                        "AdjustmentAmt": $('#AdjustAmt-' + i).val(),
                                        "CostCenterName": $('#CostCenterName').find(":selected").text() == '--Select--' ? '' : $('#CostCenterName').find(":selected").text(),
                                        "CostCenterId": $('#CostCenterId').val(),
                                    })
                                }
                            }
                            $.ajax({
                                type: "POST",
                                url: '@Url.Action("AddAgainstAdjustVoucherAdjustDetail", "AgainstAdjustVoucher")',

                                data: { model: ItemData, "Mode": $('#Mode').val() },
                                success: function (result, status, xhr) {
                                    if (xhr.status == 200 && xhr.responseText == result) {
                                        $('#DisplayRoutingDetailModal').modal('hide');
                                        $('#divBankReceiptDetail').html(result);
                                        $.notify('Process Added To Grid', "success");
                                        TotalNoOfRows();
                                        calculateTotalBalance();
                                        ClearGrid();
                                    } else if (xhr.status == 207) {
                                        $.notify('Duplicate Item...!', "info");
                                    }
                                },
                                error: function () {
                                    $.notify('Something Went Wrong, Please Try Again.', "error");
                                }
                            });
                        }

                        function roundVal(val) {
                            var num = parseFloat(val);
                            if (isNaN(num)) return 0;       // if blank or invalid, return 0
                            return Math.round(num * 100) / 100;  // round to 2 decimals
                        }

                        // function Validate_GridButton() {

                        //     var Err = 0;
                        //     if ($('#Type').val() == "") {
                        //         AddErrorCls('Type');
                        //         $.notify("Type is required", "error");
                        //         Err = 1;
                        //     }
                        //     else {
                        //         RemoveErrorCls('Type');
                        //     }
                        //     if ($('#LedgerName').prop('selectedIndex') == 0) {
                        //         AddErrorCls('LedgerName');
                        //         $.notify("LedgerName is required", "error");
                        //         Err = 1;
                        //     }
                        //     else {
                        //         RemoveErrorCls('LedgerName');
                        //     }
                        //     if ($('#ModeOfAdjustment').val() == null || $('#ModeOfAdjustment').val() == "") {
                        //         AddErrorCls('ModeOfAdjustment');
                        //         $.notify("ModeOfAdjustment is required", "error");
                        //         Err = 1;
                        //     }
                        //     else {
                        //         RemoveErrorCls('ModeOfAdjustment');
                        //     }
                        //     if ($('#AdjustmentAmt').val() == 0) {
                        //         AddErrorCls('AdjustmentAmt');
                        //         $.notify("Amount must be greater than 0 in case of against ref", "error");
                        //         Err = 1;
                        //     }
                        //     else {
                        //         RemoveErrorCls('AdjustmentAmt');
                        //     }
                        //    /*  if ($('#Balance').val() == 0) {
                        //         AddErrorCls('Balance');
                        //         $.notify("Balance is must be greater than 0.", "error");
                        //         Err = 1;
                        //     }
                        //     else {
                        //         RemoveErrorCls('Balance');
                        //     } */
                        //     if ($('#ModeOfAdjustment').find(":selected").text() == "Against Ref") {
                        //         AddErrorCls('ModeOfAdjustment');
                        //         $.notify("Cannot add to grid directly.", "error");
                        //         Err = 1;
                        //     }
                        //     else {
                        //         RemoveErrorCls('ModeOfAdjustment');
                        //     }

                        //     Err == 1 ? ShowErrorFld('H_SAGrid') : HideErrorFld('H_SAGrid');
                        //     if (Err == 1) return false;
                        //     return true;
                        // }

                        // function GridButton() {
                        //     if (!Validate_GridButton()) return;
                        //     var SchData = {
                        //         "AccountCode": $('#AccountCode').val(),
                        //         "Balance": roundVal($('#Balance').val()),
                        //         "BankType": $('#BankType').val(),
                        //         "DRCR": $('#DRCR').val(),
                        //         "InsNo": $('#InsNo').val(),
                        //         "InsDate": $('#InsDate').val(),
                        //         "AdjustmentAmt": roundVal($('#AdjustmentAmt').val()),
                        //         "AdjustmentAmtOthCur": roundVal($('#AdjustmentAmtOthCur').val()),
                        //         "PartyWiseNaration": $('#PartyWiseNaration').val(),
                        //         "AgainstVoucherNo": $('#AgainstVoucherNo').val(),
                        //         "AgainstVoucherCode": $('#AgainstVoucherCode').val(),
                        //         "AgainstVoucherDate": $('#AgainstVoucherDate').val(),
                        //         "AgainstVoucherType": $('#AgainstVoucherType').val(),
                        //         "AgainstVoucherEntryId": $('#AgainstVoucherEntryId').val(),
                        //         "VoucherBillAmt": roundVal($('#VoucherBillAmt').val()),
                        //         "PendBillAmt": roundVal($('#PendBillAmt').val()),
                        //         "SeqNo": $('#SeqNo').val(),
                        //         "CustOrderNo": $('#CustOrderNo').val(),
                        //         "SoDate": $('#SoDate').val(),
                        //         "SOYear": $('#SOYear').val(),
                        //         "DrAmt": roundVal($('#DrAmt').val()),
                        //         "CrAmt": roundVal($('#CrAmt').val()),
                        //         "ActualEntryby": parseInt($('#ActualEntryby').val()),
                        //         "UID": parseInt($('#UID').val()),
                        //         "EntryByMachine": $('#EntryByMachine').val(),
                        //         "CurrencyId": parseInt($('#CurrencyId').val()),
                        //         "ActualEntryDate": $('#ActualEntryDate').val(),
                        //         "Mode": $('#Mode').val(),
                        //         "Type": $('#Type').find(":selected").text() == '-Select-' ? '' : $('#Type').find(":selected").text(),
                        //         "LedgerName": $('#LedgerName').find(":selected").text() == '--Select--' ? '' : $('#LedgerName').find(":selected").text(),
                        //         "Intrument": $('#Intrument').find(":selected").text() == '--Select--' ? '' : $('#Intrument').find(":selected").text(),
                        //         "ModeOfAdjustment": $('#ModeOfAdjustment').find(":selected").text() == '--Select--' ? '' : $('#ModeOfAdjustment').find(":selected").text(),
                        //         "CostCenterName": $('#CostCenterName').find(":selected").text() == '--Select--' ? '' : $('#CostCenterName').find(":selected").text(),
                        //         "CostCenterId": $('#CostCenterId').val(),
                        //     };

                        //     const adjAmt = parseFloat(SchData.AdjustmentAmt) || 0;
                        //     if (SchData.Type.toLowerCase() === "dr") {
                        //         SchData.DrAmt = adjAmt.toFixed(2);

                        //         SchData.CrAmt = "0.00";
                        //     } else if (SchData.Type.toLowerCase() === "cr") {
                        //         SchData.CrAmt = adjAmt.toFixed(2);
                        //         SchData.DrAmt = "0.00";
                        //     }
                        //     $.ajax({
                        //         type: "POST",
                        //         url: '@Url.Action("AddAgainstAdjustVoucherDetail", "AgainstAdjustVoucher")',
                        //         data: { model: SchData },
                        //         success: function (result, status, xhr) {
                        //             if (xhr.status == 200 && xhr.responseText == result) {
                        //                 $('#divBankReceiptDetail').html(result);
                        //                 $.notify('Process Added To Grid', "success");
                        //                 TotalNoOfRows();
                        //                 calculateTotalBalance();
                        //                 ClearGrid();
                        //             } else if (xhr.status == 207) {
                        //                 $.notify('Cannot add duplicate item.!!', "info");
                        //             } else if (xhr.status == 208) {
                        //                 $.notify('Cannot add duplicate item.!!', "info");
                        //             } else if (xhr.status == 209) {
                        //                 $.notify('Cannot add duplicate item.!!', "info");
                        //             } else if (xhr.status == 210) {
                        //                 $.notify('Cannot add multiple bank at a one time.!!', "info");
                        //             }
                        //             EditEachItem = false;
                        //         },
                        //         error: function () {
                        //             $.notify('Something Went Wrong, Please Try Again.', "error");
                        //         }
                        //     });
                        // };
                            function Validate_GridButton() {
            let Err = false;

            $('#tblAgainstAdjustVoucher tbody tr').each(function () {
                const row = $(this);
                const type = row.find('.type-select').val() || '';
                const ledger = row.find('.ledger-select').find(":selected").text()?.trim() || '';
                const mode = row.find('.mode-select').find(":selected").text()?.trim() || '';
                const adjAmt = parseFloat(row.find('.adjamt-input').val()) || 0;

                if (!type) { AddErrorCls('Type'); Err = true; } else RemoveErrorCls('Type');
                if (!ledger || ledger === '-Select-') { AddErrorCls('LedgerName'); Err = true; } else RemoveErrorCls('LedgerName');
                if (!mode) { AddErrorCls('ModeOfAdjustment'); Err = true; }
                else if (mode.toLowerCase().replace(/\s+/g,'') === 'againstref') { AddErrorCls('ModeOfAdjustment'); Err = true; }
                else RemoveErrorCls('ModeOfAdjustment');
                if (adjAmt <= 0) { AddErrorCls('AdjustmentAmt'); Err = true; } else RemoveErrorCls('AdjustmentAmt');
            });

            Err ? ShowErrorFld('H_SAGrid') : HideErrorFld('H_SAGrid');
            return !Err;
        }

        // function GridButton() {
        // //    if (!Validate_GridButton()) return;

        //     const rows = [];

        //                 $('#tblAgainstAdjustVoucher tbody tr').each(function () {
        //     const type = $(this).find('.type-select').val() || '';
        //     const adjAmt = parseFloat($(this).find('.adjamt-input').val()) || 0;

        //     const rowData = {
        //         AccountCode: $(this).find('input[name$="AccountCode"]').val() || 0,
        //         Balance: parseFloat($(this).find('input[name$="Balance"]').val()) || 0,
        //         BankType: $(this).find('input[name$="BankType"]').val() || '',
        //         DRCR: $(this).find('input[name$="DRCR"]').val() || '',
        //         InsNo: $(this).find('input[name$="InsNo"]').val() || '',
        //         InsDate: $(this).find('input[name$="InsDate"]').val() || '',
        //         AdjustmentAmt: adjAmt.toFixed(2),
        //         AdjustmentAmtOthCur: parseFloat($(this).find('input[name$="AdjustmentAmtOthCur"]').val()) || 0,
        //         PartyWiseNaration: $(this).find('input[name$="PartyWiseNaration"]').val() || '',
        //         AgainstVoucherNo: $(this).find('input[name$="AgainstVoucherNo"]').val() || '',
        //         AgainstVoucherCode: $(this).find('input[name$="AgainstVoucherCode"]').val() || '',
        //         AgainstVoucherDate: $(this).find('input[name$="AgainstVoucherDate"]').val() || '',
        //         AgainstVoucherType: $(this).find('input[name$="AgainstVoucherType"]').val() || '',
        //         AgainstVoucherEntryId: $(this).find('input[name$="AgainstVoucherEntryId"]').val() || '',
        //         VoucherBillAmt: parseFloat($(this).find('input[name$="VoucherBillAmt"]').val()) || 0,
        //         PendBillAmt: parseFloat($(this).find('input[name$="PendBillAmt"]').val()) || 0,
        //         SeqNo: $(this).find('input[name$="SeqNo"]').val() || 0,
        //         CustOrderNo: $(this).find('input[name$="CustOrderNo"]').val() || '',
        //         SoDate: $(this).find('input[name$="SoDate"]').val() || '',
        //         SOYear: $(this).find('input[name$="SOYear"]').val() || 0,
        //         DrAmt: type.toLowerCase() === 'dr' ? adjAmt.toFixed(2) : "0.00",
        //         CrAmt: type.toLowerCase() === 'cr' ? adjAmt.toFixed(2) : "0.00",
        //         ActualEntryby: parseInt($(this).find('input[name$="ActualEntryby"]').val()) || 0,
        //         UID: parseInt($(this).find('input[name$="UID"]').val()) || 0,
        //         EntryByMachine: $(this).find('input[name$="EntryByMachine"]').val() || '',
        //         CurrencyId: parseInt($(this).find('input[name$="CurrencyId"]').val()) || 0,
        //         ActualEntryDate: $(this).find('input[name$="ActualEntryDate"]').val() || '',
        //         Mode: $(this).find('input[name$="Mode"]').val() || '',
        //         Type: type === '-Select-' ? '' : type,
        //         LedgerName: $(this).find('.ledger-select option:selected').text() === '--Select--' ? '' : $(this).find('.ledger-select option:selected').text(),
        //         Intrument: $(this).find('select[name$="Intrument"] option:selected').text() === '--Select--' ? '' : $(this).find('select[name$="Intrument"] option:selected').text(),
        //         ModeOfAdjustment: $(this).find('.mode-select option:selected').text() === '--Select--' ? '' : $(this).find('.mode-select option:selected').text(),
        //         CostCenterName: $(this).find('.costcenter-select option:selected').text() === '--Select--' ? '' : $(this).find('.costcenter-select option:selected').text(),
        //         CostCenterId: parseInt($(this).find('input[name$="CostCenterId"]').val()) || 0,
        //         SrNO: $(this).data('srno') || 0
        //     };

            
        //     rows.push(rowData); // ✅ add the row to the array
        // });
        //     let model = {};
        // $.each($("form").serializeArray(), function () {
        //     model[this.name] = this.value;
        // });

        // // 🔹 add grid list
        // model.AgainstAdjustVoucherList = rows;
            
        //     $.ajax({
        //            type: "POST",
        // url: '@Url.Action("AddAgainstAdjustVoucherDetail", "AgainstAdjustVoucher")',
        //   type: "POST",
        //         data: JSON.stringify(model),
        //         contentType: 'application/json',
      
        //         success: function (result, status, xhr) {
        //             $('#divBankReceiptDetail').html(result);
        //             $.notify('Process Added To Grid', "success");
        //             TotalNoOfRows();
        //             calculateTotalBalance();
        //             ClearGrid();
        //         },
        //         error: function () {
        //             $.notify('Something went wrong. Please try again.', "error");
        //         }
        //     });
        // }
                     function GridButton() {
            const rows = [];

              $('#tblAgainstAdjustVoucher tbody tr').each(function () {
            rows.push({
                AccountCode: parseInt($(this).find('input[name$="AccountCode"]').val()) || 0,
                Balance: parseFloat($(this).find('input[name$="Balance"]').val()) || 0,
                BankType: $(this).find('input[name$="BankType"]').val() || '',
                DRCR: $(this).find('input[name$="DRCR"]').val() || '',
                Ins: $(this).find('input[name$="Ins"]').val() || '',
                InsNo: $(this).find('input[name$="InsNo"]').val() || '',
                InsDate: $(this).find('input[name$="InsDate"]').val() || '',
                AdjustmentAmt: parseFloat($(this).find('input[name$="AdjustmentAmt"]').val()) || 0,
                AdjustmentAmtOthCur: parseFloat($(this).find('input[name$="AdjustmentAmtOthCur"]').val()) || 0,
                PartyWiseNaration: $(this).find('input[name$="PartyWiseNaration"]').val() || '',
                AgainstVoucherNo: $(this).find('input[name$="AgainstVoucherNo"]').val() || '',
                AgainstVoucherCode: $(this).find('input[name$="AgainstVoucherCode"]').val() || '',
                AgainstVoucherDate: $(this).find('input[name$="AgainstVoucherDate"]').val() || '',
                AgainstVoucherType: $(this).find('input[name$="AgainstVoucherType"]').val() || '',
                AgainstVoucherEntryId: parseInt($(this).find('input[name$="AgainstVoucherEntryId"]').val()) || 0,
                VoucherBillAmt: parseFloat($(this).find('input[name$="VoucherBillAmt"]').val()) || 0,
                PendBillAmt: parseFloat($(this).find('input[name$="PendBillAmt"]').val()) || 0,
                SeqNo: parseInt($(this).find('input[name$="SeqNo"]').val()) || 0,
                CustOrderNo: $(this).find('input[name$="CustOrderNo"]').val() || '',
                SoDate: $(this).find('input[name$="SoDate"]').val() || '',
                SOYear: parseInt($(this).find('input[name$="SOYear"]').val()) || 0,
                DrAmt: $(this).find('.type-select').val() === 'DR' ? parseFloat($(this).find('.adjamt-input').val()) || 0 : 0,
                CrAmt: $(this).find('.type-select').val() === 'CR' ? parseFloat($(this).find('.adjamt-input').val()) || 0 : 0,
                ActualEntryby: parseInt($(this).find('input[name$="ActualEntryby"]').val()) || 0,
                UID: parseInt($(this).find('input[name$="UID"]').val()) || 0,
                EntryByMachine: $(this).find('input[name$="EntryByMachine"]').val() || '',
                CurrencyId: parseInt($(this).find('input[name$="CurrencyId"]').val()) || 0,
                ActualEntryDate: $(this).find('input[name$="ActualEntryDate"]').val() || '',
                Mode: $(this).find('input[name$="Mode"]').val() || '',
                Type: $(this).find('.type-select').val() || '',
                LedgerName: $(this).find('.ledger-select option:selected').text() || '',
                Intrument: $(this).find('select[name$="Intrument"] option:selected').text() || '',
                ModeOfAdjustment: $(this).find('.mode-select option:selected').text() || '',
                CostCenterName: $(this).find('.costcenter-select option:selected').text() || '',
                CostCenterId: parseInt($(this).find('input[name$="CostCenterId"]').val()) || 0,
                SrNO: $(this).data('srno') || 0
            });
        });

            // Manually build the top-level object
            const model = {
                FromDateBack: $('#FromDateBack').val() || '',
                ToDateBack: $('#ToDateBack').val() || '',
                LedgerNameBack: $('#LedgerNameBack').val() || '',
                VoucherNoBack: $('#VoucherNoBack').val() || '',
                AccEntryId: parseInt($('#AccEntryId').val()) || 0,
                VoucherType: $('#VoucherType').val() || '',
                VoucherNo: $('#VoucherNo').val() || '',
                SrNO: parseInt($('#SrNO').val()) || 0,
                CC: $('#CC').val() || '',
                EntryId: parseInt($('#EntryId').val()) || 0,
                EntryDate: $('#EntryDate').val() || '',
                YearCode: parseInt($('#YearCode').val()) || 0,
                AgainstAdjustVoucherList: rows  // ✅ this must be an array of objects
            };

            $.ajax({
                type: "POST",
                url: '@Url.Action("AddAgainstAdjustVoucherDetail", "AgainstAdjustVoucher")',
                data: JSON.stringify(model),  // JSON.stringify is required
                contentType: 'application/json',
                success: function (result) {
                    $('#divBankReceiptDetail').html(result);
                    $.notify('Process Added To Grid', "success");
                },
                error: function (err) {
                    console.log(err);
                    $.notify('Something went wrong.', "error");
                }
            });
        }

                        function AdjustAmountForAddToGridForDRCR() {

                            var RowCount = $('#divBankReceiptDetail tr').length;
                            var DrAmt = parseFloat($('#DrAmt').val()) || 0;
                            var CrAmt = parseFloat($('#CrAmt').val()) || 0;
                            var difference = Math.abs(DrAmt - CrAmt);
                            for (let i = 1; i <= RowCount; i++) {
                                if ($('#BankType').val() == "Bank") {
                                    if (DrAmt < CrAmt) {
                                        $('#AdjustmentAmt').val(difference)
                                    }
                                }
                                else {
                                    if ($('#Type-' + i).text() == "DR") {
                                        if ($('#Type').val() == "CR") {
                                            $('#AdjustmentAmt').val(difference)
                                        }
                                    }
                                    if ($('#Type-' + i).text() == "CR") {
                                        if ($('#Type').val() == "DR") {
                                            $('#AdjustmentAmt').val(difference)
                                        }
                                    }
                                }
                            }
                            $('#AdjustmentAmt').trigger('input');
                        }

                        var EditEachItem = false;
                        function EditItemRows(SrNO) {

                            var RowCount = $('#divBankReceiptDetail tr').length;
                            if (EditEachItem) {
                                $.notify('Cannot Edit item while AddtoGrid  Existing Item!!!', "error");
                                $('#editButton-' + RowCount).prop("disabled", true);
                            }
                            else {
                                $.ajax({
                                    url: '@Url.Action("EditItemRows", "AgainstAdjustVoucher")',
                                    type: "POST",
                                    data: { SrNO: SrNO, "Mode": $('#Mode').val() },
                                    success: function (data) {

                                        var obj = $.parseJSON(data);
                                        var ModeOfAdjustment = obj[0].ModeOfAdjustment;

                                        if (ModeOfAdjustment == "Against Ref") {
                                            $('#LedgerName').val(obj[0].AccountCode).trigger("change");
                                            $('#AccountCode').val(obj[0].AccountCode);
                                            $('#Intrument').val(obj[0].Intrument).trigger("change");
                                            $('#InsNo').val(obj[0].InsNo);
                                            $('#InsDate').val(obj[0].InsDate);
                                            $('#ModeOfAdjustment').val(obj[0].ModeOfAdjustment).trigger("change");
                                            $('#SeqNo').val(obj[0].SeqNo);
                                            PopUpForPendingVouchers("EditMode", SrNO);
                                            CheckUnCheckEdit();
                                        }
                                        else {
                                            if (obj != null) {
                                                EditEachItem = true;
                                                $('#Type').val(obj[0].Type).trigger("change");
                                                $('#LedgerName').val(obj[0].AccountCode).trigger("change");
                                                $('#AccountCode').val(obj[0].AccountCode);
                                                $('#Balance').val(obj[0].Balance);
                                                $('#DRCR').val(obj[0].DRCR);
                                                $('#Intrument').val(obj[0].Intrument).trigger("change");
                                                $('#InsNo').val(obj[0].InsNo);
                                                $('#InsDate').val(obj[0].InsDate);
                                                $('#ModeOfAdjustment').val(obj[0].ModeOfAdjustment).trigger("change");
                                                $('#AdjustmentAmt').val(obj[0].AdjustmentAmt);
                                                $('#AdjustmentAmtOthCur').val(obj[0].AdjustmentAmtOthCur);
                                                $('#CostCenterName').val(obj[0].CostCenterId).trigger("change");
                                                $('#CostCenterId').val(obj[0].CostCenterId);
                                                $('#PartyWiseNaration').val(obj[0].PartyWiseNaration);
                                                $('#AgainstVoucherNo').val(obj[0].AgainstVoucherNo);
                                                $('#AgainstVoucherCode').val(obj[0].AgainstVoucherCode);
                                                $('#AgainstVoucherDate').val(obj[0].AgainstVoucherDate);
                                                $('#AgainstVoucherType').val(obj[0].AgainstVoucherType);
                                                $('#AgainstVoucherEntryId').val(obj[0].AgainstVoucherEntryId);
                                                $('#VoucherBillAmt').val(obj[0].VoucherBillAmt);
                                                $('#PendBillAmt').val(obj[0].PendBillAmt);
                                                $('#SeqNo').val(obj[0].SeqNo);
                                                $('#CustOrderNo').val(obj[0].CustOrderNo);
                                                $('#SoDate').val(obj[0].SoDate);
                                                $('#SOYear').val(obj[0].SOYear);
                                                $('#DrAmt').val(obj[0].DrAmt);
                                                $('#CrAmt').val(obj[0].CrAmt);
                                                var rowCount = $('#divStockGrid tr').length;
                                                for (var i = 1; i <= rowCount + 1; i++) {
                                                    $('#editItemGrid-' + i).css("pointer-events", "none");
                                                    $('#editItemGrid-' + i).css("cursor", "not-allowed");
                                                }

                                            }
                                            DeleteItemRow(SrNO);
                                        }
                                        AdjustAmountForAddToGridForDRCR();
                                    },
                                    error: function (response) {
                                        $.notify(response.responseText, "error");
                                    },
                                    failure: function (response) {
                                        $.notify(response.responseText, "error");
                                    }
                                });
                            }
                        }

                                $('#CheckUnCheckAll').click(function () {
                                    var isChecked = $(this).is(':checked');

                                    $('input[id^="CheckUnCheck-"]').each(function () {
                                        $(this).prop('checked', isChecked);

                                        var index = $(this).attr('id').split('-')[1];
                                        CheckUnCheckCheck(index);
                                    });
                                });

                                function CheckUnCheckCheck(i) {
                                    var RowCount = $('#divDisplayPopupForPendingVouchersDetail tr').length;
                                    var isChecked = $('#CheckUnCheck-' + i).is(':checked');

                                    if (isChecked) {
                                        if (parseFloat($('#AdjustAmt-' + i).val()) == 0) {
                                            $('#AdjustAmt-' + i).val($('#BalanceAmt-' + i).text());
                                            $('#BalanceAmt-' + i).text(0);
                                        }
                                        $('#AdjustData-' + i).css("background-color", "rgb(161 184 161)");
                                    } else {
                                        var adjustedValue = $('#AdjustAmt-' + i).val();
                                        if (adjustedValue && adjustedValue !== "0") {
                                            $('#BalanceAmt-' + i).text(adjustedValue);
                                            $('#AdjustAmt-' + i).val(0);
                                        }
                                        $('#AdjustData-' + i).css("background-color", "");
                                    }

                                    var selectedRows = $('#divDisplayPopupForPendingVouchersDetail tr').has('input[type="checkbox"]:checked').length;

                                    $('#CheckUnCheckAll').prop('checked', selectedRows === RowCount);

                                    $('#lblcheckitem').text(selectedRows);

                                    AdjustAmount();
                                }

                                function CheckUnCheckEdit() {

                                            var RowCount = $('#divBankReceiptDetail tr').length;
                                            var PopUpRow = $('#divDisplayPopupForPendingVouchersDetail tr').length;
                                            var selectedRows = 0;

                                            var existingVoucherIds = new Map();

                                            for (let i = 1; i <= RowCount; i++) {
                                                let voucherId = $('#AgainstVoucherEntryId-' + i).text().trim();
                                                let amount = parseFloat($('#AdjAmtG-' + i).text());
                                                let balance = parseFloat($('#BalanceG-' + i).text());
                                                let accountCode = $('#LedgerName').val();

                                                let key = voucherId + '_' + accountCode;
                                                existingVoucherIds.set(voucherId, { amount, balance });
                                            }

                                            var selectedRows = $('#divDisplayPopupForPendingVouchersDetail tr').has('input[type="checkbox"]:checked').length;

                                            if (selectedRows === RowCount) {
                                                $('#CheckUnCheckAll').prop('checked', true);
                                            }
                                            else {
                                                $('#CheckUnCheckAll').prop('checked', false);
                                            }

                                            for (let i = 1; i <= PopUpRow; i++) {
                                                let popupVoucherId = $('#PopUpAccEntryId-' + i).text().trim();

                                                if (existingVoucherIds.has(popupVoucherId)) {
                                                    selectedRows++;
                                                    $('#CheckUnCheck-' + i).prop('checked', true);
                                                    let { amount, balance } = existingVoucherIds.get(popupVoucherId);
                                                    $('#AdjustAmt-' + i).val(amount);
                                                    $('#BalanceAmt-' + i).text(balance);
                                                    $('#AdjustData-' + i).css("background-color", "rgb(161 184 161)");
                                                }
                                            }
                                            AdjustAmount();
                                            $('#lblcheckitem').text(selectedRows);
                                        }

                        var currentSearchColumn = null;

                        $("#search-box").on("keyup", function () {

                            var value = $(this).val().toLowerCase();
                            $("#divDisplayPopupForPendingVouchersDetail tr").filter(function () {
                                if (currentSearchColumn !== null) {
                                    var columnText = $(this).find('td').eq(currentSearchColumn).text().toLowerCase();
                                    $(this).toggle(columnText.indexOf(value) > -1);
                                } else {
                                    $(this).toggle($(this).text().toLowerCase().indexOf(value) > -1);
                                }
                            });
                        });

                        $(document).on("click", ".sortCol", function () {
                    var $column = $(this).parent().closest("th");
                    var colno = $(this).data('columnno');
                    var currentOrder = $(this).data('sortorder');

                    $('.sortCol').css('color', 'white');
                    if (currentOrder === 'asc') {
                        sortTable('GateDataTable', colno, false);
                        $(this).data('sortorder', 'desc');
                        $(this).css('color', 'yellow');
                        //$(this).css('font-size', 'larger');
                        $(this).find('i:first').removeClass('fa-arrow-up');
                        $(this).find('i:first').addClass('fa-arrow-down');
                    } else {
                        sortTable('GateDataTable', colno, true);
                        $(this).data('sortorder', 'asc');
                        $(this).css('color', 'yellow');
                        // $(this).css('font-size', 'larger');
                        $(this).find('i:first').removeClass('fa-arrow-down');
                        $(this).find('i:first').addClass('fa-arrow-up');
                    }
                });

                               function PressBack() {

                                    sessionStorage.setItem('FromDateBack', $('#FromDateBack').val());
                                    sessionStorage.setItem('ToDateBack', $('#ToDateBack').val());
                                    sessionStorage.setItem('LedgerNameBack', $('#LedgerNameBack').val());
                                    sessionStorage.setItem('VoucherNoBack', $('#VoucherNoBack').val());
                                    sessionStorage.setItem('AgainstVoucherRefNoBack', $('#AgainstVoucherRefNoBack').val());
                                    sessionStorage.setItem('AgainstVoucherNoBack', $('#AgainstVoucherNoBack').val());
                                    sessionStorage.setItem('DashboardTypeBack', $('#DashboardTypeBack').val());
                                    sessionStorage.setItem('GlobalSearchBack', $('#GlobalSearchBack').val());

                                    window.history.back();
                                }

                        $('#btnRoutingExcel').click(function () {
                            $("#GateDataTable").table2excel({
                                filename: "PendingVouchersData.xls"
                            });
                        });

    </script>
    <script src="~/Scripts/table2excel.js"></script>
}

<style>
    #dashGateThead th.sticky-action {
        position: sticky;
        left: 0;
        z-index: 10;
    }

    td.sticky-action {
        position: sticky;
        left: 0;
        background: #f8f9fa; /* match your table header bg or use white */
        z-index: 2;
    }

</style> 