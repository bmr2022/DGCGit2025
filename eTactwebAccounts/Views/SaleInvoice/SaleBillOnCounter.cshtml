@using eTactWeb.DOM.Models
@using Microsoft.AspNetCore.Http
@using System.Reflection.PortableExecutable
@inject IHttpContextAccessor HttpContextAccessor
@{
    var yearCode = Convert.ToInt32(HttpContextAccessor.HttpContext.Session.GetString("YearCode"));
}
@model eTactWeb.DOM.Models.SaleBillModel
@{
    ViewData["Title"] = "SaleInvoice";
    Layout = "~/Views/Shared/_LayoutMain.cshtml";
}

<div class="card bg-gradient mb-3 border-light shadow-lg">
    <partial name="_saleBillDisplaySODetail" />
    <partial name="_SaleBillTaxPassword" />
    <form asp-action="SaleInvoice" autocomplete="off" class="form-horizontal" id="saleInvoiceForm" method="post" enctype="multipart/form-data">
        <input type="hidden" asp-for="Mode" value="@Model.Mode" />
        <input type="hidden" asp-for="EID" />
        <input type="hidden" asp-for="EInvNo" />
        <input type="hidden" asp-for="EinvGenerated" />
        <input type="hidden" asp-for="MaxSaleInvoiceEntryDate" />
        <input type="hidden" asp-for="AllowBackDateSALEBILL" />
        <input type="hidden" asp-for="AllowToAdjZeroAmt" />
        <input type="hidden" id="TypeOfSave"/>
        <input type="hidden" id="Companytype" />
        @*   <input type="hidden" asp-for="ShowHideSaleBillEntryDetail" />
        <input type="hidden" asp-for="ShowHideSaleBillCustomerDetail" />
        <input type="hidden" asp-for="ShowHideSaleBillOtherRequiredDetail" />
        <input type="hidden" asp-for="ShowHideSaleBillCurrency" />
        <input type="hidden" asp-for="ShowHideSaleBillConsignee" />
        <input type="hidden" asp-for="ShowHideSaleBillScheduleDetail" />
        <input type="hidden" asp-for="AllowToChangeSaleBillStoreName" />
        <input type="hidden" asp-for="HideOtherFieldOFSaleBillDetailTable" /> *@
        @* <input type="hidden" asp-for="ApproveSOForGenerateSaleInvoiceOrNot" /> *@
        <input type="hidden" id="EditableRateAndDiscountONSaleInvoice" />
        <div class="card-header card-headerBG text-light bg-gradient">
            <h5>
                <strong>@ViewData["Title"] - @Model.SaleBillYearCode</strong>
                <span class="d-flex float-end" style="margin-top:-2px;">
                    @if (Model.Mode == "V")
                    {
                        <a type="button" class="btn btn-sm btn-outline-light bg-gradient" id="btnGenerateEinvoiceview"
                           asp-route-EntryId="@Model.SaleBillEntryId" asp-route-InvoiceNo="@Model.SaleBillNo" asp-route-YearCode="@Model.SaleBillYearCode">
                            <i class="fa fa-pencil-square fa-fw fa-lg" aria-hidden="true"></i>
                            GENARATE EINVOICE
                        </a>
                    }
                    <a type="button" class="pendingso  btn btn-sm btn-outline-light bg-gradient" >
                        <i class="fa fa-pencil-square fa-fw fa-lg" aria-hidden="true"></i>
                        Pending SO
                    </a>

                    <a type="button" class="btn btn-sm btn-outline-light bg-gradient" asp-action="PrintVoucher"
                       asp-controller="DirectPurchaseBill" asp-route-EntryId="@Model.SaleBillEntryId" asp-route-YearCode="@Model.SaleBillYearCode">
                        <i class="fa fa-pencil-square fa-fw fa-lg" aria-hidden="true"></i>
                        PRINT VOUCHER
                    </a>
                    <a type="button" class="btn btn-sm btn-outline-light bg-gradient" asp-action="PrintReport" asp-controller="SaleInvoice" asp-route-EntryId="@Model.SaleBillEntryId" asp-route-YearCode="@Model.SaleBillYearCode" asp-route-Type="SALEBILL" asp-route-InvoiceNo="@Model.SaleBillNo" asp-route-AccountCode="@Model.AccountCode" target="_blank">
                        <i class="fa fa-pencil-square fa-fw fa-lg" aria-hidden="true"></i>
                        PRINT INVOICE
                    </a>


                    <a asp-action="SaleBillOnCounterDashboard" class="btn btn-sm btn-outline-light bg-gradient" style="margin-right:5px;">
                        <i class="fa-solid fa-grip fa-lg fa-fw fa-beat" style="--fa-animation-duration: 2s;"></i>
                        Dashboard
                    </a>
                    <div class="row justify-content-between g-2">
                        <div class="col-auto">
                            <input asp-for="DashboardTypeBack" type="hidden" value="@Model.DashboardTypeBack" />
                            <input asp-for="FromDateBack" type="hidden" value="@Model.FromDateBack" />
                            <input asp-for="ToDateBack" type="hidden" value="@Model.ToDateBack" />
                            <input asp-for="PartCodeBack" type="hidden" value="@Model.PartCodeBack" />
                            <input asp-for="ItemNameBack" type="hidden" value="@Model.ItemNameBack" />
                            <input asp-for="SaleBillNoBack" type="hidden" value="@Model.SaleBillNoBack" />
                            <input asp-for="CustNameBack" type="hidden" value="@Model.CustNameBack" />
                            <input asp-for="SonoBack" type="hidden" value="@Model.SonoBack" />
                            <input asp-for="CustOrderNoBack" type="hidden" value="@Model.CustOrderNoBack" />
                            <input asp-for="SchNoBack" type="hidden" value="@Model.SchNoBack" />
                            <input asp-for="PerformaInvNoBack" type="hidden" value="@Model.PerformaInvNoBack" />
                            <input asp-for="SaleQuoteNoBack" type="hidden" value="@Model.SaleQuoteNoBack" />
                            <input asp-for="DomesticExportNEPZBack" type="hidden" value="@Model.DomesticExportNEPZBack" />
                            <input asp-for="SearchBoxBack" type="hidden" value="@Model.SearchBoxBack" />
                            <input asp-for="SummaryDetailBack" type="hidden" value="@Model.SummaryDetailBack" />
                            <input asp-for="AllowToAddNegativeStockInStore" type="hidden" value="Y" />
                            <input type="hidden" id="ShouldEinvoice" name="ShouldEinvoice" />

                            @if (Model.Mode == "U" || Model.Mode == "V")
                            {
                                <input type="hidden" value="@Model.SaleBillNo" id="hiddenSaleBillNo" />
                            }

                            <a href="#" class=" btn btn-primary btn-sm" onclick="PressBack();">
                                <i class="fa fa-chevron-circle-left fa-fw fa-lg" aria-hidden="true"></i>
                                BACK
                            </a>
                        </div>
                        <div class="col-auto me-2">
                            @if (Model.Mode != "V")
                            {
                                <button type="button" class="PartialSave btn btn-secondary btn-sm mr-2" style="color:white!important">
                                    <i class="fa-solid fa-floppy-disk-pen fa-fw fa-lg" style="--fa-secondary-color: crimson; --fa-secondary-opacity: 1.0;"></i>
                                    PARTIAL SAVE
                                </button>
                            }

                        </div>
                        @if (Model.Mode != "V")
                        {
                            <div class="col-auto">
                                @* <a class="btn btn-secondary btn-sm" onclick="location.href=$('form')[0].action">
                            <i class="fa fa-refresh fa-fw fa-lg" aria-hidden="true"></i>
                            REFRESH
                            </a> *@
                                <a type="button" class="btn btn-secondary btn-sm" asp-action="SaleBillOnCounter"
                                   asp-controller="SaleInvoice">
                                    <i class="fa fa-refresh fa-fw fa-lg" aria-hidden="true"></i>
                                    REFRESH
                                </a>
                            </div>
                            @if (Model.Mode == "U")
                            {
                                <div class="col-auto">
                                    <button type="submit" class="btn btn-sm btn-outline-light bg-gradient" id="UpdateButton">
                                        <i class="fa fa-pencil-square fa-fw fa-lg" aria-hidden="true"></i>
                                        UPDATE
                                    </button>
                                </div>
                            }

                            else
                            {
                                <div class="col-auto">
                                    <button type="submit" class="btn btn-primary btn-sm" id="submitBTN">
                                        <i class="fa-solid fa-chevron-circle-right"></i>
                                        SUBMIT
                                    </button>
                                </div>
                            }
                        }
                    </div>
                </span>
            </h5>
        </div>
        <div class="card-body bg-light pt-0">
            <div class="accordion shadow-lg">
                <div class="accordion-item">
                    <h2 class="accordion-header" id="HPanel1">
                        <button class="accordion-button text-light pnl4BG bg-gradient" type="button" data-bs-toggle="collapse" data-bs-target="#BPanel1" aria-expanded="true" aria-controls="BPanel1">
                            <i class="fa-brands fa-wpforms fa-lg fa-fw pr35"></i>
                            Required Parameter
                            <small class="p-3"></small>
                        </button>
                    </h2>
                    <div id="BPanel1" class="accordion-collapse collapse show pnl4 bg-gradient" aria-labelledby="HPanel1">
                        <partial name="_SaleBillMain" model="Model" />
                        <partial name="_PendingChallanListPopUp" model="Model" />
                    </div>
                </div>
                <div class="accordion-item">
                    <h2 class="accordion-header" id="HPanel10">
                        <button class="accordion-button collapsed text-light pnl1BG bg-gradient" type="button" data-bs-toggle="collapse" data-bs-target="#BPanel10" aria-expanded="true" aria-controls="BPanel10">
                            <strong style="text-transform:uppercase"><i class="fa-solid fa-table-list fa-lg fa-fw pr35 fa-fade" style="--fa-animation-duration: 2s; --fa-fade-opacity: 0.6;"></i>History Detail Grid</strong>
                        </button>

                    </h2>
                    <div id="BPanel10" class="accordion-collapse collapse pnl1 bg-gradient" aria-labelledby="HPanel10">
                        <div class="accordion-body">

                            <div class="card">
                                @*  <div class="col-xl-2 col-lg-6 col-md-6 col-sm-6 col-xs-12" style="margin-top:10px;margin-left:1100px">
                                <input type="text" class="form-control" id="search-box" style="background-color:#FFFACD" placeholder="Search...">
                                </div> *@

                                <div class="card-body overflow-auto pb-0">
                                    <div class="table-responsive" style="max-height:150px;">
                                        <table class="table table-hover table-bordered table-striped" id="poTable">
                                            <thead class="bg-gradient card-headerBG text-light small" id="poThead" style="white-space:nowrap">
                                                <tr id="HistoryRow">

                                                    <th data-columnno="1" data-sortorder="asc" class="sortCol"><span style="padding:5px;margin:5px" class="sort-icon"><i class="fa" aria-hidden="true"></i></span>Bill No</th>
                                                    <th data-columnno="2" data-sortorder="asc" class="sortCol"><span style="padding:5px;margin:5px" class="sort-icon"><i class="fa" aria-hidden="true"></i></span>Date</th>
                                                    <th data-columnno="2" data-sortorder="asc" class="sortCol"><span style="padding:5px;margin:5px" class="sort-icon"><i class="fa" aria-hidden="true"></i></span>Customer</th>
                                                    <th data-columnno="3" data-sortorder="asc" class="sortCol"><span style="padding:5px;margin:5px" class="sort-icon"><i class="fa" aria-hidden="true"></i></span>Qty</th>
                                                    <th data-columnno="4" data-sortorder="asc" class="sortCol"><span style="padding:5px;margin:5px" class="sort-icon"><i class="fa" aria-hidden="true"></i></span>MRP</th>
                                                    <th data-columnno="5" data-sortorder="asc" class="sortCol"><span style="padding:5px;margin:5px" class="sort-icon"><i class="fa" aria-hidden="true"></i></span>Discount %</th>
                                                    <th data-columnno="5" data-sortorder="asc" class="sortCol"><span style="padding:5px;margin:5px" class="sort-icon"><i class="fa" aria-hidden="true"></i></span>Rate</th>
                                                </tr>
                                            </thead>
                                            <tbody id="DivSaleBillHistory">
                                                <partial name="_SaleBillHistoryGrid" />
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>

                        </div>
                    </div>
                </div>

                <div class="accordion-item">
                    <h2 class="accordion-header" id="HPanel2">
                        <button class="accordion-button collapsed text-light pnl4BG bg-gradient" type="button" data-bs-toggle="collapse" data-bs-target="#BPanel2" aria-expanded="true" aria-controls="BPanel2">
                            <strong style="text-transform:uppercase"><i class="fa-solid fa-table-list fa-lg fa-fw pr35 fa-fade" style="--fa-animation-duration: 2s; --fa-fade-opacity: 0.6;"></i>Item Detail Grid</strong>
                            <div class="d-flex justify-content-center align-items-center flex-grow-1">
                                <strong>BASIC TOTAL : <i class="fa-solid fa-indian-rupee-sign fa-fw fa-1x"></i><span id="lblItemNetAmount"></span></strong>
                                <strong>Total Qty : <span id="TotalQty"></span></strong>
                                <input type="hidden" asp-for="BillAmt" />
                                <strong>, TOTAL NO OF ITEMS : <span id="lblItemCount"></span></strong>
                            </div>
                        </button>
                        <button type="button" style="display:none" class="PendGridButton btn btn-sm btn-outline-danger mt-1 mb-1 PendingItem">
                            <i class="fa-duotone fa-angle-double-down fa-fw fa-lg"></i> ADD TO GRID

                            
                        </button>
                    </h2>
                    <div id="BPanel2" class="accordion-collapse collapse pnl1 bg-gradient" aria-labelledby="HPanel2">
                        <div class="accordion-body">

                            <div class="card PendingItem" style="display:none">
                                <div class="card-body overflow-auto pb-0" style="max-height:240px;">
                                    <table class="table table-hover table-bordered table-striped">
                                        <thead class="bg-gradient card-headerBG text-light small" style="white-space:nowrap" id="IssueThrBom">
                                            <tr>
                                                <th>Action</th>
                                                <th>SO No</th>
                                                <th>SO YC</th>
                                                <th>CustOrderNo</th>
                                                <th>Sch No</th>
                                                <th>Sch YC</th>

                                                <th>Part Code</th>
                                                <th>Item Name</th>
                                                <th>Rate</th>
                                                <th>Qty</th>
                                                <th>Amount</th>
                                                <th>Discount %</th>
                                                <th>Discount Amt</th>
                                                <th>Unit</th>
                                                <th>RacKID</th>
                                                <th>HSNNo</th>

                                                <th>Pend Qty</th>
                                                <th>StoreName</th>
                                                <th>Batch No</th>
                                                <th>Unique Batch No</th>
                                                <th>TotalStock</th>
                                                <th>BatchStock</th>


                                                <th>SO Type</th>


                                                <th>Alt Qty</th>

                                            </tr>
                                        </thead>
                                        <tbody id="divMultiItemGrid">
                                            <partial name="_SaleBillItemMemoryGrid" />
                                        </tbody>
                                    </table>
                                </div>
                            </div>


                            <div id="_ItemGrid" class="newitems" style="display:none">
                                @await Html.PartialAsync("_SaleBillItemDetail", Model)
                            </div>
                            <div class="progress my-2 mb-3" style="height: 4px;">
                                <div class="progress-bar progress-bar-striped bg-secondary progress-bar-animated" role="progressbar" style="width: 100%" aria-valuenow="100" aria-valuemin="0" aria-valuemax="100"></div>
                            </div>
                            <div class="card">
                                <div class="col-xl-2 col-lg-6 col-md-6 col-sm-6 col-xs-12" style="margin-top:10px;margin-left:1100px">
                                    <input type="text" class="form-control" id="search-box" style="background-color:#FFFACD" placeholder="Search...">
                                </div>

                                <div class="card-body overflow-auto pb-0">
                                    <div class="table-responsive" style="max-height:250px;">
                                        <table class="table table-hover table-bordered table-striped" id="poTable">
                                            <thead class="bg-gradient card-headerBG text-light small" id="poThead" style="white-space:nowrap">
                                                <tr id="headerRow">
                                                    <th>Action</th>
                                                    <th data-columnno="1" data-sortorder="asc" class="sortCol"><span style="padding:5px;margin:5px" class="sort-icon"><i class="fa" aria-hidden="true"></i></span>Seq No</th>
                                                    <th data-columnno="3" data-sortorder="asc" class="sortCol"><span style="padding:5px;margin:5px" class="sort-icon"><i class="fa" aria-hidden="true"></i></span>Part Code</th>
                                                    <th data-columnno="4" data-sortorder="asc" class="sortCol"><span style="padding:5px;margin:5px" class="sort-icon"><i class="fa" aria-hidden="true"></i></span>Item Name</th>
                                                    <th data-columnno="4" data-sortorder="asc" class="sortCol gridHiddenField"><span style="padding:5px;margin:5px" class="sort-icon"><i class="fa" aria-hidden="true"></i></span>Bom/Ind</th> @*gridHiddenField*@
                                                    <th data-columnno="4" data-sortorder="asc" class="sortCol gridHiddenField"><span style="padding:5px;margin:5px" class="sort-icon"><i class="fa" aria-hidden="true"></i></span>Prod/UnProd</th> @*gridHiddenField*@

                                                    <th data-columnno="19" data-sortorder="asc" class="sortCol"><span style="padding:5px;margin:5px" class="sort-icon"><i class="fa" aria-hidden="true"></i></span>Bill Qty</th>
                                                    <th data-columnno="20" data-sortorder="asc" class="sortCol"><span style="padding:5px;margin:5px" class="sort-icon"><i class="fa" aria-hidden="true"></i></span>Rate</th>
                                                    <th data-columnno="22" data-sortorder="asc" class="sortCol"><span style="padding:5px;margin:5px" class="sort-icon"><i class="fa" aria-hidden="true"></i></span>Dis Per</th>
                                                    <th data-columnno="23" data-sortorder="asc" class="sortCol"><span style="padding:5px;margin:5px" class="sort-icon"><i class="fa" aria-hidden="true"></i></span>Dis Amt</th>
                                                    <th data-columnno="24" data-sortorder="asc" class="sortCol"><span style="padding:5px;margin:5px" class="sort-icon"><i class="fa" aria-hidden="true"></i></span>Item Amt</th>
                                                    <th data-columnno="5" data-sortorder="asc" class="sortCol"><span style="padding:5px;margin:5px" class="sort-icon"><i class="fa" aria-hidden="true"></i></span>SO No</th>
                                                    <th data-columnno="7" data-sortorder="asc" class="sortCol"><span style="padding:5px;margin:5px" class="sort-icon"><i class="fa" aria-hidden="true"></i></span>SO Date</th>
                                                    <th data-columnno="8" data-sortorder="asc" class="sortCol"><span style="padding:5px;margin:5px" class="sort-icon"><i class="fa" aria-hidden="true"></i></span>Cust Order No</th>
                                                    <th data-columnno="9" data-sortorder="asc" class="sortCol SaleBillScheduleDetail"><span style="padding:5px;margin:5px" class="sort-icon"><i class="fa" aria-hidden="true"></i></span>Sch No</th>
                                                    <th data-columnno="10" data-sortorder="asc" class="sortCol SaleBillScheduleDetail"><span style="padding:5px;margin:5px" class="sort-icon"><i class="fa" aria-hidden="true"></i></span>Sch Date</th>
                                                    <th data-columnno="11" data-sortorder="asc" class="sortCol"><span style="padding:5px;margin:5px" class="sort-icon"><i class="fa" aria-hidden="true"></i></span>HSN No</th>
                                                    <th data-columnno="12" data-sortorder="asc" class="sortCol"><span style="padding:5px;margin:5px" class="sort-icon"><i class="fa" aria-hidden="true"></i></span>Store Name</th>
                                                    <th data-columnno="4" data-sortorder="asc" class="sortCol"><span style="padding:5px;margin:5px" class="sort-icon"><i class="fa" aria-hidden="true"></i></span>RackID</th>

                                                    <th data-columnno="14" data-sortorder="asc" class="sortCol"><span style="padding:5px;margin:5px" class="sort-icon"><i class="fa" aria-hidden="true"></i></span>Batch No</th>
                                                    <th data-columnno="15" data-sortorder="asc" class="sortCol"><span style="padding:5px;margin:5px" class="sort-icon"><i class="fa" aria-hidden="true"></i></span>Unique BatchNo</th>
                                                    <th data-columnno="6" data-sortorder="asc" class="sortCol"><span style="padding:5px;margin:5px" class="sort-icon"><i class="fa" aria-hidden="true"></i></span>SO Year</th>
                                                    <th data-columnno="10" data-sortorder="asc" class="sortCol SaleBillScheduleDetail"><span style="padding:5px;margin:5px" class="sort-icon"><i class="fa" aria-hidden="true"></i></span>Sch YC</th>
                                                    <th data-columnno="10" data-sortorder="asc" class="sortCol"><span style="padding:5px;margin:5px" class="sort-icon"><i class="fa" aria-hidden="true"></i></span>Bom Rev No</th>
                                                    <th data-columnno="13" data-sortorder="asc" class="sortCol"><span style="padding:5px;margin:5px" class="sort-icon"><i class="fa" aria-hidden="true"></i></span>Unit</th>
                                                    <th data-columnno="16" data-sortorder="asc" class="sortCol"><span style="padding:5px;margin:5px" class="sort-icon"><i class="fa" aria-hidden="true"></i></span>Lot Stock</th>
                                                    <th data-columnno="17" data-sortorder="asc" class="sortCol"><span style="padding:5px;margin:5px" class="sort-icon"><i class="fa" aria-hidden="true"></i></span>Total Stock</th>
                                                    <th data-columnno="18" data-sortorder="asc" class="sortCol"><span style="padding:5px;margin:5px" class="sort-icon"><i class="fa" aria-hidden="true"></i></span>Pend Qty</th>
                                                    <th data-columnno="21" data-sortorder="asc" class="sortCol"><span style="padding:5px;margin:5px" class="sort-icon"><i class="fa" aria-hidden="true"></i></span>No of Pcs</th>
                                                    <th data-columnno="25" data-sortorder="asc" class="sortCol"><span style="padding:5px;margin:5px" class="sort-icon"><i class="fa" aria-hidden="true"></i></span>Customer PartCode</th>
                                                    <th data-columnno="25" data-sortorder="asc" class="sortCol"><span style="padding:5px;margin:5px" class="sort-icon"><i class="fa" aria-hidden="true"></i></span>Item Size</th>
                                                    <th data-columnno="26" data-sortorder="asc" class="sortCol"><span style="padding:5px;margin:5px" class="sort-icon"><i class="fa" aria-hidden="true"></i></span>Item Color</th>
                                                    <th data-columnno="26" data-sortorder="asc" class="sortCol"><span style="padding:5px;margin:5px" class="sort-icon"><i class="fa" aria-hidden="true"></i></span>Process Name</th>
                                                    <th data-columnno="26" data-sortorder="asc" class="sortCol"><span style="padding:5px;margin:5px" class="sort-icon"><i class="fa" aria-hidden="true"></i></span>GST Per</th>
                                                    <th data-columnno="26" data-sortorder="asc" class="sortCol"><span style="padding:5px;margin:5px" class="sort-icon"><i class="fa" aria-hidden="true"></i></span>GST Type</th>
                                                    <th data-columnno="26" data-sortorder="asc" class="sortCol"><span style="padding:5px;margin:5px" class="sort-icon"><i class="fa" aria-hidden="true"></i></span>Unit Of Rate</th>
                                                    <th data-columnno="26" data-sortorder="asc" class="sortCol"><span style="padding:5px;margin:5px" class="sort-icon"><i class="fa" aria-hidden="true"></i></span>Original MRP</th>
                                                    <th data-columnno="26" data-sortorder="asc" class="sortCol"><span style="padding:5px;margin:5px" class="sort-icon"><i class="fa" aria-hidden="true"></i></span>MRP</th>
                                                    <th data-columnno="26" data-sortorder="asc" class="sortCol"><span style="padding:5px;margin:5px" class="sort-icon"><i class="fa" aria-hidden="true"></i></span>Alt SO Pend Qty</th>
                                                    <th data-columnno="26" data-sortorder="asc" class="sortCol"><span style="padding:5px;margin:5px" class="sort-icon"><i class="fa" aria-hidden="true"></i></span>Advice No</th>
                                                    <th data-columnno="26" data-sortorder="asc" class="sortCol"><span style="padding:5px;margin:5px" class="sort-icon"><i class="fa" aria-hidden="true"></i></span>Advice EntryID</th>
                                                    <th data-columnno="26" data-sortorder="asc" class="sortCol"><span style="padding:5px;margin:5px" class="sort-icon"><i class="fa" aria-hidden="true"></i></span>Advice YC</th>
                                                    <th data-columnno="26" data-sortorder="asc" class="sortCol"><span style="padding:5px;margin:5px" class="sort-icon"><i class="fa" aria-hidden="true"></i></span>Advice Date</th>
                                                    <th data-columnno="26" data-sortorder="asc" class="sortCol"><span style="padding:5px;margin:5px" class="sort-icon"><i class="fa" aria-hidden="true"></i></span>Prod SchNo</th>
                                                    <th data-columnno="26" data-sortorder="asc" class="sortCol"><span style="padding:5px;margin:5px" class="sort-icon"><i class="fa" aria-hidden="true"></i></span>Against Prod Plan No</th>
                                                    <th data-columnno="26" data-sortorder="asc" class="sortCol"><span style="padding:5px;margin:5px" class="sort-icon"><i class="fa" aria-hidden="true"></i></span>Against Prod YC</th>
                                                    <th data-columnno="26" data-sortorder="asc" class="sortCol"><span style="padding:5px;margin:5px" class="sort-icon"><i class="fa" aria-hidden="true"></i></span>Against Prod Date</th>
                                                    <th data-columnno="26" data-sortorder="asc" class="sortCol"><span style="padding:5px;margin:5px" class="sort-icon"><i class="fa" aria-hidden="true"></i></span>SO Amend No</th>
                                                    <th data-columnno="26" data-sortorder="asc" class="sortCol"><span style="padding:5px;margin:5px" class="sort-icon"><i class="fa" aria-hidden="true"></i></span>SO Amend Date</th>
                                                    <th data-columnno="26" data-sortorder="asc" class="sortCol"><span style="padding:5px;margin:5px" class="sort-icon"><i class="fa" aria-hidden="true"></i></span>Prod Sch YC</th>
                                                    <th data-columnno="26" data-sortorder="asc" class="sortCol"><span style="padding:5px;margin:5px" class="sort-icon"><i class="fa" aria-hidden="true"></i></span>Prod Sch EntryId</th>
                                                    <th data-columnno="26" data-sortorder="asc" class="sortCol"><span style="padding:5px;margin:5px" class="sort-icon"><i class="fa" aria-hidden="true"></i></span>Prod Sch Date</th>
                                                    <th data-columnno="26" data-sortorder="asc" class="sortCol SaleBillScheduleDetail"><span style="padding:5px;margin:5px" class="sort-icon"><i class="fa" aria-hidden="true"></i></span>Sch Delivery Date</th>
                                                    <th data-columnno="27" data-sortorder="asc" class="sortCol SaleBillOtherDetail"><span style="padding:5px;margin:5px" class="sort-icon"><i class="fa" aria-hidden="true"></i></span>Packets Detail</th>
                                                    <th data-columnno="28" data-sortorder="asc" class="sortCol  SaleBillOtherDetail"><span style="padding:5px;margin:5px" class="sort-icon"><i class="fa" aria-hidden="true"></i></span>Other Detail</th>
                                                    <th data-columnno="29" data-sortorder="asc" class="sortCol"><span style="padding:5px;margin:5px" class="sort-icon"><i class="fa" aria-hidden="true"></i></span>Item Remark</th>
                                                    <th data-columnno="29" data-sortorder="asc" class="sortCol gridHiddenField"><span style="padding:5px;margin:5px" class="sort-icon"><i class="fa" aria-hidden="true"></i></span>StockableNonStockable</th> @*gridHiddenField*@
                                                    <th data-columnno="29" data-sortorder="asc" class="sortCol gridHiddenField"><span style="padding:5px;margin:5px" class="sort-icon"><i class="fa" aria-hidden="true"></i></span>CustJwAdjustmentMandatory</th>  @*gridHiddenField*@
                                                    <th data-columnno="29" data-sortorder="asc" class="sortCol gridHiddenField"><span style="padding:5px;margin:5px" class="sort-icon"><i class="fa" aria-hidden="true"></i></span>VendJwAdjustmentMandatory</th>  @*gridHiddenField*@
                                                </tr>
                                            </thead>
                                            <tbody id="divSaleBillList">
                                                <partial name="_SaleBillGrid" />
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                            <div class="card">
                                <div class="card-body overflow-auto pb-0 jobWorkChalln">
                                    <table class="table table-hover table-bordered table-striped IssueNRGPTb">
                                        <thead class="bg-gradient card-headerBG text-light small" style="white-space:nowrap">
                                            <tr>
                                                <th>SR#</th>
                                                <th class="sortCol" data-sortorder="asc" data-columnno="1"><span style="padding:5px; margin:5px;" class="sort-icon"><i class="fa" aria-hidden="true"></i></span>EntryId Rec Jw</th>
                                                <th class="sortCol" data-sortorder="asc" data-columnno="2"><span style="padding:5px; margin:5px;" class="sort-icon"><i class="fa" aria-hidden="true"></i></span>Rec JW Challan no</th>
                                                <th class="sortCol" data-sortorder="asc" data-columnno="3"><span style="padding:5px; margin:5px;" class="sort-icon"><i class="fa" aria-hidden="true"></i></span>Rec YearCode</th>
                                                <th class="sortCol" data-sortorder="asc" data-columnno="5"><span style="padding:5px; margin:5px;" class="sort-icon"><i class="fa" aria-hidden="true"></i></span>Challan Date</th>
                                                <th class="sortCol" data-sortorder="asc" data-columnno="6"><span style="padding:5px; margin:5px;" class="sort-icon"><i class="fa" aria-hidden="true"></i></span>RecPartCode</th>
                                                <th class="sortCol" data-sortorder="asc" data-columnno="7"><span style="padding:5px; margin:5px;" class="sort-icon"><i class="fa" aria-hidden="true"></i></span>RecItemName</th>
                                                <th class="sortCol" data-sortorder="asc" data-columnno="8"><span style="padding:5px; margin:5px;" class="sort-icon"><i class="fa" aria-hidden="true"></i></span>BomNo</th>
                                                <th class="sortCol" data-sortorder="asc" data-columnno="9"><span style="padding:5px; margin:5px;" class="sort-icon"><i class="fa" aria-hidden="true"></i></span>Bom Date</th>
                                                @* <th class="sortCol" data-sortorder="asc" data-columnno="10"><span style="padding:5px; margin:5px;" class="sort-icon"><i class="fa" aria-hidden="true"></i></span>Bom Status</th> *@
                                                <th class="sortCol" data-sortorder="asc" data-columnno="11"><span style="padding:5px; margin:5px;" class="sort-icon"><i class="fa" aria-hidden="true"></i></span>Pend Qty</th>
                                                <th class="sortCol" data-sortorder="asc" data-columnno="12"><span style="padding:5px; margin:5px;" class="sort-icon"><i class="fa" aria-hidden="true"></i></span>IssuePartCode</th>
                                                <th class="sortCol" data-sortorder="asc" data-columnno="12"><span style="padding:5px; margin:5px;" class="sort-icon"><i class="fa" aria-hidden="true"></i></span>IssueItemName</th>
                                                <th class="sortCol" data-sortorder="asc" data-columnno="12"><span style="padding:5px; margin:5px;" class="sort-icon"><i class="fa" aria-hidden="true"></i></span>BomQty</th>
                                                <th class="sortCol" data-sortorder="asc" data-columnno="12"><span style="padding:5px; margin:5px;" class="sort-icon"><i class="fa" aria-hidden="true"></i></span>Qty ToRec</th>
                                                <th class="sortCol" data-sortorder="asc" data-columnno="12"><span style="padding:5px; margin:5px;" class="sort-icon"><i class="fa" aria-hidden="true"></i></span>ActualAdjQty</th>
                                                <th class="sortCol" data-sortorder="asc" data-columnno="12"><span style="padding:5px; margin:5px;" class="sort-icon"><i class="fa" aria-hidden="true"></i></span>BatchNo</th>
                                                <th class="sortCol" data-sortorder="asc" data-columnno="12"><span style="padding:5px; margin:5px;" class="sort-icon"><i class="fa" aria-hidden="true"></i></span>UniqueBatchNo</th>
                                                <th class="sortCol" data-sortorder="asc" data-columnno="12"><span style="padding:5px; margin:5px;" class="sort-icon"><i class="fa" aria-hidden="true"></i></span>IssQty</th>
                                                @* <th class="sortCol" data-sortorder="asc" data-columnno="12"><span style="padding:5px; margin:5px;" class="sort-icon"><i class="fa" aria-hidden="true"></i></span>Rate</th> *@
                                                <th class="sortCol" data-sortorder="asc" data-columnno="12"><span style="padding:5px; margin:5px;" class="sort-icon"><i class="fa" aria-hidden="true"></i></span>OriginalRecQty</th>
                                                <th class="sortCol" data-sortorder="asc" data-columnno="12"><span style="padding:5px; margin:5px;" class="sort-icon"><i class="fa" aria-hidden="true"></i></span>IdealScrap</th>
                                                <th class="sortCol" data-sortorder="asc" data-columnno="12"><span style="padding:5px; margin:5px;" class="sort-icon"><i class="fa" aria-hidden="true"></i></span>IssuedScrap</th>

                                            </tr>
                                        </thead>
                                        <tbody id="divCustJobWorkISsueSummary">
                                            @* <partial name="_JOBWORKISSUESUMMARY" /> *@
                                            @await Html.PartialAsync("_CustomerJwisschallanAdjustment", Model.CustomerJobWorkChallanAdj)
                                        </tbody>
                                    </table>
                                </div>
                            </div>

                            <div class="card">
                                <div class="card-body overflow-auto pb-0">
                                    <table class="table table-hover table-bordered table-striped IssueNRGPTb jobWorkChalln">
                                        <thead class="bg-gradient card-headerBG text-light small" style="white-space:nowrap">
                                            <tr>
                                                <th>SR#</th>
                                                <th class="sortCol" data-sortorder="asc" data-columnno="1"><span style="padding:5px; margin:5px;" class="sort-icon"><i class="fa" aria-hidden="true"></i></span>FG PartCode</th>
                                                <th class="sortCol" data-sortorder="asc" data-columnno="2"><span style="padding:5px; margin:5px;" class="sort-icon"><i class="fa" aria-hidden="true"></i></span>FG ItemName</th>
                                                <th class="sortCol" data-sortorder="asc" data-columnno="3"><span style="padding:5px; margin:5px;" class="sort-icon"><i class="fa" aria-hidden="true"></i></span>Rm ItemName</th>
                                                <th class="sortCol" data-sortorder="asc" data-columnno="5"><span style="padding:5px; margin:5px;" class="sort-icon"><i class="fa" aria-hidden="true"></i></span>Rm PartCode</th>
                                                <th class="sortCol" data-sortorder="asc" data-columnno="6"><span style="padding:5px; margin:5px;" class="sort-icon"><i class="fa" aria-hidden="true"></i></span>Qty</th>
                                                <th class="sortCol" data-sortorder="asc" data-columnno="7"><span style="padding:5px; margin:5px;" class="sort-icon"><i class="fa" aria-hidden="true"></i></span>ActualPendQty</th>
                                                <th class="sortCol" data-sortorder="asc" data-columnno="8"><span style="padding:5px; margin:5px;" class="sort-icon"><i class="fa" aria-hidden="true"></i></span>PendToAdjust</th>
                                                <th class="sortCol" data-sortorder="asc" data-columnno="9"><span style="padding:5px; margin:5px;" class="sort-icon"><i class="fa" aria-hidden="true"></i></span>BOMIND</th>
                                                <th class="sortCol" data-sortorder="asc" data-columnno="10"><span style="padding:5px; margin:5px;" class="sort-icon"><i class="fa" aria-hidden="true"></i></span>ProdUnProd</th>
                                                <th class="sortCol" data-sortorder="asc" data-columnno="11"><span style="padding:5px; margin:5px;" class="sort-icon"><i class="fa" aria-hidden="true"></i></span>Fully Adjusted</th>

                                            </tr>
                                        </thead>
                                        <tbody id="divBomCustJobWorkISsueSummary">
                                            @* <partial name="_JOBWORKISSUESUMMARY" /> *@
                                            @await Html.PartialAsync("_BomCustJwisschallanAdjustment", new List<BomCustomerJWIssChallanADJ>())
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            <div class="progress my-3 mb-3" style="height: 4px;">
                                <div class="progress-bar progress-bar-striped bg-warning" role="progressbar" style="width: 100%" aria-valuenow="100" aria-valuemin="0" aria-valuemax="100"></div>
                            </div>
                          @*   <div class="row g-2 gx-3">
                                <div class="col-12 text-center">
                                    <strong>BASIC TOTAL : <i class="fa-solid fa-indian-rupee-sign fa-fw fa-1x"></i><span id="lblItemNetAmount"></span></strong>
                                    <strong>Total Qty : <span id="TotalQty"></span></strong>
                                    <input type="hidden" asp-for="BillAmt" />
                                    <strong>, TOTAL NO OF ITEMS : <span id="lblItemCount"></span></strong>
                                </div>
                            </div> *@
                        </div>
                    </div>
                </div>
                <div class="accordion-item">
                    <h2 class="accordion-header" id="H_TaxDetail">
                        <button class="accordion-button collapsed text-light pnl1BG bg-gradient" type="button" data-bs-toggle="collapse" data-bs-target="#B_TaxDetail" aria-expanded="true" aria-controls="B_TaxDetail">
                            <strong style="text-transform:uppercase"><i class="fa-solid fa-table-list fa-lg fa-fw pr35 fa-fade" style="--fa-animation-duration: 2s; --fa-fade-opacity: 0.6;"></i>Tax Detail</strong>
                            <div class="d-flex justify-content-center align-items-center flex-grow-1">
                                <strong> NetTotal : <i class="fa-solid fa-indian-rupee-sign fa-fw fa-1x"></i><span id="NetTotal1"></span></strong>
                            </div>
                        </button>
                          
                            
                    </h2>
                    <div id="B_TaxDetail" class="accordion-collapse collapse pnl4 bg-gradient" aria-labelledby="H_TaxDetail">
                        <div class="accordion-body">
                            @*    @await Html.PartialAsync("_TaxDetail", Model) *@
                            <partial name="_TaxDetail" />
                            <div class="progress my-3" style="height: 4px;">
                                <div class="progress-bar progress-bar-striped bg-danger" role="progressbar" style="width: 100%" aria-valuenow="100" aria-valuemin="0" aria-valuemax="100"></div>
                            </div>
                            <div class="row g-2 gx-3 justify-content-around">
                                <div class="col-xl-2 col-lg-3 col-md-3 col-sm-6 col-xs-12">
                                    <label asp-for="TotalRoundOff" class="form-label">RoundOff</label>
                                    <select class="form-select" asp-for="TotalRoundOff" asp-items="Model.YesNoList">
                                        <option value="">-Select-</option>
                                    </select>
                                </div>
                                <div class="col-xl-2 col-lg-3 col-md-3 col-sm-6 col-xs-12" id="RoundOff">
                                    <div class="d-flex align-items-center">
                                        <label asp-for="RoundOffAccountCode" class="form-label text-danger mb-0">Account*</label>
                                        <div class="form-check form-switch">
                                            <input asp-for="RDT" class="form-check-input" type="checkbox" role="switch" />
                                            <label class="form-check-label">Show All</label>
                                        </div>
                                    </div>

                                    <select asp-for="RoundOffAccountCode" class="form-select mt-1">
                                        <option value="0">-Select-</option>
                                    </select>
                                    @if (Model.Mode == "U" || Model.Mode == "V")
                                    {
                                        <input type="hidden" asp-for="RoundOffAccountCode" id="hiddenRoundOffAccountCode" />
                                    }
                                </div>
                                <div class="col-xl-2 col-lg-3 col-md-3 col-sm-6 col-xs-12" style="display:none">
                                    <label asp-for="TotalDiscountPercentage" class="form-label">Discount %</label>
                                    <input asp-for="TotalDiscountPercentage" class="form-control" min="0" max="100" />
                                </div>
                                <div class="col-xl-2 col-lg-3 col-md-3 col-sm-6 col-xs-12" style="display:none">
                                    <label asp-for="TotalAmtAftrDiscount" class="form-label">Amt Aftr Discount</label>
                                    <input asp-for="TotalAmtAftrDiscount" class="form-control" readonly />
                                </div>
                                <div class="col-xl-2 col-lg-3 col-md-3 col-sm-6 col-xs-12">
                                    <label asp-for="TotalRoundOffAmt" class="form-label">(+/-) RoundOff Amount</label>
                                    <input asp-for="TotalRoundOffAmt" class="form-control" readonly />
                                    <input id="TotalRoundOffAmt1" class="form-control" type="hidden" readonly />
                                </div>
                                <div class="col-xl-2 col-lg-3 col-md-3 col-sm-6 col-xs-12">
                                    <label asp-for="NetTotal" class="form-label">Net Total</label>
                                    <input asp-for="NetTotal" class="form-control" readonly />
                                    @if (Model.Mode == "U")
                                    {
                                        <input type="hidden" asp-for="AttachmentFile1" value="@Model.AttachmentFile1" id="hiddenAttachmentFile1" />
                                    }
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="accordion-item">
                    @*  <partial name="_DrCrTable" /> *@
                    @await Html.PartialAsync("_DrCrTable", Model)
                </div>
                <div class="accordion-item">
                    @await Html.PartialAsync("_AdjustmentGrid", Model.adjustmentModel ?? new Common.AdjustmentModel())
                    @*  <partial name="_AdjustmentGrid" /> *@
                </div>
                <div class="accordion-item">
                    <h2 class="accordion-header" id="HPanel4">
                        <button class="accordion-button collapsed text-light pnl4BG bg-gradient" type="button" data-bs-toggle="collapse" data-bs-target="#BPanel4" aria-expanded="true" aria-controls="BPanel4">
                            <strong style="text-transform:uppercase"><i class="fa-solid fa-table-list fa-lg fa-fw pr35 fa-fade" style="--fa-animation-duration: 2s; --fa-fade-opacity: 0.6;"></i>Other Detail</strong>
                            <small class="p-3"></small>
                        </button>
                    </h2>
                    <div id="BPanel4" class="accordion-collapse collapse pnl1 bg-gradient" aria-labelledby="HPanel4">
                        @*   <partial name="_SaleBillOtherDetail" />  *@
                        @await Html.PartialAsync("_SaleBillOtherDetail", Model)

                    </div>
                </div>
            </div>
        </div>
        <div class="card-footer p-3">
            <div class="card-header card-headerBG text-light bg-gradient">
                <h5>
                    <strong>@ViewData["Title"] - @Model.SaleBillYearCode</strong>
                    <span class="d-flex float-end" style="margin-top:-2px;">
                        @*<a asp-action="Dashboard" asp-route-ID="0" class="btn btn-sm btn-outline-light bg-gradient">*@
                        <div class="row justify-content-between g-2">
                            <div class="col-auto">
                                @*<a href="#" class="btn offer-listbtn hvr-sweep-to-right btn-sm btn-secondary" onclick="back();">*@

                                <a asp-action="SaleBillOnCounterDashboard" asp-route-ID="0" class="btn btn-secondary btn-sm">
                                    <i class="fa-solid fa-grid-horizontal fa-lg fa-fw fa-beat" style="--fa-animation-duration: 2s;"></i>
                                    Dashboard
                                </a>
                                <a href="#" class=" btn btn-primary btn-sm">
                                    <i class="fa fa-chevron-circle-left fa-fw fa-lg" aria-hidden="true"></i>
                                    BACK
                                </a>
                            </div>
                            <div class="col-auto me-2">
                                @if (Model.Mode != "V")
                                {
                                    <button type="button" class="PartialSave btn btn-secondary btn-sm mr-2" style="color:white!important">
                                        <i class="fa-solid fa-floppy-disk-pen fa-fw fa-lg" style="--fa-secondary-color: crimson; --fa-secondary-opacity: 1.0;"></i>
                                        PARTIAL SAVE
                                    </button>
                                }

                            </div>
                            @if (Model.Mode != "V")
                            {
                                <div class="col-auto">
                                    @*  <a class="btn btn-sm btn-outline-danger" onclick="location.href=$('form')[0].action">*@
                                    <a class="btn btn-secondary btn-sm" asp-action="SaleInvoice" asp-controller="SaleInvoice">
                                        @* <i class="fa-solid fa-grip fa-lg fa-fw fa-beat" style="--fa-animation-duration: 2s;"></i>*@
                                        <i class="fa fa-refresh fa-fw fa-lg" aria-hidden="true"></i>
                                        REFRESH
                                    </a>
                                </div>
                                @if (Model.Mode == "U")
                                {
                                    @*Model.Mode = "U";*@
                                    <div class="col-auto">
                                        @* <button type="submit" class="btn btn-sm btn-outline-warning">*@
                                        <button type="submit" class="btn btn-sm btn-outline-light bg-gradient" id="UpdateButton">
                                            <i class="fa fa-pencil-square fa-fw fa-lg" aria-hidden="true"></i>
                                            UPDATE
                                        </button>
                                    </div>
                                }
                                else
                                {
                                    <div class="col-auto">
                                        @*   <button type="submit" class="btn btn-sm btn-outline-primary">*@
                                        <button type="submit" class="btn btn-primary btn-sm" id="submitBTNfooter">
                                            <i class="fa-solid fa-chevron-circle-right"></i>
                                            SUBMIT
                                        </button>
                                    </div>
                                }
                            }
                        </div>
                    </span>
                </h5>
            </div>
        </div>
    </form>
</div>
@* <div class="modal fade" id="EinvoicePopup" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="EinvoicePopupLabel" aria-hidden="true">
    <div class="modal-dialog modal-sm modal-dialog-centered">
        <div class="modal-content text-center">
            <div class="modal-header border-0">
                E-Invoice Confirmation
                <h5 class="modal-title w-100" id="EinvoicePopupLabel">E-Invoice Confirmation</h5>
            </div>
            <div class="modal-body">
                <p>Do you want to generate E-Invoice now?</p>
            </div>
            <div class="modal-footer justify-content-center border-0">
                <a href="#" class="btn btn-success" id="btngenrateEinvoice">Yes</a>
                <button type="button" class="btn btn-secondary" id="btnClose">No</button>
            </div>
        </div>
    </div>
</div> *@

@* ---------------------------- *@
@* Get SaleOrder Data On CHANGE OF coustomerName *@

<div class="modal fade" style="display:none" id="PendSaleOrderModel" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="staticBackdropLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl" role="document" ">
        <div class="modal-content">
            <div class="modal-header">

    @*  <label style="margin-left:3px;margin-right:3px" for="StoreName">Store Name</label>
                <select class="form-select" asp-for="StoreId" id="MultiStoreName" style="width:170px">
                <option value="0">-Select-</option>
                </select> *@
                <h2>Pending Sale Order For Sale Invoice</h2>


                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>

            </div>
            <div class="modal-body">
                <div class="card">
                    <div class="card-body">
                        <div class="row g-2 gx-3">

                            <div class="card-body text-center overflow-auto pb-0 pt-0  ">
                                <div class="d-flex align-items-center mb-2">
                                    <button class="btn btn-sm btn-outline-warning mb-2" type="button" id="CheckAllForPendSO" style="display: flex; align-items: center;">
                                        <i class="fa fa-check-square" aria-hidden="true"></i>
                                        <span style="margin-left: 5px;">Ch/UnCh All</span>
                                    </button>
                                    <div class="col-md-2 me-3" style="margin-left:50px">
                                        <input type="text" class="form-control" id="search-box1" placeholder="Search..." style="background-color:#FFFACD;">
                                    </div>
    @*  <button class="btn btn-sm btn-outline-success mb-2" type="button" onclick="ShowGroupWiseItems()" style="display: flex; align-items: center;">
                                    <i class="fa fa-eye" aria-hidden="true"></i>
                                    <span style="margin-left: 5px;">Show</span>
                                    </button> *@
                                </div>
                                <div class="table-responsive" style="max-height:350px;">
                                    <table class="table table-hover table-bordered table-striped mb-0">
                                        <thead class="bg-gradient card-headerBG text-light small" style="white-space:nowrap">
                                            <tr>

                                                <th>Action</th>
                                                <th>SO No</th>
                                                <th class="hiddenColumn">SO YC</th>
                                                <th class="hiddenColumn">CustOrderNo</th>
                                                <th class="hiddenColumn">Sch No</th>
                                                <th class="hiddenColumn">Sch YC</th>

                                                <th>Part Code</th>
                                                <th>Item Name</th>
                                                <th>Rate</th>
                                                <th>Qty</th>
                                                <th>Amount</th>
                                                <th>Dis %</th>
                                                <th>Dis Amt</th>
                                                <th>Unit</th>
                                                <th>RacKID</th>
                                                <th>HSNNo</th>

                                                <th>Pend Qty</th>
                                                <th class="hiddenColumn">StoreName</th>
                                                <th class="">Batch No</th>
                                                <th class="hiddenColumn">Unique Batch No</th>
                                                <th class="hiddenColumn">TotalStock</th>
                                                <th class="">BatchStock</th>


                                                <th class="hiddenColumn">SO Type</th>


                                                <th class="hiddenColumn">Alt Qty</th>
                                                <th class="hiddenColumn">ItemCode</th>


                                            </tr>
                                        </thead>
                                        <tbody id="divPendSOGrid">
                                            <tr class="text-center">
                                                <td colspan="25" class="text-black-50"><strong>NO DATA YET</strong></td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>

                        </div>
                    </div>
                    <div class="progress my-2" style="height: 4px;">
                        <div class="progress-bar progress-bar-striped bg-danger" role="progressbar" style="width: 100%" aria-valuenow="100" aria-valuemin="0" aria-valuemax="100"></div>
                    </div>
                    <div class="row g-2 gx-3">
                        <div class="col-12 text-center">
                            <strong>Total No Of Items : <span id="lblTotalNoOfItems1"></span></strong>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="GridButton1 btn btn-sm btn-outline-success me-2">
                        <i class="fa-solid fa-angles-down fa-fw fa-lg"></i> ADD TO GRID
                    </button>

                    <button type="button" class="btn btn-sm btn-danger" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>
</div>









    @* --------------------------------*@

    @* for groupwise item *@
<div class="modal fade" style="display:none" id="SaleOrderGroupWiseItem" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="staticBackdropLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl" role="document" ">
        <div class="modal-content">
            <div class="modal-header">
                <label style="margin-left:3px;margin-right:3px" for="Group_Code1">Group_Code</label>
                <select class="form-select" asp-for="Group_Code" id="Group_Code1" style="width:170px">
                    <option value="0">-Select-</option>
                </select>
                <label style="margin-left:3px;margin-right:3px" for="StoreName">Store Name</label>
                <select class="form-select" asp-for="StoreId" id="MultiStoreName" style="width:170px">
                   
                </select>
                <input type="text" id="SearchPartCode" style="width:170px" placeholder="partcode">


                <label style="margin-left:3px;margin-right:3px" for="PartName">Party Name</label>
                <input type="text" id="PartyName" style="width:200px" class="form-control" readonly />
                <label for="PartName" style="margin-left:3px;margin-right:3px">Disc Category</label>
                <input type="text" id="DiscCategory" style="width:200px" class="form-control" readonly />

                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>

            </div>
            <div class="modal-body">
                <div class="card">
                    <div class="card-body">
                        <div class="row g-2 gx-3">

                            <div class="card-body text-center overflow-auto pb-0   ">
                                <div class="d-flex align-items-center mb-2">
                                    <button class="btn btn-sm btn-outline-warning mb-2" type="button" id="CheckAll" style="display: flex; align-items: center;">
                                        <i class="fa fa-check-square" aria-hidden="true"></i>
                                        <span style="margin-left: 5px;">Ch/UnCh All</span>
                                    </button>
                                    <div class="col-md-2 me-3" style="margin-left:50px">
                                        <input type="text" class="form-control" id="search-box1" placeholder="Search..." style="background-color:#FFFACD;">
                                    </div>
                                    <button class="btn btn-sm btn-outline-success mb-2" type="button" onclick="ShowGroupWiseItems()" style="display: flex; align-items: center;">
                                        <i class="fa fa-eye" aria-hidden="true"></i>
                                        <span style="margin-left: 5px;">Show</span>
                                    </button>
                                </div>
                                <div class="table-responsive" style="max-height:350px;">
                                    <table class="table table-hover table-bordered table-striped mb-0">
                                        <thead class="bg-gradient card-headerBG text-light small" style="white-space:nowrap">
                                            <tr>
                                                <th>Sr#</th>
                                                <th>Action</th>
                                                <th>Part Code</th>
                                                <th>Item Name</th>

                                                <th>Qty</th>
                                                <th>Rate</th>
                                                <th>Discount %</th>
                                                <th>Discount Amt</th>
                                                <th>Amount</th>
                                                <th>TotalStock</th>
                                                <th>Lot Stock</th>
                                                <th>Batch No</th>
                                                <th>Unique Batch No</th>

                                                <th>Unit</th>
                                                <th>HSNNO</th>


                                            </tr>
                                        </thead>
                                        <tbody id="MultiItemBody">
                                            <partial name="_SaleBillGroupWiseItems" />
                                        </tbody>
                                    </table>
                                </div>
                            </div>

                        </div>
                    </div>
                    <div class="progress my-2" style="height: 4px;">
                        <div class="progress-bar progress-bar-striped bg-danger" role="progressbar" style="width: 100%" aria-valuenow="100" aria-valuemin="0" aria-valuemax="100"></div>
                    </div>
                    <div class="row g-2 gx-3">
                        <div class="col-12 text-center">
                            <strong>Total No Of Items : <span id="lblTotalNoOfItemsGroupWise"></span></strong>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="GridMultiItemBtn btn btn-sm btn-outline-success me-2">
                        <i class="fa-solid fa-angles-down fa-fw fa-lg"></i> ADD TO GRID
                    </button>

                    <button type="button" class="btn btn-sm btn-danger" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>
</div>



@* ---------------------*@

@* Pend SO For Sale Bill*@


<div class="modal fade" style="display:none" id="PendSOForSaleBill" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="staticBackdropLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl" role="document" ">
        <div class="modal-content">
            <div class="modal-header">
             

                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>

            </div>
            <div class="modal-body">
                <div class="card">
                    <div class="card-body">
                        <div class="row g-2 gx-3">

                            <div class="card-body text-center overflow-auto pb-0   ">
                                <div class="d-flex align-items-center mb-2">
                                    <button class="btn btn-sm btn-outline-warning mb-2" type="button" id="CheckAll" style="display: flex; align-items: center;">
                                        <i class="fa fa-check-square" aria-hidden="true"></i>
                                        <span style="margin-left: 5px;">Ch/UnCh All</span>
                                    </button>
                                    <div class="col-md-2 me-3" style="margin-left:50px">
                                        <input type="text" class="form-control" id="search-box1" placeholder="Search..." style="background-color:#FFFACD;">
                                    </div>
                                   
                                </div>
                                <div class="table-responsive" style="max-height:350px;">
                                    <table class="table table-hover table-bordered table-striped" id="GateDataTable" style="table-layout: fixed;">
                                        <thead class="bg-gradient card-headerBG text-light small" style="white-space:nowrap">
                                            <tr>
                                                <th style="width:70px;">Action <input id="checkuncheck" class="form-check-input me-1 mt-2" type="checkbox" role="switch" /></th>

                                                <th style="width:70px;">SO No</th>


                                                <th style="width:150px;">Part Code</th>
                                                <th style="width:250px;">Item Name</th>
                                                <th style="width:100px;">Bill Qty</th>
                                                <th style="width:100px;">Rate</th>
                                                
                                                <th style="width:70px;">Disc %</th>
                                               
                                                <th style="width:100px;">Disc Amount</th>
                                                <th style="width:120px;">Item Amount</th>
                                                <th style="width:70px;">Order Qty</th>
                                                <th style="width:70px;">Pending Qty</th>
                                               
                                               
                                                <th style="width:70px;">Unit</th>
                                                <th style="width:70px;">Location</th>
                                                <th style="width:70px;">SOYear </th>
                                                <th style="width:90px;">Order No</th>
                                                <th style="width:70px;">Sch No</th>
                                                <th style="width:70px;">Sch Year </th>
                                                <th style="width:70px;">SO Type</th>
                                                <th style="width:70px;">SO For</th>

                                                <th style="width:70px;">HSN No</th>
                                                <th style="width:80px;">TotalStock</th>
                                                <th style="width:150px;">Batch No</th>
                                                <th style="width:150px;">Unique Batch No</th>
                                                <th style="width:70px;">Batch Stock</th>
                                               
                                                
                                                <th style="width:100px;">AltQty</th>
                                                <th style="width:100px;">StoreId</th>
                                                <th style="width:150px;">StoreName</th>
                                                <th style="width:200px;">Customer Name</th>
                                                <th style="width:120px;">Account Code</th>
                                                <th style="width:120px;">Item Code</th>


                                            </tr>
                                        </thead>
                                        <tbody id="divPendMRNGrid">
                                            <tr class="text-center">
                                                <td colspan="25" class="text-black-50"><strong>NO DATA YET</strong></td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>

                        </div>
                    </div>
                    <div class="progress my-2" style="height: 4px;">
                        <div class="progress-bar progress-bar-striped bg-danger" role="progressbar" style="width: 100%" aria-valuenow="100" aria-valuemin="0" aria-valuemax="100"></div>
                    </div>
                    <div class="row g-2 gx-3">
                        <div class="col-12 text-center">
                            <strong>Total No Of Items : <span id="lblTotalNoOfItemsPendSO"></span></strong>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class=" btn btn-sm btn-outline-success me-2" onclick="AddPendSOToGrid(event)">
                        <i class="fa-solid fa-angles-down fa-fw fa-lg"></i> ADD TO GRID
                    </button>

                    <button type="button" class="btn btn-sm btn-danger" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>
</div>
@* ----------------------------
 *@
<div class="modal fade" id="EinvoicePopup" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1"
     aria-labelledby="staticBackdropLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="staticBackdropLabel">E-Invoice Confirmation</h3>
                <button type="button" class="btn-close" data-bs-dismiss="modal" onclick="" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="card">
                    <div class="card-body">
                        <div class="row g-2 gx-3">
                            <div class="card">
                                <div class="card-body overflow-auto pb-0">
                                    <div class="col-xl-8 col-lg-8 col-md-8 col-sm-8 col-xs-12">
                                        <div class="d-flex align-items-center">
                                            <h6 class="mb-0 me-2">Do you want to generate E-Invoice now?</h6>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    @*     <div class="progress my-2" style="height: 4px;">
                    <div class="progress-bar progress-bar-striped bg-danger" role="progressbar" style="width: 100%" aria-valuenow="100" aria-valuemin="0" aria-valuemax="100"></div>
                    </div> *@
                </div>
                <div class="modal-footer">
                    <a href="#" class="btn btn-primary" id="btngenrateEinvoice">
                        save & Generate Einvoice
                    </a>
                    <button type="button" class="btn btn-danger" id="btnSaveAndDashBoard">Save & DashBoard</button>
                    <button type="button" class="btn btn-danger" id="btnClose">
                        @* <span class="spinner-border spinner-border-sm me-2 d-none" role="status" id="btnCloseSpinner" aria-hidden="true"></span> *@
                        Save
                    </button>
                    <button type="button" class="btn btn-danger" id="btnSaveAndPrint">
                        @* <span class="spinner-border spinner-border-sm me-2 d-none" role="status" id="btnCloseSpinner" aria-hidden="true"></span> *@
                        Save & Print
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="PasswordAllowPopup" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1"
     aria-labelledby="staticBackdropLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="staticBackdropLabel">Generate EInvoice</h3>
                <button type="button" class="btn-close" data-bs-dismiss="modal" onclick="" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="card">
                    <div class="card-body">
                        <div class="row g-2 gx-3">
                            <div class="card">
                                <div class="card-body overflow-auto pb-0">
                                    <div class="col-xl-8 col-lg-8 col-md-8 col-sm-8 col-xs-12">
                                        <div class="d-flex align-items-center">
                                            <h6 class="mb-0 me-2">Do You Generate Einvoice?</h6>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="progress my-2" style="height: 4px;">
                        <div class="progress-bar progress-bar-striped bg-danger" role="progressbar" style="width: 100%" aria-valuenow="100" aria-valuemin="0" aria-valuemax="100"></div>
                    </div>
                </div>
                <div class="modal-footer">
                    <a href="#" class="btn btn-primary" id="btnEwaybill">
                        E-Invoice + E-Way Bill
                    </a>
                    <button type="button" class="btn btn-danger" id="btnEinvoiceOnly">E-Invoice Only</button>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="SubmitionForm" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1"
     aria-labelledby="staticBackdropLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="staticBackdropLabel">Confirmation </h3>
                <button type="button" class="btn-close" data-bs-dismiss="modal" onclick="" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="card">
                    <div class="card-body">
                        <div class="row g-2 gx-3">
                            <div class="card">
                                <div class="card-body overflow-auto pb-0">
                                    <div class="col-xl-8 col-lg-8 col-md-8 col-sm-8 col-xs-12">
                                        <div class="d-flex align-items-center">
                                            <h6 class="mb-0 me-2">Do You Want Save&Print or Save & E-way Bill?</h6>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="progress my-2" style="height: 4px;">
                        <div class="progress-bar progress-bar-striped bg-danger" role="progressbar" style="width: 100%" aria-valuenow="100" aria-valuemin="0" aria-valuemax="100"></div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-danger" id="btnClose">Save</button>
                    <a href="#" class="btn btn-primary" id="btnPrint">
                        <i class="fa fa-print"></i> Save & Print
                    </a>
                    <a href="#" class="btn btn-primary" id="btnPrintEmail">
                        <i class="fa fa-print"></i> Save & Print & Email
                    </a>
                    @* <button type="button" class="btn btn-danger" id="btnEwayBill">Save & EWay Bill</button> *@
                </div>
            </div>
        </div>
    </div>
</div>

@* <div class="modal fade" id="exampleModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="exampleModalLabel">Sale Bill</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close" onclick="CloseCross()">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                are you sure you want to save this entry?
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="CloseButton()">Close</button>
                <button type="button" class="btn btn-primary" id="SubmitButton">Save</button>
            </div>
        </div>
    </div>
</div> *@
<div id="ajaxLoader" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background-color:rgba(255,255,255,0.7); z-index:9999; text-align:center;">
    <div style="position:absolute; top:50%; left:50%; transform:translate(-50%, -50%);">
        <span class="spinner-border text-primary" role="status"></span>
        <br />
        <span>Processing...</span>
    </div>
</div>
<style>
    .modal-fullscreen .modal-content {
        height: 80%;
        border: 0;
        border-radius: 0;
    }

    .no-cursor {
        pointer-events: none; /* Prevent clicking/typing */
        caret-color: transparent; /* Hide blinking cursor */
        background-color: white; /* Keep normal background */
        color: black; /* Keep normal text color */
        border: none; /* Remove border for clean look */
    }

    .tooltip-container {
        position: relative;
        display: inline-block;
    }

        .tooltip-container .tooltip-text {
            visibility: hidden;
            background-color: black;
            color: #fff;
            text-align: center;
            padding: 3px 8px;
            border-radius: 5px;
            position: absolute;
            z-index: 1;
            bottom: 125%; /* above the input */
            left: 50%;
            transform: translateX(-50%);
            opacity: 0;
            transition: opacity 0.2s;
        }

        .tooltip-container:hover .tooltip-text {
            visibility: visible;
            opacity: 1;
        }

    .card.PendingItem {
        background-color: #fff7e6; /* soft yellow */
        border: 1px solid #ffcc80;
    }

    #IssueThrBom {
        background-color: #343a40; /* dark grey */
        color: white;
    }

    .select2-container--default .select2-selection--single .select2-selection__rendered {
        color: #444;
        line-height: 28px;
        width: 200px;
    }
</style>

@section Scripts
{
    <script>
        var exportSupplyTypes = [
            "EXPORT WITH PAYMENT",
            "WITH SEZ PAYMENT",
            "SEZ WITHOUT PAYMENT",
            "EXPORT WITHOUT PAYMENT",
            "DEEMED EXPORT",
            "BUSINESS TO BUSINESS"
        ];
        var formRights = {
            sooptView: false,
            sooptUpdate: false
        };
         function AutoFillPARTYNAMELIST() {
            // Source for PartCodeText
            const AccountCodeSourse = function (request, response) {
                $.ajax({
                      url: '@Url.Action("AutoFillPARTYNAMELIST", "SaleOrder")',
                    type: 'POST',
                    data: {

                        SearchAccount: request.term
                    },
                    success: function (result) {
                        let obj = typeof result === "string" ? JSON.parse(result) : result;

                        if (obj.StatusCode === 200 && obj.StatusText === 'Success' && Array.isArray(obj.Result.Table)) {
                            let filtered = obj.Result.Table.filter(function (item) {
                                let term = request.term.toLowerCase();
                                return item.Account_Name.toLowerCase().includes(term);
                            });

                            response($.map(filtered, function (item) {
                                return {
                                    label: item.Account_Name,
                                    value: item.Account_Name,
                                    accountCode: item.Account_Code,

                                };
                            }));
                        } else {
                            response([]);
                        }
                    }
                });
            };



            // Autocomplete for PartCodeText
            $("#AccountCodeText").autocomplete({
                source: AccountCodeSourse,
                select: function (event, ui) {
                    $("#AccountCodeText").val(ui.item.value).data("Account_Code", ui.item.accountCode);

                    $('#AccountCode').val(ui.item.accountCode);
                    FillSONO();
            FillCurrency();
            FillCustomerAddress();

                    // $('#PendSOForSaleBill').modal('show');
                    showDetail();
                   

            if ($('#divTaxGrid tr td').length > 1) {
                btnClearTax();
            }
            if ($('#divSaleBillList tr td').length > 1) {
                //ClearGrid();
            }
            if ($('#divdbCrItemList tr td').length > 1) {
                ClearDRCRGrid();
            }
                    return false;
                },
                focus: function (event, ui) {
                    $("#AccountCodeText").val(ui.item.value);

                    return false;
                },
                minLength: 2
            });


        }
        function GetSONoFormRights() {
            $.ajax({
                url: "@Url.Action("GetFormRights", "SaleOrder")",
                type: "POST",
                success: function (data) {
                    if (!data) return;
                    var obj = $.parseJSON(data);
                    var r = obj.Result.Table[0];
                    formRights.sooptView = r.OptView;
                    formRights.sooptUpdate = r.OptUpdate;

                },
                error: function (errMsg) {
                    $.notify(errMsg, { position: "top center", className: "error" });
                }
            });
        }
        function redirectToSOEdit() {

            var SONo = $('#SONO option:selected').val();
            var yearCode = $('#SOYearCode option:selected').val();
            var soApproved = $('#SONO').find(':selected').data('soapproved');
            //  var entryId = $('#GateEntryId').val();
            if (!formRights.sooptView) {
                return alert("You do not have rights to view this record.");
            }

            var mode = (soApproved === 'Y') ? "V" : (formRights.sooptUpdate ? "U" : "V");

            //     var mode = formRights.sooptUpdate ? "U" : "V";

            if (yearCode !== "0" && SONo) {
                var url = '/SaleOrder/Index?Mode=' + mode +
                    '&ID=' + SONo +
                    '&YC=' + yearCode;
                window.open(url, '_blank');
            }
            else {
                alert("Please select a valid year code.");
                return;
            }

        }
        $('#CheckAll').click(function () {

            var RowCount = $('#MultiItemBody tr').length;
            var TotalNoOfRows = 0;
            for (var i = 0; i <= RowCount; i++) {
                var checkbox = $('#MBCheckbox-' + i);
                checkbox.prop("checked", !checkbox.prop("checked"));

                if ($('#MBCheckbox-' + i).prop("checked")) {
                    TotalNoOfRows++;
                }
            }
            $('#lblTotalNoOfItems').text(TotalNoOfRows);
        });


        $('#CheckAllForPendSO').click(function () {

            var RowCount = $('#divPendSOGrid tr').length;
            var TotalNoOfRows = 0;
            for (var i = 0; i <= RowCount; i++) {
                var checkbox = $('#AcceptedQtySHA-' + i);
                checkbox.prop("checked", !checkbox.prop("checked"));

                if ($('#AcceptedQtySHA-' + i).prop("checked")) {
                    TotalNoOfRows++;
                }
            }
            $('#lblTotalNoOfItems').text(TotalNoOfRows);
        });
               $('#RoundOffAccountCode').change(function () {
                      CalculateAdjAmt('NetTotal');
                      GetDbCrDetail();
              AddAdjstmntDetail1();
           });
             function FillRoundOffAccount(dt) {
              var showAllDoc = dt;
              $.ajax({
                  type: "POST",
                  url: "@Url.Action("FillRoundOffAccount", "PurchaseBill")",
                  data: { "ShowAllDoc": showAllDoc },
                  dataType: "json",
                  async: false,
                  success: function (result, status, error) {
                      if (result != null) {

                          var obj = $.parseJSON(result);
                          $('#RoundOffAccountCode').empty();
                          $('#RoundOffAccountCode').append('<option value="0">-Select-</option>');
                          if (obj.StatusCode != 500) {
                              $.each(obj.Result.Table, function (index, val) {
                                  $('#RoundOffAccountCode').append("<option value=" + val.Account_Code + ">" + val.Account_Name + "</option>");
                              });
                          }
                      }

                      if ($('#Mode').val() == "U" || $('#Mode').val() == "V") {
                                       $('#RoundOffAccountCode').val($('#hiddenRoundOffAccountCode').val());
                      }
                  }
              });
          }

        $(document).ready(function () {
            const mode = $('#Mode').val(); // Get current mode: U = Update, V = View
            // $('#Group_Code').select2();
            // $('#Group_Code1').select2
            $("#NetTotal1").html($("#NetTotal").val())
                             $('.salebilloncounter').show();

                             
                   
            GetItemGroup();
            AutoFillItems();
            GetCompanyType();
            GetInvoiceTypeMain();
            
               AutoFillPARTYNAMELIST();
            EditableRateAndDiscountONSaleInvoice();

            const domesticExport = $('#DomesticExportNEPZ').val();
            const $supplyType = $('#SupplyType');
            GetSONoFormRights();
                // FillItems($('#TypeItemServAssets').val());
                       var dtValue = $('#RDT').prop("checked") == true ? "T" : "F";

                  FillRoundOffAccount(dtValue);
                      $('#RoundOffAccountCode').select2();
                                  if ($("#Mode").val() === "U" || $("#Mode").val() === "V") {
                   let code = $("#hiddenRoundOffAccountCode").val();

                   if (code !== null && code !== undefined && code !== "" && Number(code) > 0) {
                       $("#RoundOff").show();
                   }
               }
        // When SO changes
              $("#SONO").change(function () {
            const sonoVal = $(this).val();

            if (sonoVal && sonoVal !== "0") {
                // SONO selected → enable Select2 mode
                enableSelect2Mode();
            } else {
                // SONO = 0 or empty → enable Autocomplete mode
                enableAutocompleteMode();
            }
        });

        // Initialize autocomplete mode by default
        enableAutocompleteMode();

            if (mode != "U" && mode != "V") {
            showDetail();
            }

            FillSONO();
            FillCurrency();
            FillCustomerAddress();

            // Only for Update/View mode
             if (mode === "U" || mode === "V") {
                 $("#SaleBillNoContainer").show();
             }
             else{
                $("#SaleBillNoContainer").hide();
             }
            
            if (mode === "U" || mode === "V") {
                // let d = $('#SaleBillEntryDate').val().split(" ")[0].split("-");
                // $('#SaleBillEntryDate').datepicker({ dateFormat: 'dd/mm/yy' })
                //     .datepicker("setDate", parseDateToFormat(`${d[1]}-${d[0]}-${d[2]}`));
                // $('#SaleBillEntryDate').datepicker({ dateFormat: 'dd/mm/yy' })
                //     .datepicker("setDate", ($('#SaleBillEntryDate').val()));
                // $('#SaleBillDate').datepicker({ dateFormat: 'dd/mm/yy' })
                //     .datepicker("setDate", ($('#SaleBillDate').val()));


                // $('#ActualEntryDate').datepicker({ dateFormat: 'dd/mm/yy' })
                //     .datepicker("setDate", ($('#ActualEntryDate').val()));
                // $('#SaleBillEntryDate, #SaleBillDate, #ActualEntryDate').datepicker({
                //     dateFormat: 'dd/mm/yy' // dd/MM/yyyy format

                // });
                var currentYear = getFinancialYear();
                if ($('#SaleBillYearCode', '').val() == currentYear) {
                    $('#SaleBillDate').prop("disabled", false);
                } else {
                    $('#SaleBillDate').prop("disabled", true);
                }
                if (domesticExport === "EXPORT") {
                    $supplyType.empty();
                    $supplyType.append($('<option>', { value: "", text: "-- Select --" }));

                    $.each(exportSupplyTypes, function (i, text) {
                        $supplyType.append($('<option>', {
                            value: text,
                            text: text
                        }));
                    });
                }

                // Set selected SupplyType from Razor model
                const supplyTypeFromModel = "@Model.SupplyType";
                $supplyType.val(supplyTypeFromModel);
                var salebilldatee= $('#SaleBillDate').val();
                        $('#SaleBillDate').datepicker({ dateFormat: 'dd/mm/yy' }).datepicker("setDate", salebilldatee);
            }
            else {
                GetServerDate();
            }
            calculatetotalqty();

                $('.pendingso').click(function () {
                    // $('#PendSOForSaleBill').modal('show');
 showDetail();
                });


            // Initialize validator only once
            //   $form.validate();
            fieldIds.forEach(removeRequiredRule);
            $('#btnSaveAndPrint').click(function () {
                const printWindow = window.open('', '_blank', 'width=900,height=700,toolbar=no,menubar=no,scrollbars=yes,resizable=yes');

                $('#EinvoicePopup').modal("hide");

                // setTimeout(() => {
                       submitForm(false, printWindow,false,false); // Send true and window object
                // }, 300);
            });
                      $('#btnSaveAndDashBoard').click(function () {
                                    submitForm(false, null,true,false);
                       $('#EinvoicePopup').modal("hide");
               });

            $('#btnClose').click(function () {
                submitForm(false, null, false, false);
                $('#EinvoicePopup').modal("hide");
                //   $('#btnCloseSpinner').removeClass('d-none');
                //   $('#btnClose').prop('disabled', true);

                //   // Wait a bit, then submit the form
                // //  setTimeout(() => {
                //       submitForm(false, null).then(() => {
                //           // After async process completes
                //           $('#EinvoicePopup').modal("hide");
                //       }).finally(() => {
                //      //     $('#btnCloseSpinner').addClass('d-none');
                //           $('#btnClose').prop('disabled', false);
                //       });
                // //  }, 300);
            });
            GetFeatureOption();
            GetMaxSaleInvoiceEntryDate();
            // When user clicks "Print"
            $('#btngenrateEinvoice').click(function () {
                $('#EinvoicePopup').modal("hide");
                $('#PasswordAllowPopup').modal("show");

                // setTimeout(() => {
                //     submitForm(true, printWindow); // Send true and window object
                // }, 300);
            });

            // When user clicks "Close" or no print
            // $('#btnClose').click(function () {
            //             $('#EinvoicePopup').modal("hide");
            // });
            let generateEway = null;
            function GetInvoiceTypeMain() {
                $.ajax({
                    url: '@Url.Action("GetInvoiceTypeMain")',
                    type: 'GET',
                    async: false,
                    success: function (response, status, error) {

                        var Dropdown = $('#SubInvoicetype');
                        var obj = $.parseJSON(response);
                        Dropdown.empty();


                        $.each(obj.Result, function (index, store) {
                            Dropdown.append('<option selected value="' + store.SubVoucherName + '">' + store.SubVoucherName + '</option>');
                            // alert('Store Name: ' + store.Store_Name);
                        });

                    },
                    error: function (xhr, status, error) {
                        alert('Failed to load groups.');
                    }
                });

            }
            $('#btnGenerateEinvoiceview').click(function (e) {
                e.preventDefault();
                $('#PasswordAllowPopup').modal("show");
            });

            // Handle "E-Invoice Only" click
            $('#btnEinvoiceOnly').click(function () {
                generateEway = 'EInvoice';
                if (mode === "V") {
                    sendInvoiceRequest();
                }
                else {
                    //   setTimeout(() => {
                    submitForm(true, null,false,false); // no print
                    // }, 300);
                }
            });

            // Handle "E-Invoice + E-Way Bill" click
            $('#btnEwaybill').click(function () {
                generateEway = 'EwayAndEInvoice';
                if (mode === "V") {
                    sendInvoiceRequest();
                }
                else {
                    // setTimeout(() => {
                                  submitForm(true, null,false,false); // no print
                    // }, 300);
                }
            });
                    $(document).keyup(function (e) {
                   if (e.altKey && e.keyCode === 83) {
                       e.preventDefault();
                       $('.PartialSave').trigger("click");
                   }
               });
                          $(document).on('click', '.PartialSave', function (e) {

                              $('#TypeOfSave').val("PS");
                              e.preventDefault();
                                         ValidateSubmitWrapper(function (isValid) {
                              if (!isValid) return;

                              if ($('#divSaleBillList tr td').length <= 1) {
                                  $.notify('Sale Bill Grid Should Have Atleast 1 Item...!', "error");
                              } else if ($('#GSTRegistered').val() == 'Y') {
                                  if ($('#divTaxGrid tr td').length <= 1 && $('#DomesticExportNEPZ').val() == "DOMESTIC") {
                                      $.notify('Tax Grid Should Have Atleast 1 Item...!', "error");
                                  } else {
                                      if ($('#divAdjItemList tr td').length <= 1) {
                                          $.notify('Adjust Grid Should Have Atleast 1 Item...!', "error");
                                      } else if ($('#divdbCrItemList tr td').length <= 1) {
                                          $.notify('DRCR Grid Should Have Atleast 1 Item...!', "error");
                                      } else if ($('#StateCode').val() == 0) {
                                          $.notify('StateCode is mandatory...!', "error");
                                      } else if ($('#divAdjItemList tr td').length > 1) {
                                          var hasCR = false;
                                          $('tr.adjGridRow').each(function () {
                                              $(this).find('.GridAdjDrCr').each(function () {
                                                  if ($(this).text().trim().toUpperCase() === 'CR') {
                                                      hasCR = true;
                                                      return false;
                                                  }
                                              });
                                              if (hasCR) return false;
                                          });

                                          if (hasCR) {
                                              $.notify('AdjGrid should not have CR value...!', "error");
                                          } else {
                                              if ($('#SaleBillJobwork').val() == 'J') {
                                                  var rowCount = $('#divSaleBillList tr').length;
                                                  var itemsStockableAndCustJw = [];

                                                  for (var i = 1; i <= rowCount; i++) {
                                                      var stockable = $('#stockableItems-' + i).text() === 'Y';
                                                      var custJWAdj = $('#custJWAdjMandatory-' + i).text() === 'Y';
                                                      if (stockable || custJWAdj) {
                                                          itemsStockableAndCustJw.push($('#GridIC-' + i).val());
                                                      }
                                                  }

                                                  var isCustJWValid = ValidateAdjChallanGrid('#divCustJobWorkISsueSummary', '#fgItemCodeGrid-');
                                                  var isBomCustJWValid = ValidateAdjChallanGrid('#divBomCustJobWorkISsueSummary', '#fgBomItemCodeGrid-');
                                                  var isBomItemsValidInCust = ValidateBomItemsInCustGrid();

                                                  var isPentoAdj = true;
                                                  $('.bomCustRowJW').find('#pendToAdj').each(function () {
                                                      if (parseFloat($(this).text()) > 0) {
                                                          isPentoAdj = false;
                                                          $.notify('PendToAdj qty must be adjusted.', "error");
                                                          return false;
                                                      }
                                                  });

                                                  if (isCustJWValid && isBomCustJWValid && isBomItemsValidInCust && isPentoAdj) {
                                                      if (confirm("Are you sure you want to save this entry?")) {
                                                         submitForm(false, null,false,true);
                                                      }
                                                  }
                                              } else {
                                                  if (confirm("Are you sure you want to save this entry?")) {
                                                            submitForm(false, null,false,true);
                                                  }
                                              }
                                          }
                                      } else if ($('#GSTRegistered').val() == 'Y') {
                                          if ($('#divTaxGrid tr td').length <= 1) {
                                              $.notify('Tax Grid Should Have Atleast 1 Item...!', "error");
                                          }
                                      } else {
                                          if (confirm("Are you sure you want to save this entry?")) {
                                             submitForm(false, null,false,true);
                                          }
                                      }
                                  }
                              } else {
                                  if (confirm("Are you sure you want to save this entry?")) {
                                          submitForm(false, null,false,true);
                                  }
                              }
                          });
                          });
                   function submitForm(ShouldEinvoice, printWindow,GoToDashBoard,Partialview) {
                $('#ShouldEinvoice').val(ShouldEinvoice);

                var formData = new FormData(document.getElementById('saleInvoiceForm'));

                $.ajax({
                    type: "POST",
                    url: $('#saleInvoiceForm').attr('action'),
                    data: formData,
                    processData: false,
                    contentType: false,
                      beforeSend: function () {
                      $('#ajaxLoader').show(); // ✅ Show loader
                  },
                    success: function (res) {
                          $('#ajaxLoader').hide();
                        if (res && res.status === "Success") {
                                     if (GoToDashBoard) {
                                  $.notify("Save successfully.", "success");

                                                 window.location.href = '/SaleInvoice/SaleBillOnCounterDashboard';
                               }
                                              else if (Partialview) {
                                         $.notify("Save successfully.", "success");

                                                                             window.location.href = `/SaleInvoice/SaleBillOnCounter/${res.entryId}?Mode=U&YearCode=${res.yearCode}`;
                                                                         }
                                      else{
                            if (ShouldEinvoice && res.entryId && res.yearCode) {
                                const payload = {
                                    EntryId: res.entryId,
                                    InvoiceNo: res.invoiceNo,
                                    YearCode: res.yearCode,
                                    saleBillType: res.saleBillType,
                                    customerPartCode: res.customerPartCode,
                                    transporterName: res.transporterName,
                                    vehicleNo: res.vehicleNo,
                                    distanceKM: res.distanceKM.toString(),
                                    EntrybyId: res.entrybyId,
                                    MachineName: res.machineName,
                                    generateEway: generateEway
                                };

                                fetch('@Url.Action("GenerateInvoice", "SaleInvoice")', {
                                    method: 'POST',
                                    headers: {
                                        'Content-Type': 'application/json'
                                    },
                                    body: JSON.stringify(payload)
                                })
                                    .then(response => {
                                        if (!response.ok) throw new Error("Failed to generate invoice");
                                        return response.json();
                                    })
                                    .then(data => {
                                        //     if (data.redirectUrl) {
                                        //             $('#PasswordAllowPopup').modal("hide");
                                        //         window.location.href = data.redirectUrl;

                                        //     }
                                        //         if (data.rawResponse) {
                                        //             try {
                                        //             //    const formattedJson = JSON.stringify(JSON.parse(res.rawResponse), null, 4);
                                        //                         $('#EinvoiceResponseBox').val(data.rawResponse.eInvoiceResponse || '');
                                        //                          $('#ewayResponseBox').val(data.rawResponse.eWayBillResponse || '');
                                        //             } catch (e) {
                                        //                 $('#EinvoiceResponseBox').val(res.rawResponse);
                                        //                 $('#ewayResponseBox').val(res.rawResponse);
                                        //             }
                                        //         }
                                        //     else {
                                        //        $.notify(data.redirectUrl, "error");
                                        //     }
                                        // }) // <-- this closing parenthesis was missing
                                        // .catch(error => {
                                        //     console.log(JSON.stringify(payload));
                                        //     console.error("Invoice error:", error);
                                        //     alert("Failed to generate invoice.");
                                        // });
                                        if (data.rawEInvoice) {
                                            $('#einvoiceResponseBox').val(data.rawEInvoice);
                                        }

                                        // Show eWayBill response
                                        if (data.rawEWayBill) {
                                            $('#ewayResponseBox').val(data.rawEWayBill);
                                        }

                                        // Open PDF if available
                                        if (data.ewbPdfUrl && data.ewbPdfUrl.trim() !== "") {
                                            window.open(data.ewbPdfUrl, '_blank');
                                        }
                                        // Open QR code image if available
                                        else if (data.qrCodeUrl && data.qrCodeUrl.trim() !== "") {
                                            window.open(data.qrCodeUrl, '_blank');
                                        }

                                        // Fallback: no data at all
                                        if (
                                            !data.rawEInvoice &&
                                            !data.rawEWayBill &&
                                            !data.qrCodeUrl &&
                                            !data.ewbPdfUrl
                                        ) {
                                            $.notify("Invoice generated, but no detailed response or QR/PDF available.", "warn");
                                        }
                                        $('#PasswordAllowPopup').modal('hide');
                                    })
                                    .catch(error => {
                                        console.log(JSON.stringify(payload));
                                        console.error("Invoice error:", error);
                                        alert("Failed to generate invoice.");
                                    });

                            } else if (res.entryId && res.yearCode && printWindow) {

                                const printUrl = '/SaleInvoice/PrintReport?EntryId=' + res.entryId + '&YearCode=' + res.yearCode + '&Type=SALEBILL' + '&InvoiceNo=' + res.invoiceNo + '&AccountCode=' + res.accountCode;
                                printWindow.location.replace(printUrl); // navigate to report
                                printWindow.onload = function () {
                                    printWindow.document.title = "Sale Invoice Report";

                                };
                                  $.notify("Save successfully.", "success");
                                        
                                window.location.href = '/SaleInvoice/SaleBillOnCounter/0';
                            }
                                    
                            else {
                                  $.notify("Save successfully.", "success");
                                         
                                window.location.href = '/SaleInvoice/SaleBillOnCounter/0';
                            }
                        } 
                        }
                        else {
                            alert(res.message || "Something went wrong.");
                        }
                    },
                    error: function (xhr) {
                        console.error("Error occurred:", xhr.responseText);
                        alert("Save failed.");
                    }
                });
            }

            function sendInvoiceRequest() {

                const model = {
                    EntryId: '@Model.SaleBillEntryId',
                    InvoiceNo: '@Model.SaleBillNo',
                    YearCode: '@Model.SaleBillYearCode',
                    saleBillType: '@Model.SupplyType',
                    customerPartCode: '@Model.PartCode',
                    transporterName: '@Model.TransporterName',
                    vehicleNo: '@Model.vehicleNo',
                    distanceKM: '@Model.DistanceKM',
                    EntrybyId: '@Model.EntryByempId',
                    MachineName: '@Model.MachineName',
                    generateEway: generateEway
                };

                $.ajax({
                    url: '@Url.Action("GenerateInvoice")',
                    method: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify(model),
                      beforeSend: function () {
                        $('#ajaxLoader').show(); // ✅ Show loader
                    },
                    success: function (res) {
                         $('#ajaxLoader').hide(); 
                        // if (res.redirectUrl) {
                        //     window.location.href = res.redirectUrl;
                        // }
                        //   if (res.rawResponse) {
                        //             try {
                        //                 const formattedJson = JSON.stringify(JSON.parse(res.rawResponse), null, 4);
                        //                 $('#ewayResponseBox').val(formattedJson);
                        //             } catch (e) {
                        //                 $('#ewayResponseBox').val(res.rawResponse);
                        //             }
                        //         }
                        // else {
                        //     alert('E-Invoice generation failed.');
                        // }
                        if (res.rawEInvoice)
                            $('#einvoiceResponseBox').val(res.rawEInvoice);
                        if (res.rawEWayBill)
                            $('#ewayResponseBox').val(res.rawEWayBill);

                        // Handle PDF or QR
                        if (res.ewbPdfUrl && res.ewbPdfUrl.trim() !== "") {
                            window.open(res.ewbPdfUrl, '_blank');
                        }
                        else if (res.qrCodeUrl) {
                            window.open(res.qrCodeUrl, '_blank');
                        } else {
                            alert("No QR code or PDF found.");
                        }

                        $('#PasswordAllowPopup').modal('hide');
                    },
                    error: function () {
                        alert('An error occurred while generating the E-Invoice.');
                        $('#PasswordAllowPopup').modal('hide');
                    }
                });
            }


            var showEinvoicePrompt = '@(ViewBag.ShowEinvoicePrompt?.ToString().ToLower())';



            // if (showEinvoicePrompt === "true") {
            //     if (confirm("Do you want to generate E-Invoice?")) {
            //         // Open popup tab before fetch to avoid blocker
            //         const newTab = window.open("", "_blank");

            //         const invoiceInput = {
            //     EntryId: '@Model.SaleBillEntryId',
            //     InvoiceNo: '@Model.SaleBillNo',
            //     YearCode: '@Model.SaleBillYearCode',
            //     saleBillType: '@Model.SupplyType',
            //     customerPartCode: ''
            // }

            //         fetch('/SaleInvoice/GenerateInvoice', {
            //             method: 'POST',
            //             headers: {
            //                 'Content-Type': 'application/json'
            //             },
            //             body: JSON.stringify(invoiceInput)
            //         })
            //         .then(response => response.json())
            //         .then(data => {
            //             if (data.redirectUrl) {
            //                 newTab.location = data.redirectUrl;
            //             } else {
            //                 newTab.document.write("E-invoice generation failed.");
            //             }
            //         })
            //         .catch(err => {
            //             newTab.document.write("Error occurred.");
            //             console.error(err);
            //         });
            //     }
            // }

            FillSaleBillGridFromMemoryCache();
            var rowCounter = $('#divMultiItemGrid tr').length;
            if ($('#Mode').val() != 'U' && $('#Mode').val() != 'V') {
                if (rowCounter > 0) {
                    $('.PendingItem').show();
                    $('.newitems').hide();

                }
                else {
                    $('.PendingItem').hide();
                    $('.newitems').show();

                    // FillWorkCenter();
                }
            } else {

                $('.PendingItem').hide();
                $('.newitems').show();
                // FillWorkCenter();

            }
        });







        function GetCompanyType() {


            $.ajax({
                type: "POST",

                url: "@Url.Action("GetCompanyType")",
                dataType: "json",
                async: false,
                success: function (result, status, error) {

                    if (result != null) {
                        var obj = $.parseJSON(result);
                        if (obj.Result != null) {
                            $('#Companytype').val('');
                            $('#Companytype').val(obj.Result.Table[0].RetailerOrManufacturar);


                        }
                    }
                }
            });
        }

        function CheckacceptedQtySHA(i) {

            var checkedtruevalues = [];
            var rowCount = $('#divPendMRNGrid tr').length;
            for (let i = 1; i <= rowCount; i++) {
                checkedtruevalues.push({
                    "checked": $('#AcceptedQtySHA' + i).is(':checked')
                })
            }

            var checkedonlytrue = checkedtruevalues.filter(function (item) {
                return item.checked;
            }).length;
            if (rowCount == checkedonlytrue) {
                $('#checkuncheck').prop('checked', true)
            } else {
                $('#checkuncheck').prop('checked', false)
            }
        }

        $('#checkuncheck').change(function () {

            var rowCount = $('#divPendMRNGrid tr').length;
            if ($('#checkuncheck').is(':checked') == true) {
                for (let i = 1; i <= rowCount; i++) {
                    $('#AcceptedQtySHA' + i).prop('checked', true)
                }
            }
            else {
                for (let i = 1; i <= rowCount; i++) {
                    $('#AcceptedQtySHA' + i).prop('checked', false)
                }
            }
        })

        function showDetail() {

            var data = {
                "Flag": "ShowPendingSaleorderforBill",
                "FromDate": $('#FinFromDate').val(),
                "Todate": $('#FinToDate').val(),
                "InvoiceDate": $('#SaleBillDate').val(),
                "CurrentYear": $('#SaleBillYearCode').val(),
                "BillFromStoreId": $('#BillFromStoreId').val(),
                "BillFromStoreId": $('#BillFromStoreId').val(),
                "accountCode": $('#AccountCode').val(),
                "SONo": "@(ViewBag.sono ?? "")",
                "PartCode": $('#PartCode').val(),
                "CompanyType": $('#Companytype').val()

            }

            $.ajax({
                url: '@Url.Action("ShowPendingSaleorderforBill")',
                type: "POST",
                data: data,
                async:false,
                success: function (data) {
                    if (data != null) {

                        var obj = $.parseJSON(data);
                        if (obj.StatusCode == 200 && obj.StatusText == 'Success') {
                            $('#PendSOForSaleBill').modal('show');
                            $('#divPendMRNGrid').empty();
                            var i = 1;
                            $.each(obj.Result.Table, function (index, val) {

                                var html = '';
                                html += '<tr>' +
                                    '<td style="text-align:center;">' +
                                    '<input style="background-color: #b2b3f0;" id="AcceptedQtySHA' + i + '" ' +
                                    'class="form-check-input me-1 mt-2" type="checkbox" role="switch" ' +
                                    'onchange="CheckacceptedQtySHA(' + i + ');" />' +
                                    '</td>' +

                                    '<td><input id="SONo' + i + '" class="form-control no-cursor" value="' + val.SONo + '"/></td>' +

                                    '<td><input id="PartCode' + i + '" class="form-control no-cursor" value="' + val.PartCode + '"/></td>' +
                                    '<td><input id="ItemName' + i + '" class="form-control no-cursor" value="' + val.ItemName + '"/></td>' +
                                      '<td><input type="number" style="background-color :#FFFACD" onfocusout="CalculateAmountForPendSOGrid(' + i + ')" id="SaleBillQty' + i + '" class="form-control " value="' + val.SaleBillQty + '"/></td>' +
                                    '<td><input id="SOItemRate' + i + '" style="background-color:#FFFACD" onfocusout="CalculateAmountForPendSOGrid(' + i + ')" class="form-control" value="' + val.SOItemRate + '"/></td>' +
                                    '<td><input type="number" style="background-color:#FFFACD" onfocusout="CalculateAmountForPendSOGrid(' + i + ')" id="DisPer' + i + '" class="form-control " value="' + val.DisPer + '"/></td>' +
                                    '<td><input type="number" id="DisAmt' + i + '" class="form-control" value="' + val.DisAmt + '"/></td>' +
                                    '<td><input type="number" id="ItemAmount' + i + '" class="form-control no-cursor" value="' + val.ItemAmount + '"/></td>' +
                                    '<td><input id="OrderQty' + i + '" class="form-control no-cursor" value="' + val.OrderQty + '"/></td>' +
                                    '<td><input id="OrderPendQty' + i + '" class="form-control no-cursor" value="' + val.OrderPendQty + '"/></td>' +
                                    
                                   
                                    '<td><input id="Unit' + i + '" class="form-control no-cursor" value="' + val.Unit + '"/></td>' +
                                    '<td><input id="RackID' + i + '" class="form-control no-cursor" value="' + val.RackID + '"/></td>' +
                                    '<td><input id="SOYearCode' + i + '" class="form-control no-cursor" value="' + val.SOYearCode + '"/></td>' +
                                    '<td><input id="CustorderNo' + i + '" class="form-control no-cursor" value="' + val.CustorderNo + '"/></td>' +
                                    '<td><input id="SchNo' + i + '" class="form-control no-cursor" value="' + val.SchNo + '"/></td>' +
                                    '<td><input id="SchYearCode' + i + '" class="form-control no-cursor" value="' + val.SchYearCode + '"/></td>' +
                                    '<td><input id="SOType' + i + '" class="form-control no-cursor" value="' + val.SOType + '"/></td>' +
                                    '<td><input id="SOFor' + i + '" class="form-control no-cursor" value="' + val.SOFor + '"/></td>' +

                                    '<td><input id="HSNNO' + i + '" class="form-control no-cursor" value="' + val.HSNNO + '"/></td>' +
                                    '<td><input id="TotalStock' + i + '" class="form-control no-cursor" value="' + val.TotalStock + '"/></td>' +
                                    '<td><input id="BatchNo' + i + '" class="form-control no-cursor" value="' + val.BatchNo + '"/></td>' +
                                    '<td><input id="UniqueBatchNo' + i + '" class="form-control no-cursor" value="' + val.UniqueBatchNo + '"/></td>' +
                                    '<td><input id="BatchStock' + i + '" class="form-control no-cursor" value="' + val.BatchStock + '"/></td>' +
                                    
                                    '<td><input id="AltQty' + i + '" class="form-control no-cursor" value="' + val.AltQty + '"/></td>' +
                                    '<td><input id="Storeid' + i + '" class="form-control no-cursor" value="' + val.Storeid + '"/></td>' +
                                    '<td><input id="Store_Name' + i + '" class="form-control no-cursor" value="' + val.Store_Name + '"/></td>' +
                                    '<td><input id="CustomerName' + i + '" class="form-control no-cursor" value="' + val.CustomerName + '"/></td>' +
                                    '<td><input id="Accountcode' + i + '" class="form-control no-cursor" value="' + val.Accountcode + '"/></td>' +
                                    '<td><input id="ItemCode' + i + '" type="hidden" value="' + val.ItemCode + '"/>' +
                                    '<input class="form-control no-cursor" value="' + val.ItemCode + '"/></td>' +
                                    '</tr>';

                                $('#divPendMRNGrid').append(html);
                                $('#TransertoMIRBtn').prop("disabled", false);

                                var count = $('#divPendMRNGrid tr').length;
                                $('#totalRows').text(count);
                                  $("#lblTotalNoOfItemsPendSO").html(count);
                                i++;
                            });

                        }
                        else {
                            $('#divPendMRNGrid').empty();
                            var count = $('#divPendMRNGrid tr').length;
                                   $("#lblTotalNoOfItemsPendSO").html(count);
                            $('#totalRows').text(count);
                            $('#divPendMRNGrid').append('<tr class="text-center"><td colspan="26" class="text-black-50"><strong>NO DATA FOUND</strong></td></tr>')

                        }
                    }
                },
                error: function (response) {
                    alert(response.responseText);
                },
                failure: function (response) {
                    alert(response.responseText);
                }
            });
        }


        // function AutoFillItems() {


        //     // Source for PartCodeText
        //     const partCodeSource = function (request, response) {
        //         $.ajax({
        //             url: '@Url.Action("AutoFillPartCode")',
        //             type: 'POST',
        //             data: {



        //                 SearchPartCode: request.term
        //             },
        //             success: function (result) {
        //                 let obj = typeof result === "string" ? JSON.parse(result) : result;
        //                 console.log("obj" + obj);
        //                 console.log("result" + typeof result === "string" ? JSON.parse(result) : result);
        //                 if (obj.StatusCode === 200 && obj.StatusText === 'Success' && Array.isArray(obj.Result)) {

        //                     let filtered = obj.Result.filter(function (item) {
        //                         let term = request.term.toLowerCase();
        //                         return item.PartCode.toLowerCase().includes(term);
        //                     });
        //                     console.log(filtered);

        //                     response($.map(filtered, function (item) {
        //                         return {
        //                             label: item.PartCode,
        //                             value: item.PartCode,
        //                             itemName: item.ItemName,
        //                             itemCode: item.Item_Code,
        //                         };
        //                     }));
        //                 } else {
        //                     response([]);
        //                 }
        //             }
        //         });
        //     };



        //     $("#SearchPartCode").autocomplete({
        //         source: partCodeSource,
        //         appendTo: "#SaleOrderGroupWiseItem",
        //         select: function (event, ui) {
        //             $("#SearchPartCode").val(ui.item.value).data("itemcode", ui.item.itemCode);

        //             return false;
        //         },
        //         focus: function (event, ui) {
        //             $("#SearchPartCode").val(ui.item.value);
        //             return false;
        //         },
        //         minLength: 2
        //     });







        // }


        $(document).on('mouseover', 'input[type="text"]', function () {
            $(this).attr('title', $(this).val());
        });
        // Attach autocomplete when StoreName input is focused
        $(document).on("focus", "input[id^='StoreName-']", function () {
            var $this = $(this);

            // Prevent initializing autocomplete multiple times
            if ($this.data("ui-autocomplete")) return;

            $this.autocomplete({
                minLength: 1,
                autoFocus: true,
                source: function (request, response) {
                    $.ajax({
                        url: '@Url.Action("AutoFillStore")',
                        type: 'POST',
                        data: { SearchStoreName: request.term },
                        success: function (result) {
                            var data = typeof result === "string" ? JSON.parse(result) : result;

                            if (data.StatusCode === 200 && data.StatusText === 'Success' && Array.isArray(data.Result.Table)) {
                                var filtered = data.Result.Table.filter(function (item) {
                                    return item.Store_Name.toLowerCase().includes(request.term.toLowerCase());
                                });

                                response($.map(filtered, function (item) {
                                    return {
                                        label: item.Store_Name,
                                        value: item.Store_Name,
                                        StoreId: item.StoreId
                                    };
                                }));
                            } else {
                                response([]);
                            }
                        },
                        error: function () {
                            response([]);
                        }
                    });
                },
                select: function (event, ui) {
                    $this.val(ui.item.label);

                    // Set corresponding StoreId hidden field
                    var id = $this.attr("id").split("-")[1];
                    $("#StoreId-" + id).val(ui.item.StoreId);

                    return false;
                }
            });
        });

        //        function AutoFillStore(i) {
        //     $("#StoreName-" + i).autocomplete({
        //         minLength: 1,
        //         autoFocus: true,
        //         source: function (request, response) {
        //             $.ajax({
        //                 url: '@Url.Action("AutoFillStore")',
        //                 type: 'POST',
        //                 data: { SearchStoreName: request.term },
        //                 success: function (result) {
        //                     // Controller returns string -> must parse
        //                     let obj = JSON.parse(result);

        //                     if (obj.StatusCode === 200 && obj.StatusText === 'Success' && Array.isArray(obj.Result.Table)) {
        //                         let filtered = obj.Result.Table.filter(function (item) {
        //                             return item.Store_Name.toLowerCase().includes(request.term.toLowerCase());
        //                         });

        //                         response($.map(filtered, function (item) {
        //                             return {
        //                                 label: item.Store_Name,
        //                                 value: item.Store_Name,
        //                                 StoreId: item.StoreId
        //                             };
        //                         }));
        //                     } else {
        //                         response([]);
        //                     }
        //                 },
        //                 error: function (xhr, status, error) {
        //                     console.error("Autocomplete error:", error);
        //                     response([]);
        //                 }
        //             });
        //         },
        //         select: function (event, ui) {
        //             $("#StoreName-" + i).val(ui.item.label);
        //             $("#StoreId" + i).val(ui.item.StoreId);
        //             return false;
        //         }
        //     });
        // }


        //     // Autocomplete for StoreName
        //     $("#StoreName-"+i).autocomplete({
        //         source: StoreNameSource,
        //         select: function (event, ui) {
        //             $("#StoreName-" + i).val(ui.item.value).data("StoreId", ui.item.StoreId);

        //             $('#StoreId-' + i).val(ui.item.StoreId);

        //             return false;
        //         },
        //         focus: function (event, ui) {
        //             $("#StoreName-" + i).val(ui.item.value);
        //             return false;
        //         },
        //         minLength: 2
        //     });


        // }

        // function AutoFillStore(rowIndex) {
        //     $("#StoreName-" + rowIndex).autocomplete({
        //         minLength: 1,
        //         source: function (request, response) {
        //             $.ajax({
        //                 url: '@Url.Action("AutoFillStore")',
        //                 type: 'GET',
        //                 dataType: 'json',
        //                 data: { SearchStoreName: request.term },
        //                 success: function (data) {
        //                     if (data && data.Result && data.Result.Table) {
        //                         response($.map(data.Result.Table, function (item) {
        //                             return {
        //                                 label: item.Store_Name, // what is shown in dropdown
        //                                 value: item.Store_Name, // what is filled in input
        //                                 storeId: item.StoreId   // extra field for hidden input
        //                             };
        //                         }));
        //                     } else {
        //                         response([]);
        //                     }
        //                 },
        //                 error: function () {
        //                     response([]);
        //                 }
        //             });
        //         },
        //         select: function (event, ui) {
        //             $("#StoreName-" + rowIndex).val(ui.item.value);
        //             $("#StoreId-" + rowIndex).val(ui.item.storeId); // Fill hidden field with ID
        //             return false;
        //         }
        //     });
        // }


        function AddMultipleItems() {
            $('#SaleOrderGroupWiseItem').modal('show');
            $('#MultiItemBody').empty();
            GetMultiItemGroup();
            FillStore();
        }
        $('#MultiStoreName, #Group_Code1').change(function () {
            $('#MultiItemBody').empty();
        });



        function ShowGroupWiseItems() {
            var groupname = '';
            if ($('#Group_Code1 option:selected').text().trim() == '-Select-')
                groupname = '';
            else
                groupname = $('#Group_Code1 option:selected').text().trim();

            //var reportType = $('#ReportType').val();
            var Group_Code = $('#Group_Code1').val();
            var GroupName = groupname;
            var AccountCode = $('#AccountCode').val();
            var storeid = $('#MultiStoreName').val();
            var ToDate = $('#SaleBillDate').val();
            var PartCode = $('#SearchPartCode').val();

            $.ajax({
                type: 'POST',
                url: "@Url.Action("ShowGroupWiseItems")",
                data: {
                    Group_Code: Group_Code,
                    AccountCode: AccountCode,
                    storeid: storeid,
                    GroupName: GroupName,
                    ToDate: ToDate,
                    PartCode: PartCode

                },
                success: function (response) {
                    // Clear the existing items in the table body
                    $('#MultiItemBody').empty(); // Clear existing items
                    $('#MultiItemBody').html(response);

                    var totalRows = $('#MultiItemBody tr').length;
                           $('#lblTotalNoOfItemsGroupWise').text(totalRows);

                    for (let i = 1; i <= totalRows; i++) {
                        CalculateRateForMalti(i);
                    }
                },
                error: function (xhr, status, error) {
                    console.error("Error fetching BOM tree data:", error);
                }
            });
            $.getJSON({
                url: "@Url.Action("getdiscCategoryName")",
                data: {
                    Group_Code: Group_Code,
                    AccountCode: AccountCode

                },
                success: function (result, status, xhr) {

                    $('#DiscCategory').val(result.result);

                }
            });
        }

        $('#AccountCode').change(function () {

            showDetail();
            GetlastBillDetail();

        })

        function GetlastBillDetail() {


            var AccountCode = $('#AccountCode').val();
            var invoicedate = $('#SaleBillDate').val();
            var currentYearcode = $('#SaleBillYearCode').val();
            var ItemCode = $('#ItemCode').val();


            $.ajax({
                type: 'POST',
                url: "@Url.Action("GetlastBillDetail")",
                data: {

                    AccountCode: AccountCode,
                    invoicedate: invoicedate,
                    currentYearcode: currentYearcode,
                    ItemCode: ItemCode,

                },
                success: function (response) {
                    // Clear the existing items in the table body
                    $('#DivSaleBillHistory').empty(); // Clear existing items
                    $('#DivSaleBillHistory').html(response);


                },
                error: function (xhr, status, error) {
                    console.error("Error fetching BOM tree data:", error);
                }
            });

        }


        // function showDetail() {

        //     var data = {
        //         "Flag": "ShowPendingSaleorderforBill",
        //         "FromDate": $('#FromDate').val(),
        //         "Todate": $('#SaleBillDate').val(),
        //         "InvoiceDate": $('#SaleBillDate').val(),
        //         "CurrentYear": $('#SaleBillYearCode').val(),
        //         "BillFromStoreId": $('#BillFromStoreId').val(),
               //         "PaymentDays": $('#AccountCode').val(),
        //         "SONo": $('#SONo').val(),
        //         // "PartCode": $('#PartCode').val()

        //     }

        //     $.ajax({
        //         url: '@Url.Action("ShowPendingSaleorderforBill")',
        //         type: "POST",
        //         data: data,
        //         success: function (data) {
        //             if (data != null) {

        //                 var obj = $.parseJSON(data);
        //                 if (obj.StatusCode == 200 && obj.StatusText == 'Success') {
        //                     $('#PendSaleOrderModel').modal('show');
        //                     $('#divPendSOGrid').empty();
        //                     var i = 1;
        //                     $.each(obj.Result.Table, function (index, val) {

        //                         var html = '';
        //                         html += '<tr>' +
        //                             '<td style="text-align:center;">' +
        //                             '<input style="background-color: #b2b3f0;" id="AcceptedQtySHA-' + i + '" ' +
        //                             'class="form-check-input me-1 mt-2" type="checkbox" role="switch" ' +
        //                             'onchange="CheckacceptedQtySHA(' + i + ');" />' +
        //                             '</td>' +

        //                             '<td><input id="SONO-' + i + '" class=" no-cursor" style="width:50px !important;" value="' + val.SONo + '"/></td>' +
        //                             '<td><input id="SOYearCode-' + i + '" class=" no-cursor hiddenColumn" value="' + val.SOYearCode + '"/></td>' +
        //                             '<td><input id="CustOrderNo-' + i + '" class=" no-cursor hiddenColumn" value="' + val.CustorderNo + '"/></td>' +
        //                             '<td><input id="SchNo-' + i + '" class=" no-cursor hiddenColumn" value="' + val.SchNo + '"/></td>' +
        //                             '<td><input id="SaleSchYearCode-' + i + '" class=" no-cursor hiddenColumn" value="' + val.SchYearCode + '"/></td>' +

        //                             '<td><input id="PartCode-' + i + '" class=" no-cursor" style="width:200px !important;" value="' + val.PartCode + '"/></td>' +
        //                             '<td><input id="ItemName-' + i + '" class=" no-cursor" style="width:200px !important;" value="' + val.ItemName + '"/></td>' +
        //                             '<td><input id="Rate-' + i + '" class="" style="width:60px !important;"   onkeyup="CalculateAmountForMemoryGrid(' + i + ')"  value="' + val.SOItemRate + '"/></td>' +
        //                             // '<td><input id="OrderQty' + i + '" class="form-control no-cursor" value="' + val.OrderQty + '"/></td>' +
        //                             '<td><input id="Qty-' + i + '" class="" style="width:60px !important;"  onkeyup="CalculateAmountForMemoryGrid(' + i + ')"  value="' + val.SaleBillQty + '"/></td>' +
        //                             '<td><input id="Amount-' + i + '" class=" no-cursor" style="width:60px !important;" value="' + val.ItemAmount + '"/></td>' +
        //                             '<td><input id="DiscountPer-' + i + '" class="" style="width:40px !important;"  onkeyup="CalculateAmountForMemoryGrid(' + i + ')"  value="' + val.DisPer + '"/></td>' +
        //                             '<td><input id="DiscountAmt-' + i + '" class=" no-cursor" style="width:40px !important;" value="' + val.DisAmt + '"/></td>' +

        //                             '<td><input id="Unit-' + i + '" class=" no-cursor " style="width:30px !important;" value="' + val.Unit + '"/></td>' +
        //                             '<td><input id="RackID-' + i + '" class=" no-cursor" style="width:80px !important;" value="' + val.RackID + '"/></td>' +
        //                             '<td><input id="HSNNo-' + i + '" class=" no-cursor" style="width:70px !important;" value="' + val.HSNNO + '"/></td>' +


        //                             '<td><input id="SOPendQty-' + i + '" class=" no-cursor" style="width:70px !important;" value="' + val.OrderPendQty + '"/></td>' +
        //                             '<td><input id="StoreName-' + i + '" class=" no-cursor hiddenColumn" value="' + val.Store_Name + '"/></td>' +
        //                             '<td><input id="StoreId-' + i + '" class=" no-cursor hiddenColumn" value="' + val.Storeid + '"/></td>' +
        //                             '<td><input id="Batchno-' + i + '" class=" no-cursor " value="' + val.BatchNo + '"/></td>' +
        //                             '<td><input id="Uniquebatchno-' + i + '" class=" no-cursor hiddenColumn" value="' + val.UniqueBatchNo + '"/></td>' +
        //                             '<td><input id="TotalStock-' + i + '" class=" no-cursor hiddenColumn" value="' + val.TotalStock + '"/></td>' +

        //                             '<td><input id="LotStock-' + i + '" class=" no-cursor " value="' + val.BatchStock + '"/></td>' +



        //                             '<td><input id="SOType-' + i + '" class=" no-cursor hiddenColumn" value="' + val.SOType + '"/></td>' +


        //                             '<td><input id="AltQty-' + i + '" class=" no-cursor hiddenColumn" value="' + val.AltQty + '"/></td>' +
        //                             '<td><input id="ItemCode-' + i + '" class=" no-cursor hiddenColumn" value="' + val.ItemCode + '"/></td>' +


        //                             // '<td><input id="CustomerName' + i + '" class="form-control no-cursor" value="' + val.CustomerName + '"/></td>' +
        //                             // '<td><input id="Accountcode' + i + '" class="form-control no-cursor" value="' + val.Accountcode + '"/></td>' +
        //                             // '<td><input id="ItemCode' + i + '" type="hidden" value="' + val.ItemCode + '"/>' +
        //                             // '<input class="form-control no-cursor" value="' + val.ItemCode + '"/></td>' +
        //                             '</tr>';

        //                         $('#divPendSOGrid').append(html);
        //                         $('#TransertoMIRBtn').prop("disabled", false);

        //                         var count = $('#divPendSOGrid tr').length;
        //                         $('#totalRows').text(count);
        //                         i++;
        //                     });
        //                     $('th.hiddenColumn').hide();
        //                     $('.hiddenColumn').closest('td').hide();

        //                     if ($('#EditableRateAndDiscountONSaleInvoice').val() == 'N') {
        //                         $('input[id^="Rate-"]').prop('readonly', true);
        //                         $('input[id^="DiscountPer-"]').prop('readonly', true);
        //                         $('input[id^="DiscountAmt-"]').prop('readonly', true);
        //                     }
        //                     else {
        //                         $('input[id^="Rate-"]').prop('readonly', false);
        //                         $('input[id^="DiscountPer-"]').prop('readonly', false);
        //                         $('input[id^="DiscountAmt-"]').prop('readonly', false);
        //                     }


        //                 }
        //                 else {
        //                     $('#divPendSOGrid').empty();
        //                     var count = $('#divPendSOGrid tr').length;
        //                     $('#totalRows').text(count);
        //                     $('#divPendSOGrid').append('<tr class="text-center"><td colspan="26" class="text-black-50"><strong>NO DATA FOUND</strong></td></tr>')

        //                 }
        //             }
        //         },
        //         error: function (response) {
        //             alert(response.responseText);
        //         },
        //         failure: function (response) {
        //             alert(response.responseText);
        //         }
        //     });
        // }




        function GetMultiItemGroup() {

            $.ajax({
                type: "POST",
                url: "@Url.Action("GetItemGroup")",
                dataType: "json",
                async: false,

                success: function (result, status, error) {

                    if (result != null) {
                        var obj = $.parseJSON(result);
                        if (obj.StatusCode == 200 && obj.StatusText == 'Success') {
                            $('#Group_Code1').empty();
                            $('#Group_Code1').append('<option value="0"  selected>-Select-</option>');


                            $.each(obj.Result, function (index, val) {
                                $('#Group_Code1').append('<option value="' + val.Group_Code + '">' + val.Group_name + '</option>');
                            });

                        }
                    }
                }
            });
        }


        function GetItemGroup() {

            $.ajax({
                type: "POST",
                url: "@Url.Action("GetItemGroup")",
                dataType: "json",
                async: false,

                success: function (result, status, error) {

                    if (result != null) {
                        var obj = $.parseJSON(result);
                        if (obj.StatusCode == 200 && obj.StatusText == 'Success') {
                            $('#Group_Code').empty();
                            $('#Group_Code').append('<option value="0"  selected>-Select-</option>');

                            $.each(obj.Result, function (index, val) {
                                $('#Group_Code').append('<option value="' + val.Group_Code + '">' + val.Group_name + '</option>');
                            });

                        }
                    }
                }
            });
        }


        $('#Group_Code').change(function () {
            var Group_Code = $('#Group_Code').val();

            $.ajax({
                type: "POST",
                url: "@Url.Action("GETGROUPWISEITEM")",
                data: { Group_Code: Group_Code },
                dataType: "json",
                async: false,

                success: function (result, status, error) {

                    if (result != null) {
                        var obj = $.parseJSON(result);
                        if (obj.StatusCode == 200 && obj.StatusText == 'Success') {
                            $('#PartCode').empty();
                            $('#PartCode').append('<option value="0"  selected>-Select-</option>');

                            $.each(obj.Result, function (index, val) {
                                $('#PartCode').append('<option value="' + val.Item_Code + '">' + val.PartCode + '</option>');
                            });


                            $('#ItemCode').empty();
                            $('#ItemCode').append('<option value="0"  selected>-Select-</option>');

                            $.each(obj.Result, function (index, val) {
                                $('#ItemCode').append('<option value="' + val.Item_Code + '">' + val.ItemName + '</option>');
                            });
                        }
                    }
                }
            });
        });

        $('#DomesticExportNEPZ').change(function () {
            updateSupplyTypeOptions();
        });

        function FillSaleBillGridFromMemoryCache() {

            $.ajax({
                url: "@Url.Action("FillSaleBillGridFromMemoryCache")",
                type: "POST",
                async: false,
                success: function (data) {

                    if (data != null) {
                        $('#divMultiItemGrid').html(data);
                        var firstAccountCode = $('#AccountCode-1').val();
                        var AccountName = $('#AccountName-1').val();

                        if (firstAccountCode) {
                            // ✅ Fill your #WCID dropdown with only that one value
                            // $('#AccountCode').empty().append(
                            //     $('<option>', {
                            //         value: firstAccountCode,
                            //         text: AccountName
                            //     })
                            // );
                            $('#AccountCode').val(firstAccountCode);
                            $('#AccountCodeText').val(AccountName);

                            // $('#AccountCode').prop('disabled', true);
                            $.getJSON({
                                url: '@Url.Action("GetGstRegister", "PurchaseOrder")',
                                data: { Code: $('#AccountCode').val() },
                                success: function (result, status, xhr) {
                                    if (result != null) {
                                        var obj = $.parseJSON(result);
                                        $('#GSTRegistered').val(obj.Result[0].GSTRegistered);
                                    }
                                    // if ($('#divSaleBillList tr td').length > 1) {
                                    //     isAccountCodeClear = true;
                                    // }
                                    itemArrayLength = [];
                                }
                            });
                            FillDistance();

                            FillCurrency();
                            FillCustomerAddress();

                            btnClearTax();
                            ClearAdjustmentGrid();
                            ClearDRCRGrid();
                            ClearCustomerJWGrid();
                            // $('#IssueFromWCid').val(firstWCID);


                        }

                        // if ($('#EditableRateAndDiscountONSaleInvoice').val() == 'N') {
                        //     $('input[id^="Rate-"]').prop('readonly', true);
                        //     $('input[id^="DiscountPer-"]').prop('readonly', true);
                        //     $('input[id^="DiscountAmt-"]').prop('readonly', true);
                        // }
                        // else {
                        //     $('input[id^="Rate-"]').prop('readonly', false);
                        //     $('input[id^="DiscountPer-"]').prop('readonly', false);
                        //     $('input[id^="DiscountAmt-"]').prop('readonly', false);
                        // }

                        var rowCounter = $('#divMultiItemGrid tr').length;
                        for (let i = 1; i <= rowCounter; i++) {
                            FillTotalStockForAll(i);
                            FillLotStockForALl(i);
                            CalculateAmountForMemoryGrid(i);

                        }

                    }
                },
                error: function (errMsg) {
                    console.log(errMsg);
                }
            });
        }

        function DeleteModelRow(el) {
            // Find the row containing the clicked delete link
            var row = $(el).closest("tr");
            row.remove();

            // Reset counter (first column)
            $("#divMultiItemGrid tr").each(function (index) {
                $(this).find("td:first").text(index + 1);
            });
        }


       function AddPendSOToGrid (e) {
            e.preventDefault();
            /* if (!Validate_TransferGrid()) return; */
            // var ItemData = [];
            // var RowCount = $('#divMultiItemGrid tr').length;




            // var CheckboxArr = [];
            // // var RowCount = $('#MultiItemBody tr').length;




            // // var RowCount = $('#MultiItemBody tr').length;
            // for (var i = 1; i <= RowCount; i++) {

            //     if ($('#Qty-' + i).val() == 0) {
            //         $.notify('Please enter quantity for ' + $('#PartCode-' + i).val(), 'error');
            //         return;
            //     }

            //     if (AllowedToDispatchQtyMoreThenCloseSOPendQty != 'Y') {
            //         if (parseFloat($('#Qty-' + i).val()) > parseFloat($('#SOPendQty-' + i).val())) {
            //             $.notify('Please enter Valid quantity for ' + $('#PartCode-' + i).val(), 'error');
            //             return;
            //         }
            //     }

            //     if ($('#Rate-' + i).val() == 0) {
            //         $.notify('Please enter rate for ' + $('#PartCode-' + i).val(), 'error');
            //         return;
            //     }
            //     if ($('#Unit-' + i).val() == '') {
            //         $.notify('Please select unit for ' + $('#PartCode-' + i).val(), 'error');
            //         return;
            //     }

            //     if ($('#Amount-' + i).val() == '') {
            //         $.notify('amount can not be 0 ' + $('#PartCode-' + i).val(), 'error');
            //         return;
            //     }





            // }





            var selectedData = [];

            $('#GateDataTable tbody tr').each(function (rowIndex) {
                var $row = $(this);
                var checkbox = $row.find('input[type="checkbox"]');

                if (checkbox.is(':checked')) {
                    var i = rowIndex + 1;
                    var rowData = {

                        AccountName: $("#CustomerName" + i).val(),   // we created CustomerNameX
                        AccountCode: $("#Accountcode" + i).val(),
                        SONO: $("#SONo" + i).val(),
                        SOYearCode: $("#SOYearCode" + i).val(),
                        CustOrderNo: $("#CustorderNo" + i).val(),
                        SchNo: $("#SchNo" + i).val(),
                        SaleSchYearCode: $("#SchYearCode" + i).val(),
                        ItemCode: $("#ItemCode" + i).val(),
                        PartCode: $("#PartCode" + i).val(),
                        ItemName: $("#ItemName" + i).val(),
                        Unit: $("#Unit" + i).val(),
                        HSNNo: $("#HSNNO" + i).val(),
                        Qty: $("#SaleBillQty" + i).val(),
                        SOPendQty: $("#OrderPendQty" + i).val(),
                        Rate: $("#SOItemRate" + i).val(),
                        SOType: $("#SOType" + i).val(),
                        Batchno: $("#BatchNo" + i).val(),
                        Uniquebatchno: $("#UniqueBatchNo" + i).val(),
                        DiscountPer: $("#DisPer" + i).val(),
                        DiscountAmt: $("#DisAmt" + i).val(),
                        Amount: $("#ItemAmount" + i).val(),
                        AltQty: $("#AltQty" + i).val(),
                        StoreId: $("#Storeid" + i).val(),
                        StoreName: $("#Store_Name" + i).val(),
                        RackID: $("#RackID" + i).val()


                    };
                    selectedData.push(rowData);
                }
            });
            if (selectedData.length === 0) {
                notify("Please check at least one checkbox before proceeding.", "error");
                return;
            }

            $.ajax({
                url: '@Url.Action("AddMultiSaleBillDetail")',
                type: "POST",
                data: JSON.stringify(selectedData),
                contentType: 'application/json',
                beforeSend: function () {
                    console.log('Sending item...');
                    console.log('ItemData', selectedData);
                },
                success: function (data, status, xhr) {

                    

                    if (data === "Duplicate" && (xhr.statusCode === 207 || xhr.responseText === "Duplicate")) {
                        $.notify('Duplicate Item Not Allowed.', "info");
                        $('.ItemBtn').html('<span role="status"><i class="fa-solid fa-angles-down fa-fw fa-lg"></i> ADD TO GRID</span>').prop("disabled", false);
                    } else if (xhr.status == 205 && (xhr.responseText.indexOf('Reset') || xhr.statusText.indexOf('Reset'))) {
                        $.notify('Adding Item Not Allowed, Please Clear Gate Detail...!!!', "info");
                    } else {
                        // $('.gridHiddenField').show();

                        $('#divSaleBillList').html(data);
                        $('#PendSOForSaleBill').modal('hide');
                        if ($('#SaleBillJobwork').val() == 'J') {
                            $('.jobWorkChalln').show();
                            $('.gridHiddenField').show();
                        } else {
                            $('.jobWorkChalln').hide();
                            $('.gridHiddenField').hide();
                        }
                        GetFeatureOption();
                        $.notify('Item Added To Grid.', "success");
                    }

                    editingNow = false;
                    BasicTotal();
                    ClearAdjustmentGrid();
                    calculatetotalqty();
                    // ResetPendQty();

                    // var rowCount = $('#divSaleBillList tr').length;

                    // for (var i = 1; i <= rowCount; i++) {

                    //     sum += parseFloat($('#GridAmount-' + i).text() == '.00' ? 0 : $('#GridAmount-' + i).text());
                    // }
                    $('#ItemNetAmount').val(sum);

                    // $('#lblItemNetAmount').text(sum.toFixed(2));

                    var txSum = 0;
                    if ($('#divTaxGrid tr td').length > 1) {
                        for (var i = 1; i <= taxRowCount; i++) {
                            txSum += parseFloat($('#txGridAmount-' + i).text() == '.00' ? 0 : $('#txGridAmount-' + i).text());
                        }
                    }

                    var txTotal = sum + txSum;
                    $('#NetTotal').val(txTotal.toFixed(2));
                    $('#BaseNetTotal').val(txTotal.toFixed(2));
                    $('#AdjPendAmt').val($('#NetTotal').val());
                    $('#NetTotal1').html($('#NetTotal').val());
                    $('#TotalDiscountPercentage').val(0);
                    $('#TotalAmtAftrDiscount').val(0);

                    // ClearGrid();
                    $('.PendingItem').hide();
                    $('.newitems').show();
                    // $('#BatchNo').val('0');
                    // $('#UniqueBatchNo').val('0');

                },
                error: function (result) {
                    $.notify(result.responseText, "error");
                },
                failure: function (result) {
                    alert(result.responseText);
                },
                complete: function () {
                    console.log('Done');
                    $('.Schedule').fadeIn();
                }
            }).done(function () {
                GetItemGroup();
                GetTaxPartItem();
                GetDbCrDetail();
                AddAdjstmntDetail1();
            })
        };




        $('.PendGridButton').click(function (e) {
            e.preventDefault();
            /* if (!Validate_TransferGrid()) return; */
            var ItemData = [];
            var RowCount = $('#divMultiItemGrid tr').length;
           



            var CheckboxArr = [];
            // var RowCount = $('#MultiItemBody tr').length;




            // var RowCount = $('#MultiItemBody tr').length;
            for (var i = 1; i <= RowCount; i++) {

                if ($('#Qty-' + i).val() == 0) {
                    $.notify('Please enter quantity for ' + $('#PartCode-' + i).val(), 'error');
                    return;
                }
              
                if (AllowedToDispatchQtyMoreThenCloseSOPendQty != 'Y') {
                    if (parseFloat($('#Qty-' + i).val()) > parseFloat($('#SOPendQty-' + i).val())) {
                        $.notify('Please enter Valid quantity for ' + $('#PartCode-' + i).val(), 'error');
                        return;
                    }
                }
              
                if ($('#Rate-' + i).val() == 0) {
                    $.notify('Please enter rate for ' + $('#PartCode-' + i).val(), 'error');
                    return;
                }
                if ($('#Unit-' + i).val() == '') {
                    $.notify('Please select unit for ' + $('#PartCode-' + i).val(), 'error');
                    return;
                }
               
                if ($('#Amount-' + i).val() == '') {
                    $.notify('amount can not be 0 ' + $('#PartCode-' + i).val(), 'error');
                    return;
                }





            }





            for (var i = 1; i <= RowCount; i++) {

                ItemData.push({

                    SONO: $('#SONO-' + i).val(),
                    SOYearCode: parseInt($('#SOYearCode-' + i).val()),
                    CustOrderNo: $('#CustOrderNo-' + i).val(),
                    SchNo: $('#SchNo-' + i).val(),
                    SaleSchYearCode: parseInt($('#SaleSchYearCode-' + i).val()),
                    PartCode: $('#PartCode-' + i).val(),
                    ItemCode: parseInt($('#ItemCode-' + i).val()),
                    ItemName: $('#ItemName-' + i).val(),
                    Unit: $('#Unit-' + i).val(),

                    HSNNo: $('#HSNNo-' + i).val(),
                    SOPendQty: parseFloat($('#SOPendQty-' + i).val()),
                    StoreName: $('#StoreName-' + i).val(),
                    StoreId: parseInt($('#StoreId-' + i).val()),
                    Batchno: $('#Batchno-' + i).val(),
                    Uniquebatchno: $('#Uniquebatchno-' + i).val(),
                    TotalStock: parseFloat($('#TotalStock-' + i).val()),
                    LotStock: parseFloat($('#LotStock-' + i).val()),
                    Rate: parseFloat($('#Rate-' + i).val()),
                    Qty: parseFloat($('#Qty-' + i).val()) || 0,
                    SOType: $('#SOType-' + i).val,
                    DiscountPer: parseFloat($('#DiscountPer-' + i).val()),
                    DiscountAmt: parseFloat($('#DiscountAmt-' + i).val()),
                    Amount: parseFloat($('#Amount-' + i).val()) || 0,
                    AltQty: parseFloat($('#AltQty-' + i).val()),
                    RackID: ($('#RackID-' + i).val()),

                });

            }

            $.ajax({
                url: '@Url.Action("AddMultiSaleBillDetail")',
                type: "POST",
                data: JSON.stringify(ItemData),
                contentType: 'application/json',
                beforeSend: function () {
                    console.log('Sending item...');
                    console.log('ItemData', ItemData);
                },
                success: function (data, status, xhr) {

                    /* // ✅ Store used batch
                    itemBatchArray.push({
                        "itemcode": parseInt($('#ItemCode').val()),
                        "batchno": $('#BatchNo').val(),
                        "uniqueBatchNo": $('#UniqueBatchNo').val()
                    });

                    // ✅ Disable current used batch
                    const usedBatchNo = $('#BatchNo').val();
                    $('#BatchNo option[value="' + usedBatchNo + '"]').prop('disabled', true);

                    // ✅ Enable next unused batch from batchList
                    for (var i = 0; i < batchList.length; i++) {
                        var nextBatch = batchList[i];
                        var isUsed = itemBatchArray.some(function (item) {
                            return item.batchno === nextBatch;
                        });
                        if (!isUsed) {
                            $('#BatchNo option[value="' + nextBatch + '"]').prop('disabled', false).prop('selected', true);
                            $('#BatchNo').trigger('change'); // optional
                            break;
                        }
                    } */

                    if (data === "Duplicate" && (xhr.statusCode === 207 || xhr.responseText === "Duplicate")) {
                        $.notify('Duplicate Item Not Allowed.', "info");
                        $('.ItemBtn').html('<span role="status"><i class="fa-solid fa-angles-down fa-fw fa-lg"></i> ADD TO GRID</span>').prop("disabled", false);
                    } else if (xhr.status == 205 && (xhr.responseText.indexOf('Reset') || xhr.statusText.indexOf('Reset'))) {
                        $.notify('Adding Item Not Allowed, Please Clear Gate Detail...!!!', "info");
                    } else {
                        // $('.gridHiddenField').show();

                        $('#divSaleBillList').html(data);
                        $('#PendSaleOrderModel').modal('hide');
                        if ($('#SaleBillJobwork').val() == 'J') {
                            $('.jobWorkChalln').show();
                            $('.gridHiddenField').show();
                        } else {
                            $('.jobWorkChalln').hide();
                            $('.gridHiddenField').hide();
                        }
                        GetFeatureOption();
                        $.notify('Item Added To Grid.', "success");
                    }

                    editingNow = false;
                    BasicTotal();
                    ClearAdjustmentGrid();
                    calculatetotalqty();
                    // ResetPendQty();

                    // var rowCount = $('#divSaleBillList tr').length;

                    // for (var i = 1; i <= rowCount; i++) {

                    //     sum += parseFloat($('#GridAmount-' + i).text() == '.00' ? 0 : $('#GridAmount-' + i).text());
                    // }
                    $('#ItemNetAmount').val(sum);

                    // $('#lblItemNetAmount').text(sum.toFixed(2));

                    var txSum = 0;
                    if ($('#divTaxGrid tr td').length > 1) {
                        for (var i = 1; i <= taxRowCount; i++) {
                            txSum += parseFloat($('#txGridAmount-' + i).text() == '.00' ? 0 : $('#txGridAmount-' + i).text());
                        }
                    }

                    var txTotal = sum + txSum;
                    $('#NetTotal').val(txTotal.toFixed(2));
                    $('#BaseNetTotal').val(txTotal.toFixed(2));
                    $('#AdjPendAmt').val($('#NetTotal').val());
                           $('#NetTotal1').html($('#NetTotal').val());
                    $('#TotalDiscountPercentage').val(0);
                    $('#TotalAmtAftrDiscount').val(0);

                    // ClearGrid();
                    $('.PendingItem').hide();
                    $('.newitems').show();
                    // $('#BatchNo').val('0');
                    // $('#UniqueBatchNo').val('0');

                },
                error: function (result) {
                    $.notify(result.responseText, "error");
                },
                failure: function (result) {
                    alert(result.responseText);
                },
                complete: function () {
                    console.log('Done');
                    $('.Schedule').fadeIn();
                }
            }).done(function () {
                GetItemGroup();
                GetTaxPartItem();
                GetDbCrDetail();
                AddAdjstmntDetail1();
            })
        });



        $('.GridButton1').click(function (e) {
            e.preventDefault();
            /* if (!Validate_TransferGrid()) return; */
            var ItemData = [];
            var RowCount = $('#divPendSOGrid tr').length;
            // for (var i = 1; i <= RowCount; i++) {
            //     if ($('#AcceptedQtySHA-' + i).prop("checked") == false) continue;
            //     var Partcode= $('#PartCode-' + i).val();
            //     if (parseFloat($('#Qty-' + i).val()) > parseFloat($('#BatchWisePendQty-' + i).val()) )
            //     {
            //         $.notify('Qty should not be greater than Pending Qty or Stock for partcode:' + Partcode, "info");
            //         return;
            //     }
            //     if (parseFloat($('#Rate-' + i).val()) <=0 || ($('#Rate-' + i).val()) =='') {
            //         $.notify('Please Enter valid rate for :' + Partcode, "info");
            //         return;
            //     }
            //     if (parseFloat($('#Qty-' + i).val()) <= 0 || ($('#Qty-' + i).val()) == '') {
            //         $.notify('Please Enter valid rate for :' + Partcode, "info");
            //         return;
            //     }
            // }




            var CheckboxArr = [];
            // var RowCount = $('#MultiItemBody tr').length;

            for (var i = 1; i <= RowCount; i++) {
                if ($('#AcceptedQtySHA-' + i).prop("checked")) {
                    CheckboxArr.push(i);
                }
            }

            if (CheckboxArr.length === 0) {
                $.notify('Please select any item.', 'error');
            } else {


                // var RowCount = $('#MultiItemBody tr').length;
                for (var i = 1; i <= RowCount; i++) {
                    if ($('#AcceptedQtySHA-' + i).prop("checked")) {
                        if ($('#Qty-' + i).val() == 0) {
                            $.notify('Please enter quantity for ' + $('#PartCode-' + i).val(), 'error');
                            return;
                        }
                        if (parseFloat($('#Qty-' + i).val()) > parseFloat($('#LotStock-' + i).val())) {
                            $.notify('Please enter Valid quantity for ' + $('#PartCode-' + i).val(), 'error');
                            return;
                        }

                        if (parseFloat($('#Qty-' + i).val()) > parseFloat($('#SOPendQty-' + i).val())) {
                            $.notify('Please enter Valid quantity for ' + $('#PartCode-' + i).val(), 'error');
                            return;
                        }
                        if ($('#Rate-' + i).val() == 0) {
                            $.notify('Please enter rate for ' + $('#PartCode-' + i).val(), 'error');
                            return;
                        }
                        if ($('#Unit-' + i).val() == '') {
                            $.notify('Please select unit for ' + $('#PartCode-' + i).val(), 'error');
                            return;
                        }
                        if ($('#HSNNo-' + i).val() == '') {
                            $.notify('Please enter HSN for ' + $('#PartCode-' + i).val(), 'error');
                            return;
                        }
                        if ($('#Amount-' + i).val() == '') {
                            $.notify('amount can not be 0 ' + $('#PartCode-' + i).val(), 'error');
                            return;
                        }




                    }
                }
            }




            for (var i = 1; i <= RowCount; i++) {
                if ($('#AcceptedQtySHA-' + i).prop("checked")) {

                    ItemData.push({

                        SONO: $('#SONO-' + i).val(),
                        SOYearCode: parseInt($('#SOYearCode-' + i).val()),
                        CustOrderNo: $('#CustOrderNo-' + i).val(),
                        SchNo: $('#SchNo-' + i).val(),
                        SaleSchYearCode: parseInt($('#SaleSchYearCode-' + i).val()),
                        PartCode: $('#PartCode-' + i).val(),
                        ItemCode: parseInt($('#ItemCode-' + i).val()),
                        ItemName: $('#ItemName-' + i).val(),
                        Unit: $('#Unit-' + i).val(),

                        HSNNo: $('#HSNNo-' + i).val(),
                        SOPendQty: parseFloat($('#SOPendQty-' + i).val()),
                        StoreName: $('#StoreName-' + i).val(),
                        StoreId: parseInt($('#StoreId-' + i).val()),
                        Batchno: $('#Batchno-' + i).val(),
                        Uniquebatchno: $('#Uniquebatchno-' + i).val(),
                        TotalStock: parseFloat($('#TotalStock-' + i).val()),
                        LotStock: parseFloat($('#LotStock-' + i).val()),
                        Rate: parseFloat($('#Rate-' + i).val()),
                        Qty: parseFloat($('#Qty-' + i).val()) || 0,
                        SOType: $('#SOType-' + i).val,
                        DiscountPer: parseFloat($('#DiscountPer-' + i).val()),
                        DiscountAmt: parseFloat($('#DiscountAmt-' + i).val()),
                        Amount: parseFloat($('#Amount-' + i).val()) || 0,
                        AltQty: parseFloat($('#AltQty-' + i).val()),
                        RackID: ($('#RackID-' + i).val()),

                    });
                }
            }

            $.ajax({
                url: '@Url.Action("AddMultiSaleBillDetail")',
                type: "POST",
                data: JSON.stringify(ItemData),
                contentType: 'application/json',
                beforeSend: function () {
                    console.log('Sending item...');
                    console.log('ItemData', ItemData);
                },
                success: function (data, status, xhr) {

                    /* // ✅ Store used batch
                    itemBatchArray.push({
                        "itemcode": parseInt($('#ItemCode').val()),
                        "batchno": $('#BatchNo').val(),
                        "uniqueBatchNo": $('#UniqueBatchNo').val()
                    });

                    // ✅ Disable current used batch
                    const usedBatchNo = $('#BatchNo').val();
                    $('#BatchNo option[value="' + usedBatchNo + '"]').prop('disabled', true);

                    // ✅ Enable next unused batch from batchList
                    for (var i = 0; i < batchList.length; i++) {
                        var nextBatch = batchList[i];
                        var isUsed = itemBatchArray.some(function (item) {
                            return item.batchno === nextBatch;
                        });
                        if (!isUsed) {
                            $('#BatchNo option[value="' + nextBatch + '"]').prop('disabled', false).prop('selected', true);
                            $('#BatchNo').trigger('change'); // optional
                            break;
                        }
                    } */

                    if (data === "Duplicate" && (xhr.statusCode === 207 || xhr.responseText === "Duplicate")) {
                        $.notify('Duplicate Item Not Allowed.', "info");
                        $('.ItemBtn').html('<span role="status"><i class="fa-solid fa-angles-down fa-fw fa-lg"></i> ADD TO GRID</span>').prop("disabled", false);
                    } else if (xhr.status == 205 && (xhr.responseText.indexOf('Reset') || xhr.statusText.indexOf('Reset'))) {
                        $.notify('Adding Item Not Allowed, Please Clear Gate Detail...!!!', "info");
                    } else {
                        // $('.gridHiddenField').show();

                        $('#divSaleBillList').html(data);
                        $('#PendSaleOrderModel').modal('hide');
                        if ($('#SaleBillJobwork').val() == 'J') {
                            $('.jobWorkChalln').show();
                            $('.gridHiddenField').show();
                        } else {
                            $('.jobWorkChalln').hide();
                            $('.gridHiddenField').hide();
                        }
                        GetFeatureOption();
                        $.notify('Item Added To Grid.', "success");
                    }

                    editingNow = false;
                    BasicTotal();
                    ClearAdjustmentGrid();
                    // ResetPendQty();

                    // var rowCount = $('#divSaleBillList tr').length;

                    // for (var i = 1; i <= rowCount; i++) {

                    //     sum += parseFloat($('#GridAmount-' + i).text() == '.00' ? 0 : $('#GridAmount-' + i).text());
                    // }
                    $('#ItemNetAmount').val(sum);

                    // $('#lblItemNetAmount').text(sum.toFixed(2));

                    var txSum = 0;
                    if ($('#divTaxGrid tr td').length > 1) {
                        for (var i = 1; i <= taxRowCount; i++) {
                            txSum += parseFloat($('#txGridAmount-' + i).text() == '.00' ? 0 : $('#txGridAmount-' + i).text());
                        }
                    }

                    var txTotal = sum + txSum;
                    $('#NetTotal').val(txTotal.toFixed(2));
                    $('#BaseNetTotal').val(txTotal.toFixed(2));
                    $('#AdjPendAmt').val($('#NetTotal').val());
                    $('#NetTotal1').html($('#NetTotal').val());
                    $('#TotalDiscountPercentage').val(0);
                    $('#TotalAmtAftrDiscount').val(0);

                    // ClearGrid();
                    $('.PendingItem').hide();
                    $('.newitems').show();
                    // $('#BatchNo').val('0');
                    // $('#UniqueBatchNo').val('0');

                },
                error: function (result) {
                    $.notify(result.responseText, "error");
                },
                failure: function (result) {
                    alert(result.responseText);
                },
                complete: function () {
                    console.log('Done');
                    $('.Schedule').fadeIn();
                }
            }).done(function () {
                GetItemGroup();
                GetTaxPartItem();
                GetDbCrDetail();
                AddAdjstmntDetail1();
            })
        });


        function updateSupplyTypeOptions() {
            const $supplyType = $('#SupplyType');
            const selectedValue = $('#DomesticExportNEPZ').val();
            $supplyType.empty();

            if (selectedValue === "EXPORT") {
                $supplyType.append($('<option>', { value: "", text: "-- Select --" }));

                $.each(exportSupplyTypes, function (i, text) {
                    $supplyType.append($('<option>', {
                        value: text,
                        text: text
                    }));
                });
            } else {
                $supplyType.append($('<option>', { value: "", text: "-- Select --" }));
            }
        }
        $(function () {
            $("#vehicleNo").autocomplete({
                source: function (request, response) {

                    $.ajax({
                        url: '@Url.Action("AutoComplete", "SaleInvoice")',
                        type: "POST",
                        data: { "ColumnName": "vehicleNo", "prefix": request.term },
                        success: function (data) {
                            response($.map(data,
                                function (key, value) {
                                    return key.text;
                                }));
                        },
                        error: function (response) {
                            alert(response.responseText);
                        },
                        failure: function (response) {
                            alert(response.responseText);
                        }
                    });
                },
                select: function (e, i) {
                    $("#vehicleNo").val(i.item.value);
                },
                change: function (e, i) {

                    //$("#vehicleNo").val($("#vehicleNo").val());
                },
                minLength: 1
            });
        });

        async function CheckDuplicate(n, v) {
            $.ajax({
                url: "@Url.Action("isDuplicate", "SaleInvoice")",
                type: "POST",
                data: { "Colval": $('#' + v).val(), "ColName": n },
                success: await function (data) {
                    if (data.result !== "0" && data.statusText === "Error") {
                        var message = 'Duplicate Entry : ' + $('#' + v).val() + ' Found For Column : ' + n;
                        $('#' + v).val('');
                        $.notify(message, { position: "top center", className: "error" });
                    }
                },
                error: function (errMsg) {
                    $.notify(errMsg, { position: "top center", className: "error" });
                }
            });
        }

        if ($('#Mode').val() != "U" && $('#Mode').val() != "V") {
            NewEntryId();
            btnClearTax();
            // FillItems($('#TypeItemServAssets').val());
        } else {
            SetminQty();
            BasicTotal();
            $('#DT').prop("checked", true);
            $('#PN1').prop("checked", true);
            // FillCustomerList("Y");
            $('#SaleBillNo').val($('#hiddenSaleBillNo').val());
            var taxRowCount = $('#divTaxGrid tr').length;

            var txSum = 0;
            if ($('#divTaxGrid tr td').length > 1) {
                for (var i = 0; i < taxRowCount; i++) {
                    txSum += parseFloat($('#txGridAmount-' + (i + 1)).text()) == '.00' || $('#txGridAmount-' + (i + 1)).text() == '' ? 0 : parseFloat($('#txGridAmount-' + (i + 1)).text());
                }
            }
            var TotalRoundOffAmt=0;
                      if ($("#TotalRoundOff").val() == "Y") {
                      TotalRoundOffAmt=  parseFloat(  $('#TotalRoundOffAmt').val());
               }
                   var txTotal = sum + txSum+TotalRoundOffAmt;
            $('#NetTotal').val(txTotal.toFixed(2));
            $('#BaseNetTotal').val(txTotal.toFixed(2));
            $('#AdjPendAmt').val($('#NetTotal').val());
                   $('#NetTotal1').html($('#NetTotal').val());
        }

        if ($('#SaleBillJobwork').val() == 'S') {
            $('#SaleBillJobwork').css("background-color", "#fff5d5");
        }

        // isAccountCodeClear = false;

        if ($('#SaleBillJobwork').val() == 'J') {
            $('.jobWorkChalln').show();
            $('.gridHiddenField').show();
        } else {
            $('.jobWorkChalln').hide();
            $('.gridHiddenField').hide();
        }

        $('#AdjNewRefNo').val($('#SaleBillNo').val());
        $('#AdjDescription').val($('#SaleBillNo').val());

        AllowTaxPassword();
        $('#Unit').prop("readonly", true);
        $('#AltUnit').prop("readonly", true);

        if ($('#SONO').val() == '') {
            $('#ItemSA').prop("disabled", false);
        }
        var ischeckedAc = $('#PN1').is(':checked') == true ? 'Y' : 'N';
        FillCustomerList(ischeckedAc);
        FillConsigneeList("");
        var dtValue = $('#DT').prop("checked") == true ? "T" : "F";

        FillDocument(dtValue);
        FillStore();
        FillDistance();
        FillTransporter();
        // $('#PartCode').select2();
        // $('#ItemCode').select2();
      //  $('#AccountCode').select2();
        $('#DocTypeAccountCode').select2();
        // $('#TransporterName').select2();
        $('.AF').fadeOut();
        AutoComplete("DistanceKM", "DistanceKM");
        //  AutoComplete('VIssueAgainstPlanSchMainDetailItem', 'vehicleNo', 'vehicleNo', null);
        AutoComplete("vehicleNo", "vehicleNo");

        var InvDate = parseDateToFormat($('#SaleBillDate').val().split(" ")[0]);

        // var parts = InvDate.split('/');
        // var InvDate = new Date(parts[2], parts[1] - 1, parts[0]);
        // var RemovalDate = new Date(InvDate);
        // RemovalDate.setDate(RemovalDate.getDate() + 1);

        // $('#RemovalDate').datepicker({ dateFormat: 'dd/mm/yy' }).datepicker("setDate", RemovalDate);
        $('#RemovalDate').datepicker("option", "minDate", InvDate);

        GetTaxPartItem();

        if ($('#Mode').val() == "V" || $('#Mode').val() == "U") {
            GetDbCrDetail(); FillCurrency(); FillSONO(); BomAdjustChallanGrid();
            var InvDate = ($('#SaleBillDate').val().split(" ")[0]);
            $('#RemovalDate').datepicker("option", "minDate", InvDate);
        }

        DueDateCalculation();

        $('#DiscountPer').prop("readonly", false);
        $('#DiscountAmt').prop("readonly", false);

        // var txAmt = $('#lblItemNetAmount').text();
        // $('#NetTotal').val(txAmt);
        // $('#AdjPendAmt').val($('#NetTotal').val());

        function removeRequiredRule(id) {
            var $el = $('#' + id.trim());
            var validator = $el.closest("form").data("validator");

            if ($el.length && validator && validator.settings && $el.rules) {
                try {
                    $el.rules("remove", "required");
                } catch (e) {
                    console.warn(`Could not remove rule for #${id}:`, e.message);
                }
            }
        }

        // All input field IDs where the "required" rule should be removed
        var fieldIds = [
            'ProducedUnprod', 'BOMInd', 'BomNo', 'SaleBillJobwork', 'SONO',
            'SOYearCode', 'CustOrderNo', 'Qty', 'AltQty', 'RateInOtherCurr',
            'NoofPcs', 'Amount', 'DiscountAmt', 'DiscountPer', 'Batchno',
            'SOPendQty', 'AltUnit', 'SaleBillEntryId', 'SaleBillYearCode',
            'SaleBillNo', 'SaleBillDate', 'InvoiceTime', 'RemovalDate',
            'RemovalTime', 'AccountCode', 'PN1', 'GSTNO', 'StateNameofSupply',
            'CustAddress', 'StateCode', 'CityofSupply', 'CountryOfSupply',
            'vehicleNo', 'TransporterName', 'TransportModeBYRoadAIR',
            'DispatchTo', 'DispatchThrough', 'DomesticExportNEPZ',
            'DocTypeAccountCode', 'PaymentTerm', 'currencyId', 'ExchangeRate',
            'TypeItemServAssets', 'ConsigneeAccountcode', 'ConsigneeAddress',
            'Unit', 'PacketsDetail', 'OtherDetail', 'ItemRemark', 'SupplyType',
            'TypeJob', 'dispatchLocation', 'BILLAgainstWarrenty',
            'PerformaInvNo', 'TaxbaleAmtInWord', 'RoundTypea', 'PermitNo',
            'NetAmtInWords', 'ExportInvoiceNo', 'CancelBill', 'Cancelreason',
            'BankName', 'Ewaybillno', 'FreightPaid', 'TransporterdocNo',
            'DispatchDelayReason', 'AttachmentFilePath1', 'AttachmentFilePath2',
            'AttachmentFilePath3', 'DocketNo', 'DispatchDelayreson', 'Commodity',
            'EInvNo', 'Remark', 'EinvGenerated', 'SaleQuotNo', 'SaleQuotDate',
            'EntryFreezToAccounts', 'ChallanNo', 'BalanceSheetClosed', 'Schdate',
            'HSNNo', 'Uniquebatchno', 'AgstInvNo', 'PerformaInvYearCode',
            'AgstInvDate', 'CostCenterId', 'ActualEnteredByName',
            'AdjModeOfAdjstment', 'AdjDescription', 'AdjDueDate', 'AdjNewRefNo',
            'AdjPendAmt', 'dbCrsearch-box', 'StoreId', 'ItemSize', 'Itemcolor',
            'ProcessId', 'GSTPer', 'GSTType', 'UnitOfRate', 'OriginalMRP', 'MRP',
            'AltSOPendQty', 'AdviceNo', 'AdviseEntryId', 'AdviceYearCode',
            'AdviseDate', 'ProdSchno', 'AgainstProdPlanNo',
            'AgainstProdPlanYearCode', 'AgaisntProdPlanDate', 'SOAmendNo',
            'SOAmendDate', 'ProdSchYearcode', 'ProdSchEntryId', 'ProdSchDate',
            'SchdeliveryDate', 'DistanceKM'
        ];


        var itemBatchArray = []; // ✅ Initialize the array before pushing
        var rowCount = $('#divSaleBillList tr').length;
        for (var i = 1; i <= rowCount; i++) {
            var itemCodee = parseInt($('#GridIC-' + i).val());
            var batchNoo = $('#GridBatchNo-' + i).text();
            var uniquebatchnoo = $('#GridUniqueBatchNo-' + i).text();
            var Seqno = $('#SeqNo-' + i).val();

            itemBatchArray.push({
                "SeqNo": parseInt(Seqno),
                "itemcode": itemCodee,
                "batchno": batchNoo,
                "uniquebatchno": uniquebatchnoo
            });
        }


        // for (var i = 1; i <= rowCount; i++) {
        //     var itemCodee = parseInt($('#GridIC-' + i).val());
        //     var batchNoo = $('#GridBatchNo-' + i).text();
        //     var uniquebatchnoo = $('#GridUniqueBatchNo-' + i).text();
        //     var Seqno = $('#SeqNo-' + i).val();
        //     itemBatchArray.push({
        //         "SeqNo": parseInt(Seqno),
        //         "itemcode": itemCodee,
        //         "batchno": batchNoo,
        //         "uniquebatchno": uniquebatchnoo
        //     });
        // }

        if ($('#Mode').val() == "U") {
            if ($('#EInvNo').val() == "Y" || $('#EinvGenerated').val() == "Y") {
                $('#SaleBillJobwork').prop("disabled", true);
                $('#GSTNO').prop("disabled", true);
                $('#CustAddress').prop("disabled", true);
                $('#DistanceKM').prop("disabled", true);
                $('#vehicleNo').prop("disabled", true);
                $('#TransporterName').prop("disabled", true);
                $('#TransportModeBYRoadAIR').prop("disabled", true);
                $('#DispatchTo').prop("disabled", true);
                $('#DispatchThrough').prop("disabled", true);
                $('#SupplyType').prop("disabled", true);
                $('#DocTypeAccountCode').prop("disabled", true);
                $('#PaymentCreditDay').prop("disabled", true);
                $('#TypeJob').prop("disabled", true);
                $('#currencyId').prop("disabled", true);
                $('#ExchangeRate').prop("disabled", true);
                $('#TypeItemServAssets').prop("disabled", true);
                $('#dispatchLocation').prop("disabled", true);
                $('#ConsigneeAccountcode').prop("disabled", true);
                $('#ConsigneeAddress').prop("disabled", true);
                $('.SODetail').prop("disabled", true);
                $('#btnAdjustChallanListGrid').prop("disabled", true);
                $('.ItemBtn').prop("disabled", true);
                $('.btnAddTax2Grid').prop("disabled", true);
                $('.btnEnterTaxPass').css("display", "none");
                $('.btnClearTax').prop("disabled", true);
                $('#AccountCode').prop("disabled", true);
                $('.btnClearTax').prop("disabled", true);
            }
        }


        document.addEventListener('DOMContentLoaded', function () {
            var now = new Date();
            var hours = ('0' + now.getHours()).slice(-2);
            var minutes = ('0' + now.getMinutes()).slice(-2);
            document.getElementById('RemovalTime').value = hours + ':' + minutes;
        });

        function formatDate(dateString) {
            const [day, month, year] = dateString.split('/'); // Split dd/MM/yyyy
            return `${month}/${day}/${year}`; // Reformat to MM/dd/yyyy
        }
        document.addEventListener('DOMContentLoaded', function () {
            var now = new Date();
            var hours = ('0' + now.getHours()).slice(-2);
            var minutes = ('0' + now.getMinutes()).slice(-2);
            document.getElementById('InvoiceTime').value = hours + ':' + minutes;
        });

        $('#AdjModeOfAdjstment').change(function () {
            $('#AdjNewRefNo').val($('#SaleBillNo').val());
            $('#AdjDescription').val($('#SaleBillNo').val());
            $('#AdjPendAmt').val($('#NetTotal').val());
        });

        $("#HSNNo,#Qty").on("input", function (e) {
            var inputValue = $(this).val();

            inputValue = inputValue.replace(/[^0-9.]/g, '');

            var dotCount = inputValue.split('.').length - 1;
            if (dotCount > 1) {
                inputValue = inputValue.slice(0, -1);
            }
            $(this).val(inputValue);
        });

        $('#SaleBillJobwork').change(function () {

            if ($('#SaleBillJobwork').val() == 'J') {
                $('.jobWorkChalln').show();
                $('.gridHiddenField').show();
                FillJWCustomerList();
                $('#SaleBillJobwork').css("background-color", "#fde5fc");

            } else {
                $('.jobWorkChalln').hide();
                $('.gridHiddenField').hide();
                FillCustomerList($('#PN1').is(":checked"));
                $('#SaleBillJobwork').css("background-color", "#fff5d5");

            }
        });

        $('#pendingChallanList').click(function (event) {
            event.preventDefault();
            $('#PendingChallanListPopupModel').modal("show");
            $.ajax({
                url: "@Url.Action("GetPopUpData", "CustomerJWI")",
                type: 'GET',
                async: false,
                data: {
                    "YearCode": $('#SaleBillYearCode').val(),
                    "EntryDate": formatDate($('#SaleBillDate').val()),
                    "ChallanDate": formatDate($('#SaleBillDate').val()),
                    "AccountCode": $('#AccountCode').val()
                },
                success: function (result, status, xhr) {
                    $('#divPendingChallanDisplayGrid').empty();
                    if (result != null) {
                        // if (result && result.Result && result.Result.length > 0)
                        // {
                        // if (result && result.Result && Array.isArray(result.Result) && result.Result.length > 0) {
                        var obj = $.parseJSON(result);
                        if (obj.StatusCode == 200 && obj.StatusText == 'Success') {

                            var html = '';
                            var i = 1;
                            $.each(obj.Result, function (index, val) {
                                html += '<tr>' +
                                    '<td>' + i + '</td>' +
                                    '<td>' + val.CustomerName + '</td>' +
                                    '<td id="PartCode' + i + '">' + val.RecPartcode + '</td>' +
                                    '<td id="ItemName' + i + '">' + val.RecItemName + '</td>' +
                                    '<td id="BomInd' + i + '">' + val.BOMIND + '</td>' +
                                    '<td>' + val.RecJWChallan + '</td>' +
                                    '<td>' + val.RecChallanYearCode + '</td>' +
                                    '<td>' + val.RecChallandate.split("T")[0] + '</td>' +
                                    '<td>' + val.RecQty + '</td>' +
                                    '<td>' + val.IssQty + '</td>' +
                                    '<td>' + val.ActualPendQty + '</td>' +
                                    '<td>' + val.PendQty + '</td>' +
                                    '</tr>';
                            });
                            $('#divPendingChallanDisplayGrid').append(html);
                        } else {
                            $('#divPendingChallanDisplayGrid').append('<tr class="text-center"><td colspan="26" class="text-black-50"><strong>NO DATA FOUND</strong></td></tr>')
                        }
                    } else {
                        alert('No data or result is not as expected!');
                    }
                }
            });

            $('#PendingChallanListPopupModel').modal("hide");
        });


        var currentSearchColumn = null;
        $(document).on("click", "#divPendingChallanDisplayGrid th[data-columnno]", function () {

            currentSearchColumn = $(this).data('columnno');
            $("#pending-search-box").val('').trigger('keyup');
        });

        $("#pending-search-box").on("keyup", function () {
            var value = $("#pending-search-box").val().toLowerCase();

            $("#divPendingChallanDisplayGrid tr").filter(function () {
                var rowContainsValue = false;

                if (currentSearchColumn != null) {
                    var columnText = $(this).find('td').eq(currentSearchColumn).text().trim().toLowerCase();
                    rowContainsValue = columnText.indexOf(value) > -1;
                } else {
                    $(this).find('td').each(function () {
                        var columnText = $(this).text().trim().toLowerCase();
                        if (columnText.indexOf(value) > -1) {
                            rowContainsValue = true;
                            return false;
                        }
                    });
                }

                $(this).toggle(rowContainsValue);
            });
        });


        function ValidateAdjDetail() {
            if ($('#AccountCode').val() == 0) {
                $.notify('please enter AccountCode...!', "error");
                return false;
            }

            if ($('#divSaleBillList tr td').length <= 1) {
                $.notify('please fill item grids...!', "error");
                return false;
            }

            return true;
        }

        $('#btnAdjustChallanListGrid').click(function (event) {
            event.preventDefault();

            if (!ValidateAdjDetail()) return;
            var YearCode = $('#SaleBillYearCode').val();
            var EntryDate = $('#FinFromDate').val();
            var ChallanDate = $('#ChallanDate').val();
            var AccountCode = $('#AccountCode').val();
            var itemCode = $('#ItemCode').val();
            var adjustedData = [];

            $("#divSaleBillList tr").each(function () {

                var row = $(this);
                var rowData = {
                    // ProduceUnproduce: row.find("td:eq(2)").text().trim(),
                    ItemCode: row.find("td:eq(1) input").val(), // ItemCode
                    Unit: row.find("td:eq(21)").text().trim(),
                    BillQty: row.find("td:eq(12)").text().trim(),
                    JWRate: row.find("td:eq(13)").text().trim(),
                    ProcessId: row.find("td:eq(29) input").val(), // ProcoessId
                    SONO: row.find("td:eq(5)").text().trim(),
                    CustOrderNo: row.find("td:eq(7)").text().trim(),
                    SOYearCode: row.find("td:eq(19)").text().trim(),
                    SchNo: row.find("td:eq(8)").text().trim(),
                    SchYearcode: row.find("td:eq(20)").text().trim(),
                    BOMIND: row.find("td:eq(3)").text().trim(), // BOMIND
                    BOMNO: $('#BomNo').val(), //BomNo
                    BOMEffDate: "", //Bom Eff Date
                    Produnprod: row.find("td:eq(4)").text().trim(),
                    fromChallanOrSalebill: "",
                    ItemAdjustmentRequired: ""
                };

                adjustedData.push(rowData);
            });

            console.log("Adustdata:", adjustedData);

            $.ajax({
                url: "@Url.Action("GetAdjustedChallanDetailsData")",
                type: "POST",
                // contentType: "application/json; charset=utf-8",
                // data: JSON.stringify(adjustedData),
                data: {
                    "model": adjustedData,
                    "YearCode": YearCode,
                    "EntryDate": EntryDate,
                    "ChallanDate": ChallanDate,
                    "AccountCode": AccountCode,
                    "ItemCode": itemCode
                },
                // dataType: "html",
                async: false,
                success: function (data) {

                    $('#divCustJobWorkISsueSummary').html(data);
                    var dashGrid = $('#divCustJobWorkISsueSummary').length ? $('#divCustJobWorkISsueSummary').length : 0;
                    $('#totalRows').text(dashGrid);
                    BomAdjustChallanGrid();
                },
                error: function (response) {
                    alert(response.responseText);
                },
                failure: function (response) {
                    alert(response.responseText);
                }
            });
        });


        function fillBomRevNo() {
            $.ajax({
                type: "POST",
                url: "@Url.Action("GetBomRevNo", "ReqThroughBom")",
                async: false,
                data: { ItemCode: $('#ItemCode').val() },
                dataType: "json",
                success: function (result, status, error) {
                    if (result != null) {

                        var obj = $.parseJSON(result);
                        if (obj.StatusCode == 200 && obj.StatusText == 'Success') {
                            $('#BomNo').empty();
                            $('#BOMEffDate').val('');
                            $.each(obj.Result, function (index, val) {
                                $('#BomNo').append('<option value="' + val.bomno + '">' + val.bomno + '</option>');
                            });
                        }

                    }
                }

            });
        }

        function BomAdjustChallanGrid() {
            // event.preventDefault();

            if (!ValidateAdjDetail()) return;
            var YearCode = $('#SaleBillYearCode').val();
            var EntryDate = $('#FinFromDate').val();
            var ChallanDate = $('#ChallanDate').val();
            var AccountCode = $('#AccountCode').val();
            var itemCode = $('#ItemCode').val();
            var adjustedData = [];

            $("#divSaleBillList tr").each(function () {

                var row = $(this);
                var rowData = {
                    // ProduceUnproduce: row.find("td:eq(2)").text().trim(),
                    ItemCode: row.find("td:eq(1) input").val(), // ItemCode
                    Unit: row.find("td:eq(21)").text().trim(),
                    BillQty: row.find("td:eq(12)").text().trim(),
                    JWRate: row.find("td:eq(13)").text().trim(),
                    ProcessId: row.find("td:eq(29) input").val(), // ProcoessId
                    SONO: row.find("td:eq(5)").text().trim(),
                    CustOrderNo: row.find("td:eq(7)").text().trim(),
                    SOYearCode: row.find("td:eq(19)").text().trim(),
                    SchNo: row.find("td:eq(8)").text().trim(),
                    SchYearcode: row.find("td:eq(20)").text().trim(),
                    BOMIND: row.find("td:eq(3)").text().trim(), // BOMIND
                    BOMNO: $('#BomNo').val(), //BomNo
                    BOMEffDate: "", //Bom Eff Date
                    Produnprod: row.find("td:eq(4)").text().trim(),
                    fromChallanOrSalebill: "",
                    ItemAdjustmentRequired: ""
                };

                adjustedData.push(rowData);
            });

            console.log("Adustdata:", adjustedData);

            $.ajax({
                url: "@Url.Action("GetBomAdjustedChallanDetailsData")",
                type: "POST",
                // contentType: "application/json; charset=utf-8",
                // data: JSON.stringify(adjustedData),
                data: {
                    "model": adjustedData,
                    "YearCode": YearCode,
                    "EntryDate": EntryDate,
                    "ChallanDate": ChallanDate,
                    "AccountCode": AccountCode,
                    "ItemCode": itemCode
                },
                // dataType: "html",
                async: false,
                success: function (data) {

                    $('#divBomCustJobWorkISsueSummary').html(data);
                    var dashGrid = $('#divBomCustJobWorkISsueSummary').length ? $('#divBomCustJobWorkISsueSummary').length : 0;
                    $('#totalRows').text(dashGrid);
                },
                error: function (response) {
                    alert(response.responseText);
                },
                failure: function (response) {
                    alert(response.responseText);
                }
            });
        }

        $('#soDetailExcel').click(function () {
            const table = document.querySelector(".poPopUpData");
            const rows = table.querySelectorAll("tr");
            const data = [];

            const headerRow = rows[0];
            const headerData = [];

            headerRow.querySelectorAll("th").forEach((cell, index) => {
                if ($(cell).is(':visible')) {
                    headerData.push(cell.textContent);
                }
            });

            let maxColumns = 0;
            for (let i = 1; i < rows.length; i++) {
                const cellsCount = rows[i].querySelectorAll("td, input").length;
                maxColumns = Math.max(maxColumns, cellsCount);
            }
            for (let i = headerData.length; i < maxColumns; i++) {
                headerData.push('');
            }

            data.push(headerData);

            for (let i = 1; i < rows.length; i++) {
                const rowData = [];
                const cells = rows[i].querySelectorAll("td");

                cells.forEach((cell, index) => {
                    if ($(headerRow.querySelectorAll("th")[index]).is(':visible')) {
                        rowData.push(cell.textContent);
                    }
                });

                const inputCells = rows[i].querySelectorAll("input");
                if (inputCells.length > 0) {
                    inputCells.forEach((inputCell, index) => {
                        if ($(headerRow.querySelectorAll("th")[index]).is(':visible')) {
                            rowData.push(inputCell.value);
                        }
                    });
                }
                for (let j = rowData.length; j < headerData.length; j++) {
                    rowData.push('');
                }

                data.push(rowData);
            }

            const ws = XLSX.utils.aoa_to_sheet(data);

            const colsWidths = [];
            headerRow.querySelectorAll("th").forEach((cell, index) => {
                if ($(cell).is(':visible')) {
                    colsWidths.push({ wch: 15 });
                }
            });
            ws["!cols"] = colsWidths;

            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Sheet 1")

            XLSX.writeFile(wb, "SaleBillSODetail.xlsx");
        });

        // function CloseCross() {
        //     $("#exampleModal").modal("hide");
        // }

        // function CloseButton() {
        //     $("#exampleModal").modal("hide");
        // }

        function DueDateCalculation() {
            var saleBillDateVal = $('#SaleBillDate').val();

            if (!saleBillDateVal) {
                console.warn("SaleBillDate is empty, skipping DueDateCalculation");
                return;
            }

            // If value is like "31/08/2025" → no need to split
            var [day, month, year] = saleBillDateVal.split('/').map(Number);
            var SaleBillDate = new Date(year, month - 1, day);

            var creditDays = $('#PaymentCreditDay').val() == "" ? 0 : parseInt($('#PaymentCreditDay').val(), 10);

            // Add credit days
            SaleBillDate.setDate(SaleBillDate.getDate() + creditDays);

            // Format as dd/mm/yy
            var formattedDueDate = $.datepicker.formatDate('dd/mm/yy', SaleBillDate);

            // Set in AdjDueDate
            $('#AdjDueDate').datepicker({ dateFormat: 'dd/mm/yy' }).datepicker("setDate", formattedDueDate);

            // Restrict min date to SaleBillDate
            $('#AdjDueDate').datepicker("option", "minDate", saleBillDateVal);
        }

        $('#PaymentCreditDay').change(function () {
            $('#divAdjItemList').empty();
            var NoData = '<tr class="text-center"><td colspan="32" class="text-black-50"><strong>NO DATA ADDED</strong></td></tr>';
            $('#divAdjItemList').html(NoData);
            CalculateAdjAmt('NetTotal');
            DueDateCalculation();
              ClearAdjustmentGrid();
                    AddAdjstmntDetail1();
         
        });

        function PasswordCheck() {

            if ($('#taxPassword').val() != allowManualPassword) {
                $.notify('please correct password...!', "error");
            } else {
                $('.btnAddTax2Grid').prop("disabled", false);
                //$('.btnTax4HSN').prop("disabled", false);
                $('.btnTax2All').prop("disabled", false);

                $('#saleBillTaxAllowPopup').modal('hide');
            }
            $('#taxPassword').val("");
        }

        function FillAltQty() {
            var ItemCode = parseInt($('#ItemCode').val());
            var AltQty = $('#AltQty').val();
            var UnitQty = parseFloat($('#TotalStock').val());
            $.ajax({
                type: "POST",
                data: { "ItemCode": ItemCode, "AltQty": AltQty, "UnitQty": UnitQty },
                url: "@Url.Action("GetAltUnitQty", "StockAdjustment")",
                dataType: "json",
                success: function (result, status, error) {
                    if (result != null) {
                        var obj = $.parseJSON(result);
                        if (obj.Result.length > 0) {
                            $('#AltQty').val("");
                            $('#AltQty').val(obj.Result[0].AltUnitValue);
                        }
                    }
                }
            });
        }

        // $('#btnAddTax2Grid').click(function () {
        //     AllowTaxPassword();
        // });

        // $('#TxType,#TxTaxType').change(function () {
        //     AllowTaxPassword();
        // });

        var isAllowTaxPass = "";
        var allowManualPassword = "";
        function AllowTaxPassword() {
            if ($('title').text().indexOf('SaleInvoice') == 0) {
                ('inside allow');
                $('.enterTaxPass').css("display", "block");
            }

            $.ajax({
                type: "POST",
                url: "@Url.Action("AllowTaxPassword")",
                dataType: "json",
                success: function (result, status, error) {

                    if (result != null) {
                        var obj = $.parseJSON(result);
                        if (obj.Result.length > 0) {
                            if (obj.Result[0].AccSaleBillManualTaxAlloweed == 'N') {
                                $('.btnAddTax2Grid').prop("disabled", true);
                                //$('.btnTax4HSN').prop("disabled", true);
                                $('.btnTax2All').prop("disabled", true);
                            } else if (obj.Result[0].AccSaleBillManualTaxAlloweed == 'Y') {
                                $('.enterTaxPass').css("display", "none");
                            }
                            isAllowTaxPass = obj.Result[0].AccSaleBillManualTaxAlloweed;
                            allowManualPassword = obj.Result[0].AccPasswordToAllowManualTax;
                        }
                    }
                }
            });
        }

        $('.enterTaxPass').click(function () {
            // if(isAllowTaxPass == "Y"){
            $('#saleBillTaxAllowPopup').modal("show");
            // }
        });

        function ResetPendQty() {

            // FillSOPendQty();
            if ($('#SOPendQty').val() != 0) {
                var rowCount = $('#divSaleBillList tr').length;
                var totalBillQty = 0;
                // GridIC-1
                var saleBillQty = 0;
                for (var i = 1; i <= rowCount; i++) {
                    if ($('#GridSONO-' + i).text() == $('#SONO').val() && $('#GridIC-' + i).val() == $('#ItemCode').val()) {
                        saleBillQty = 0;
                        saleBillQty = $('#saleBillRow-' + i).find('#billQty').text() == '' ? 0 : parseFloat($('#saleBillRow-' + i).find('#billQty').text());
                        totalBillQty += saleBillQty;
                    }
                }

                var soPendQty = $('#SOPendQty').val() == '' ? 0 : parseFloat($('#SOPendQty').val());
                soPendQty = (soPendQty - totalBillQty) < 0 ? 0 : (soPendQty - totalBillQty);
                $('#SOPendQty').val(soPendQty);
                $('#Qty').val($('#SOPendQty').val());
                CalculateAmount();
            }
        }

        // $('#DiscountPer').on('input', function () {
        //     var discPer = $(this).val();
        //     if (discPer < 0 || discPer > 100 || isNaN(discPer)) {
        //         $(this).val('');
        //     }
        // });

        $('#NoofPcs').on('input', function () {
            var value = $(this).val();

            if (value < 0 || isNaN(value) || value.includes('--')) {
                $(this).val('');
            }
            $(this).val(value.replace(/[^0-9]/g, ''));
        });


        $('#AltQty').on('input', function () {
            var value = $(this).val();

            if (value < 0 || isNaN(value) || value.includes('--')) {
                $(this).val('');
            }

            $(this).val(value.replace(/[^0-9.]/g, ''));

            if ((value.match(/\./g) || []).length > 1) {
                $(this).val(value.substring(0, value.lastIndexOf('.')));
            }
        });

        $('#PaymentCreditDay').on('input', function () {
            var creditDays = $(this).val();
            if (isNaN(creditDays) || creditDays < 0 || creditDays > 90) {
                $(this).val('');
            } else {
                $(this).val(parseInt(creditDays, 10));
            }
        });
        var isAccountCodeClear = false;
        $('#AccountCode').change(function () {
         //   $('#PartyName').val($('#AccountCode option:selected').text());
              $('#PartyName').val($("#AccountCodeText").val());


            $.getJSON({
                url: '@Url.Action("GetGstRegister", "PurchaseOrder")',
                data: { Code: $('#AccountCode').val() },
                success: function (result, status, xhr) {
                    if (result != null) {
                        var obj = $.parseJSON(result);
                        $('#GSTRegistered').val(obj.Result[0].GSTRegistered);
                    }
                    // if ($('#divSaleBillList tr td').length > 1) {
                    //     isAccountCodeClear = true;
                    // }
                    itemArrayLength = [];
                }
            });
            FillDistance();
            FillSONO();

            ClearGrid();
            btnClearTax();
            ClearAdjustmentGrid();
            ClearDRCRGrid();
            ClearCustomerJWGrid();
        });

        $("#PaymentTerm").on("input", function (e) {
            var inputValue = $(this).val();

            inputValue = inputValue.replace(/[^0-9.]/g, '');

            var dotCount = inputValue.split('.').length - 1;
            if (dotCount > 1) {
                inputValue = inputValue.slice(0, -1);
            }
            $(this).val(inputValue);
        });

        $("#DistanceKM").on("input", function (e) {
            var inputValue = $(this).val();

            inputValue = inputValue.replace(/[^0-9.]/g, '');

            var dotCount = inputValue.split('.').length - 1;
            if (dotCount > 1) {
                inputValue = inputValue.slice(0, -1);
            }
            $(this).val(inputValue);
        });

        async function GetTaxPartItem() {
            $.ajax({
                type: "GET",
                url: '@Url.Action("GetTaxPartItem", "Tax")',
                data: { SessionName: "SaleInvoice", Mode: $('#Mode').val() },
                dataType: "json",
                success: await function (data, status, error) {

                    $('#TxPartCode').empty();
                    $('#TxPartCode').append('<option>-Select-</option>');
                    var PartCode = 0;
                    var arrayPartCode = [];
                    $.each(data.partCode, function (key, val) {
                        if (arrayPartCode.includes(val.text)) {
                            //do nothing
                        }
                        else {
                            $('#TxPartCode').append('<option value="' + val.value + '">' + val.text + '</option>');
                            arrayPartCode.push(val.text);
                        }
                    });
                    $("[id='TxItemCode']").empty();
                    $("[id='TxItemCode']").append('<option>-Select-</option>');
                    var ItemText = 0;
                    var arrayitemCode = [];
                    $.each(data.itemCode, function (key, val) {
                        if (arrayitemCode.includes(val.text)) {
                            //do nothing
                        }
                        else {
                            $("[id='TxItemCode']").append('<option value="' + val.value + '">' + val.text + '</option>');
                            arrayitemCode.push(val.text);
                        }

                    });
                },
                error: function (req, status, error) {
                    alert(error);
                }
            });
        }
                function onItemSelected(idType) {
            if (idType === 'PartCode') {
                SetPartCodeItemName('PartCode');
            } else {
                SetPartCodeItemName('ItemCode');
            }

            fillBomRevNo();
            // FillCurrentBatchINStore();
            FillSOPendQty();
            FillTotalStock();
            FillSOItemRate();
            DisableDiscountFields();
            CalculateAmount();
            GetlastBillDetail();
        }
        // $(document).on('select2:select', '#PartCode,#ItemCode', function (e) {

        //     var cntId = e.target.id;
        //     if (cntId == 'PartCode') {
        //         SetPartCodeItemName('PartCode');
        //     }
        //     else {
        //         SetPartCodeItemName('ItemCode');
        //     }

        //     // FillSOSchedule();
        //     fillBomRevNo();
        //     FillCurrentBatchINStore();
        //     // $('#StoreId').val(0);
        //     FillSOPendQty();
        //     FillTotalStock();
        //     FillSOItemRate();
        //     DisableDiscountFields();
        //     CalculateAmount();
        //     GetlastBillDetail();
        // });
              
        function DisableDiscountFields() {

            var rowCount = $('#divSaleBillList tr').length;
            var discPer = 0;
            var discFieldFlag = false;
            for (var i = 1; i <= rowCount; i++) {

                if ($('#GridIC-' + i).val() == $('#PartCode').val()) {
                    discFieldFlag = true;
                    discPer = ($('#saleBillRow-' + i).find('td.DiscPer').text() == '' ? 0 : parseFloat($('#saleBillRow-' + i).find('td.DiscPer').text()));
                }
                // else {
                //     $('#DiscountPer').val(0);
                //     $('#DiscountAmt').val(0);
                //     $('#DiscountPer').prop("readonly", false);
                //     $('#DiscountAmt').prop("readonly", false);
                // }
            }
            if (discFieldFlag) {
                if ($('#DiscountPer').val() == '0') {
                    $('#DiscountPer').val(discPer);
                    $('#DiscountPer').prop("readonly", true);
                    $('#DiscountAmt').prop("readonly", true);
                }
            }
        }

        $('#SchNo').change(function () {
            FillSchYearCode();
        });

        function calculatetotalqty() {
            var totalQty = 0;

            // Loop through each row inside tbody (to skip table header)
            $('#divSaleBillList tr').each(function () {
                var billQty = parseFloat($(this).find('.billQty').text()) || 0;
                totalQty += billQty;
            });

            // Set total qty rounded to 2 decimals
            $('#TotalQty').text(totalQty.toFixed(2));
        }

        function ValidateGrid() {

            if (!SetminQty()) return;

            var Err = 0;
            $('#Batchno').find(':selected').prop("disabled", false)
            // if ($('#PartCode').prop('selectedIndex') == 0) {
            //     AddErrorCls('PartCode');
            //     $.notify('please select Partcode...!', "error");
            //     Err = 1;
            // }
            // else {
            //     RemoveErrorCls('PartCode');
            // }
                    let partCodeValue = "";
        if ($("#PartCode").is("select")) {
            partCodeValue = $('#PartCode').find(':selected').val();
        } else {
            partCodeValue = $('#PartCodeText').val();
        }
        if (!partCodeValue || partCodeValue === "0" || partCodeValue === "-Select-") {
            AddErrorCls('PartCode');
            $.notify('Please select or enter a valid Part Code!', "error");
            Err = 1;
        } else {
            RemoveErrorCls('PartCode');
        }


            if ($('#SaleBillJobwork').val() == "J") {
                if ($('#BOMInd').prop('selectedIndex') == 0) {
                    AddErrorCls('BOMInd');
                    $.notify('please select BOM Ind...!', "error");
                    Err = 1;
                }
                else {
                    RemoveErrorCls('BOMInd');
                }

                if ($('#ProducedUnprod').prop('selectedIndex') == 0) {
                    AddErrorCls('ProducedUnprod');
                    $.notify('please select Produced Unprod...!', "error");
                    Err = 1;
                }
                else {
                    RemoveErrorCls('ProducedUnprod');
                }

                if ($('#ProducedUnprod').val() == 'Unprod') {
                    if ($("#BOMInd").val() != 'I') {
                        AddErrorCls('BOMInd');
                        $.notify('please select Individual in case of unProd...!', "error");
                        Err = 1;
                    } else {
                        RemoveErrorCls('BOMInd');
                    }
                }

            }

            // if ($('#ItemCode').prop('selectedIndex') == 0) {
            //     AddErrorCls('ItemCode');
            //     $.notify('please select ItemName...!', "error");
            //     Err = 1;
            // }
            // else {
            //     RemoveErrorCls('ItemCode');
            // }
                    let itemCodeValue = "";

        // Detect which mode is active
        if ($("#ItemCode").is("select")) {
            // Select2 or normal dropdown mode
            itemCodeValue = $('#ItemCode').find(':selected').val();
        } else {
            // Autocomplete mode (text inputs)
            itemCodeValue = $('#ItemNameText').val();
        }

        // Validation
        if (!itemCodeValue || itemCodeValue === "0" || itemCodeValue === "-Select-") {
            AddErrorCls('ItemCode');
            $.notify('Please select Item Name...!', "error");
            Err = 1;
        } else {
            RemoveErrorCls('ItemCode');
        }


            if ($('#Rate').val() == 0) {
                AddErrorCls('Rate');
                Err = 1;
            }
            else {
                RemoveErrorCls('Rate');
            }

            // if ($('#HSNNo').val() == 0 || $('#HSNNo').val() == '') {
            //     AddErrorCls('HSNNo');
            //     $.notify('please select HSNNo...!', "error");
            //     Err = 1;
            // }
            // else {
            //     RemoveErrorCls('HSNNo');
            // }

            if ($('#ItemCode').find(':selected').data('stockable') == 'Y') {
                if ($('#Batchno').val() == '0' || $('#Batchno').val() == null) {
                    $.notify('BillQty can not be more then stock  qty ...!', "error");
                    AddErrorCls('Batchno');
                    Err = 1;
                } else {
                    RemoveErrorCls('Batchno');
                }

                if ($('#Uniquebatchno').val() == '0' || $('#Uniquebatchno').val() == null) {
                    $.notify('Unique batchNo is required ...!', "error");
                    AddErrorCls('Uniquebatchno');
                    Err = 1;
                } else {
                    RemoveErrorCls('Uniquebatchno');
                }


                if ($('#Qty').val() == 0) {
                    $.notify('BillQty can not be less then 0...!', "error");
                    AddErrorCls('Qty');
                    Err = 1;
                }
                else {
                    RemoveErrorCls('Qty');
                }
            } else {
                RemoveErrorCls('Batchno');
                RemoveErrorCls('Uniquebatchno');
                RemoveErrorCls('Qty');
            }

            if ($('#SONO').val() != '' && $('#CustOrderNo').val() != '0') {
                if (AllowedToDispatchQtyMoreThenCloseSOPendQty != 'Y') {
                if (parseFloat($('#Qty').val()) > parseFloat($('#SOPendQty').val())) {
                    $.notify('Bill Qty should not more then Pend Qty...!', "error");
                    AddErrorCls('Qty');
                    Err = 1;
                } else {
                    RemoveErrorCls('Qty');
                }

                }
            }

            var rowCount = $('#divSaleBillList tr').length;
            for (var i = 0; i <= rowCount; i++) {
                if ($('#GridIC-' + i).val() == $('#ItemCode').val()) {
                    if (parseFloat($('#saleBillRow-' + i).find('td.DiscPer').text()) != parseFloat($('#DiscountPer').val())) {
                        $.notify('Disc Per should same with Grid Disc Per...!', "error");
                        AddErrorCls('DiscountPer');
                        Err = 1;
                    }

                    if (parseFloat($('#saleBillRow-' + i).find('td.rate').text()) != parseFloat($('#Rate').val())) {
                        $.notify('Rate should same with Grid Rate...!', "error");
                        AddErrorCls('Rate');
                        Err = 1;
                    }
                }
            }

            Err == 1 ? ShowErrorFld('H_Panel2') : HideErrorFld('H_Panel2');
            if (Err == 1) return false;

            return true;
        }

        $('#ProducedUnprod').change(function () {
            if ($('#ProducedUnprod').val() == 'Unprod') {
                $("#BOMInd").val('I');
                $('#BOMInd option[value="B"]').prop('disabled', true);
                if ($('#SaleBillJobwork').val() == "J") {
                    JWItemList($('#TypeItemServAssets').val());
                }
            } else {
                $('#BOMInd option[value="B"]').prop('disabled', false);
            }
        });

        function CalculateAmountForMemoryGrid(i) {

            var Amount = 0;

            const UnitRate = $('#UnitRate').val();
            const Rate = $('#Rate-' + i).val() === "0" || $('#Rate-' + i).val() === "" ? 0 : parseFloat($('#Rate-' + i).val());
            const DP = $('#DiscountPer-' + i) === "0" || $('#DiscountPer-' + i).val() === "" ? 0 : parseFloat($('#DiscountPer-' + i).val());


            const Qty = $('#Qty-' + i).val() == "0" || $('#Qty-' + i).val() == "" ? 0 : parseFloat($('#Qty-' + i).val());
            Amount = Qty * Rate;


            if (DP !== 0) {
                const DA = ((Amount * DP) / 100);
                $('#DiscountAmt-' + i).val(DA);
                Amount = Amount - DA;
            }

            $('#Amount-' + i).val(Amount.toFixed(2));



        }

        function CalculateAmountForPendSOGrid(i) {

            var Amount = 0;

            const UnitRate = $('#UnitRate').val();
            const Rate = $('#SOItemRate' + i).val() === "0" || $('#SOItemRate' + i).val() === "" ? 0 : parseFloat($('#SOItemRate' + i).val());
            const DP = $('#DisPer' + i) === "0" || $('#DisPer' + i).val() === "" ? 0 : parseFloat($('#DisPer' + i).val());


            const Qty = $('#SaleBillQty' + i).val() == "0" || $('#SaleBillQty' + i).val() == "" ? 0 : parseFloat($('#SaleBillQty' + i).val());
            Amount = Qty * Rate;


            if (DP !== 0) {
                const DA = ((Amount * DP) / 100);
                $('#DisAmt' + i).val(DA);
                Amount = Amount - DA;
            }

            $('#ItemAmount' + i).val(Amount.toFixed(2));



        }

        function CalculateRateForMalti(i) {

            var Amount = 0;
            const OC = $('#SOType').val();
            const UnitRate = $('#UnitRate').val();
            const Rate = $('#Rate-' + i).val() === "0" || $('#Rate-' + i).val() === "" ? 0 : parseFloat($('#Rate-' + i).val());
            const DP = $('#DiscountPer-' + i) === "0" || $('#DiscountPer-' + i).val() === "" ? 0 : parseFloat($('#DiscountPer-' + i).val());


            const Qty = $('#Qty-' + i).val() == "0" || $('#Qty-' + i).val() == "" ? 0 : parseFloat($('#Qty-' + i).val());
            Amount = Qty * Rate;


            if (DP !== 0) {
                const DA = ((Amount * DP) / 100);
                $('#DiscountAmt-' + i).val(DA);
                Amount = Amount - DA;
            }

            $('#Amount-' + i).val(Amount.toFixed(2));

            // $('#Amount').val(Amount.toFixed(2));

        }

        function FillSOPendQty() {
            $.ajax({
                type: "POST",
                url: "@Url.Action("FillSOPendQty")",
                data: { "saleBillEntryId": $('#SaleBillEntryId').val(), "saleBillNo": $('#SaleBillNo').val(), "saleBillYearCode": $('#SaleBillYearCode').val(), "sono": $('#SONO').val(), "soYearcode": $('#SOYearCode').val(), "custOrderNo": $('#CustOrderNo').val(), "itemCode": $('#ItemCode').val(), "accountCode": $('#AccountCode').val(), "schNo": $('#SchNo').val(), "schYearCode": $('#SaleSchYearCode').val() },
                dataType: "json",
                async: false,
                success: function (result, status, error) {
                    if (result != null) {
                        var obj = $.parseJSON(result);
                        if (obj.Result != null) {

                            $('#SOPendQty').val("");
                            $('#SOPendQty').val(obj.Result[0].PendQty);
                            $('#Qty').val("");
                            $('#Qty').val(obj.Result[0].PendQty);

                            $('#SOPendQty').prop("readonly", true);
                            $('#Rate').val("");
                            $('#Rate').val(obj.Result[0].Rate);
                            // $('#Rate').prop("readonly", true);
                            $('#Unit,#AltUnit').val("");
                            $('#Unit').val(obj.Result[0].Unit);
                            $('#Unit').prop("readonly", true);
                            $('#AltUnit').val(obj.Result[0].AltUnit);
                            $('#AltUnit').prop("readonly", true);
                            $('#MRP').val("");
                            $('#MRP').val(obj.Result[0].Rate);
                            $('#OriginalMRP').val("");
                            $('#OriginalMRP').val(obj.Result[0].Rate);
                            $('#RateInOtherCurr').val("");
                            $('#RateInOtherCurr').val((obj.Result[0].Rate).toFixed(4));

                            ResetPendQty();
                        }
                    }
                }
            });
        }

        function removeChargeFromNetTotal(chargeId) {
            let currentNet = parseFloat($('#NetTotal').val()) || 0;
            let chargeValue = parseFloat($(chargeId).val()) || 0;

            // Subtract the charge from NetTotal
            let newNet = currentNet - chargeValue;
            if (newNet < 0) newNet = 0; // safety check

            $('#NetTotal').val(newNet.toFixed(2));
        }

        function addPackingExpenceInNetAmount() {
            //  var PackingCharges = safeParse('#PackingCharges');
            // var ForwardingCharges = safeParse('#ForwardingCharges');
            // var CourieerCharges = safeParse('#CourieerCharges');
            // var GST = safeParse('#GST');

            // $('TxType').val('EXPENSES');
            $("#divTaxGrid  tr").each(function () {
                let cellText = $(this).find(".txGridName").text().trim();
                if (cellText === "PackingCharges") {
                    $(this).remove();
                    recalcNetTotal();
                }
            });

            $.ajax({
                url: '/SaleInvoice/RemovePackingChargesTax', // <-- create this action in your controller
                type: 'POST',
                data: { taxName: "PackingCharges" },
                success: function (res) {
                    console.log("PackingCharges removed from session");
                    GetDbCrDetail();
                    ClearAdjustmentGrid();
                    AddAdjstmntDetail1();
                },
                error: function (err) {
                    console.error("Error removing from session", err);
                }
            });

            $('#TxType').val('EXPENSES').trigger('change');
            $("#TxTaxType option").filter(function () {
                return $(this).text() === "Other";
            }).prop("selected", true).trigger("change");
            $("#TxAccountCode option").filter(function () {
                return $(this).text() === "PackingCharges";
            }).prop("selected", true).trigger("change");
            $('#TxRoundOff').val('N').trigger('change');
            let packingCharges = parseFloat($('#PackingCharges').val()) || 0;
            $('#TxAmount').val(packingCharges.toFixed(2)).trigger('change');

            if (packingCharges > 0) {
                $('.btnAddTax2Grid').trigger('click');
            }




        }

        function addForwardingChargesInNetAmount() {
            //  var PackingCharges = safeParse('#PackingCharges');
            // var ForwardingCharges = safeParse('#ForwardingCharges');
            // var CourieerCharges = safeParse('#CourieerCharges');
            // var GST = safeParse('#GST');

            // $('TxType').val('EXPENSES');
            $("#divTaxGrid  tr").each(function () {
                let cellText = $(this).find(".txGridName").text().trim();
                if (cellText === "ForwardingCharges") {
                    $(this).remove();
                    recalcNetTotal();
                }
            });

            $.ajax({
                url: '/SaleInvoice/RemovePForwardingChargesTax', // <-- create this action in your controller
                type: 'POST',
                data: { taxName: "ForwardingCharges" },
                success: function (res) {
                    console.log("PackingCharges removed from session");
                    GetDbCrDetail();
                    ClearAdjustmentGrid();
                    AddAdjstmntDetail1();
                },
                error: function (err) {
                    console.error("Error removing from session", err);
                }
            });

            $('#TxType').val('EXPENSES').trigger('change');
            $("#TxTaxType option").filter(function () {
                return $(this).text() === "Other";
            }).prop("selected", true).trigger("change");
            $("#TxAccountCode option").filter(function () {
                return $(this).text() === "ForwardingCharges";
            }).prop("selected", true).trigger("change");
            $('#TxRoundOff').val('N').trigger('change');
            let ForwardingCharges = parseFloat($('#ForwardingCharges').val()) || 0;
            $('#TxAmount').val(ForwardingCharges.toFixed(2)).trigger('change');

            if (ForwardingCharges > 0) {
                $('.btnAddTax2Grid').trigger('click');
            }




        }


        function addCourieerChargesInNetAmount() {
            //  var PackingCharges = safeParse('#PackingCharges');
            // var ForwardingCharges = safeParse('#ForwardingCharges');
            // var CourieerCharges = safeParse('#CourieerCharges');
            // var GST = safeParse('#GST');

            // $('TxType').val('EXPENSES');
            $("#divTaxGrid  tr").each(function () {
                let cellText = $(this).find(".txGridName").text().trim();
                if (cellText === "CourieerCharges") {
                    $(this).remove();
                    recalcNetTotal();
                }
            });

            $.ajax({
                url: '/SaleInvoice/RemoveCourieerChargesTax', // <-- create this action in your controller
                type: 'POST',
                data: { taxName: "CourieerCharges" },
                success: function (res) {
                    console.log("PackingCharges removed from session");
                    GetDbCrDetail();
                    ClearAdjustmentGrid();
                    AddAdjstmntDetail1();
                },
                error: function (err) {
                    console.error("Error removing from session", err);
                }
            });

            $('#TxType').val('EXPENSES').trigger('change');
            $("#TxTaxType option").filter(function () {
                return $(this).text() === "Other";
            }).prop("selected", true).trigger("change");
            $("#TxAccountCode option").filter(function () {
                return $(this).text() === "CourieerCharges";
            }).prop("selected", true).trigger("change");
            $('#TxRoundOff').val('N').trigger('change');
            let CourieerCharges = parseFloat($('#CourieerCharges').val()) || 0;
            $('#TxAmount').val(CourieerCharges.toFixed(2)).trigger('change');

            if (CourieerCharges > 0) {
                $('.btnAddTax2Grid').trigger('click');
            }




        }

        function addGSTInNetAmount() {
            //  var PackingCharges = safeParse('#PackingCharges');
            // var ForwardingCharges = safeParse('#ForwardingCharges');
            // var CourieerCharges = safeParse('#CourieerCharges');
            // var GST = safeParse('#GST');

            // $('TxType').val('EXPENSES');
            $("#divTaxGrid  tr").each(function () {
                let cellText = $(this).find(".txGridName").text().trim();
                if (cellText === "GST") {
                    $(this).remove();
                    recalcNetTotal();
                }
            });

            $.ajax({
                url: '/SaleInvoice/RemoveGSTTax', // <-- create this action in your controller
                type: 'POST',
                data: { taxName: "GST" },
                success: function (res) {
                    console.log("PackingCharges removed from session");
                    ClearAdjustmentGrid();
                    GetDbCrDetail();
                    AddAdjstmntDetail1();
                },
                error: function (err) {
                    console.error("Error removing from session", err);
                }
            });

            $('#TxType').val('EXPENSES').trigger('change');
            $("#TxTaxType option").filter(function () {
                return $(this).text() === "Other";
            }).prop("selected", true).trigger("change");
            $("#TxAccountCode option").filter(function () {
                return $(this).text() === "GST";
            }).prop("selected", true).trigger("change");
            $('#TxRoundOff').val('N').trigger('change');
            let GST = parseFloat($('#GST').val()) || 0;
            $('#TxAmount').val(GST.toFixed(2)).trigger('change');

            if (GST > 0) {
                $('.btnAddTax2Grid').trigger('click');
            }




        }
        function recalcNetTotal() {
            let baseTotal = parseFloat($('#lblItemNetAmount').text()) || 0;
            let packing = parseFloat($('#PackingCharges').val()) || 0;
            let forwarding = parseFloat($('#ForwardingCharges').val()) || 0;
            let courier = parseFloat($('#CourieerCharges').val()) || 0;
            let gst = parseFloat($('#GST').val()) || 0;
            let CashDisRs = parseFloat($('#CashDisRs').val()) || 0;
            let AdditionalDiscount = parseFloat($('#AdditionalDiscount').val()) || 0;

            let net = baseTotal + packing + forwarding + courier + gst - CashDisRs - AdditionalDiscount;

            $('#NetTotal').val(net.toFixed(2));
            $('#NetTotal1').html(net.toFixed(2));
        }

        function NetAmountAfterDiscount() {
            function safeParse(selector) {
                var val = $.trim($(selector).val());
                var num = parseFloat(val);
                return isNaN(num) ? 0 : num;
            }

            // Always start from original clean net total
            var baseAmt = parseFloat($('#lblItemNetAmount').text()) || 0;;

            var discAmt = safeParse('#CashDisRs');
            var additionalDisAmt = safeParse('#AdditionalDiscount');
            var PackingCharges = safeParse('#PackingCharges');
            var ForwardingCharges = safeParse('#ForwardingCharges');
            var CourieerCharges = safeParse('#CourieerCharges');
            var GST = safeParse('#GST');

            // Apply adjustments
            var netAmt = baseAmt - (discAmt + additionalDisAmt)
                + PackingCharges + ForwardingCharges + CourieerCharges + GST;

            $('#NetTotal').val(netAmt.toFixed(2));
            $('#NetTotal1').html(netAmt.toFixed(2));
            $('#AdjPendAmt').val(netAmt.toFixed(2));

            // GetDbCrDetail();

            ClearAdjustmentGrid();
            AddAdjstmntDetail1();
        }



        $('.GridMultiItemBtn').click(function (e) {
            e.preventDefault();
            var CheckboxArr = [];
            var RowCount = $('#MultiItemBody tr').length;

            for (var i = 1; i <= RowCount; i++) {
                if ($('#MBCheckbox-' + i).prop("checked")) {
                    CheckboxArr.push(i);
                }
            }

            if (CheckboxArr.length === 0) {
                $.notify('Please select any item.', 'error');
            } else {


                var RowCount = $('#MultiItemBody tr').length;
                for (var i = 1; i <= RowCount; i++) {
                    if ($('#MBCheckbox-' + i).prop("checked")) {
                        if ($('#Qty-' + i).val() == 0) {
                            $.notify('Please enter quantity for ' + $('#PartCode-' + i).val(), 'error');
                            return;
                        }
                        // if (parseFloat($('#Qty-' + i).val()) > parseFloat($('#LotStock-' + i).val())) {
                        //     $.notify('Please enter Valid quantity for ' + $('#PartCode-' + i).val(), 'error');
                        //     return;
                        // }
                        if ($('#Rate-' + i).val() == 0) {
                            $.notify('Please enter rate for ' + $('#PartCode-' + i).val(), 'error');
                            return;
                        }
                        if ($('#Unit-' + i).val() == '') {
                            $.notify('Please select unit for ' + $('#PartCode-' + i).val(), 'error');
                            return;
                        }
                        if ($('#HSNNo-' + i).val() == '') {
                            $.notify('Please enter HSN for ' + $('#PartCode-' + i).val(), 'error');
                            return;
                        }
                        if ($('#Amount-' + i).val() == '') {
                            $.notify('amount can not be 0 ' + $('#PartCode-' + i).val(), 'error');
                            return;
                        }




                    }
                }
                var ArrMultiBatch = [];
                for (var i = 1; i <= RowCount; i++) {
                    if ($('#MBCheckbox-' + i).prop("checked")) {

                        ArrMultiBatch.push({
                            "SONO": parseInt($('#SONO').val()),
                            "SOYearCode": $('#SOYearCode').val(),
                            "SODate": $('#SODate').val(),
                            "CustOrderNo": $('#CustOrderNo').val(),
                            "Group_Code": $('#Group_Code1').val(),
                            "Group_name": $('#Group_Code1 option:selected').text(),
                            "PartCode": $('#PartCode-' + i).val(),
                            "ItemCode": $('#ItemCode-' + i).val(),
                            "ItemName": $('#ItemName-' + i).val(),
                            "SchNo": $('#SchNo').val(),
                            "SaleSchYearCode": $('#SaleSchYearCode').val(),
                            "Schdate": $('#Schdate').val(),
                            "StoreId": $('#MultiStoreName').val(),
                            "StoreName": $('#MultiStoreName').find(':selected').text() == '-Select-' ? "" : $('#MultiStoreName').find(':selected').text(),
                            "HSNNo": $('#HSNNo-' + i).val(),
                            "Unit": $('#Unit-' + i).val(),

                            "Batchno": $('#Batchno-' + i).val(),
                            "Uniquebatchno": $('#Uniquebatchno-' + i).val(),
                            "LotStock": $('#LotStock-' + i).val(),
                            "TotalStock": $('#TotalStock-' + i).val(),
                            "SOPendQty": $('#SOPendQty').val(),
                            "Qty": $('#Qty-' + i).val(),
                            "Rate": $('#Rate-' + i).val(),
                            "NoofPcs": $('#NoofPcs').val(),
                            "reasonOfAdjustment": $('#reasonOfAdjustment').val(),
                            "DiscountPer": $('#DiscountPer-' + i).val(),
                            "DiscountAmt": $('#DiscountAmt-' + i).val(),
                            "Amount": $('#Amount-' + i).val(),
                            "PacketsDetail": $('#PacketsDetail').val(),
                            "OtherDetail": $('#OtherDetail').val(),
                            "ItemRemark": $('#ItemRemark').val(),
                            "Itemcolor": $('#Itemcolor').val(),
                            "ProcessId": $('#ProcessId').val(),
                            "GSTPer": $('#GSTPer').val(),
                            "GSTType": $('#GSTType').val(),
                            "ItemSize": $('#ItemSize').val(),
                            "UnitOfRate": $('#UnitOfRate').val(),
                            "OriginalMRP": $('#OriginalMRP').val(),
                            "MRP": $('#MRP').val(),
                            "AdviseEntryId": $('#AdviseEntryId').val(),
                            "AltSOPendQty": $('#AltSOPendQty').val(),
                            "AdviceNo": $('#AdviceNo').val(),
                            "AdviceYearCode": $('#AdviceYearCode').val(),
                            "AdviseDate": $('#AdviseDate').val(),
                            "ProdSchno": $('#ProdSchno').val(),
                            "AdviseDate": $('#AdviseDate').val(),
                            "AgainstProdPlanNo": $('#AgainstProdPlanNo').val(),
                            "AgaisntProdPlanDate": $('#AgaisntProdPlanDate').val(),
                            "SOAmendNo": $('#SOAmendNo').val(),
                            "SOAmendDate": $('#SOAmendDate').val(),
                            "ProdSchYearcode": $('#ProdSchYearcode').val(),
                            "ProdSchEntryId": $('#ProdSchEntryId').val(),
                            "ProdSchDate": $('#ProdSchDate').val(),
                            "CustomerPartCode": $('#CustomerPartCode').val(),
                            "SchdeliveryDate": $('#SchdeliveryDate').val(),
                            "BOMInd": $('#BOMInd').val(),
                            "BomRevNo": $('#BomRevNo').val(),
                            "ProducedUnprod": $('#ProducedUnprod').val(),
                            // "SeqNo": parseInt($('#SeqNo').val()) == 0 ? (highestValue + 1) : parseInt($('#SeqNo').val()),
                            "CustJwAdjustmentMandatory": $('#CustJwAdjustmentMandatory').val(),
                            "StockableNonStockable": $('#ItemCode').find(':selected').data('stockable'),
                            "VendJwAdjustmentMandatory": $('#VendJwAdjustmentMandatory').val()
                        });
                    }
                }

                $.ajax({
                    type: "POST",
                    url: '@Url.Action("AddMultipleItemDetail")',
                    data: { "model": ArrMultiBatch },
                    statusCode: {
                        207: function () {
                            $.notify('Duplicate Item...!', "info");
                        }
                    },
                    success: function (result, status, xhr) {
                        if (xhr.status == 200 && xhr.responseText == result) {
                           
                            $('#divSaleBillList').html(result);

                            if ($('#SaleBillJobwork').val() == 'J') {
                                $('.jobWorkChalln').show();
                                $('.gridHiddenField').show();
                            } else {
                                $('.jobWorkChalln').hide();
                                $('.gridHiddenField').hide();
                            }
                            $('#SaleOrderGroupWiseItem').modal('hide');
                            BasicTotal();
                            ClearAdjustmentGrid();
                           
                            // ResetPendQty();
                            // FillSOPendQty();

                            $('#ItemNetAmount').val(sum);

                            // $('#lblItemNetAmount').text(sum.toFixed(2));

                            var txSum = 0;
                            if ($('#divTaxGrid tr td').length > 1) {
                                for (var i = 1; i <= taxRowCount; i++) {
                                    txSum += parseFloat($('#txGridAmount-' + i).text() == '.00' ? 0 : $('#txGridAmount-' + i).text());
                                }
                            }

                            var txTotal = sum + txSum;
                            $('#NetTotal').val(txTotal.toFixed(6));
                            $('#BaseNetTotal').val(txTotal.toFixed(6));
                            $('#AdjPendAmt').val($('#NetTotal').val());
                            $('#NetTotal1').html($('#NetTotal').val());
                            $('#TotalDiscountPercentage').val(0);
                            $('#TotalAmtAftrDiscount').val(0);



                        }
                    },
                    error: function (result, status, xhr) {
                        $.notify('Something Went Wrong, Please Try Again.', "error");
                    }
                }).done(function () {
                    GetFeatureOption();
                    GetTaxPartItem();
                    GetDbCrDetail();
                    AddAdjstmntDetail1();
                });
            }
        });
        var sum = 0;
        var itemBatchArray = [];
        $('.ItemBtn').click(function (e) {

            e.preventDefault();
            EditEachItem = false;
            var seqnoarray = [];

            var rowsCounting = parseInt($('#divSaleBillList tr').length);
            $('#divSaleBillList tr').each(function (index, element) {
                var currentRow = $(element);
                var seqnoText = currentRow.find('input[id^=SeqNo]').val();
                if (seqnoText != undefined) {
                    seqnoarray.push(parseInt(seqnoText));
                }
            });



            var highestValue = 0;
            if (seqnoarray.length == 0) {
                highestValue = 0;
            }
            else {
                highestValue = Math.max(...seqnoarray);
            }

            EditEachItem = false;
            if (!ValidateGrid()) return;

            var itemCodee = parseInt($('#ItemCode').val());
            var batchNoo = $('#Batchno').val();
            var uniquebatchnoo = $('#Uniquebatchno').val();
            var sono = parseInt($('#SONO').val());
            let partCodeVal = "";
            let itemCodeVal = "";
            let itemNameVal = "";

            if ($("#PartCode").is("select")) {
                let selectedPartText = $('#PartCode').find(':selected').text();
              var   partCodeValue = (selectedPartText === "-Select-") ? "" : selectedPartText;
                  let parts = partCodeValue.split('-->');
                  partCodeVal = parts[0].trim();
            } else {

                let partCodeTextVal = $("#PartCodeText").val()?.trim() || "";
                        let partDescVal = "";
                        if (partCodeTextVal.includes("-->")) {
                            const parts = partCodeTextVal.split("-->");
                              partCodeVal = parts[0].trim();
                            partDescVal = parts[1]?.trim() || "";
                        } else {
                            partCodeVal = partCodeTextVal; // fallback if no separator
                        }
            }

            if ($("#ItemCode").is("select")) {
                itemCodeVal = $('#ItemCode').val() || "";
                let selectedItemText = $('#ItemCode').find(':selected').text();
                itemNameVal = (selectedItemText === "-Select-") ? "" : selectedItemText;
            } else {
                itemCodeVal = $("#ItemCode").val() || "";
                itemNameVal = $("#ItemNameText").val() || "";
            }

            var SchData = {
                "SONO": parseInt($('#SONO').val()),
                "SOYearCode": $('#SOYearCode').val(),
                "SODate": $('#SODate').val(),
                "CustOrderNo": $('#CustOrderNo').val(),
                "Group_Code": $('#Group_Code').val(),
                "Group_name": $('#Group_Code option:selected').text(),
                // "PartCode": $('#PartCode').find(':selected').text() == "-Select-" ? "" : $('#PartCode').find(':selected').text(),
                // "ItemCode": $('#ItemCode').val(),
                // "ItemName": $('#ItemCode').find(':selected').text() == '-Select-' ? "" : $('#ItemCode').find(':selected').text(),
                    "PartCode": partCodeVal,
                "ItemCode": itemCodeVal,
                "ItemName": itemNameVal,
                "SchNo": $('#SchNo').val(),
                "SaleSchYearCode": $('#SaleSchYearCode').val(),
                "Schdate": $('#Schdate').val(),
                "StoreId": $('#StoreId').val(),
                "StoreName": $('#Storeid').find(':selected').text() == '-Select-' ? "" : $('#StoreId').find(':selected').text(),
                "HSNNo": $('#HSNNo').val(),
                "Unit": $('#Unit').val(),

                "Batchno": $('#Batchno').find(':selected').text().trim(),
                "Uniquebatchno": $('#Uniquebatchno').find(':selected').text().trim(),
                "LotStock": $('#LotStock').val(),
                "TotalStock": $('#TotalStock').val(),
                "SOPendQty": $('#SOPendQty').val(),
                "Qty": $('#Qty').val(),
                "Rate": $('#Rate').val(),
                "NoofPcs": $('#NoofPcs').val(),
                "reasonOfAdjustment": $('#reasonOfAdjustment').val(),
                "DiscountPer": $('#DiscountPer').val(),
                "DiscountAmt": $('#DiscountAmt').val(),
                "Amount": $('#Amount').val(),
                "PacketsDetail": $('#PacketsDetail').val(),
                "OtherDetail": $('#OtherDetail').val(),
                "ItemRemark": $('#ItemRemark').val(),
                "Itemcolor": $('#Itemcolor').val(),
                "ProcessId": $('#ProcessId').val(),
                "GSTPer": $('#GSTPer').val(),
                "GSTType": $('#GSTType').val(),
                "ItemSize": $('#ItemSize').val(),
                "UnitOfRate": $('#UnitOfRate').val(),
                "OriginalMRP": $('#OriginalMRP').val(),
                "MRP": $('#MRP').val(),
                "AdviseEntryId": $('#AdviseEntryId').val(),
                "AltSOPendQty": $('#AltSOPendQty').val(),
                "AdviceNo": $('#AdviceNo').val(),
                "AdviceYearCode": $('#AdviceYearCode').val(),
                "AdviseDate": $('#AdviseDate').val(),
                "ProdSchno": $('#ProdSchno').val(),
                "AdviseDate": $('#AdviseDate').val(),
                "AgainstProdPlanNo": $('#AgainstProdPlanNo').val(),
                "AgaisntProdPlanDate": $('#AgaisntProdPlanDate').val(),
                "SOAmendNo": $('#SOAmendNo').val(),
                "SOAmendDate": $('#SOAmendDate').val(),
                "ProdSchYearcode": $('#ProdSchYearcode').val(),
                "ProdSchEntryId": $('#ProdSchEntryId').val(),
                "ProdSchDate": $('#ProdSchDate').val(),
                "CustomerPartCode": $('#CustomerPartCode').val(),
                "SchdeliveryDate": $('#SchdeliveryDate').val(),
                "BOMInd": $('#BOMInd').val(),
                "BomRevNo": $('#BomRevNo').val(),
                "ProducedUnprod": $('#ProducedUnprod').val(),
                "SeqNo": parseInt($('#SeqNo').val()) == 0 ? (highestValue + 1) : parseInt($('#SeqNo').val()),
                "CustJwAdjustmentMandatory": $('#CustJwAdjustmentMandatory').val(),
                "StockableNonStockable": $('#ItemCode').find(':selected').data('stockable'),
                "VendJwAdjustmentMandatory": $('#VendJwAdjustmentMandatory').val()
            }



            $.ajax({
                type: "POST",
                url: '@Url.Action("AddSaleBillDetail")',
                data: SchData,
                statusCode: {
                    207: function () {
                        $.notify('Duplicate Item...!', "info");
                    }
                },
                success: function (result, status, xhr) {
                    if (xhr.status == 200 && xhr.responseText == result) {

                        $('#divSaleBillList').html(result);
                        var rowCount = $('#divSaleBillList tr').length;

                        if ($('#SaleBillJobwork').val() == 'J') {
                            $('.jobWorkChalln').show();
                            $('.gridHiddenField').show();

                        } else {
                            $('.jobWorkChalln').hide();
                            $('.gridHiddenField').hide();
                        }
                        //$('#PartCode,#ItemCode').val(0).trigger("change");

                        $('#Uniquebatchno,#Batchno,#Qty,#SOPendQty').val(0);
                                      $('#PartCodeText,#ItemNameText').val("");
                        // $('#StoreId').val(0);
                        // $('#LotStock,#TotalStock').val("");

                        // $('#BOMInd,#ProducedUnprod').val('');
                        //$('#HSNNo').val("");
                        //$('#Unit,#AltUnit').val("");
                        // $('#TotalStock,#LotStock,#AltQty,#ActualStockQty,#AdjQty,#Amount').val(0);

                        //$('#Storeid,#Wcid').prop("disabled", false);

                        // if ($('#DiscountPer').val() != 0 && $('#DiscountPer').val() != '0' && $('#DiscountPer').val() != '') {
                        //     $('#DiscountPer').prop("readonly", "true");
                        // }

                        if ($('#DiscountAmt').val() != 0 && $('#DiscountAmt').val() != '0' && $('#DiscountAmt').val() != '') {
                            $('#DiscountAmt').prop("readonly", "true");
                        }

                        $('#SONO').focus();

                        BasicTotal();
                        ClearAdjustmentGrid();
                        // ResetPendQty();
                        FillSOPendQty();
                        calculatetotalqty();
                        // var rowCount = $('#divSaleBillList tr').length;

                        // for (var i = 1; i <= rowCount; i++) {

                        //     sum += parseFloat($('#GridAmount-' + i).text() == '.00' ? 0 : $('#GridAmount-' + i).text());
                        // }
                        $('#ItemNetAmount').val(sum);

                        // $('#lblItemNetAmount').text(sum.toFixed(2));

                        var txSum = 0;
                        if ($('#divTaxGrid tr td').length > 1) {
                            for (var i = 1; i <= taxRowCount; i++) {
                                txSum += parseFloat($('#txGridAmount-' + i).text() == '.00' ? 0 : $('#txGridAmount-' + i).text());
                            }
                        }

                        var txTotal = sum + txSum;
                        $('#NetTotal').val(txTotal.toFixed(2));
                        $('#BaseNetTotal').val(txTotal.toFixed(2));

                        $('#AdjPendAmt').val($('#NetTotal').val());
                        $('#NetTotal1').html($('#NetTotal').val());
                        $('#TotalDiscountPercentage').val(0);
                        $('#TotalAmtAftrDiscount').val(0);

                        var Seqno = $('#SeqNo-' + rowCount).val();
                        itemBatchArray.push({
                            "SeqNo": parseInt(Seqno),
                            "itemcode": itemCodee,
                            "batchno": batchNoo,
                            "uniquebatchno": uniquebatchnoo,
                            "sono": sono
                        });

                        if ($('#SaleBillJobwork').val() == "J") {
                            for (var i = 1; i <= rowCount; i++) {
                                if ($('#gridBomInd-' + i).text() == 'Bom') {
                                    $('#saleBillRow-' + i).css("background-color", "#f1fab9");
                                } else {
                                    $('#saleBillRow-' + i).css("background-color", "#fab9e1");
                                }
                            }

                            $('.gridHiddenField').show();
                        } else {
                            $('.gridHiddenField').hide();
                        }

                        $('#Rate').val(parseFloat($('#Rate').val()).toFixed(2));

                        FillCurrentBatchINStore();

                    }

                },
                error: function (result, status, xhr) {
                    $.notify('Something Went Wrong, Please Try Again.', "error");
                }
            }).done(function () {

                //alert('inside ajax');
                GetFeatureOption();
                GetTaxPartItem();
                GetDbCrDetail();
                AddAdjstmntDetail1();
            }).fail(function () {
                alert("error");
            }).always(function () {
            });
        });

        function GetBatchInventory() {
            $.ajax({
                type: "POST",
                url: "@Url.Action("GetBatchInventory")",
                dataType: "json",
                success: function (result, status, error) {

                    if (result != null) {
                        var obj = $.parseJSON(result);

                        //$('#EntryId').val(obj.Result[0].EntryId);
                        if (obj.Result.Table[0].AllowBAtchEditable == 'Y') {
                            $("#Batchno option:not(:eq(1))").prop("disabled", true);
                            $('#Batchno').css('background-color', 'rgb(248 255 178)');
                        }
                    }
                }
            });
        }

        $('.btnClearTax').click(function () {
            btnClearTax();
        });

        function btnClearTax() {
            $.ajax({
                type: "POST",
                url: "@Url.Action("ClearTaxGrid", "PurchaseOrder")",
                data: { YearCode: $('#YearCode').val() },
                dataType: "json",
                success: function (result, status, error) {

                    $('#divTaxGrid').empty();
                    var NoData = '<tr class="text-center"><td colspan="32" class="text-black-50"><strong>NO DATA ADDED</strong></td></tr>';
                    $('#divTaxGrid').html(NoData);
                    var txAmt = $('#lblItemNetAmount').text();
                    $('#NetTotal').val(txAmt);
                    $('#BaseNetTotal').val(txAmt);
                    $('#AdjPendAmt').val($('#NetTotal').val());
                    $('#NetTotal1').html($('#NetTotal').val());
                    // $('#AdjNewRefNo').val($('#NetTotal').val());

                },
                error: function (req, status, error) {
                    alert(error);
                }
            });
        }

        function ClearSpecificItemTax(ItemCode) {

        }

        function ClearGrid() {
            var itemGridArr = [];
            var rowCount = $('#divSaleBillList tr').length;
            for (var j = 1; j <= rowCount; j++) {

                var iC = $('#GridIC-' + j).val();
                var batchNo = $('#GridBatchNo-' + j).text();

                itemGridArr.push({
                    IC: iC,
                    BatchNo: batchNo
                });
            }

            $.ajax({
                type: "POST",
                url: "@Url.Action("ClearGrid")",
                success: function (result, status, error) {

                    for (var j = 1; j <= itemGridArr.length; j++) {

                        var IC = itemGridArr[j - 1].IC;
                        var BatchNo = itemGridArr[j - 1].BatchNo;

                        var itemArrayLength = itemBatchArray.length;

                        for (var i = 0; i < itemArrayLength; i++) {
                            if (itemBatchArray[i].itemcode == IC && itemBatchArray[i].batchno == BatchNo) {
                                itemBatchArray.splice(i, 1);
                            }
                        }
                    }

                    $('#divSaleBillList').empty();
                    var NoData = '<tr class="text-center"><td colspan="32" class="text-black-50"><strong>NO DATA ADDED</strong></td></tr>';
                    $('#divSaleBillList').html(NoData);

                    $('#Uniquebatchno,#Batchno,#Qty,#SaleSchYearCode,#SOPendQty,#Qty').val(0);
                    $('#LotStock,#TotalStock').val("");
                    $('#BOMInd,#ProducedUnprod').val('');
                    $('#TotalStock,#LotStock,#AltQty,#ActualStockQty,#AdjQty,#Amount').val(0);

                    BasicTotal();
                    FillSOPendQty();
                },
                error: function (req, status, error) {
                    alert(error);
                }
            });
        }

        function SetPartCodeItemName(ID) {

            if (!ID) return;
            else {
                var v = $('#' + ID).val();
                var t = $('#' + ID + ' option:selected').text();

                if (ID == "PartCode") {
                    v == "" ? $('#ItemCode').val("").trigger("change") : $('#ItemCode').val(v).trigger("change");
                }

                if (ID == "ItemCode") {
                    v == "" ? $('#PartCode').val("").trigger("change") : $('#PartCode').val(v).trigger("change");
                }
            }
        }

        $('#ItemSA').change(function () {
            if ($('#SaleBillJobwork').val() == "S") {
                FillItems($('#TypeItemServAssets').val());
            }
            JWItemList($('#TypeItemServAssets').val());
        });

        $('#BOMInd').change(function () {
            JWItemList($('#TypeItemServAssets').val());
        });

        function JWItemList(itemType) {
            var showAll = $('#ItemSA').prop('checked') ? 'T' : 'F';
            $.ajax({
                type: "POST",
                data: { "typeItemServAssets": itemType, "showAll": showAll, "bomInd": $('#BOMInd').val(), "schNo": $('#SchNo').val(), "schYearCode": $('#SaleSchYearCode').val() },
                url: "@Url.Action("JWItemList")",
                dataType: "json",
                async: false,
                success: function (result, status, error) {

                    if (result != null) {

                        var obj = $.parseJSON(result);
                        $('#PartCode').empty();
                        $('#PartCode').append('<option value="0">-Select-</option>');
                        if (obj.StatusCode != 500) {
                            $.each(obj.Result, function (index, val) {
                                // sonoItems.push({
                                //     itemCode: val.itemcode
                                // });
                                $('#PartCode').append("<option value=" + val.Item_Code + " data-stockable=" + val.Stockable + ">" + val.PartCode + "</option>");
                            });
                        }

                        $('#ItemCode').empty();
                        $('#ItemCode').append('<option value="0">-Select-</option>');
                        if (obj.StatusCode != 500) {
                            $.each(obj.Result, function (index, val) {
                                $('#ItemCode').append("<option value=" + val.Item_Code + " data-stockable=" + val.Stockable + ">" + val.ItemName + "</option>");
                            });
                        }
                    }
                }
            });
        }

        function FillSOWiseItems() {
            var sbJobWork = $('#SaleBillJobwork').val() == 'J' ? "JOBWORK-SALEBILL" : "SaleBill";
            $.ajax({
                type: "POST",
                data: { "invoiceDate": $('#SaleBillDate').val(), "sono": $('#SONO').val(), "soYearCode": $('#SOYearCode').val(), "accountCode": $('#AccountCode').val(), "schNo": $('#SchNo').val(), "schYearCode": $('#SaleSchYearCode').val(), "sbJobWork": sbJobWork },
                url: "@Url.Action("FillSOWiseItems")",
                dataType: "json",
                async: false,
                success: function (result, status, error) {

                    if (result != null) {
                        var obj = $.parseJSON(result);

                        $('#PartCode').empty();
                        $('#PartCode').append('<option value="0">-Select-</option>');
                        if (obj.StatusCode != 500) {
                            $.each(obj.Result, function (index, val) {
                                // sonoItems.push({
                                //     itemCode: val.itemcode
                                // });
                                $('#PartCode').append("<option value=" + val.Item_Code + " data-stockable=" + val.Stockable + ">" + val.PartCode + "</option>");
                            });
                        }

                        $('#ItemCode').empty();
                        $('#ItemCode').append('<option value="0">-Select-</option>');
                        if (obj.StatusCode != 500) {
                            $.each(obj.Result, function (index, val) {
                                $('#ItemCode').append("<option value=" + val.Item_Code + " data-stockable=" + val.Stockable + ">" + val.ItemName + "</option>");
                            });
                        }
                    }
                }
            });
        }
        //         function enableSelect2Mode() {
        //     // Hide autocomplete inputs
        //     $("#PartCodeText, #ItemNameText").hide();

        //     // Create select2 dropdowns dynamically
        //     if (!$("#PartCode").length) {
        //         $("<select id='PartCode' class='form-control'></select>").insertAfter("#PartCodeText");
        //         $("<select id='ItemCode' class='form-control'></select>").insertAfter("#ItemNameText");
        //         $("#PartCode").select2();
        //         $("#ItemCode").select2();
        //     }
          
        // }
             $(document).on('select2:select', '#PartCode,#ItemCode', function (e) {
            const cntId = e.target.id;
            onItemSelected(cntId);
        });
                function enableSelect2Mode() {
            $("#PartCodeText, #ItemNameText").hide();
            if (!$("#PartCode").is("select")) {
                $("#PartCode").remove();
                $("#ItemCode").remove();
                $("<select id='PartCode' class='form-control'></select>").insertAfter("#PartCodeText");
                $("<select id='ItemCode' class='form-control'></select>").insertAfter("#ItemNameText");

                $("#PartCode").select2({
                    placeholder: "Select Part Code",
                    width: "100%"
                }).on("select2:select", function (e) {
                    onItemSelected("PartCode");
                });

                $("#ItemCode").select2({
                    placeholder: "Select Item Name",
                    width: "100%"
                }).on("select2:select", function (e) {
                    onItemSelected("ItemCode");
                });
            }
        }

        function enableAutocompleteMode() {
            if ($("#PartCode").data("select2")) {
                $("#PartCode").select2("destroy");
            }
            if ($("#ItemCode").data("select2")) {
                $("#ItemCode").select2("destroy");
            }
            $("#PartCode, #ItemCode").remove();

            $("<input type='hidden' id='PartCode' name='PartCode' value='0' />").insertAfter("#PartCodeText");
            $("<input type='hidden' id='ItemCode' name='ItemCode' value='0' />").insertAfter("#ItemNameText");

            $("#PartCodeText, #ItemNameText").show();

             // FillItems($('#TypeItemServAssets').val());
            AutoFillItems();
        }

        // function enableAutocompleteMode() {
        //     // Remove select2 if exists
        //     $("#PartCode, #ItemCode").remove();

        //     // Show autocomplete inputs
        //     $("#PartCodeText, #ItemNameText").show();

        //     // Activate autocomplete
        //     FillItems("Item");
        // }
        // var sonoItems = [];

        function AutoFillItems() {
            // Source for PartCodeText
            const partCodeSource = function (request, response) {
                $.ajax({
                    url: '@Url.Action("FillItems", "PurchaseOrder")',
                    type: 'POST',
                    data: {
                        Type: $('#POTypeServItem').val(),
                        ShowAllItem: 'N',
                        SearchItemCode: '',
                        SearchPartCode: request.term
                    },
                    success: function (result) {
                        let obj = typeof result === "string" ? JSON.parse(result) : result;

                        if (obj.StatusCode === 200 && obj.StatusText === 'Success' && Array.isArray(obj.Result.Table)) {
                            let filtered = obj.Result.Table.filter(function (item) {
                                let term = request.term.toLowerCase();
                                return (
                                    (item.PartCode && item.PartCode.toLowerCase().includes(term)) ||
                                    (item.Barcode && item.Barcode.toLowerCase().includes(term)) ||
                                    (item.ItemName && item.ItemName.toLowerCase().includes(term))
                                );
                            });

                            response($.map(filtered, function (item) {
                                return {
                                    label: item.PartCode,
                                    value: item.PartCode,
                                    itemName: item.ItemName,
                                    itemCode: item.Item_Code
                                };
                            }));
                        } else {
                            AddMultipleItems();
                ShowGroupWiseItems();
                            response([]);
                        }
                    }
                });
            };

            // Source for ItemNameText
            const itemNameSource = function (request, response) {
                $.ajax({
                    url: '@Url.Action("FillItems", "PurchaseOrder")',
                    type: 'POST',
                    data: {
                        Type: $('#POTypeServItem').val(),
                        ShowAllItem: 'N',
                        SearchItemCode: request.term,
                        SearchPartCode: ''
                    },
                    success: function (result) {
                        let obj = typeof result === "string" ? JSON.parse(result) : result;

                        if (obj.StatusCode === 200 && obj.StatusText === 'Success' && Array.isArray(obj.Result.Table)) {
                            let filtered = obj.Result.Table.filter(function (item) {
                                let term = request.term.toLowerCase();
                                return item.ItemName.toLowerCase().includes(term);
                            });

                            response($.map(filtered, function (item) {
                                return {
                                    label: item.ItemName,
                                    value: item.Item_Code,
                                    itemName: item.ItemName,
                                    itemCode: item.Item_Code,
                                    partCode: item.PartCode
                                };
                            }));
                        } else {
                                   AddMultipleItems();
                       ShowGroupWiseItems();
                            response([]);
                        }
                    }
                });
            };

            // Autocomplete for PartCodeText
            $("#PartCodeText").autocomplete({
                source: partCodeSource,
                select: function (event, ui) {
                    $("#PartCodeText").val(ui.item.value).data("itemcode", ui.item.itemCode);
                    $("#ItemNameText").val(ui.item.itemName);
                    $('#ItemCode').val(ui.item.itemCode);
                    $('#PartCode').val(ui.item.itemCode);
                    onItemSelected("ItemCode");
                    return false;
                },
                focus: function (event, ui) {
                    $("#PartCodeText").val(ui.item.value);
                    return false;
                },
                minLength: 2
            });

            // 🔹 Focusout event for PartCodeText (manual entry validation)
            $("#PartCodeText").on("focusout", function () {
                let entered = $(this).val().trim().toLowerCase();
                if (entered === "") return;

                $.ajax({
                    url: '@Url.Action("FillItems", "PurchaseOrder")',
                    type: 'POST',
                    data: {
                        Type: $('#POTypeServItem').val(),
                        ShowAllItem: 'N',
                        SearchItemCode: '',
                        SearchPartCode: entered
                    },
                    success: function (result) {
                        let obj = typeof result === "string" ? JSON.parse(result) : result;

                        if (obj.StatusCode === 200 && obj.StatusText === 'Success' && Array.isArray(obj.Result.Table)) {
                            // 🔹 Partial match: includes()
                            let match = obj.Result.Table.find(item => {
                                let real = (item.RealPartCode || "").toLowerCase();
                                let name = (item.Item_Name || "").toLowerCase();
                                let barcode = (item.Barcode || "").toLowerCase();

                                return real.includes(entered) || name.includes(entered) || barcode.includes(entered);
                            });

                            if (match) {
                                $("#PartCodeText").val(match.PartCode).data("itemcode", match.Item_Code);
                                $("#ItemNameText").val(match.Item_Name);
                                $("#ItemCode").val(match.Item_Code);
                                $("#PartCode").val(match.Item_Code);
                                onItemSelected("ItemCode");

                            }
                            else
                            {
                               
                                 $("#PartCodeText").val("").focus();
                                //          AddMultipleItems();
                                //           ShowGroupWiseItems();
                            }
                           
                        }
                      

                    },
                    error: function (xhr, status, error) {
                        console.error("AJAX Error:", error);
                    }
                });
            });

            // Autocomplete for ItemNameText
            $("#ItemNameText").autocomplete({
                source: itemNameSource,
                select: function (event, ui) {
                    $("#ItemNameText").val(ui.item.itemName).data("itemcode", ui.item.itemCode);
                    $("#PartCodeText").val(ui.item.partCode);
                    $('#ItemCode').val(ui.item.itemCode);
                    $('#PartCode').val(ui.item.itemCode);
                    onItemSelected("ItemCode");
                    return false;

                },
                focus: function (event, ui) {
                    $("#ItemNameText").val(ui.item.itemName);
                    return false;
                },
                minLength: 2
            });

            // 🔹 Focusout event for ItemNameText (manual entry validation)
            $("#ItemNameText").on("focusout", function () {
                let itemName = $(this).val().trim();
                if (itemName !== "") {
                    $.ajax({
                        url: '@Url.Action("FillItems", "PurchaseOrder")',
                        type: 'POST',
                        data: {
                            Type: $('#POTypeServItem').val(),
                            ShowAllItem: 'N',
                            SearchItemCode: itemName,
                            SearchPartCode: ''
                        },
                        success: function (result) {
                            let obj = typeof result === "string" ? JSON.parse(result) : result;
                            alert(JSON.stringify(obj.Result));
                            if (obj.StatusCode === 200 && obj.StatusText === 'Success' && Array.isArray(obj.Result.Table)) {

                                let match = obj.Result.Table.find(item => item.ItemName.toLowerCase() === itemName.toLowerCase());

                                if (match) {
                                    $("#ItemNameText").val(match.ItemName).data("itemcode", match.Item_Code);
                                    $("#PartCodeText").val(match.PartCode);
                                    $('#ItemCode').val(match.Item_Code);
                                    $('#PartCode').val(match.Item_Code);
                                    onItemSelected("ItemCode");
                                } else {
                                   // alert("Invalid Item Name entered!");
                                    $("#ItemNameText").val("").focus();
                                    //        AddMultipleItems();
                                    //         ShowGroupWiseItems();
                                }
                            } else {
                              //  alert("Invalid Item Name entered!");
                                $("#ItemNameText").val("").focus();
                                   
          //                      AddMultipleItems();
          // ShowGroupWiseItems();
                        

                            }
                        }
                    });
                }
            });
        }




        function FillItems(itemType) {
            var showAll = $('#ItemSA').prop('checked') ? 'T' : 'F';
                const partCodeSource = function (request, response) {
                $.ajax({
                    url: '@Url.Action("FillItems")',
                    type: 'POST',
                     data: { "showAll": showAll, "TypeItemServAssets": itemType, "sbJobWork": "SaleBill",
                        SearchItemCode: '',
                        SearchPartCode: request.term
                    },
                    success: function (result) {
                        let obj = typeof result === "string" ? JSON.parse(result) : result;

                        if (obj.StatusCode === 200 && obj.StatusText === 'Success' && Array.isArray(obj.Result.Table)) {
                            let filtered = obj.Result.Table.filter(function (item) {
                                let term = request.term.toLowerCase();
                                return item.PartCode.toLowerCase().includes(term);
                            });

                            response($.map(filtered, function (item) {
                                return {
                                    label: item.PartCode ,
                                    value: item.PartCode,
                                    itemName: item.ItemName,
                                    itemCode: item.Item_Code
                                };
                            }));
                        } else {
                            response([]);
                        }
                    }
                });
            };
            // Source for ItemNameText
            const itemNameSource = function (request, response) {
                $.ajax({
                    url: '@Url.Action("FillItems")',
                    type: 'POST',
                    data: { "showAll": showAll, "TypeItemServAssets": itemType, "sbJobWork": "SaleBill",
                        SearchItemCode: request.term,
                        SearchPartCode: ''
                    },
                    success: function (result) {
                        let obj = typeof result === "string" ? JSON.parse(result) : result;

                        if (obj.StatusCode === 200 && obj.StatusText === 'Success' && Array.isArray(obj.Result.Table)) {
                            let filtered = obj.Result.Table.filter(function (item) {
                                let term = request.term.toLowerCase();
                                return item.ItemName.toLowerCase().includes(term);
                            });

                            response($.map(filtered, function (item) {
                                return {
                                    label: item.ItemName ,
                                    value: item.Item_Code,
                                    itemName: item.ItemName,
                                    itemCode: item.Item_Code,
                                    partCode: item.PartCode
                                };
                            }));
                        } else {
                            response([]);
                        }
                    }
                });
            };
            // Autocomplete for PartCodeText
            $("#PartCodeText").autocomplete({
                source: partCodeSource,
                select: function (event, ui) {
                   $("#PartCodeText").val(ui.item.value).data("itemcode", ui.item.itemCode);
                    $("#ItemNameText").val(ui.item.itemName);
                    $('#ItemCode').val(ui.item.itemCode);
                    $('#PartCode').val(ui.item.itemCode);
                   onItemSelected('PartCode');
                    return false;
                },
                focus: function (event, ui) {
                    $("#PartCodeText").val(ui.item.value);
                    return false;
                },
                minLength:2
            });
            // Autocomplete for ItemNameText
            $("#ItemNameText").autocomplete({
                source: itemNameSource,
                select: function (event, ui) {
                    $("#ItemNameText").val(ui.item.itemName).data("itemcode", ui.item.itemCode);
                    $("#PartCodeText").val(ui.item.partCode);
                    $('#ItemCode').val(ui.item.itemCode);
                    $('#PartCode').val(ui.item.itemCode);
                    onItemSelected("ItemCode");
                    return false;
                },
                focus: function (event, ui) {
                    $("#ItemNameText").val(ui.item.itemName);
                    return false;
                },
                minLength:2
            });
          
            }
        // } function FillItems(itemType) {
        //     var showAll = $('#ItemSA').prop('checked') ? 'T' : 'F';
        //     $.ajax({
        //         type: "POST",
        //         data: { "showAll": showAll, "TypeItemServAssets": itemType, "sbJobWork": "SaleBill"
        //        },
        //         url: "@Url.Action("FillItems")",
        //         dataType: "json",
        //         async: false,
        //         success: function (result, status, error) {

        //             if (result != null) {
        //                 var obj = $.parseJSON(result);

        //                 $('#PartCode').empty();
        //                 $('#PartCode').append('<option value="0">-Select-</option>');
        //                 if (obj.StatusCode != 500) {
        //                     $.each(obj.Result, function (index, val) {
        //                         // sonoItems.push({
        //                         //     itemCode: val.itemcode
        //                         // });
        //                         $('#PartCode').append("<option value=" + val.Item_Code + " data-stockable=" + val.Stockable + ">" + val.PartCode + "</option>");
        //                     });
        //                 }

        //                 $('#ItemCode').empty();
        //                 $('#ItemCode').append('<option value="0">-Select-</option>');
        //                 if (obj.StatusCode != 500) {
        //                     $.each(obj.Result, function (index, val) {
        //                         $('#ItemCode').append("<option value=" + val.Item_Code + " data-stockable=" + val.Stockable + ">" + val.ItemName + "</option>");
        //                     });
        //                 }
        //             }
        //         }
        //     });
        // }

        function NewEntryId() {

            var YearCode = parseInt($('#SaleBillYearCode').val());
            var SubInvoicetype = ($('#SubInvoicetype option:selected').text().trim());
            $.ajax({
                type: "POST",
                data: { "YearCode": YearCode, "SubInvoicetype": SubInvoicetype },
                url: "@Url.Action("NewEntryId")",
                dataType: "json",
                success: function (result, status, error) {

                    if (result != null) {
                        var obj = $.parseJSON(result);
                        if (obj.Result != null) {
                            $('#SaleBillEntryId').val(0);
                            $('#SaleBillEntryId').val(obj.Result.Table[0].EntryId);
                            $('#SaleBillNo').val(0);
                            $('#SaleBillNo').val(obj.Result.Table[0].SaleBillNo);

                            $('#AdjDescription').val($('#SaleBillNo').val());
                            $('#AdjNewRefNo').val($('#SaleBillNo').val());

                        }
                    }
                }
            });
        }


        function EditableRateAndDiscountONSaleInvoice() {


            $.ajax({
                type: "POST",

                url: "@Url.Action("EditableRateAndDiscountONSaleInvoice")",
                dataType: "json",
                success: function (result, status, error) {

                    if (result != null) {
                        var obj = $.parseJSON(result);
                        if (obj.Result != null) {
                            $('#EditableRateAndDiscountONSaleInvoice').val('');
                            $('#EditableRateAndDiscountONSaleInvoice').val(obj.Result.Table[0].EditableRateAndDiscountONSaleInvoice);


                        }
                    }
                }
            });
        }

        function GetMaxSaleInvoiceEntryDate() {
            var YearCode = parseInt($('#SaleBillYearCode').val());
            $.ajax({
                type: "POST",
                data: { "YearCode": YearCode },
                url: "@Url.Action("GetMaxSaleInvoiceEntryDate")",
                dataType: "json",
                success: function (result, status, error) {
                    if (result != null) {
                        var obj = $.parseJSON(result);
                        if (obj.Result != null) {
                            $('#MaxSaleInvoiceEntryDate').val("");
                            var lastSaleBillDate = obj.Result[0].SaleBillDate; // comes in dd/MM/yyyy format?
                            $('#MaxSaleInvoiceEntryDate').val(lastSaleBillDate);

                            // Convert to date object
                            var maxSaleBillDate = toDateObject(lastSaleBillDate);

                            // If back date not allowed → enforce restriction
                            if ($('#AllowBackDateSALEBILL').val() != "Y") {
                                $('#SaleBillDate').datepicker("option", "minDate", maxSaleBillDate);
                                $('#SaleBillEntryDate').datepicker("option", "minDate", maxSaleBillDate);
                            }
                        }
                    }
                }
            });
        }

        function toDateObject(dateStr) {
            if (!dateStr) return null;
            dateStr = dateStr.trim();

            let d;

            if (dateStr.includes("T")) {
                // ISO format: yyyy-MM-ddTHH:mm:ss
                d = new Date(dateStr);
            } else if (dateStr.includes("-")) {
                // yyyy-MM-dd
                let parts = dateStr.split("-");
                d = new Date(parts[0], parts[1] - 1, parts[2]);
            } else if (dateStr.includes("/")) {
                // dd/MM/yyyy
                let parts = dateStr.split("/");
                d = new Date(parts[2], parts[1] - 1, parts[0]);
            } else {
                console.error("Unknown date format:", dateStr);
                return null;
            }

            return isNaN(d.getTime()) ? null : d;
        }

        var AllowedToDispatchQtyMoreThenCloseSOPendQty = '';
        function GetFeatureOption() {

            $.ajax({
                type: "POST",
                data: {},
                url: "@Url.Action("GetFeatureOption")",
                dataType: "json",
                success: function (result, status, error) {

                    if (result != null) {
                        var obj = $.parseJSON(result);
                        if (obj.Result != null) {
                            $('#AllowBackDateSALEBIL').val("");
                            $('#ShowHideSaleBillEntryDetail').val("");
                            $('#ShowHideSaleBillCustomerDetail').val("");
                            $('#ShowHideSaleBillOtherRequiredDetail').val("");
                            $('#ShowHideSaleBillCurrency').val("");
                            $('#ShowHideSaleBillConsignee').val("");
                            $('#ShowHideSaleBillScheduleDetail').val("");
                            $('#AllowToChangeSaleBillStoreName').val("");
                            $('#HideOtherFieldOFSaleBillDetailTable').val("");
                            $('#ApproveSOForGenerateSaleInvoiceOrNot').val("");

                            $('#AllowBackDateSALEBILL').val(obj.Result[0].AllowBackDateSALEBILL);
                            $('#AllowToAdjZeroAmt').val(obj.Result[0].AllowToAdjZeroAmt);
                            AllowedToDispatchQtyMoreThenCloseSOPendQty=obj.Result[0].AllowedToDispatchQtyMoreThenCloseSOPendQty;
                            // $('#ShowHideSaleBillEntryDetail').val(obj.Result[0].ShowHideSaleBillEntryDetail);
                            // $('#ShowHideSaleBillCustomerDetail').val(obj.Result[0].ShowHideSaleBillCustomerDetail);
                            // $('#ShowHideSaleBillOtherRequiredDetail').val(obj.Result[0].ShowHideSaleBillOtherRequiredDetail);
                            // $('#ShowHideSaleBillCurrency').val(obj.Result[0].ShowHideSaleBillCurrency);
                            // $('#ShowHideSaleBillConsignee').val(obj.Result[0].ShowHideSaleBillConsignee);
                            // $('#ShowHideSaleBillScheduleDetail').val(obj.Result[0].ShowHideSaleBillScheduleDetail);
                            // $('#AllowToChangeSaleBillStoreName').val(obj.Result[0].AllowToChangeSaleBillStoreName);
                            // $('#HideOtherFieldOFSaleBillDetailTable').val(obj.Result[0].HideOtherFieldOFSaleBillDetailTable);
                            // $('#ApproveSOForGenerateSaleInvoiceOrNot').val(obj.Result[0].ApproveSOForGenerateSaleInvoiceOrNot);
                            if (obj.Result[0].ShowHideSaleBillEntryDetail === "N") {
                                $('.SaleBillEntryDetail').hide();
                            } else {
                                $('.SaleBillEntryDetail').show();
                            }

                            if (obj.Result[0].ShowHideSaleBillCustomerDetail === "N") {
                                $('.SaleBillCustomerDetail').hide();
                            } else {
                                $('.SaleBillCustomerDetail').show();
                            }

                            if (obj.Result[0].ShowHideSaleBillOtherRequiredDetail === "N") {
                                $('.SaleBillOtherRequiredDetail').hide();
                            } else {
                                $('.SaleBillOtherRequiredDetail').show();
                            }

                            if (obj.Result[0].ShowHideSaleBillCurrency === "N") {
                                $('.SaleBillCurrency').hide();
                            } else {
                                $('.SaleBillCurrency').show();
                            }

                            if (obj.Result[0].ShowHideSaleBillConsignee === "N") {
                                $('.SaleBillConsignee').hide();
                            } else {
                                $('.SaleBillConsignee').show();
                            }
                            if (obj.Result[0].HideShowOtherDiscount === "N") {
                                $('.HideShowOtherDiscount').hide();
                            } else {
                                $('.HideShowOtherDiscount').show();
                                recalcNetTotal();
                            }


                            if (obj.Result[0].ShowHideOtherDetails === "N") {
                                $('.HideOtherDetail').hide();
                            } else {
                                $('.HideOtherDetail').show();
                            }


                            if (obj.Result[0].AllowToChangeSaleBillStoreName === "N") {
                                $('.AllowToChangeStoreOrNot').hide();
                            } else {
                                $('.AllowToChangeStoreOrNot').show();
                            }


                            if (obj.Result[0].ShowHideSaleBillScheduleDetail === "N") {
                                $('.SaleBillScheduleDetail').hide();
                            } else {
                                $('.SaleBillScheduleDetail').show();
                            }
                            if (obj.Result[0].HideOtherFieldOFSaleBillDetailTable === "N") {
                                $('.SaleBillOtherDetail').hide();
                            } else {
                                $('.SaleBillOtherDetail').show();
                            }


                        }
                    }
                }
            });
        }

        function FillDistance() {

            var accountCode = $('#AccountCode').val();
            $.ajax({
                type: "POST",
                data: { "accountCode": accountCode },
                url: "@Url.Action("GetDistance")",
                dataType: "json",
                success: function (result, status, error) {

                    if (result != null) {
                        var obj = $.parseJSON(result);
                        if (obj.StatusCode == 200) {
                            $('#DistanceKM').val("");
                            $('#DistanceKM').val(obj.Result.Table[0].Column1);
                        } else {
                            $('#DistanceKM').val("");
                        }
                    }
                }
            });
        }

        $('#SH').change(function () {
            if ($('#SH').is(':checked') == true) {
                $('.AF').fadeIn();
            }
            else {
                $('.AF :input').val('');
                $('.AF').fadeOut();
            }
        });

        function FillStore() {
            $.ajax({
                type: "POST",
                url: "@Url.Action("FillStore")",
                dataType: "json",
                success: function (result, status, error) {
                    if (result != null) {
                        var obj = $.parseJSON(result);
                        $('#StoreId').empty();
                        // $('#StoreId').append('<option value="0">-Select-</option>');
                        if (obj.StatusCode != 500) {
                            $.each(obj.Result, function (index, val) {
                                $('#StoreId').append("<option value=" + val.StoreId + ">" + val.Store_Name + "</option>");
                            });

                            $.each(obj.Result, function (index, val) {
                                $('#MultiStoreName').append("<option value=" + val.StoreId + ">" + val.Store_Name + "</option>");
                            });
                        }
                    }
                }
            });
        }




        function FillTransporter() {
            $.ajax({
                type: "POST",
                url: "@Url.Action("FillTransporter")",
                dataType: "json",
                success: function (result, status, error) {
                    if (result != null) {
                        var obj = $.parseJSON(result);
                        $('#TransporterName').empty();
                        $('#TransporterName').append('<option value="0">-Select-</option>');
                        if (obj.StatusCode != 500) {
                            $.each(obj.Result, function (index, val) {
                                $('#TransporterName').append(
                                    '<option value="' + val.TransporterName + '">' + val.TransporterName + '</option>'
                                );
                            });
                        }
                    }

                    // if ($('#Mode').val() == "U" || $('#Mode').val() == "V") {
                    //     $('#TransporterName').val($('#hiddenTransporterName').val()).trigger("change");
                    // }
                }
            });
        }

        $('#Qty').change(function () {
            CalculateAmount();
            FillAltQty();
        });

        $('#AltQty').change(function () {
            FillAltQty();
        });

        $('#Rate').change(function () {
            CalculateAmount();
        });

        function CalculateAmount() {

            // var rate = $('#Rate').val();
            // var Qty = $('#Qty').val();

            // $('#Amount').val(rate * Qty);


            var Amount = 0;


            const Rate = $('#Rate').val() === "0" || $('#Rate').val() === "" ? 0 : parseFloat($('#Rate').val());
            const DP = $('#DiscountPer') === "0" || $('#DiscountPer').val() === "" ? 0 : parseFloat($('#DiscountPer').val());


            const Qty = $('#Qty').val() == "0" || $('#Qty').val() == "" ? 0 : parseFloat($('#Qty').val());
            Amount = Qty * Rate;


            if (DP !== 0) {
                const DA = ((Amount * DP) / 100);
                $('#DiscountAmt').val(DA.toFixed(6));
                Amount = Amount - DA;
            }

            $('#Amount').val(Amount.toFixed(6));


        }

        $('#currencyId').change(function () {
            $.ajax({
                type: "POST",
                url: "@Url.Action("GetExchangeRate", "DirectPurchaseBill")",
                data: { Currency: $('#currencyId :selected').text() },
                dataType: "json",
                success: function (result, status, error) {

                    if (result != null) {
                        var obj = $.parseJSON(result);
                        var exchangeRate = obj.Result[0].IndianValue == null ? 0 : parseFloat(obj.Result[0].IndianValue);
                        $('#ExchangeRate').val(exchangeRate);
                    }
                }
            });
        });

        $('#PN1').change(function (event) {
            event.preventDefault();
            if ($('#SaleBillJobwork').val() == 'S') {
                if ($('#PN1').is(":checked") == true) {
                    FillCustomerList("Y");
                }
            }
        });

        $('#PNConsingee').change(function (event) {
            event.preventDefault();
            if ($('#PNConsingee').is(":checked") == true) {
                FillConsigneeList("Y");
            }
        });

        // $(document).on('select2:select', '#AccountCode', function (e) {
        //     FillSONO();
        //     FillCurrency();
        //     FillCustomerAddress();

        //     if ($('#divTaxGrid tr td').length > 1) {
        //         btnClearTax();
        //     }
        //     if ($('#divSaleBillList tr td').length > 1) {
        //         //ClearGrid();
        //     }
        //     if ($('#divdbCrItemList tr td').length > 1) {
        //         ClearDRCRGrid();
        //     }
        // });

        function ClearDRCRGrid() {
            $.ajax({
                type: "POST",
                url: "@Url.Action("ClearDRCRGrid")",
                dataType: "json",
                success: function (result, status, error) {

                    $('#divdbCrItemList').empty();
                    var NoData = '<tr class="text-center"><td colspan="32" class="text-black-50"><strong>NO DATA ADDED</strong></td></tr>';
                    $('#divdbCrItemList').html(NoData);
                    BasicTotal();
                },
                error: function (req, status, error) {
                    alert(error);
                }
            });
        }

        $(document).on('select2:select', '#DocTypeAccountCode', function (e) {
            if ($('#divSaleBillList tr td').length > 1) {
                GetDbCrDetail();
            }
        });

        function FillCustomerAddress() {

            $.ajax({
                type: "POST",
                url: "@Url.Action("GetCustomerBasedDetails")",
                data: { Code: $('#AccountCode').val() },
                dataType: "json",
                success: function (result, status, error) {

                    if (result != null) {
                        var obj = $.parseJSON(result);
                        $('#CustAddress').empty();
                        $('#CustAddress').val(obj.Result.Table[0].Address);
                        $('#GSTNO').empty();
                        $('#GSTNO').val(obj.Result.Table[0].GSTNO);
                        $('#StateCode').empty();
                        $('#StateCode').val(obj.Result.Table[0].statecode);
                        $('#StateNameofSupply').empty();
                        $('#StateNameofSupply').val(obj.Result.Table[0].StateName);
                        $('#CityofSupply').empty();
                        $('#CityofSupply').val(obj.Result.Table[0].City);
                        $('#CountryOfSupply').empty();
                        $('#CountryOfSupply').val(obj.Result.Table[0].Country);
                        $('#PaymentCreditDay').empty();
                        $('#PaymentCreditDay').val(obj.Result.Table[0].CreditDays);

                        if($('#PaymentCreditDay').val()=='' || $('#PaymentCreditDay').val()==0)
                        {
                            $('#PaymentCreditDay').val(1);
                        }

                        DueDateCalculation();

                        // if ($('#StateCode').val() == "") {
                        //     $.notify('StateCode is manadatory...!', "error");
                        //     alert("StateCode is manadatory...!");
                        //     $('#AccountCode').val('0');
                        //     $('#AccountCode').trigger("change");

                        // }
                    }
                }
            });
        }

        $('#ConsigneeAccountcode').change(function () {
            FillConsigneeAddress();
            btnClearTax();
        });

        $('#AccountCode').change(function () {
            if ($('#Mode').val() != 'U' && $('#Mode').val() != 'V') {
                $('#ConsigneeAccountcode').val($('#AccountCode').val());
                FillConsigneeAddress();
            }
        });

        $('.SODetail').click(function () {

            $('#PopupModel').modal("show");
            var accountName = $("#AccountCodeText").val() == '-Select-' ? '' : $("#AccountCodeText").val() ;
            var itemName = $('#ItemCode').find(':selected').text() == '-Select-' ? '' : $('#ItemCode').find(':selected').text().split("--->")[0]
            var partCode = $('#PartCode').find(':selected').text() == '-Select-' ? '' : $('#PartCode').find(':selected').text();
            var sono = $('#SONO').find(':selected').text() == '-Select-' ? '' : $('#SONO').find(':selected').text();
            var soYearCode = $('#SOYearCode').find(':selected').text() == '-select-' ? '' : $('#SOYearCode').find(':selected').text();
            var custOrderNo = $('#CustOrderNo').find(':selected').text() == '-select-' ? '' : $('#CustOrderNo').find(':selected').text();
            var schNo = $('#SchNo').find(':selected').text() == '-select-' ? '' : $('#SchNo').find(':selected').text();
            var schYearCode = $('#SaleSchYearCode').find(':selected').text() == '-Select-' ? '' : $('#SaleSchYearCode').find(':selected').text();

            $.ajax({
                type: "POST",
                url: "@Url.Action("DisplaySODetail")",
                data: { "accountName": accountName, "itemName": itemName, "partCode": partCode, "sono": sono, "soYearCode": soYearCode, "custOrderNo": custOrderNo, "schNo": schNo, "schYearCode": schYearCode },
                dataType: "json",
                success: function (result, status, error) {
                    if (result != null) {
                        var obj = $.parseJSON(result);
                        if (obj.Result != null) {
                            var html = '';
                            $('#divDisplayGrid').empty();
                            var i = 1;
                            $.each(obj.Result, function (index, val) {
                                html += '<tr id="DisplayRow-' + i + '">' +
                                    '<td>' + i + '</td>' +
                                    '<td>' + val.CustomerName + '</td>' +
                                    '<td>' + val.SONO + '</td>' +
                                    '<td>' + val.CustOrderNo + '</td>' +
                                    '<td>' + val.SODate + '</td>' +
                                    '<td>' + val.SchNo + '</td>' +
                                    '<td>' + val.PartCode + '</td>' +
                                    '<td>' + val.ItemName + '</td>' +
                                    '<td>' + val.OrderQty + '</td>' +
                                    '<td>' + val.BilledQty + '</td>' +
                                    '<td>' + val.ActualPendQty + '</td>' +
                                    '<td>' + val.PendQty + '</td>' +
                                    '<td>' + val.Unit + '</td>' +
                                    '<td>' + val.AltQty + '</td>' +
                                    '<td>' + val.AltUnit + '</td>' +
                                    '<td>' + val.Rate + '</td>' +
                                    '<td>' + val.DiscPer + '</td>' +
                                    '<td>' + val.Active + '</td>' +
                                    '<td>' + val.Approved + '</td>' +
                                    '<td>' + val.WEF + '</td>' +
                                    '<td>' + val.SOCloseDate + '</td>' +
                                    '<td>' + val.Deactive + '</td>' +
                                    '<td>' + val.SOType + '</td>' +
                                    '<td>' + val.SchYearcode + '</td>' +
                                    '</tr>';
                                i++;
                            });
                            $('#divDisplayGrid').append(html);
                        }
                    }
                }
            });
        });

        function FillConsigneeAddress() {

            $.ajax({
                type: "POST",
                url: "@Url.Action("GetCustomerBasedDetails")",
                data: { Code: $('#ConsigneeAccountcode').val() },
                dataType: "json",
                success: function (result, status, error) {

                    if (result != null) {
                        var obj = $.parseJSON(result);
                        $('#ConsigneeAddress').empty();
                        $('#ConsigneeAddress').val(obj.Result.Table[0].Address);
                    }
                }
            });
        }

        $('#SubmitButton').click(function () {
            if ($('#divAdjItemList tr td').length > 1) {
                $.notify('Adjustgrid is manadatory...!', "error");
            }
            else {
                $("form").submit();
                $('#SubmitionForm').modal("show");
            }
        })
        // $('#btnPrint').click(function () {
        //     const printWindow = window.open('', '_blank', 'width=900,height=700,toolbar=no,menubar=no,scrollbars=yes,resizable=yes');

        //     $('#SubmitionForm').modal("hide");

        //     setTimeout(() => {
        //         submitForm(true, false, false, printWindow, null); // Send true and window object
        //     }, 300);
        // });

        // $('#btnPrintEmail').click(function () {
        //     const printWindow = window.open('', '_blank', 'width=900,height=700,toolbar=no,menubar=no,scrollbars=yes,resizable=yes');
        //     const sendWindow = window.open('', '_blank'); // Open blank tab first (browser-safe)


        //     $('#SubmitionForm').modal("hide");

        //     setTimeout(() => {
        //         submitForm(true, true, false, printWindow, sendWindow); // Send true and window object
        //     }, 300);
        // });
        // $('#submitBTN, #submitBTNfooter, #UpdateButton').click(function (e) {
        //     e.preventDefault(); // Prevent default button action if needed

        //     // Show the modal
        //     $('#SubmitionForm').modal('show');
        // });

        // $('#btnClose').click(function () {
        //     $('#SubmitionForm').modal("hide");

        //     setTimeout(() => {
        //         submitForm(false, false, false, null, null); // no print
        //     }, 300);
        // });

        var itemsStockableAndCustJw = [];
        function ValidateBomItemsInCustGrid() {
            var custItemCodes = new Set();
            var isValid = true;

            // Collect all item codes from Customer grid
            $('#divCustJobWorkISsueSummary tr').each(function (index) {
                var itemCode = $('#fgItemCodeGrid-' + (index + 1)).val();
                if (itemCode && itemCode !== "0") {
                    custItemCodes.add(itemCode);
                }
            });

            // Validate each BOM item exists in Customer grid
            $('#divBomCustJobWorkISsueSummary tr').each(function (index) {
                var itemCode = $('#fgBomItemCodeGrid-' + (index + 1)).val();
                if (itemCode && itemCode !== "0") {
                    if (!custItemCodes.has(itemCode)) {
                        $.notify('Item "' + itemCode + '" in BOM Customer JobWork must also exist in Customer JobWork grid.', "error");
                        isValid = false;
                        return false;
                    }
                }
            });

            return isValid;
        }

        function ValidateAdjChallanGrid(gridSelector, itemSelector) {
            var rowCount = $(gridSelector + ' tr').length;
            for (var j = 1; j <= rowCount; j++) {
                var itemCode = $(itemSelector + j).val();
                if (itemCode != "" && itemCode != "0") {
                    if (!itemsStockableAndCustJw.includes(itemCode)) {
                        if (gridSelector == '#divBomCustJobWorkISsueSummary') {
                            $.notify('Bom Customer JobWork must be 1 row...!', "error");
                        } else {
                            $.notify('Customer JobWork must be 1 row...!', "error");
                        }
                        return false;
                    }
                }
            }
            return true;
        }

        function CheckFinYearBeforeSave(callback) {
            $.ajax({
                type: "POST",
                url: "@Url.Action("CheckFinYearBeforeSave")",
                data: {
                    YearCode: @yearCode,
                    Date: $('#SaleBillEntryDate').val(),
                    DateName: ""
                },
                dataType: "json",
                success: function (result, textStatus, jqXHR) {
                    if (jqXHR.status === 200) {
                        if (result != null) {
                            var obj = $.parseJSON(result);

                            // Check the response value
                            if (obj.Result && obj.Result.length > 0 && obj.Result[0].Result === 'Correct date') {
                                callback(true); // ✅ Valid date
                            } else {
                                $.notify(obj.Result[0].Result || "Invalid response!", "error");
                                callback(false); // ❌ Invalid
                            }
                        } else {
                            $.notify("Empty response from server!", "error");
                            callback(false);
                        }
                    } else {
                        $.notify("Unexpected server response!", "error");
                        callback(false);
                    }
                },
                error: function (jqXHR, textStatus, errorThrown) {
                    $.notify("Error checking financial year!", "error");
                    callback(false);
                }
            });
        }
             
        $('#submitBTN,#submitBTNfooter,#UpdateButton').click(function (e) {
            e.preventDefault();
                   $('#TypeOfSave').val("NPS");
            ValidateSubmitWrapper(function (isValid) {
                if (!isValid) return;

                if ($('#divSaleBillList tr td').length <= 1) {
                    $.notify('Sale Bill Grid Should Have Atleast 1 Item...!', "error");
                } else if ($('#GSTRegistered').val() == 'Y') {
                    if ($('#divTaxGrid tr td').length <= 1 && $('#DomesticExportNEPZ').val() == "DOMESTIC") {
                        $.notify('Tax Grid Should Have Atleast 1 Item...!', "error");
                    } else {
                        if ($('#divAdjItemList tr td').length <= 1) {
                            $.notify('Adjust Grid Should Have Atleast 1 Item...!', "error");
                        } else if ($('#divdbCrItemList tr td').length <= 1) {
                            $.notify('DRCR Grid Should Have Atleast 1 Item...!', "error");
                        } else if ($('#StateCode').val() == 0) {
                            $.notify('StateCode is mandatory...!', "error");
                        } else if ($('#divAdjItemList tr td').length > 1) {
                            var hasCR = false;
                            $('tr.adjGridRow').each(function () {
                                $(this).find('.GridAdjDrCr').each(function () {
                                    if ($(this).text().trim().toUpperCase() === 'CR') {
                                        hasCR = true;
                                        return false;
                                    }
                                });
                                if (hasCR) return false;
                            });

                            if (hasCR) {
                                $.notify('AdjGrid should not have CR value...!', "error");
                            } else {
                                if ($('#SaleBillJobwork').val() == 'J') {
                                    var rowCount = $('#divSaleBillList tr').length;
                                    var itemsStockableAndCustJw = [];

                                    for (var i = 1; i <= rowCount; i++) {
                                        var stockable = $('#stockableItems-' + i).text() === 'Y';
                                        var custJWAdj = $('#custJWAdjMandatory-' + i).text() === 'Y';
                                        if (stockable || custJWAdj) {
                                            itemsStockableAndCustJw.push($('#GridIC-' + i).val());
                                        }
                                    }

                                    var isCustJWValid = ValidateAdjChallanGrid('#divCustJobWorkISsueSummary', '#fgItemCodeGrid-');
                                    var isBomCustJWValid = ValidateAdjChallanGrid('#divBomCustJobWorkISsueSummary', '#fgBomItemCodeGrid-');
                                    var isBomItemsValidInCust = ValidateBomItemsInCustGrid();

                                    var isPentoAdj = true;
                                    $('.bomCustRowJW').find('#pendToAdj').each(function () {
                                        if (parseFloat($(this).text()) > 0) {
                                            isPentoAdj = false;
                                            $.notify('PendToAdj qty must be adjusted.', "error");
                                            return false;
                                        }
                                    });

                                    if (isCustJWValid && isBomCustJWValid && isBomItemsValidInCust && isPentoAdj) {
                                        if (confirm("Are you sure you want to save this entry?")) {
                                            $('#EinvoicePopup').modal('show');
                                        }
                                    }
                                } else {
                                    if (confirm("Are you sure you want to save this entry?")) {
                                        $('#EinvoicePopup').modal('show');
                                    }
                                }
                            }
                        } else if ($('#GSTRegistered').val() == 'Y') {
                            if ($('#divTaxGrid tr td').length <= 1) {
                                $.notify('Tax Grid Should Have Atleast 1 Item...!', "error");
                            }
                        } else {
                            if (confirm("Are you sure you want to save this entry?")) {
                                $('#EinvoicePopup').modal('show');
                            }
                        }
                    }
                } else {
                    if (confirm("Are you sure you want to save this entry?")) {
                        $('#EinvoicePopup').modal('show');
                    }
                }
            });
        });


        var EditEachItem = false;
        var EditDeleteBatchValidation = false;
        function EditItemRows(SeqNo) {

            var RowCount = $('#divSaleBillList tr').length;
            if (EditEachItem) {
                $.notify('Cannot Edit item while AddtoGrid  Existing Item!!!', "error");
                $('#editButton-' + RowCount).prop("disabled", true);
            }
            else {
                $.ajax({
                           url: '/SaleInvoice/EditItemRow',
                    type: "POST",
                    data: { SeqNo: SeqNo },
                    success: function (data) {
                        var obj = $.parseJSON(data);
                        if (obj != null) {
                            var ItemCode = $('#GridIC-' + SeqNo).val()
                            ClearDRCRGrid();
                            ClearAdjustmentGrid();
                            DeleteTaxRowByItemCode(ItemCode);
                            EditEachItem = true;
                            EditDeleteBatchValidation = true;

                            // if ($('#Mode').val() == "U" || $('#Mode').val() == "V") {
                            // FillSONO();
                            $('#SONO').val(obj[0].SONO);
                           
        if ($('#SONO option[value="' + obj[0].SONO + '"]').length === 0 && obj[0].SONO && obj[0].SONO !== '0') {
            $('#SONO').append('<option value="' + obj[0].SONO + '">' + obj[0].SONO + '</option>');
        }
        $('#SONO').val(obj[0].SONO).trigger('change');
                // FillSOYearCode();
                                   FillSOYearCode();
                                   $('#SOYearCode').val(obj[0].SOYearCode);
                            // FILLCustomerOrderAndSPDate();
                            // FillSOSchedule();
                            // FillSchYearCode();
                            // $('#SaleSchYearCode').trigger("change");
                            $('#SchNo').val(obj[0].SchNo);
                           
                                if ($('#SchNo option[value="' + obj[0].ScheduleNo + '"]').length === 0 && obj[0].ScheduleNo && obj[0].ScheduleNo !== '0') {
                   $('#SchNo').append('<option value="' + obj[0].ScheduleNo + '">' + obj[0].ScheduleNo + '</option>');
        }
               $('#SchNo').val(obj[0].ScheduleNo).trigger('change');
                      FillSchYearCode();
                            $('#SaleSchYearCode').val(obj[0].SaleSchYearCode);

                            $('#CustOrderNo').val(obj[0].CustOrderNo);
      
                                if ($('#CustOrderNo option[value="' + obj[0].CustOrderNo + '"]').length === 0 && obj[0].CustOrderNo && obj[0].CustOrderNo !== '0') {
                   $('#CustOrderNo').append('<option value="' + obj[0].CustOrderNo + '">' + obj[0].CustOrderNo + '</option>');
        }
               $('#CustOrderNo').val(obj[0].CustOrderNo).trigger('change');
                                   //  $('#CustOrderNo').append("<option value=" + val.CustOrderNo + " selected>" + val.CustOrderNo + "</option>");
                            // FillItems($('#TypeItemServAssets').val());
                            if ($('#SaleBillJobwork').val() == 'J') {
                                JWItemList($('#TypeItemServAssets').val());
                            }

                            // if ($('#SONO').val() == '' || $('#SONO').val() == '0') {
                            //     FillItems($('#TypeItemServAssets').val());
                            // } else {
                            //     FillSOWiseItems();
                            // }
                             // if ($('#SONO').val() == ''||   $('#SONO').val() == 'NaN' ||$('#SONO').val() == null || $('#SONO').val() == '0') {
                // Autocomplete mode
                enableAutocompleteMode();
                // FillItems($('#TypeItemServAssets').val());
                                 AutoFillItems();

                $("#ItemCode").val(obj[0].ItemCode);
                $("#PartCode").val(obj[0].ItemCode);

                $("#ItemNameText").val(obj[0].ItemName);
                $("#PartCodeText").val(obj[0].PartCode);

               // GetItemPartCode("ItemCode");
            // } else {
            //     // Select2 mode
            //     enableSelect2Mode();
            //     FillSOWiseItems();
            //     $('#ItemCode').append('<option value="' + obj[0].ItemCode + '"  selected> '+obj[0].ItemName+'</option>').val(obj[0].ItemCode).trigger("change");
            //     $('#PartCode').append('<option value="' + obj[0].ItemCode + '"  selected> '+obj[0].PartCode+'</option>') .val(obj[0].ItemCode) .trigger("change");
            // }

                            // $('#ItemCode').val(obj[0].ItemCode).trigger("change");
                            // $('#PartCode').val(obj[0].ItemCode).trigger("change");
                            // FillCurrentBatchINStore();
                            if (obj[0].Batchno != '0' && obj[0].Batchno != null && obj[0].Batchno != 0) {
                                $('#Batchno').append('<option value="' + obj[0].Batchno + '" selected>' + obj[0].Batchno + '</option>');
                            }

                            if ($('#SaleBillJobwork').val() == 'J') {
                                fillBomRevNo();
                            }
                            $('#BomNo').val(obj[0].BomNo);
                            // } else {
                            //     $('#SONO').val(obj[0].SONO);
                            //     $('#SOYearCode').val(obj[0].SOYearCode);
                            //     $('#SaleSchYearCode').val(obj[0].SaleSchYearCode);

                            //     $('#ItemCode').val(obj[0].ItemCode).trigger("change");
                            //     $('#PartCode').val(obj[0].ItemCode).trigger("change");
                            //     FillCurrentBatchINStore();
                            //     // $('#Batchno').val(obj[0].Batchno);
                            //     if (obj[0].Batchno != '0' && obj[0].Batchno != null && obj[0].Batchno != 0) {
                            //         $('#Batchno').append('<option value="' + obj[0].Batchno + '" selected>' + obj[0].Batchno + '</option>');
                            //     }

                            // }

                            if ($('#SaleBillJobwork').val() == 'J') {
                                fillBomRevNo();
                            }
                            $('#BomNo').val(obj[0].BomNo);
                            $('#SeqNo').val(obj[0].SeqNo);
                            $('#ProducedUnprod').val(obj[0].ProducedUnprod);
                            $('#Group_Code').val(obj[0].Group_Code).trigger('select2:select');
                            $("#Group_CodeDiv").hide();
                            $('#BOMInd').val(obj[0].BOMInd);
                            
                            $('#SODate').val(obj[0].SODate);
                            $('#SchNo').val(obj[0].SchNo);
                            $('#Schdate').val(obj[0].Schdate);
                            $('#SOAmendNo').val(obj[0].SOAmendNo);
                            $('#SOAmendDate').val(obj[0].SOAmendDate);
                            $('#SchAmendNo').val(obj[0].SchAmendNo);
                            $('#SchAmendDate').val(obj[0].SchAmendDate);
                            $('#HSNNo').val(obj[0].HSNNo);
                            $('#Unit').val(obj[0].Unit);
                            $('#NoofCase').val(obj[0].NoofCase);
                            $('#Qty').val(obj[0].Qty);
                            $('#UnitOfRate').val(obj[0].UnitOfRate);
                            $('#RateInOtherCurr').val(obj[0].RateInOtherCurr);
                            $('#Rate').val(obj[0].Rate);
                            $('#AltUnit').val(obj[0].AltUnit);
                            $('#AltQty').val(obj[0].AltQty);
                            $('#ItemWeight').val(obj[0].ItemWeight);
                            $('#NoofPcs').val(obj[0].NoofPcs);
                            $('#CustomerPartCode ').val(obj[0].CustomerPartCode);
                            $('#MRP').val(obj[0].MRP);
                            $('#OriginalMRP').val(obj[0].OriginalMRP);
                            $('#SOPendQty').val(obj[0].SOPendQty);
                            $('#AltSOPendQty').val(obj[0].AltSOPendQty);
                            $('#DiscountPer').val(obj[0].DiscountPer);
                            $('#DiscountAmt').val(obj[0].DiscountAmt);
                            $('#ItemSize').val(obj[0].ItemSize);
                            $('#Itemcolor').val(obj[0].Itemcolor);
                            $('#StoreId').val(obj[0].StoreId);
                            $('#Amount').val(obj[0].Amount);
                            $('#AdviceNo').val(obj[0].AdviceNo);
                            $('#AdviseEntryId').val(obj[0].AdviseEntryId);
                            $('#AdviceYearCode').val(obj[0].AdviceYearCode);
                            $('#AdviseDate').val(obj[0].AdviseDate);
                            $('#ProcessId').val(obj[0].ProcessId);
                            $('#LotStock').val(obj[0].LotStock);
                            $('#TotalStock').val(obj[0].TotalStock);
                            $('#AgainstProdPlanNo').val(obj[0].AgainstProdPlanNo);
                            $('#AgainstProdPlanYearCode').val(obj[0].AgainstProdPlanYearCode);
                            $('#AgaisntProdPlanDate').val(obj[0].AgaisntProdPlanDate);
                            $('#GSTPer').val(obj[0].GSTPer);
                            $('#GSTType').val(obj[0].GSTType);
                            $('#PacketsDetail').val(obj[0].PacketsDetail);
                            $('#OtherDetail').val(obj[0].OtherDetail);
                            $('#ItemRemark').val(obj[0].ItemRemark);
                            $('#ProdSchno').val(obj[0].prodSchno);
                            $('#CostCenterId').val(obj[0].CostCenterid);
                            $('#ProdSchYearcode').val(obj[0].ProdSchYearcode);
                            $('#ProdSchEntryId').val(obj[0].prodSchEntryId);
                            $('#ProdSchDate').val(obj[0].ProdSchDate);
                            $('#SchdeliveryDate').val(obj[0].SchdeliveryDate);
                            // FillUniqueBatchNo();
                               if (obj[0].Uniquebatchno != '0' && obj[0].Uniquebatchno != null && obj[0].Uniquebatchno != 0) {
                                    $('#Uniquebatchno').append('<option value="' + obj[0].Uniquebatchno + '" selected>' + obj[0].Uniquebatchno + '</option>');
                              }
                          //  $('#Uniquebatchno').val(obj[0].Uniquebatchno);

                            var rowCount = $('#divStockGrid tr').length;
                            for (var i = 1; i <= rowCount + 1; i++) {
                                $('#editItemGrid-' + i).css("pointer-events", "none");
                                $('#editItemGrid-' + i).css("cursor", "not-allowed");
                            }

                            if ($('#SaleBillJobwork').val() == 'J') {
                                $('.jobWorkChalln').show();
                                $('.gridHiddenField').show();
                            } else {
                                $('.jobWorkChalln').hide();
                                $('.gridHiddenField').hide();
                            }
                                          $('#saleBillRow-' + SeqNo).remove();
                            // DeleteItemRow(SeqNo);

                             if ($('#divSaleBillList').children().length == 0) {
                                var NoData = '<tr class="text-center"><td colspan="28" class="text-black-50"><strong>NO DATA ADDED</strong></td></tr>';
                                       $('#divSaleBillList').html(NoData);
                            }
                        }
                    },
                    error: function (response) {
                        $.notify(response.responseText, "error");
                    },
                    failure: function (response) {
                        $.notify(response.responseText, "error");
                    }
                }).done(function () {
                    GetDbCrDetail();
                });
            }
        }

        function DeleteItemRow(SeqNo) {

            var IC = $('#GridIC-' + SeqNo).val();
            var BatchNo = $('#GridBatchNo-' + SeqNo).text();

            var allowDeletion = true;
            if (!EditDeleteBatchValidation) {
                for (var j = 0; j < itemBatchArray.length; j++) {
                    if (itemBatchArray[j].SeqNo > SeqNo && itemBatchArray[j].itemCodee == IC) {
                        $.notify('Cannot delete this row before deleting other BatchNo of this Item.', "error");
                        allowDeletion = false;
                        break;
                    }
                }
            }

            if (allowDeletion) {
                $.ajax({
                    url: '@Url.Action("DeleteItemRow")',
                    type: "POST",
                    async: false,
                    data: { "SeqNo": SeqNo, "Mode": $('#Mode').val() },
                    success: function (data, status, xhr) {

                        $('#divSaleBillList').html(data);

                        BasicTotal();
                        ClearDRCRGrid();
                        ClearAdjustmentGrid();

                        if ($('#SaleBillJobwork').val() == 'J') {
                            $('.jobWorkChalln').show();
                            $('.gridHiddenField').show();

                        } else {
                            $('.jobWorkChalln').hide();
                            $('.gridHiddenField').hide();
                        }

                        var itemArrayLength = itemBatchArray.length;

                        for (var i = 0; i < itemArrayLength; i++) {
                            if (itemBatchArray[i].itemcode == IC && itemBatchArray[i].batchno == BatchNo) {
                                itemBatchArray.splice(i, 1);
                            }
                        }

                        var rowCount = $('#divSaleBillList tr td').length;
                        if (rowCount <= 1) {
                            $('#DiscountPer').val(0);
                            $('#DiscountPer').prop("readonly", false);
                            $('#DiscountAmt').val(0);
                            $('#DiscountAmt').prop("readonly", false);
                        }

                        calculatetotalqty();
                    },
                    error: function (response, status, xhr) {
                        alert(response.responseText);
                        $.notify(response.responseText, "error");
                    },
                    failure: function (response, status, xhr) {
                        alert(response.responseText);
                        $.notify(response.responseText, "error");
                    }
                }).done(function () {
                    GetTaxPartItem();
                    GetDbCrDetail();
                           ClearAdjustmentGrid();
                    AddAdjstmntDetail1();

                });
            }
            EditDeleteBatchValidation = false;
        }


        async function AutoComplete(CtrlID, ColName) {

            $("#" + CtrlID).autocomplete({
                source: await function (request, response) {
                    $.ajax({
                        url: '/SaleInvoice/GetAutocompleteValue',
                        type: "POST",
                        success: function (data) {

                            var obj = JSON.parse(data);
                            //const filteredData = obj.Result.map(item => item[ColName]);
                            const distinctValues = new Set();

                            obj.Result.forEach(item => {
                                const colValue = item[ColName];
                                if (!distinctValues.has(colValue)) {
                                    distinctValues.add(colValue);
                                }
                            });

                            const distinctData = Array.from(distinctValues);
                            response(distinctData.map(text => ({ label: text, value: text })));
                        },
                        error: function (response) {
                            $.notify(response.responseText, { position: "top center", className: "error" });
                        },
                        failure: function (response) {
                            $.notify(response.responseText, { position: "top center", className: "error" });
                        }
                    });
                },
                select: function (e, i) {
                    //$("#" + SelectFunc).val(i.item.value);
                },
                minLength: 1
            });
        }


        function ValidateSubmit() {
             
             if($('#DocTypeAccountCode').prop('selectedIndex') == -1){
                 $.notify("DocTypeAccountCode is required...!", "error");
                return false;
            }
            var salebillRowCount = $('#divTaxGrid tr').length;
            if ($('#divTaxGrid tr td').length > 1) {
                for (var i = 1; i < salebillRowCount; i++) {
                    if ($('#txGridAmount-' + i).text() == 0) {
                        $.notify("Please enter Tax Amount first..!", "error");
                        return false;
                    }
                }
            }

            if ($('#vehicleNo').val() != '') {
                var inputValue = $('#vehicleNo').val();
                if (inputValue.length > 10) {
                    $('#vehicleNo').val(inputValue.substring(0, 10));
                } else if (inputValue.length < 10) {
                    $.notify("Please enter at least 10 characters in Vehicle No", "error");
                    return false;
                }
            }

            if ($('#CustOrderNo').val() == '') {
                $.notify("CustOrder No is required...!", "error");
                return false;
            }

            let AdjustAmount = parseFloat($('#AdjAdjstedAmt1').text());
            let TotalAmount = parseFloat($('#AdjTotalAmt1').text());
            let NetAmount = parseFloat($('#NetTotal').val());

            if (AdjustAmount !== TotalAmount || TotalAmount !== NetAmount) {
                $.notify("AdjustAmount, TotalAmount, and NetAmount must all be equal....!", "error");
                return false;
            }

            if ($('#DistanceKM').val() > 3000) {
                $('#DistanceKM').val(0);
                $.notify("Distance KM should not greter then 3000 KM...!", "error");
                return false;
            }

            if ($('#AccountCode').val() == 0) {
                $.notify("Customer Name is mandatory...!", "error");
                return false;
            }

            if ($('#DocTypeAccountCode').val() == 0) {
                $.notify("DocType Name is mandatory...!", "error");
                return false;
            }

            if ($('#SaleBillNo').val() == '') {
                $.notify("SaleBillNo is mandatory...!", "error");
                return false;
            }

            if ($('#PaymentCreditDay').val() == 0) {
                $.notify("Credit Days should not be 0...!", "error");
                return false;
            }

            var rowCount = $('#divdbCrItemList tr').length;
            var drAmt = 0;
            var crAmt = 0;

            for (var i = 1; i <= rowCount; i++) {
                drAmt += $('#drcrRow-' + i + ' .dramt').text() == '' ? 0 : parseFloat($('#drcrRow-' + i + ' .dramt').text());
                crAmt += $('#drcrRow-' + i + ' .cramt').text() == '' ? 0 : parseFloat($('#drcrRow-' + i + ' .cramt').text());
            }

            if (drAmt.toFixed(2) != crAmt.toFixed(2)) {
                $.notify("Debit and Credit are not maintained...!", "error");
                return false;
            }

            return true;
        }

        function ValidateSubmitWrapper(callback) {
            if (!ValidateSubmit()) {
                callback(false);
                return;
            }

            CheckFinYearBeforeSave(function (isValid) {
                callback(isValid);
            });
        }

        $('#vehicleNo').on('input', function () {
            var inputValue = $(this).val();
            if (inputValue.length > 10) {
                $(this).val(inputValue.substring(0, 10));
            }
        });

        $('#DistanceKM').on('change', function () {
            if ($('#DistanceKM').val() > 3000) {
                $('#DistanceKM').val(0);
                $.notify("Distance KM should not greter then 3000 KM...!", "error");
                return false;
            }
            return true;
        });

        $('#vehicleNo').on('change', function () {
            var inputValue = $(this).val();
            if (inputValue.length < 10) {
                $.notify("Please enter at least 10 characters in Vehicle No", "error");
            }
        });

        function FillJWCustomerList() {
            $.ajax({
                type: "POST",
                url: "@Url.Action("FillJWCustomerList")",
                data: { "SBJobwork": "JOBWORK-SALEBILL", "yearCode": $('#SaleBillYearCode').val() },
                dataType: "json",
                async: false,
                success: function (result, status, error) {
                    if (result != null) {

                        var obj = $.parseJSON(result);
                        $('#AccountCode').empty();
                        $('#AccountCode').append('<option value="0">-Select-</option>');
                        if (obj.StatusCode != 500) {
                            $.each(obj.Result.Table, function (index, val) {
                                $('#AccountCode').append("<option value=" + val.Account_code + ">" + val.CustomeName + "</option>");
                            });
                        }
                    }
                    if ($('#Mode').val() == "U" || $('#Mode').val() == "V") {
                        // $('#AccountCode').val($('#hiddenAccountCode').val()).trigger("change");
                     //   $('#AccountCode').val($('#hiddenAccountCode').val()).trigger('change.select2');
                        $('#AccountCode').val($('#hiddenAccountCode').val()).trigger('change');
                    }
                }
            });
        }

        function FillCustomerList(ShowAllCustomer) {
            var ShowAllCustomer = ShowAllCustomer == "" ? "N" : "Y";
            $.ajax({
                type: "POST",
                url: "@Url.Action("FillCustomerList")",
                data: { "SBJobwork": "SaleBill", "showAllCustomer": ShowAllCustomer },
                dataType: "json",
                async: false,
                success: function (result, status, error) {
                    if (result != null) {

                        var obj = $.parseJSON(result);
                        $('#AccountCode').empty();
                        $('#AccountCode').append('<option value="0">-Select-</option>');
                        if (obj.StatusCode != 500) {
                            $.each(obj.Result.Table, function (index, val) {
                                $('#AccountCode').append("<option value=" + val.Account_code + ">" + val.CustomeName + "</option>");
                            });
                        }
                    }
                    if ($('#Mode').val() == "U" || $('#Mode').val() == "V") {
                        $('#AccountCode').val($('#hiddenAccountCode').val()).trigger("change");
                      //  $('#AccountCode').val($('#hiddenAccountCode').val()).trigger('change.select2');
                       // $('#AccountCode').val($('#hiddenAccountCode').val()).trigger('change.select2');
                    }
                }
            });
        }

        $('#DT').change(function () {
            var dtValue = $('#DT').prop("checked") == true ? "T" : "F";
            FillDocument(dtValue);
        });

        function FillDocument(dt) {
            var showAllDoc = dt;
            $.ajax({
                type: "POST",
                url: "@Url.Action("FillDocument")",
                data: { "ShowAllDoc": showAllDoc },
                dataType: "json",
                async: false,
                success: function (result, status, error) {
                    if (result != null) {

                        var obj = $.parseJSON(result);
                        $('#DocTypeAccountCode').empty();
                        // $('#DocTypeAccountCode').append('<option value="0">-Select-</option>');
                        if (obj.StatusCode != 500) {
                            $.each(obj.Result.Table, function (index, val) {
                                $('#DocTypeAccountCode').append("<option value=" + val.Account_Code + ">" + val.Account_Name + "</option>");
                            });
                        }
                    }

                    if ($('#Mode').val() == "U" || $('#Mode').val() == "V") {
                        $('#DocTypeAccountCode').val($('#hiddenDocType').val()).trigger("change");
                    }
                }
            });
        }

        $('#SONO').change(function () {
            if ($('#SONO').val() != '0') {
                $('#Group_CodeDiv').hide();
            } else {
                $('#Group_CodeDiv').show();
            }
        });

        function FillCurrency() {

            var accountCode = $('#AccountCode').val();
            $.ajax({
                type: "POST",
                url: "@Url.Action("FillCurrency")",
                data: { "accountCode": accountCode },
                dataType: "json",
                success: function (result, status, error) {

                    if (result != null) {

                        var obj = $.parseJSON(result);
                        $('#currencyId').empty();
                        $('#currencyId').append('<option value="0">-Select-</option>');
                        if (obj.StatusCode != 500) {
                            $.each(obj.Result.Table, function (index, val) {
                                $('#currencyId').append("<option value=" + val.entry_id + ">" + val.Currency + "</option>");
                            });
                            $('#currencyId option:eq(1)').prop('selected', true);

                            $('#currencyId').trigger("change");

                            //   $('#DomesticExportNEPZ').val(obj.Result.Table[0].DomExport);
                        }
                    }
                }
            });
        }

        function FillSONO() {
            var saleBillType = $('#SaleBillJobwork').val() == 'J' ? "JOBWORK-SALEBILL" : "SALEBILL";
            $.ajax({
                type: "POST",
                url: "@Url.Action("FillSONO")",
                data: { "billDate": $("#SaleBillDate").val(), "accountCode": $('#AccountCode').val(), "billType": saleBillType },
                dataType: "json",
                async: false,
                success: function (result, status, error) {

                    if (result != null) {
                        var obj = $.parseJSON(result);
                        $('#SONO').empty();
                        $('#SONO').append('<option value="0">-Select-</option>');
                        if (obj.StatusCode != 500) {
                            $.each(obj.Result, function (index, val) {
                                $('#SONO').append("<option value=" + val.SONo + " data-sotype=" + val.SOType + " data-soApproved=" + val.Approved + ">" + val.SONo + "</option>");
                            });

                            $('#SOType').val($('#SONO').find(':selected').data('sotype'));
                        }
                    }
                }
            });
        }

        function FillSOItemRate() {

            var sono = $("#SONO").val() == '0' ? '' : $("#SONO").val();
            $.ajax({
                type: "POST",
                url: "@Url.Action("FillSOItemRate")",
                data: { "sono": sono, "soYearCode": $('#SOYearCode').val(), "accountCode": $('#AccountCode').val(), "custOrderNo": $('#CustOrderNo').val(), "itemCode": $('#ItemCode').val() },
                dataType: "json",
                async: false,
                success: function (result, status, error) {
                    if (result != null) {

                        var obj = $.parseJSON(result);
                        if (obj.StatusCode == 200) {
                            var rate = obj.Result[0].Rate == '' ? 0 : parseFloat(obj.Result[0].Rate);
                            $('#Rate').val("");
                            $('#Rate').val((rate).toFixed(2));
                            $('#DiscountPer').val(0);
                            $('#DiscountPer').val(obj.Result[0].DiscPer);
                            $('#DiscountAmt').val(0);
                            $('#DiscountAmt').val(obj.Result[0].DiscRs);
                            $('#Unit').val("");
                            $('#Unit').val(obj.Result[0].unit);
                            $('#AltUnit').val("");
                            $('#AltUnit').val(obj.Result[0].unit);
                            // $('#OtherRateCurr').val("");
                            // $('#OtherRateCurr').val(obj.Result[0].OtherRateCurr);
                            // $('#ItemDescription').val("");
                            // $('#ItemDescription').val(obj.Result[0].ItemDescription);
                            $('#HSNNo').val("");
                            $('#HSNNo').val(obj.Result[0].HsnNo);

                            if ($('#DiscountPer').val() != 0 || $('#DiscountAmt').val() != 0) {
                                // $('#DiscountPer').prop("readonly", true);
                                $('#DiscountAmt').prop("readonly", true);
                            }
                        }
                    }
                }
            });
        }

        function convertDateFormat(dateStr) {
            let parts = dateStr.split("/");
            return `${parts[2]}-${parts[1]}-${parts[0]}`;
        }

        function FILLCustomerOrderAndSPDate() {

            $.ajax({
                type: "POST",
                url: "@Url.Action("FILLCustomerOrderAndSPDate")",
                data: { "billDate": convertDateFormat($("#SaleBillDate").val()), "accountCode": $('#AccountCode').val(), "sono": $('#SONO').val(), "soYearCode": $('#SOYearCode').val() },
                dataType: "json",
                async: false,
                success: function (result, status, error) {

                    if (result != null) {
                        var obj = $.parseJSON(result);
                        if (obj.StatusCode == 200) {
                            $('#CustOrderNo').empty();
                            $('#CustOrderNo').append('<option value="0">-Select-</option>');
                            if (obj.StatusCode != 500) {
                                $.each(obj.Result, function (index, val) {
                                    $('#CustOrderNo').append("<option value=" + val.CustOrderNo + " selected>" + val.CustOrderNo + "</option>");
                                });
                            }

                            $('#SODate').val("");
                            //$('#SODate').val(obj.Result[0].Sodate);

                            $('#SODate').datepicker({ dateFormat: 'dd/mm/yy' }).datepicker("setDate", new Date(obj.Result[0].Sodate.split("T")[0]));
                            FillSOItemRate();
                        }
                    }
                }
            });
        }

        $('#CustOrderNo').change(function () {
            FillSOItemRate();
        });

        $('#SONO').change(function (event) {
            event.preventDefault();
            $('#CustOrderNo').val('0');
            FillSOYearCode();

            if ($('#SONO').find(':selected').data('sotype') == "CLOSE") {
                $('#SchNo').val('');
                $('#SchNo').prop("disabled", true);
                $('#SaleSchYearCode').prop("disabled", true);
            } else {
                $('#SchNo').prop("disabled", false);
                $('#SaleSchYearCode').prop("disabled", false);
            }
            // $('#SOType').val($('#SONO').find(':selected').data('sotype'));
            if ($('#SONO').val() == '0' || $('#SONO').val() == ''||  $('#SONO').val()=="NaN") {
                $('#Rate').prop("readonly", false);
                $('#RateInOtherCurr').prop("readonly", false);
            } else {
                // $('#Rate').prop("readonly", true)
                $('#RateInOtherCurr').prop("readonly", true);
                $('#ItemSA').prop("disabled", true);
            }

            $('#SOType').val($('#SONO').find(':selected').data('sotype'));
        });

        $('#SOYearCode').change(function () {
            $('#CustOrderNo').val('0');


            if ($('#SONO').val() == '') {
                if ($('#SaleBillJobwork').val() == 'J') {
                    JWItemList($('#TypeItemServAssets').val());
                }
            } else {


                if ($('#SONO').find(':selected').data('sotype') == 'CLOSE') {
                    FillSOWiseItems();
                }
            }


            FILLCustomerOrderAndSPDate();
            FillSOItemRate();
            FillSOSchedule();

            if ($('#SOYearCode').val() == '0') {

                $('#Rate').prop("readonly", false);
                $('#RateInOtherCurr').prop("readonly", false);
            } else {
                // $('#Rate').prop("readonly", true);
                $('#RateInOtherCurr').prop("readonly", true);
            }
        });

        $('#TypeItemServAssets').change(function () {
            // FillItems($(this).val());
            JWItemList($(this).val());
        });

        function FillSOYearCode() {
            $.ajax({
                type: "POST",
                url: "@Url.Action("FillSOYearCode")",
                data: { "sono": $('#SONO').val(), "accountCode": $('#AccountCode').val() },
                dataType: "json",
                async: false,
                success: function (result, status, error) {

                    if (result != null) {
                        var obj = $.parseJSON(result);
                        $('#SOYearCode').empty();
                        $('#SOYearCode').append('<option value="0">-Select-</option>');
                        if (obj.StatusCode != 500) {
                            $.each(obj.Result, function (index, val) {
                                $('#SOYearCode').append("<option value=" + val.SOYearCode + ">" + val.SOYearCode + "</option>");
                            });
                        }
                    }

                    $('#SchNo,#SaleSchYearCode,#SOPendQty,#Rate').val(0);
                    $('#PartCode,#ItemCode').val(0).trigger("change");
                    $('#Batchno,#Uniquebatchno').val("");
                }
            });
        }

        $('#StoreId').change(function () {
            FillCurrentBatchINStore();
            FillTotalStock();
        });

        $('#Batchno').change(function (event) {

            event.preventDefault();
            FillUniqueBatchNo();
            FillTotalStock();
        });

        function FillUniqueBatchNo() {
            $.ajax({
                type: "POST",
                url: '@Url.Action("GetBatchNumber", "NRGP")',
                data: { StoreId: $('#StoreId').val(), StoreName: $('#StoreId').find(':selected').text(), ItemCode: $('#ItemCode').val(), TransDate: $('#SaleBillDate').val(), YearCode: $('#SaleBillYearCode').val(), BatchNo: $('#Batchno').val() },
                dataType: "json",
                async: false,
                success: function (result, status, error) {

                    $('#Uniquebatchno').empty();
                    $('#Uniquebatchno').append('<option value="0" selected>-Select-</option>');
                    if (result != null) {
                        var obj = $.parseJSON(result);
                        if (obj.StatusCode == 200 && obj.StatusText == 'Success') {
                            $.each(obj.Result, function (index, val) {
                                if ($("#Uniquebatchno option[value='" + val.UniqueBatchNo + "']").length == 0) {
                                    $('#Uniquebatchno').append('<option value="' + val.UniqueBatchNo + '" data-stock="' + val.stock + '" selected>' + val.UniqueBatchNo + '</option>');
                                }
                            });
                            FillLotStock();
                            // $('#DiscountAmt').val(0);
                            // $('#DiscountPer').val(0);
                        }
                    }

                },
                error: function (req, status, error) {
                    alert(error);
                }
            });
        }

        function BasicTotal() {
            var columnCount = $('#divSaleBillList tr td').length;
            //var taxRowCount = $('#divTaxGrid tr').length;
            sum = 0;
            var rowCount = $('#divSaleBillList tr').length;
            //noofitems
            if (columnCount > 1)
                $('#lblItemCount').text(rowCount);
            else
                $('#lblItemCount').text(0);

            for (var i = 1; i <= rowCount; i++) {

                sum += parseFloat($('#GridAmount-' + i).text() == '.00' ? 0 : $('#GridAmount-' + i).text());
            }

            $('#lblItemNetAmount').text(sum.toFixed(2));
            $('#BillAmt').val(sum.toFixed(2));
        }

        $('#Uniquebatchno').change(function () {

            FillLotStock();
        });

        var MinQtyVal = 0;
        var LowestStock = "";

        function SetminQty() {
            var TotalStock = parseFloat($('#TotalStock').val());
            var LotStock = parseFloat($('#LotStock').val());
            var LowestStock = parseFloat($('#SOPendQty').val());

          
           

             if ($('#SONO').val() != '' && $('#CustOrderNo').val() != '0') {
                 if (AllowedToDispatchQtyMoreThenCloseSOPendQty != 'Y') {
                if (parseFloat($('#Qty').val()) > LowestStock) {
                AddErrorCls('Qty');
                Err = 1;
                $.notify("Qty should less then " + LowestStock + "  ...!", "error");
                return false;
            }
            else {
                RemoveErrorCls('Qty');
            }
                 }
             }
            return true;
        }

        function FillLotStock() {

            $.ajax({
                type: "POST",
                url: "@Url.Action("FillLotStock", "StockAdjustment")",
                data: { ItemCode: $('#ItemCode').val(), StoreId: $('#StoreId').val(), TillDate: $('#SaleBillDate').val(), BatchNo: $('#Batchno').val(), UniqueBatchNo: $('#Uniquebatchno').val() },
                dataType: "json",
                async: false,
                success: function (result, status, error) {

                    if (result != null) {
                        var obj = $.parseJSON(result);
                        $('#LotStock').val($.parseJSON(result).Result[0].STOCK);
                        BatchStock = $.parseJSON(result).Result[0].STOCK;
                    }
                    // SetminQty();
                    CalculateAmount();
                }
            });
        }

        function FillLotStockForALl(i) {

            $.ajax({
                type: "POST",
                url: "@Url.Action("FillLotStock", "StockAdjustment")",
                data: { ItemCode: $('#ItemCode-' + i).val(), StoreId: $('#StoreId-' + i).val(), TillDate: $('#SaleBillDate').val(), BatchNo: $('#Batchno-' + i).val(), UniqueBatchNo: $('#Uniquebatchno-' + i).val() },
                dataType: "json",
                async: false,
                success: function (result, status, error) {

                    if (result != null) {
                        var obj = $.parseJSON(result);
                        $('#LotStock-' + i).val($.parseJSON(result).Result[0].STOCK);
                        BatchStock = $.parseJSON(result).Result[0].STOCK;
                    }
                    // SetminQty();
                    CalculateAmount();
                }
            });
        }

        function FillLotStockForGroupWiseItem(i) {

            $.ajax({
                type: "POST",
                url: "@Url.Action("FillLotStock", "StockAdjustment")",
                data: { ItemCode: $('#ItemCode-' + i).val(), StoreId: $('#MultiStoreName').val(), TillDate: $('#SaleBillDate').val(), BatchNo: $('#Batchno-' + i).val(), UniqueBatchNo: $('#Uniquebatchno-' + i).val() },
                dataType: "json",
                async: false,
                success: function (result, status, error) {

                    if (result != null) {
                        var obj = $.parseJSON(result);
                        $('#LotStock-' + i).val($.parseJSON(result).Result[0].STOCK);
                        BatchStock = $.parseJSON(result).Result[0].STOCK;
                    }
                    // SetminQty();
                    CalculateAmount();
                }
            });
        }

        function DiscountPerCalculation() {

            CalculateAmount();
            var discountPerVal = $('#DiscountPer').val() == '' ? 0 : parseFloat($('#DiscountPer').val());
            var discountPer = parseFloat(discountPerVal);
            if (discountPer != 0) {
                var amount = $('#Amount').val() == "" ? 0 : parseFloat($('#Amount').val());
                $('#DiscountAmt').val((discountPer * amount / 100).toFixed(2));
                var discountAmt = $('#DiscountAmt').val() == "" ? 0 : parseFloat($('#DiscountAmt').val()).toFixed(2);
                var finalAmount = (amount - discountAmt).toFixed(2);
                $('#ItemAmount').val(finalAmount);
                // $('#Amount').val($('#Amount').val() - $('#DiscountAmt').val());
            } else {
                $('#DiscountAmt').val(0);
            }
        }

        function DiscountAmtCalculation() {

            CalculateAmount();
            var discAmtVal = $('#DiscountAmt').val() == '' ? 0 : parseFloat($('#DiscountAmt').val());
            var discAmt = parseFloat(discAmtVal);
            if (discAmt != 0) {
                var amount = $('#Amount').val() == "" ? 0 : parseFloat($('#Amount').val());
                $('#DiscountPer').val((discAmt * 100 / amount).toFixed(2));
                var discountPer = $('#DiscountPer').val() == "" ? 0 : parseFloat($('#DiscountPer').val());
                var finalAmount = (amount - discountPer).toFixed(2);
                $('#ItemAmount').val(finalAmount);
                // $('#Amount').val($('#Amount').val() - $('#DiscountAmt').val());
            } else {
                $('#DiscountPer').val(0);
            }
        }

        // $('#DiscountPer,#DiscountAmt').on('input', function () {
        //     let value = $(this).val();
        //     if (/^\d+(\.\d{0,2})?$/.test(value)) {

        //     } else {

        //         $(this).val(value.slice(0, value.indexOf('.') + 3));
        //     }
        // });

        $('#DiscountAmt').change(function () {
            DiscountAmtCalculation();
        });

        $('#DiscountPer').change(function () {
            DiscountPerCalculation();
        });

        $('#RejectedQty').change(function () {
            DiscountPerCalculation();
        });

        function FillTotalStock() {
            $.ajax({
                type: "POST",
                url: "@Url.Action("GetStoreTotalStock", "NRGP")",
                data: { ItemCode: $('#ItemCode').val(), StoreId: $('#StoreId').val(), TillDate: $('#SaleBillDate').val() },
                dataType: "json",
                success: function (result, status, error) {
                    if (result != null) {
                        var obj = $.parseJSON(result);
                        $('#TotalStock').val(obj.Result[0].STOCK);
                    }
                }
            });
        }

        function FillTotalStockForAll(i) {
            $.ajax({
                type: "POST",
                url: "@Url.Action("GetStoreTotalStock", "NRGP")",
                data: { ItemCode: $('#ItemCode-' + i).val(), StoreId: $('#StoreId-' + i).val(), TillDate: $('#SaleBillDate').val() },
                dataType: "json",
                success: function (result, status, error) {
                    if (result != null) {
                        var obj = $.parseJSON(result);
                        $('#TotalStock-' + i).val(obj.Result[0].STOCK);
                    }
                }
            });
        }

        function FillTotalStockForGroupWiseItem(i) {
            $.ajax({
                type: "POST",
                url: "@Url.Action("GetStoreTotalStock", "NRGP")",
                data: { ItemCode: $('#ItemCode-' + i).val(), StoreId: $('#MultiStoreName').val(), TillDate: $('#SaleBillDate').val() },
                dataType: "json",
                success: function (result, status, error) {
                    if (result != null) {
                        var obj = $.parseJSON(result);
                        $('#TotalStock-' + i).val(obj.Result[0].STOCK);
                    }
                }
            });
        }

        function FillCurrentBatchINStore() {

            var ItemCode = $('#ItemCode').val();
            var YearCode = $('#SaleBillYearCode').val();
            var StoreName = $('#StoreId').find(':selected').text();
            var batchno = "";
            if ($('#Batchno').prop('selectedIndex') != 0) {
                batchno = $('#Batchno').val();
            }
            $.ajax({
                type: "POST",
                url: "@Url.Action("FillCurrentBatchINStore", "NRGP")",
                data: { "ItemCode": ItemCode, "YearCode": YearCode, "StoreName": StoreName, "batchno": batchno },
                dataType: "json",
                async: false,
                success: function (result, status, error) {
                    if (result != null) {
                        var obj = $.parseJSON(result);
                        if (obj.StatusCode == 200 && obj.StatusText == 'Success') {
                            $('#Batchno').empty();
                            $('#Batchno').append('<option value="0" selected>-Select-</option>');

                            var seenValues = {};
                            $.each(obj.Result, function (index, val) {
                                if (!seenValues[val.batchno]) {
                                    seenValues[val.batchno] = true;
                                    $('#Batchno').append('<option value="' + val.batchno + '">' + val.batchno + '</option>');
                                }
                            });


                            GetBatchInventory();

                            var selectListLength = $('#Batchno option').length - 1;
                            var itemArrayLength = itemBatchArray.length;
                            if (itemArrayLength > 0) {
                                var itemsWithCode16 = itemBatchArray.filter(function (item) {
                                    return item.itemcode === parseInt(ItemCode);
                                });
                                var selectList = $('#Batchno');
                                selectList.find('option').each(function () {
                                    var optionValue = $(this).val();
                                    var existsInItemsWithCode16 = itemsWithCode16.some(function (item) {
                                        return item.batchno === optionValue;
                                    });

                                    if (existsInItemsWithCode16) {
                                        $(this).remove();
                                    }
                                });

                                //}
                                //if (itemBatchArray.length > 0) {
                                //    $('#BatchNo option[value="' + itemBatchArray[0].batchno + '"]').remove();
                                //    $('#uniquebatchno option[value="' + itemBatchArray[0].uniquebatchno + '"]').remove();
                                //}
                            }
                        } else {
                            $('#Batchno').empty();
                            $('#Batchno').append('<option value="0" disabled selected>-Select-</option>');
                            $('#Uniquebatchno').empty();
                            $('#Uniquebatchno').append('<option value="0" disabled selected>-Select-</option>');
                        }

                    }
                }
            });
        }


        function FillCurrentBatchINStoreForALl(i) {

            var ItemCode = $('#ItemCode-' + i).val();
            var YearCode = $('#SaleBillYearCode').val();
            var StoreName = $('#StoreName-' + i).val();
            var batchno = "";
            if ($('#Batchno-' + i).prop('selectedIndex') != 0) {
                batchno = $('#Batchno').val();
            }
            $.ajax({
                type: "POST",
                url: "@Url.Action("FillCurrentBatchINStore", "NRGP")",
                data: { "ItemCode": ItemCode, "YearCode": YearCode, "StoreName": StoreName, "batchno": batchno },
                dataType: "json",
                async: false,
                success: function (result, status, error) {
                    if (result != null) {
                        var obj = $.parseJSON(result);
                        if (obj.StatusCode == 200 && obj.StatusText == 'Success') {
                            $('#Batchno-' + i).empty();
                            $('#Batchno-' + i).append('<option value="0" selected>-Select-</option>');

                            var seenValues = {};
                            $.each(obj.Result, function (index, val) {
                                if (!seenValues[val.batchno]) {
                                    seenValues[val.batchno] = true;
                                    $('#Batchno-' + i).append('<option value="' + val.batchno + '">' + val.batchno + '</option>');
                                }
                            });


                            GetBatchInventory();



                        } else {
                            $('#Batchno-' + i).empty();
                            $('#Batchno-' + i).append('<option value="0" disabled selected>-Select-</option>');
                            $('#Uniquebatchno-' + i).empty();
                            $('#Uniquebatchno-' + i).append('<option value="0" disabled selected>-Select-</option>');
                        }

                    }
                }
            });
        }



        function FillSOSchedule() {
            $.ajax({
                type: "POST",
                url: "@Url.Action("FillSOSchedule")",
                data: { "sono": $('#SONO').val(), "accountCode": $('#AccountCode').val(), "soYearCode": $('#SOYearCode').val(), "ItemCode": $('#ItemCode').val() },
                dataType: "json",
                async: false,
                success: function (result, status, error) {

                    if (result != null) {
                        var obj = $.parseJSON(result);
                        $('#SchNo').empty();
                        $('#SchNo').append('<option value="0">-Select-</option>');
                        if (obj.StatusCode != 500) {
                            $.each(obj.Result, function (index, val) {
                                $('#SchNo').append("<option value=" + val.ScheduleNo + ">" + val.ScheduleNo + "</option>");
                            });
                        }
                    }
                }
            });
        }

        function FillSchYearCode() {
            $.ajax({
                type: "POST",
                url: "@Url.Action("FillSOSchedule")",
                data: { "sono": $('#SONO').val(), "accountCode": $('#AccountCode').val(), "soYearCode": $('#SOYearCode').val(), "ItemCode": $('#ItemCode').val() },
                dataType: "json",
                async: false,
                success: function (result, status, error) {
                    if (result != null) {
                        var obj = $.parseJSON(result);
                        $('#SaleSchYearCode').empty();
                        $('#SaleSchYearCode').append('<option value="0">-Select-</option>');
                        if (obj.StatusCode != 500) {
                            // $.each(obj.Result, function (index, val) {
                            //     $('#SaleSchYearCode').append("<option value=" + val.SchYearCode + ">" + val.SchYearCode + "</option>");
                            // });

                            let uniqueYears = new Set();

                            $.each(obj.Result, function (index, val) {
                                uniqueYears.add(val.SchYearCode);
                            });

                            uniqueYears.forEach(function (year) {
                                $('#SaleSchYearCode').append("<option value='" + year + "'>" + year + "</option>");
                            });
                        }
                    }
                }
            });
        }

        $('#SaleSchYearCode').change(function () {
            $.ajax({
                type: "POST",
                url: "@Url.Action("FILLSOScheduleDate")",
                data: { "sono": $('#SONO').val(), "accountCode": $('#AccountCode').val(), "soYearCode": $('#SOYearCode').val(), "SchNo": $('#SchNo').val(), "schYearCode": $('#SaleSchYearCode').val() },
                dataType: "json",
                // async:false,
                success: function (result, status, error) {

                    if (result != null) {
                        var obj = $.parseJSON(result);
                        if (obj.StatusCode != 500) {
                            $('#Schdate').val("");
                            var scheduleDate = obj.Result[0].ScheduleDate;
                            var dateOnly = new Date(scheduleDate);

                            // Format to dd/MM/yyyy
                            var day = ('0' + dateOnly.getDate()).slice(-2);
                            var month = ('0' + (dateOnly.getMonth() + 1)).slice(-2);
                            var year = dateOnly.getFullYear();

                            var formattedDate = day + '/' + month + '/' + year;

                            $('#Schdate').val(formattedDate);
                        }

                        // if ($('#SaleBillJobwork').val() == 'J') {
                        //     JWItemList($('#TypeItemServAssets').val());
                        // } else {
                        //     if ($('#SONO').find(':selected').data('sotype') == 'OPEN') {
                        //         FillSOWiseItems();
                        //     }
                        // }

                        if ($('#SONO').val() == '') {
                            if ($('#SaleBillJobwork').val() == 'J') {
                                JWItemList($('#TypeItemServAssets').val());
                            }
                        } else {

                            if ($('#SONO').find(':selected').data('sotype') == 'OPEN') {
                                FillSOWiseItems();
                            }
                        }
                    }
                }
            });
        });

        function FillConsigneeList(ShowAllConsignee) {
            var ShowAllConsignee = ShowAllConsignee == "" ? "N" : "Y";
            $.ajax({
                type: "POST",
                url: "@Url.Action("FillConsigneeList")",
                data: { "showAllConsignee": ShowAllConsignee },
                dataType: "json",
                success: function (result, status, error) {

                    if (result != null) {
                        var obj = $.parseJSON(result);
                        $('#ConsigneeAccountcode').empty();
                        $('#ConsigneeAccountcode').append('<option value="0">-Select-</option>');
                        if (obj.StatusCode != 500) {
                            $.each(obj.Result, function (index, val) {
                                $('#ConsigneeAccountcode').append("<option value=" + val.Account_code + ">" + val.CustomeName + "</option>");
                            });

                            if ($('#Mode').val() == "U" || $('#Mode').val() == "V") {
                                $('#ConsigneeAccountcode').val($('#hiddenConsigneeAC').val());
                            }
                        }
                    }
                }
            });
        }

        function GetServerDate() {
            $.ajax({
                type: "GET",
                url: "@Url.Action("GetServerDate", "WorkOrder")",
                async: false,
                success: function (result, status, error) {
                    var FinFromDate = parseDateToFormat($('#FinFromDate').val().split(" ")[0]);
                    var FinToDate = parseDateToFormat($('#FinToDate').val().split(" ")[0]);

                    if ($('#Mode').val() != "U" && $('#Mode').val() != "V") {
                        $('#SaleBillEntryDate').datepicker({ dateFormat: 'dd/mm/yy' }).datepicker("setDate", result);
                        $('#SaleBillDate').datepicker({ dateFormat: 'dd/mm/yy' }).datepicker("setDate", result);
                        $('#SaleBillEntryDate,#SaleBillDate').datepicker("option", "minDate", FinFromDate);
                        $('#SaleBillEntryDate,#SaleBillDate').datepicker("option", "maxDate", FinToDate);
                        $('#SaleBillDate').prop("disabled", false);
                        $('#ActualEntryDate').datepicker({ dateFormat: 'dd/mm/yy' }).datepicker("setDate", result);
                        $('#GRDate').datepicker({ dateFormat: 'dd/mm/yy' }).datepicker("setDate", result);
                               $('#CourierDate').datepicker({ dateFormat: 'dd/mm/yy' }).datepicker("setDate", result);
                    } else {
                        // let d = $('#SaleBillEntryDate').val().split(" ")[0].split("-");
                        // // $('#SaleBillEntryDate').datepicker({ dateFormat: 'dd/mm/yy' })
                        // //     .datepicker("setDate", parseDateToFormat(`${d[1]}-${d[0]}-${d[2]}`));
                        // $('#SaleBillEntryDate').datepicker({ dateFormat: 'dd/mm/yy' })
                        //     .datepicker("setDate", parseDateToFormat($('#SaleBillEntryDate').val()));
                        // $('#SaleBillDate').datepicker({ dateFormat: 'dd/mm/yy' })
                        //     .datepicker("setDate", parseDateToFormat($('#hiddenSaleBillDate').val()));
                        // let hiddenDate = $('#hiddenSaleBillDate').val().split(" ")[0];
                        // $('#SaleBillDate').datepicker({ dateFormat: 'dd/mm/yy' })
                        //     .datepicker("setDate", hiddenDate);
                        // $('#ActualEntryDate').datepicker({ dateFormat: 'dd/mm/yy' })
                        //     .datepicker("setDate", parseDateToFormat($('#ActualEntryDate').val()));

                        // var currentYear = getFinancialYear();
                        // if ($('#SaleBillYearCode').val() == currentYear) {
                        //     $('#SaleBillDate').prop("disabled", false);
                        // } else {
                        //     $('#SaleBillDate').prop("disabled", true);
                        // }
                    }

                    // Other dates default set to server date
                    $('#PerformaInvDate').datepicker({ dateFormat: 'dd/mm/yy' }).datepicker("setDate", result);
                    $('#RemovalDate').datepicker({ dateFormat: 'dd/mm/yy' }).datepicker("setDate", result);
                    $('#SoDelTime').datepicker({ dateFormat: 'dd/mm/yy' }).datepicker("setDate", result);
                    $('#Shippingdate').datepicker({ dateFormat: 'dd/mm/yy' }).datepicker("setDate", result);
                    $('#Canceldate').datepicker({ dateFormat: 'dd/mm/yy' }).datepicker("setDate", result);
                    $('#Schdate').datepicker({ dateFormat: 'dd/mm/yy' }).datepicker("setDate", result);
                    $('#SOAmendDate').datepicker({ dateFormat: 'dd/mm/yy' }).datepicker("setDate", result);
                    $('#AdviseDate').datepicker({ dateFormat: 'dd/mm/yy' }).datepicker("setDate", result);
                    $('#AgaisntProdPlanDate').datepicker({ dateFormat: 'dd/mm/yy' }).datepicker("setDate", result);
                    $('#ProdSchDate').datepicker({ dateFormat: 'dd/mm/yy' }).datepicker("setDate", result);
                    $('#SchdeliveryDate').datepicker({ dateFormat: 'dd/mm/yy' }).datepicker("setDate", result);

                    $('#SaleQuotDate').datepicker({ dateFormat: 'dd/mm/yy' }).datepicker("setDate", result);
                    $('#ChallanDate').datepicker({ dateFormat: 'dd/mm/yy' }).datepicker("setDate", result);
                    $('#ApprovDate').datepicker({ dateFormat: 'dd/mm/yy' }).datepicker("setDate", result);

                    // =========================
                    // ✅ Restrict Removal Date
                    // =========================
                    var saleBillDate = $('#SaleBillDate').datepicker('getDate');
                    let minRemovalDate = new Date(saleBillDate);
                    let maxRemovalDate = addDays(saleBillDate, 1);

                    $('#RemovalDate').datepicker("option", "minDate", minRemovalDate);
                    $('#RemovalDate').datepicker("option", "maxDate", maxRemovalDate);

                    // If RemovalDate is outside range → reset to SaleBillDate
                    let currentRemoval = $('#RemovalDate').datepicker("getDate");
                    if (!currentRemoval || currentRemoval < minRemovalDate || currentRemoval > maxRemovalDate) {
                        $('#RemovalDate').datepicker("setDate", saleBillDate);
                    }

                    // AdjDueDate cannot be less than SaleBillDate
                    $('#AdjDueDate').datepicker("option", "minDate", ($('#SaleBillDate').val()).split(" ")[0]);
                }
            });

            function addDays(date, days) {
                var result = new Date(date);
                result.setDate(result.getDate() + days);
                return result;
            }
        }

        function getFinancialYear() {
            const today = new Date();
            const year = today.getFullYear();
            const month = today.getMonth() + 1;

            return month < 4 ? year - 1 : year;
        }

        $('#SaleBillEntryDate').change(function () {
            let entryDate = $(this).datepicker("getDate");
            $('#SaleBillDate').datepicker("setDate", entryDate);

            $('#AdjDueDate').datepicker("option", "minDate", entryDate);

            let minRemovalDate = new Date(entryDate);
            let maxRemovalDate = new Date(entryDate);
            maxRemovalDate.setDate(maxRemovalDate.getDate() + 1);

            $('#RemovalDate').datepicker("option", "minDate", minRemovalDate);
            $('#RemovalDate').datepicker("option", "maxDate", maxRemovalDate);

            let currentRemoval = $('#RemovalDate').datepicker("getDate");
            if (!currentRemoval || currentRemoval < minRemovalDate || currentRemoval > maxRemovalDate) {
                $('#RemovalDate').datepicker("setDate", entryDate);
            }
        });

        $('#SaleBillDate').change(function () {

            

            

            let billDate = $(this).datepicker("getDate");
            $('#SaleBillEntryDate').datepicker("setDate", billDate);

            // Set minDate for AdjDueDate = SaleBillDate
            $('#AdjDueDate').datepicker("option", "minDate", billDate);

            // Restrict RemovalDate between SaleBillDate and SaleBillDate + 1 day
            let minRemovalDate = new Date(billDate);
            let maxRemovalDate = new Date(billDate);
            maxRemovalDate.setDate(maxRemovalDate.getDate() + 1);

            $('#RemovalDate').datepicker("option", "minDate", minRemovalDate);
            $('#RemovalDate').datepicker("option", "maxDate", maxRemovalDate);

            // If current RemovalDate is outside range → reset to SaleBillDate
            let currentRemoval = $('#RemovalDate').datepicker("getDate");
            if (!currentRemoval || currentRemoval < minRemovalDate || currentRemoval > maxRemovalDate) {
                $('#RemovalDate').datepicker("setDate", billDate);
            }
        });

        $('#RemovalDate').change(function () {
            ClearGrid();
            btnClearTax();
            ClearAdjustmentGrid();
            ClearDRCRGrid();
            ClearCustomerJWGrid();
        });

        function ClearCustomerJWGrid() {
            $.ajax({
                type: "POST",
                url: "@Url.Action("ClearCustomerJWGrid")",
                success: function (result, status, error) {
                    $('#divCustJobWorkISsueSummary').empty();
                    $('#divBomCustJobWorkISsueSummary').empty();
                    var NoData = '<tr class="text-center"><td colspan="32" class="text-black-50"><strong>NO DATA ADDED</strong></td></tr>';
                    $('#divCustJobWorkISsueSummary').html(NoData);
                    $('#divBomCustJobWorkISsueSummary').html(NoData);
                },
                error: function (req, status, error) {
                    alert(error);
                }
            });
        }

        function PressBack() {

            sessionStorage.setItem('FromDateBack', $('#FromDateBack').val());
            sessionStorage.setItem('ToDateBack', $('#ToDateBack').val());
            sessionStorage.setItem('PartCodeBack', $('#PartCodeBack').val());
            sessionStorage.setItem('ItemNameBack', $('#ItemNameBack').val());
            sessionStorage.setItem('SaleBillNoBack', $('#SaleBillNoBack').val());
            sessionStorage.setItem('CustNameBack', $('#CustNameBack').val());
            sessionStorage.setItem('SonoBack', $('#SonoBack').val());
            sessionStorage.setItem('CustOrderNoBack', $('#CustOrderNoBack').val());
            sessionStorage.setItem('SchNoBack', $('#SchNoBack').val());
            sessionStorage.setItem('PerformaInvNoBack', $('#PerformaInvNoBack').val());
            sessionStorage.setItem('SaleQuoteNoBack', $('#SaleQuoteNoBack').val());
            sessionStorage.setItem('DomesticExportNEPZBack', $('#DomesticExportNEPZBack').val());
            sessionStorage.setItem('SearchBoxBack', $('#SearchBoxBack').val());
            sessionStorage.setItem('SummaryDetailBack', $('#SummaryDetailBack').val());

            window.history.back();
        }

    </script>
    <script src="https://cdn.jsdelivr.net/gh/linways/table-to-excel@v1.0.4/dist/tableToExcel.js"></script>

    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />

    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.2/xlsx.full.min.js"></script>
    @*<script src="~/Scripts/table2excel.js"></script>*@
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.16.9/xlsx.full.min.js"></script>


    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">



}


