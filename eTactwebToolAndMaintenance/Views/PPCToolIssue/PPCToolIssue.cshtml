@model eTactWeb.DOM.Models.PPCToolIssueMainModel


@{
    ViewData["Title"] = "PPCToolIssue";
    Layout = "~/Views/Shared/_LayoutMain.cshtml";
}
<style>
    #ReqWithoutBom th {
        background-color: #127387;
        position: sticky;
        top: -15px;
        z-index: 1;
    }

    .select2-container--default .select2-selection--single {
        background-color: #e0f2f1;
        border: 1.5px solid #0a0a0a !important;
        border-radius: 4px;
    }

        .select2-container--default .select2-selection--single .select2-selection__rendered {
            /* border-bottom: 1.5px solid #000 !important; */
            border-bottom: none !important;
        }

    .select2-container--default .select2-results > .select2-results__options {
        background-color: #e0f2f1; /* Dropdown background color */
        color: #000;
    }
</style>


<div class="card bg-gradient mb-3 border-light shadow-lg">
    <form asp-action="InsertToolIssue" method="post" id="toolIssueForm" autocomplete="off" class="form-horizontal">
        <div class="card-header card-headerBG text-light bg-gradient">
            <h5>
                <strong>PPC Tool Issue</strong>
                <span class="d-flex float-end" style="margin-top:-2px;">
                    <div class="col-auto">
                       
                        <a type="button" class="btn btn-sm btn-outline-light bg-gradient" asp-action="PrintReport"
                           asp-controller="PPCToolIssue" asp-route-EntryId="" asp-route-YearCode="" target="_blank">
                            <i class="fa fa-pencil-square fa-fw fa-lg" aria-hidden="true"></i>
                            PRINT
                        </a>
                    </div>
                    <a asp-action="Dashboard" asp-route-FromDate="@DateTime.Now.AddDays(1 - DateTime.Now.Day);" asp-route-Todate="@DateTime.Today" asp-route-Flag="True" class="btn btn-sm btn-outline-light bg-gradient">
                        <i class="fa-solid fa-grip fa-lg fa-fw fa-beat" style="--fa-animation-duration: 2s;"></i>
                        Dashboard
                    </a>
                    @*<partial name="_FormsButton" />*@
                    <div class="row justify-content-between g-2">
                        <div class="col-auto">
                           
                            <a href="#" class=" btn btn-primary btn-sm" onclick="PressBack();">
                                <i class="fa fa-chevron-circle-left fa-fw fa-lg" aria-hidden="true"></i>
                                BACK
                            </a>
                        </div>
                        @if (Model.Mode != "V")
                        {
                            <div class="col-auto">
                                @*  <a class="btn btn-sm btn-outline-danger" onclick="location.href=$('form')[0].action">*@
                                <a class="btn btn-secondary btn-sm" onclick="location.href=$('form')[0].action">
                                    @* <i class="fa-solid fa-grip fa-lg fa-fw fa-beat" style="--fa-animation-duration: 2s;"></i>*@
                                    <i class="fa fa-refresh fa-fw fa-lg" aria-hidden="true"></i>
                                    REFRESH
                                </a>
                            </div>
                            @if (Model.Mode == "U")
                            {
                                @*Model.Mode = "U";*@
                                <div class="col-auto">
                                    @* <button type="submit" class="btn btn-sm btn-outline-warning">*@
                                    <button type="submit" class="btn btn-sm btn-outline-light bg-gradient" id="UpdateButton">
                                        <i class="fa fa-pencil-square fa-fw fa-lg" aria-hidden="true"></i>
                                        UPDATE
                                    </button>
                                </div>
                            }

                            else
                            {
                                <div class="col-auto">
                                    @*   <button type="submit" class="btn btn-sm btn-outline-primary">*@
                                    <button type="submit" class="btn btn-primary btn-sm" id="submitBTN">
                                        <i class="fa-solid fa-chevron-circle-right"></i>
                                        SUBMIT
                                    </button>
                                </div>
                            }
                        }
                    </div>
                </span>
            </h5>
        </div>
        <div class="card-body bg-light pt-0">
            <div class="accordion shadow-lg">
                <div class="accordion-item" id="GI_Grid">
                    <h2 class="accordion-header" id="H_RParameter">
                        <button class="accordion-button text-light pnl1BG bg-gradient" type="button" data-bs-toggle="collapse" data-bs-target="#B_RParameter" aria-expanded="true" aria-controls="B_RParameter">
                            <i class="fa-brands fa-wpforms fa-lg fa-fw pr35"></i>
                            Required Parameter
                        </button>
                    </h2>
                    <div id="B_RParameter" class="accordion-collapse collapse show pnl1 bg-gradient" aria-labelledby="H_RParameter">
                        <div class="accordion-body">
                            <div class="row g-2 gx-3">
                                <input type="hidden" name="Mode" value="@Model.Mode" />
                                <div class="col-lg-2">
                                    <label asp-for="ToolIssueEntryId" class="form-label">Entry Id</label>
                                    <input asp-for="ToolIssueEntryId" id="ToolIssueEntryId" class="form-control" readonly />
                                </div>
                                <div class="col-lg-2">
                                    <label asp-for="ToolIssueYearCode" class="form-label">Year Code</label>
                                    <input asp-for="ToolIssueYearCode" id="ToolIssueYearCode" class="form-control" readonly />
                                </div>
                                <div class="col-lg-2">
                                    <label asp-for="ToolIssueEntryDate" class="form-label">Entry Date</label>
                                    <input asp-for="ToolIssueEntryDate" id="EntryDate" class="form-control datepicker" type="text" readonly />
                                </div>

                                <div class="col-lg-2">
                                    <label asp-for="ToolIssueDate" class="form-label">Issue Date</label>
                                    <input asp-for="ToolIssueDate" id="IssueDate" class="form-control datepicker" type="text" readonly />
                                </div>

                                <div class="col-lg-2">
                                    <label asp-for="ToolIssueSlipNo" class="form-label">Slip No</label>
                                    <input asp-for="ToolIssueSlipNo" id="ToolIssueSlipNo" class="form-control" readonly />
                                </div>
                                <div class="col-lg-2">
                                    <label asp-for="IssueToDepartmentId" class="form-label">Issue To Dept</label>
                                    <select name="IssueToDepartmentId" asp-for="IssueToDepartmentId" id="IssueToDepartmentId" class="form-select">
                                        <option value="">-- Select Department --</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="accordion-item">
                        <h2 class="accordion-header" id="H_SAGrid">
                            <button class="accordion-button collapsed text-light pnl4BG bg-gradient" type="button" data-bs-toggle="collapse" data-bs-target="#B_ToolGrid" aria-expanded="true" aria-controls="B_ToolGrid">
                                <strong style="text-transform:uppercase"><i class="fa-solid fa-table-list fa-lg fa-fw pr35 fa-fade" style="--fa-animation-duration: 2s; --fa-fade-opacity: 0.6;"></i>Req Item Grid</strong>
                            </button>
                        </h2>

                        <div id="B_ToolGrid" class="accordion-collapse collapse pnl4 bg-gradient " aria-labelledby="H_ToolGrid">
                            <div class="accordion-body ">

                                <!-- 🔹 Input Form Row -->
                                <div class="card  mb-3">
                                    <div class="card-body overflow-auto">
                                        <table class="table table-hover table-bordered">
                                            <thead class="bg-gradient card-headerBG text-light small">
                                                <tr>
                                                    <th style="min-width: 150px;color:red">Tool Name *</th>
                                                    <th style="min-width: 150px;">Barcode</th>
                                                    <th style="min-width: 150px;">Serial No</th>
                                                    <th style="min-width: 150px;">Tool Type</th>
                                                    <th style="min-width: 60px;color:red">Issue Qty *</th>
                                                    <th style="min-width: 60px;">Unit</th>
                                                    <th style="min-width: 150px;">Current Location</th>
                                                    <th style="min-width: 150px;color:red">Issue To Location *</th>
                                                    <th style="min-width: 150px;">Tool Condition</th>
                                                    <th style="min-width: 150px;">Last Calibration</th>
                                                    <th style="min-width: 150px;">Next Calibration Due</th>
                                                    <th style="min-width: 150px;">Remaining Life (Months)</th>
                                                    <th style="min-width: 150px;">Prod Plan No</th>
                                                    <th style="min-width: 100px;">Prod Plan YearCode</th>
                                                    <th style="min-width: 150px;">Prod Plan Date</th>
                                                    <th style="min-width: 70px;">Prod Plan ID</th>
                                                    <th style="min-width: 150px;">Prod Sch No</th>
                                                    <th style="min-width: 150px;">Prod Sch Date</th>
                                                    <th style="min-width: 150px;">For Machine</th>
                                                    <th style="min-width: 150px;">Special Instruction</th>
                                                    <th style="min-width: 150px;">Consumed/Returned</th>
                                                </tr>
                                            </thead>
                                            <tbody id="inputRow">
                                                <tr>
                                                    <input type="hidden" id="SeqNo" value="" />
                                                    <td>

                                                        <select name="ToolIssueDetails[0].ToolEntryId" id="ToolEntryId" class="form-select">
                                                            <option value="">-- Select Option --</option>
                                                        </select>
                                                    </td>
                                                    <td>
                                                        <select name="ToolIssueDetails[0].BarCode" id="BarCode" class="form-select">
                                                            <option value="">-- Select Barcode --</option>
                                                        </select>
                                                    </td>
                                                    <td>
                                                        <select name="ToolIssueDetails[0].SerialNo" id="SerialNo" class="form-select">
                                                            <option value="">-- Select SerialNo --</option>
                                                        </select>
                                                    </td>
                                                    <td><input name="ToolIssueDetails[0].ToolType" id="ToolType" class="form-control" disabled placeholder="Enter Tool Type" /></td>
                                                    <td><input name="ToolIssueDetails[0].IssueQty" type="text" id="IssueQty" inputmode="numeric" class="form-control" pattern="[0-9]*" placeholder="0" oninput="this.value = this.value.replace(/[^0-9]/g, '')" /></td>
                                                    <td><input name="ToolIssueDetails[0].Unit" id="Unit" class="form-control" disabled /></td>
                                                    <td><input name="ToolIssueDetails[0].CurrentLocation" id="CurrentLocation" class="form-control" placeholder="Enter Current Location" /></td>
                                                    <td><input name="ToolIssueDetails[0].IssueToLocation" id="IssueToLocation" class="form-control" placeholder="Enter Issue To Location" /></td>
                                                    <td><input name="ToolIssueDetails[0].ToolCondition" id="ToolCondition" class="form-control" placeholder="Enter Tool Condition" /></td>
                                                    <td><input name="ToolIssueDetails[0].LastCalibrationDate" id="LastCalibrationDate" disabled class="form-control datepicker" placeholder="Select Last Calibration Date" /></td>
                                                    <td><input name="ToolIssueDetails[0].NextCalibrationDueDate" id="NextCalibrationDueDate" disabled class="form-control datepicker" placeholder="Select Next Calibration Date" /></td>
                                                    <td><input name="ToolIssueDetails[0].RemainingToolLifeInMonths" id="RemainingToolLifeInMonths" disabled class="form-control" placeholder="Enter Remaining Life (Months)" /></td>
                                                    <td>
                                                        <select name="ToolIssueDetails[0].ProdPlanNo" id="ProdPlanNo" class="form-select">
                                                            <option value="">-- Select Prod Plan --</option>
                                                        </select>
                                                    </td>
                                                    <td><input name="ToolIssueDetails[0].ProdPlanYearCode" id="ProdPlanYearCode" class="form-control" placeholder="Enter ProdPlan YearCode" /></td>
                                                    <td><input name="ToolIssueDetails[0].ProdPlandate" id="ProdPlanDate" class="form-control datepicker" placeholder="Select Production Plan Date" /></td>
                                                    <td><input name="ToolIssueDetails[0].ProdPlanEntryId" id="ProdPlanEntryId" class="form-control" placeholder="Plan ID" /></td>

                                                    <td><input name="ToolIssueDetails[0].ProdSchNo" id="ProdSchNo" class="form-control" placeholder="Enter Production Schedule No" /></td>
                                                    <td><input name="ToolIssueDetails[0].ProdSchDate" id="ProdSchDate"  class="form-control" placeholder="Select Production Schedule Date" /></td>
                                                    <td>
                                                        <select name="ToolIssueDetails[0].ForMachineId" id="ForMachineId" class="form-select">
                                                            <option value="">-- Select Machine --</option>
                                                        </select>
                                                    </td>
                                                    <td><input name="ToolIssueDetails[0].SpecialInstruction" id="SpecialInstruction" class="form-control" placeholder="Enter Special Instruction" /></td>
                                                    <td>
                                                        <select name="ToolIssueDetails[0].WillBeConsumedOrReturned" id="WillBeConsumedOrReturned" class="form-select">
                                                            <option value="">-- Select Option --</option>
                                                            <option value="Returned">Returned</option>
                                                            <option value="Consumed">Consumed</option>
                                                        </select>
                                                    </td>
                                                </tr>
                                            </tbody>


                                        </table>
                                    </div>
                                </div>

                                <!-- 🔹 Add to Grid Button -->
                                <div class="col-4 col-auto">
                                    <div class="row justify-content-around">
                                        <div class="col-auto">
                                            <button type="button" class="GridButton btn btn-sm btn-outline-danger mt-3">
                                                <i class="fa-solid fa-angles-down fa-fw fa-lg"></i> ADD TO GRID
                                            </button>
                                        </div>
                                    </div>
                                </div>

                                <div class="progress my-2 mb-3" style="height: 4px;">
                                    <div class="progress-bar progress-bar-striped bg-secondary progress-bar-animated"
                                         role="progressbar" style="width: 100%" aria-valuenow="100"
                                         aria-valuemin="0" aria-valuemax="100"></div>
                                </div>

                                <!-- 🔹 Added Items Grid -->
                                <div class="card">
                                    <div class="card-body overflow-auto pb-0">
                                        <table class="table table-hover table-bordered table-striped" id="table">
                                            <thead class="bg-gradient card-headerBG text-light small" style="white-space:nowrap">
                                                <tr>
                                                    <th>Sq No</th>
                                                    <th>Action</th>
                                                    <th>Tool Name</th>
                                                    <th>Barcode</th>
                                                    <th>Serial No</th>
                                                    <th>Tool Type</th>
                                                    <th>Issue Qty</th>
                                                    <th>Unit</th>
                                                    <th>Current Location</th>
                                                    <th>Issue To Location</th>
                                                    <th>Tool Condition</th>
                                                    <th>Last Calibration</th>
                                                    <th>Next Calibration Due</th>
                                                    <th>Remaining Life</th>
                                                    <th>Prod Plan No</th>
                                                    <th>Prod Plan YearCode</th>
                                                    <th>Prod Plan Date</th>
                                                    <th>Prod Plan ID</th>
                                                    <th>Prod Sch No</th>
                                                    <th>Prod Sch Date</th>
                                                    <th>For Machine</th>
                                                    <th>Special Instruction</th>
                                                    <th>Consumed/Returned</th>
                                                    <th>Pending Status</th>
                                                    <th>Pending Qty</th>
                                                </tr>
                                            </thead>
                                           <tbody id="divToolIssueAdded">
                                                @await Html.PartialAsync("_PPCToolIssueGrid", Model.ToolIssueDetails)
                                           </tbody>
                                        </table>
                                    </div>
                                </div>

                            </div>
                        </div>
                    </div>


                    <div class="accordion-item">
                        <h2 class="accordion-header" id="OtherGrid">
                            <button class="accordion-button collapsed text-light pnl4BG bg-gradient" type="button" data-bs-toggle="collapse" data-bs-target="#OtherGridDetail" aria-expanded="true" aria-controls="OtherGridDetail">
                                <strong style="text-transform:uppercase"><i class="fa-solid fa-table-list fa-lg fa-fw pr35 fa-fade" style="--fa-animation-duration: 2s; --fa-fade-opacity: 0.6;"></i>Other Detail</strong>
                            </button>
                        </h2>
                        <div id="OtherGridDetail" class="accordion-collapse collapse pnl1 bg-gradient" aria-labelledby="OtherGrid">
                            <div class="accordion-body">
                                <div class="row g-2 gx-3">
                                    <div class="col-lg-2">
                                        <label asp-for="IssuedByEmpId" class="form-label">Issued By</label>
                                        <select asp-for="IssuedByEmpId" id="IssueEmpId" class="form-select">
                                            <option value="">-- Select Emp --</option>
                                        </select>
                                    </div>
                                    <div class="col-lg-2">
                                        <label asp-for="ApprovedByEmpId" class="form-label">Approved By</label>
                                        <select asp-for="ApprovedByEmpId" class="form-select"
                                                asp-items="ViewBag.Employees"></select>
                                    </div>
                                    <div class="col-lg-2">
                                        <label asp-for="ReceivedByEmpId" class="form-label">Received By</label>
                                        <select asp-for="ReceivedByEmpId" class="form-select"
                                                asp-items="ViewBag.Employees"></select>
                                    </div>
                                    <div class="col-lg-2">
                                        <label asp-for="CC" class="form-label">Branch</label>
                                        <input asp-for="CC" class="form-control" readonly />
                                    </div>
                                    <div class="col-lg-2">
                                        <label asp-for="PendingStatus" class="form-label">Pending Status</label>
                                        <select asp-for="PendingStatus" class="form-select">
                                            <option value="Pending">Pending</option>
                                            <option value="Approved">Approved</option>
                                            <option value="Rejected">Rejected</option>
                                        </select>
                                    </div>
                                    <div class="col-lg-2">
                                        <label asp-for="LastUpdatedDate" class="form-label">Last Updated</label>
                                        <input asp-for="LastUpdatedDate"  class="form-control" readonly />
                                    </div>

                                </div>
                            </div>
                        </div>

                </div>
            </div>
            <div class="card-header card-headerBG text-light bg-gradient">
                <h5>
                    <strong>PPC Tool Issue</strong>
                    <span class="d-flex float-end" style="margin-top:-2px;">
                        <div class="col-auto">
                            @* <button type="submit" class="btn btn-sm btn-outline-warning">*@
                            <button type="submit" class="btn btn-sm btn-outline-light bg-gradient" id="PrintButton">
                                <i class="fa fa-pencil-square fa-fw fa-lg" aria-hidden="true"></i>
                                PRINT
                            </button>
                        </div>
                        <a asp-action="Dashboard" asp-route-FromDate="@DateTime.Now.AddDays(1 - DateTime.Now.Day);" asp-route-Todate="@DateTime.Today" asp-route-Flag="True" class="btn btn-sm btn-outline-light bg-gradient">
                            <i class="fa-solid fa-grip fa-lg fa-fw fa-beat" style="--fa-animation-duration: 2s;"></i>
                            Dashboard
                        </a>
                        <partial name="_FormsButton" />
                    </span>
                </h5>
            </div>
        </div>
    </form>
</div>


<div class="modal fade" id="PasswordAllowPopup" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1"
     aria-labelledby="staticBackdropLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="staticBackdropLabel">Confirmation</h3>
                <button type="button" class="btn-close" data-bs-dismiss="modal" onclick="" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="card">
                    <div class="card-body">
                        <div class="row g-2 gx-3">
                            <div class="card">
                                <div class="card-body overflow-auto pb-0">
                                    <div class="col-xl-8 col-lg-8 col-md-8 col-sm-8 col-xs-12">
                                        <div class="d-flex align-items-center">
                                            <h6 class="mb-0 me-2">Do You Want to Save & Print?</h6>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="progress my-2" style="height: 4px;">
                        <div class="progress-bar progress-bar-striped bg-danger" role="progressbar" style="width: 100%" aria-valuenow="100" aria-valuemin="0" aria-valuemax="100"></div>
                    </div>
                </div>
                <div class="modal-footer">
                    <a href="#" class="btn btn-primary" id="btnPrint">
                        <i class="fa fa-print"></i> Save & Print
                    </a>
                    <button type="button" class="btn btn-danger" id="btnClose">Save Only</button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // Fetch new entry
    async function GetNewEntry() {
        try {
            const result = await $.ajax({
                type: "GET",
                url: '@Url.Action("GetNewEntry", "PPCToolIssue")',
                dataType: "json"
            });

            console.log("Raw result:", result);

            // Parse if needed
            const obj = typeof result === "string" ? JSON.parse(result) : result;
            // console.log("Parsed object:", obj);

            if (obj.Result && obj.Result.length > 0) {
                $('#ToolIssueEntryId').val(obj.Result[0].EntryID);
                $('#ToolIssueSlipNo').val(obj.Result[0].ToolIssueSlipNo);
                return obj.Result[0].EntryID; // return entryId
            } else if (obj.Error) {
                alert(obj.Error);
                return null;
            }
        } catch (err) {
            console.error("Error fetching new entry:", err);
            alert("Failed to fetch new entry.");
            return null;
        }
    }

     function FillDepartmentList() {
        $.ajax({
            url: '/PPCToolIssue/FillDepartmentList',
            type: 'GET',
            dataType: 'json',
            success: function (data) {
                // console.log("ToolList raw data:", data);

                // ✅ Parse only if it's actually a string
                const obj = typeof data === "string" ? JSON.parse(data) : data;
                // console.log("Parsed object:", obj);

                var select = $('#IssueToDepartmentId');
                select.empty();
                select.append('<option value="">-- Select Department --</option>');

                // ✅ Use obj instead of data
                if (obj.Result && obj.Result.length > 0) {
                    $.each(obj.Result, function (i, item) {
                        select.append($('<option>', {
                            value: item.DeptId,
                            text: item.DeptName
                        }));
                    });
                }
            },
            error: function (err) {
                console.error("❌ Error fetching tool list:", err);
            }
        });
    }

     function FillToolList() {
        $.ajax({
            url: '/PPCToolIssue/FillToolList',
            type: 'GET',
            dataType: 'json',
            success: function (data) {
                // console.log("ToolList raw data:", data);

                
                const obj = typeof data === "string" ? JSON.parse(data) : data;
                // console.log("Parsed object:", obj);

                var select = $('#ToolEntryId');
                select.empty();
                select.append('<option value="">-- Select Tool --</option>');

                 if (obj.Result && obj.Result.length > 0) {
                $.each(obj.Result, function (i, item) {
                    select.append($('<option>', {
                        value: item.ToolEntryId,
                        text: item.ToolName
                    }));
                }); 
            }
            select.trigger('change.select2');
            },
            error: function (err) {
                console.error("❌ Error fetching tool list:", err);
            }
        });
     }


    function FillToolBarCode(callback) {
            const toolId = $('#ToolEntryId').val();
            const editingValue = $('#BarCode').data('editing-value');

            if (!toolId) {
                $('#BarCode').empty().append('<option value="">-- Select Barcode --</option>').trigger("change.select2");
                $('#ToolType').val('');
                if (callback) callback();
                return;
            }

            $.ajax({
                url: '/PPCToolIssue/FillToolBarCode',
                type: 'GET',
                data: { ToolEntryId: toolId },
                dataType: 'json',
                success: function (data) {
                    const obj = typeof data === "string" ? JSON.parse(data) : data;
                    const result = obj.Result || [];
                    const select = $('#BarCode');
                    select.empty().append('<option value="">-- Select Barcode --</option>');

                    if (result.length > 0) {
                        $.each(result, function (i, item) {
                            select.append($('<option>', { value: item.BarCode, text: item.BarCode }));
                            if (item.Tooltype) $('#ToolType').val(item.Tooltype);
                        });
                    }
                    // Add editing value if missing
                    if (editingValue && select.find(`option[value="${editingValue}"]`).length === 0) {
                        select.append($('<option>', { value: editingValue, text: editingValue }));
                    }

                    select.val(editingValue || "").trigger('change.select2');
                    if (callback) callback();
                }
            });
        }

        function FillToolSerialNo(callback) {
            const toolId = $('#ToolEntryId').val();
            const barcode = $('#BarCode').val();
            const editingValue = $('#SerialNo').data('editing-value');

            if (!toolId || !barcode) {
                $('#SerialNo').empty().append('<option value="">-- Select Serial No --</option>').trigger("change.select2");
                if (callback) callback();
                return;
            }

            $.ajax({
                url: '/PPCToolIssue/FillToolSerialNo',
                type: 'GET',
                data: { ToolEntryId: toolId, barcode: barcode },
                dataType: 'json',
                success: function (data) {
                    const obj = typeof data === "string" ? JSON.parse(data) : data;
                    const result = obj.Result || [];
                    const select = $('#SerialNo');
                    select.empty().append('<option value="">-- Select Serial No --</option>');

                    if (result.length > 0) {
                        $.each(result, function (i, item) {
                            select.append($('<option>', { value: item.SerialNo, text: item.SerialNo }));
                        });
                    }

                    // Add editing value if missing
                    if (editingValue && select.find(`option[value="${editingValue}"]`).length === 0) {
                        select.append($('<option>', { value: editingValue, text: editingValue }));
                    }

                    select.val(editingValue || "").trigger('change.select2');
                    if (callback) callback();
                }
            });
        }
    function FillToolBarCodeDetail() {
        const ToolEntryId = $('#ToolEntryId').val();
        const barcode = $('#BarCode').val();
        const SerialNo = $('#SerialNo').val();

        // 🧩 Stop if any dropdown is empty
        if (!ToolEntryId || !barcode || !SerialNo) return;

        $.ajax({
            url: '/PPCToolIssue/FillToolBarCodeDetail',
            type: 'GET',
            data: { ToolEntryId, barcode, SerialNo },
            dataType: 'json',
            success: function (data) {
                // console.log("✅ BarcodeDetails List:", data);

                const obj = typeof data === "string" ? JSON.parse(data) : data;
                const result = obj.Result?.[0] || obj[0];

                if (!result) {
                    console.warn("⚠ No detail found for selected serial");
                    return;
                }

                const backendDate = new Date(result.NextCalibrationDate);
                const backendDate1 = new Date(result.LastCalibrationDate);

                 const formatted = ('0' + backendDate.getDate()).slice(-2) + '/' +
                      ('0' + (backendDate.getMonth() + 1)).slice(-2) + '/' +
                      backendDate.getFullYear();
                const formatted1 = ('0' + backendDate1.getDate()).slice(-2) + '/' +
                      ('0' + (backendDate1.getMonth() + 1)).slice(-2) + '/' +
                      backendDate1.getFullYear();
                // 🟢 Fill all fields from SP result
                $('#RemainingToolLifeInMonths').val(result.ExpectedLife || '');
                $('#NextCalibrationDueDate').val(formatted);
                $('#ForDepartmentId').val(result.ForDepartmentId || '');
                $('#CurrentLocation').val(result.LocationOfInsallation || '');
                $('#Unit').val(result.Unit || '');
                $('#LastCalibrationDate').val(formatted1);
            },
            error: function (err) {
                console.error("❌ Error fetching detail:", err);
            }
        });
    }

     function FillMachineList() {
        $.ajax({
            url: '/PPCToolIssue/FillMachineList',
            type: 'GET',
            dataType: 'json',
            success: function (data) {
                // ✅ Parse only if it's actually a string
                const obj = typeof data === "string" ? JSON.parse(data) : data;
                var select = $('#ForMachineId');
                select.empty();
                select.append('<option value="">-- Select Machine --</option>');

                // ✅ Use obj instead of data
                if (obj.Result && obj.Result.length > 0) {
                    $.each(obj.Result, function (i, item) {
                        select.append($('<option>', {
                            value: item.MachineId,
                            text: item.MachineName
                        }));
                    });
                }
            },
            error: function (err) {
                console.error("❌ Error fetching tool list:", err);
            }
        });
    }

         function FillIssueEmpList() {
            $.ajax({
                    url: '/PPCToolIssue/FillIssuedByEmpList',
                type: 'GET',
                dataType: 'json',
                success: function (data) {
                    console.log("IssueByEmp list",data);
                    // ✅ Parse only if it's actually a string
                    const obj = typeof data === "string" ? JSON.parse(data) : data;
                        var select = $('#IssueEmpId');
                    select.empty();
                    select.append('<option value="">-- Select Emp --</option>');

                    // ✅ Use obj instead of data
                    if (obj.Result && obj.Result.length > 0) {
                        $.each(obj.Result, function (i, item) {
                            select.append($('<option>', {
                                value: item.Emp_Id,
                                text: item.EmpName
                            }));
                        });
                    }
                },
                error: function (err) {
                    console.error("❌ Error fetching issue emp list:", err);
                }
            });
        }

    function FillProdPlan() {
            // console.log("🔹 FillProdPlan called");
        const toolId = $('#ToolEntryId').val();
        // console.log("....id",toolId);
        if (!toolId) {
            $('#ProdPlanNo').empty().append('<option value="">-- Select Prod Plan --</option>');
            return;
        }

        $.ajax({
            url: '/PPCToolIssue/FillProdPlan',
            type: 'GET',
            data: { ToolEntryId: toolId },
            dataType: 'json',
            success: function (data) {
                console.log("✅ FillProdPlan Data:", data);
                const obj = typeof data === "string" ? JSON.parse(data) : data;
                const result = obj.Result || obj || [];

                let select = $('#ProdPlanNo');
                select.empty();
                select.append('<option value="">-- Select Prod Plan --</option>');

                if (result.length > 0) {
                    $.each(result, function (i, item) {
                        if (item.ProDPlanNo) {
                            select.append(`<option value="${item.ProDPlanNo}">${item.ProDPlanNo}</option>`);
                        }
                    });
                } else {
                    select.append('<option value="">No Production Plan Found</option>');
                }
            },
            error: function (err) {
                console.error("❌ Error fetching FillProdPlan:", err);
            }
        });
    }


    function FillProdPlanYearCode() {
        const toolId = $('#ToolEntryId').val();
        const ProdPlanNo = $('#ProdPlanNo').val();

        if (!toolId || !ProdPlanNo) return;

        $.ajax({
            url: '/PPCToolIssue/FillProdPlanYearCode',
            type: 'GET',
            data: { ToolEntryId: toolId,ProdPlanNo },
            dataType: 'json',
            success: function (data) {
                console.log("FillProdPlanYearCode No List:", data);

                const obj = typeof data === "string" ? JSON.parse(data) : data;
                const result = obj.Result && obj.Result.length > 0 ? obj.Result[0] : null;

                if (!result) {
                    console.warn("⚠ No detail found for FillProdPlanYearCode");
                    return;
                }

                $('#ProdPlanYearCode').val(result.PlanNoYearCode || '');
                FillProdPlanDate();
            },
            error: function (err) {
                console.error("❌ Error fetching FillProdPlanYearCode:", err);
            }
        });
    }

     function FillProdPlanDate() {
        const ToolEntryId = $('#ToolEntryId').val();
        const ProdPlanNo = $('#ProdPlanNo').val();
        const ProdPlanYearCode = $('#ProdPlanYearCode').val();

        // 🧩 Stop if any dropdown is empty
        if (!ToolEntryId || !ProdPlanNo || !ProdPlanYearCode) return;

        $.ajax({
            url: '/PPCToolIssue/FillProdPlanDate',
            type: 'GET',
            data: { ToolEntryId, ProdPlanNo, ProdPlanYearCode },
            dataType: 'json',
            success: function (data) {
                console.log("✅ FillProdPlanDate List:", data);

                const obj = typeof data === "string" ? JSON.parse(data) : data;
                const result = obj.Result?.[0] || obj[0];

                if (!result) {
                    console.warn("⚠ No detail found for selected serial");
                    return;
                }

                const backendDate = new Date(result.WODAte);
                 const formatted = ('0' + backendDate.getDate()).slice(-2) + '/' +
                      ('0' + (backendDate.getMonth() + 1)).slice(-2) + '/' +
                      backendDate.getFullYear();
                // 🟢 Fill all fields from SP result
                $('#ProdPlanEntryId').val(result.PlanNoEntryId || '');
                $('#ProdPlanDate').val(formatted);
              
            },
            error: function (err) {
                console.error("❌ Error fetching FillProdPlanDate detail:", err);
            }
        });
    }

    $(function () {
        $(".datepicker").datepicker({
            dateFormat: "dd/mm/yy",
            changeMonth: true,
            changeYear: true
        });

        // Set today's date on page load
        let today = new Date();
        $(".datepicker").datepicker("setDate", today);

        // Prevent typing manually
        $(".datepicker").on("keydown", function (e) {
            e.preventDefault();
        });
    });
  
    function toDDMMYYYY(dateString) {
    if (!dateString) return "";

    const d = new Date(dateString);
    if (isNaN(d)) return "";

        let day = ("0" + d.getDate()).slice(-2);
    let month = ("0" + (d.getMonth() + 1)).slice(-2);
    let year = d.getFullYear();

    return `${day}/${month}/${year}`;
}

        let isEditing = false;
         // Edit a row from the second table
    function EditDetail(seq) {
        isEditing = true;
        $.ajax({
            url: "/PPCToolIssue/EditToolIssueRow",
            type: "GET",
            data: { SeqNo: seq },
            success: function(data) {
                const row = JSON.parse(data);

                // Save editing values
                $('#BarCode').data('editing-value', row.BarCode);
                $('#SerialNo').data('editing-value', row.SerialNo);

                // Fill dropdowns with callbacks
                $("#ToolEntryId").val(row.ToolEntryId).trigger("change.select2");

                FillToolBarCode(function() {
                    FillToolSerialNo(function() {
                        // Fill remaining fields
                        $("#ToolType").val(row.ToolType);
                        $("#IssueQty").val(row.IssueQty);
                        $("#Unit").val(row.Unit);
                        $("#CurrentLocation").val(row.CurrentLocation);
                        $("#IssueToLocation").val(row.IssueToLocation);
                        $("#ToolCondition").val(row.ToolCondition);
                        $("#LastCalibrationDate").val(toDDMMYYYY(row.LastCalibrationDate)).datepicker("setDate", toDDMMYYYY(row.LastCalibrationDate));
                        $("#NextCalibrationDueDate").val(toDDMMYYYY(row.NextCalibrationDueDate)).datepicker("setDate", toDDMMYYYY(row.NextCalibrationDueDate));
                        $("#RemainingToolLifeInMonths").val(row.RemainingToolLifeInMonths);
                        $("#ProdPlanEntryId").val(row.ProdPlanEntryId);
                        $("#ProdPlanYearCode").val(row.ProdPlanYearCode);
                                $("#ProdPlanDate").val(toDDMMYYYY(row.ProdPlandate)).datepicker("setDate", toDDMMYYYY(row.ProdPlandate));
                        $("#ProdSchDate").val(toDDMMYYYY(row.ProdSchDate)).datepicker("setDate", toDDMMYYYY(row.ProdSchDate));

                        $("#SeqNo").val(row.SeqNo);
                        isEditing = false; // finished editing
                    });
                });
            }
        });
    }

    function DeleteDetail(seq) {
        $.ajax({
            url: "/PPCToolIssue/DeleteToolIssueRow",
            type: "GET",
            data: { SeqNo: seq },
            success: function(res) {
                $("#divToolIssueAdded").html(res);
            }
        });
    }
  
    
    $(document).ready(async function () {
        GetNewEntry();
        FillDepartmentList();
        FillToolList();
        FillMachineList();
              FillIssueEmpList();
    function clearDependentFieldsForBarcode() {
        $('#SerialNo').empty().append('<option value="">-- Select Serial No --</option>');
        $('#ProdPlanNo').empty().append('<option value="">-- Select Prod Plan --</option>');

        $('#ProdPlanYearCode').val('');
        $('#ProdPlanDate').val('');
        $('#ProdPlanEntryId').val('');
        $('#RemainingToolLifeInMonths').val('');
        $('#NextCalibrationDueDate').val('');
        $('#LastCalibrationDate').val('');
        $('#ForDepartmentId').val('');
        $('#CurrentLocation').val('');
        $('#Unit').val('');
    }
        function clearDependentFields() {
        $('#BarCode').empty().append('<option value="">-- Select Barcode --</option>');
        clearDependentFieldsForBarcode();
    }

        // ✅ Delegated event bindings
        $(document).on('change', '#ToolEntryId', function () {
             $('#BarCode').removeData('editing-value');
            $('#SerialNo').removeData('editing-value');
                $('#ToolType').val('');
             if (isEditing) return;
            clearDependentFields();
            FillToolBarCode();
            FillProdPlan();
          
        });

    $(document).on('change', '#BarCode', function () {
         if (isEditing) return;
        // Only clear dependent fields that rely on SerialNo
        $('#RemainingToolLifeInMonths').val('');
        $('#NextCalibrationDueDate').val('');
        $('#LastCalibrationDate').val('');
        $('#CurrentLocation').val('');
        $('#Unit').val('');

        // Now populate SerialNo for this barcode
        FillToolSerialNo();
    });


        $(document).on('change', '#SerialNo', function () {
             if (isEditing) return;
            FillToolBarCodeDetail();
        });

        $(document).on('change', '#ProdPlanNo', function () {
             if (isEditing) return;
            FillProdPlanYearCode();
        });

        $(document).on('change', '#ProdPlanYearCode', function () {
             if (isEditing) return;
            FillProdPlanDate();
        });

        $('#ToolEntryId, #BarCode, #SerialNo').select2({
            placeholder: "-- Select --",
            allowClear: false,
            width: '100%'
        });


    $(document).on('select2:select', '#ToolEntryId', function (e) {
        var selectedValue = e.params.data.id;
        console.log('Tool selected:', selectedValue);

        // Trigger the same logic as normal dropdown change
        clearDependentFields();
        FillToolBarCode();
        FillProdPlan();
    });

    $(document).on('select2:select', '#BarCode', function (e) {
        // Only clear SerialNo dependent fields
        $('#SerialNo').empty().append('<option value="">-- Select Serial No --</option>');
        $('#RemainingToolLifeInMonths').val('');
        $('#NextCalibrationDueDate').val('');
        $('#LastCalibrationDate').val('');
        $('#CurrentLocation').val('');
        $('#Unit').val('');
        // Do NOT clear ToolType or ProdPlanNo
        FillToolSerialNo();
    });


    $(document).on('select2:select', '#SerialNo', function (e) {
        var selectedValue = e.params.data.id;
        FillToolBarCodeDetail();
    });


        // Add to Grid
        $(".GridButton").click(function () {
    const requiredFields = [
        { id: '#ToolEntryId', name: 'Tool Name' },
        { id: '#IssueToLocation', name: 'Issue To Location' },
        { id: '#IssueQty', name: 'Issue Quantity' }
    ];

    let emptyCheck = false;
    let missingFields = [];

    requiredFields.forEach(function (field) {
        const input = $(field.id);
        const value = input.val() && input.val().trim() !== "" ? input.val() : "";

        if (value === "") {
            emptyCheck = true;
            missingFields.push(field.name);
            input.addClass("is-invalid");
        } else {
            input.removeClass("is-invalid");
        }
    });

    if (emptyCheck) {
        alert("Please fill the following required fields:\n\n- " + missingFields.join("\n- "));
        return;
    }

    let model = {
        ToolIssueEntryId: $("#ToolIssueEntryId").val(),
        ToolIssueYearCode: $("#ToolIssueYearCode").val(),  // ✅ parent

        ToolEntryId: $("#ToolEntryId").val(),
        ToolName: $("#ToolEntryId option:selected").text(),
        ToolYearCode: $("#ToolIssueYearCode").val(),       // ✅ child

        BarCode: $("#BarCode").val(),
        SerialNo: $("#SerialNo").val(),
        ToolType: $("#ToolType").val(),
        IssueQty: $("#IssueQty").val(),
        Unit: $("#Unit").val(),
        CurrentLocation: $("#CurrentLocation").val(),
        IssueToLocation: $("#IssueToLocation").val(),
        ToolCondition: $("#ToolCondition").val(),

        LastCalibrationDate: $("#LastCalibrationDate").val(),
        NextCalibrationDueDate: $("#NextCalibrationDueDate").val(),
        RemainingToolLifeInMonths: $("#RemainingToolLifeInMonths").val(),

        ProdPlanEntryId: $("#ProdPlanEntryId").val(),
        ProdPlanNo: $("#ProdPlanNo").val(),
        ProdPlandate: $("#ProdPlanDate").val(),
        ProdPlanYearCode: $("#ProdPlanYearCode").val(),

        ProdSchEntryId: $("#ProdSchEntryId").val(),
        ProdSchNo: $("#ProdSchNo").val(),
        ProdSchDate: $("#ProdSchDate").val(),
        ProdSchYearCode: $("#ProdSchYearCode").val(),

        ForMachineId: $("#ForMachineId").val(),
        SpecialInstruction: $("#SpecialInstruction").val(),
        WillBeConsumedOrReturned: $("#WillBeConsumedOrReturned").val(),
        PendingQty: $("#PendingQty").val(),
        PendingStatus: $("#PendingStatus").val(),
        SeqNo: $("#SeqNo").val() || 0
    };


    $.ajax({
        url: "/PPCToolIssue/AddToolIssueDetail",   
        type: "POST",
        data: model,
            success: function (response) {
        // Update grid HTML
        //VERY IMPORTANT: remove editing values after save
        $("#divToolIssueAdded").html(response);
         $('#BarCode').removeData('editing-value');
    $('#SerialNo').removeData('editing-value');
    // Clear all except Tool Name
    $("#BarCode").empty().append('<option value="">-- Select --</option>').val('').trigger('change.select2');
    $("#SerialNo").empty().append('<option value="">-- Select --</option>').val('').trigger('change.select2');

    $("#ToolType,#IssueQty,#Unit,#CurrentLocation,#IssueToLocation,#ToolCondition,#LastCalibrationDate,#NextCalibrationDueDate,#RemainingToolLifeInMonths,#ProdPlanEntryId,#ProdPlanNo,#ProdPlanDate,#ProdPlanYearCode,#ProdSchEntryId,#ProdSchNo,#ProdSchDate,#ProdSchYearCode,#ForMachineId,#SpecialInstruction,#WillBeConsumedOrReturned,#PendingQty,#PendingStatus,#SeqNo").val('');
    FillToolBarCode(function () {
        FillToolSerialNo(function () {
            console.log("Done loading both");
        });
    });

    },
        error: function () {
            alert("Error adding detail");
        }
    });

  

    });

       
      
    });


        $("#toolIssueForm").on("submit", function (e) {
            e.preventDefault();

            $.post("/PPCToolIssue/InsertToolIssue", $(this).serialize())
                .done(function () {
                    window.location.reload();
                })
                .fail(function () {
                    alert("Error submitting form");
                });
        });
</script>



