@model eTactWeb.DOM.Models.WIPStockRegisterModel
@{
	ViewData["Title"] = "WIP Stock Register";
	Layout = "~/Views/Shared/_LayoutMain.cshtml";
}
<style>

	.select2-container--default .select2-selection--single {
		background-color: #e0f2f1;
		border: 1.5px solid #0a0a0a !important;
		border-radius: 4px;
	}

		.select2-container--default .select2-selection--single .select2-selection__rendered {
			/* border-bottom: 1.5px solid #000 !important; */
			border-bottom: none !important;
		}

	.select2-container--default .select2-results > .select2-results__options {
		background-color: #e0f2f1; /* Dropdown background color */
		color: #000;
</style>

<div class="card bg-gradient mb-3 border-light shadow-lg">

	<div class="card-header card-headerBG text-light bg-gradient">
		<h5>
			<strong>WIP Stock Register</strong>
			<span class="d-flex float-end" style="margin-top:-2px;">
				@*<a asp-action="Dashboard" asp-route-ID="0" class="btn btn-sm btn-outline-light bg-gradient">*@

			</span>
		</h5>
	</div>
	<div>
	</div>
	<div class="card-body bg-light pt-0">
		<div class="accordion shadow-lg">
			<div class="card-body">
				<div class="card overflow-auto">
					<div class="card-body">
						<form id="SParam">

							<div class="accordion-item">
								<h2 class="accordion-header" id="H_WIPStock">
									<button class="accordion-button collapsed text-light pnl4BG bg-gradient" type="button" data-bs-toggle="collapse" data-bs-target="#B_WIPStock" aria-expanded="true" aria-controls="B_WIPStock">
										<strong style="text-transform:uppercase"><i class="fa-solid fa-table-list fa-lg fa-fw pr35 fa-fade" style="--fa-animation-duration: 2s; --fa-fade-opacity: 0.6;"></i>WIP Stock</strong>
									</button>
								</h2>

								<div id="B_WIPStock" class="accordion-collapse collapse pnl4 bg-gradient show" aria-labelledby="H_WIPStock">
									<div class="accordion-body">

										<div class="row">
											<div class="col-xxl-2 col-xl-3 col-lg-3 col-md-6 col-sm-12 col-xs-12">
												<div class="row">
													<div class="col">
														<label class="form-label">From Date</label>
														<input asp-for="FromDate" class="form-control" />
													</div>
													<div class="col">
														<label class="form-label">To Date</label>
														<input asp-for="ToDate" class="form-control" />
													</div>
												</div>
											</div>
											<div class="col-xxl-2 col-xl-3 col-lg-3 col-md-6 col-sm-6 col-xs-12">
												<label asp-for="WCID" class="form-label">WorkCenter</label>
												<select asp-for="WCID" class="form-select">
												</select>
											</div>
											<div class="col-xxl-2 col-xl-3 col-lg-3 col-md-6 col-sm-6 col-xs-12">
												<label asp-for="PartCode" class="form-label">PartCode</label>
												<input type="text" id="PartCodeText" class="form-control" placeholder="Type Part Code..." />
												<input type="hidden" asp-for="PartCode" id="PartCode" />
											</div>
											<div class="col-xxl-2 col-xl-3 col-lg-3 col-md-6 col-sm-6 col-xs-12">
												<label asp-for="ItemName" class="form-label">ItemName</label>
													<input type="text" id="ItemNameText" class="form-control" placeholder="Type Item Name..." />
												<input type="hidden" asp-for="ItemName" id="ItemName" />
													@*   <select class="form-select" asp-for="ItemCode" style="heigt:190px;width:300px;">
													<option value="0">-Select-</option>
													</select> *@
												
											</div>
											<div class="col-xxl-2 col-xl-3 col-lg-3 col-md-6 col-sm-6 col-xs-12">
												<label asp-for="ItemGroup" class="form-label">Item Group</label>
												<input asp-for="ItemGroup" class="form-control" />
											</div>
											<div class="col-xxl-2 col-xl-3 col-lg-3 col-md-6 col-sm-6 col-xs-12">
												<label asp-for="ItemType" class="form-label">Item Type</label>
												<input asp-for="ItemType" class="form-control" />
											</div>
											<div class="col-xxl-2 col-xl-3 col-lg-3 col-md-6 col-sm-6 col-xs-12">
												<label asp-for="ReportType" class="form-label">Report Type</label>
												<select asp-for="ReportType" class="form-select">
													<option disabled value="">-Select-</option>
													<option selected value="WIPSTOCKSUMMARY">WIP STOCK SUMMARY</option>
													<option value="WIPSTOCKDETAIL">WIP STOCKDETAIL REPORT</option>
													<option value="WIPSTOCKSUMMARY">SUMMARY WITH ZERO INVENTORY</option>
													<option value="WIPSTOCKSUMMARY">Show only balance</option>
													<option value="SHOWONLYRECDATA">Show only rec</option>
													<option value="SHOWONLYISSUEDATA">Show only issue</option>
													<option value="BATCHWISESTOCKSUMMARY">Batch Wise Summary</option>
													<option value="WIPSTOCKSUMMARY">STORE + WIP STOCK SUMMARY</option>
												</select>
											</div>
											<div class="col-xxl-2 col-xl-3 col-lg-3 col-md-6 col-sm-6 col-xs-12">
												<label asp-for="BatchNo" class="form-label">Batch No</label>
												<input asp-for="BatchNo" class="form-control" />
											</div>
											<div class="col-xxl-2 col-xl-3 col-lg-3 col-md-6 col-sm-6 col-xs-12">
												<label asp-for="UniqueBatchNo" class="form-label">Unique Batch No</label>
												<input asp-for="UniqueBatchNo" class="form-control" />

											</div>
											<div class="col-xxl-2 col-xl-3 col-lg-3 col-md-6 col-sm-6 col-xs-12">
												<label class="form-label">Global search</label>
												<input id="search-box" class="form-control" style="background-color: #FFFACD;" placeholder="Search..." />
											</div>
											<div class=" d-flex justify-content-center mt-3" width="inherit">
												<button class="btn btn-sm btn-outline-info" type="button" style="padding:0px;height:30px;width:100px;" onclick="GetWIPRegisterData();">
													<i class="fa-solid fa-magnifying-glass fa-fw fa-lg"></i>SEARCH
												</button>
												<button class="btn btn-sm btn-outline-danger" style="padding:3px; height:30px; width:100px; margin-left:20px;" type="button" id="sendToPDF">
													<i class="fa-solid fa-file-pdf fa-fw fa-lg"></i> PDF
												</button>
                                                <button class="btn btn-sm btn-outline-success" style="padding:3px;height:30px;width:100px;margin-left:20px;" type="button" id="sendToExcel">
													<i class="fa-solid fa-upload fa-fw fa-lg "></i>EXCEL
												</button>
												<a class="btn btn-sm btn-outline-danger" style="padding:3px;height:30px;width:100px;margin-left:20px;" asp-controller="WIPStockRegister" asp-action="WIPStockRegister">
													<i class="fa-solid fa-rotate fa-fw fa-lg"></i>RESET
												</a>
											</div>
										</div>
										</<div></div>
									</div>
									<div class="progress my-2 mb-3" style="height: 4px;">
										<div class="progress-bar progress-bar-striped bg-secondary progress-bar-animated" role="progressbar" style="width: 100%" aria-valuenow="100" aria-valuemin="0" aria-valuemax="100"></div>
									</div>
									<div class="accordion-item">
										<h2 class="accordion-header" id="H_SAGrid">
											<button class="accordion-button collapsed text-light pnl4BG bg-gradient" type="button" data-bs-toggle="collapse" data-bs-target="#B_SAGrid" aria-expanded="true" aria-controls="B_SAGrid">
												<strong style="text-transform:uppercase"><i class="fa-solid fa-table-list fa-lg fa-fw pr35 fa-fade" style="--fa-animation-duration: 2s; --fa-fade-opacity: 0.6;"></i>Item Detail Grid</strong>
											</button>
										</h2>

										<div id="B_SAGrid" class="accordion-collapse collapse pnl4 bg-gradient show" aria-labelledby="H_SAGrid">
											<div class="accordion-body">
												<div class="card-body" id="divPendingMRP">
													<div class="row">
														<div class="col-md-12" id="divStockMainRegister">
															<partial name="_WIPStockRegisterGrid" />
														</div>

													</div>
												</div>
												<center>
													<div class="row">
														<div class="col-xxl-2 col-xl-3 col-lg-3 col-md-6 col-sm-6 col-xs-12" id="opnStkDiv">
															<label class="form-label">Total Open Stock</label>
															<input id="totOpenStock" class="form-control" readonly />
														</div>
														<div class="col-xxl-2 col-xl-3 col-lg-3 col-md-6 col-sm-6 col-xs-12" id="recDiv">
															<label class="form-label">Total Rec Stock</label>
															<input id="totRecQty" class="form-control" readonly />
														</div>
														<div class="col-xxl-2 col-xl-3 col-lg-3 col-md-6 col-sm-6 col-xs-12" id="issQtyDiv">
															<label class="form-label">Total Issue Stock</label>
															<input id="totIssueQty" class="form-control" readonly />
														</div>
														<div class="col-xxl-2 col-xl-3 col-lg-3 col-md-6 col-sm-6 col-xs-12" id="stockDiv">
															<label class="form-label">Total Stock</label>
															<input id="totStock" class="form-control" readonly />
														</div>
														<div class="col-xxl-2 col-xl-3 col-lg-3 col-md-6 col-sm-6 col-xs-12" id="stockDiv">
															<label class="form-label">Total Amount</label>
															<input id="totAmount" class="form-control" readonly />
														</div>
													</div>
												</center>
											</div>

										</div>
									</div>
						</form>
					</div>
				</div>
			</div>

		</div>
	</div>


</div>


@section Scripts
{
	<script>
		  $(document).ready(function () {
			  GetServerDate();
			  FillWorkCenter();
			  $('#WCID').select2();
			  $('#ReportType').select2();
			FillItems();
			if ($('#ItemNameText').val() == '') {
				$('#ItemName').val('');
			}
			  /* GetWIPRegisterData(); */
			  AutoComplete('Item_Master_Type', 'ItemType', 'Type_Item', null);
			  AutoComplete('VItemGroupMaster', 'ItemGroup', 'Group_name', null);
			   /* AutoComplete('VItemMaster', 'ItemName', 'Item_Name', null);
			  AutoComplete(' VItemMaster', 'PartCode', 'PartCode', null); */

			  AutoCompleteRawMaterial('Raw_Material_Stock_Ledger', 'BatchNo', 'BatchNo', null, $('#FromDate').val(), $('#ToDate').val(), 0, $('#StoreId').val());
			  AutoCompleteRawMaterial('Raw_Material_Stock_Ledger', 'UniqueBatchNo', 'UniqueBatchNo', null, $('#FromDate').val(), $('#ToDate').val(), 0, $('#StoreId').val());
			  $('#BillDate').datepicker({ dateFormat: 'dd/mm/yy' });
		  });

		function FillItems() {
			// Source for PartCodeText
			const partCodeSource = function (request, response) {
				$.ajax({
					url: '@Url.Action("FillItems")',
					type: 'POST',
					data: {
						
						SearchItemCode: '',
						SearchPartCode: request.term
					},
					success: function (result) {
						let obj = typeof result === "string" ? JSON.parse(result) : result;

						if (obj.StatusCode === 200 && obj.StatusText === 'Success' && Array.isArray(obj.Result.Table)) {
							let filtered = obj.Result.Table.filter(function (item) {
								let term = request.term.toLowerCase();
								return item.PartCode.toLowerCase().includes(term);
							});

							response($.map(filtered, function (item) {
								return {
									label: item.PartCode,
									value: item.PartCode,
									itemName: item.ItemName,
									itemCode: item.Item_Code
								};
							}));
						} else {
							response([]);
						}
					}
				});
			};

			// Source for ItemNameText
			const itemNameSource = function (request, response) {
				$.ajax({
					url: '@Url.Action("FillItems")',
					type: 'POST',
					data: {
					
						SearchItemCode: request.term,
						SearchPartCode: ''
					},
					success: function (result) {
						let obj = typeof result === "string" ? JSON.parse(result) : result;

						if (obj.StatusCode === 200 && obj.StatusText === 'Success' && Array.isArray(obj.Result.Table)) {
							let filtered = obj.Result.Table.filter(function (item) {
								let term = request.term.toLowerCase();
								return item.ItemName.toLowerCase().includes(term);
							});

							response($.map(filtered, function (item) {
								return {
									label: item.ItemName,
									value: item.Item_Code,
									itemName: item.ItemName,
									itemCode: item.Item_Code,
									partCode: item.PartCode
								};
							}));
						} else {
							response([]);
						}
					}
				});
			};

			// Autocomplete for PartCodeText
			$("#PartCodeText").autocomplete({
				source: partCodeSource,
				select: function (event, ui) {
					$("#PartCodeText").val(ui.item.value).data("itemcode", ui.item.itemCode);
					$("#ItemNameText").val(ui.item.itemName);
					$('#ItemName').val(ui.item.itemName);
					$('#PartCode').val(ui.item.partCode);
					/* GetItemPartCode("PartCode"); */
					return false;
				},
				focus: function (event, ui) {
					$("#PartCodeText").val(ui.item.value);
					return false;
				},
				minLength: 2
			});

			// Autocomplete for ItemNameText
			$("#ItemNameText").autocomplete({
				source: itemNameSource,
				select: function (event, ui) {
					$("#ItemNameText").val(ui.item.itemName).data("itemcode", ui.item.itemCode);
					$("#PartCodeText").val(ui.item.partCode);
					$('#ItemName').val(ui.item.itemName);
					$('#PartCode').val(ui.item.partCode);
					
					return false;
				},
				focus: function (event, ui) {
					$("#ItemNameText").val(ui.item.itemName);
					return false;
				},
				minLength: 2
			});
		}
		

		  function loadPage(pageNumber) {

			  const data = {
				  FromDate: $('#FromDate').val(),
				  ToDate: $('#ToDate').val(),
				PartCode: $('#PartCodeText').val(),
				  ItemName: $('#ItemName').val(),
				  ItemGroup: $('#ItemGroupName').val(),
				  ItemType: $('#ItemType').val(),
				  WCID: $('#WCID').val(),
				  ReportType: $('#ReportType').val(),
				  BatchNo: $('#BatchNo').val(),
				  UniqueBatchNo: $('#UniqueBatchNo').val(),
				  WorkCenter: $('#WCID option:checked').text(),
				  SearchBox: $('#search-box').val(),
				  pageNumber: pageNumber
			  };

			  $.ajax({
				  type: 'GET',
				  url: '/WIPStockRegister/GetWIPRegisterData',
				  data: data,
				  success: function (result) {
					  $('#divStockMainRegister').empty();
					  $('#divStockMainRegister').html(result);
					  $('#totalRows').text($('#divStockMainRegister tr').length - 1);
					  countAllTotal();
				  }
			  });
		  }

		  function GetWIPRegisterData() {

			  $.ajax({
				  type: "POST",
				  url: "@Url.Action("GetWIPRegisterData")",
				  async: false,
				data: { "FromDate": $('#FromDate').val(), "ToDate": $('#ToDate').val(), "PartCode": $('#PartCodeText').val(), "ItemName": $('#ItemName').val(), "ItemGroup": $('#ItemGroup').val(), "ItemType": $('#ItemType').val(), "WCID": $('#WCID').val(), "ReportType": $('#ReportType').val(), "BatchNo": $('#BatchNo').val(), "UniqueBatchNo": $('#UniqueBatchNo').val() },
				  success: function (result, status, error) {

					  $('#divStockMainRegister').empty();
					  $('#divStockMainRegister').html(result);
					  $('#totalRows').text($('#divStockMainRegister tr').length - 1);
					  countAllTotal();
				  }
			  });
		  }

	    $('#sendToPDF').click(async function () {
			 
			const { jsPDF } = window.jspdf;
			const doc = new jsPDF({ orientation: 'landscape', unit: 'pt', format: 'a4' });

			// Get dynamic values
			var reportTypeText = $('#ReportType').find(":selected").text();
			var reportTypeValue = $('#ReportType').val();
			var fromDate = $('#FromDate').val();
			var toDate = $('#ToDate').val();
			var WorkCenter = $('#WCID').find(":selected").text();
			var PartCode = $('#PartCode').val();
			var ItemName = $('#ItemName').val();
			var ItemGroup = $('#ItemGroup').val();
			var ItemType = $('#ItemType').val();
			var BatchNo = $('#BatchNo').val();
			var UniqueBatchNo = $('#UniqueBatchNo').val();

			// Report Title (Bold and Color)
			doc.setFontSize(16).setFont('helvetica', 'bold').setTextColor(41, 128, 185).text(reportTypeText, 40, 40);  // Blue color

					doc.setFontSize(10);
		doc.setTextColor(0, 0, 0);
		doc.setFont('helvetica', 'bold');
		doc.text('For the duration From:', 40, 58);
		doc.setFont('helvetica', 'normal');
		doc.text(fromDate, 160, 58);
		doc.setFont('helvetica', 'bold');
		doc.text('To:', 240, 58);
		doc.setFont('helvetica', 'normal');
		doc.text(toDate, 270, 58);

			// Header Fields
			const headerFields = [
				{ label: 'Work Center', value: (WorkCenter && WorkCenter !== '-Select-') ? WorkCenter : '' },
				{ label: 'Part Code', value: PartCode || '' },
				{ label: 'Item Name', value: ItemName || '' },
				{ label: 'Item Group', value: ItemGroup || '' },
				{ label: 'Item Type', value: ItemType || '' },
				{ label: 'Batch No', value: BatchNo || '' },
				{ label: 'Unique BatchNo', value: UniqueBatchNo || '' },
			];

			// Adding headerFields to PDF with bold labels
							let yPosition = 75; // starting position for header fields
		doc.setFontSize(10);
		doc.setTextColor(0, 0, 0); // Set black color once before loop

		headerFields.forEach((field, index) => {
		  if (field.value) {
			doc.setFont('helvetica', 'bold');
			doc.text(`${field.label}:`, 40, yPosition);
			doc.setFont('helvetica', 'normal');
			doc.text(field.value, 140, yPosition);
			yPosition += 15;
		  }
		});

			// Fetch data
			var resp = await fetch('/WIPStockRegister/GetWIPStockRegisterData');
			var rows = await resp.json();

			// Declare headers and body
			let headers = [];
			let body = [];

			// Handle report type logic
			switch (reportTypeValue) {
				case 'WIPSTOCKSUMMARY':
					headers = [
						"Sr#", "Work Center", "Part Code", "Item Name", "Opn Stk", "Rec Qty",
						"Iss Qty", "Total Stock", "Std Packing", "Unit", "Avg Rate", "Amount",
						"Min Level", "Alt Unit", "Alt Stock", "Group Name", "Bin No",
						"Maximum Level", "Reorder Level"
					];
					body = rows.map((r, i) => [
						i + 1, r.workCenterName, r.partCode, r.itemName, r.opnStk, r.recQty,
						r.issQty, r.totStk, r.stdPacking, r.unit, r.avgRate, r.amount,
						r.minLevel, r.altUnit, r.altStock, r.groupName, r.binNo,
						r.maximumLevel, r.reorderLevel
					]);
					break;
				case 'WIPSTOCKDETAIL':
					headers = [
						"Sr#", "Work Center","Transaction Type","Trans Date","Slip No","Date" ,"Part Code", "Item Name", "Opn Stk", "Rec Qty",
						"Iss Qty", "Total Stock", "Unit", "Alt Rec", "Alt Iss","Alt Stk","Alt Unit", "Rate", "Amount", "Batch No",
						"Unique BatchNo", "Entry Id","From Wc","To Wc","To Store"
					];
					body = rows.map((r, i) => [
						i + 1, r.workCenterName, r.transactionType, r.transDate, r.billNo, r.billDate,r.partCode,r.itemName,r.opnStk,r.recQty,
						r.issQty, r.totStk, r.unit, r.altRecQty, r.altIssQty, r.altStock,r.altUnit,r.rate,r.amount,r.batchNo,
						r.uniquebatchNo, r.entryId,r.fromWc,r.toWC,r.toStore
					]);
					break;

				// Add more cases for different report types here if needed
				default:
					headers = ["Sr#", "Item Name", "Total Stock"];
					body = rows.map((r, i) => [i + 1, r.itemName, r.totStk]);
					break;
			}

			// Generate table with bold and colored header
					doc.autoTable({
		  startY: yPosition, // after headerFields
		  head: [headers],
		  body: body,
		  theme: 'grid',
		  margin: { left: 40, right: 40 },
		  styles: {
			fontSize: 7,
			cellPadding: 3,
			overflow: 'linebreak',
			halign: 'center',
			valign: 'middle'
		  },
		  headStyles: {
			fillColor: [41, 128, 185],
			textColor: [255, 255, 255],
			fontStyle: 'bold'
		  },
		  columnStyles: getColumnStyles(reportTypeValue),
		  tableWidth: 'auto',
		  showHead: 'everyPage'
				});

								// 1. Calculate all totals
		const totalOpnStk = rows.reduce((sum, r) => sum + (+r.opnStk  || 0), 0);
		const totalRecQty = rows.reduce((sum, r) => sum + (+r.recQty  || 0), 0);
		const totalIssQty = rows.reduce((sum, r) => sum + (+r.issQty  || 0), 0);
		const totalTotStk = rows.reduce((sum, r) => sum + (+r.totStk  || 0), 0);
		const totalAmount = rows.reduce((sum, r) => sum + (+r.amount  || 0), 0);

		// 2. Build the one-line footer values string
		const footerValues =
		  `Total Open Stock: ${totalOpnStk.toFixed(2)}  |  ` +
		  `Total Rec Stock: ${totalRecQty.toFixed(2)}  |  ` +
		  `Total Issue Stock: ${totalIssQty.toFixed(2)}  |  ` +
		  `Total Stock: ${totalTotStk.toFixed(2)}  |  ` +
		  `Total Amount: ${totalAmount.toFixed(2)}`;

		// 3. Determine where the table finished
		const finalY = doc.lastAutoTable.finalY || yPosition;

		// 4. Compute available width (pageWidth − margins)
		const pageWidth   = doc.internal.pageSize.getWidth();
		const marginLeft  = 40;
		const marginRight = 40;
		const availableW  = pageWidth - marginLeft - marginRight;

		// 5. Draw a bold footer title
		const titleY = finalY + 15;
		doc.setFont('helvetica', 'bold')
		   .setFontSize(11)
		   .setTextColor(41, 128, 185)           // Optional: match your header color
		   .text('Report Totals:', marginLeft, titleY);

		// 6. Draw the footer values on the same line (normal weight)
		const valuesY = titleY + 12;
		doc.setFont('helvetica', 'normal')
		   .setFontSize(10)
		   .setTextColor(0, 0, 0)
		   .text(footerValues, marginLeft, valuesY, {
			 maxWidth: availableW,
			 align: 'left'
		   });

			// Save the PDF
			doc.save(`${reportTypeText.replace(/\s+/g, '_')}.pdf`);
		});

		function getColumnStyles(reportTypeValue) {
			switch (reportTypeValue) {
				case 'WIPSTOCKSUMMARY':
					return {
						0: { cellWidth: 20 },   // Sr#
						1: { cellWidth: 50 },   // Work Center
						2: { cellWidth: 60 },   // Part Code
						3: { cellWidth: 70 },   // Item Name
						4: { cellWidth: 30 },   // Opn Stk
						5: { cellWidth: 30 },   // Rec Qty
						6: { cellWidth: 30 },   // Iss Qty
						7: { cellWidth: 30 },   // Total Stock
						8: { cellWidth: 30 },   // Std Packing
						9: { cellWidth: 30 },   // Unit
						10: { cellWidth: 30 },  // Avg Rate
						11: { cellWidth: 35 },  // Amount
						12: { cellWidth: 30 },  // Min Level
						13: { cellWidth: 30 },  // Alt Unit
						14: { cellWidth: 30 },  // Alt Stock
						15: { cellWidth: 50 },  // Group Name
						16: { cellWidth: 30 },  // Bin No
						17: { cellWidth: 35 },  // Maximum Level
						18: { cellWidth: 35 }   // Reorder Level
					};

				case 'WIPSTOCKDETAIL':
					return {
						0: { cellWidth: 20 },   // Sr#
						1: { cellWidth: 50 },   // Work Center
						2: { cellWidth: 50 },   // Transaction Type
						3: { cellWidth: 50 },   // Trans Date
						4: { cellWidth: 25 },   // Slip No
						5: { cellWidth: 25 },   // Date
						6: { cellWidth: 50 },   // Part Code
						7: { cellWidth: 50 },   // Item Name
						8: { cellWidth: 25 },   // Opn Stk
						9: { cellWidth: 25 },   // Rec Qty
						10: { cellWidth: 25 },  // Iss Qty
						11: { cellWidth: 25 },  // Total Stock
						12: { cellWidth: 25 },  // Unit
						13: { cellWidth: 25 },  // Alt Rec
						14: { cellWidth: 25 },  // Alt Iss
						15: { cellWidth: 25 },  // Alt Stk
						16: { cellWidth: 25 },  // Alt Unit
						17: { cellWidth: 25 },  // Rate
						18: { cellWidth: 25 },  // Amount
						19: { cellWidth: 25 },  // Batch No
						20: { cellWidth: 35 },  // Unique Batch No
						21: { cellWidth: 25 },  // Entry Id
						22: { cellWidth: 25 },  // From Wc
						23: { cellWidth: 25 },  // To Wc
						24: { cellWidth: 25 }   // To Store
					};

				default:
					return {
						0: { cellWidth: 20 },   // Sr#
						1: { cellWidth: 80 },   // Item Name
						2: { cellWidth: 30 }    // Total Stock
					};
			}
		}

		  $("#search-box").on("input", function () {

			  var searchString = $(this).val().trim();

			  $.ajax({
				  url: "/WIPStockRegister/GlobalSearch?searchString=" + searchString,
				  type: "GET",
				  data: { searchString: searchString },
				  success: function (data) {

					  $('#divStockMainRegister').empty();
					  $('#divStockMainRegister').html(data);
					  $('#totalRows').text($('#divStockMainRegister tr').length - 1);
					  countAllTotal();
				  },
				  error: function () {
					  console.log("Error fetching search results.");
				  }
			  });
		  });

		  function GetServerDate() {
			  $.ajax({
				  type: "GET",
				  url: "@Url.Action("GetServerDate")",
				  async: false,
				  success: function (result, status, error) {
					  console.log(result);
					  if (result != null) {
						  // $('#EntryDate').datepicker({ dateFormat: 'dd/mm/yy' }).datepicker("setDate", result);
						  //$('#InvoiceDate').datepicker({ dateFormat: 'dd/mm/yy' }).datepicker("setDate", result);

						  var firstDayOfMonth = getFirstDayOfMonth(result);
						  $('#FromDate').datepicker({ dateFormat: 'dd/mm/yy' }).datepicker("setDate", firstDayOfMonth);
						  $('#ToDate').datepicker({ dateFormat: 'dd/mm/yy' }).datepicker("setDate", result);

					  }
				  }
			  });
		  }

		  function getFirstDayOfMonth(dateString) {
			  const [day, month, year] = dateString.split('/');

			  // Create a new Date object (months are 0-indexed, so subtract 1 from the month)
			  const currentDate = new Date(year, month - 1, day);

			  // Set the date to the 1st day of the month
			  currentDate.setDate(1);

			  // Format the result as dd/mm/YYYY
			  const firstDayOfMonth = `${currentDate.getDate().toString().padStart(2, '0')}/${(currentDate.getMonth() + 1).toString().padStart(2, '0')}/${currentDate.getFullYear()}`;

			  return firstDayOfMonth;
		  }

		  function FillWorkCenter() {
			  $.ajax({
				  type: "POST",
				  url: "@Url.Action("GetAllWorkCenter")",
				  dataType: "JSON",
				  async: false,
				  success: function (result, status, error) {
					  if (result != null) {
						  var obj = $.parseJSON(result);
						  if (obj.StatusCode == 200 && obj.StatusText == 'Success') {
							  $('#WCID').empty();
							  $('#WCID').append('<option value="0" selected>-Select-</option>');
							  $.each(obj.Result, function (index, val) {
								  $('#WCID').append('<option value="' + val.EntryID +
									  '">' + val.WorkCenterDescription + '</option>');
							  });
						  }
					  }
				  }
			  });
		  }

		  function countAllTotal() {

			  var rowCount = $('#divStockRegisterBody tr').length;
			  var OpnStk = 0;
			  var TotStk = 0;
			  var IssQty = 0;
			  var RecQty = 0;
			  var rate = 0;
			  var totAmount = 0;
			  for (var i = 1; i <= rowCount; i++) {
				  OpnStk += $('#opnStk-' + i).text() == '' ? 0 : parseFloat($('#opnStk-' + i).text());
				  TotStk += $('#totStk-' + i).text() == '' ? 0 : parseFloat($('#totStk-' + i).text());
				  IssQty += $('#issQty-' + i).text() == '' ? 0 : parseFloat($('#issQty-' + i).text());
				  RecQty += $('#recQty-' + i).text() == '' ? 0 : parseFloat($('#recQty-' + i).text());
				  //rate += $('#rate-' + i).text() == '' ? 0 : parseFloat($('#rate-' + i).text());
				  totAmount += $('#amount-' + i).text() == '' ? 0 : parseFloat($('#amount-' + i).text());
				  //if(totAmount < 0){
				  //    $('#SAGridRow-' + i).css('background-color', 'red');
				  //}
			  }

			  $('#totOpenStock').val(isNaN(OpnStk) ? 0 : OpnStk);
			  $('#totRecQty').val(isNaN(RecQty) ? 0 : RecQty);
			  $('#totIssueQty').val(isNaN(IssQty) ? 0 : IssQty);
			  $('#totStock').val(isNaN(TotStk) ? 0 : TotStk);
			  $('#totAmount').val(isNaN(totAmount) ? 0 : totAmount.toFixed(2));
		  }

		 /*  $('#sendToExcel').click(function () {
			  let table = $("#ReportTable");
			  console.log(table);
			  TableToExcel.convert(table[0], {
				  name: `ReportTable.xlsx`,
				  sheet: {
					  name: 'ReportTable'
				  }
			  });
		  }); */
		$('#sendToExcel').click(function () {
			var reportType = $('#ReportType').val(); 
			window.location.href = '/WIPStockRegister/ExportWIPStockRegisterToExcel?ReportType=' + encodeURIComponent(reportType);
		});
		  function FillItemGroup() {
			  $.ajax({
				  type: "POST",
				  url: "@Url.Action("GetAllItemGroups")",
				  dataType: "JSON",
				  async: false,
				  success: function (result, status, error) {

					  if (result != null) {
						  var obj = $.parseJSON(result);
						  if (obj.StatusCode == 200 && obj.StatusText == 'Success') {
							  $('#ItemGroup').empty();
							  $('#ItemGroup').append('<option value="0" selected>-Select-</option>');
							  $.each(obj.Result, function (index, val) {
								  $('#ItemGroup').append('<option value="' + val.Group_Code +
									  '">' + val.Group_name + '</option>');
							  });
						  }
					  }
				  }
			  });
		  }

		  function FillItemType() {
			  $.ajax({
				  type: "POST",
				  url: "@Url.Action("GetAllItemTypes")",
				  dataType: "JSON",
				  async: false,
				  success: function (result, status, error) {
					  if (result != null) {
						  var obj = $.parseJSON(result);
						  if (obj.StatusCode == 200 && obj.StatusText == 'Success') {
							  $('#ItemType').empty();
							  $('#ItemType').append('<option value="0" selected>-Select-</option>');
							  $.each(obj.Result, function (index, val) {
								  $('#ItemType').append('<option value="' + val.Entry_id +
									  '">' + val.Type_Item + '</option>');
							  });
						  }
					  }
				  }
			  });
		  }

		  function DeleteRow(i) {

			  var indexToRemove = i - 1;
			  $('#SAGridRow-' + i).remove();
			  $('#ReportTable tbody tr').each(function (index) {
				  $(this).attr('id', 'SAGridRow-' + (index + 1));


				  $(this).find('td:first-child a:first-child').each(function (tdIndex) {
					  $(this).attr('id', (index + 1));
				  });

				  $(this).find('td[id^="opnStk-"]').each(function (tdIndex) {
					  $(this).attr('id', 'opnStk-' + (index + 1));
				  });
				  $(this).find('td[id^="totStk-"]').each(function (tdIndex) {
					  $(this).attr('id', 'totStk-' + (index + 1));
				  });
				  $(this).find('td[id^="recQty-"]').each(function (tdIndex) {
					  $(this).attr('id', 'recQty-' + (index + 1));
				  });
				  $(this).find('td[id^="issQty-"]').each(function (tdIndex) {
					  $(this).attr('id', 'issQty-' + (index + 1));
				  });
				  $(this).find('td[id^="rate-"]').each(function (tdIndex) {
					  $(this).attr('id', 'rate-' + (index + 1));
				  });
				  $(this).find('td[id^="amount-"]').each(function (tdIndex) {
					  $(this).attr('id', 'amount-' + (index + 1));
				  });

			  });
			  //$('#ReportTable tr:eq(' + indexToRemove + ')').remove();
			  countAllTotal();
			  $('#totalRows').text($('#divStockMainRegister tr').length - 1);
		  }

		  $(document).on("click", ".sortCol", function () {
				;
			  var $column = $(this).parent().closest("th");
			  var colno = $(this).data('columnno');
			  var currentOrder = $(this).data('sortorder');

			  $('.sortCol').css('color', 'white');

			  if (currentOrder === 'asc') {
				  sortTable(colno, false);
				  $(this).data('sortorder', 'desc');
				  $(this).css('color', 'yellow'); // Visual indication of descending order
				  //$(this).css('font-size', 'larger'); // Visual indication of descending order
				  $(this).find('i:first').removeClass('fa-arrow-up');
				  $(this).find('i:first').addClass('fa-arrow-down');
			  } else {
				  sortTable(colno, true);
				  $(this).data('sortorder', 'asc');
				  $(this).css('color', 'yellow');
				  // $(this).css('font-size', 'larger'); // Visual indication of ascending order
				  $(this).find('i:first').removeClass('fa-arrow-down');
				  $(this).find('i:first').addClass('fa-arrow-up');
			  }
		  });

		  function sortTable(columnIndex, ascending) {

			  var table = $('#ReportTable');
			  var rows = table.find('#divStockRegisterBody > tr').toArray();

			  rows.sort(function (a, b) {
				  var aValue = $(a).find('td').eq(columnIndex).text();
				  var bValue = $(b).find('td').eq(columnIndex).text();

				  var aIntValue = 0;
				  var bIntValue = 0;
				  if (/^\d+$/.test(aValue) && /^\d+$/.test(bValue)) {
					  aIntValue = parseInt(aValue, 10);
					  bIntValue = parseInt(bValue, 10);
				  }

				  if (aIntValue > 0) {
					  if (ascending) {
						  return aValue - bValue;
					  } else {
						  return bValue - aValue;
					  }
				  } else {
					  if (ascending) {
						  return aValue.localeCompare(bValue);
					  } else {
						  return bValue.localeCompare(aValue);
					  }
				  }
			  });

			  $.each(rows, function (index, row) {
				  table.children('#divStockRegisterBody').append(row);
			  });
		  }


	</script>
	<script src="https://cdn.jsdelivr.net/gh/linways/table-to-excel@v1.0.4/dist/tableToExcel.js"></script>
	<!-- jsPDF core -->
	<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

	<!-- jsPDF AutoTable plugin -->
	<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
}

<style>

	.sort-icon {
		padding: 5px;
		margin: 5px;
		vertical-align: top;
	}

	.ascCol {
		font-size: 15px;
		vertical-align: bottom;
	}

	.descCol {
		font-size: 15px;
		vertical-align: super;
	}

</style>