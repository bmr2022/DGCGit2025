@model List<CancelSaleBillDetails>
@using Microsoft.AspNetCore.Http
@using System.Reflection.PortableExecutable
@{
    ViewData["Title"] = "Cancel SaleBill";
    Layout = "~/Views/Shared/_LayoutMain.cshtml";
}
@inject IHttpContextAccessor HttpContextAccessor
@{
    int SaleBillYearCode = Convert.ToInt32(HttpContextAccessor.HttpContext.Request.Query["SaleBillYearCode"]);
    int CanSaleBillReqYearcode = Convert.ToInt32(HttpContextAccessor.HttpContext.Request.Query["CanSaleBillReqYearcode"]);
    string CanRequisitionNo = HttpContextAccessor.HttpContext.Request.Query["CanRequisitionNo"];
    string Cancelreason = HttpContextAccessor.HttpContext.Request.Query["Reasonofcancel"];
    string SaleBillNo = HttpContextAccessor.HttpContext.Request.Query["SaleBillNo"];
    int EmpID = Convert.ToInt32(HttpContextAccessor.HttpContext.Session.GetString("EmpID"));
    string empName = HttpContextAccessor.HttpContext.Session.GetString("EmpName");
    string yearCode = HttpContextAccessor.HttpContext.Session.GetString("YearCode");
    string CustomerName = HttpContextAccessor.HttpContext.Request.Query["CustomerName"];

}
<div class="card-body">
    <div class="card overflow-auto">
        <div class="card-body">
            <form id="SParam">
                <center><h4>Cancel/UnCancel</h4></center>
                <div class="row">
                       <div class="col-xl-3 col-xl-3 col-lg-3 col-md-6 col-sm-6 col-xs-12">
                        <input id="approvePO" type="checkbox" style="margin-left:30px;width:15px !important;height:15px !important;" />
                        <label class="form-label" style="display: inline-block;"><strong>Click for Cancel Sale Bill</strong></label>
                       @*  @if (@typeOfApproval == "LISTOFUNCANCELEDPO")
                        {
                            <label class="form-label" style="display: inline-block;"><strong>Click for Cancel PO</strong></label>
                        }
                        else if (typeOfApproval == "LISTOFCANCELEDPO")
                        {
                            <label class="form-label" style="display: inline-block;"><strong>Click for UnCancel PO</strong></label>

                        }
                        else if (typeOfApproval == "LISTOFACTIVEPO")
                        {
                            <label class="form-label" style="display: inline-block;"><strong>Click for DeActivate PO</strong></label>

                        }
                        else if (typeOfApproval == "LISTOFDEACTIVEPO")
                        {
                            <label class="form-label" style="display: inline-block;"><strong>Click for Activate PO</strong></label>

                        } *@
                    </div>
                    <div class="col-xl-2 col-xl-3 col-lg-3 col-md-6 col-sm-6 col-xs-12">
                        <label class="form-label">Cancle Date</label>
                        <input id="cancelDate" style="display: inline-block;"readonly  class="form-control" />
                    </div>
                       <div class="col-xl-2 col-xl-3 col-lg-3 col-md-6 col-sm-6 col-xs-12">
                        <label class="form-label">Cancel By</label>
                        <input type="hidden" id="CancleById" value="@EmpID" />
                        <input id="cancelBy" style="display: inline-block;" readonly value="@empName" class="form-control" />
                    </div>
                    <div class="col-xl-3 col-xl-3 col-lg-3 col-md-6 col-sm-6 col-xs-12">
                        <div class="d-flex justify-content-right">
                            <a class="btn btn-sm btn-outline-info" style="height:30px;width:100px;margin-top:15px !important;" asp-controller="CancelSaleBill" 
                            onclick="checkCondition(event)">
                                <i class="fa-solid fa-chevron-circle-right fa-fw fa-lg"></i>SAVE
                            </a>
                        </div>
                   @*  <div class="d-flex" style="margin-left:-550px;margin-top:10px;">
                        <label class="color-box" style="background-color: red;"></label><label style="margin-left:5px;margin-top:-5px;">Rate > OldRate</label>
                        <label class="color-box" style="background-color: blue;margin-left:25px;"></label><label style="margin-left:5px;margin-top:-5px;">Rate < OldRate</label>
                    </div> *@
                </div>
        </div>
        </form>
    </div>
</div>
</div>
<div class="card-body">
    <div class="card overflow-auto">
        <div class="card-body" id="divDashboardGrid">
            <table class="table table-hover table-bordered table-striped TbCss text-nowrap mb-0">
                <thead class="bg-gradient card-headerBG text-light">
                    <tr>
                        <th>Sr#</th>
                        <th>Requisition No</th>
                        <th>Request Date</th>
                        <th>Customer</th>
                        <th>GST No</th>
                        <th>Sale Bill No</th>
                        <th>Sale Bill Date</th>
                        <th>Bill Amt</th>
                        <th>INV Net Amt</th>
                        <th>Part Code</th>
                        <th>Item Name</th>
                        <th>HSN</th>
                        <th>Bill Qty</th>
                        <th>Rate</th>
                        <th>Unit</th>
                        <th>Item Amt</th>
                        <th>SO No</th>
                        <th>SO Date</th>
                        <th>SO Year</th>
                        <th>Reason</th>
                    </tr>
                </thead>
                <tbody>
                    @{
                        var @Cntr = 0;
                        if (Model == null || Model.Count == 0)
                        {
                            <tr class="text-center"><td colspan="26" class="text-black-50"><strong>NO DATA FOUND</strong></td></tr>
                        }
                        else
                        {
                            foreach (var item in Model)
                            {
                                Cntr = Cntr + 1;
                                <tr id="dashTableGridRow-@Cntr">
                                    <td>@Cntr</td>
                                    <td>@item.CanRequisitionNo</td>
                                    <td>@item.CanSaleBillReqDate.ToString("yyyy-MM-dd")</td>
                                    <td>@item.CustomerName</td>
                                    <td>@item.GSTNO</td>
                                    <td>@item.SaleBillNo</td>
                                    <td>@item.SaleBillDate.ToString("yyyy-MM-dd")</td>
                                    <td>@item.BillAmt</td>
                                    <td>@item.INVNetAmt</td>
                                    <td>@item.PartCode</td>
                                    <td>@item.Item_Name</td>
                                    <td>@item.HSNNO</td>
                                    <td>@item.BillQty</td>
                                    <td>@item.BillRate</td>
                                    <td>@item.Unit</td>
                                    <td>@item.ItemAmount</td>
                                    <td>@item.SONO</td>
                                    <td>@item.SODate.ToString("yyyy-MM-dd")</td>
                                    <td>@item.SOYearCode</td>
                                    <td>@item.Reasonofcancel</td>
                                </tr>
                            }
                        }
                    }
                </tbody>
            </table>

        </div>
    </div>
</div>
<div class="modal fade" id="PasswordAllowPopup" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1"
     aria-labelledby="staticBackdropLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="staticBackdropLabel">Cancel SaleBill</h3>
                <button type="button" class="btn-close" data-bs-dismiss="modal" onclick="" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="card">
                    <div class="card-body">
                        <div class="row g-2 gx-3">
                            <div class="card">
                                <div class="card-body overflow-auto pb-0">
                                    <div class="col-xl-8 col-lg-8 col-md-8 col-sm-8 col-xs-12">
                                        <div class="d-flex align-items-center">
                                            <h6 class="mb-0 me-2">Do You Cancel Sale Bill?</h6>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="progress my-2" style="height: 4px;">
                        <div class="progress-bar progress-bar-striped bg-danger" role="progressbar" style="width: 100%" aria-valuenow="100" aria-valuemin="0" aria-valuemax="100"></div>
                    </div>
                </div>
                <div class="modal-footer">
                    <a href="#" class="btn btn-primary" id="btnSalebillonly">
                        Cancel Sale Bill Only
                    </a>
                    <button type="button" class="btn btn-danger" id="btnSaleBillEinvoice">Cancel Sale Bill +E-Invoice Also</button>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts
{
    <script>
        $(document).ready(function () {
            $('#cancelDate').datepicker({ dateFormat: 'dd/mm/yy' }).datepicker("setDate", 'now');
            $('#cancelDate').datepicker("option", "minDate", 'now');
            $('#cancelDate').datepicker("option", "maxDate", 'now');
         //   allowApprovingUnApproving();
            colorRates();
        });
                 $('#btnSaleBillEinvoice').on('click', function () {
            saveCancelation(true); // Cancel SaleBill + E-Invoice
        });

        $('#btnSalebillonly').on('click', function () {
            saveCancelation(false); // Cancel SaleBill only
        });


        // function allowApprovingUnApproving() {
        //     if ($('#typeOfAppr').val().includes('Final Level')) {

        //     }
        // }

                function checkCondition(event) {
            event.preventDefault();

            // Set any required values or validations here if needed

            // Show the confirmation modal
            $('#PasswordAllowPopup').modal('show');
        }
         function colorRates() {
            var size = $('#gateDashboardtable tr').length;

            for (var i = 1; i <= size; i++) {
                var curRowTds = $('#dashTableGridRow-' + i).find('td');
                if (parseInt($('#rateRow-' + i).text()) > parseInt($('#oldrateRow-' + i).text())) {
                    curRowTds.css("color", "red");
                    curRowTds.css("font-weight", "bolder");
                    $('#rateRow-' + i).css("color", "red");
                    $('#oldrateRow-' + i).css("color", "red");
                } else if (parseInt($('#rateRow-' + i).text()) < parseInt($('#oldrateRow-' + i).text())) {
                    curRowTds.css("color", "green");
                    curRowTds.css("font-weight", "bolder");
                    $('#rateRow-' + i).css("color", "blue");
                    $('#oldrateRow-' + i).css("color", "blue");
                } else {
                    curRowTds.css("color", "black");
                    $('#rateRow-' + i).css("color", "black");
                    $('#oldrateRow-' + i).css("color", "black");
                }
            }

        }


        function saveCancelation(cancelEInvoice) {
            $.ajax({
                type: "POST",
                url: "@Url.Action("SaveCancelation")",
                data: {
                    SaleBillYearCode: @SaleBillYearCode,
                    CanSaleBillReqYearcode: @CanSaleBillReqYearcode,
                    CanRequisitionNo: "@CanRequisitionNo",
                    SaleBillNo: "@SaleBillNo",
                    CancelBy: @EmpID,
                    Cancelreason: "@Model.FirstOrDefault()?.Reasonofcancel",
                    Canceldate: $('#cancelDate').val(),
                    CancelEInvoice: cancelEInvoice,
                    CustomerName:"@Model.FirstOrDefault()?.CustomerName"
                },
                success: function (response) {
                    alert(response.message || "Cancellation Saved Successfully!");
                     window.location.href = "/CancelSaleBill/CancelSaleBill";
                },
                error: function (xhr) {
                    console.error(xhr);
                    alert("Something went wrong during cancellation.");
                }
            });
        }
    </script>
}

<style>
    .color-box {
        width: 10px;
        height: 10px;
    }
</style>
