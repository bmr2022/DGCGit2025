@model eTactWeb.DOM.Models.GateAttendanceModel
@{
    ViewData["Title"] = "Gate Attendance";
    Layout = "~/Views/Shared/_LayoutMain.cshtml";
}

@if (!string.IsNullOrEmpty(ViewBag.Message))
{
    <div class="alert alert-success">@ViewBag.Message</div>
}
<div class="card bg-gradient mb-3 border-light shadow-lg">
    <form asp-action="GateAttendance" autocomplete="off" class="form-horizontal" method="post" enctype="multipart/form-data">
        <input type="hidden" asp-for="Mode" value="@Model.Mode" />
        <input type="hidden" asp-for="EID" />
        <div class="card-header card-headerBG text-light bg-gradient">
            <h5>
                <strong>@ViewData["Title"] - @Model.GateAttYearCode</strong>
                <span class="d-flex float-end" style="margin-top:-2px;">
                    @if (Model.Mode == "U" && Model.Mode != "POC" && Model.Mode != "V")
                    {
                    }
                    <a asp-action="Dashboard" asp-route-ID="0" class="btn btn-sm btn-outline-light bg-gradient" style="margin-right:5px;">
                        <i class="fa-solid fa-grip fa-lg fa-fw fa-beat" style="--fa-animation-duration: 2s;"></i>
                        Dashboard
                    </a>

                    @* <partial name="_FormsButton" /> *@
                    <div class="row justify-content-between g-2">
                        <div class="col-auto">
                            <input asp-for="FromDateBack" type="hidden" value="@Model.FromDateBack" />
                            <input asp-for="ToDateBack" type="hidden" value="@Model.ToDateBack" />
                            @* <input asp-for="DashboardTypeBack" type="hidden" value="@Model.DashboardTypeBack" />
                            <input asp-for="AttendanceEntryMethodTypeBack" type="hidden" value="@Model.AttendanceEntryMethodTypeBack" /> *@
                            <input asp-for="DashDepartmentBack" type="hidden" value="@Model.DashDepartmentBack" />
                            <input asp-for="DashCategoryBack" type="hidden" value="@Model.DashCategoryBack" />
                            <input asp-for="DashDesignationBack" type="hidden" value="@Model.DashDesignationBack" />
                            <input asp-for="DashEmployeeBack" type="hidden" value="@Model.DashEmployeeBack" />
                            <input asp-for="GlobalSearchBack" type="hidden" value="@Model.GlobalSearchBack" />

                            <a href="#" class=" btn btn-primary btn-sm" onclick="PressBack();">
                                <i class="fa fa-chevron-circle-left fa-fw fa-lg" aria-hidden="true"></i>
                                BACK
                            </a>
                        </div>
                        @if (Model.Mode != "V" && Model.Mode != "SOC" && Model.Mode != "POC")
                        {
                            <div class="col-auto">
                                <a class="btn btn-secondary btn-sm" onclick="location.href=$('form')[0].action">
                                    <i class="fa fa-refresh fa-fw fa-lg" aria-hidden="true"></i>
                                    REFRESH
                                </a>
                            </div>
                            @if (Model.Mode == "U")
                            {
                                <div class="col-auto">
                                    <button type="button" class="btn btn-sm btn-outline-light bg-gradient" id="UpdateButton">
                                        <i class="fa fa-pencil-square fa-fw fa-lg" aria-hidden="true"></i>
                                        UPDATE
                                    </button>
                                    <span class="d-flex float-end" style="margin-top:-2px;">
                                        <a asp-action="GateAttendance" asp-route-ID="0" class="btn btn-sm btn-outline-light bg-gradient" id="savebtn">
                                            <i class="fa fa-plus-circle fafw fa-lg" aria-hidden="true"></i>
                                            Add New
                                        </a>
                                    </span>
                                </div>
                            }

                            else
                            {
                                <div class="col-auto">
                                    <button type="button" class="btn btn-primary btn-sm" id="submitBTN">
                                        <i class="fa-solid fa-chevron-circle-right"></i>
                                        SUBMIT
                                    </button>
                                </div>
                            }
                        }
                    </div>
                </span>
            </h5>
        </div>
        <div class="card-body bg-light pt-0">
            <div class="accordion shadow-lg">
                <div class="accordion-item">
                    <h2 class="accordion-header" id="HPanel1">
                        <button class="accordion-button text-light pnl4BG bg-gradient" type="button" data-bs-toggle="collapse" data-bs-target="#BPanel1" aria-expanded="true" aria-controls="BPanel1">
                            <i class="fa-brands fa-wpforms fa-lg fa-fw pr35"></i>
                            Required Parameter
                            <small class="p-3"></small>
                        </button>
                    </h2>
                    <div id="BPanel1" class="accordion-collapse collapse show pnl4 bg-gradient" aria-labelledby="HPanel1">
                        <partial name="_GateAttMain" />
                        <input type="hidden" asp-for="TypeOfSave" value="" />
                        <input type="hidden" asp-for="EntryByMachineName" value="" />
                        <input type="hidden" asp-for="IsIncreamented" value="@Model.IsIncreamented" />
                    </div>
                </div>
                <div class="accordion-item">
                    <h2 class="accordion-header" id="HPanel2">
                        <button class="accordion-button collapsed text-light pnl1BG bg-gradient" type="button" data-bs-toggle="collapse" data-bs-target="#BPanel2" aria-expanded="true" aria-controls="BPanel2">
                            <strong style="text-transform:uppercase"><i class="fa-solid fa-table-list fa-lg fa-fw pr35 fa-fade" style="--fa-animation-duration: 2s; --fa-fade-opacity: 0.6;"></i>Attendance Grid</strong>
                        </button>
                        @* <button class="GridButton btn btn-sm btn-outline-danger" style="width:150px; text-wrap-mode: nowrap;" type="button">
                            <i class="fa-solid fa-angles-down fa-fw fa-lg "></i>ADD TO GRID
                        </button> *@
                    </h2>
                    <div id="BPanel2" class="accordion-collapse collapse pnl1 bg-gradient" aria-labelledby="HPanel2">
                        <div class="accordion-body">
                            <div class="progress my-2 mb-3" style="height: 4px;">
                                <div class="progress-bar progress-bar-striped bg-secondary progress-bar-animated" role="progressbar" style="width: 100%" aria-valuenow="100" aria-valuemin="0" aria-valuemax="100"></div>
                            </div>
                            <div class="card">
                                <div class="col-xl-2 col-lg-6 col-md-6 col-sm-6 col-xs-12" style="margin-top:10px;margin-left: calc(90% - 100px);">
                                    <input type="text" class="form-control" id="search-box" style="background-color:#FFFACD" placeholder="Search...">
                                </div>
                                <div id="attendanceItemGrid">
                                    <partial name="_GateManualAttendance" />
                                </div>
                            </div>
                            <div class="progress my-3 mb-3" style="height: 4px;">
                                <div class="progress-bar progress-bar-striped bg-warning" role="progressbar" style="width: 100%" aria-valuenow="100" aria-valuemin="0" aria-valuemax="100"></div>
                            </div>
                            <div class="row g-2 gx-3">
                                <div class="col-12 text-center">
                                    <strong>TOTAL NO OF Employees : <span id="lblItemCount"></span></strong>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="card-header card-headerBG text-light bg-gradient">
            <h5>
                <strong>@ViewData["Title"] - @Model.GateAttYearCode</strong>
                <span style="display:none;" id="GateAttYearCode">@Model.GateAttYearCode</span>
                <span class="d-flex float-end" style="margin-top:-2px;">
                    @if (Model.Mode == "U" && Model.Mode != "POC" && Model.Mode != "V")
                    {
                    }
                    <a asp-action="Dashboard" asp-route-ID="0" class="btn btn-sm btn-outline-light bg-gradient" style="margin-right:5px;">
                        <i class="fa-solid fa-grip fa-lg fa-fw fa-beat" style="--fa-animation-duration: 2s;"></i>
                        Dashboard
                    </a>

                    @* <partial name="_FormsButton" /> *@
                    <div class="row justify-content-between g-2">
                        <div class="col-auto">
                            <input asp-for="FromDateBack" type="hidden" value="@Model.FromDateBack" />
                            <input asp-for="ToDateBack" type="hidden" value="@Model.ToDateBack" />
                            @* <input asp-for="DashboardTypeBack" type="hidden" value="@Model.DashboardTypeBack" />
                            <input asp-for="AttendanceEntryMethodTypeBack" type="hidden" value="@Model.AttendanceEntryMethodTypeBack" /> *@
                            <input asp-for="DashDepartmentBack" type="hidden" value="@Model.DashDepartmentBack" />
                            <input asp-for="DashCategoryBack" type="hidden" value="@Model.DashCategoryBack" />
                            <input asp-for="DashDesignationBack" type="hidden" value="@Model.DashDesignationBack" />
                            <input asp-for="DashEmployeeBack" type="hidden" value="@Model.DashEmployeeBack" />
                            <input asp-for="GlobalSearchBack" type="hidden" value="@Model.GlobalSearchBack" />

                            <a href="#" class=" btn btn-primary btn-sm" onclick="PressBack();">
                                <i class="fa fa-chevron-circle-left fa-fw fa-lg" aria-hidden="true"></i>
                                BACK
                            </a>
                        </div>
                        @if (Model.Mode != "V" && Model.Mode != "SOC" && Model.Mode != "POC")
                        {
                            <div class="col-auto">
                                <a class="btn btn-secondary btn-sm" onclick="location.href=$('form')[0].action">
                                    <i class="fa fa-refresh fa-fw fa-lg" aria-hidden="true"></i>
                                    REFRESH
                                </a>
                            </div>
                            @if (Model.Mode == "U")
                            {
                                <div class="col-auto">
                                    <button type="button" class="btn btn-sm btn-outline-light bg-gradient" id="UpdateButton">
                                        <i class="fa fa-pencil-square fa-fw fa-lg" aria-hidden="true"></i>
                                        UPDATE
                                    </button>
                                </div>
                                <div class="col-auto">
                                    <a asp-action="GateAttendance" asp-route-ID="0" class="btn btn-sm btn-outline-light bg-gradient" id="savebtn">
                                        <i class="fa fa-plus-circle fafw fa-lg" aria-hidden="true"></i>
                                        Add New
                                    </a>
                                </div>
                            }
                            else
                            {
                                <div class="col-auto">
                                    <button type="button" class="btn btn-primary btn-sm" id="submitBTN">
                                        <i class="fa-solid fa-chevron-circle-right"></i>
                                        SUBMIT
                                    </button>
                                </div>
                            }
                        }
                </span>
            </h5>
        </div>
    </form>
</div>


@section Scripts
{
    <script>
        $(function () {
            $('#EntryByMachineName').val($('#machineName').text());
            $('.DH').fadeOut();
            if ('@Model.Mode' != '' && parseInt('@Model.ID') != 0) {
            }
            else {
                window.setInterval(function () {
                    Dat = new Date();
                    let am_pm = (Dat.getHours() >= 12) ? "PM" : "AM";
                    var time = Dat.getHours() + ":" + Dat.getMinutes() + ":" + Dat.getSeconds() + " - " + am_pm;
                    //console.log(time);
                    $('#EntryTime').val(time);
                }, 1000);
            }
        });
        $(document).ready(function () {
            GetFormRights();
            //LockedFinancialYear(); //use to disable submit when not in fianancial year
            var monthNames = {
                "Jan": "01",
                "Feb": "02",
                "Mar": "03",
                "Apr": "04",
                "May": "05",
                "Jun": "06",
                "Jul": "07",
                "Aug": "08",
                "Sep": "09",
                "Oct": "10",
                "Nov": "11",
                "Dec": "12"
            };
            var finFromDate = $('#FinFromDate').val();
            var finToDate = $('#FinToDate').val();
            var findateParts1 = finFromDate.split("/");
            var finformattedDate1 = findateParts1[0] + "/" + monthNames[findateParts1[1]] + "/" + findateParts1[2];
            var findateParts2 = finToDate.split("/");
            var finformattedDate2 = findateParts2[0] + "/" + monthNames[findateParts2[1]] + "/" + findateParts2[2];

            var NFromDate = $('#NFromDate').val();
            var NToDate = $('#NToDate').val();
            var NdateParts1 = NFromDate.split("/");
            var NformattedDate1 = NdateParts1[0] + "/" + monthNames[NdateParts1[1]] + "/" + NdateParts1[2];
            var NdateParts2 = NToDate.split("/");
            var NformattedDate2 = NdateParts2[0] + "/" + monthNames[NdateParts2[1]] + "/" + NdateParts2[2];

            var minDate = parseCustomDate($("#NFromDate").val());
            var maxDate = parseCustomDate($("#NToDate").val());
            var today = new Date(); today.setHours(0,0,0,0);
            var defaultDate = (today < minDate) ? minDate : (today > maxDate ? maxDate : today);
            fillEntryId();
            if ($('#Mode').val() == "U" || $('#Mode').val() == "V" || $('#IsIncreamented').val().toLowerCase() == "true") {
                //var strEmpAttDate = $('#strEmpAttDate').val().split("-").join("/");
                //strEmpAttDate = parseDateToFormat(strEmpAttDate.split(" ")[0]);
                var strEmpAttDate = $('#strEmpAttDate').val();
                $('#strEmpAttDate').datepicker("destroy").datepicker({ dateFormat: 'dd/M/yy' }).datepicker("setDate", strEmpAttDate);
                isallcheckedonmodify = true;
            }
            else {
                $('#strEmpAttDate').val('').datepicker("destroy").datepicker({dateFormat: 'dd/M/yy', minDate: minDate, maxDate: maxDate}).datepicker("setDate", defaultDate);
            }
            DayorMonthChange();
            EmpAttDateOnChange();
            $('#EmployeeCode').select2();
            updateItemCount();
            if($('#IsIncreamented').val().toLowerCase() == 'true') {
                ShowManualAttandance();
            }
            const url = new URL(window.location.href);
             if (url.searchParams.has("IsIncreament")) {
                let ref = url.searchParams.get("IsIncreament");
                url.searchParams.delete("IsIncreament");
                window.history.replaceState({}, "", url.toString());
            }
            initTimePickers12();
        });

        function parseCustomDate(str) {
            var parts = str.split("/");
            var day = parseInt(parts[0], 10);
            var monthNames = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
            var month = monthNames.indexOf(parts[1]); // 0-based
            var year = parseInt(parts[2], 10);
            return new Date(year, month, day);
        }

        $(document).on('keyup', '.form-control', function (e) {
            var keyCode = e.keyCode || e.which;
            if (keyCode == 9) {
                if ($(this).parent("#BPanel1").length > 0) {
                    if ($(this).is(":focus")) {
                        var fControl = $(this).parent().next().find('.datePickerControl');
                        if (fControl.length > 0 && fControl.is(":focus")) {
                            $(this).parent().next().find('.datePickerControl').focus();
                        }
                        else {
                            $(this).parent().next().find(":focusable").focus();
                        }
                    }
                }
            }
        });

        var tabIndx = 0;
        $(":focusable").each(function () {
            $(this).attr("tabindex", ++tabIndx);
        });

        var currentSearchColumn = null;
        $("#search-box").on("keyup", function () {
            var value = $(this).val().toLowerCase();
            $(".itemgridBody tr").filter(function () {
                if (currentSearchColumn !== null) {
                    var columnText = $(this).find('td').eq(currentSearchColumn).text().toLowerCase();
                    $(this).toggle(columnText.indexOf(value) > -1);
                } else {
                    $(this).toggle($(this).text().toLowerCase().indexOf(value) > -1);
                }
            });
        });

        $(document).on("click", "th[data-columnno]", function () {
            currentSearchColumn = $(this).data('columnno');
            $("#search-box").val('').trigger('keyup'); // Reset search box and trigger the search
        });

        $(document).on("click", ".sortCol", function () {
            var colno = parseInt($(this).attr("data-columnno")); // SAFEST
            var tableid = $(this).closest("table")[0].id;        // ALWAYS CORRECT
            var currentOrder = $(this).data("sortorder");
            $('.sortCol').css('color', 'white').find("i").removeClass("fa-arrow-up fa-arrow-down");
            if (currentOrder === 'asc') {
                sortTable(colno, false, tableid);
                $(this).data('sortorder', 'desc');
                $(this).css('color', 'yellow').find('i:first').removeClass('fa-arrow-up').addClass('fa-arrow-down');
            } else {
                sortTable(colno, true, tableid);
                $(this).data('sortorder', 'asc');
                $(this).css('color', 'yellow').find('i:first').removeClass('fa-arrow-down').addClass('fa-arrow-up');
            }
        });

        function sortTable(columnIndex, ascending, tableid) {
                const table = $('#' + tableid);
                const rows = table.find('tbody > tr').toArray();
                const getCellValue = td => $(td).find("input[type='checkbox']").length ? $(td).clone().find("input").remove().end().text().trim() : $(td).find("input[type!='checkbox']").val()?.trim() || $(td).find("select option:selected").text()?.trim() || $(td).text().trim();
                rows.sort((a, b) => {
                    let tdA = $(a).find('td').eq(columnIndex), tdB = $(b).find('td').eq(columnIndex);
                    let aVal = getCellValue(tdA);
                    let bVal = getCellValue(tdB);
                    aVal = aVal.trim(); bVal = bVal.trim();
                    const isTimeA = /^\d{2}:\d{2}$/.test(aVal) || aVal === "--:--";
                    const isTimeB = /^\d{2}:\d{2}$/.test(bVal) || bVal === "--:--";
                    if (isTimeA && isTimeB) {
                        if (aVal === "--:--") return 1;
                        if (bVal === "--:--") return -1;
                        const [ah, am] = aVal.split(":").map(Number), [bh, bm] = bVal.split(":").map(Number);
                        const tA = ah * 60 + am, tB = bh * 60 + bm;
                        return ascending ? tA - tB : tB - tA;
                    }
                    const aNum = parseFloat(aVal), bNum = parseFloat(bVal);
                    const aIsNum = !isNaN(aNum), bIsNum = !isNaN(bNum);
                    if (aIsNum && !bIsNum) return ascending ? -1 : 1;
                    if (!aIsNum && bIsNum) return ascending ? 1 : -1;
                    if (aIsNum && bIsNum) {
                        if (aNum !== bNum) return ascending ? aNum - bNum : bNum - aNum;
                        return ascending ? aVal.length - bVal.length : bVal.length - aVal.length;
                    }
                    const len = Math.max(aVal.length, bVal.length);
                    for (let i = 0; i < len; i++) {
                        const aChar = aVal[i] || "", bChar = bVal[i] || "";
                        if (aChar === bChar) continue;
                        const diff = aChar.localeCompare(bChar);
                        return ascending ? diff : -diff;
                    }
                    return ascending ? aVal.length - bVal.length : bVal.length - aVal.length;
                });
                $.each(rows, (i, r) => table.children('tbody').append(r));
        }
        $(document).on('select2:open', () => {
            document.querySelector('.select2-search__field').focus();
        });

        function ValidateForm() {
            // if ($('#EmployeeCode').val() === "" || $('#EmployeeCode').val() === "0") {
            //     $.notify("Please select employee code", "error");
            //     e.preventDefault();
            //     return false;
            // }
            return true;
        }

        function collectGateAttendanceModel() {
            var model = {};
            // collect top-level model fields
            model.GateAttEntryId = ($('#GateAttEntryId').val() != "0" && $('#GateAttEntryId').val() != null) ? parseInt($('#GateAttEntryId').val()) : 0;
            model.GateAttEntryDate = ($('#GateAttEntryDate').val() != null) ? parseDateToFormat($('#GateAttEntryDate').val()) : null;
            model.GateAttYearCode = ($('#GateAttYearCode').val() != null) ? parseInt($('#GateAttYearCode').val()) : 0;
            model.AttendanceType = $('#AttendanceType').val();
            model.AttendanceEntryMethodType = $('#AttendanceEntryMethodType').val();
            model.DayOrMonthType = $('#DayOrMonthType').val();
            model.strEmpAttDate = ($('#strEmpAttDate').val() != null && $('#strEmpAttDate').val() != '') ? parseDateToFormat($('#strEmpAttDate').val()).toString() : null;
            model.strEmpAttMonth = $('#strEmpAttMonth :selected').text();
            model.intEmpAttMonth = ($('#strEmpAttMonth').val() != "0" && $('#strEmpAttMonth').val() != null) ? parseInt($('#strEmpAttMonth').val()) : 0;
            model.GateAttEntryDay = $('#GateAttEntryDay').val();
            model.EmployeeCode = ($('#EmployeeCode').val() != "0" && $('#EmployeeCode').val() != null) ? $('#EmployeeCode :selected').text() : "0";
            model.EmpId = ($('#EmployeeCode').val() != "0" && $('#EmployeeCode').val() != null) ? parseInt($('#EmployeeCode').val()) : 0;
            model.CategoryCode = ($('#CategoryCode').val() != "0" && $('#CategoryCode').val() != null) ? $('#CategoryCode').val() : "0";
            model.EmpCategoryId = ($('#EmpCategoryId').val() != "0" && $('#EmpCategoryId').val() != null) ? $('#EmpCategoryId').val() : "0";
            // collect selected employees
            model.GateAttDetailsList = [];
            let missingEmpList = [];
            document.querySelectorAll("input[name='selectedEmpIds']:checked").forEach(function (cb) {
                var empId = cb.value;
                var row = cb.closest("tr");
                if (!row) return;

                var deptEl = row.querySelector("[name='dept_" + empId + "']");
                var desigEl = row.querySelector("[name='desig_" + empId + "']");
                var EmpShiftId = row.querySelector("[name='GateAttDetailsList[" + empId + "].ActualEmpShiftId']");
                var CategoryId = row.querySelector("[name='GateAttDetailsList[" + empId + "].CategoryId']");

                var empObj = {
                    EmpId: parseInt(empId, 10) || 0,
                    DeptId: deptEl ? parseInt(deptEl.value, 10) || 0 : 0,
                    DesignationEntryId: desigEl ? parseInt(desigEl.value, 10) || 0 : 0,
                    ActualEmpShiftId: EmpShiftId ? parseInt(EmpShiftId.value, 10) || 0 : 0,
                    CategoryId: CategoryId ? parseInt(CategoryId.value, 10) || 0 : 0,
                    Attendance: {}
                };
                 row.querySelectorAll("input[name^='Attendance[" + empId + "]']").forEach(function (inp) {
                    var name = inp.getAttribute("name");
                    var keyMatch = name.match(/\]\[(\d+)\((.*?)\)\]/) || name.match(/\[(\d+)\]\[([A-Za-z]+)\)?]/);
                    if (keyMatch) {
                        if($('#DayOrMonthType').val().toLowerCase() == 'daily') {
                             let dateStr = document.getElementById("strEmpAttDate").value;
                            let date = (dateStr) ? new Date(dateStr) : null;
                            var day = (date != null) ? date.getDate() : 0;                            
                            var type = keyMatch[2];
                        }
                        else {
                            var day = keyMatch[1];
                            var type = keyMatch[2]; 
                        }
                        var dictKey = (type.toLowerCase() === "intime" ? "AttInTime" : (type.toLowerCase() === "attendstatus" ? "AttendStatus"  : (type.toLowerCase() === "totalnoofhour" ? "TotalNoOfHour" : "AttOutTime"))) + day;
                        empObj.Attendance[dictKey] = (type.toLowerCase() === "attendstatus") ? "P" : ((type.toLowerCase() === "totalnoofhour") ? "0"  : (inp.value || ""));
                    }
                });
                if ($('#DayOrMonthType').val().toLowerCase() == 'daily') {
                    let anyMissing = Object.values(empObj.Attendance).some(v => !v || v.trim() === "");
                    if (anyMissing) {
                        let srNo = $("#SrNo_" + empId).text().trim();
                        let nameText = $("#EmpName_" + empId).text().trim();
                        let code = $("#EmpCode_" + empId).text().trim();
                        let empRow = $("#selectedEmp_" + empId).closest("tr");
                        missingEmpList.push({ id: empId, srNo, name: nameText, code, row: empRow });
                    }
                } else if ($('#DayOrMonthType').val().toLowerCase() == 'monthly') {
                    let allEmpty = Object.values(empObj.Attendance).every(v => !v || v.trim() === "");
                    if (allEmpty) {
                        let srNo = $("#SrNo_" + empId).text().trim();
                        let nameText = $("#EmpName_" + empId).text().trim();
                        let code = $("#EmpCode_" + empId).text().trim();
                        let empRow = $("#selectedEmp_" + empId).closest("tr");
                        missingEmpList.push({ id: empId, srNo, name: nameText, code, row: empRow });
                    }
                }
                model.GateAttDetailsList.push(empObj);
            });
             if (missingEmpList.length > 0) {
                // reset background for all selected rows
                $("input[name='selectedEmpIds']:checked").each(function () {
                    $(this).closest("tr").css("background-color", "");
                });

                // highlight missing rows
                missingEmpList.forEach(emp => emp.row.css("background-color", "#ffe6e6"));

                let msgList = missingEmpList.map(emp => `${emp.srNo}. ${emp.name} (${emp.code})`).join("\n");
                let msg = `The following employees have missing time entries. Please enter the required time for them, or Do you want to mark them as Absent? click Cancel for any modification: \n\n${msgList}\n\n`;

                if (confirm(msg)) {
                    missingEmpList.forEach(emp => {
                        let checkbox = document.getElementById("selectedEmp_" + emp.id);
                        if (checkbox) checkbox.checked = false;
                        emp.row.css("background-color", "");
                        model.GateAttDetailsList = model.GateAttDetailsList.filter(e => e.EmpId != emp.id);
                    });
                } else {
                    return false; // stop save
                }
            }
             // ADD UNCHECKED EMPLOYEES WITH EMPTY ATTENDANCE — ONLY IF SHIFT EXISTS
            document.querySelectorAll("input[name='selectedEmpIds']").forEach(function (cb) {
                 if (!cb.checked) {
                    var empId = cb.value;
                    var row = cb.closest("tr");
                    if (!row) return model;
                    // shift required
                    var EmpShiftIdEl = row.querySelector("[name='GateAttDetailsList[" + empId + "].ActualEmpShiftId']");
                    if (!EmpShiftIdEl) return model;
                    var deptEl = row.querySelector("[name='dept_" + empId + "']");
                    var desigEl = row.querySelector("[name='desig_" + empId + "']");
                    var CategoryEl = row.querySelector("[name='GateAttDetailsList[" + empId + "].CategoryId']");
                    var empObj = {
                        EmpId: parseInt(empId, 10) || 0,
                        DeptId: deptEl ? parseInt(deptEl.value, 10) || 0 : 0,
                        DesignationEntryId: desigEl ? parseInt(desigEl.value, 10) || 0 : 0,
                        ActualEmpShiftId: EmpShiftIdEl ? parseInt(EmpShiftIdEl.value, 10) || 0 : 0,
                        CategoryId: CategoryEl ? parseInt(CategoryEl.value, 10) || 0 : 0,
                        Attendance: {}
                    }
                    // find all attendance inputs for this employee
                    row.querySelectorAll("input[name^='Attendance[" + empId + "]']").forEach(function (inp) {
                        var name = inp.getAttribute("name");
                        // SAME REGEX you used for checked employees
                        var keyMatch = name.match(/\]\[(\d+)\((.*?)\)\]/) || name.match(/\[(\d+)\]\[([A-Za-z]+)\]?]/);
                        if (keyMatch) {
                            let day = keyMatch[1];
                            let type = keyMatch[2]; // InTime / OutTime
                            var dictKey = (type.toLowerCase() === "intime" ? "AttInTime" : (type.toLowerCase() === "attendstatus" ? "AttendStatus"  : (type.toLowerCase() === "totalnoofhour" ? "TotalNoOfHour" : "AttOutTime"))) + day;
                            empObj.Attendance[dictKey] = (type.toLowerCase() === "attendstatus") ? "A" : ((type.toLowerCase() === "totalnoofhour") ? "0" : ""); // EMPTY VALUE
                        }
                    });
                    // finally add into model
                    model.GateAttDetailsList.push(empObj);
                }
            });
            return model;
        }
        $("#submitBTN, #UpdateButton").on("click", function(e) 
        { 
            e.preventDefault(); // stop page refresh
            submitAttendanceAjax();
        });
        function submitAttendanceAjax() {
            $('#submitBTN, #UpdateButton').prop('disabled', true).html('Validating Form... <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>');
            var IsErr = 0;
            if (!ValidateForm()) {
                event.preventDefault();
                resetButtonText('#submitBTN, #UpdateButton');
            }
            else {
                var model = collectGateAttendanceModel();
                if (model == null || model == false) {
                    $.notify("Please fill the missing attendance entries either it will be added as Absentwhen you click on ok.", "error");
                    IsErr = 1;
                }
                // else if (!model.GateAttDetailsList || model.GateAttDetailsList.length === 0) {
                //     $.notify("Please select at least one employee before submitting.", "error");
                //     IsErr = 1;
                // }
                if(IsErr==1){
                    event.preventDefault();
                    resetButtonText('#submitBTN, #UpdateButton');
                }
                else{
                    console.log("Payload:", model);
                     $.ajax({
                        url: '@Url.Action("GateAttendance", "GateAttendance")',
                        type: "POST",
                        //contentType: "application/json; charset=utf-8",
                        //data: JSON.stringify(model),
                        data: model,
                        success: function (res) {
                            if (res != null && res.isSuccess == true) {
                                $.notify(res?.message || "Attendance saved successfully!", "success");
                                resetButtonText('#submitBTN, #UpdateButton');
                                setTimeout(function () {
                                    window.location.href = '@Url.Action("GateAttendance", "GateAttendance")' + '?ID=' + res.ID + '&Mode=' + $('#Mode').val() + '&YearCode=' + $('#GateAttYearCode').val() + '&IsIncreament=' + true;
                                }, 1500);       
                            }
                            else if (res != null && res.isSuccess == false) {
                                $.notify(res?.message || "Something went wrong", "error");
                                resetButtonText('#submitBTN, #UpdateButton');
                            }
                        },
                        error: function (xhr) {
                            $.notify("Error saving attendance", "error");
                            console.error("AJAX error:", xhr.responseText);
                            resetButtonText('#submitBTN, #UpdateButton');
                        }
                    });
                }
            }
        }

        function resetButtonText(btn) {
            if ($(btn).attr('id') === "submitBTN") {
                $(btn).prop('disabled', false).html('<i class="fa-solid fa-chevron-circle-right"></i> SUBMIT');
            } else {
                $(btn).prop('disabled', false).html('<i class="fa fa-pencil-square fa-fw fa-lg"></i> UPDATE');
            }
        }

        function copyToClipboardForDropdown(element) {
            var $temp = $("<input>");
            $("body").append($temp);
            ;
            $temp.val($(element).find(":selected").text()).select();
            document.execCommand("copy");
            $temp.remove();
        }

        function GetFormRights() {
            $.ajax({
                url: "@Url.Action("GetFormRights")",
                type: "POST",
                success: function (data) {
                    if (data != null) {
                        var obj = $.parseJSON(data);
                        if (obj.Result.Table.length == 0) {
                            if ($('#Mode').val() == "POA") {
                                $('.AmendButton').prop("disabled", true);
                            }
                            $('#submitBTN').prop("disabled", true);
                            $('.card-footer #submitBTN').prop("disabled", true);
                        } else {
                            var optAll = obj.Result.Table[0].OptAll;
                            var optSave = obj.Result.Table[0].OptSave;
                            var optUpdate = obj.Result.Table[0].OptUpdate;
                            var optDelete = obj.Result.Table[0].OptDelete;
                            var optView = obj.Result.Table[0].OptView;
                            if (!optAll) {
                                if (!optSave) {
                                    if ($('#Mode').val() == "POA") {
                                        $('.AmendButton').prop("disabled", true);
                                    }
                                    $('#submitBTN').prop("disabled", true);
                                    $('.card-footer #submitBTN').prop("disabled", true);
                                    $('#UpdateButton').prop("disabled", true);
                                    $('.card-footer #UpdateButton').prop("disabled", true);
                                    $('.PartialSave').prop("disabled", true);
                                }
                            }
                        }
                    }
                },
                error: function (errMsg) {
                    $.notify(errMsg, { position: "top center", className: "error" });
                }
            });
        }

        function copyToClipboardForDropdown(element) {
            var $temp = $("<input>");
            $("body").append($temp);
            $temp.val($(element).find(":selected").text()).select();
            document.execCommand("copy");
            $temp.remove();
        }

        $(document).on('keypress', ':input:not(textarea):not([type=button])', function (e) {
            if (e.which == 13) e.preventDefault();
        });
    </script>
}
<!-- jQuery FIRST -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<!-- Then Select2 -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/css/select2.min.css" rel="stylesheet" />
<script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/js/select2.min.js"></script>

<!-- Then other plugins that depend on jQuery -->
<script src="https://cdn.jsdelivr.net/gh/linways/table-to-excel@v1.0.4/dist/tableToExcel.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css" />
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<!-- Optional (makes AM/PM UI nicer) -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/themes/material_blue.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/notify/0.4.2/notify.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-validate/1.19.5/jquery.validate.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-validation-unobtrusive/3.2.13/jquery.validate.unobtrusive.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/timepicker/1.3.5/jquery.timepicker.min.css" />
<script src="https://cdnjs.cloudflare.com/ajax/libs/timepicker/1.3.5/jquery.timepicker.min.js"></script>

<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

<style>
    #poTable {
        width: 100%;
        border-collapse: collapse;
    }

    #poThead th {
        background-color: #127387;
        position: sticky;
        top: 0;
        z-index: 1;
    }

    .table-container, .table-responsive {
        width: 100%;
        overflow-x: auto;
        overflow-y: auto;
        white-space: nowrap;
        border: 1px solid #ccc;
    }

    .itemgridTable {
        border-collapse: collapse;
        table-layout: fixed;
        width: max-content;
        min-width: 100%;
    }

    .itemgridHead th {
        background-color: #127387;
        position: sticky;
        top: 0;
        z-index: 1;
        min-width: 10px;
        padding: 6px;
        white-space: nowrap;
        resize: horizontal;
        overflow: auto;
    }

    .itemgridTable td {
        padding: 6px;
        min-width: 80px;
        font-weight: normal !important;
    }

    .resize-handle {
        position: absolute;
        right: 0;
        top: 0;
        width: 6px;
        height: 100%;
        cursor: col-resize;
        user-select: none;
    }

        .resize-handle::after {
            content: '';
            position: absolute;
            right: 3px;
            top: 20%;
            width: 2px;
            height: 60%;
            background: rgba(0,0,0,0.3);
            border-radius: 1px;
        }

    .itemgridHead th input[type="checkbox"] {
        margin: 0 4px 0 0;
        vertical-align: middle;
    }

    .select2-search__field {
        z-index: 10000 !important; /* Adjust the value as needed */
    }

    .weekoff-time {
        color: red !important;
        font-weight: bold;
    }

    .holiday-time {
        color: #5b00ff !important;
        font-weight: bold;
    }

    .lighten {
        filter: brightness(135%);
    }
</style>

<script type="text/javascript">
    let isallcheckedonmodify = false;
    function DayorMonthChange(e) {
            var obj = $('#DayOrMonthType :selected').val();
            if (obj && obj.toLowerCase() === "daily") {
                $('.dvEmpAttDate').show();
                $('.dvGateAttEntryDay').show();
                if($('#Mode').val() != 'V' && $('#Mode').val() != 'U' && $('#IsIncreamented').val().toLowerCase() == 'false') {
                    $('#strEmpAttDate').select(0);
                }
                else {
                    if(isallcheckedonmodify == true && ($('#Mode').val() == "U" || $('#Mode').val() == "V")) {
                        document.querySelectorAll("input[name='selectedEmpIds']").forEach(cb => {
                            let empId = cb.value;
                            let status = document.getElementById("txt_" + empId + "_AttendStatus").value;
                            // Only check P/p rows
                            if (status.toUpperCase() === "P") {
                                cb.checked = true;
                            } else {
                                cb.checked = false;
                            }
                        });
                        checkUncheckEmp();
                        isallcheckedonmodify = false;
                    }
                }
                $('.dvEmpAttMonth').hide();
                $('#strEmpAttMonth').prop("selectedIndex", 0);
                 $('#CategoryCode').val($('#EmpCategoryId').val());
            }
            else if (obj && obj.toLowerCase() === "monthly") {
                $('.dvEmpAttMonth').show();
                $('.dvEmpAttDate').hide();
                if($('#Mode').val() != 'V' && $('#Mode').val() != 'U' && $('#IsIncreamented').val().toLowerCase() == 'false') {
                    $('#strEmpAttMonth').val('');
                }
                else {
                    if(ValidateNull($('#intEmpAttMonth').val())) {
                        $('#strEmpAttMonth').prop("selectedIndex", $('#intEmpAttMonth').val());
                    }
                    else{
                        $('#strEmpAttMonth').val($('#strEmpAttMonth').val());
                    }
                    $('#CategoryCode').val($('#EmpCategoryId').val());
                    if(isallcheckedonmodify == true && ($('#Mode').val() == "U" || $('#Mode').val() == "V")) {
                        document.querySelectorAll("input[name='selectedEmpIds']").forEach(cb => {
                            let empId = cb.value;
                            let status = document.getElementById("txt_" + empId + "_AttendStatus").value;
                            // Only check P/p rows
                            if (status.toUpperCase() === "P") {
                                cb.checked = true;
                            } else {
                                cb.checked = false;
                            }
                        });
                        checkUncheckEmp();
                        isallcheckedonmodify = false;
                    }
                }
                $('.dvGateAttEntryDay').hide();
                $('#strEmpAttDate').val("");
            }
            else {
                $('.dvEmpAttDate').show();
                $('.dvGateAttEntryDay').show();
                if($('#Mode').val() != 'V' && $('#Mode').val() != 'U' && $('#IsIncreamented').val().toLowerCase() == 'false') {
                    $('#strEmpAttDate').select(0);
                }
                else {
                    if(isallcheckedonmodify == true && ($('#Mode').val() == "U" || $('#Mode').val() == "V")) {
                        document.querySelectorAll("input[name='selectedEmpIds']").forEach(cb => {
                            let empId = cb.value;
                            let status = document.getElementById("txt_" + empId + "_AttendStatus").value;
                            // Only check P/p rows
                            if (status.toUpperCase() === "P") {
                                cb.checked = true;
                            } else {
                                cb.checked = false;
                            }
                        });
                        checkUncheckEmp();
                        isallcheckedonmodify = false;
                    }
                }
                $('.dvEmpAttMonth').hide();
                $('#strEmpAttMonth').prop("selectedIndex", 0);
            }
        }

    function EmpAttDateOnChange() {
            let dateStr = document.getElementById("strEmpAttDate").value;
            if (dateStr) {
                let date = new Date(dateStr);
                let options = { weekday: 'long' };
                let dayName = date.toLocaleDateString('en-US', options);
                let year = date.getFullYear();
                console.log("Day:", dayName, "Year:", year);
                $('#GateAttEntryDay').val(dayName);
            }
        }

    function ShowManualAttandance() {
            var date = $("#strEmpAttDate").val();
            var attmonth = $("#strEmpAttMonth").val();
            var yearcode = $("#GateAttYearCode").val();
            var DayOrMonthType = $("#DayOrMonthType").val();
            var EmpCatId = $("#CategoryCode").val();
            var IsErr = 0;
            if (!DayOrMonthType) {
                    $.notify("Please select a Day or Month.", "error");
                    IsErr = 1;
            }
            if (DayOrMonthType) {
                    if (DayOrMonthType.toLowerCase() == "daily" && (date == null || date ==undefined || date == "")) {
                           $.notify("Please select a Attendance Date", "error");
                            IsErr = 1;
                    }
                    if (DayOrMonthType.toLowerCase() == "monthly" && (attmonth == null || attmonth ==undefined || attmonth == "" || attmonth == "0")) {
                             $.notify("Please select a Attendance Month", "error");
                             IsErr = 1;
                    }
                    if (DayOrMonthType.toLowerCase() == "monthly" && (EmpCatId == null || EmpCatId ==undefined || EmpCatId == "" || EmpCatId == "0")) {
                             $.notify("Please select Category", "error");
                             IsErr = 1;
                    }
            }
            if (IsErr === 0) {
                $.ajax({
                    url: '/GateAttendance/LoadAttendanceGrid',
                    type: 'GET',
                    data: { DayOrMonthType: DayOrMonthType, Attdate: date, AttMonth: attmonth, YearCode: yearcode, EmpCatId: EmpCatId  },
                    success: function (result) {
                            $("#attendanceItemGrid").html(result);
                            updateItemCount();
                            initTimePickers12();
                            if(DayOrMonthType.toLowerCase() == "daily")
                            {
                                if (($('#isholiday').val() != null && $('#isholiday').val() != undefined && $('#isholiday').val().toLowerCase() == "true") || ($('#isweekoff').val() != null && $('#isweekoff').val() != undefined && $('#isweekoff').val().toLowerCase() == "true")) {
                                    let message = $('#isholiday').val().toLowerCase() == "true"
                                        ? "This day is a Holiday. Do you still want to edit attendance?"
                                        : "This day is a Week-Off. Do you still want to edit attendance?";

                                    if (!confirm(message)) {
                                                $("#attendanceItemGridbody").html("<input id='rowitemcount' type='hidden' value='0' /><tr id='norecord'><td colspan='8' class='text-center'>No records found.</td></tr>");
                                                $('#GateAttEntryOffDay').text('');
                                                $('.dvGateAttEntryOffDay').hide();
                                    }
                                    else {
                                        var textblock = ($('#isholiday').val() != null && $('#isholiday').val() != undefined && $('#isholiday').val().toLowerCase() == "true") ? "Holiday" : "Week-Off";
                                        var textclass = ($('#isholiday').val() != null && $('#isholiday').val() != undefined && $('#isholiday').val().toLowerCase() == "true") ? "holiday-time lighten" : "weekoff-time lighten";
                                        $('#GateAttEntryDay').addClass(textclass);
                                        $('#GateAttEntryOffDay').addClass(textclass);
                                        $('#GateAttEntryOffDay').text(textblock);
                                        $('.dvGateAttEntryOffDay').show();
                                    }
                                }
                                else {
                                    $('#GateAttEntryOffDay').text('');
                                    $('.dvGateAttEntryOffDay').hide();
                                }
                            }
                    },
                    error: function () {
                        console.log("Error loading attendance grid.");
                    }
                });
            }
        }
    function updateItemCount() {
        var count = $("#attendanceItemGrid tbody tr").length;
        if($("#norecord").length && count > 0) {
            count = count - 1;
        }
        $("#lblItemCount").text(count);
    }
    function fillEntryId() {
            //ENTRYID
            $.ajax({
                type: "GET",
                url: "@Url.Action("FillEntryId")",
                dataType: "json",
                data: { "YearCode": $('#GateAttYearCode').val() },
                success: function (result, status, error) {
                    if($('#Mode').val() != 'V' && $('#Mode').val() != 'U') {
                        if (result != null) {
                            var obj = $.parseJSON(result);
                            var EntryId = obj.Result.Table[0] != null ? obj.Result.Table[0].EntryId : (obj.Result.Table1[0] != null ? obj.Result.Table1[0].EntryId : 0);
                            $('#GateAttEntryId').val(EntryId);
                        }
                    }
                }
            });
        }
    function initItemGridResize() {
      document.querySelectorAll('.itemgridTable').forEach(function (table) {
        if (table.dataset.resizable === "true") return;
        table.dataset.resizable = "true";

        // Remove old colgroup to recalc widths fresh
        const oldColgroup = table.querySelector('colgroup');
        if (oldColgroup) oldColgroup.remove();

        const ths = table.querySelectorAll('thead th');
        const colgroup = document.createElement('colgroup');

        ths.forEach(th => {
          const col = document.createElement('col');
          const naturalWidth = th.offsetWidth;
          let initWidth;

          // Intime / Outtime columns → compact (30px minimum)
          if (/\d+\(in|outtime\)/i.test(th.textContent)) {
            initWidth = Math.max(30, naturalWidth);
          }
          else {
            // Descriptive columns → wider (≥120px)
            initWidth = Math.max(120, naturalWidth);
          }

          col.style.width = initWidth + 'px';
          colgroup.appendChild(col);
        });

        table.insertBefore(colgroup, table.firstChild);

        const cols = table.querySelectorAll('col');

        ths.forEach((th, i) => {
          if (th.querySelector('.resize-handle')) return;

          const handle = document.createElement('div');
          handle.className = 'resize-handle';
          th.style.position = 'relative';
          th.appendChild(handle);

          let startX, startWidth;

          handle.addEventListener('mousedown', function (e) {
            startX = e.clientX;
            startWidth = cols[i].offsetWidth;
            document.addEventListener('mousemove', onMouseMove);
            document.addEventListener('mouseup', onMouseUp);
          });

          function onMouseMove(e) {
            const diff = e.clientX - startX;
            let newWidth = startWidth + diff;

            // Enforce different minimums
            if (/\d+\(in|outtime\)/i.test(th.textContent)) {
              if (newWidth < 30) newWidth = 30;
            } else {
              if (newWidth < 120) newWidth = 120;
            }

            cols[i].style.width = newWidth + 'px';
          }

          function onMouseUp() {
            document.removeEventListener('mousemove', onMouseMove);
            document.removeEventListener('mouseup', onMouseUp);
          }
        });
      });
    }
    function onclickCheckEmp() {
        const master = document.getElementById("checkAllEmp");
        document.querySelectorAll("input[name='selectedEmpIds']").forEach(cb => cb.checked = master.checked);
    }
    function checkUncheckEmp(empid) {
        const all = document.querySelectorAll("input[name='selectedEmpIds']");
        const checked = document.querySelectorAll("input[name='selectedEmpIds']:checked");
        document.getElementById("checkAllEmp").checked = (all.length === checked.length);
    }
    function ondeptlistchange(empid) {
        if (document.getElementById("checkDeptSync")?.checked) {
                let dropdown = document.getElementById("dept_" + empid);
        if (dropdown) {
            document.querySelectorAll(".dept-dd").forEach(other => {
                other.value = dropdown.value;
            });
        }
        }
    }
    function ondesiglistchange(empid) {
        if (document.getElementById("checkDesigSync")?.checked) {
               let dropdown = document.getElementById("desig_" + empid);
        if (dropdown) {
            document.querySelectorAll(".desig-dd").forEach(other => {
                other.value = dropdown.value;
            });
        }
        }
    }
    function onclickCheckDate(dayNo) {
        let checkboxes = document.querySelectorAll("input[type='checkbox'][data-day='" + dayNo + "']");
        let isChecked = event.target.checked;
        checkboxes.forEach(cb => cb.checked = isChecked);

        document.querySelectorAll("input.att-input[data-day='" + dayNo + "']").forEach(function (el)
        {
            if (isChecked) {
                el.removeAttribute("disabled");
            } else {
                el.setAttribute("disabled", "disabled");
            }
        });
    }
    document.addEventListener('DOMContentLoaded', initItemGridResize);
    function PressBack() {
        sessionStorage.setItem('FromDateBack', $('#FromDateBack').val());
        sessionStorage.setItem('ToDateBack', $('#ToDateBack').val());
        // sessionStorage.setItem('DashboardTypeBack', $('#DashboardTypeBack').val());
        // sessionStorage.setItem('AttendanceEntryMethodTypeBack', $('#AttendanceEntryMethodTypeBack').val());
        sessionStorage.setItem('DashDepartmentBack', $('#DashDepartmentBack').val());
        sessionStorage.setItem('DashCategoryBack', $('#DashCategoryBack').val());
        sessionStorage.setItem('DashDesignationBack', $('#DashDesignationBack').val());
        sessionStorage.setItem('DashEmployeeBack', $('#DashEmployeeBack').val());
        sessionStorage.setItem('GlobalSearchBack', $('#GlobalSearchBack').val());
        window.history.back();
    }
</script>

<script> // scripts for setting 12 hour format at timepicker
    function initTimePickers12() {
        // Destroy previous instances (avoids duplicates when grid reloads)
        document.querySelectorAll(".timepicker").forEach(el => {
            if (el._flatpickr) el._flatpickr.destroy();
        });

        // Apply Flatpickr 12-hour time
        flatpickr(".timepicker", {
            enableTime: true,
            noCalendar: true,
            dateFormat: "h:i K",        // 12-hour format with AM/PM
            time_24hr: false,
            allowInput: true,
            minuteIncrement: 1,
            defaultHour: null,
            defaultMinute: null,
            onReady: (val, now, inst) => {
                if (!inst.input.value) inst.input.placeholder = "--:--";
            },
            onValueUpdate: (selDate, val, inst) => {
                // Converts to 24h when saving to model
                let t = formatTo24(val);
                inst.input.setAttribute("data-24", t || "");
            }
        });
    }

    // Convert selected 12h to 24h when needed
    function formatTo24(time12) {
        if (!time12) return "";
        let d = new Date("1970-01-01 " + time12);
        if (isNaN(d)) return "";
        return d.toISOString().substring(11, 16);  // HH:mm
    }
</script>