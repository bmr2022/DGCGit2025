@model eTactWeb.DOM.Models.MRNRegisterModel
@{
    ViewData["Title"] = "MRN Inward Register";
    Layout = "~/Views/Shared/_LayoutMain.cshtml";
}
<style>

    .select2-container--default .select2-selection--single {
        background-color: #e0f2f1;
        border: 1.5px solid #0a0a0a !important;
        border-radius: 4px;
    }

        .select2-container--default .select2-selection--single .select2-selection__rendered {
            /* border-bottom: 1.5px solid #000 !important; */
            border-bottom: none !important;
        }

    .select2-container--default .select2-results > .select2-results__options {
        background-color: #e0f2f1; /* Dropdown background color */
        color: #000;
</style>

<div class="card bg-gradient mb-3 border-light shadow-lg">

    <div class="card-header card-headerBG text-light bg-gradient">
        <h5>
            <strong>MRN Register</strong>
           <span class="d-flex float-end" style="margin-top:-2px;">
                @*<a asp-action="Dashboard" asp-route-ID="0" class="btn btn-sm btn-outline-light bg-gradient">*@

            </span>
        </h5>
    </div>
    <div>
    </div>
    <div class="card-body bg-light pt-0">
        <div class="accordion shadow-lg">
            <div class="card-body">
                <div class="card overflow-auto">
                    <div class="card-body">
                        <form id="SParam">
                            <div class="row">

                                <div class="col-xxl-2 col-xl-3 col-lg-3 col-md-6 col-sm-12 col-xs-12">
                                    <div class="row">
                                        <div class="col">
                                            <label class="form-label">From Date</label>
                                            <input asp-for="FromDate" class="form-control" />
                                        </div>
                                        <div class="col">
                                            <label class="form-label">To Date</label>
                                            <input asp-for="ToDate" class="form-control" />
                                        </div>
                                    </div>
                                </div>
                                <div class="col-xxl-2 col-xl-3 col-lg-3 col-md-6 col-sm-6 col-xs-12">
                                    <label asp-for="MRNType" class="form-label" style="color: blue;">MRN Type</label>
                                    <select asp-for="MRNType" class="form-select" style="background-color:#f8aa86;">
                                        <option  value="">ALL</option>
                                        <option selected value="MRN">MRN</option>
                                        <option value="JWMRN">JW MRN</option>
                                        <option value="JWMRN">MRN+JW MRN</option>
                                        <option value="CUSTJW">CUST JW  </option>
                                        </select>
                                </div>
                                <div class="col-xxl-2 col-xl-3 col-lg-3 col-md-6 col-sm-6 col-xs-12">
                                        
                                    <label asp-for="ReportType" class="form-label" style="color: blue;">Report Type</label>
                                    <select asp-for="ReportType" class="form-select" style="background-color:#f8aa86;">
                                        <option selected value="DETAIL">DETAIL</option>
                                        <option selected value="vendorItemWiseSummary">VENDOR ITEM WISE SUMMARY</option>
                                        <option value="vendorItemWiseConsolidated">VENDOR ITEM WISE CONSOLIDATED</option>
                                        <option value="vendorWiseConsolidated">VENDOR WISE CONSOLIDATED </option>
                                        <option value="ItemWiseConsolidated">ITEM WISE CONSOLIDATED </option>
                                        <option value="DAYWISEMRNENTRYLIST">DAY WISE MRN ENTRY</option>
                                        <option value="PENDMRNFORQC(SUMMARY)">PENDING MRN FOR QC (SUMMARY)</option>
                                        <option value="PENDMRNFORQC(DEATIL)">PENDING MRN FOR QC (DETAIL) </option>
                                        <option value="Short Excess Register">Short Excess Register </option>

                                        <option value="mrnqcdetail">MRN QC DETAIL </option>
                                    </select>
                                </div>

                                <div class="col-xl-2 col-lg-2 col-md-6 col-sm-6 col-xs-12">
                                    <label asp-for="VendorName" class="form-label">VendorName</label>
                                    <div class="form-check form-switch mx-3 w-auto position-absolute d-inline"> 
                                    </div>
                                    <select asp-for="VendorName" class="form-control">
                                        <option value="">-Select-</option>
                                    </select>
                                </div>
                                <div class="col-xxl-2 col-xl-3 col-lg-3 col-md-6 col-sm-6 col-xs-12">
                                    <label asp-for="gateno" class="form-label">Gate Entry No</label>
                                    <select asp-for="gateno" class="form-select">
                                        <option value="">-Select-</option>
                                    </select>
                                </div>
                                <div class="col-xxl-2 col-xl-3 col-lg-3 col-md-6 col-sm-6 col-xs-12">
                                    <label asp-for="MRNno" class="form-label">MRN No</label>
                                    <select asp-for="MRNno" class="form-select">
                                        <option value="">-Select-</option>
                                    </select>
                                </div>
                                <div class="col-xxl-2 col-xl-3 col-lg-3 col-md-6 col-sm-6 col-xs-12">
                                    <label asp-for="invoiceNo" class="form-label">Invoice No</label>
                                    <select asp-for="invoiceNo" class="form-select">
                                        <option value="">-Select-</option>
                                    </select>
                                </div>
                                <div class="col-xxl-2 col-xl-3 col-lg-3 col-md-6 col-sm-6 col-xs-12">
                                    <label asp-for="PONo" class="form-label">PONO</label>
                                    <select asp-for="PONo" class="form-select">
                                        <option value="">-Select-</option>
                                    </select>
                                </div>

                                <div class="col-xxl-2 col-xl-3 col-lg-3 col-md-6 col-sm-6 col-xs-12">
                                    <label asp-for="Schno" class="form-label">Sch No</label>
                                    <select asp-for="Schno" class="form-select">
                                    </select>
                                </div>
                                 
                                <div class="col-xxl-2 col-xl-3 col-lg-3 col-md-6 col-sm-6 col-xs-12">
                                    <label asp-for="PartCode" class="form-label">Part Code</label>
                                    <select asp-for="PartCode" class="form-select">
                                    </select>
                                </div>
                                <div class="col-xxl-2 col-xl-3 col-lg-3 col-md-6 col-sm-6 col-xs-12">
                               <label asp-for="ItemName" class="form-label">Item Name</label>
                                    <select asp-for="ItemName" class="form-select">
                                    </select>
                                </div>
                                
                                <div class="col-xxl-2 col-xl-3 col-lg-3 col-md-6 col-sm-6 col-xs-12">
                                    <label asp-for="docname" class="form-label">Document Type</label>
                                    <select asp-for="docname" class="form-select">
                                    </select>
                                </div>
                   @*              <div class="col-xxl-2 col-xl-3 col-lg-3 col-md-6 col-sm-6 col-xs-12">
                                    <label asp-for="VendorName" class="form-label">Vendor Name</label>
                                    <input asp-for="VendorName" class="form-control" />
                                </div> *@
                                 
                                <div class="col-sm-2 col-md-6 col-lg-4 col-xl-2">
                                    <label class="form-label">Global search</label>
                                    <input type="text" class="form-control" id="search-box" style="background-color:#FFFACD" placeholder="Search...">
                                </div>
                                @*<div class="col-xxl-2 col-xl-3 col-lg-3 col-md-6 col-sm-6 col-xs-12">
                                <label asp-for="Type" class="form-label">Type</label>
                                <select asp-for="Type" class="form-select">
                                <option value="Summary" selected>Summary</option>
                                <option value="Detail">Detail</option>
                                </select>
                                </div>*@
                                <div class=" d-flex justify-content-center mt-3" width="inherit">

                                    <button class="btn btn-sm btn-outline-info" type="button" style="padding:0px;height:30px;width:100px;" onclick="GetMRNRegisterData();">
                                        <i class="fa-solid fa-magnifying-glass fa-fw fa-lg"></i>SEARCH
                                    </button>
                                    <button class="btn btn-sm btn-outline-success" style="padding:3px;height:30px;width:100px;margin-left:20px;" type="button" id="sendToExcel">
                                        <i class="fa-solid fa-upload fa-fw fa-lg "></i>EXCEL
                                    </button>
                                    <button class="btn btn-sm btn-outline-danger" style="padding:3px; height:30px; width:100px; margin-left:20px;" type="button" id="sendToPDF">
                                        <i class="fa-solid fa-file-pdf fa-fw fa-lg"></i> PDF
                                    </button>
                                    <a class="btn btn-sm btn-outline-danger" style="padding:3px;height:30px;width:100px;margin-left:20px;" asp-controller="MRNRegister" asp-action="MRNRegister">
                                        <i class="fa-solid fa-rotate fa-fw fa-lg"></i>RESET
                                    </a>
                                </div>

                            </div>

                            <div class="progress my-2 mb-3" style="height: 4px;">
                                <div class="progress-bar progress-bar-striped bg-secondary progress-bar-animated" role="progressbar" style="width: 100%" aria-valuenow="100" aria-valuemin="0" aria-valuemax="100"></div>
                            </div>
                            <div class="accordion-item">
                                <h2 class="accordion-header" id="H_SAGrid">
                                    <button class="accordion-button collapsed text-light pnl4BG bg-gradient" type="button" data-bs-toggle="collapse" data-bs-target="#B_SAGrid" aria-expanded="true" aria-controls="B_SAGrid">
                                        <strong style="text-transform:uppercase"><i class="fa-solid fa-table-list fa-lg fa-fw pr35 fa-fade" style="--fa-animation-duration: 2s; --fa-fade-opacity: 0.6;"></i>Item Detail Grid</strong>
                                    </button>
                                </h2>

                                <div id="B_SAGrid" class="accordion-collapse collapse pnl4 bg-gradientn show" aria-labelledby="H_SAGrid">
                                    <div class="accordion-body">
                                        <div class="card-body" id="divPendingMRP">
                                            <div class="row">
                                                <div class="col-md-12 divStockRegister" id="divStockMainRegister">
                                                    <partial name="_MRNRegisterGrid" />
                                                </div>

                                            </div>
                                        </div>
                                        <center>
                                            <div class="row">
                                                <div class="col-xxl-2 col-xl-3 col-lg-3 col-md-6 col-sm-6 col-xs-12" id="opnStkDiv">
                                                    <label class="form-label">Total Bill Qty</label>
                                                    <input id="totOpenStock" class="form-control" readonly />
                                                </div>
                                                <div class="col-xxl-2 col-xl-3 col-lg-3 col-md-6 col-sm-6 col-xs-12" id="opnStkDiv">
                                                    <label class="form-label">Total Rec Qty</label>
                                                    <input id="totRecQty" class="form-control" readonly />
                                                </div>
                                                <div class="col-xxl-2 col-xl-3 col-lg-3 col-md-6 col-sm-6 col-xs-12" id="opnStkDiv">
                                                    <label class="form-label">Total Short/Excess</label>
                                                    <input id="totshrotexcess" class="form-control" readonly />
                                                </div>
                                                <div class="col-xxl-2 col-xl-3 col-lg-3 col-md-6 col-sm-6 col-xs-12" id="stockDiv">
                                                    <label class="form-label">Total Amount</label>
                                                    <input id="totAmount" class="form-control" readonly />
                                                </div>
                                            </div>
                                        </center>
                                    </div>

                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

        </div>
    </div>


</div>

@section Scripts
    {
    <script>

        $(function () {
             
            GetServerDate();
            $('#B_SAGrid').addClass('show');//open accordion on ready
            var currentDate = new Date();
            var firstDayOfMonth = new Date(currentDate.getFullYear(), currentDate.getMonth(), 1);
            $('#totalRows').text($('#divStockRegisterBody tr').length);
            $('#FromDate').datepicker({ dateFormat: 'dd/mm/yy' }).datepicker("setDate", formatDate1(firstDayOfMonth));
            $('#ToDate').datepicker({ dateFormat: 'dd/mm/yy' }).datepicker("setDate", 'now');
                 $('#gateno').select2();
            $('#PONo').select2();
            $('#Schno').select2();
            $('#ItemName').select2();
            $('#PartCode').select2();
            $('#docname').select2();
            $('#invoiceNo').select2();
            $('#VendorName').select2();
            $('#ReportType').select2();
            $('#MRNno').select2();
            FillGateNo();

            FillItemNamePartcode();
            FillDocument();
            FillVendor();
            FillInvoice();
            FillPONO();
            FillSchNo();
            FillMRNNo();

            GetMRNRegisterData();//INITIAL - ON LOAD METHOD
        });
       
        $('#sendToPDF').click(async function () {
             
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF({ orientation: 'portrait', unit: 'pt', format: 'a4' });

            // Get dynamic values
            var reportTypeText = $('#ReportType').find(":selected").text();
            var reportTypeValue = $('#ReportType').val();

            var mrnTypeText = $('#MRNType').find(":selected").text();
            var mrnTypeValue = $('#MRNType').val();

            var fromDate = $('#FromDate').val();
            var toDate = $('#ToDate').val();

            var vendorName = $('#VendorName').val();
            var gateNo = $('#gateno').val();
            var mrnNo = $('#MRNno').val();
            var invoiceNo = $('#invoiceNo').val();
            var poNo = $('#PONo').val();
            var schNo = $('#Schno').val();
            var partCode = $('#PartCode').val();
            var itemName = $('#ItemName').val();
            var docName = $('#docname').val();

            // Additional fields you mentioned:
            var workCenter = $('#WCID').find(":selected").text();
            var itemGroup = $('#ItemGroup').val();
            var itemType = $('#ItemType').val();
            var batchNo = $('#BatchNo').val();
            var uniqueBatchNo = $('#UniqueBatchNo').val();

            // Report Title
            doc.setFontSize(16).text(reportTypeText, 40, 40);

            // Date Range
            doc.setFontSize(10).text(`For the duration From: ${fromDate}     To: ${toDate}`, 40, 58);

            let currentY = 75;
            const headerFields = [
               /*  { label: 'Report Type (Text)', value: reportTypeText || '' },
                { label: 'Report Type (Value)', value: reportTypeValue || '' },
                { label: 'MRN Type (Text)', value: mrnTypeText || '' },
                { label: 'MRN Type (Value)', value: mrnTypeValue || '' },
                { label: 'From Date', value: fromDate || '' },
                { label: 'To Date', value: toDate || '' },
                { label: 'Vendor Name', value: vendorName || '' },
                { label: 'Gate Entry No', value: gateNo || '' },
                { label: 'MRN No', value: mrnNo || '' },
                { label: 'Invoice No', value: invoiceNo || '' },
                { label: 'PO No', value: poNo || '' },
                { label: 'Sch No', value: schNo || '' },
                { label: 'Part Code', value: partCode || '' },
                { label: 'Item Name', value: itemName || '' },
                { label: 'Document Type', value: docName || '' },
                { label: 'Work Center', value: (workCenter && workCenter !== '-Select-') ? workCenter : '' },
                { label: 'Item Group', value: itemGroup || '' },
                { label: 'Item Type', value: itemType || '' },
                { label: 'Batch No', value: batchNo || '' },
                { label: 'Unique Batch No', value: uniqueBatchNo || '' } */
            ];

            // Filter out any fields with empty values
            const filled = headerFields.filter(field => field.value);

            // If there is at least one non-empty value, print the header
            if (filled.length > 0) {
                filled.forEach(field => {
                    doc.setFontSize(10)
                        .text(`${field.label}: ${field.value}`, 40, currentY);
                    currentY += 15;
                });
            }

            // Fetch data
            var resp = await fetch('/MRNRegister/GetMRNRegisterData');
            var rows = await resp.json();

            // Declare headers and body
            let headers = [];
            let body = [];

            // Handle report type logic
            switch (reportTypeValue) {
                case 'vendorItemWiseSummary':
                    headers = [
                        "Sr#","Vendor Name", "MRN No", "MRN Date", "Gate No", "Gate Date", "Invoice No",
                        "Invoice Date", "Document No", "Part Code", "Item Name", "Bill Quantity",
                        "Received Quantity", "Short/Excess Quantity", "Unit",  
                        "Actual Entry By Employee", "Actual Entry Date", 
                        "Currency", "Received In Store", "MRN Type"
                    ];
                    console.log("Data:", rows);
                    body = rows.map((r, i) => [
                        i + 1, r.vendorName, r.mrnNo, r.mrnDate, r.gateNo, r.gDate,
                        r.invoiceNo, r.invoiceDate, r.docNo, r.partCode, r.itemName,
                        r.billQty, r.recQty, r.shortExcessQty, r.unit,
                        r.actualEntryByEmp, r.actualEntryDate, r.currency,
                        r.recInStore, r.mrnType
                    ]);
                break;
                case 'vendorItemWiseConsolidated':
                    headers = [
                        "Sr#", "Part Code", "Item Name", "Bill Quantity",
                        "Received Quantity", "Short/Excess Quantity", "Unit",
                        "Total Amount", "MRN Type"
                    ];
                    console.log("Data:", rows);
                    body = rows.map((r, i) => [
                        i + 1, r.partCode,r.itemName, r.billQty, r.recQty,  r.shortExcessQty,
                        r.unit,r.totalAmt, r.mrnType
                    ]);
                break;
                case 'vendorWiseConsolidated':
                    headers = [
                        "Sr#", "Vendor Name", "Bill Quantity",
                        "Received Quantity", "Short/Excess Quantity",
                        "Total Amount", "MRN Type"
                    ];
                    console.log("Data:", rows);
                    body = rows.map((r, i) => [
                        i + 1, r.vendorName, r.billQty,  r.recQty, r.shortExcessQty,
                        r.totalAmt,  r.mrnType
                    ]);
                break;

                case 'ItemWiseConsolidated':
                    headers = [
                        "Sr#", "Part Code", "Item Name", "Bill Quantity",
                        "Received Quantity", "Short/Excess Quantity",
                        "Unit", "Rate", "Total Amount", "MRN Type"
                    ];

                    console.log("Data:", rows);
                    body = rows.map((r, i) => [
                        i + 1, r.partCode, r.itemName,r.billQty,r.recQty,
                        r.shortExcessQty,r.unit,r.rate,r.totalAmt,r.mrnType
                    ]);
                break;

                case 'DAYWISEMRNENTRYLIST':
                    headers = [
                        "Sr#", "MRN No", "MRN Date", "Gate No", "Vendor Name", "Invoice No",
                        "Invoice Date", "Document No", "Bill Quantity", "Received Quantity",
                        "Currency", "Received In Store", "MRN Type", "MRN QC Completed",
                        "Need To Check QC", "Vendor Address", "Actual Entry By Employee",
                        "Actual Entry Date", "Last Updated By", "Last Updated Date", "Entry By Machine Name"
                    ];

                    console.log("Data:", rows);
                    body = rows.map((r, i) => [
                        i + 1,r.mrnNo, r.mrnDate,r.gateNo,r.vendorName,r.invoiceNo,
                        r.invoiceDate,r.docNo, r.billQty,r.recQty, r.currency,
                        r.recInStore,r.mrnType, r.mrnQcCompleted,r.needTochkQc,
                        r.vendAddress,r.actualEntryByEmp, r.actualEntryDate,
                        r.lastUpdatedby, r.lastUpdatedDate,r.entryByMachineName
                    ]);
                break;
                case 'PENDMRNFORQC(SUMMARY)':
                    headers = [
                        "Sr#", "Vendor Name", "MRN No", "MRN Date", "Gate No", "Gate Date",
                        "Invoice No", "Invoice Date", "Total Bill Quantity", "Received Quantity",
                        "Total Amount", "Purchase Bill Posted", "MRN Type"
                    ];

                    console.log("Data:", rows);
                    body = rows.map((r, i) => [
                        i + 1,r.vendorName, r.mrnNo, r.mrnDate, r.gateNo, r.gDate,
                        r.invoiceNo, r.invoiceDate, r.totalBillQty, r.recQty,r.totalAmt,
                        r.purchaseBillPosted,r.mrnType
                    ]);
                break;
                case 'PENDMRNFORQC(DEATIL)':
                    headers = [
                        "Sr#", "Vendor Name", "MRN No", "MRN Date", "Gate No", "Gate Date",
                        "Invoice No", "Invoice Date", "Part Code", "Item Name", "Total Bill Quantity",
                        "Received Quantity", "Rate", "Total Amount", "PO No", "PO Date", "PO Type",
                        "Schedule No", "Schedule Date", "QC Completed", "Purchase Bill Posted"
                    ];

                    console.log("Data:", rows);
                    body = rows.map((r, i) => [
                        i + 1, r.vendorName, r.mrnNo, r.mrnDate, r.gateNo, r.gDate, r.invoiceNo, r.invoiceDate, r.partCode, r.itemName,
                        r.totalBillQty, r.recQty, r.rate, r.totalAmt, r.poNo, r.poDate, r.poType, r.schNo, r.schDate, r.qcCompleted, r.purchaseBillPosted
                    ]);

                break;
                case 'Short Excess Register':
                    headers = [
                        "Sr#", "MRN No", "MRN Date", "InvNo", "Invoice Date", "Account Name",
                         "Part Code", "Item Name", "Bill Qty", "Rec Qty",
                        "Sh/ExQty", "Rate", "Total amt"
                    ];

                    console.log("Data:", rows);
                    
                    body = rows.map((r, i) => [
                        i + 1, r.mrnNo, parseDateToFormat(r.mrnDate), r.invoiceNo, r.invoiceDate, r.account_Name,
                        r.partCode, r.itemName, r.billQty, r.recQty, r.shortExcessQty, 
                        r.rate, r.totalAmt
                    ]);
                break;


                // Add more cases for different report types here if needed
                default:
                    headers = [
                        "Sr#", "Vendor Name", "MRN No", "MRN Date", "Gate No", "Gate Date", "Entry Date", "Invoice No",
                        "Invoice Date", "Document No", "PO No", "PO Date", "PO Type", "Schedule No", "Schedule Date",
                        "Part Code", "Item Name", "Bill Quantity", "Received Quantity", "Short/Excess Quantity", "Unit",
                        "Rate", "Amount", "Alt Quantity", "Alt Unit", "QC Completed", "MRN QC Completed", "Need to Check QC",
                        "Batch No", "Unique Batch No", "Supplier Batch No", "Shelf Life", "Total Amount", "Net Amount", "Remark",
                        
                        "FOC", "Department Name", "Currency", "Received In Store", "MRN Type", "Vendor Address"
                    ];
                    body = rows.map((r, i) => [
                        i + 1, r.vendorName, r.mrnNo, r.mrnDate, r.gateNo, r.gDate, r.entryDate, r.invoiceNo,
                        r.invoiceDate, r.docNo, r.poNo, r.poDate, r.poType, r.schNo, r.schDate, r.partCode, r.itemName,
                        r.billQty, r.recQty, r.shortExcessQty, r.unit, r.rate, r.amount, r.altQty, r.altUnit,
                        r.qcCompleted, r.mrnQcCompleted, r.needToChkQc, r.batchNo, r.uniqueBatchNo, r.supplierBatchNo,
                        r.shelfLife, r.totalAmt, r.netAmount, r.remark, r.foc, r.depName, r.currency, r.recInStore, r.mrnType,
                        r.vendAddress
                    ]);
                    break;
            }

            // Generate table with custom column width handling
            let finalY = 0;
            doc.autoTable({
                startY: currentY + 15, // Adjust the starting Y position
                head: [headers],
                body: body,
                styles: { cellWidth: 'wrap' },
                theme: 'grid',
                margin: { left: 5, right: 5 },
                tableWidth: 'wrap',
                styles: {
                    fontSize: 9,
                    textColor: [0, 0, 0],
                    cellPadding: 2,        
                    overflow: 'linebreak',
                    halign: 'center',
                    valign: 'middle'
                },
                headStyles: {
                    fillColor: [41, 128, 185],
                    textColor: 255,
                    fontStyle: 'bold'
                },
                tableWidth: 'auto',
                /* columnStyles: {
                    0: { cellWidth: 30 },   // Column 1: Sr#
                    1: { cellWidth: 50 },   // Column 2: VendorName
                    2: { cellWidth: 50 },   // Column 3: MRNNo
                    3: { cellWidth: 30 },   // Column 4: MRNDate
                    4: { cellWidth: 60 },   // Column 5: GateNo
                    5: { cellWidth: 30 },   // Column 6: GDate
                    6: { cellWidth: 40 },   // Column 7: InvoiceNo
                    7: { cellWidth: 40 },   // Column 8: InvoiceDate
                    8: { cellWidth: 60 },   // Column 9: DocNo
                    9: { cellWidth: 50 },   // Column 10: PartCode
                    10: { cellWidth: 60 },  // Column 11: ItemName
                    11: { cellWidth: 20 },  // Column 12: BillQty
                    12: { cellWidth: 20 },  // Column 13: RecQty
                    13: { cellWidth: 20 },  // Column 14: ShortExcessQty
                    14: { cellWidth: 20 },  // Column 15: Unit
                    15: { cellWidth: 40 },  // Column 16: Amount
                    16: { cellWidth: 40 },  // Column 17: TotalAmt
                    17: { cellWidth: 40 },  // Column 18: NetAmount
                    18: { cellWidth: 30 },  // Column 19: Remark
                    19: { cellWidth: 30 },  // Column 20: ActualEntryByEmp
                    20: { cellWidth: 40 },  // Column 21: ActualEntryDate
                   
                   
                }, */
                showHead: 'everyPage',
                didDrawPage: function (data) {
                    finalY = data.cursor.y; // Capture bottom of table
                }


            });
            const footerStartY = finalY + 30;
            const pageWidth = doc.internal.pageSize.getWidth();

            doc.setFontSize(10);
            doc.text("Issued By: ___________________", 40, footerStartY);

            const centerText = "Checked By: ___________________";
            const centerX = pageWidth / 2 - (doc.getTextWidth(centerText) / 2);
            doc.text(centerText, centerX, footerStartY);

            const rightText = "Received By: ___________________";
            const rightX = pageWidth - doc.getTextWidth(rightText) - 40;
            doc.text(rightText, rightX, footerStartY);

            // Save the PDF
            doc.save(`${reportTypeText.replace(/\s+/g, '_')}.pdf`);
        });

        function GetServerDate() {
            $.ajax({
                type: "GET",
                url: "@Url.Action("GetServerDate")",
                async: false,
                success: function (result, status, error) {
                    console.log(result);
                    if (result != null) {
                       // $('#EntryDate').datepicker({ dateFormat: 'dd/mm/yy' }).datepicker("setDate", result);
                        //$('#InvoiceDate').datepicker({ dateFormat: 'dd/mm/yy' }).datepicker("setDate", result);

                        var firstDayOfMonth = getFirstDayOfMonth(result);
                        $('#FromDate').datepicker({ dateFormat: 'dd/mm/yy' }).datepicker("setDate", firstDayOfMonth);

                        $('#ToDate').datepicker({ dateFormat: 'dd/mm/yy' }).datepicker("setDate", result);

                    }
                }
            });
        }

        function getFirstDayOfMonth(dateString){
            const [day, month, year] = dateString.split('/');

            // Create a new Date object (months are 0-indexed, so subtract 1 from the month)
            const currentDate = new Date(year, month - 1, day);

            // Set the date to the 1st day of the month
            currentDate.setDate(1);

            // Format the result as dd/mm/YYYY
            const firstDayOfMonth = `${currentDate.getDate().toString().padStart(2, '0')}/${(currentDate.getMonth() + 1).toString().padStart(2, '0')}/${currentDate.getFullYear()}`;

            return firstDayOfMonth;
        }

        $('#sendToExcel').click(function () {
            let table = $("#ReportTable");
            console.log(table);
            TableToExcel.convert(table[0], {
                name: `ReportTable.xlsx`,
                sheet: {
                    name: 'ReportTable'
                }
            });
        });
        function formatDate1(date) {
            var day = ("0" + date.getDate()).slice(-2);
            var month = ("0" + (date.getMonth() + 1)).slice(-2);
            var year = date.getFullYear();
            var dateString = day + "/" + month + "/" + year;
            return dateString;
        }

        function GetMRNRegisterData() {
             
            var inputValue = $('#gateno').val();
             $.ajax({
                type: "POST",
                url: "@Url.Action("GetMRNRegisterData")",
                async: false,
                data: {
                    "MRNType": $('#MRNType').val(), "ReportType": $('#ReportType').val(), "FromDate": $('#FromDate').val(), "ToDate": $('#ToDate').val(), "gateno": inputValue, "MRNno": $('#MRNno').val() == '0' ? '' : $('#MRNno').val(), "docname": $('#docname').val() == '0' ? '' : $('#docname').val(), "PONo": $('#PONo').val() == '0' ? '' : $('#PONo').val(), "Schno": $('#SchNo').val() == '0' ? '' : $('#Schno').val(), "PartCode": $('#PartCode').val() == '0' ? '' : $('#PartCode').val(), "ItemName": $('#ItemName').val() == '0' ? '' : $('#ItemName').val(), "invoiceNo": $('#invoiceNo').val() == '0' ? '' : $('#invoiceNo').val(), "VendorName": $('#VendorName').val() == '0' ? '' : $('#VendorName').val()
                },
                success: function (result, status, error) {
                     $('#divStockMainRegister').empty();
                    $('#divStockMainRegister').html(result);
                    $('#totalRows').text($('#divStockMainRegister tr').length - 1);
                      countAllTotal();
                }
            });
        }
      
        
        function FillGateNo() {
            var FromDate = $('#FromDate').val();
            var FromParts = FromDate.split("/");
            var formattedFromDate = `${FromParts[2]}-${FromParts[1]}-${FromParts[0]}`;
            var ToDate = $('#ToDate').val();
            var ToParts = ToDate.split("/");
             var formattedToDate = `${ToParts[2]}-${ToParts[1]}-${ToParts[0]}`;
            $.ajax({
                type: "POST",
                url: "@Url.Action("FillGateNo")",
                dataType: "JSON",
                async: false,
                data: { "FromDate": formattedFromDate, "ToDate": formattedToDate },
                success: function (result, status, error) {
                    if (result != null) {
                        var obj = $.parseJSON(result);
                        if (obj.StatusCode == 200 && obj.StatusText == 'Success') {
                            $('#gateno').empty();
                            $('#gateno').append('<option value="0" selected>-Select-</option>');
                            $.each(obj.Result, function (index, val) {
                                $('#gateno').append('<option value="' + val.GateNo +
                                    '">' + val.GateNo + '</option>');
                            });
                        }
                    }
                }
            });
        }

        function FillMRNNo() {
            var FromDate = $('#FromDate').val();
            var FromParts = FromDate.split("/");
            var formattedFromDate = `${FromParts[2]}-${FromParts[1]}-${FromParts[0]}`;
            var ToDate = $('#ToDate').val();
            var ToParts = ToDate.split("/");
            var formattedToDate = `${ToParts[2]}-${ToParts[1]}-${ToParts[0]}`;
            $.ajax({
                type: "POST",
                url: "@Url.Action("FillMRNNo")",
                dataType: "JSON",
                async: false,
                data: { "FromDate": formattedFromDate, "ToDate": formattedToDate },
                success: function (result, status, error) {
                    if (result != null) {
                        var obj = $.parseJSON(result);
                        if (obj.StatusCode == 200 && obj.StatusText == 'Success') {
                            $('#MRNno').empty();
                            $('#MRNno').append('<option value="0" selected>-Select-</option>');
                            $.each(obj.Result, function (index, val) {
                                $('#MRNno').append('<option value="' + val.MRNNo + '">' + val.MRNNo + '</option>');
                            });
                        }
                    }
                }
            });
        }


        function FillDocument() {
            var FromDate = $('#FromDate').val();
            var FromParts = FromDate.split("/");
            var formattedFromDate = `${FromParts[2]}-${FromParts[1]}-${FromParts[0]}`;
            var ToDate = $('#ToDate').val();
            var ToParts = ToDate.split("/");
            var formattedToDate = `${ToParts[2]}-${ToParts[1]}-${ToParts[0]}`;
            $.ajax({
                type: "POST",
                url: "@Url.Action("FillDocument")",
                dataType: "JSON",
                async: false,
                data: { "FromDate": formattedFromDate, "ToDate": formattedToDate },
                success: function (result, status, error) {
                    if (result != null) {
                        var obj = $.parseJSON(result);
                        if (obj.StatusCode == 200 && obj.StatusText == 'Success') {
                            $('#docname').empty();
                            $('#docname').append('<option value="0" selected>-Select-</option>');
                            $.each(obj.Result, function (index, val) {
                                $('#docname').append('<option value="' + val.DocName +
                                    '">' + val.DocName + '</option>');
                            });
                        }
                    }
                }
            });
        }
        
        function FillVendor() {
            var FromDate = $('#FromDate').val();
            var FromParts = FromDate.split("/");
            var formattedFromDate = `${FromParts[2]}-${FromParts[1]}-${FromParts[0]}`;
            var ToDate = $('#ToDate').val();
            var ToParts = ToDate.split("/");
            var formattedToDate = `${ToParts[2]}-${ToParts[1]}-${ToParts[0]}`;
            $.ajax({
                type: "POST",
                url: "@Url.Action("FillVendor")",
                dataType: "JSON",
                async: false,
                data: { "FromDate": formattedFromDate, "ToDate": formattedToDate },
                success: function (result, status, error) {
                    if (result != null) {
                        var obj = $.parseJSON(result);
                        if (obj.StatusCode == 200 && obj.StatusText == 'Success') {
                            $('#VendorName').empty();
                            $('#VendorName').append('<option value="0" selected>-Select-</option>');
                            $.each(obj.Result, function (index, val) {
                                $('#VendorName').append('<option value="' + val.Account_Name +
                                    '">' + val.Account_Name + '</option>');
                            });
                        }
                    }
                }
            });
        }

        function FillInvoice() {
            var FromDate = $('#FromDate').val();
            var FromParts = FromDate.split("/");
            var formattedFromDate = `${FromParts[2]}-${FromParts[1]}-${FromParts[0]}`;
            var ToDate = $('#ToDate').val();
            var ToParts = ToDate.split("/");
            var formattedToDate = `${ToParts[2]}-${ToParts[1]}-${ToParts[0]}`;
            $.ajax({
                type: "POST",
                url: "@Url.Action("FillInvoice")",
                dataType: "JSON",
                async: false,
                data: { "FromDate": formattedFromDate, "ToDate": formattedToDate },
                success: function (result, status, error) {
                    if (result != null) {
                        var obj = $.parseJSON(result);
                        if (obj.StatusCode == 200 && obj.StatusText == 'Success') {
                            $('#invoiceNo').empty();
                            $('#invoiceNo').append('<option value="0" selected>-Select-</option>');
                            $.each(obj.Result, function (index, val) {
                                $('#invoiceNo').append('<option value="' + val.Invoiceno +
                                    '">' + val.Invoiceno + '</option>');
                            });
                        }
                    }
                }
            });
        }
      
        function FillPONO() {
            var FromDate = $('#FromDate').val();
            var FromParts = FromDate.split("/");
            var formattedFromDate = `${FromParts[2]}-${FromParts[1]}-${FromParts[0]}`;
            var ToDate = $('#ToDate').val();
            var ToParts = ToDate.split("/");
            var formattedToDate = `${ToParts[2]}-${ToParts[1]}-${ToParts[0]}`;
            $.ajax({
                type: "POST",
                url: "@Url.Action("FillPONO")",
                dataType: "JSON",
                async: false,
                data: { "FromDate": formattedFromDate, "ToDate": formattedToDate },
                success: function (result, status, error) {
                    if (result != null) {
                        var obj = $.parseJSON(result);
                        if (obj.StatusCode == 200 && obj.StatusText == 'Success') {
                            $('#PONo').empty();
                            $('#PONo').append('<option value="0" selected>-Select-</option>');
                            $.each(obj.Result, function (index, val) {
                                $('#PONo').append('<option value="' + val.PONo +
                                    '">' + val.PONo + '</option>');
                            });
                        }
                    }
                }
            });
        }

        function FillSchNo() {
            var FromDate = $('#FromDate').val();
            var FromParts = FromDate.split("/");
            var formattedFromDate = `${FromParts[2]}-${FromParts[1]}-${FromParts[0]}`;
            var ToDate = $('#ToDate').val();
            var ToParts = ToDate.split("/");
            var formattedToDate = `${ToParts[2]}-${ToParts[1]}-${ToParts[0]}`;
            $.ajax({
                type: "POST",
                url: "@Url.Action("FillSchNo")",
                dataType: "JSON",
                async: false,
                data: { "FromDate": formattedFromDate, "ToDate": formattedToDate },
                success: function (result, status, error) {
                    if (result != null) {
                        var obj = $.parseJSON(result);
                        if (obj.StatusCode == 200 && obj.StatusText == 'Success') {
                            $('#Schno').empty();
                            $('#Schno').append('<option value="0" selected>-Select-</option>');
                            $.each(obj.Result, function (index, val) {
                                $('#Schno').append('<option value="' + val.SchNo +
                                    '">' + val.SchNo + '</option>');
                            });
                        }
                    }
                }
            });
        }


        function FillItemNamePartcode() {
            var FromDate = $('#FromDate').val();
            var FromParts = FromDate.split("/");
            var formattedFromDate = `${FromParts[2]}-${FromParts[1]}-${FromParts[0]}`;
            var ToDate = $('#ToDate').val();
            var ToParts = ToDate.split("/");
            var formattedToDate = `${ToParts[2]}-${ToParts[1]}-${ToParts[0]}`;
            $.ajax({
                type: "POST",
                url: "@Url.Action("FillItemNamePartcode")",
                dataType: "JSON",
                async: false,
                data: { "FromDate": formattedFromDate, "ToDate": formattedToDate },
                success: function (result, status, error) {
                    if (result != null) {
                        var obj = $.parseJSON(result);
                        if (obj.StatusCode == 200 && obj.StatusText == 'Success') {
                            $('#ItemName').empty();
                            $('#PartCode').empty();
                            $('#PartCode').append('<option value="0" selected>-Select-</option>');
                            $('#ItemName').append('<option value="0" selected>-Select-</option>');
                            $.each(obj.Result, function (index, val) {
                                $('#ItemName').append('<option value="' + val.Item_Name +
                                    '">' + val.Item_Name + '</option>');
                                $('#PartCode').append('<option value="' + val.PartCode +
                                    '">' + val.PartCode + '</option>');
                            });
                        }
                    }
                }
            });
        }

        function countAllTotal() {

            var rowCount = $('#divStockMainRegister tr').length;
            var OpnStk = 0;
            var TotStk = 0;
            var IssQty = 0;
            var RecQty = 0;
            var rate = 0;
            var totAmount =0;
            var totShortExccessQty = 0;
            for (var i = 1; i <= rowCount; i++) {
                OpnStk += $('#opnStk-' + i).text() =='' ? 0 : parseFloat($('#opnStk-' + i).text());
               
                IssQty += $('#issQty-' + i).text() == '' ? 0 : parseFloat($('#issQty-' + i).text());
                RecQty += $('#recQty-' + i).text() == '' ? 0 : parseFloat($('#recQty-' + i).text());

                totShortExccessQty += $('#shortexcessQty-' + i).text() == '' ? 0 : parseFloat($('#shortexcessQty-' + i).text());
                //rate += $('#rate-' + i).text() == '' ? 0 : parseFloat($('#rate-' + i).text());
                totAmount += $('#amount-' + i).text() == '' ? 0 : parseFloat($('#amount-' + i).text());
                //if(totAmount < 0){
                //    $('#SAGridRow-' + i).css('background-color', 'red');
                //}
            }

            $('#totOpenStock').val(isNaN(OpnStk) ? 0 : OpnStk.toFixed(2));
            $('#totRecQty').val(isNaN(RecQty) ? 0 : RecQty.toFixed(2));
            $('#totshrotexcess').val(isNaN(totShortExccessQty) ? 0 : totShortExccessQty.toFixed(2));
            $('#totAmount').val(isNaN(totAmount) ? 0 : totAmount.toFixed(2));
        }

        $(document).on("click", ".sortCol", function () {
             ;
            var $column = $(this).parent().closest("th");
            var colno = $(this).data('columnno');
            var currentOrder = $(this).data('sortorder');

            $('.sortCol').css('color', 'white');
            if (currentOrder === 'asc') {
                sortTable(colno, false);
                $(this).data('sortorder', 'desc');
                $(this).css('color', 'yellow'); // Visual indication of descending order
                //$(this).css('font-size', 'larger'); // Visual indication of descending order
                $(this).find('i:first').removeClass('fa-arrow-up');
                $(this).find('i:first').addClass('fa-arrow-down');
            } else {
                sortTable(colno, true);
                $(this).data('sortorder', 'asc');
                $(this).css('color', 'yellow');
                // $(this).css('font-size', 'larger'); // Visual indication of ascending order
                $(this).find('i:first').removeClass('fa-arrow-down');
                $(this).find('i:first').addClass('fa-arrow-up');
            }
        });

        function sortTable(columnIndex, ascending) {
             
            var table = $('#ReportTable');
            var rows = table.find('#divStockRegisterBody > tr').toArray();

            rows.sort(function (a, b) {
                var aValue = $(a).find('td').eq(columnIndex).text();
                var bValue = $(b).find('td').eq(columnIndex).text();

                var aIntValue = 0;
                var bIntValue = 0;
                if (/^\d*\.?\d+$/.test(aValue) && /^\d*\.?\d+$/.test(bValue)) {
                    aIntValue = parseInt(aValue, 10);
                    bIntValue = parseInt(bValue, 10);
                }

                if (aIntValue > 0) {
                    if (ascending) {
                        return aValue - bValue;
                    } else {
                        return bValue - aValue;
                    }
                } else {
                    if (ascending) {
                        return aValue.localeCompare(bValue);
                    } else {
                        return bValue.localeCompare(aValue);
                    }
                }
            });

            $.each(rows, function (index, row) {
                table.children('#divStockRegisterBody').append(row);
            });
        }

        var currentSearchColumn = null;

        $("#search-box").on("keyup", function () {
            var value = $(this).val().toLowerCase();
            $("#divStockRegisterBody tr").filter(function () {
                if (currentSearchColumn !== null) {
                    var columnText = $(this).find('td').eq(currentSearchColumn).text().toLowerCase();
                    $(this).toggle(columnText.indexOf(value) > -1);
                } else {
                    $(this).toggle($(this).text().toLowerCase().indexOf(value) > -1);
                }
            });
        });

        $(document).on("click", "th[data-columnno]", function () {
            currentSearchColumn = $(this).data('columnno');
            $("#search-box").val('').trigger('keyup'); // Reset search box and trigger the search
        });

        function DeleteRow(i){
             
            var indexToRemove = i-1;
            $('#SAGridRow-'+i).remove();
            $('#ReportTable tbody tr').each(function (index) {
                $(this).attr('id', 'SAGridRow-' + (index+1));


                $(this).find('td:first-child a:first-child').each(function (tdIndex) {
                    $(this).attr('id', (index+1));
                });
       
                $(this).find('td[id^="amount-"]').each(function (tdIndex) {
                    $(this).attr('id', 'amount-' + (index+1));
                });
                
            });
            //$('#ReportTable tr:eq(' + indexToRemove + ')').remove();
            countAllTotal();
            $('#totalRows').text($('#divStockMainRegister tr').length - 1);
        }

        $('#FromDate').change(function (){
            /* GetMRNRegisterData(); */
            FillVendor();
            FillGateNo();
            FillDocument();
            FillInvoice();
            FillItemNamePartcode();
            FillPONO();
            FillSchNo();
        })
        $('#ToDate').change(function () {
            /* GetMRNRegisterData(); */
            FillVendor();
            FillGateNo();
            FillDocument();
            FillInvoice();
            FillItemNamePartcode();
            FillPONO();
            FillSchNo();
        })

    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>

    <script src="https://cdn.jsdelivr.net/gh/linways/table-to-excel@v1.0.4/dist/tableToExcel.js"></script>
}
<style>

    .sort-icon {
        padding: 5px;
        margin: 5px;
        vertical-align: top;
    }

    .ascCol {
        font-size: 15px;
        vertical-align: bottom;
    }

    .descCol {
        font-size: 15px;
        vertical-align: super;
    }

</style>