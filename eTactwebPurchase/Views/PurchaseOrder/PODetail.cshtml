@model eTactWeb.DOM.Models.PurchaseOrderModel

@{
	ViewData["Title"] = "Purchase Order Detail";
	Layout = "~/Views/Shared/_LayoutMain.cshtml";
	ViewData["PageName"] = "PurchaseOrder";
}

<div class="card bg-gradient mb-3 border-light shadow-lg">
	<partial name="_PODelivery" />
	<partial name="_POConfirmationBox" />
	<form asp-action="SavePODetail" asp-controller="PurchaseOrder" autocomplete="off" method="post" class="form-horizontal" enctype="multipart/form-data">
		<input type="hidden" asp-for="Mode" value="@Model.Mode" />
		<input type="hidden" asp-for="EID" />
		<div class="card-header card-headerBG text-light bg-gradient">

			<h5>
				<strong>@ViewData["Title"] - @Model.YearCode</strong>

				
				<span class="d-flex float-end" style="margin-top:-2px;">
					@if (Model.Mode != "V" && Model.Mode != "POC")
					{
						@* <a type="button" class="btn btn-sm btn-outline-light bg-gradient" asp-action="HtmlSave" asp-controller="PurchaseOrder" asp-route-EntryId="@Model.EntryID" asp-route-YearCode="@Model.YearCode" asp-route-PONO="@Model.PONo">
                    <i class="fa fa-pencil-square fa-fw fa-lg" aria-hidden="true"></i>
                    SAVE
                    </a> *@
						<div class="col-auto">
							<button type="button" class="ItemBelowReoder btn btn-secondary btn-sm mr-2" style="color:white!important;margin-right:5px;" onclick="AddMultipleItems();">
								<i class="fa-regular fa-pen-to-square" style="--fa-secondary-color: crimson; --fa-secondary-opacity: 1.0;"></i>
								Item Below Reoder Level
							</button>
						</div>

						<a type="button" class="btn btn-sm btn-outline-light bg-gradient" asp-action="GetImage" asp-controller="PurchaseOrder" asp-route-EntryId="@Model.EntryID" asp-route-YearCode="@Model.YearCode" asp-route-PONO="@Model.PONo">
							<i class="fa fa-pencil-square fa-fw fa-lg" aria-hidden="true"></i>
							EXPORT
						</a>
						

						<div class="col-auto">
							<button type="button" class="PartialSave btn btn-secondary btn-sm mr-2" style="color:white!important;margin-right:5px;">
								<i class="fa-regular fa-pen-to-square" style="--fa-secondary-color: crimson; --fa-secondary-opacity: 1.0;"></i>
								PARTIAL SAVE
							</button>
						</div>
					}
					@if ((Model.Mode == "U" || Model.Mode == "V") && Model.Mode != "POC")
					{
						<div class="col-auto">
							<a class="Copy btn btn-sm btn-outline-light bg-gradient" asp-action="PODetail" asp-route-Mode="C" asp-route-ID="@Model.EntryID" asp-route-YC="@Model.YearCode" style="color:white!important;margin-right:5px;">
								<i class="fa-regular fa-pen-to-square" style="--fa-secondary-color: white; --fa-secondary-opacity: 1.0;--fa-animation-duration: 2s;"></i>
								COPY
							</a>
						</div>
						<a type="button" class="btn btn-sm btn-outline-light bg-gradient" id="printButton" asp-action="PrintReport" target="_blank" asp-controller="PurchaseOrder" asp-route-EntryId="@Model.EntryID" asp-route-YearCode="@Model.YearCode" asp-route-PONO="@Model.PONo" asp-route-ShowOnlyAmendItem="@Model.ShowOnlyAmendItem">
							<i class="fa fa-pencil-square fa-fw fa-lg" aria-hidden="true"></i>
							PRINT
						</a>
					}
					@if (Model.Mode == "POC")
					{
						<a asp-action="POAmmCompleted" asp-route-ID="0" class="btn btn-sm btn-outline-light bg-gradient" style="margin-right:5px;">
							<i class="fa-solid fa-grip fa-lg fa-fw fa-beat" style="--fa-animation-duration: 2s;"></i>
							Dashboard
						</a>
					}
					else if (Model.Mode == "POA")
					{
						<a asp-action="POAmendmentList" asp-route-ID="0" class="btn btn-sm btn-outline-light bg-gradient" style="margin-right:5px;">
							<i class="fa-solid fa-grip fa-lg fa-fw fa-beat" style="--fa-animation-duration: 2s;"></i>
							Dashboard
						</a>
					}
					else
					{
						<a asp-action="Dashboard" asp-route-ID="0" class="btn btn-sm btn-outline-light bg-gradient saleorderDashBoard" style="margin-right:5px;">
							<i class="fa-solid fa-grip fa-lg fa-fw fa-beat" style="--fa-animation-duration: 2s;"></i>
							Dashboard
						</a>
						@* <a type="button" class="btn btn-sm btn-outline-light bg-gradient" asp-action="PrintReport" asp-controller="PurchaseOrder" asp-route-EntryId="@Model.EntryID" asp-route-YearCode="@Model.YearCode" asp-route-PONO="@Model.PONo" asp-route-ShowOnlyAmendItem="@Model.ShowOnlyAmendItem">
							<i class="fa fa-pencil-square fa-fw fa-lg" aria-hidden="true"></i>
							PRINT
						</a> *@
						
					}


					<partial name="_FormsButton" />
				</span>
			</h5>
		</div>
		<div class="card-body bg-light pt-0">
			@*<div asp-validation-summary="All" class="text-danger pt-1"></div>*@
			<div class="accordion shadow-lg">
				<div class="accordion-item">
					<h2 class="accordion-header" id="HPanel1">
						<button class="accordion-button text-light pnl4BG bg-gradient" type="button" data-bs-toggle="collapse" data-bs-target="#BPanel1" aria-expanded="true" aria-controls="BPanel1">
							<i class="fa-brands fa-wpforms fa-lg fa-fw pr35"></i>
							Required Parameter
							<small class="p-5"></small>
							<div style="margin-left:750px">show only Ammend Item</div>
							<input type="checkbox" id="ShowOnlyAmendItemcheck" />
							<input type="hidden" asp-for="ShowOnlyAmendItem" value="@Model.ShowOnlyAmendItem" />

						</button>
					</h2>
					<div id="BPanel1" class="accordion-collapse collapse show pnl4 bg-gradient" aria-labelledby="HPanel1">
						<partial name="_POMain" />
						<input type="hidden" asp-for="TypeOfSave" value="" />
						<input type="hidden" asp-for="EntryByMachineName" value="" />
					</div>
				</div>
				<div class="accordion-item">
					<div class="col-auto ShowAllRequiredFields">
						<button type="button" class="PendingIndentDetail btn btn-sm btn-outline-danger">
							<i class="fa-solid fa-angles-down fa-fw fa-lg"></i> Pending Indent
						</button>
					</div>
					<h2 class="accordion-header" id="HPanel2">
						<button class="accordion-button collapsed text-light pnl1BG bg-gradient" tabindex="-1" type="button" data-bs-toggle="collapse" data-bs-target="#BPanel2" aria-expanded="true" aria-controls="BPanel2">
							<div class="d-flex align-items-center">
								<i class="fa-solid fa-table-list fa-lg fa-fw fa-fade me-2"
								   style="--fa-animation-duration: 2s; --fa-fade-opacity: 0.6;"></i>
								<strong class="text-uppercase">Item Detail Grid</strong>
							</div>

							<div class="d-flex justify-content-center align-items-center flex-grow-1">
								<strong class="me-2">BASIC TOTAL:</strong>
								<span id="lblItemNetAmount" class="me-4 text-warning">0.00</span>
								<strong class="me-2">TOTAL QTY:</strong>
								<span id="lblTotalQty" class="me-4 text-warning">0.00</span>

								<strong class="me-2">TOTAL NO OF ITEMS:</strong>
								<span id="lblItemCount" class="text-warning">0</span>
							</div>
						</button>






						@* <div class="row g-2 gx-3">
							<div class="col-12 text-center">
								<strong>BASIC TOTAL : <i class="fa-solid fa-indian-rupee-sign fa-fw fa-1x"></i><span id="lblItemNetAmount"></span></strong>
								<strong>TOTAL QTY: <i class="fa-solid fa-indian-rupee-sign fa-fw fa-1x"></i><span id="lblTotalQty"></span></strong>
								<strong>, TOTAL NO OF ITEMS : <span id="lblItemCount"></span></strong>
							</div>
						</div> *@
					</h2>
					<div id="BPanel2" class="accordion-collapse collapse pnl1 bg-gradient" aria-labelledby="HPanel2">
						<div class="accordion-body">
							<partial name="_POItemDetail" />
							<div class="progress my-2 mb-3" style="height: 4px;">
								<div class="progress-bar progress-bar-striped bg-secondary progress-bar-animated" role="progressbar" style="width: 100%" aria-valuenow="100" aria-valuemin="0" aria-valuemax="100"></div>
							</div>
							<div class="card">
								<div class="d-flex justify-content-end mb-2">


									<div class="col-auto" style="display:none">
										<button type="button" class="EXPORT btn btn-sm btn-outline-success" id="sendToExcel">
											<i class="fa-solid fa-angles-down fa-fw fa-lg"></i> EXPORT
										</button>
									</div>
									<div class="col-auto  me-3">
										<input class="form-control" type="file" id="ExcelFile" />
									</div>
									<div class="col-auto  me-3">
										<button type="button" class="Importbtn btn btn-sm btn-outline-success" onclick="UploadExcel()">
											<i class="fa-solid fa-angles-down fa-fw fa-lg"></i> Import From Excel
										</button>
									</div>



									<div class="col-md-2 me-3">
										<input type="text" class="form-control" id="search-box" style="background-color:#FFFACD" placeholder="Search...">
									</div>
									<a class="btn btn-secondary btn-sm ImportExcel" onclick="ExportPOFormate();">
										<i class="fa-solid fa-floppy-disk-pen fa-fw fa-lg" style="--fa-secondary-color: crimson; --fa-secondary-opacity: 1.0;"></i>
										IMPORT FORMAT
									</a>
								</div>

								<div class="card-body overflow-auto pb-0">
									<div class="table-responsive" style="max-height:150px;">
										<table class="table table-hover table-bordered table-striped" id="poTable">
											<thead class="bg-gradient card-headerBG text-light small" id="poThead" style="white-space:nowrap">
												<tr id="headerRow">
													<th>Action</th>
													<th data-columnno="1" data-sortorder="asc" class="sortCol">
														<span class="sort-icon">
															<i class="fa" aria-hidden="true"></i>
														</span>Seq No
													</th>
													<th data-columnno="2" data-sortorder="asc" class="sortCol">
														<span class="sort-icon" style="color:  yellow;">
															<i class="fa" aria-hidden="true"></i>
														</span>Part Code
													</th>
													<th data-columnno="3" data-sortorder="asc" class="sortCol">
														<span class="sort-icon" style="color:  yellow;">
															<i class="fa" aria-hidden="true"></i>
														</span>Item Name
													</th>
													<th data-columnno="5" data-sortorder="asc" class="sortCol">
														<span class="sort-icon" style="color:  yellow;">
															<i class="fa" aria-hidden="true"></i>
														</span>PO Qty
													</th>
													<th data-columnno="13" data-sortorder="asc" class="sortCol">
														<span class="sort-icon" style="color:  yellow;">
															<i class="fa" aria-hidden="true"></i>
														</span>Rate
													</th>
													<th data-columnno="17" data-sortorder="asc" class="sortCol">
														<span class="sort-icon">
															<i class="fa" aria-hidden="true"></i>
														</span>Disc %
													</th>
													<th data-columnno="18" data-sortorder="asc" class="sortCol">
														<span class="sort-icon">
															<i class="fa" aria-hidden="true"></i>
														</span>Disc Rs.
													</th>
													<th data-columnno="19" data-sortorder="asc" class="sortCol">
														<span class="sort-icon">
															<i class="fa" aria-hidden="true"></i>
														</span>Amount
													</th>
													<th data-columnno="4" data-sortorder="asc" class="sortCol">
														<span class="sort-icon" style="color:  yellow;">
															<i class="fa" aria-hidden="true"></i>
														</span>HSN No
													</th>
													
													<th data-columnno="6" data-sortorder="asc" class="sortCol">
														<span class="sort-icon" style="color:  yellow;">
															<i class="fa" aria-hidden="true"></i>
														</span>Unit
													</th>
													<th data-columnno="6" data-sortorder="asc" class="sortCol">
														<span class="sort-icon" style="color:  yellow;">
															<i class="fa" aria-hidden="true"></i>
														</span>ItemLocation
													</th>
													<th data-columnno="6" data-sortorder="asc" class="sortCol">
														<span class="sort-icon" style="color:  yellow;">
															<i class="fa" aria-hidden="true"></i>
														</span>VehicleNo
													</th>
													<th data-columnno="6" data-sortorder="asc" class="sortCol">
														<span class="sort-icon" style="color:  yellow;">
															<i class="fa" aria-hidden="true"></i>
														</span>ItemGroupName
													</th>

													<th data-columnno="7" data-sortorder="asc" class="sortCol ShowAllItemDetailFields">
														<span class="sort-icon">
															<i class="fa" aria-hidden="true"></i>
														</span>Alt PO Qty
													</th>
													<th data-columnno="8" data-sortorder="asc" class="sortCol ShowAllItemDetailFields">
														<span class="sort-icon">
															<i class="fa" aria-hidden="true"></i>
														</span>Alt Unit
													</th>
													<th data-columnno="9" data-sortorder="asc" class="sortCol">
														<span class="sort-icon">
															<i class="fa" aria-hidden="true"></i>
														</span>Pend Qty
													</th>
													<th data-columnno="9" data-sortorder="asc" class="sortCol">
														<span class="sort-icon">
															<i class="fa" aria-hidden="true"></i>
														</span>Store Name
													</th>
													<th data-columnno="9" data-sortorder="asc" class="sortCol">
														<span class="sort-icon">
															<i class="fa" aria-hidden="true"></i>
														</span>Total Stock
													</th>
														<th data-columnno="9" data-sortorder="asc" class="sortCol">
														<span class="sort-icon">
															<i class="fa" aria-hidden="true"></i>
														</span>Work Center
													</th>
													<th data-columnno="9" data-sortorder="asc" class="sortCol">
														<span class="sort-icon">
															<i class="fa" aria-hidden="true"></i>
														</span>Work Stock
													</th>
													<th data-columnno="10" data-sortorder="asc" class="sortCol ShowAllItemDetailFields">
														<span class="sort-icon">
															<i class="fa" aria-hidden="true"></i>
														</span>Alt Pend Qty
													</th>
													<th data-columnno="11" data-sortorder="asc" class="sortCol ShowAllItemDetailFields">
														<span class="sort-icon">
															<i class="fa" aria-hidden="true"></i>
														</span>Pkg Std
													</th>
													<th data-columnno="12" data-sortorder="asc" class="sortCol ShowAllItemDetailFields">
														<span class="sort-icon">
															<i class="fa" aria-hidden="true"></i>
														</span>Process
													</th>
													
													<th data-columnno="14" data-sortorder="asc" class="sortCol ShowAllItemDetailFields">
														<span class="sort-icon">
															<i class="fa" aria-hidden="true"></i>
														</span>Old Rate
													</th>
													<th data-columnno="15" data-sortorder="asc" class="sortCol ShowAllItemDetailFields">
														<span class="sort-icon">
															<i class="fa" aria-hidden="true"></i>
														</span>Rate In Oth Curr.
													</th>
													<th data-columnno="16" data-sortorder="asc" class="sortCol ShowAllItemDetailFields">
														<span class="sort-icon">
															<i class="fa" aria-hidden="true"></i>
														</span>Rate/Unit
													</th>
													<th data-columnno="16" data-sortorder="asc" class="sortCol ShowAllItemDetailFields">
														<span class="sort-icon">
															<i class="fa" aria-hidden="true"></i>
														</span>DeliveryDate
													</th>
													
													<th data-columnno="20" data-sortorder="asc" class="sortCol ShowAllItemDetailFields">
														<span class="sort-icon">
															<i class="fa" aria-hidden="true"></i>
														</span>Tol Limit Qty
													</th>
													<th data-columnno="21" data-sortorder="asc" class="sortCol ShowAllItemDetailFields">
														<span class="sort-icon">
															<i class="fa" aria-hidden="true"></i>
														</span>Tol Limit %
													</th>
													<th data-columnno="22" data-sortorder="asc" class="sortCol ShowAllItemDetailFields">
														<span class="sort-icon">
															<i class="fa" aria-hidden="true"></i>
														</span>Size Detail
													</th>
													<th data-columnno="23" data-sortorder="asc" class="sortCol ShowAllItemDetailFields">
														<span class="sort-icon">
															<i class="fa" aria-hidden="true"></i>
														</span>Remark
													</th>
													<th data-columnno="24" data-sortorder="asc" class="sortCol ShowAllItemDetailFields">
														<span class="sort-icon">
															<i class="fa" aria-hidden="true"></i>
														</span>Description
													</th>
													<th data-columnno="25" data-sortorder="asc" class="sortCol ShowAllItemDetailFields">
														<span class="sort-icon">
															<i class="fa" aria-hidden="true"></i>
														</span>Additional Rate
													</th>
													<th data-columnno="26" data-sortorder="asc" class="sortCol ShowAllItemDetailFields">
														<span class="sort-icon">
															<i class="fa" aria-hidden="true"></i>
														</span>Color
													</th>
													<th data-columnno="27" data-sortorder="asc" class="sortCol ShowAllItemDetailFields">
														<span class="sort-icon">
															<i class="fa" aria-hidden="true"></i>
														</span>CostCenter
													</th>
													<th data-columnno="28" data-sortorder="asc" class="sortCol ShowAllItemDetailFields">
														<span class="sort-icon">
															<i class="fa" aria-hidden="true"></i>
														</span>First Month Tent Qty
													</th>
													<th data-columnno="29" data-sortorder="asc" class="sortCol ShowAllItemDetailFields">
														<span class="sort-icon">
															<i class="fa" aria-hidden="true"></i>
														</span>Sec Month Tent Qty
													</th>
													<th data-columnno="30" data-sortorder="asc" class="sortCol ShowAllItemDetailFields">
														<span class="sort-icon">
															<i class="fa" aria-hidden="true"></i>
														</span>Amendment No
													</th>
													<th data-columnno="31" data-sortorder="asc" class="sortCol ShowAllItemDetailFields">
														<span class="sort-icon">
															<i class="fa" aria-hidden="true"></i>
														</span>Amendment Date
													</th>
													<th data-columnno="32" data-sortorder="asc" class="sortCol ShowAllItemDetailFields">
														<span class="sort-icon">
															<i class="fa" aria-hidden="true"></i>
														</span>Amendment Reason
													</th>
												</tr>

											</thead>
											<tbody id="divPOItemList">
												<partial name="_POItemGrid" />
											</tbody>
										</table>
									</div>
								</div>
							</div>
							<div class="progress my-3 mb-3" style="height: 4px;">
								<div class="progress-bar progress-bar-striped bg-warning" role="progressbar" style="width: 100%" aria-valuenow="100" aria-valuemin="0" aria-valuemax="100"></div>
							</div>
							
						</div>
					</div>
				</div>
				<div class="accordion-item">
					<h2 class="accordion-header" id="H_TaxDetail">
						<button class="accordion-button collapsed text-light pnl4BG bg-gradient" type="button" data-bs-toggle="collapse" data-bs-target="#B_TaxDetail" aria-expanded="true" aria-controls="B_TaxDetail">
							<strong style="text-transform:uppercase"><i class="fa-solid fa-table-list fa-lg fa-fw pr35 fa-fade" style="--fa-animation-duration: 2s; --fa-fade-opacity: 0.6;"></i>Tax Detail</strong>
						</button>
					</h2>
					<div id="B_TaxDetail" class="accordion-collapse collapse pnl4 bg-gradient" aria-labelledby="H_TaxDetail">
						<div class="accordion-body">
							<partial name="_TaxDetail" />
							<div class="progress my-3" style="height: 4px;">
								<div class="progress-bar progress-bar-striped bg-danger" role="progressbar" style="width: 100%" aria-valuenow="100" aria-valuemin="0" aria-valuemax="100"></div>
							</div>
							<div class="row g-2 gx-3 justify-content-around">
								<div class="col-xl-2 col-lg-3 col-md-3 col-sm-6 col-xs-12">
									<label asp-for="TotalRoundOff" class="form-label">RoundOff</label>
									<select class="form-select" asp-for="TotalRoundOff" asp-items="Model.YesNoList">
										<option value="">-Select-</option>
									</select>
								</div>
								<div class="col-xl-2 col-lg-3 col-md-3 col-sm-6 col-xs-12 allowtobilldiscount" >
									<label asp-for="TotalDiscountPercentage" class="form-label">Discount %</label>
									<input asp-for="TotalDiscountPercentage" class="form-control" min="0" max="100" />
								</div> 
								<div class="col-xl-2 col-lg-3 col-md-3 col-sm-6 col-xs-12 allowtobilldiscount">
									<label asp-for="TotalAmtAftrDiscount" class="form-label">Amt Aftr Discount</label>
									<input asp-for="TotalAmtAftrDiscount" class="form-control" readonly />
								</div> 
								<div class="col-xl-2 col-lg-3 col-md-3 col-sm-6 col-xs-12">
									<label asp-for="NetTotal" class="form-label">Net Total</label>
									<input asp-for="NetTotal" class="form-control" readonly />
								</div>
								<div class="d-none">
									@*       @foreach (var item in Model.PendingIndentDetailGrid)
                                    {
                                    <input type="hidden" value="@item.ItemCode" id="hiddenIndentItemCode-@(item.ItemCode)-@(item.IndentEntryId)" />
                                    <input type="hidden" value="@item.IndentEntryId" id="hiddenIndentEntryId-@(item.ItemCode)-@(item.IndentEntryId)" />
                                    <input type="hidden" value="@item.IndentNo" id="hiddenIndentNo-@(item.ItemCode)-@(item.IndentEntryId)" />
                                    }
                                    *@
									@if (Model.PendingIndentDetailGrid != null)
									{
										<input type="hidden" value="@Model.PendingIndentDetailGrid.Count" id="hiddenPendingIndentDetailTotalCount" />
										@for (var i = 0; i < Model.PendingIndentDetailGrid.Count; i++)
										{
											<input type="hidden" value="@Model.PendingIndentDetailGrid[i].ItemCode" id="hiddenIndentItemCode-@(i + 1)" />
											<input type="hidden" value="@Model.PendingIndentDetailGrid[i].IndentEntryId" id="hiddenIndentEntryId-@(i + 1)" />
											<input type="hidden" value="@Model.PendingIndentDetailGrid[i].IndentNo" id="hiddenIndentNo-@(i + 1)" />
										}
									}
								</div>
							</div>
						</div>
					</div>
				</div>
				<div class="accordion-item">
					<h2 class="accordion-header" id="HPanel4">
						<button class="accordion-button collapsed text-light pnl1BG bg-gradient" type="button" data-bs-toggle="collapse" data-bs-target="#BPanel4" aria-expanded="true" aria-controls="BPanel4">
							<strong style="text-transform:uppercase"><i class="fa-solid fa-table-list fa-lg fa-fw pr35 fa-fade" style="--fa-animation-duration: 2s; --fa-fade-opacity: 0.6;"></i>Other Detail</strong>
							<small class="p-3"></small>
						</button>
					</h2>
					<div id="BPanel4" class="accordion-collapse collapse pnl1 bg-gradient" aria-labelledby="HPanel4">
						<partial name="_POtherDetail" />
					</div>
				</div>
			</div>
		</div>
		<div class="card-footer p-3">
			<div class="card-header card-headerBG text-light bg-gradient">
				<h5>
					<strong>@ViewData["Title"] - @Model.YearCode</strong>
					<span class="d-flex float-end" style="margin-top:-2px;">
						@if (Model.Mode != "V" && Model.Mode != "POC")
						{
							<div class="col-auto">
								<button type="button" class="PartialSave btn btn-secondary btn-sm mr-2" style="color:white!important;margin-right:5px;">
									<i class="fa-regular fa-pen-to-square" style="--fa-secondary-color: crimson; --fa-secondary-opacity: 1.0;"></i>
									PARTIAL SAVE
								</button>
							</div>
						}
						@if (Model.Mode == "U" || Model.Mode == "V")
						{
							<div class="col-auto">
								<a class="Copy btn btn-sm btn-outline-light bg-gradient" asp-action="PODetail" asp-route-Mode="C" asp-route-ID="@Model.EntryID" asp-route-YC="@Model.YearCode" style="color:white!important;margin-right:5px;">
									<i class="fa-regular fa-pen-to-square" style="--fa-secondary-color: white; --fa-secondary-opacity: 1.0;--fa-animation-duration: 2s;"></i>
									COPY
								</a>
							</div>
						}
						<a asp-action="Dashboard" asp-route-ID="0" class="btn btn-sm btn-outline-light bg-gradient saleorderDashBoard" style="margin-right:5px;">
							<i class="fa-solid fa-grip fa-lg fa-fw fa-beat" style="--fa-animation-duration: 2s;"></i>
							Dashboard
						</a>

						@* <partial name="_FormsButton" /> *@

						<div class="row justify-content-between g-2">
							<div class="col-auto">
								@*<a href="#" class="btn offer-listbtn hvr-sweep-to-right btn-sm btn-secondary" onclick="back();">*@
								<a href="#" class=" btn btn-primary btn-sm" onclick="BackButtonData();">
									<i class="fa fa-chevron-circle-left fa-fw fa-lg" aria-hidden="true"></i>
									BACk
								</a>
							</div>
							@if (Model.Mode != "V" && Model.Mode != "SOC" && Model.Mode != "POC")
							{
								<div class="col-auto">
									@*  <a class="btn btn-sm btn-outline-danger" onclick="location.href=$('form')[0].action">*@
									<a class="btn btn-secondary btn-sm" onclick="location.href=$('form')[0].action">
										@* <i class="fa-solid fa-grip fa-lg fa-fw fa-beat" style="--fa-animation-duration: 2s;"></i>*@
										<i class="fa fa-refresh fa-fw fa-lg" aria-hidden="true"></i>
										REFRESH
									</a>
								</div>
								@if (Model.Mode == "U" || Model.Mode == "SAU" || Model.Mode == "PAU" || Model.Mode == "PSU")
								{
									@*Model.Mode = "U";*@
									<div class="col-auto">
										@* <button type="submit" class="btn btn-sm btn-outline-warning">*@
										<button type="submit" class="btn btn-sm btn-outline-light bg-gradient" id="UpdateButton">
											<i class="fa fa-pencil-square fa-fw fa-lg" aria-hidden="true"></i>
											UPDATE
										</button>
									</div>
								}
								else if (Model.Mode == "SOA" || Model.Mode == "POA" || Model.Mode == "PSA" || Model.Mode == "SSA")
								{
									<div class="col-auto">
										<button type="submit" class="btn btn-sm btn-outline-light bg-gradient POAAmendButton">
											<i class="fa-solid fa-floppy-disk-pen fa-fw fa-lg" style="--fa-secondary-color: crimson; --fa-secondary-opacity: 1.0;"></i>
											AMEND
										</button>
									</div>
								}
								else
								{
									<div class="col-auto">
										@*   <button type="submit" class="btn btn-sm btn-outline-primary">*@
										<button type="submit" class="btn btn-primary btn-sm" id="submitBTN">
											<i class="fa-solid fa-chevron-circle-right"></i>
											SUBMIT
										</button>
									</div>
								}
							}
						</div>
					</span>
				</h5>
			</div>
		</div>
		@*<div class="accordion-item">
        <span class="d-flex float-end mb-2">
        <div class="col-auto me-2">
        <button type="button" class="PartialSave btn btn-secondary btn-sm mr-2" style="color:white!important">
        <i class="fa-solid fa-floppy-disk-pen fa-fw fa-lg" style="--fa-secondary-color: crimson; --fa-secondary-opacity: 1.0;"></i>
        PARTIAL SAVE
        </button>
        </div>
        <partial name="_FormsButton" model="Model" />
        </span>
        </div>
        </div>*@
		<partial name="_PendingIndentDetail" />
	</form>
</div>


<div class="modal fade" style="display:none" id="SaleOrderGroupWiseItem" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="staticBackdropLabel" aria-hidden="true">
	<div class="modal-dialog modal-xl">
		<div class="modal-content">
			<div class="modal-header">
				<h5 class="modal-title" id="staticBackdropLabel">Group Name</h5>
				<select class="form-select" asp-for="ItemGroupName" id="Group_Code1" style="width:170px">
					<option value="0">-Select-</option>
				</select>
				<select class="form-select" style="width:100px;" id="Storeid1">
					<option value="" disabled selected>-Select-</option>
				</select>
				<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
			</div>
			<div class="modal-body">
				<div class="card">
					<div class="card-body">
						<div class="row g-2 gx-3">

							<div class="card-body text-center overflow-auto pb-0 mt-0 pt-0  ">
								<div class="d-flex align-items-center mb-2">
									<button class="btn btn-sm btn-outline-warning mb-2" type="button" id="CheckAll" style="display: flex; align-items: center;">
										<i class="fa fa-check-square" aria-hidden="true"></i>
										<span style="margin-left: 5px;">Ch/UnCh All</span>
									</button>
									<div class="col-md-2 me-3" style="margin-left:100px">
										<input type="text" class="form-control" id="search-box1" placeholder="Search..." style="background-color:#FFFACD;">
									</div>
									<button class="btn btn-sm btn-outline-primary mb-5"type="button"id="Showdata"style="display:flex; align-items:center; margin-left:10px;">	Show
									</button>
								</div>
							
								<div class="table-responsive" style="max-height:350px;">
									<table class="table table-hover table-bordered table-striped mb-0 auto-adjust">
										<thead class="bg-gradient card-headerBG text-light small">
											<tr>
												<th>Sr#</th>
												<th>Action</th>
												<th>Part Code</th>
												<th>Item Name</th>
												<th>Sale Rate</th>
												<th>Purchase Rate</th>
												<th>Balance</th>
												<th>Min Level</th>
												<th>Max Level</th>
												<th>Qty</th>
												



											</tr>
										</thead>
										<tbody id="MultiItemBody">
											<partial name="_POItemBelowReorderlevel" />
										</tbody>
									</table>
								</div>
							</div>

						</div>
					</div>
					<div class="progress my-2" style="height: 4px;">
						<div class="progress-bar progress-bar-striped bg-danger" role="progressbar" style="width: 100%" aria-valuenow="100" aria-valuemin="0" aria-valuemax="100"></div>
					</div>
					<div class="row g-2 gx-3">
						<div class="col-12 text-center">
							<strong>Total No Of Items : <span id="lblTotalNoOfItems1"></span></strong>
						</div>
					</div>
				</div>
				<div class="modal-footer">
					<button type="button" class="GridMultiItemBtn btn btn-sm btn-outline-success me-2">
						<i class="fa-solid fa-angles-down fa-fw fa-lg"></i> ADD TO GRID
					</button>

					<button type="button" class="btn btn-sm btn-danger" data-bs-dismiss="modal">Close</button>
				</div>
			</div>
		</div>
	</div>
</div>






@section Scripts
{
	<script>
		var actualRate = 0;
		// 	 document.getElementById('ShowOnlyAmendItemcheck').addEventListener('change', function () {
		// 	document.getElementById('ShowOnlyAmendItem').value = this.checked ? 'Yes' : 'No';
		// 	console.log(this.checked ? 'Yes' : 'No');
		// });

		document.getElementById('ShowOnlyAmendItemcheck').addEventListener('change', function () {
			const value = this.checked ? 'Yes' : 'No';
			document.getElementById('ShowOnlyAmendItem').value = value;
			console.log(value);

			// update the print button URL dynamically
			const entryId = '@Model.EntryID';
			const yearCode = '@Model.YearCode';
			const poNo = '@Model.PONo';
			const AmmNo = '@Model.AmmNo';

			const printUrl = `/PurchaseOrder/PrintReport?EntryId=${entryId}&YearCode=${yearCode}&PONO=${poNo}&ShowOnlyAmendItem=${value}&AmmNo=${AmmNo}`;
			document.getElementById('printButton').href = printUrl;
		}); // <-- closing for the 'change' event listener

		window.addEventListener('load', function () {
			const isChecked = document.getElementById('ShowOnlyAmendItemcheck').checked;
			const value = isChecked ? 'Yes' : 'No';
			document.getElementById('ShowOnlyAmendItem').value = value;

			const entryId = '@Model.EntryID';
			const yearCode = '@Model.YearCode';
			const poNo = '@Model.PONo';

			const printUrl = `/PurchaseOrder/PrintReport?EntryId=${entryId}&YearCode=${yearCode}&PONO=${poNo}&ShowOnlyAmendItem=${value}`;
			document.getElementById('printButton').href = printUrl;
		}); // <-- closing for the 'load' event listener





		$(function () {
			$('#EntryByMachineName').val($('#machineName').text());
			$('.DH').fadeOut();
			if ('@Model.Mode' != 'U' && parseInt('@Model.ID') != 0 &&'@Model.Mode' != 'C') {
				GetTaxPartItem();
				// FillItems();
				$('#lblItemNetAmount').text($('#ItemNetAmount').val());
				$('#AccountCode').prop('disabled', true);
				if ($('#POType').val() == "OPEN") {
					$('#Qty,#AltQty').val('0').prop('disabled', true).attr('readonly', 'readonly');
				}
			}
			else {
				window.setInterval(function () {
					Dat = new Date();
					let am_pm = (Dat.getHours() >= 12) ? "PM" : "AM";
					var time = Dat.getHours() + ":" + Dat.getMinutes() + ":" + Dat.getSeconds() + " - " + am_pm;
					//console.log(time);
					$('#EntryTime').val(time);
				}, 1000);
			}

			AutoComplete('VPURCHASEPRDER', 'RefNo', 'RefNo', null);
			AutoComplete('VPURCHASEPRDER', 'FreightPaidBy', 'FreightPaidBy', null);
			AutoComplete('VPURCHASEPRDER', 'InsurancePaidBy', 'InsurancePaidBy', null);
			AutoComplete('VPURCHASEPRDER', 'ModeOFTransport', 'ModeOFTransport', null);
			AutoComplete('VPURCHASEPRDER', 'DeliverySch', 'DeliverySch', null);
			AutoComplete('VPURCHASEPRDER', 'PackingChg', 'PackingChg', null);
			AutoComplete('VPURCHASEPRDER', 'DeliveryTerms', 'DeliveryTerms', null);
			AutoComplete('VPURCHASEPRDER', 'PackingTYpe', 'PackingTYpe', null);
			AutoComplete('VPURCHASEPRDER', 'PaymentTerms', 'PaymentTerms', null);
			AutoComplete('VPURCHASEPRDER', 'PriceBasis', 'PriceBasis', null);
			AutoComplete('VPURCHASEPRDER', 'Installation', 'Installation', null);
			AutoComplete('VPURCHASEPRDER', 'Inspection', 'Inspection', null);
			AutoComplete('VPURCHASEPRDER', 'Warrenty', 'Warrenty', null);
			AutoComplete('VPURCHASEPRDER', 'Clause', 'Clause', null);
			AutoComplete('VPURCHASEPRDER', 'ShipmentTerm', 'ShipmentTerm', null);
			AutoComplete('VPURCHASEPRDER', 'LDClause', 'LDClause', null);

		});

		$(document).on('keyup', '.form-control', function (e) {
			var keyCode = e.keyCode || e.which;
			if (keyCode == 9) {
				if ($(this).parent("#BPanel1").length > 0) {
					if ($(this).is(":focus")) {
						var fControl = $(this).parent().next().find('.datePickerControl');
						if (fControl.length > 0 && fControl.is(":focus")) {
							$(this).parent().next().find('.datePickerControl').focus();
						}
						else {
							$(this).parent().next().find(":focusable").focus();
						}
					}
				}
			}
		});

		var itemDataArray = [];
		$('#btnAddIndentQty').click(function () {
			$('#POQty').val(0);
			itemDataArray = [];
			var indentRowCount = $('#divIndentDetail tr').length;
			var indentQty = 0;
					 var selectedItemCode = null;
			for (var i = 1; i <= indentRowCount; i++) {
				if ($('#chkIndentData-' + i).is(":checked") == true) {
							 var currentItemCode = $('#GridIndentItemCode-' + i).val();

					// validation: different items not allowed
					if (selectedItemCode == null) {
						selectedItemCode = currentItemCode; // set first item
					} else if (selectedItemCode !== currentItemCode) {
						$.notify("You can only select multiple indents for the same item!", "error");
						return; // stop execution
					}
					indentQty += $('#poQtyIndenGrid-' + i).text() == '' ? 0 : parseFloat($('#poQtyIndenGrid-' + i).text());

					var ItemData = {
						'IndentNo': $('#GridIndentNo-' + i).text(),
						'IndentDate': $('#GridIndentDate-' + i).text(),
						'IndentYearCode': $('#GridIndentYearCode-' + i).text(),

						'IndentEntryId': $('#GridIndentEntryId-' + i).text(),
						'PartCode': $('#GridIndentPartCode-' + i).text(),
						'PONO': $('#PONo').val(),
						'POEntryId': $('#EntryID').val(),
						'POYearCode': $('#YearCode').val(),
						'POAccountCode': $('#AccountCode').val(),
						'ItemName': $('#GridIndentItemName-' + i).text(),
						'Qty': $('#poQtyIndenGrid-' + i).text(),
						'AltQty': $('#poAltQtyIndenGrid-' + i).text(),
						'PendQtyForPO': $('#GridPendQtyForPO-' + i).text(),
						'Unit': $('#GridIndentUnit-' + i).text(),
						'AltUnit': $('#GridIndentAltUnit-' + i).text(),
						'ReqDate': $('#GridIndentReqDate-' + i).text(),
						'PODate': $('#PODate').val(),
						'ItemCode': $('#GridIndentItemCode-' + i).val(),
					};

					itemDataArray.push(ItemData);
				}
			}
			$('#IndentDetailModal').modal("hide");
			$('#POQty').val(indentQty);
			// $('#POQty').prop("readonly", true);

			console.log(JSON.stringify(itemDataArray));

			$.ajax({
				type: "POST",
				url: "@Url.Action("AddIndentDetail")",
				contentType: "application/json; charset=utf-8",
				async: false,
				data: JSON.stringify(itemDataArray),
				success: function (response) {
					if (response == "Duplicate Item") {
						$.notify("Duplicate Item..!", "error");
					}
					else if (response == "OK") {
								if (itemDataArray.length > 0) {
					var firstItem = itemDataArray[0];

					$("#PartCodeText").val(firstItem.PartCode).data("itemcode", firstItem.ItemCode);
					$("#ItemNameText").val(firstItem.ItemName);
					$('#ItemCode').val(firstItem.ItemCode);
							$('#Unit').val(firstItem.Unit);
							$('#PartCode').val(firstItem.ItemCode);
							GetItemPartCode("PartCode");
							
									$.ajax({
						type: "GET",
						url: "/PurchaseOrder/AltUnitConversion",
						dataType: "json",
						async: false,
						data: { ItemCode: $('#PartCode').val(), AltQty: 0, UnitQty: $('#POQty').val() },
						success: function (data, status, error) {
							if (data != null) {
								var obj = $.parseJSON(data);
								$('#AltPOQty').val(obj.Result[0].AltUnitValue);
							}
						},
						error: function (req, status, error) {
							alert(error);
						}
					});
				}

						
						$.notify("Indent detail saved successfully..!", "success");

						// 		if ($('#ItemCode').val() =='' && $('#PartCode').val() == 0) {
						// 	FillItems();
						// }
					}
				},
				error: function (xhr, status, error) {
					console.error("Error:", error);
				}
			});
		})

		var tabIndx = 0;
		$(":focusable").each(function () {
			$(this).attr("tabindex", ++tabIndx);
		});

		$(document).ready(function () {
			if ($('#OrderType').val() == 'Import') {
				$('#Rate').prop("disabled", true);
				$('#OtherRateCurr').prop("disabled", false);

			} else {
				$('#Rate').prop("disabled", false);
				$('#OtherRateCurr').prop("disabled", true);
			}
			const myInput = document.getElementById("TotalDiscountPercentage");

			myInput.addEventListener("input", function (event) {
				const inputValue = parseInt(event.target.value);
				if (isNaN(inputValue) || inputValue > 100) {
					event.target.value = ""; // Clear the input value if it's not a valid number or greater than 100
				}
			});
			// $('#AccountCode').select2();
			// $('#PartCode').select2();
			// $('#ItemCode').select2();
			FillStoreList1();
			FillWorkCenter();
		    FillVendors();
			GetFormRights();
			LockedFinancialYear();
			FillCurrency();
			GetFeaturesOptions();
			calculateTotalAmount();
			AutoFillPARTYNAMELIST();
			$('#POTypeServItem').val('Item');
			FillItems();
			
			//add by mayuri
						if ( $('#Mode').val() == "PAU") {
								var accountCode = @Html.Raw(Json.Serialize(Model.AccountCode));
								$('#AccountCode').val(accountCode).trigger('change.select2');
							}
			var finFromDate = $('#FinFromDate').val();
			var finToDate = $('#FinToDate').val();

			var dateParts1 = finFromDate.split("/");
			var monthNames = {
				"Jan": "01",
				"Feb": "02",
				"Mar": "03",
				"Apr": "04",
				"May": "05",
				"Jun": "06",
				"Jul": "07",
				"Aug": "08",
				"Sep": "09",
				"Oct": "10",
				"Nov": "11",
				"Dec": "12"
			};
			$('#Rate').rules("remove", "required");
			$('#HSNNo').rules("remove", "required");
			$('#POQty').rules("remove", "required");
			$('#AltPOQty').rules("remove", "required");

			var formattedDate1 = dateParts1[0] + "/" + monthNames[dateParts1[1]] + "/" + dateParts1[2];
			var dateParts2 = finToDate.split("/");

			var formattedDate2 = dateParts2[0] + "/" + monthNames[dateParts2[1]] + "/" + dateParts2[2];
			if ($('#Mode').val() == "POA" || $('#Mode').val() == "POC") {
				$('#PN1').prop("disabled", "false");
				$('#PN1').prop("checked", "true");
				$('#PN1').change().trigger("change");
				$('#IN1').prop("checked", "true");
				$('#IN1').trigger("change");
			}

			if ($('#Mode').val() == "U" || $('#Mode').val() == "V"||$('#Mode').val() == "C" ||$('#Mode').val() == "PAU" ) {
				// PendingIndentDetail(true);
				//FillItems();
				// alert("inside edit");
				// alert("entrydate1" + $('#EntryDate').val());
				$('.DH').fadeIn();
				$('#PN1').prop("disabled", "false");
				$('#PN1').prop("checked", "true");
				$('#PN1').change().trigger("change");
				$('#IN1').prop("checked", "true");
				$('#IN1').trigger("change");

				GetTaxPartItem();

				// var EntryDate = $('#EntryDate').val().split("-").join("/");
				// EntryDate = parseDateToFormat(EntryDate.split(" ")[0]);
				// $('#EntryDate').datepicker({ dateFormat: 'dd/mm/yy' }).datepicker("setDate", parseDateToFormat(EntryDate));

				// var PODt = $('#PODate').val().split("-").join("/");
				// PODt = parseDateToFormat(PODt.split(" ")[0]);
				// $('#PODate').datepicker({ dateFormat: 'dd/mm/yy' }).datepicker("setDate", parseDateToFormat(PODt));

				// var WEFDt = $('#WEF').val().split("-").join("/");
				// WEFDt = parseDateToFormat(WEFDt.split(" ")[0]);
				// $('#WEF').datepicker({ dateFormat: 'dd/mm/yy' }).datepicker("setDate", WEFDt);

				//  
				// var EntryDate = parseDateToFormat($('#EntryDate').val().split(" ")[0]);
				// var PODate = parseDateToFormat($('#PODate').val().split(" ")[0]);
				// var WEF = parseDateToFormat($('#WEF').val().split(" ")[0]);

				// console.log(EntryDate);
				// // console.log(InvoiceDt);

				// /* var EntryDate = parseDateToFormat($('#EntryDate').val().split(" ").join("/"));
				// var InvoiceDt = parseDateToFormat($('#InvoiceDate').val().split(" ").join("/")); */

				// $('#EntryDate').datepicker({ dateFormat: 'dd/mm/yy' }).datepicker("setDate", EntryDate);
				// $('#PODate').datepicker({ dateFormat: 'dd/mm/yy' }).datepicker("setDate", PODate);
				// $('#WEF').datepicker({ dateFormat: 'dd/mm/yy' }).datepicker("setDate", WEF);

				// var POCloseDt = $('#POCloseDate').val().split("-").join("/");
				// POCloseDt = parseDateToFormat(POCloseDt.split(" ")[0]);
				// $('#POCloseDate').datepicker({ dateFormat: 'dd/mm/yy' }).datepicker("setDate", POCloseDt);


				///////////Monika
				// Get end of financial year date (31st March of relevant year)
				// var today = new Date();
				// var fyEndYear = (today.getMonth() + 1) <= 3 ? today.getFullYear() : today.getFullYear() + 1;
				// var endOfFY = new Date(fyEndYear, 2, 31); // March = 2 (0-based)

				// // endOfFY = parseDateToFormat(endOfFY.split(" ")[0]);
				// // Format to dd/mm/yyyy
				//  var formattedDate = endOfFY.toLocaleDateString('en-GB');
				//   
				// var poCloseDate = parseDateToFormat($('#POCloseDate').val().split(" ")[0]);
				// // Set it in the datepicker
				// $('#POCloseDate').datepicker({ dateFormat: 'dd/mm/yy' }).datepicker("setDate", poCloseDate);
				// ///////////////////

				// var Ammdt = $('#AmmDate').val().split("-").join("/");
				// Ammdt = parseDateToFormat(Ammdt.split(" ")[0]);
				// $('#AmmDate').datepicker({ dateFormat: 'dd/mm/yy' }).datepicker("setDate", Ammdt);

				// var AmendmentDt = $('#AmendmentDate').val().split("-").join("/");
				// AmendmentDt = parseDateToFormat(AmendmentDt.split(" ")[0]);
				// $('#AmendmentDate').datepicker({ dateFormat: 'dd/mm/yy' }).datepicker("setDate", AmendmentDt);

				// Added recently 21/May/2025
				


				
				// $('#AmmDate').datepicker("option", "minDate", ($('#WEF').val()));
				// $('#AmmDate').datepicker("option", "maxDate", ($('#POCloseDate').val()));



				$('#POCloseDate ,#WEF,#PODate,#EntryDate, #AmmDate, #AmendmentDate,#DeliveryDate').on('focus mouseenter', function () {
					$(this).datepicker({
						dateFormat: 'dd/mm/yy',
						changeMonth: true,
						changeYear: true

					}).datepicker('show');
				});

				// $('#WEF,#POCloseDate').datepicker("option", "minDate", parseDateToFormat(finFromDate));
				// $('#WEF').datepicker("option", "maxDate", parseDateToFormat(finToDate));

				// $('#AmmDate').datepicker("option", "minDate", parseDateToFormat($('#WEF').val()));
				// $('#AmmDate').datepicker("option", "maxDate", parseDateToFormat($('#POCloseDate').val()));
						 var EntryDate = parseDateToFormat($('#EntryDate').val());
						 if($('#Mode').val()=="U"){
									 EntryDate = ($('#EntryDate').val());
						 }
					 /*    console.log("EntryDate" + EntryDate); */
						$('#EntryDate').datepicker({ dateFormat: 'dd/mm/yy' }).datepicker("setDate", EntryDate);
						// alert("entrydate2" + $('#EntryDate').val());
			}
			else if ($('#Mode').val() == "POA")
			{
				// alert("poa");
				$('#AmmDate').datepicker({ dateFormat: 'dd/mm/yy' }).datepicker("setDate", 'now');

				// $('#POCloseDate').datepicker({ dateFormat: 'dd/mm/yy' }).datepicker("setDate", parseDateToFormat($('#POCloseDate').val()));
				// $('#WEF').datepicker({ dateFormat: 'dd/mm/yy' }).datepicker("setDate", parseDateToFormat($('#WEF').val()));
				$('#WEF,#POCloseDate').datepicker("option", "minDate", parseDateToFormat(finFromDate));
				$('#WEF').datepicker("option", "maxDate", parseDateToFormat(finToDate));

				// $('#AmmDate').datepicker("option", "minDate", ($('#WEF').val()));
				// $('#AmmDate').datepicker("option", "maxDate", ($('#POCloseDate').val()));



				$('#POCloseDate ,#WEF,#PODate,#EntryDate,#DeliveryDate').on('focus mouseenter', function () {
					$(this).datepicker({
						dateFormat: 'dd/mm/yy',
						changeMonth: true,
						changeYear: true

					}).datepicker('show');
				});
			}
			else if ($('#Mode').val() != "POA") 
			{
				//alert("not poa");
				//$('#EntryDate').datepicker({ dateFormat: 'dd/mm/yy' }).datepicker("setDate", 'now');
				//$("#PODate,#POCloseDate,#AmmDate,#AmendmentDate").datepicker({
				//    dateFormat: 'dd/mm/yy',
				//    minDate: today,
				//});


				//$("#RefDate").datepicker({ dateFormat: 'dd/mm/yy', maxDate: today });
				//                $('#PODate').datepicker({ dateFormat: 'dd/mm/yy' }).datepicker("setDate", 'now');
				//                $('#WEF').datepicker({ dateFormat: 'dd/mm/yy' }).datepicker("setDate", 'now');

				//$('#PODate').datepicker("option", "maxDate", formattedDate2);
				//$('#PODate').datepicker("option", "minDate", formattedDate1);

					$('#EntryDate').datepicker({ dateFormat: 'dd/mm/yy' }).datepicker("setDate", 'now');
					$('#PODate').datepicker({ dateFormat: 'dd/mm/yy' }).datepicker("setDate", 'now');
					// $('#POCloseDate').datepicker({ dateFormat: 'dd/mm/yy' }).datepicker("setDate", 'now');
					$('#WEF').datepicker({ dateFormat: 'dd/mm/yy' }).datepicker("setDate", 'now');
					$('#RefDate').datepicker({ dateFormat: 'dd/mm/yy' }).datepicker("setDate", 'now');
					$('#AmmDate').datepicker({ dateFormat: 'dd/mm/yy' }).datepicker("setDate", 'now');
					$('#DeliveryDate').datepicker({ dateFormat: 'dd/mm/yy' }).datepicker("setDate", 'now');

					$('#EntryDate').datepicker("option", "minDate", parseDateToFormat(formattedDate1));
					$('#EntryDate').datepicker("option", "maxDate", parseDateToFormat(formattedDate2));

				///////////Monika
				// Get end of financial year date (31st March of relevant year)
				var today = new Date();
				var fyEndYear = (today.getMonth() + 1) <= 3 ? today.getFullYear() : today.getFullYear() + 1;
				var endOfFY = new Date(fyEndYear, 2, 31); // March = 2 (0-based)

				// endOfFY = parseDateToFormat(endOfFY.split(" ")[0]);
				// Format to dd/mm/yyyy
				 var formattedDate = endOfFY.toLocaleDateString('en-GB');

				// Set it in the datepicker
				$('#POCloseDate').datepicker({ dateFormat: 'dd/mm/yy' }).datepicker("setDate", formattedDate);
				///////////////////
					var today = new (Date);
					$("#PODate,#POCloseDate,#AmmDate,#AmendmentDate").datepicker({
						dateFormat: 'dd/mm/yy',
						minDate: today,
					});


					$("#RefDate").datepicker({ dateFormat: 'dd/mm/yy', maxDate: today });
					$('#PODate').datepicker("option", "maxDate", parseDateToFormat(formattedDate2));

					$('.AF').fadeOut();
					$('.Schedule').fadeOut();

					$('#WEF').on("change", function () {
						$('#AmmDate').val('').datepicker("option", { "minDate": $(this).val() });
					});

					var currentDate1 = new Date();

					// Calculate the date one year from now
					var oneYearFromNow = new Date();
					oneYearFromNow.setFullYear(currentDate1.getFullYear() + 1);

					// Format the date as dd/mm/yy
					var formattedDate11 = $.datepicker.formatDate('dd/mm/yy', oneYearFromNow);

					// Set the date in the datepicker
					// $('#POCloseDate').datepicker({
					//     dateFormat: 'dd/mm/yy'
					// }).datepicker("setDate", formattedDate11);

			}


			$('#POAAmendButton').click(function () {
				$('form').submit();
			});

			function checkedIndentDetail() {
				var modelIndentCount = parseInt($('#hiddenPendingIndentDetailTotalCount').val(), 10);
				var modelIndentData = [];

				for (var j = 1; j <= modelIndentCount; j++) {
					modelIndentData.push({
						"ItemCode": $('#hiddenIndentItemCode-' + j).val(),
						"IndentEntryId": $('#hiddenIndentEntryId-' + j).val()
					});
				}

				var indentRowCount = $('#divIndentDetail tr').length;
				for (var i = 1; i <= indentRowCount; i++) {
					var currentItemCode = $('#GridIndentItemCode-' + i).val();
					var currentIndentEntryId = $('#GridIndentEntryId-' + i).text();

					var isMatched = modelIndentData.some(function (data) {
						return data.ItemCode === currentItemCode && data.IndentEntryId === currentIndentEntryId;
					});

					if (isMatched) {
						$('#chkIndentData-' + i).prop("checked", true);
					}
				}
			}

			$('.PendingIndentDetail').click(function () {
				$('#IndentDetailModal').modal("show");
				PendingIndentDetail($('#showAllIndent').is(":checked"));
			})

			$('#showAllIndent').change(function () {
				PendingIndentDetail($('#showAllIndent').is(":checked"));
			})

			function PendingIndentDetail(showAllIndent) {
				var itemName = "";
				var partCode = "";
				var itemCode = 0;

				if (!showAllIndent) {
					// itemName = $('#ItemCode').find(':selected').text() == '-Select-' ? "" : $('#ItemCode').find(':selected').text().split("--->")[0];
					// partCode = $('#PartCode').find(':selected').text() == '-Select-' ? "" : $('#PartCode').find(':selected').text();
					// itemCode = $('#ItemCode').val();
							itemName = $('#ItemNameText').val() === '-Select-' ? "" : $('#ItemNameText').val();
							partCode = $('#PartCodeText').val() === '-Select-' ? "" : $('#PartCodeText').val();
							itemCode = $('#ItemCode').val(); // This holds the actual item code from autocomplete selection

				}

				if (partCode == "" || itemCode == null) {
					isItemSelected = true;
				} else {
					isItemSelected = false;
				}

				$.ajax({
					type: "POST",
					url: "@Url.Action("FillIndentDetail")",
					data: { "itemName": itemName, "partCode": partCode, "itemCode": itemCode },
					dataType: "json",
					async: false,
					success: function (result, status, error) {

						if (result != null) {
							var obj = $.parseJSON(result);
							var html = '';
							$('#divIndentDetail').empty();
							var i = 1;
							$.each(obj.Result.Table, function (index, val) {
								//html += '<tr><td><input id="Checkbox' + i + '"  type="checkbox"><input type="hidden" value="' + val.AccountCode + '" id="Accountcode' + i + '"/><input type="hidden" value="' + val.itemcode + '" id="Itemcode' + i + '"/></td><td><input id="AcName' + i + '" value=' + JSON.stringify(val.Account_Name) + ' readonly></td><td><input id="PartCode' + i + '" value=' + val.PartCode + ' readonly style="width:90px;"></td><td><input id="ItemName' + i + '" value=' + JSON.stringify(val.ItemName) + ' readonly></td><td><select id="Store' + i + '" onchange = "StoreChange(' + i + ')"></select></td><td><input id="Stock' + i + '" style="width:70px;" readonly></td> <td><input id="WOQty' + i + '" value=' + val.OrderQty + ' style="width:60px;background-color:#ffd6dd"><td><input id="OrderQty' + i + '" value=' + val.OrderQty + ' readonly style="width:60px;"></td><td><input id="OrderType' + i + '" value=' + val.OrderType + ' readonly style="width:90px;"></td><td><input id="wef' + i + '" value=' + val.wef.split("T")[0] + ' readonly style="width:90px;"></td><td><input type="hidden" id="SOType' + i + '" value=' + val.SOType + '><input id="AmmNo' + i + '" value=' + val.AmmNo + ' readonly style="width:40px;"></td><td><input id="AmmEffDate' + i + '" value=' + val.AmmEffDate.split("T")[0] + ' readonly style="width:90px;"></td><td><input id="unit' + i + '" value=' + val.unit + ' readonly style="width:40px;"></td><td><input id="AltQty' + i + '" value=' + val.AltQty + ' readonly style="width:30px;"></td><td><input id="AltUnit' + i + '" value=' + val.AltUnit + ' readonly style="width:50px;"></td><td><input id="Color' + i + '" readonly style="width:70px;" value= "' + val.Color + ' " ></td><td><input id="Description' + i + ' " readonly  value=' + val.Description + '></td><td><input id="CustOrderNo' + i + '" value=' + JSON.stringify(val.CustOrderNo) + ' readonly style="width:80px;"></td><td class="SONo' + i + '"><input id="SONo' + i + '" value=' + val.SONo + ' readonly style="width:40px;"></td><td><input id="SODate' + i + '" value=' + val.SODate.split("T")[0] + '  readonly style="width:90px;"></td><td class="SchNo' + i + '" ><input readonly  style="width:60px;" id="SchNO' + i + '" value=' + val.SchNO + ' ></td><td><input id="Schdate' + i + '" value=' + val.Schdate.split("T")[0] + ' readonly style="width:90px;"></td><td><input id="FGStoreName' + i + '" value=' + JSON.stringify(val.FGStoreName) + ' readonly style="width:90px;"></td><td><input id="FGStock' + i + '" value=' + val.FGStock + ' readonly style="width:90px;"></td><td><input id="ItemAmendmentNo' + i + '" value=' + val.ItemAmendmentNo + ' readonly style="width:100px;"></td><td><input id="SOCloseDate' + i + '" value=' + val.SOCloseDate.split("T")[0] + ' readonly style="width:90px;"></td><td><input id="SchEffTillDate' + i + '" value=' + val.ScheduleEffectiveTillDate.split("T")[0] + ' readonly style="width:90px;"></td>';
								html += '<tr id="IndentDetailRow-' + i + '">' +
									'<td>' + i + '</td>' +
									'<td><input type="checkbox" id="chkIndentData-' + i + '"/></td>' +
									'<td id="GridIndentNo-' + i + '"><input type="hidden" id="GridIndentItemCode-' + i + '" value="' + val.ItemCode + '"/> ' + val.IndentNo + '</td>' +
									'<td id="GridIndentDate-' + i + '">' + val.IndentDate + '</td>' +
									'<td id="GridIndentYearCode-' + i + '">' + val.IndentYearCode + '</td>' +
									'<td id="GridIndentEntryId-' + i + '">' + val.IndentEntryId + '</td>' +
									'<td id="GridIndentPartCode-' + i + '">' + val.Partcode + '</td>' +
									'<td id="GridIndentItemName-' + i + '">' + val.itemName + '</td>' +
									'<td id="poQtyIndenGrid-' + i + '">' + val.Qty + '</td>' +
									'<td id="poAltQtyIndenGrid-' + i + '">' + val.altQty + '</td>' +
									'<td id="GridPendQtyForPO-' + i + '">' + val.PendQtyForPO + '</td>' +
									'<td id="GridIndentUnit-' + i + '">' + val.unit + '</td>' +
									'<td id="GridIndentAltUnit-' + i + '">' + val.AltUnit + '</td>' +
									// '<td id="SubBom-' + i + '">' + val.SUBBOM + '</td>' +
									'<td id=GridIndentReqDate-' + i + '"">' + val.ReqDate + '</td>' +
									'</tr>';
								i++;
							});

							$('#divIndentDetail').append(html);

							checkedIndentDetail();
						}
					}
				});
			}



			$('#EntryDate').datepicker("option", "minDate", parseDateToFormat(formattedDate1));
			$('#EntryDate').datepicker("option", "maxDate", parseDateToFormat(formattedDate2));
			var today = new (Date);


			$('.AF').fadeOut();
			$('.Schedule').fadeOut();

			$('#WEF').on("change", function () {
				$('#AmmDate').val('').datepicker("option", { "minDate": $(this).val() });
			});

			$('.hasDatepicker').datepicker("option", "showAnim", "clip");
			$('.hasDatepicker').on('keydown', function (e) { return false });
			//'@Model.isPONo' === 'False' ? $('#PONo').prop('disabled', true) : $('#PONo').prop('disabled', false);
			$('#divPOItemList tr td:first-child').text() == 'NO DATA ADDED' ? $('.Schedule').fadeOut() : $('.Schedule').fadeIn();

			if ($('#Mode').val() == "POA") {
				if ($('#POType').val() == 'Open') {
					$('#POQty').prop("disabled", true);
				}
				if ($('#OrderType').val() == 'Import') {
					$('#Rate').prop("disabled", true);
					$('#OtherRateCurr').prop("disabled", false);

				}
				NewAmmEntryId();
				var hiddenCurrency = $('#hiddenCurrency').val();
				$('#Currency').val(hiddenCurrency);
			} else {
				//donothing
			}
			if ($('#Mode').val() != "U" && $('#Mode').val() != 'POA' && $('#Mode').val() != 'PAU') {
				if ($('#Mode').val() == "V") {
					var rowCount = $('#divPOItemList tr').length;
					var columnCount = $('#divPOItemList tr td').length;

					if (columnCount > 1)
						$('#lblItemCount').text(rowCount);
					else
						$('#lblItemCount').text(0);
					var hiddenCurrency = $('#hiddenCurrency').val();
					$('#Currency').val(hiddenCurrency);
				}
				else if ($('#Mode').val() == "C") {
					fillEntryandPONO();
					var hiddenCurrency = $('#hiddenCurrency').val();
					$('#Currency').val(hiddenCurrency);
					var rowCount = $('#divPOItemList tr').length;
					var columnCount = $('#divPOItemList tr td').length;

					if (columnCount > 1)
						$('#lblItemCount').text(rowCount);
					else
						$('#lblItemCount').text(0);
				}
				else if ($('#Mode').val() == "POC") {
					//do nothing
				}
				else {
					fillEntryandPONO();
					btnClearTax();
					$('#lblItemNetAmount').text(0.00);
					$('#lblItemCount').text(0);
				}
			} else {
				var hiddenCurrency = $('#hiddenCurrency').val();
				$('#Currency').val(hiddenCurrency);
				var rowCount = $('#divPOItemList tr').length;
				var columnCount = $('#divPOItemList tr td').length;

				if (columnCount > 1)
					$('#lblItemCount').text(rowCount);
				else
					$('#lblItemCount').text(0);

			}
			const currentYear = $('#YearCode').val();

			// $("#WEF").datepicker({
			// 	minDate: new Date(currentYear, 4 - 1, 1)
			// });
			$('#POFor').trigger("change");
			FillItems();
		});///ready even end here
		$('#Showdata').click(function () {
			$('#MultiItemBody').empty();
			ItemBelowReOrderLevel();

		});

		function FillStoreList() {
			$.ajax({
				type: "POST",
				url: "@Url.Action("GetStoreList","NRGP")",
				dataType: "json",
				success: function (result, status, error) {

					if (result != null) {
						var obj = $.parseJSON(result);
						$('#Storeid').empty();
						$('#Storeid').append('<option value="0">-Select-</option>');

						$.each(obj.Result, function (key, val) {
							$('#Storeid').append('<option value="' + val.entryid + '" data-type="' + val.Store_Type + '">' + val.store_name + '</option>');
						});
					}

					// check AllowToChangeStore
					if ($('#AllowToChangeStore').val() == "N") {
						// find store where store_type is "Main Store"
						var mainStore = $("#Storeid option[data-type='MAIN STORE']").val();

						if (mainStore) {
							$("#Storeid").val(mainStore);   // set selected
							$("#Storeid").prop("disabled", true); // make dropdown readonly
						}
					}
				}
			});
		}

		function GetMultiItemGroup() {

			$.ajax({
				type: "POST",
				url: "@Url.Action("GetItemGroup","SaleOrder")",
				dataType: "json",
				async: false,

				success: function (result, status, error) {

					if (result != null) {
						var obj = $.parseJSON(result);
						if (obj.StatusCode == 200 && obj.StatusText == 'Success') {
							$('#Group_Code1').empty();
							$('#Group_Code1').append('<option value=""  selected></option>');


							$.each(obj.Result, function (index, val) {
								$('#Group_Code1').append('<option value="' + val.Group_Code + '">' + val.Group_name + '</option>');
							});

						}
					}
				}
			});
		}

		$("#search-box1").on("keyup", function () {

			var value = $(this).val().toLowerCase();
			$("#MultiItemBody tr").filter(function () {
				if (currentSearchColumn !== null) {
					// var columnText = $(this).find('input').eq(currentSearchColumn).text().toLowerCase();
					var columnValue = $(this)
						.find('td')
						.eq(currentSearchColumn)
						.find('input')
						.val()
						.toLowerCase();
					$(this).toggle(columnText.indexOf(value) > -1);
				} else {
					// $(this).toggle($(this).text().toLowerCase().indexOf(value) > -1);
					var rowText = $(this)
						.find('input')
						.map(function () {
							return $(this).val();
						})
						.get()
						.join(" ")
						.toLowerCase();

					$(this).toggle(rowText.indexOf(value) > -1);
				}
			});
		});
		$('#CheckAll').click(function () {

			var RowCount = $('#MultiItemBody tr').length;
			var TotalNoOfRows = 0;
			for (var i = 0; i <= RowCount; i++) {
				var checkbox = $('#MBCheckbox-' + i);
				checkbox.prop("checked", !checkbox.prop("checked"));

				if ($('#MBCheckbox-' + i).prop("checked")) {
					TotalNoOfRows++;
				}
			}
			$('#lblTotalNoOfItems').text(TotalNoOfRows);
		});

		//$('#PODate').change(function () {
		//    if (!$('#AccountCode').is(':focus')) {
		//        $('#AccountCode').select2('open').select2('focus');
		//    }
		//});
				function AddMultipleItems()
				{
					$('#SaleOrderGroupWiseItem').modal('show');
					GetMultiItemGroup();
					FillStoreList();
					$('#MultiItemBody').empty();
							ItemBelowReOrderLevel();
				}
		function adjustColumnWidths() {
			const table = document.querySelector(".auto-adjust");
			if (!table) return;

			const headerCells = table.querySelectorAll("thead th");
			const rows = table.querySelectorAll("tbody tr");

			headerCells.forEach((th, columnIndex) => {
				let maxWidth = th.offsetWidth;

				rows.forEach(row => {
					const cell = row.children[columnIndex];
					if (cell) {
						let width = cell.scrollWidth + 25; // extra px for padding
						if (width > maxWidth) maxWidth = width;
					}
				});

				th.style.width = maxWidth + "px";
				rows.forEach(row => {
					const cell = row.children[columnIndex];
					if (cell) cell.style.width = maxWidth + "px";
				});
			});
		}

		// Run after your partial view loads
		

								function ItemBelowReOrderLevel() {

					//var reportType = $('#ReportType').val();
			var FromDate = $('#FinFromDate').val();
			var ToDate = $('#FinToDate').val();
			var GroupName = $('#Group_Code1 option:selected').text().trim();
							var CatName = $('#CatName').val();
							var Storeid = $('#Storeid').val();

					$.ajax({
						type: 'POST',
								url: "@Url.Action("ItemBelowReOrderLevel", "PurchaseOrder")",
						data: {
									FromDate: FromDate,
									ToDate: ToDate,
									GroupName:GroupName,
									CatName:CatName,
											Storeid:Storeid

						},
						success: function (response) {
							// Clear the existing items in the table body
							$('#MultiItemBody').empty(); // Clear existing items
							$('#MultiItemBody').html(response);
					
							var totalRows = $('#MultiItemBody tr').length;
							$('#lblTotalNoOfItems1').text(totalRows);


						},
						error: function (xhr, status, error) {
							console.error("Error fetching BOM tree data:", error);
						}
					});
					
				}


		function BackButtonData() {
			window.history.back();
		}

		$('#sendToExcel').click(function () {
			let table = $("#poTable");
			console.log(table);

			TableToExcel.convert(table[0], {
				name: `PurchaseOrderTableAmm.xlsx`,
				sheet: {
					name: 'PurchaseOrderTableAmm'
				}
			});
		});

		function ExportPOFormate() {

			$('#divPOItemList').empty();
			var wb = XLSX.utils.book_new();

			if($('#Mode').val()=='POA')
			{
				var ws = XLSX.utils.json_to_sheet([], { header: ["Part Code", "HSNNO", "Rate", "Qty", "Unit", "Dis%", "DisAmt", "description","AmendmentReason"] });
			}
			else
			{

			var ws = XLSX.utils.json_to_sheet([], { header: ["Part Code", "HSNNO", "Rate", "Qty", "Unit", "Dis%", "DisAmt", "description"] });
			}
			//ws['!ref'] = 'A1:I1';

			XLSX.utils.book_append_sheet(wb, ws, "Sheet 1");

			XLSX.writeFile(wb, "ImportPurchaseOrderFormat.xlsx");
		}

		function UploadExcel() {
			var fileInput = $('#ExcelFile');
			var file = fileInput.prop("files")[0];

			var formData = new FormData();
formData.append("EntryId", $('#EntryID').val());
formData.append("Mode", $('#Mode').val());
			formData.append("AmmNo", $('#AmmNo').val());
			formData.append("PoNo", $('#PONo').val());
			formData.append("POYearcode", $('#YearCode').val());
			formData.append("AccountCode", $('#AccountCode').val());
			formData.append("SchNo", "");
			formData.append("SchYearCode", 0);
			formData.append("Flag", "PURCHASEORDER");
			formData.append("Currency", $('#Currency').find(":selected").text());
			formData.append("excelFile", fileInput.prop("files")[0]);

			formData.append("POType", $("#POType").val());


			var Err = 0;

			if ($('#ExcelFile').val() == '') {
				AddErrorCls('ExcelFile');
				Err = 1;
				return;
			}
			else {
				RemoveErrorCls('ExcelFile');
			}

			$.ajax({
				url: "@Url.Action("UploadExcel")",
				type: "POST",
				data: formData,
				processData: false,
				contentType: false,
				async: false,
				success: function (result) {
					if (result == "Not Done") {
						$.notify("Pend Qty cannot be less than 0!Please Try again!", "error");
					}
					else if (result == "Duplicate") {
						$.notify("Duplicate Item Not allowed", "error");
					}
					else if (result == "Partcode not available") {
						$.notify("Imported Partcode is not available, Please check!!!", "error");
					}
					else if (result == "Qty is less Then 0") {
						$.notify("Qty Should be Greater Then 0 , Please check!!!", "error");
					}
					else {
						$('#divPOItemList').empty();
						$('#divPOItemList').html(result);
						GetFeaturesOptions();
						calculateTotalAmount();
						GetTaxPartItem();
					}
				},
				error: function (xhr) {
					if (xhr.status === 400) {
						$.notify(xhr.responseText, "error"); // Show error message if part code is invalid
					} else {
						$.notify("An unexpected error occurred. Please try again.", "error");
					}
				}

			});

			
		}


		function calculateTotalAmount() {
			var totalAmount = 0;
			var totalQty = 0;


			let rowsExist = $(".GridAmount").length > 0;
			let rowsQtyExist = $(".GridQty").length > 0;

			if (rowsExist) {
				$(".GridAmount").each(function () {
					let value = parseFloat($(this).text());
					totalAmount += isNaN(value) ? 0 : value;
				});
			} else {
				totalAmount = 0;
			}
			if (rowsQtyExist) {
				$(".GridQty").each(function () {
					let value = parseFloat($(this).text());
					totalQty += isNaN(value) ? 0 : value;
				});
			} else {
				totalQty = 0;
			}

			// Update total amount label
			$('#lblItemNetAmount').text(totalAmount.toFixed(2));
			$('#lblTotalQty').text(totalQty.toFixed(2));
		}
		function GetPendQty() {
			$.ajax({
				type: "POST",
				url: "@Url.Action("GetPendQty")",
				dataType: "json",
				async: false,
				data: { "PoNo": $('#PONo').val(), "POYearcode": $('#YearCode').val(), "AccountCode": $("#AccountCode").val(), "SchNo": "", "SchYerCode": 0 },
				success: function (result, status, error) {

					//if (result != null) {
					//    var obj = $.parseJSON(result);
					//    $('#AmmEntryId').val("");
					//    $('#AmmEntryId').val(obj.Result[0].AmmEntryId);
					//}
				}
			});
		}


		function NewAmmEntryId() {

			$.ajax({
				type: "POST",
				url: "@Url.Action("NewAmmEntryId")",
				dataType: "json",
				async: false,
				data: { "PoAmendYearCode": $('#YearCode').val() },
				success: function (result, status, error) {

					if (result != null) {
						var obj = $.parseJSON(result);
						$('#AmmEntryId').val("");
						$('#AmmEntryId').val(obj.Result[0].AmmEntryId);
					}
				}
			});
		}
				  function GetFeaturesOptions() {
					$.ajax({
						type: "POST",
						data: {},
								url: "@Url.Action("GetFeaturesOptions")",
						dataType: "json",
						success: function (result, status, error) {
							if (result != null) {
								var obj = $.parseJSON(result);
								if (obj.Result != null && obj.Result.length > 0) {
									var feature = obj.Result[0];

									// New DirectPurchaseBill flags
											if (feature.allowtobilldiscount === "Y") {
										$('.allowtobilldiscount').show();
									} else {
												$('.allowtobilldiscount').hide();
									}

							if (feature.ShowAllRequiredFields === "N") {
								$('.ShowAllRequiredFields').hide();
							} else {
								$('.ShowAllRequiredFields').show();
							}
							if (feature.ShowAllItemDetailFields === "N") {
								$('.ShowAllItemDetailFields').hide();
							} else {
								$('.ShowAllItemDetailFields').show();
							}

								}
							}
						}
					});
				}

				
		function FillVendors() {

			$.ajax({
				type: "POST",
				url: "@Url.Action("FillVendors")",
				dataType: "json",
				async: false,
				success: function (result, status, error) {

					if (result != null) {
						var obj = $.parseJSON(result);
						// $('#AccountCode').empty();
						// $('#AccountCode').append('<option value="0">-Select-</option>');
						$('#ShipTo').empty();
						$('#ShipTo').append('<option value="0">-Select-</option>');
						$.each(obj.Result, function (key, val) {
							// $('#AccountCode').append('<option value="' + val.AccountCode + '" data-gstregister="' + val.GSTRegistered + '" data-state="' + val.State + '">' + val.AccountName + '</option>');
							$('#ShipTo').append('<option value="' + val.AccountCode + '">' + val.AccountName + '</option>');
						});

						if ($('#Mode').val() == "U" || $('#Mode').val() == "V" || $('#Mode').val() == "POA"||$('#Mode').val() == "PAU" ) {
							var shipTo = @Html.Raw(Json.Serialize(Model.ShipTo));
							$('#ShipTo').val(shipTo).trigger('change.select2');
						}
					}
				}
			});
		}


		function AutoFillPARTYNAMELIST() {
			// Source for PartCodeText
			const AccountCodeSourse = function (request, response) {
				$.ajax({
					url: '@Url.Action("AutoFillPARTYNAMELIST","SaleOrder")',
					type: 'POST',
					data: {

						SearchAccount: request.term
					},
					success: function (result) {
						let obj = typeof result === "string" ? JSON.parse(result) : result;

						if (obj.StatusCode === 200 && obj.StatusText === 'Success' && Array.isArray(obj.Result.Table)) {
							let filtered = obj.Result.Table.filter(function (item) {
								let term = request.term.toLowerCase();
								return item.Account_Name.toLowerCase().includes(term);
							});

							response($.map(filtered, function (item) {
								return {
									label: item.Account_Name,
									value: item.Account_Name,
									accountCode: item.Account_Code,

								};
							}));
						} else {
							response([]);
						}
					}
				});
			};



			// Autocomplete for PartCodeText
			$("#AccountCodeText").autocomplete({
				source: AccountCodeSourse,
				select: function (event, ui) {
					$("#AccountCodeText").val(ui.item.value).data("Account_Code", ui.item.accountCode);

					$('#AccountCode').val(ui.item.accountCode);
					AccountcodeChange();
					btnClearTax();
					GetTaxPartItem();


					return false;
				},
				focus: function (event, ui) {
					$("#AccountCodeText").val(ui.item.value);

					return false;
				},
				minLength: 2
			});


		}



		$('#DDays').change(function () {

			var newDate = addDays(new Date($('#DDate').val()), parseInt($(this).val()) + 1);
			var newDDate = formatDATEDate(newDate);
			$('#DDate').datepicker({ dateFormat: 'dd/mm/yy' }).datepicker("setDate", newDDate);
			$('#DDate').datepicker("option", "minDate", 'now');
		});

		$('#DDate').change(function () {
			var tDate = parseDDate($(this).val());
			var today = new Date();
			var timeDifference = tDate.getTime() - today.getTime();
			var daysDifference = Math.ceil(timeDifference / (1000 * 3600 * 24));
			$('#DDays').val(daysDifference);
		});

		function parseDDate(dateString) {
			var parts = dateString.split('/');
			var day = parseInt(parts[0]);
			var month = parseInt(parts[1]) - 1;
			var year = parseInt(parts[2]);
			return new Date(year, month, day);
		}
		function formatDATEDate(inputDate) {
			var parts = inputDate.split('-');
			var year = parts[0];
			var month = parts[1];
			var day = parts[2];
			return day + '/' + month + '/' + year;
		}

		function fillEntryandPONO() {
			//ENTRYID
			$.ajax({
				type: "GET",
				url: "@Url.Action("FillEntryandPONumber")",
				dataType: "json",
				async: false,
				data: { "YearCode": $('#YearCode').val() },
				success: function (result, status, error) {
					if (result != null) {
						var obj = $.parseJSON(result);
						$('#EntryID').val(obj.Result.Table[0].EntryID);
					}
				}
			});
			//PONO
			$.ajax({
				type: "GET",
				url: "@Url.Action("FillPONumber")",
				dataType: "json",
				async: false,
				data: { "YearCode": $('#YearCode').val(), "OrderType": $('#OrderType').val(), "PoDate": $('#PODate').val() },
				success: function (result, status, error) {
					if (result != null) {
						var obj = $.parseJSON(result);
						$('#PONo').val(obj.Result.Table[0].PONO);
					}
				}
			});
		}

		$('#ItemsForDepartment').change(function () {
			if ($(this).prop('selectedIndex') != 0) {
				$('.DH').fadeIn();
			}
		});

		function LockedFinancialYear() {
			$.ajax({
				type: "GET",
				url: "@Url.Action("CheckLockYear")",
				dataType: "json",
				async: false,
				data: { "YearCode": $('#YearCode').val() },
				success: function (result, status, error) {
					if (result != null) {

						var obj = $.parseJSON(result);
						if (obj.Result.Table[0] != undefined && obj.Result != null) {
							if (obj.Result.Table[0].ClosedForAllusers == 'Y') {
								$('#submitBTN').prop("disabled", true);
								$('.card-footer #submitBTN').prop("disabled", true);
								$('.PartialSave').prop("disabled", true);
							}
						}
					}
				}
			});
		}

		$('#POTypeServItem').change(function () {
			if ($(this).val() == 'Asset' || $(this).val() == 'Service') {
				$('#IN1').prop("checked", false);
				$('#IN1').hide();
				$('#IN12').hide();
			}
			else {
				$('#IN1').show();
				$('#IN12').show();
			}
			FillItems();
		})

		$('#AltPOQty').change(function () {
			if ($('#POQty').val() == 0) {
				$.ajax({
					type: "GET",
					url: "@Url.Action("AltUnitConversion")",
					dataType: "json",
					async: false,
					data: { ItemCode: $('#PartCode').val(), AltQty: $(this).val(), UnitQty: 0 },
					success: function (data, status, error) {
						if (data != null) {
							var obj = $.parseJSON(data);
							$('#POQty').val(obj.Result[0].ActualUnitValue);
						}
					},
					error: function (req, status, error) {
						alert(error);
					}
				});
			}

		});

		function FillCurrency() {
			$.ajax({
				type: "GET",
				url: "@Url.Action("FillCurrency")",
				async: false,
				dataType: "json",
				data: { Ctrl: $('#OrderType').val() },
				success: function (result, status, error) {

					if (result != null) {
						var obj = $.parseJSON(result);
						$('#Currency').empty();
						$('#Currency').append("<option value='' disabled>-Select-</option>");
						$.each(obj.Result.Table, function (index, val) {
							$('#Currency').append("<option value=" + val.entry_id + " selected>" + val.Currency + "</option>");
						});
					}
				}
			});
		}
		function googleMatch(searchText, item) {
			if (!searchText) return true;

			let words = searchText.toLowerCase().split(/\s+/);

			let partCode = (item.PartCode || "").toLowerCase();
			let realPartCode = (item.RealPartCode || "").toLowerCase();
			let itemName = (item.ItemName || item.Item_Name || "").toLowerCase();
			let barcode = (item.Barcode || "").toLowerCase();

			// ALL words must match at least one field
			return words.every(word =>
				partCode.includes(word) ||
				realPartCode.includes(word) ||
				itemName.includes(word) ||
				barcode.includes(word)
			);
		}

		var isItemSelected = false;
		function FillItems() {
			// Source for PartCodeText
			const partCodeSource = function (request, response) {
				$.ajax({
					url: '@Url.Action("FillItems", "PurchaseOrder")',
					type: 'POST',
					data: {
						Type: $('#POTypeServItem').val(),
						ShowAllItem: 'N',
						SearchItemCode: '',
						SearchPartCode: request.term
					},
					success: function (result) {
						let obj = typeof result === "string" ? JSON.parse(result) : result;

						if (obj.StatusCode === 200 && obj.StatusText === 'Success' && Array.isArray(obj.Result.Table)) {
							// let filtered = obj.Result.Table.filter(function (item) {
							// 	let term = request.term.toLowerCase();
							// 	return (
							// 		(item.PartCode && item.PartCode.toLowerCase().includes(term)) ||
							// 		(item.Barcode && item.Barcode.toLowerCase().includes(term)) ||
							// 		(item.ItemName && item.ItemName.toLowerCase().includes(term))
							// 	);
							// });

							let filtered = obj.Result.Table.filter(item =>
								googleMatch(request.term, item)
							);

							response($.map(filtered, function (item) {
								return {
									label: item.PartCode,
									value: item.PartCode,
									itemName: item.ItemName,
									itemCode: item.Item_Code,
									onlyPartCode: item.OnlyPartCode,
									onlyItemName: item.OnlyItemName,
								};
							}));
						} else {
							response([]);
						}
					}
				});
			};

			// Source for ItemNameText
			const itemNameSource = function (request, response) {
				$.ajax({
					url: '@Url.Action("FillItems", "PurchaseOrder")',
					type: 'POST',
					data: {
						Type: $('#POTypeServItem').val(),
						ShowAllItem: 'N',
						SearchItemCode: request.term,
						SearchPartCode: ''
					},
					success: function (result) {
						let obj = typeof result === "string" ? JSON.parse(result) : result;

						if (obj.StatusCode === 200 && obj.StatusText === 'Success' && Array.isArray(obj.Result.Table)) {
							// let filtered = obj.Result.Table.filter(function (item) {
							// 	let term = request.term.toLowerCase();
							// 	return item.ItemName.toLowerCase().includes(term);
							// });

							let filtered = obj.Result.Table.filter(item =>
								googleMatch(request.term, item)
							);

							response($.map(filtered, function (item) {
								return {
									label: item.ItemName,
									value: item.Item_Code,
									itemName: item.ItemName,
									itemCode: item.Item_Code,
									partCode: item.PartCode,
									onlyPartCode: item.OnlyPartCode,
									onlyItemName: item.OnlyItemName,
								};
							}));
						} else {
							response([]);
						}
					}
				});
			};

			// Autocomplete for PartCodeText
			$("#PartCodeText").autocomplete({
				source: partCodeSource,
				select: function (event, ui) {
					$("#PartCodeText").val(ui.item.onlyPartCode).data("itemcode", ui.item.itemCode);
					$("#ItemNameText").val(ui.item.onlyItemName);
					$('#ItemCode').val(ui.item.itemCode);
					$('#PartCode').val(ui.item.itemCode);
					GetItemPartCode("PartCode");
					GetTotalStockQty();
					 GetWorkCenterTotalQty();
					// GetlastSaleOrderDetail();
					return false;
				},
				focus: function (event, ui) {
					$("#PartCodeText").val(ui.item.value);
					return false;
				},
				minLength: 2
			});

			// 🔹 Focusout event for PartCodeText (manual entry validation)
			$("#PartCodeText").on("focusout", function () {
				let entered = $(this).val().trim().toLowerCase();
				if (entered === "") return;

				$.ajax({
					url: '@Url.Action("FillItems", "PurchaseOrder")',
					type: 'POST',
					data: {
						Type: $('#POTypeServItem').val(),
						ShowAllItem: 'N',
						SearchItemCode: '',
						SearchPartCode: entered
					},
					success: function (result) {
						let obj = typeof result === "string" ? JSON.parse(result) : result;

						if (obj.StatusCode === 200 && obj.StatusText === 'Success' && Array.isArray(obj.Result.Table)) {
							// 🔹 Partial match: includes()
							// let match = obj.Result.Table.find(item => {
							// 	let real = (item.RealPartCode || "").toLowerCase();
							// 	let name = (item.Item_Name || "").toLowerCase();
							// 	let barcode = (item.Barcode || "").toLowerCase();

							// 	// return real.includes(entered) || name.includes(entered) || barcode.includes(entered);

							// });

							let match = obj.Result.Table.find(item =>
								googleMatch(entered, item)
							);

							if (match) {
								$("#PartCodeText").val(match.OnlyPartCode).data("itemcode", match.Item_Code);
								$("#ItemNameText").val(match.OnlyItemName);
								$("#ItemCode").val(match.Item_Code);
								$("#PartCode").val(match.Item_Code);
								GetItemPartCode("PartCode");
								GetTotalStockQty();
								GetWorkCenterTotalQty();

								// GetlastSaleOrderDetail();

							}
						}

					},
					error: function (xhr, status, error) {
						console.error("AJAX Error:", error);
					}
				});
			});

			// Autocomplete for ItemNameText
			$("#ItemNameText").autocomplete({
				source: itemNameSource,
				select: function (event, ui) {
					$("#ItemNameText").val(ui.item.onlyItemName).data("itemcode", ui.item.itemCode);
					$("#PartCodeText").val(ui.item.onlyPartCode);
					$('#ItemCode').val(ui.item.itemCode);
					$('#PartCode').val(ui.item.itemCode);
					GetItemPartCode("ItemCode");
					GetTotalStockQty();
					// GetlastSaleOrderDetail()
					return false;

				},
				focus: function (event, ui) {
					$("#ItemNameText").val(ui.item.itemName);
					return false;
				},
				minLength: 2
			});

			// // 🔹 Focusout event for ItemNameText (manual entry validation)
			// $("#ItemNameText").on("focusout", function () {
			//     let itemName = $(this).val().trim();
			//     if (itemName !== "") {
			//         $.ajax({
			//             url: '@Url.Action("FillItems", "PurchaseOrder")',
			//             type: 'POST',
			//             data: {
			//                 Type: $('#POTypeServItem').val(),
			//                 ShowAllItem: 'N',
			//                 SearchItemCode: itemName,
			//                 SearchPartCode: ''
			//             },
			//             success: function (result) {
			//                 let obj = typeof result === "string" ? JSON.parse(result) : result;
			//                          alert(JSON.stringify(obj.Result));
			//                 if (obj.StatusCode === 200 && obj.StatusText === 'Success' && Array.isArray(obj.Result.Table)) {

			//                     let match = obj.Result.Table.find(item => {
			//                         let real = (item.RealPartCode || "").toLowerCase();
			//                         let name = (item.Item_Name || "").toLowerCase();
			//                         let barcode = (item.Barcode || "").toLowerCase();

			//                         return real.includes(entered) || name.includes(entered) || barcode.includes(entered);
			//                     });

			//                     if (match) {
			//                         $("#ItemNameText").val(match.OnlyItemName).data("itemcode", match.Item_Code);
			//                         $("#PartCodeText").val(match.OnlyPartCode);
			//                         $('#ItemCode').val(match.Item_Code);
			//                         $('#PartCode').val(match.Item_Code);
			//                         GetItemPartCode("ItemCode");
			//                         GetlastSaleOrderDetail();
			//                     } else {
			//                         alert("Invalid Item Name entered!");
			//                         $("#ItemNameText").val("").focus();
			//                     }
			//                 } else {
			//                     alert("Invalid Item Name entered!");
			//                     $("#ItemNameText").val("").focus();
			//                 }
			//             }
			//         });
			//     }
			// });
		}

		// 		function cleanItemName(name) {
		// 	return name ? name.replace(/--->.*$/, '').trim() : '';
		// }

		// function fetchItems(term, callback, filterBy = "both") {
		// 	$.ajax({

		// 				url: "@Url.Action("FillItems")",
		// 		method: "GET",
		// 				data: { Type: $('#POTypeServItem').val(), // Optional, depending on use
		// 					ShowAllItem: $('#IN1').is(':checked') ? 'Y' : 'N',
		// 					SearchItemCode: term },
		// 		success: function (data) {
		// 			let filtered = data;
		// 			const t = term.toLowerCase();
		// 			if (filterBy === "PartCode") {
		// 				filtered = data.filter(d => d.PartCode && d.PartCode);
		// 			} else if (filterBy === "ItemName") {
		// 				filtered = data.filter(d => d.ItemName && d.ItemName);
		// 			}

		// 			callback(filtered);
		// 		}
		// 	});
		// }

		// function FillItems() {
		// 	// Autocomplete for Part Code
		// 	$("#PartCodeText").autocomplete({
		// 		source: function (request, response) {
		// 					  console.log("Searching PartCode for:", request.term);
		// 					fetchItems(request.term, function (items) {
		// 				response($.map(items, function (item) {
		// 					return {
		// 						label: item.PartCode, // Show only PartCode
		// 								value: item.Item_Code,
		// 								itemName: item.ItemName,
		// 								partCode: item.PartCode
		// 					};
		// 				}));
		// 			}, "PartCode");
		// 		},
		// 		select: function (event, ui) {
		// 					$("#PartCodeText").val(ui.item.label);
		// 			$("#PartCode").val(ui.item.value).trigger('change');
		// 			$("#ItemNameText").val(ui.item.itemName);
		// 			$("#ItemCode").val(ui.item.itemCode).trigger('change');
		// 					GetItemPartCode("PartCodeText") ;
		// 			return false;
		// 		}
		// 	});

		
		// 	$("#ItemNameText").autocomplete({
		// 		source: function (request, response) {
		// 			fetchItems(request.term, function (items) {
		// 				response($.map(items, function (item) {
		// 					return {
		// 						label: cleanItemName(item.ItemName), // Show cleaned name
		// 								value: Item_Code,
		// 						itemCode: item.Item_Code,
		// 						partCode: item.PartCode
		// 					};
		// 				}));
		// 			}, "ItemName");
		// 		},
		// 		select: function (event, ui) {
		// 					$("#ItemNameText").val(ui.item.label);
		// 			$("#ItemCode").val(ui.item.itemCode).trigger('change');
		// 			$("#PartCodeText").val(ui.item.partCode);
		// 					$("#PartCode").val(ui.item.itemCode).trigger('change');
		// 			GetItemPartCode("PartCodeText");
		// 					return false;
		// 		}
		// 	});
		// }

		//  function fetchItems(searchTerm, callback) {
		// 	$.ajax({
		// 					type: "GET",
		// 				url: "@Url.Action("FillItems")",
		// 				dataType: "json",
		// 				async: false,
		// 		data: {
		// 			Type: $('#POTypeServItem').val(), // Optional, depending on use
		// 			ShowAllItem: $('#IN1').is(':checked') ? 'Y' : 'N',
		// 			SearchItemCode: searchTerm
		// 		},
		// 		success: function (result) {
		// 			var obj = JSON.parse(result);
		// 			if (obj.StatusCode === 200 && obj.StatusText === "Success") {
		// 				callback(obj.Result);
		// 			} else {
		// 				callback([]);
		// 			}
		// 		}
		// 	});
		// 		}
		// 		function FillItems() {
		// 		// Autocomplete for Part Code
		// 				$("#PartCodeText").autocomplete({
		// 			source: function (request, response) {
		// 				fetchItems(request.term, function (items) {
		// 					response($.map(items, function (item) {
		// 						return {
		// 							label: item.PartCode,    // Show only PartCode in the dropdown
		// 							value: item.PartCode,    // Set this as the input value
		// 							itemCode: item.Item_Code,
		// 							itemName: item.ItemName
		// 						};
		// 					}));
		// 				});
		// 			},
		// 			select: function (event, ui) {
		// 				// On selecting PartCode, fill other fields
		// 				$("#PartCodeText").val(ui.item.value);         // Visible textbox
		// 				$("#PartCode").val(ui.item.value).trigger('change'); // Hidden select/input
		// 				$("#ItemNameText").val(ui.item.itemName);      // Fill ItemNameText
		// 				$("#ItemCode").val(ui.item.itemCode).trigger('change'); // Fill ItemCode
		// 				return false; // Prevent default behaviour
		// 			}
		// 		});
		// 		$("#ItemNameText").autocomplete({
		// 				source: function (request, response) {
		// 					fetchItems(request.term, function (items) {
		// 						response($.map(items, function (item) {
		// 							return {
		// 								label: item.ItemName,         // Only ItemName shown in list
		// 								value: item.ItemName,         // Fills input with ItemName
		// 								itemCode: item.Item_Code,     // Additional data
		// 								partCode: item.PartCode
		// 							};
		// 						}));
		// 					});
		// 				},
		// 				select: function (event, ui) {
		// 					// Set corresponding values on selection
		// 					$("#ItemNameText").val(ui.item.value);              // Show ItemName in textbox
		// 					$("#ItemCode").val(ui.item.itemCode).trigger('change');
		// 					$("#PartCodeText").val(ui.item.partCode);           // Show PartCode in text
		// 					$("#PartCode").val(ui.item.partCode).trigger('change');
		// 					return false; // Prevent default behavior
		// 				}
		// 			});
		// }
		// 		function FillItems(){
		// 							   $("#PartCodeText").autocomplete({
		// 			   source: function (request, response) {
		// 				   $.ajax({
		// 					   url: '@Url.Action("FillPartCode")',
		// 					   type: 'POST',
		// 					   data: { search: request.term },
		// 					   success: function (result) {
		// 						   var obj = $.parseJSON(result);
		// 						   if (obj.StatusCode === 200 && obj.StatusText === 'Success') {
		// 							   response($.map(obj.Result, function (item) {
		// 								   return {
		// 									   label: item.PartCode,
		// 									   value: item.PartCode,
		// 									   itemCode: item.Item_Code
		// 								   };
		// 							   }));
		// 						   } else {
		// 							   response([]);
		// 						   }
		// 					   }
		// 				   });
		// 			   },
		// 			   select: function (event, ui) {
		// 				   $("#PartCode").val(ui.item.label).data("itemcode", ui.item.itemCode);
		// 						  $('#ItemCode').val(ui.item.itemCode);
		// 				   SetPartCodeItemName("PartCode");
		// 				  GetItemPartCode("PartCode");
		// 						 handleItemSelection()
		// 				   return false;
		// 			   },
		// 			   focus: function (event, ui) {
		// 				   $("#PartCode").val(ui.item.label);
		// 				   return false;
		// 			   },
		// 			   minLength: 1
		// 		   });

		// }
// 		 function FillItems() {
// 		// Autocomplete for Part Code
// 				$("#PartCodeText").autocomplete({
// 			minLength: 2,
// 			source: function (request, response) {
// 				fetchItems(request.term, function (items) {
// 					response($.map(items, function (item) {
// 						return {
// 							label: item.PartCode,    // Show only PartCode in the dropdown
// 							value: item.PartCode,    // Set this as the input value
// 							itemCode: item.Item_Code,
// 							itemName: item.ItemName
// 						};
// 					}));
// 				});
// 			},
// 			select: function (event, ui) {
// 				// On selecting PartCode, fill other fields
// 				$("#PartCodeText").val(ui.item.value);         // Visible textbox
// 				$("#PartCode").val(ui.item.value).trigger('change'); // Hidden select/input
// 				$("#ItemNameText").val(ui.item.itemName);      // Fill ItemNameText
// 				$("#ItemCode").val(ui.item.itemCode).trigger('change'); // Fill ItemCode
// 				return false; // Prevent default behaviour
// 			}
// 		});
// 		$("#ItemNameText").autocomplete({
// 				minLength: 2,
// 				source: function (request, response) {
// 					fetchItems(request.term, function (items) {
// 						response($.map(items, function (item) {
// 							return {
// 								label: item.ItemName,         // Only ItemName shown in list
// 								value: item.ItemName,         // Fills input with ItemName
// 								itemCode: item.Item_Code,     // Additional data
// 								partCode: item.PartCode
// 							};
// 						}));
// 					});
// 				},
// 				select: function (event, ui) {
// 					// Set corresponding values on selection
// 					$("#ItemNameText").val(ui.item.value);              // Show ItemName in textbox
// 					$("#ItemCode").val(ui.item.itemCode).trigger('change');
// 					$("#PartCodeText").val(ui.item.partCode);           // Show PartCode in text
// 					$("#PartCode").val(ui.item.partCode).trigger('change');
// 					return false; // Prevent default behavior
// 				}
// 			});
// }

		// Autocomplete for Item Name

		// function FillItems() {

		// 	$.ajax({
		// 		type: "GET",
		// 		url: "@Url.Action("FillItems")",
		// 		dataType: "json",
		// 		async: false,
		// 		data: { Type: $('#POTypeServItem').val(), ShowAllItem: $('#IN1').is(":checked") == true ? 'Y' : 'N' },
		// 		success: function (result, status, error) {

		// 			if (result != null) {
		// 				var obj = $.parseJSON(result);
		// 				if (obj.StatusCode == 200 && obj.StatusText == "Success") {
		// 					$('#PartCode,#ItemCode').empty();
		// 					$('#PartCode, #ItemCode').append("<option selected disabled>-Select-</option>");
		// 					if (isItemSelected) {
		// 						const distinctItems = Array.from(
		// 							itemDataArray.reduce((map, item) => map.set(item.ItemCode, item), new Map()).values()
		// 						);

		// 						$.each(distinctItems, function (index, val) {
		// 							$('#PartCode').append("<option value=" + val.ItemCode + " data-unipartcode = " + val.PartCode + ">" + val.PartCode + "</option>");
		// 							$('#ItemCode').append("<option value=" + val.ItemCode + " data-unipartcode = " + val.PartCode + ">" + val.ItemName + "</option>");
		// 						});
		// 					}
		// 					else {

		// 						$.each(obj.Result.Table, function (index, val) {
		// 							$('#PartCode').append("<option value=" + val.Item_Code + " data-unipartcode = " + val.UniversalPartCode + " data-unidesc = " + val.UniversalDescription + ">" + val.PartCode + "</option>");
		// 							$('#ItemCode').append("<option value=" + val.Item_Code + " data-unipartcode = " + val.UniversalPartCode + " data-unidesc = " + val.UniversalDescription + ">" + val.ItemName + "</option>");
		// 						});
		// 					}
		// 				}
		// 			}
		// 		}
		// 	});
		// }

		// 		function FillItems() {
		// 	$.ajax({
		// 		type: "GET",
		// 		url: "@Url.Action("FillItems")",
		// 		dataType: "json",
		// 		async: false,
		// 		data: {
		// 			Type: $('#POTypeServItem').val(),
		// 			ShowAllItem: $('#IN1').is(":checked") ? 'Y' : 'N',
		// 					SearchItemCode: searchTerm
		// 		},
		// 		success: function (result) {
		// 			if (result != null) {
		// 				var obj = $.parseJSON(result);
		// 				if (obj.StatusCode === 200 && obj.StatusText === "Success") {
		// 					let sourceData = [];

		// 					if (isItemSelected) {
		// 						const distinctItems = Array.from(
		// 							itemDataArray.reduce((map, item) => map.set(item.ItemCode, item), new Map()).values()
		// 						);

		// 						sourceData = distinctItems.map(val => ({
		// 							label: val.PartCode + " - " + val.ItemName,
		// 							value: val.ItemName,
		// 							itemCode: val.ItemCode,
		// 							partCode: val.PartCode
		// 						}));
		// 					} else {
		// 						sourceData = obj.Result.Table.map(val => ({
		// 							label: val.PartCode + " - " + val.ItemName,
		// 							value: val.ItemName,
		// 							itemCode: val.Item_Code,
		// 							partCode: val.PartCode
		// 						}));
		// 					}

		// 					// Autocomplete for PartCodeText
		// 					$("#PartCodeText").autocomplete({
		// 						source: sourceData,
		// 						minLength: 1,
		// 						select: function (event, ui) {
		// 							$("#PartCodeText").val(ui.item.partCode);
		// 							$("#ItemNameText").val(ui.item.value); // show Item Name
		// 							$("#ItemCode").val(ui.item.itemCode);   // store ItemCode int
		// 							$("#PartCode").val(ui.item.itemCode);   // store PartCode int (if needed)
		// 							return false;
		// 						}
		// 					});

		// 					// Autocomplete for ItemNameText
		// 					$("#ItemNameText").autocomplete({
		// 						source: sourceData,
		// 						minLength: 1,
		// 						select: function (event, ui) {
		// 							$("#ItemNameText").val(ui.item.value);
		// 							$("#PartCodeText").val(ui.item.partCode);
		// 							$("#ItemCode").val(ui.item.itemCode);
		// 							$("#PartCode").val(ui.item.itemCode); // assuming same
		// 							return false;
		// 						}
		// 					});
		// 				}
		// 			}
		// 		}
		// 	});
		// }

		var currentSearchColumn = null;
		$("#search-box").on("keyup", function () {
			var value = $(this).val().toLowerCase();
			$("#divPOItemList tr").filter(function () {
				if (currentSearchColumn !== null) {
					var columnText = $(this).find('td').eq(currentSearchColumn).text().toLowerCase();
					$(this).toggle(columnText.indexOf(value) > -1);
				} else {
					$(this).toggle($(this).text().toLowerCase().indexOf(value) > -1);
				}
			});
		});


		$(document).on("click", "th[data-columnno]", function () {
			currentSearchColumn = $(this).data('columnno');
			$("#search-box").val('').trigger('keyup'); // Reset search box and trigger the search
		});

		var currentIndentSearchColumn = null;
		$("#indent-search-box").on("keyup", function () {
			var value = $(this).val().toLowerCase();
			$("#divIndentDetail tr").filter(function () {
				if (currentIndentSearchColumn !== null) {
					var columnText = $(this).find('td').eq(currentIndentSearchColumn).text().toLowerCase();
					$(this).toggle(columnText.indexOf(value) > -1);
				} else {
					$(this).toggle($(this).text().toLowerCase().indexOf(value) > -1);
				}
			});
		});

		$(document).on("click", ".sortCol", function () {
			var $column = $(this).parent().closest("th");
			var colno = $(this).data('columnno');
			var currentOrder = $(this).data('sortorder');

			$('.sortCol').css('color', 'white');
			if (currentOrder === 'asc') {
				sortTable(colno, false);
				$(this).data('sortorder', 'desc');
				$(this).css('color', 'yellow'); // Visual indication of descending order
				//$(this).css('font-size', 'larger'); // Visual indication of descending order
				$(this).find('i:first').removeClass('fa-arrow-up');
				$(this).find('i:first').addClass('fa-arrow-down');
			} else {
				sortTable(colno, true);
				$(this).data('sortorder', 'asc');
				$(this).css('color', 'yellow');
				// $(this).css('font-size', 'larger'); // Visual indication of ascending order
				$(this).find('i:first').removeClass('fa-arrow-down');
				$(this).find('i:first').addClass('fa-arrow-up');
			}
		});
		function sortTable(columnIndex, ascending) {

			var table = $('#poTable');
			var rows = table.find('#divPOItemList > tr').toArray();

			rows.sort(function (a, b) {
				var aValue = $(a).find('td').eq(columnIndex).text();
				var bValue = $(b).find('td').eq(columnIndex).text();

				var aIntValue = 0;
				var bIntValue = 0;
				if (/^\d*\.?\d+$/.test(aValue) && /^\d*\.?\d+$/.test(bValue)) {
					aIntValue = parseInt(aValue, 10);
					bIntValue = parseInt(bValue, 10);
				}

				if (aIntValue > 0) {
					if (ascending) {
						return aValue - bValue;
					} else {
						return bValue - aValue;
					}
				} else {
					if (ascending) {
						return aValue.localeCompare(bValue);
					} else {
						return bValue.localeCompare(aValue);
					}
				}
			});

			$.each(rows, function (index, row) {
				table.children('#divPOItemList').append(row);
			});
		}

		$('#POFor').change(function () {
			var poFor = $(this).val();
			if (poFor == 'For JobWork') {
				$('#POTypeServItem').empty();
				$('#POTypeServItem').append("<option disabled>-Select-</option>");
				$('#POTypeServItem').append("<option value='Item' selected>Item</option>");
				$('#POTypeServItem').append("<option value='Service'>Service</option>");
				$('#POTypeServItem').trigger("change");
			}
			else if (poFor == 'For Service') {
				$('#POTypeServItem').empty();
				$('#POTypeServItem').append("<option disabled>-Select-</option>");
				$('#POTypeServItem').append("<option value='Service'>Service</option>");
				$('#POTypeServItem').trigger("change");
			}
			else {
				$('#POTypeServItem').empty();
				$('#POTypeServItem').append("<option disabled>-Select-</option>");
				$('#POTypeServItem').append("<option value='Item' selected>Item</option>");
				$('#POTypeServItem').append("<option value='Service'>Service</option>");
				$('#POTypeServItem').append("<option value='Asset'>Asset</option>");
				$('#POTypeServItem').trigger("change");
			}
		});

		$('#WEF').change(function () {

			var poEffDate = $(this).val();
			var poDate = $('#PODate').val();
			// if (poEffDate < poDate) {
			//     $.notify("PO EFF Date cannot be less than PO Date", "error");
			//     $('#WEF').datepicker({ dateFormat: 'dd/mm/yy' }).datepicker("setDate", 'now');
			// }
		});

		$('#WEF').on("keydown", function (event) {
			if (event.key === "Tab") {
				$('#POCloseDate').focus();
				event.preventDefault();
			}
		});

		$('#WEF').change(function () {
			$('#POCloseDate').focus();
		});

		$('#POCloseDate').on("keydown", function (event) {
			if (event.key === "Tab") {
				$('#AmmNo').focus();
				event.preventDefault();
			}
		});

		$('#POCloseDate').change(function () {
			$('#AmmNo').focus();
			$('#AmmDate').datepicker("option", "maxDate", parseDateToFormat($('#POCloseDate').val()));
		});

		$('#AmmDate').on("keydown", function (event) {
			if (event.key === "Tab") {
				$('#MRPNo').focus();
				event.preventDefault();
			}
		});

		$('#AmmDate').change(function () {
			$('#MRPNo').focus();
		});

		$('#RefDate').on("keydown", function (event) {
			if (event.key === "Tab") {
				$('#ShipTo').focus();
				event.preventDefault();
			}
		});
		$('#RefDate').change(function () {
			$('#ShipTo').focus();
		});

		$('#POQty').change(function () {
			$.ajax({
				type: "GET",
				url: "@Url.Action("AltUnitConversion")",
				dataType: "json",
				async: false,
				data: { ItemCode: $('#PartCode').val(), AltQty: 0, UnitQty: $('#POQty').val() },
				success: function (data, status, error) {
					if (data != null) {
						var obj = $.parseJSON(data);
						$('#AltPOQty').val(obj.Result[0].AltUnitValue);
					}
				},
				error: function (req, status, error) {
					alert(error);
				}
			});
		});
		$('#PODate').change(function () {
			$('#AccountCode').select2('open').select2('focus');
		});
		$('#PODate').on('keydown', function () {
			$('#AccountCode').focus();
		});
		$(document).on('select2:open', () => {
			document.querySelector('.select2-search__field').focus();
		});
		//        $('#AccountCode').on('select2:open', function() {
		//
		//              $('.select2-search__field').focus();
		//          });
		function ValidateForm() {
			var Err = 0;
			if ($('#POFor').val() == 0) {
				AddErrorCls('POFor');
				$.notify('POFor is required...!', "error");
				Err = 1;
			}
			else {
				RemoveErrorCls('POFor');
			}

			if ($('#AccountCode').val() == 0 || $('#AccountCode').val() == null) {
				AddErrorCls('AccountCode');
				$.notify('AccountName is required...!', "error");
				Err = 1;
			}
			else {
				RemoveErrorCls('AccountCode');
			}
			if ($('#AccountCodeText').val() == 0 || $('#AccountCodeText').val() == null || $('#AccountCodeText').val() == '') {
				AddErrorCls('AccountCode');
				$.notify('AccountName is required...!', "error");
				Err = 1;
			}
			else {
				RemoveErrorCls('AccountCode');
			}

			Err == 1 ? ShowErrorFld('HPanel1') : HideErrorFld('HPanel1');

			if (Err == 1) return false;


			if ($('#PreparedBy').prop('selectedIndex') == 0) {
				AddErrorCls('PreparedBy');
				$.notify('PreparedBy is required...!', "error");
				Err = 1;
			}
			else {
				RemoveErrorCls('PreparedBy');
			}

			Err == 1 ? ShowErrorFld('HPanel4') : HideErrorFld('HPanel4');

			if (Err == 1) return false;

			return true;
		}

		$('form').submit(function (event) {
			//var poEffDate = $(this).val();
			//var poDate = $('#PODate').val();
			//if (poEffDate < poDate) {
			//    $.notify("PO EFF Date cannot be less than PO Date", "error");
			//    $('#WEF').datepicker({ dateFormat: 'dd/mm/yy' }).datepicker("setDate", 'now');
			//}
			//else {
			//    $("form").submit();
			//}

			//$('#PartCode').prop('selectedIndex', 1).trigger("change");

			$('.btn-outline-primary').prop('disabled', true).html('Validating Form... <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>');
			if (!ValidateForm()) {
				event.preventDefault(); // Prevent the form from submitting via the browser
				$('.btn-outline-primary').prop('disabled', false).html('<i class="fa-solid fa-chevron-circle-right fa-fw fa-lg"></i> SUBMIT');
			}
			else {
				//event.stopPropagation(); // Prevent calling function inside this function.
				var form = $(this);
				var url = form.attr('action'); //get submit url [replace url here if desired]
				$("form :input").prop("disabled", false);
			}
		});


		$('#PODate,#AmmEffDate').on('keydown', function (e) {
			e.preventDefault();
			return false;
		});
		// 		$(document).on('autocompleteselect', '#ItemNameText, #PartCodeText', function (e, ui) {
		// 	var cntId = e.target.id;

		// 	if (cntId === 'ItemNameText') {
		// 		ItemNameChange(cntId);
		// 	} else if (cntId === 'PartCodeText') {
		// 		PartCodeChange(cntId);
		// 	}
		// });

		function PartCodeChange(ID) {
			const partCode = $('#PartCode').val();
			const sumItemwiseQty = Array.from(
				itemDataArray
					.filter(item => item.ItemCode == partCode)
					.reduce((map, item) => {
						if (map.has(item.ItemCode)) {
							map.get(item.ItemCode).Qty += item.Qty !== '' ? parseFloat(item.Qty) : 0;
						} else {
							map.set(item.ItemCode, {
								...item,
								Qty: item.Qty !== '' ? parseFloat(item.Qty) : 0
							});
						}
						return map;
					}, new Map()).values()
			);

			$('#POQty,#AltPOQty').val(sumItemwiseQty.length > 0 ? sumItemwiseQty[0].Qty : 0);
			copyToClipboardForDropdown("#PartCode");

			const selectedItem = itemDataArray.find(item => item.ItemCode == partCode);
			if (selectedItem) {
				$('#UniversalPartCode').val(selectedItem.UniversalPartCode || '');
				$('#UniversalDescription').val(selectedItem.UniversalDescription || '');
			}

			$.when(SetPartCodeItemName(ID)).done(function () {
				GetItemPartCode(ID);
			});

			$('#HSNNo').focus();
		}

		function ItemNameChange(ID) {
			const itemCode = $('#ItemCode').val();
			const sumItemwiseQty = Array.from(
				itemDataArray
					.filter(item => item.ItemCode == itemCode)
					.reduce((map, item) => {
						if (map.has(item.ItemCode)) {
							map.get(item.ItemCode).Qty += item.Qty !== '' ? parseFloat(item.Qty) : 0;
						} else {
							map.set(item.ItemCode, {
								...item,
								Qty: item.Qty !== '' ? parseFloat(item.Qty) : 0
							});
						}
						return map;
					}, new Map()).values()
			);

			$('#POQty,#AltPOQty').val(sumItemwiseQty.length > 0 ? sumItemwiseQty[0].Qty : 0);
			copyToClipboardForDropdown("#ItemCode");

			$('#UniversalPartCode').val($('#ItemCode').find().data('unipartcode'));
			$('#UniversalDescription').val($('#ItemCode').find().data('unidesc'));

			SetPartCodeItemName(ID);
			GetItemPartCode(ID);
			$('#HSNNo').focus();
		}

		function SetPartCodeItemName(ID) {
			if (!ID) return;
			var v = $('#' + ID).val();
			if (ID == "PartCode") {
				$("#ItemCode").val(v).trigger("change");
			} else if (ID == "ItemCode") {
				$("#PartCode").val(v).trigger("change");
			}
		}

		function copyToClipboardForDropdown(element) {
			var $temp = $("<input>");
			$("body").append($temp);
			$temp.val($(element).find(":selected").text()).select();
			document.execCommand("copy");
			$temp.remove();
		}

		async function GetItemPartCode(ID) {
			$.getJSON({
				url: '@Url.Action("GetItemPartCode", "SaleOrder")',
				data: { Code: $('#' + ID).val() },
				async: false,
				success: function (result, status, xhr) {
					if (result) {
						var obj = JSON.parse(result);
						if (!obj) {
							$('#Unit').val('0');
							$('#HSNNo').val('0');
							$('#AltUnit').val('NA');
						} else if (obj.StatusCode == 200 && obj.StatusText == "Success") {
							$('#Unit').val(obj.Result[0].Unit);
							$('#HSNNo').val(obj.Result[0].HSNNo);
							$('#PkgStd').val(obj.Result[0].StdPacking);
							$('#AltUnit').val(obj.Result[0].AltUnit == null ? 'NA' : obj.Result[0].AltUnit);
							$('#UnitRate').prop('disabled', !$('#AltUnit').val());
							$('#ItemGroupName').val("");
							$('#ItemGroupName').val(obj.Result[0].Group_name);
							$('#ItemLocation').val("");
							$('#ItemLocation').val(obj.Result[0].Location);
							$('#VehicleNo').val("");
							$('#VehicleNo').val(obj.Result[0].Vehicle);
							
						}
					}
				},
				error: function (result, status, xhr) {
					$.notify(result.responseText, "error");
				}
			});
		}

	// 	$(document).on('autocompleteselect', '#ItemNameText, #PartCodeText', function (e, ui) {

	// 	//$(document).on('select2:select', '#ItemCode,#PartCode', function (e) {
	// 		var cntId = e.target.id;

	// 		if (cntId == 'ItemNameText') {
	// 			ItemNameChange(cntId);
	// 		}
	// 		else {
	// 			PartCodeChange(cntId);
	// 		}

	// 	});

	// 	function copyToClipboardForDropdown(element) {
	// 		var $temp = $("<input>");
	// 		$("body").append($temp);
	// 		;
	// 		$temp.val($(element).find(":selected").text()).select();
	// 		document.execCommand("copy");
	// 		$temp.remove();
	// 	}

	// 	function SetPartCodeItemName(ID) {

	// 		if (!ID) return;
	// 		else {
	// 			var v = $('#' + ID).select2('val');
	// 			if (ID == "PartCode") {
	// 				$("#ItemCode").val(v).trigger("change");
	// 			}

	// 			if (ID == "ItemCode") {
	// 				$("#PartCode").val(v).trigger("change");
	// 			}
	// 		}
	// 	}

	// 	function PartCodeChange(ID) {

	// 		const sumItemwiseQty = Array.from(
	// 			itemDataArray
	// 				.filter(item => item.ItemCode == $('#PartCode').val())
	// 				.reduce((map, item) => {
	// 					if (map.has(item.ItemCode)) {
	// 						map.get(item.ItemCode).Qty += item.Qty !== '' ? parseFloat(item.Qty) : 0;
	// 					} else {
	// 						map.set(item.ItemCode, {
	// 							...item,
	// 							Qty: item.Qty !== '' ? parseFloat(item.Qty) : 0
	// 						});
	// 					}
	// 					return map;
	// 				}, new Map()).values()
	// 		);

	// 		$('#POQty,#AltPOQty').val(sumItemwiseQty.length > 0 ? sumItemwiseQty[0].Qty : 0);

	// 		copyToClipboardForDropdown("#PartCode");
	// 			const selectedItem = itemDataArray.find(item => item.ItemCode == partCode);

	// 	if (selectedItem) {
	// 		$('#UniversalPartCode').val(selectedItem.UniversalPartCode || '');
	// 		$('#UniversalDescription').val(selectedItem.UniversalDescription || '');
	// 	}

	// 	$.when(SetPartCodeItemName(ID)).done(function () {
	// 		GetItemPartCode(ID);
	// 	});

	// 		// $('#UniversalPartCode').val($('#PartCode').find(":selected").data('unipartcode'));
	// 		// $('#UniversalDescription').val($('#PartCode').find(":selected").data('unidesc'));
	// 	//	$.when(SetPartCodeItemName(ID)).done(function () { GetItemPartCode(ID) });
	// 		$('#HSNNo').focus();
	// 	}


	// 	function ItemNameChange(ID) {
	// 		// $('#POQty,#AltPOQty').val(0);

	// 		const sumItemwiseQty = Array.from(
	// 			itemDataArray
	// 				.filter(item => item.ItemCode == $('#ItemCode').val())
	// 				.reduce((map, item) => {
	// 					if (map.has(item.ItemCode)) {
	// 						map.get(item.ItemCode).Qty += item.Qty !== '' ? parseFloat(item.Qty) : 0;
	// 					} else {
	// 						map.set(item.ItemCode, {
	// 							...item,
	// 							Qty: item.Qty !== '' ? parseFloat(item.Qty) : 0
	// 						});
	// 					}
	// 					return map;
	// 				}, new Map()).values()
	// 		);

	// 		$('#POQty,#AltPOQty').val(sumItemwiseQty.length > 0 ? sumItemwiseQty[0].Qty : 0);

	// $('#UniversalPartCode').val($('#ItemCode').find(":selected").data('unipartcode'));
	// 	$('#UniversalDescription').val($('#ItemCode').find(":selected").data('unidesc'));
	// 		copyToClipboardForDropdown("#ItemCode");

	// 		SetPartCodeItemName(ID);
	// 		GetItemPartCode(ID);
	// 		$('#HSNNo').focus();

	// 	}

		function GetFormRights() {
			$.ajax({
				url: "@Url.Action("GetFormRights")",
				type: "POST",
				async: false,
				success: function (data) {
					if (data != null) {
						var obj = $.parseJSON(data);
						if (obj.Result.Table.length == 0) {
							if ($('#Mode').val() == "POA") {
								$('.AmendButton').prop("disabled", true);
							}
							$('#submitBTN').prop("disabled", true);
							$('.card-footer #submitBTN').prop("disabled", true);
						} else {

							var optAll = obj.Result.Table[0].OptAll;
							var optSave = obj.Result.Table[0].OptSave;
							var optUpdate = obj.Result.Table[0].OptUpdate;
							var optDelete = obj.Result.Table[0].OptDelete;
							var optView = obj.Result.Table[0].OptView;
							if (!optAll) {
								if (!optSave) {
									if ($('#Mode').val() == "POA") {
										$('.AmendButton').prop("disabled", true);
									}
									$('#submitBTN').prop("disabled", true);
									$('.card-footer #submitBTN').prop("disabled", true);
									$('#UpdateButton').prop("disabled", true);
									$('.card-footer #UpdateButton').prop("disabled", true);
									$('.PartialSave').prop("disabled", true);
								}
								if (!(optUpdate || optDelete || optView)) {
									$(".saleorderDashBoard")
										.addClass("disabled-link")
										.on("click", function (e) {
											e.preventDefault(); // Prevents clicking the link
										});
								}
							}
						}
					}
				},
				error: function (errMsg) {
					$.notify(errMsg, { position: "top center", className: "error" });
				}
			});
		}

		// async function GetItemPartCode(ID) {
		// 	$.getJSON({
		// 		url: '@Url.Action("GetItemPartCode", "SaleOrder")',
		// 		data: { Code: $('#' + ID).val() },
		// 		async: false,
		// 		success: function (result, status, xhr) {
		// 			if (result) {
		// 				var obj = JSON.parse(result);
		// 				if (!obj) {
		// 					$('#Unit').val('0'), $('#HSNNo').val('0'), $('#AltUnit').val('NA');
		// 				}
		// 				else if (obj.StatusCode == 200 && obj.StatusText == "Success") {
		// 					$('#Unit').val(obj.Result[0].Unit);
		// 					$('#HSNNo').val(obj.Result[0].HSNNo);
		// 					$('#PkgStd').val(obj.Result[0].StdPacking);
		// 					$('#AltUnit').val(obj.Result[0].AltUnit == null ? 'NA' : obj.Result[0].AltUnit);
		// 					!$('#AltUnit').val() ? $('#UnitRate').prop('disabled', true) : $('#UnitRate').prop('disabled', false);
		// 				}
		// 			}
		// 		},
		// 		error: function (result, status, xhr) {
		// 			$.notify(result.responseText, "error");
		// 		}
		// 	});
		// }

		//by sumu
		//$('#PartCode,#ItemCode').change(function () {
		//    if ($(this).prop('selectedIndex') != 0) {
		//        $.getJSON({
		//            url: "@Url.Action("GetPOItem")",
		//            data: { AccountCode: parseInt($('#AccountCode').val()), PONO: parseInt($('#PONO').val()), Year: $('#POYearCode').val(), ItemCode: parseInt($(this).val()) },
		//            success: function (result, status, xhr) {
		//                if (result != null) {
		//                    var obj = $.parseJSON(result);
		//                    if (obj.StatusCode == 200 && obj.StatusText == 'Success') {
		//                        $('#Unit').val(obj.Result[0].Unit), $('#Rate').val(obj.Result[0].Rate.toFixed(2));
		//                        obj.Result[0].AltUnit == null ? ($('#AltUnit').prop('disabled', true), $('#AltSchQty').prop('disabled', true)) : ($('#AltUnit').val(obj.Result[0].AltUnit), $('#AltSchQty').val('0.00'));
		//                    }
		//                    else if (obj.StatusCode == 500 && obj.StatusText == 'Error') {

		//                    }
		//                }
		//            },
		//            error: function (result, status, xhr) {
		//                $.notify(result.responseText, "error");
		//            }
		//        });
		//    }
		//    else {
		//        $('#Unit').val(''), $('#Rate').val('0.00'), $('#SchQty').val(''), $('#DeliveryDate').val('');
		//    }
		//});

		$('#TxTaxType').change(function () {
			//GetTaxVendorName();
		});

		$('#OrderType').change(function () {
			var type = $(this).val();
			$('#type').val("order");
			$('#type2').val(type);
			var rowCount = $('#divPOItemList tr td').length;
			var TaxrowCount = $('#divTaxGrid tr td').length;
			if (rowCount > 1 || TaxrowCount > 1) {
				$('#POConfirmationBox').modal("show");
			}
			else {
				if ($('#type').val() == "PO") {
					$('.Schedule').fadeOut();
					ClearItemTax();
					if ($(this).val() == "Open") {
						$('#POQty,#AltPOQty').val('0').prop('disabled', true).attr('readonly', 'readonly');
					}
					if ($(this).val() == "Close") {
						$('#POQty,#AltPOQty').val('0').prop('disabled', false).removeAttr('readonly');
					}
				}
				else {
					FillCurrency();
					ClearItemTax();
					if ($('#OrderType').val() == 'Import') {
						$('#OtherRateCurr').prop("disabled", false);
						$('#Rate').prop("disabled", true);
					}
					else {
						$('#OtherRateCurr').prop("disabled", true);
						$('#Rate').prop("disabled", false);
					}
				}
			}

		});

		$('#POType').change(function () {
			var type = $(this).val();
			$('#type').val("PO");
			$('#type2').val(type);
			var rowCount = $('#divPOItemList tr td').length;
			var TaxrowCount = $('#divTaxGrid tr td').length;
			if (rowCount > 1 || TaxrowCount > 1) {
				$('#POConfirmationBox').modal("show");
			}
			else {
				if ($('#type').val() == "PO") {
					$('.Schedule').fadeOut();
					ClearItemTax();
					if ($(this).val() == "Open") {
						$('#POQty,#AltPOQty').val('0').prop('disabled', true).attr('readonly', 'readonly');
					}
					if ($(this).val() == "Close") {
						$('#POQty,#AltPOQty').val('0').prop('disabled', false).removeAttr('readonly');
					}
				}
				else {
					FillCurrency();
					ClearItemTax();
					if ($('#OrderType').val() == 'Import') {
						$('#OtherRateCurr').prop("disabled", false);
						$('#Rate').prop("disabled", true);
					}
					else {
						$('#OtherRateCurr').prop("disabled", true);
						$('#Rate').prop("disabled", false);
					}
				}
			}

			if ($('#POType').val() == 'Open') {
				$('#POQty').val('0').prop('disabled', true).attr('readonly', 'readonly');
			}
		});
		$('#cancelBtn').click(function () {
			if ($('#type').val() == "PO") {
				if ($('#type2').val() == 'Close') {
					$('#POType').val('Open');
				}
				else {
					$('#POType').val('Close');

				}
			}
			else {
				if ($('#type2').val() == 'Import') {
					$('#OrderType').val('Domestic');
				}
				else {
					$('#OrderType').val('Import');
				}
				if ($('#OrderType').val == 'Import') {
					$('#OtherRateCurr').prop("disabled", false);
					$('#Rate').prop("disabled", true);
				}
				else {
					$('#OtherRateCurr').prop("disabled", true);
					$('#Rate').prop("disabled", false);
				}
			}
		});
		$('#confirmBtn').click(function () {
			if ($('#type').val() == "PO") {
				$('.Schedule').fadeOut();
				ClearItemTax();
				if ($(this).val() == "Open") {
					$('#POQty,#AltPOQty').val('0').prop('disabled', true).attr('readonly', 'readonly');
				}
				if ($(this).val() == "Close") {
					$('#POQty,#AltPOQty').val('0').prop('disabled', false).removeAttr('readonly');
				}
			}
			else {
				FillCurrency();
				ClearItemTax();
				if ($('#OrderType').val() == 'Import') {
					$('#OtherRateCurr').prop("disabled", false);
					$('#Rate').prop("disabled", true);
				}
				else {
					$('#OtherRateCurr').prop("disabled", true);
					$('#Rate').prop("disabled", false);
				}
			}

		});


		$('#POQty').keyup(function () {

			$('#PendQty').val($(this).val());
		});


		$('#AltPOQty').keyup(function () {
			$('#AltPendQty').val($(this).val());
		});


		async function ClearItemTax() {
			$.ajax({
				url: "@Url.Action("ResetGridItems")",
				type: "GET",
				async: false,
				success: await function (result, status, xhr) {
					if (result == 200) {
						ClearItem();
						var NoData = '<tr class="text-center"><td colspan="28" class="text-black-50"><strong>NO DATA ADDED</strong></td></tr>';
						$('#divPOItemList').html(NoData);
						$('#ItemNetAmount').val('0.00'), $('#TotalTaxAmt').val('0.00'), $('#lblItemNetAmount').text('0.00'), $('#NetTotal').val('0.00'), $('#TotalRoundOff').prop('selectedIndex', 0), $('#TotalDiscountAmt').val('0');
					}
					$('#ItemNetAmount').val('0.00'), $('#TotalTaxAmt').val('0.00'), $('#lblItemNetAmount').text('0.00'), $('#NetTotal').val('0.00'),
						$('#TotalRoundOff').prop('selectedIndex', 0);$('#TotalDiscountAmt').val('0'), $('#TotalAmtAftrDiscount').val('0.00');
				}
			}).done(function (data) {

				$('#divTaxGrid').empty();
				$('#TxPartCode,TxItemCode').empty();
				$('#TxPartCode,TxItemCode').append("<option value='' selected disabled>-Select-</option>");
				$('#TxPartCode').prop('selectedIndex', 0).prop('disabled', false).removeClass('is-invalid').change(), $('#TxItemCode').prop('selectedIndex', 0).prop('disabled', false).removeClass('is-invalid'),
					$('#TxTaxType').prop('selectedIndex', 0).removeClass('is-invalid'), $('#TxAccountCode').prop('selectedIndex', 0).removeClass('is-invalid'), $('#TxPercentg').val(0).removeAttr('readonly').removeClass('is-invalid'),
					$('#TxAdInTxable').prop('selectedIndex', 0).removeClass('is-invalid'), $('#TxRoundOff').prop('selectedIndex', 0).removeClass('is-invalid'), $('#TxRefundable').prop('selectedIndex', 0).removeClass('is-invalid'),
					$('#TxOnExp').val('0.00'), $('#TxRemark').val(''), $('#TxAmount').val("0.00").removeClass('is-invalid');

			}).fail(function (data) {
			}).always(function (data) {
			});
		}
		// $('#POTypeServItem').change(function () {
		//   // alert($('#POTypeServItem').val());
		//    if ($('#POTypeServItem').prop('selectedIndex') != 0) {
		//        $.getJSON({
		//            url: "@Url.Action("GetItemServiceFORPO", "PurchaseOrder")",
		//            data: { ItemService: $('#POTypeServItem').val() },

		//            success: function (result, status, xhr)
		//            {
		//                if ( result != null)
		//                {
		//                var obj = $.parseJSON(result);
		//                $('#ItemCode').empty();

		//                 $('#ItemCode').append('<option>-Select-</option>');
		//                    $.each(obj.Result, function (key, val)
		//                    {
		//                        $('#ItemCode').append('<option value="' + val.ServiceName + '">' + val.ServiceName + '</option>');
		//                    });

		//                }
		//            },
		//            error: function (result, status, xhr)
		//            {
		//            //$.notify(result.responseText, "error");
		//            alert("error");
		//            }
		//        });
		//    }
		//   // else $('#VendorAddress').val('');
		//});

		function copyToClipboardForDropdown(element) {
			var $temp = $("<input>");
			$("body").append($temp);
			;
			$temp.val($(element).find(":selected").text()).select();
			document.execCommand("copy");
			$temp.remove();
		}

		function AccountcodeChange()
{

	copyToClipboardForDropdown("#AccountCode");


			
				$.getJSON({
					url: '@Url.Action("GetAddress", "SaleOrder")',
					data: { Code: $('#AccountCode').val() },
					success: function (result, status, xhr) {
						$('#VendorAddress').val(result.result.address);
					}
				});
		
			
				$.getJSON({
					url: '@Url.Action("GetGstRegister", "PurchaseOrder")',
					data: { Code: $('#AccountCode').val() },
					success: function (result, status, xhr) {
						if (result != null) {
							var obj = $.parseJSON(result);
							$('#GSTRegistered').val(obj.Result[0].GSTRegistered);
						}
					}
				});
			

			// btnClearTax();
			if ($('#TxTaxType').val() != '-Select-') {
				GetTaxAccountName("TAX");
			}
}

		$('#AccountCode').change(function () {
			copyToClipboardForDropdown(this);
			if ($('#AccountCode').prop('selectedIndex') != 0) {
				$.getJSON({
					url: '@Url.Action("GetAddress", "SaleOrder")',
					data: { Code: $('#AccountCode').val() },
					success: function (result, status, xhr) {
						$('#VendorAddress').val(result.result.address);
					}
				});
			}
			else $('#VendorAddress').val('');
			if ($('#AccountCode').prop('selectedIndex') != 0) {
				$.getJSON({
					url: '@Url.Action("GetGstRegister", "PurchaseOrder")',
					data: { Code: $('#AccountCode').val() },
					success: function (result, status, xhr) {
						if (result != null) {
							var obj = $.parseJSON(result);
							$('#GSTRegistered').val(obj.Result[0].GSTRegistered);
						}
					}
				});
			}

			// btnClearTax();
			if ($('#TxTaxType').val() != '-Select-') {
				GetTaxAccountName("TAX");
			}
		});

		$('#PN1').change(function () {
			$.ajax({
				type: "POST",
				url: "@Url.Action("GetPartyList")",
				data: { Check: $('#PN1').is(':checked') == true ? 'T' : 'F' },
				dataType: "json",
				async: false,
				success: function (data, status, error) {

					var obj = $.parseJSON(data);
					$('#AccountCode').empty();
					$('#AccountCode').append('<option>-Select-</option>');
					$.each(obj.Result, function (key, val) {
						$('#AccountCode').append('<option value="' + val.Account_Code + '" data-gstregister="' + val.GSTRegistered + '" data-state="' + val.State + '">' + val.Account_Name + '</option>');
						//$('#VendorAddress').val('');
					});
					if ($('#Mode').val() == "U" || $('#Mode').val() == "V" || $('#Mode').val() == "POA"||$('#Mode').val() == "PAU"  || $('#Mode').val() == "C") {
						var accountCode = @Html.Raw(Json.Serialize(Model.AccountCode));
						$('#AccountCode').val(accountCode).trigger('change.select2');
					} else {
						$('#VendorAddress').val('');
					}
				},
				error: function (req, status, error) {
					alert(error);
				}
			});
		});


		$('#ShipTo').change(function () {
			if ($('#ShipTo').prop('selectedIndex') != 0) {
				$.getJSON({
					url: '@Url.Action("GetAddress", "SaleOrder")',
					data: { Code: $('#ShipTo').val() },
					success: function (result, status, xhr) {
								$('#ShippingAddress').val(result.result.address);
					}
				});
			}
			else $('#ShippingAddress').val('');
		});


		$('#MRPNo').change(function () {
			if ($('#MRPNo').prop('selectedIndex') != 0) {
				$.getJSON({
					url: '@Url.Action("GetMrpYear")',
					data: { MRPNo: $('#MRPNo').val() },
					success: function (result, status, xhr) {
						$('#MRPYearCode').val(result);
					}
				});
			}
			else $('#MRPYearCode').val('');
		});


		$('#QuotNo').change(function () {
			if ($('#QuotNo').prop('selectedIndex') != 0) {
				$.getJSON({
					url: '@Url.Action("GetQuotData")',
					data: { QuotNo: $('#QuotNo').val() },
					success: function (result, status, xhr) {
						var objQuotData = $.parseJSON(result);
						if (objQuotData.StatusCode === 200 && objQuotData.StatusText === "Success") {
							$('#QuotYear').val(objQuotData.Result[0].YearCode), $('#QuotDate').val(objQuotData.Result[0].QuotDate);
						}
						else {
							$('#QuotYear').val('0'), $('#QuotDate').val('');
						}
					}
				});
			}
			else $('#QuotYear').val('0'), $('#QuotDate').val('');
		});

		$('#PN2').change(function () {
			$.ajax({
				type: "POST",
				url: "@Url.Action("GetPartyList")",
				data: { Check: $('#PN2').is(':checked') == true ? 'T' : 'F' },
				dataType: "json",
				async: false,
				success: function (data, status, error) {
					$('#ShipTo').empty();
					$('#ShipTo').append('<option>-Select-</option>');
					$.each(data, function (key, val) {
						$('#ShipTo').append('<option value="' + val.value + '">' + val.text + '</option>');
						$('#ShippingAddress').val('');
					});
				},
				error: function (req, status, error) {
					alert(error);
				}
			});
		});

		//$('#Currency').change(function () {
		//    $.getJSON({
		//        url: '@Url.Action("GetCurrencyDetail", "SaleOrder")',
		//        data: { Currency: $('#Currency :selected').text() },
		//        success: function (result, status, xhr) {
		//            if (result != null && result != "null") {
		//                var objResult = $.parseJSON(result);
		//                if (objResult != null) {
		//                    if (objResult.StatusCode == 200 && objResult.StatusText == "Success") {
		//                        if (objResult.Result != null) {
		//                            $('#ExRate').val(parseFloat(objResult.Result[0].Rate));
		//                            if (objResult.Result[0].Default == "Y") {
		//                                $('#Rate').val('0.00').prop('disabled', false).removeAttr('readonly');
		//                                $('#OtherRateCurr').val('0').prop('disabled', true).attr('readonly', 'readonly');
		//                            }
		//                            else {
		//                                $('#Rate').val('0.00').prop('disabled', true).attr('readonly', 'readonly');
		//                                $('#OtherRateCurr').val('0').prop('disabled', false).removeAttr('readonly');
		//                                $('#OtherRateCurr').keyup(function () {
		//                                    $('#Rate').val($('#OtherRateCurr').val().trim() != "" ? parseFloat($('#OtherRateCurr').val()) * parseFloat($('#ExRate').val()) : 0);
		//                                    CalculateRate();
		//                                });
		//                            }
		//                        }
		//                    }
		//                }
		//            }
		//        },
		//        error: function (result, status, xhr) {
		//            console.log(result);
		//        }
		//    }).done(function () {
		//        ClearItemTax();
		//    });
		//});




		// $('#IN1').change(function () {

		// 	$('#Unit').val('0'), $('#HSNNo').val('0'), $('#AltUnit').val('NA');
		// 	$.ajax({
		// 		type: "GET",
		// 		url: "@Url.Action("FillItems")",
		// 		dataType: "json",
		// 		async: false,
		// 		data: { Type: 'Item', ShowAllItem: $('#IN1').val() == 'true' ? 'Y' : 'N' },
		// 		success: function (result, status, error) {
		// 			if (result != null) {
		// 				var obj = $.parseJSON(result);
		// 				if (obj.StatusCode == 200 && obj.StatusText == "Success") {

		// 					 var sourceData = $.map(obj.Result.Table, function (val) {
		// 				return {
		// 					label: val.ItemName,
		// 					value: val.ItemName,
		// 					itemcode: val.Item_Code,
		// 					partcode: val.PartCode,
		// 					itemname: val.ItemName.split('--->')[0],
		// 					unipartcode: val.UniversalPartCode,
		// 					unidesc: val.UniversalDescription
		// 				};
		// 			});

		// 			// Rebind autocomplete sources
		// 			$('#ItemNameText').autocomplete('option', 'source', sourceData);
		// 			$('#PartCodeText').autocomplete('option', 'source', sourceData);

		// 					// $('#PartCode,#ItemCode').empty();
		// 					// $('#PartCode, #ItemCode').append("<option selected disabled>-Select-</option>");
		// 					// $.each(obj.Result.Table, function (index, val) {
		// 					// 	$('#PartCode').append("<option value=" + val.Item_Code + ">" + val.PartCode + "</option>");
		// 					// 	$('#ItemCode').append("<option value=" + val.Item_Code + ">" + val.ItemName + "</option>");
		// 					// });
		// 				}

		// 			}
		// 		}
		// 	});
		// });


		$('#SH').change(function () {
			if ($('#SH').is(':checked') == true) {
				$('.AF').fadeIn();
			}
			else {
				$('.AF :input').val('');
				$('.AF').fadeOut();
			}
		});


		function CalculateRate() {
			if ($('#Mode').val() == "POA") {
				$('#OldRate').val(actualRate);
			}

			var Amount = 0.00;
			const OC = $('#POType').val();
			const UnitRate = $('#UnitRate').val();
			const Rate = $('#Rate').val() === "0" || $('#Rate').val() === "" ? 0 : parseFloat($('#Rate').val());
			const DP = $('#DiscPer') === "0" || $('#DiscPer').val() === "" ? 0 : parseFloat($('#DiscPer').val());

			if (UnitRate === "Unit") {
				const POQty = $('#POQty').val() == "0" || $('#POQty').val() === "" ? 0 : parseFloat($('#POQty').val());
				Amount = OC === 'Close' ? POQty * Rate : Amount;
			}
			if (UnitRate == "AltUnit") {
												const AltQty = $('#AltPOQty').val() == "0" || $('#AltPOQty').val() === "" ? 0 : parseFloat($('#AltPOQty').val());
				Amount = OC === 'Close' ? AltQty * Rate : Amount;
			}

			if (DP !== 0) {
				const DA = ((Amount * DP) / 100);
				$('#DiscRs').val(DA);
				Amount = Amount - DA;
			}

			$('#Amount').val(Amount.toFixed(2));
		}

		$('#Rate').on('input', function () {
			let value = $(this).val();
			value = value.replace(/[^\d.]/g, '');
			if (value.split('.').length > 2) {
				value = value.replace(/\.+$/, '');
			}
			$(this).val(value);
		});

		function CalculateRate1() {
			$.ajax({
				type: "POST",
				url: "@Url.Action("GetExchangeRate")",
				data: { Currency: $('#Currency').find(":selected").text() },
				async: false,
				dataType: "json",
				success: function (data, status, error) {

					var obj = $.parseJSON(data);
					var rate = obj.Result[0].Rate;
					var rateinOther = parseFloat($('#OtherRateCurr').val());
					$('#Rate').val(rate * rateinOther);
				},
				error: function (req, status, error) {
					alert(error);
				}
			});

			var Amount = 0;
			const OC = $('#POType').val();
			const UnitRate = $('#UnitRate').val();
			const Rate = $('#Rate').val() === "0" || $('#Rate').val() === "" ? 0 : parseFloat($('#Rate').val());
			const DP = $('#DiscPer') === "0" || $('#DiscPer').val() === "" ? 0 : parseFloat($('#DiscPer').val());

			if (UnitRate === "Unit") {
				const POQty = $('#POQty').val() == "0" || $('#POQty').val() === "" ? 0 : parseInt($('#POQty').val());
				Amount = OC === 'Close' ? POQty * Rate : Amount;
			}
			if (UnitRate == "AltUnit") {
				const AltQty = $('#AltQty').val() == "0" || $('#AltQty').val() === "" ? 0 : parseInt($('#AltQty').val());
				Amount = OC === 'Close' ? AltQty * Rate : Amount;
			}

			if (DP !== 0) {
				const DA = ((Amount * DP) / 100);
				$('#DiscRs').val(DA);
				Amount = Amount - DA;
			}

			$('#Amount').val(Amount.toFixed(2));
		}


		let DelSeqNo = 0;

		async function GetTaxPartItem() {
			$.ajax({
				type: "GET",
				url: '@Url.Action("GetTaxPartItem", "Tax")',
				data: { SessionName: '@ViewData["PageName"]' },
				dataType: "json",
				async: false,
				success: await function (data, status, error) {

					$('#TxPartCode').empty();
					$('#TxPartCode').append('<option>-Select-</option>');
					$.each(data.partCode, function (key, val) {
						$('#TxPartCode').append('<option value="' + val.value + '">' + val.text + '</option>');
					});

					$("[id='TxItemCode']").empty();
					$("[id='TxItemCode']").append('<option>-Select-</option>');
					$.each(data.itemCode, function (key, val) {
						$("[id='TxItemCode']").append('<option value="' + val.value + '">' + val.text + '</option>');
					});

					$("[id='POItemCode']*").empty();
					$("[id='POItemCode']*").append('<option>-Select-</option>');
					$.each(data.itemCode, function (key, val) {
						$("[id='POItemCode']*").append('<option value="' + val.value + '">' + val.text + '</option>');
					});
				},
				error: function (req, status, error) {
					alert(error);
				}
			});
		}

		$('.PartialSave').click(function (e) {
			e.preventDefault();
			$('#TypeOfSave').val("PS");
			var poGrid = $('#divPOItemList tr td').length;
			var taxGrid = $('#divTaxGrid tr td').length;
			var txRowCount = $('#divTaxGrid tr').length;
			if ($('#POFor').val() != 'For Purchase(Sample)') {
				if (!checkPartCodeMusthaveAtLeastOneTax()) {
					return false;
				}
			}
			if (poGrid <= 1) {
				$.notify("PO Grid should at least have one item", "error");
				return;
			}
			else {
				if ($('#POFor').val() != 'For Purchase(Sample)') {
					if ($('#GSTRegistered').val() == "Y" || $('#OrderType').val() != "Domestic") {
						if (taxGrid >= 1) {
							for (var i = 1; i <= txRowCount; i++) {
								var txType = $('#txGridType-' + i).text();
								var txname = $('#txGridName-' + i).text();
								if (txType == '' || txname == '') {
									$.notify("TaxType Or TaxName cannot be null", "error");
									return;
								}
							}
						}
					}
					$("form").submit();
				}
				else {

					if (taxGrid <= 1) {
						$.notify("Tax Grid should at least have one item", "error");
						return;
					}
					else {
						if ($('#POFor').val() != 'For Purchase(Sample)') {
							for (var i = 1; i <= txRowCount; i++) {
								var txType = $('#txGridType-' + i).text();
								var txname = $('#txGridName-' + i).text();
								if (txType == '' || txname == '') {
									$.notify("TaxType Or TaxName cannot be null", "error");
									return;
								}
							}
						}
					}
				}
			}
			if (taxGrid >= 1) {
				for (var i = 1; i <= txRowCount; i++) {
					var txType = $('#txGridType-' + i).text();
					var txname = $('#txGridName-' + i).text();
					if (txType == '' || txname == '') {
						$.notify("TaxType Or TaxName cannot be null", "error");
						return;
					}
				}
			}
			$("form").submit();
		});


		function checkPartCodeMusthaveAtLeastOneTax() {
			var errorPartCode = [];
			$('.divPOItemListPartCode').each(function (i, data) {
				var partcode = $(data).text();
				var taxes = $("td[data-txPartCode='" + partcode + "']");
				if (!taxes || taxes.length == 0) {
					errorPartCode.push(partcode)
				}
			});
			if (errorPartCode.length > 0) {
				$.notify("No tax available for " + errorPartCode.join(", ") + " part code(s).", "error");
			}
			return errorPartCode.length == 0;
		}

		$('button[type="submit"]').click(function (e) {

			e.preventDefault();
			$('#TypeOfSave').val("NS");
			var poGrid = $('#divPOItemList tr td').length;
			var taxGrid = $('#divTaxGrid tr td').length;
			var txRowCount = $('#divTaxGrid tr').length;

			if ($('#AccountCode').find(':selected').data('gstregister') == "Y") {
				//do nothing
				for (var i = 1; i <= txRowCount; i++) {
					var txType = $('#txGridType-' + i).text();
					var txname = $('#txGridName-' + i).text();
					if (txType == '' || txname == '') {
						$.notify("TaxType Or TaxName cannot be null", "error");
						return false;
					}
				}
				if ($('#POFor').val() != 'For Purchase(Sample)') {
					if (!checkPartCodeMusthaveAtLeastOneTax()) {
						return false;
					}
				}
			}



			if (poGrid <= 1) {
				$.notify("PO Grid should at least have one item", "error");
				return;
			}
			if ($('#ItemsForDepartment').prop('selectedIndex') != 0) {
				if ($('#ResposibleEmplforQC').prop('selectedIndex') == 0) {
					$.notify("Please select Responsible Emp for QC", "error");
					$('#ResposibleEmplforQC').css('border', '1px solid red');
					return;
				}
			}
			else {
				if ($('#POFor').val() != 'For Purchase(Sample)') {
					if ($('#AccountCode').find(':selected').data('gstregister') == "Y" || $('#OrderType').val() != "Domestic") {
						if (taxGrid >= 1) {
							for (var i = 1; i <= txRowCount; i++) {
								var txType = $('#txGridType-' + i).text();
								var txname = $('#txGridName-' + i).text();
								if (txType == '' || txname == '') {
									$.notify("TaxType Or TaxName cannot be null", "error");
									return;
								}
							}
						} else if ($('#ItemsForDepartment').val() == "3") {
							if ($('#ResposibleEmplforQC').val() == '') {
								$.notify("Responsible employee for QC is required", "error");
								return;
							}
						}


						$("form").submit();
					}
					else {

						// $('#GSTRegistered').val()
						if ($('#AccountCode').find(':selected').data('gstregister') == "Y") {
							if (taxGrid <= 1) {
								$.notify("Tax Grid should at least have one item", "error");
								return;
							}
						} else if ($('#ItemsForDepartment').val() == "3") {
							if ($('#ResposibleEmplforQC').val() == '') {
								$.notify("Responsible employee for QC is required", "error");
								return;
							}
						}

					}
				}
			}

			$("form").submit();


		});

		$('#submitBTN').click(function () {
			$('#TypeOfSave').val("NS");

			var poGrid = $('#divPOItemList tr td').length;
			var taxGrid = $('#divTaxGrid tr td').length;
			var txRowCount = $('#divTaxGrid tr').length;

			// GST Registered Vendor
			if ($('#AccountCode').find(':selected').data('gstregister') == 'Y') {
				if ($('#POFor').val() != 'For Purchase(Sample)') {
					if (!checkPartCodeMusthaveAtLeastOneTax()) {
						return false;
					}
				}

				if (poGrid <= 1) {
					$.notify("PO Grid should at least have one item", "error");
					return;
				}

				if ($('#POFor').val() != 'For Purchase(Sample)') {
					if (taxGrid <= 1) {
						$.notify("Tax Grid should at least have one item", "error");
						return;
					}
				}

				if ($('#ItemsForDepartment').val() == "3" && $('#ResposibleEmplforQC').val() == '') {
					$.notify("Responsible employee for QC is required", "error");
					return;
				}

				if ($('#AccountCode').val() == '0') {
					$.notify("Vendor Name is required", "error");
					return;
				}

				// Extra validation for "not sample"
				if ($('#POFor').val() != 'For Purchase(Sample)') {
					for (var i = 1; i <= txRowCount; i++) {
						var txType = $('#txGridType-' + i).text();
						var txname = $('#txGridName-' + i).text();
						if (txType == '' || txname == '') {
							$.notify("TaxType Or TaxName cannot be null", "error");
							return;
						}
					}
				}

				// Everything valid, submit
				$("form").submit();
			}
			// Non-GST Registered Vendor
			else {
				if (poGrid <= 1) {
					$.notify("PO Grid should at least have one item", "error");
					return;
				}

				if ($('#AccountCode').val() == '0') {
					$.notify("Vendor Name is required", "error");
					return;
				}

				if ($('#ItemsForDepartment').val() == "3" && $('#ResposibleEmplforQC').val() == '') {
					$.notify("Responsible employee for QC is required", "error");
					return;
				}

				// Everything valid, submit
				$("form").submit();
			}
		});

		$('#UpdateButton').click(function () {
			$('#TypeOfSave').val("NS");

			var poGrid = $('#divPOItemList tr td').length;
			var taxGrid = $('#divTaxGrid tr td').length;
			var txRowCount = $('#divTaxGrid tr').length;
			// for (var i = 1; i <= txRowCount; i++) {
			//     var txType = $('#txGridType-' + i).text();
			//     var txname = $('#txGridName-' + i).text();
			//     if (txType == '' || txname == '') {
			//         $.notify("TaxType Or TaxName cannot be null", "error");
			//         return;
			//     }
			// }

			if ($('#AccountCode').find(':selected').data('gstregister') == 'Y') {
				if ($('#POFor').val() != 'For Purchase(Sample)') {
					if (!checkPartCodeMusthaveAtLeastOneTax()) {
						return false;
					}
				}
				else if (poGrid <= 1) {
					$.notify("PO Grid should at least have one item", "error");
					return;
				}
				else if ($('#ItemsForDepartment').val() == "3") {
					if ($('#ResposibleEmplforQC').val() == '') {
						$.notify("Responsible employee for QC is required", "error");
						return;
					}
				}
				else if (taxGrid <= 1) {
					$.notify("Tax Grid should at least have one item", "error");
					return;
				}
				else if ($('#AccountCode').val() == '0') {
					$.notify("Vendor Name is required", "error");
				}
				else {
					if ($('#POFor').val() != 'For Purchase(Sample)') {
						for (var i = 1; i <= txRowCount; i++) {
							var txType = $('#txGridType-' + i).text();
							var txname = $('#txGridName-' + i).text();
							if (txType == '' || txname == '') {
								$.notify("TaxType Or TaxName cannot be null", "error");
								return;
							}
							else {
								$("form").submit();
							}
						}
					}
				}
			}
			else {
				if (poGrid <= 1) {
					$.notify("PO Grid should at least have one item", "error");
					return;
				}
				else if ($('#ItemsForDepartment').val() == "3") {
					if ($('#ResposibleEmplforQC').val() == '') {
						$.notify("Responsible employee for QC is required", "error");
						return;
					}
				}
				else if ($('#AccountCode').val() == '0') {
					$.notify("Vendor Name is required", "error");
				}
				else {
					$("form").submit();

				}
			}
		});



		$('.GridMultiItemBtn').click(function (e) {
			e.preventDefault();
			var CheckboxArr = [];
			var RowCount = $('#MultiItemBody tr').length;

			for (var i = 0; i <= RowCount; i++) {
				if ($('#MBCheckbox-' + i).prop("checked")) {
					CheckboxArr.push(i);
				}
			}

			if (CheckboxArr.length === 0) {
				$.notify('Please select any item.', 'error');
			} else {


				var RowCount = $('#MultiItemBody tr').length;
				for (var i = 0; i < RowCount; i++) {
					if ($('#MBCheckbox-' + i).prop("checked")) {
						if ($('#POQty-' + i).val() == 0) {
							$.notify('Please enter quantity for ' + $('#PartText-' + i).val(), 'error');
							return;
						}
						if ($('#Rate-' + i).val() == 0) {
							$.notify('Please enter rate for ' + $('#PartText-' + i).val(), 'error');
							return;
						}
						// if ($('#Unit-' + i).val() == '') {
						// 	$.notify('Please select unit for ' + $('#PartText-' + i).val(), 'error');
						// 	return;
						// }
						// if ($('#HSNNo-' + i).val() == '') {
						// 	$.notify('Please enter HSN for ' + $('#PartText-' + i).val(), 'error');
						// 	return;
						// }
						if ($('#Amount-' + i).val() == '') {
							$.notify('amount can not be 0 ' + $('#PartText-' + i).val(), 'error');
							return;
						}




					}
				}
				var ArrMultiBatch = [];
				for (var i = 0; i < RowCount; i++) {
					if ($('#MBCheckbox-' + i).prop("checked")) {

						ArrMultiBatch.push({
							'PartCode': $('#ItemCode-' + i).val(),
							'PartText': $('#PartText-' + i).val(),

							'ItemCode': $('#ItemCode-' + i).val(),
							'ItemText': $('#ItemText-' + i).val(),
							'HSNNo': $('#HSNNo-' + i).val(),
							'AdditionalRate': $('#AdditionalRate-' + i).val(),
							'AltPendQty': $('#AltPendQty-' + i).val(),
							'AltPOQty': $('#AltPOQty-' + i).val(),
							'AltUnit': $('#AltUnit-' + i).val(),
							'AmendmentDate': $('#AmendmentDate-' + i).val(),
							'AmendmentNo': $('#AmendmentNo-' + i).val(),
							'AmendmentReason': $('#AmendmentReason-' + i).val(),
							'Amount': $('#Amount-' + i).val(),
							'Color': $('#Color-' + i).val(),
							'CostCenter': $('#CostCenter-' + i).val(),
							'Description': $('#Description-' + i).val(),
							'DiscPer': $('#DiscPer-' + i).val(),
							'DiscRs': $('#DiscRs-' + i).val(),
							'FirstMonthTentQty': $('#FirstMonthTentQty-' + i).val(),
							'ItemNetAmount': $('#ItemNetAmount-' + i).val(),
							'OldRate': $('#OldRate-' + i).val(),
							'OtherRateCurr': $('#OtherRateCurr-' + i).val(),
							'PendQty': $('#PendQty-' + i).val(),
							'PIRemark': $('#Remark-' + i).val(),
							'PkgStd': $('#PkgStd-' + i).val(),
							'POQty': $('#POQty-' + i).val(),
							'Process': $('#Process-' + i).val(),
							'Rate': $('#Rate-' + i).val(),
							'SecMonthTentQty': $('#SecMonthTentQty-' + i).val(),
							'SizeDetail': $('#SizeDetail-' + i).val(),
							'TolLimitPercent': $('#TolLimitPercent-' + i).val(),
							'TolLimitQty': $('#TolLimitQty-' + i).val(),
							'Unit': $('#Unit-' + i).val(),
							'UnitRate': $('#UnitRate-' + i).val(),

							'Mode': $('#Mode').val() == "U" ? "U" : "INSERT",

							'AmendmentNo': $('#AmmNo-' + i).val(),
							'AmendmentDate': $('#AmmDate-' + i).val(),
							'DeliveryDate': $('#DeliveryDate-' + i).val(),
							'VehicleNo': $('#VehicleNo-' + i).val(),
							'ItemGroupName': $('#ItemGroupName-' + i).val(),
							'ItemLocation': $('#ItemLocation-' + i).val(),
							'TotalStock': $('#Balance-' + i).val(),

							'SeqNo': $('#SeqNo-' + i).val(),
						});


						
					}
				}
				console.log(ArrMultiBatch);
				$.ajax({
					type: "POST",
					url: '@Url.Action("AddMultipleItemDetail")',
					data: { "model": ArrMultiBatch },
					statusCode: {
						207: function () {
							$.notify('Duplicate Item...!', "info");
						}
					},
					success: function (result, status, xhr) {
						if (xhr.status == 200 && xhr.responseText == result) {


							$('#divPOItemList').html(result);
							$('#SaleOrderGroupWiseItem').modal('hide');
							$.notify('Item Added To Grid.', "success");
							ClearItem();
					GetFeaturesOptions();
						
						$('#TotalRoundOff').prop('selectedIndex', 0);
						var INA = parseFloat($('#ItemNetAmount').val());
						var rowCount = $('#divPOItemList tr').length;
						var columnCount = $('#divPOItemList tr td').length;
						var taxRowCount = $('#divTaxGrid tr').length;
						var sum = 0;
						var TotalQty = 0;

						//noofitems
						if (columnCount > 1)
							$('#lblItemCount').text(rowCount);
						else
							$('#lblItemCount').text(0);

						let rowsExist = $(".GridAmount").length > 0;
						let rowsQtyExist = $(".GridQty").length > 0;

						if (rowsExist) {
							$(".GridAmount").each(function () {
								let value = parseFloat($(this).text());
								sum += isNaN(value) ? 0 : value;
							});
						} else {
							sum = 0;
						}
						if (rowsQtyExist) {
							$(".GridQty").each(function () {
								let value = parseFloat($(this).text());
								TotalQty += isNaN(value) ? 0 : value;
							});
						} else {
							TotalQty = 0;
						}
						$('#ItemNetAmount').val(sum);
						var txSum = 0;
						if ($('#divTaxGrid tr td').length > 1) {
							for (var i = 1; i <= taxRowCount; i++) {
								txSum += parseFloat($('#txGridAmount-' + i).text() == '.00' ? 0 : $('#txGridAmount-' + i).text());
							}
						}
						$('#lblItemNetAmount').text(sum.toFixed(2));
						$('#lblTotalQty').text(TotalQty.toFixed(2));


						var txTotal = sum + txSum;
						$('#NetTotal').val(txTotal.toFixed(2));
						// $('#TotalDiscountPercentage').val(0);
						// $('#TotalAmtAftrDiscount').val(0);
						$('#PartCodeText').focus().autocomplete("search", $('#PartCodeText').val());


						}
					},
					error: function (result, status, xhr) {
						$.notify('Something Went Wrong, Please Try Again.', "error");
					}
				}).done(function () {

					GetTaxPartItem();
				});
			}
		});




		


		$('.ItemBtn').click(function () {
						EditEachItem = false;
			// $("#PartCode").next(".select2-container").find(".select2-selection").focus();
			// $('#PartCode').css("border", "1px solid black");
			$("#PartCodeText").focus();
			$('#PartCodeText').css("border", "1px solid black");
			let IsError = 0;

		//	$(this).html('Calculating... <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>').prop("disabled", true);
				if ($('#PartCodeText').val().trim() === "" || $('#PartCode').val().trim() === "") {
			AddErrorCls('PartCodeText');
			IsError = 1;
		} else {
			RemoveErrorCls('PartCodeText');
		}
			if ($('#POFor').val() == 0) {
				AddErrorCls('POFor');
				IsError = 1;
			}
			else {
				RemoveErrorCls('POFor');
			}
			if ($('#AccountCode').val() == 0 || $('#AccountCode').val() == null) {
				$.notify("Account Code is required", "error");
				AddErrorCls('AccountCode');
				IsError = 1;
			}
			else {
				RemoveErrorCls('AccountCode');
			}
			if ($('#AccountCodeText').val() == 0 || $('#AccountCodeText').val() == null || $('#AccountCodeText').val() == '') {
				$.notify("Account Code is required", "error");
				AddErrorCls('AccountCode');
				IsError = 1;
			}
			else {
				RemoveErrorCls('AccountCode');
			}

			if ($('#POType').val() == "Close" && parseFloat($('#POQty').val()) <= 0) {
				AddErrorCls('POQty');
				$.notify('PoQty is required...!', "error");
				IsError = 1;
			}
			else {
				RemoveErrorCls('POQty');
			}

			if ($('#OrderType').val() === 'Domestic') {
				if ($('#Rate').val() == "" || parseFloat($('#Rate').val()) <= 0) {
					AddErrorCls('Rate');
					$.notify('Rate is required...!', "error");
					IsError = 1;
				}
				else {
					RemoveErrorCls('Rate');
				}
			}
			if (($('#Mode').val() == 'POA' ) && @Model.ID > 0) {
				if (!$('#AmendmentReason').val()) {
					AddErrorCls('AmendmentReason');
					$.notify('AmendmentReason is required...!', "error");
					IsError = 1;
				}
				else {
					RemoveErrorCls('AmendmentReason');
				}
			}
			if ($('#OrderType').val() === 'Import') {
				if ($('#OtherRateCurr').val() == "" || parseFloat($('#OtherRateCurr').val()) <= 0) {
					AddErrorCls('OtherRateCurr');
					$.notify('OtherRateCurr is required...!', "error");
					IsError = 1;
				}
				else {
					RemoveErrorCls('OtherRateCurr');
				}
			}

			if (parseInt($('#DiscPer').val()) < 0 || parseInt($('#DiscPer').val()) > 100) {
				AddErrorCls('DiscPer');
				$.notify('DiscPer is required...!', "error");
				IsError = 1;
			}
			else {
				RemoveErrorCls('DiscPer');
			}

			if (IsError == 1) {
				$('.ItemBtn').html('<span role="status"><i class="fa-solid fa-angles-down fa-fw fa-lg"></i> ADD TO GRID</span>').prop("disabled", false);
				return;
			}
			else {
				var ItemData = {
					'PartCode': $('#PartCode').val(),
					'PartText': $('#PartCodeText').val(),
					'ItemCode': $('#ItemCode').val(),
					'ItemText': $('#ItemNameText').val(),
					'HSNNo': $('#HSNNo').val(),
					'AdditionalRate': $('#AdditionalRate').val(),
					'AltPendQty': $('#AltPendQty').val(),
					'AltPOQty': $('#AltPOQty').val(),
					'AltUnit': $('#AltUnit').val(),
					'AmendmentDate': $('#AmendmentDate').val(),
					'AmendmentNo': $('#AmendmentNo').val(),
					'AmendmentReason': $('#AmendmentReason').val(),
					'Amount': $('#Amount').val(),
					'Color': $('#Color').val(),
					'CostCenter': $('#CostCenter').val(),
					'Description': $('#Description').val(),
					'DiscPer': $('#DiscPer').val(),
					'DiscRs': $('#DiscRs').val(),
					'FirstMonthTentQty': $('#FirstMonthTentQty').val(),
					'ItemNetAmount': $('#ItemNetAmount').val(),
					'OldRate': $('#OldRate').val(),
					'OtherRateCurr': $('#OtherRateCurr').val(),
					'PendQty': $('#PendQty').val(),
					'PIRemark': $('#Remark').val(),
					'PkgStd': $('#PkgStd').val(),
					'POQty': $('#POQty').val(),
					'Process': $('#Process').val(),
					'Rate': $('#Rate').val(),
					'SecMonthTentQty': $('#SecMonthTentQty').val(),
					'SizeDetail': $('#SizeDetail').val(),
					'TolLimitPercent': $('#TolLimitPercent').val(),
					'TolLimitQty': $('#TolLimitQty').val(),
					'Unit': $('#Unit').val(),
					'UnitRate': $('#UnitRate').val(),
					'Mode': $('#Mode').val() == "U" ? "U" : "INSERT",
					'AmendmentNo': $('#AmmNo').val(),
					'AmendmentDate': $('#AmmDate').val(),
					'DeliveryDate': $('#DeliveryDate').val(),
					'VehicleNo': $('#VehicleNo').val(),
					'ItemGroupName': $('#ItemGroupName').val(),
					'ItemLocation': $('#ItemLocation').val(),
					'SeqNo': $('#SeqNo').val(),
					'StoreName' : $('#Storeid1 option:selected').text(),
					'StoreId' : $('#Storeid1').val(),
					'TotalStock':$('#TotalStock').val(),
					'WcId': $('#WcId').val(),
					'WorkCenter': $('#WorkCenter option:selected').text(),

					'WorkStock': $('#WorkStock').val()
				}

				$.ajax({
					url: '@Url.Action("AddItem2Grid")',
					type: "POST",
					data: ItemData,
					async: false,
					beforeSend: function (xhr) {
						//xhr.overrideMimeType( "text/plain; charset=x-user-defined" );
					},
					success: function (data, status, xhr) {
						if (xhr.status === 208 && xhr.responseText === 'Duplicate Item') {
							$.notify('Duplicate Item Not Allowed.', "info");
							$('.ItemBtn').html('<span role="status"><i class="fa-solid fa-angles-down fa-fw fa-lg"></i> ADD TO GRID</span>').prop("disabled", false);
						}
						else if (xhr.status == 205 && xhr.responseText == 'Reset Tax Detail') {
							$.notify('Adding Item Not Allowed, Please Clear Tax Detail...!!!', "info");
						}
						else {
							if (!DelSeqNo && DelSeqNo != 0) {
								$('#divPOItemList ."' + DelSeqNo + "'").remove();
							}
							$('#divPOItemList').html(data);
							$.notify('Item Added To Grid.', "success");
							ClearItem();
							GetFeaturesOptions();
						}
						$('#TotalRoundOff').prop('selectedIndex', 0);
						var INA = parseFloat($('#ItemNetAmount').val());
						var rowCount = $('#divPOItemList tr').length;
						var columnCount = $('#divPOItemList tr td').length;
						var taxRowCount = $('#divTaxGrid tr').length;
						var sum = 0;
						var TotalQty = 0;

						//noofitems
						if (columnCount > 1)
							$('#lblItemCount').text(rowCount);
						else
							$('#lblItemCount').text(0);

						let rowsExist = $(".GridAmount").length > 0;
						let rowsQtyExist = $(".GridQty").length > 0;

						if (rowsExist) {
							$(".GridAmount").each(function () {
								let value = parseFloat($(this).text());
								sum += isNaN(value) ? 0 : value;
							});
						} else {
							sum = 0;
						}
						if (rowsQtyExist) {
							$(".GridQty").each(function () {
								let value = parseFloat($(this).text());
								TotalQty += isNaN(value) ? 0 : value;
							});
						} else {
							TotalQty = 0;
						}
						$('#ItemNetAmount').val(sum);
						var txSum = 0;
						if ($('#divTaxGrid tr td').length > 1) {
							for (var i = 1; i <= taxRowCount; i++) {
								txSum += parseFloat($('#txGridAmount-' + i).text() == '.00' ? 0 : $('#txGridAmount-' + i).text());
							}
						}
						$('#lblItemNetAmount').text(sum.toFixed(2));
						$('#lblTotalQty').text(TotalQty.toFixed(2));


						var txTotal = sum + txSum;
						$('#NetTotal').val(txTotal.toFixed(2));
						// $('#TotalDiscountPercentage').val(0);
						// $('#TotalAmtAftrDiscount').val(0);
						$('#PartCodeText').focus().autocomplete("search", $('#PartCodeText').val());

						//$('#PartCode').select2('open').select2('focus');
					},
					error: function (result, status, xhr) {
						$.notify(result.responseText, "error");
					},
					failure: function (result, status, xhr) {
						alert(response.responseText);
					},
					complete: function () {
						$('.Schedule').fadeIn();
						$('.ItemBtn').html('<span role="status"><i class="fa-solid fa-angles-down fa-fw fa-lg"></i> ADD TO GRID</span>').prop("disabled", false);
					}
				}).done(function () {
					GetTaxPartItem();
				}).fail(function () {
					alert("error");;
				}).always(function () {
				});
			}
		});

		var isEditAllowed = "false";
				  var EditEachItem = false;
		async function EditItemRow(SeqNo) {
							  var RowCount = $('#divPOItemList tr').length;
						if (EditEachItem) {
							$.notify('Cannot Edit item while AddtoGrid  Existing Item!!!', "error");
								 $('#editButton-' + RowCount).prop("disabled", true);
						}
						else {
			var PartCode = $('#PartCode').val();
			$.ajax({
				url: '@Url.Action("EditItemRow")',
				type: "POST",
				data: { PartCode: PartCode, SeqNo: SeqNo },
				async: false,
				success: await function (data, status, xhr) {
						
					if (data === "Duplicate" && (xhr.statusCode === 207 || xhr.responseText === "Duplicate")) {
						$.notify("If Same Tax Exists, Item Cannot Be Edited...!", "warning");
					}
					else {
						;
						var obj = $.parseJSON(data);
						DeleteItemRow(SeqNo);
						if (isEditAllowed == "false") {
							return false;
						}
						else {

							if (obj != null && obj.length == 1) {
											  EditEachItem = true;
								// $('#PartCode').val(obj[0].PartCode).trigger('change');
								// $('#ItemCode').val(obj[0].ItemCode).trigger('change');
									$('#PartCode').val(obj[0].PartCode);
								$('#ItemCode').val(obj[0].ItemCode);
								 $('#PartCodeText').val(obj[0].PartText);
								$('#ItemNameText').val(obj[0].ItemText);
							
								$('#HSNNo').val(obj[0].HSNNo);
								$('#AdditionalRate').val(obj[0].AdditionalRate);
								$('#AltPendQty').val(obj[0].AltPendQty);
								$('#AltPOQty').val(obj[0].AltPOQty);
								$('#AltUnit').val(obj[0].AltUnit);
								$('#AmendmentDate').val(obj[0].AmendmentDate);
								$('#AmendmentNo').val(obj[0].AmendmentNo);
								$('#AmendmentReason').val(obj[0].AmendmentReason);
								$('#Amount').val(obj[0].Amount);
								$('#Color').val(obj[0].Color);
								$('#CostCenter').val(obj[0].CostCenter);
								$('#Description').val(obj[0].Description);
								$('#DiscPer').val(obj[0].DiscPer);
								$('#DiscRs').val(obj[0].DiscRs);
								$('#FirstMonthTentQty').val(obj[0].FirstMonthTentQty);
								$('#ItemNetAmount').val(obj[0].ItemNetAmount);
								$('#OldRate').val(obj[0].OldRate);
								$('#OtherRateCurr').val(obj[0].OtherRateCurr);
								$('#PendQty').val(obj[0].PendQty);
								$('#Remark').val(obj[0].PIRemark);
								$('#PkgStd').val(obj[0].PkgStd);
								$('#POQty').val(obj[0].POQty);
								$('#Process').val(obj[0].Process);
								$('#Rate').val(obj[0].Rate);
								$('#SecMonthTentQty').val(obj[0].SecMonthTentQty);
								$('#SizeDetail').val(obj[0].SizeDetail);
								$('#TolLimitPercent').val(obj[0].TolLimitPercent);
								$('#TolLimitQty').val(obj[0].TolLimitQty);
								$('#Unit').val(obj[0].Unit);
								$('#SeqNo').val(obj[0].SeqNo);
								$('#UnitRate').val(obj[0].UnitRate);
								$('#DeliveryDate').val(obj[0].DeliveryDate);
								$('#ItemLocation').val(obj[0].ItemLocation);
								$('#VehicleNo').val(obj[0].VehicleNo);
								$('#ItemGroupName').val(obj[0].ItemGroupName);
								$('#StoreId').val(obj[0].StoreId);
								$('#StoreName').val(obj[0].StoreName);
								$('#TotalStock').val(obj[0].TotalStock);
								$('#WcId').val(obj[0].WcId);         
								$('#WcId').val(obj[0].WorkCenter);   
								$('#WorkStock').val(obj[0].WorkStock);
								if ($('#Mode').val() == "POA") {
									actualRate = $('#Rate').val();
								}
							}
						}
					}
				},
				error: function (response) {
					$.notify(response.responseText, "error");
				},
				failure: function (response) {
					$.notify(response.responseText, "error");
				}
			});
			}
		}

		$('#AccountCode').change(function () {

			btnClearTax();
			GetTaxPartItem();


		});

		$('.btnClearTax').click(function () {

			// btnClearTax();
			var NoData = '<tr class="text-center"><td colspan="32" class="text-black-50"><strong>NO DATA ADDED</strong></td></tr>';
			$('#divTaxGrid').html(NoData);

		});
		function btnClearTax() {
			$.ajax({
				type: "POST",
				url: "@Url.Action("ClearTaxGrid")",
				data: { YearCode: $('#YearCode').val() },
				dataType: "json",
				async: false,
				success: function (result, status, error) {
					$('#divTaxGrid').empty();
					var NoData = '<tr class="text-center"><td colspan="32" class="text-black-50"><strong>NO DATA ADDED</strong></td></tr>';
					$('#divTaxGrid').html(NoData);
					var txAmt = $('#lblItemNetAmount').text();
					$('#NetTotal').val(txAmt);
				},
				error: function (req, status, error) {
					alert(error);
				}
			});
		}

		function DeleteItemRow(SeqNo) {
			$.ajax({
				url: '@Url.Action("DeleteItemRow")',
				type: "POST",
				data: { "SeqNo": SeqNo },
				async: false,
				success: function (data, status, xhr) {
					if (data === "Duplicate" && (xhr.statusCode === 207 || xhr.responseText === "Duplicate")) {
						;
						$.notify("If Tax Exists, Item Cannot Be Deleted/Edited...!", "warning");
						isEditAllowed = "false";
					}
					else {

						$('#divPOItemList').html(data);
						GetFeaturesOptions();
						if ($('#divPOItemList').children('tr').length === 0) {
							$('.Schedule').fadeOut();
							var NoData = '<tr class="text-center"><td colspan="32" class="text-black-50"><strong>NO DATA ADDED</strong></td></tr>';
							$('#lblItemNetAmount').text("0.00");
							$('#divPOItemList').html(NoData);
						}
						GetTaxPartItem();
						$('#lblItemNetAmount').text($('#ItemNetAmount').val());
						$('#TotalRoundOff').prop('selectedIndex', 0);
						//var INA = parseFloat($('#ItemNetAmount').val());
						var rowCount = $('#divPOItemList tr').length;
						var rowCountGrid = $('#divPOItemList tr td').length;
						var taxRowCount = $('#divTaxGrid tr').length;
						var taxRowCountGrid = $('#divTaxGrid tr td').length;
						var sum = 0;
						var TotalQty = 0;
						var txSum = 0;
						var columnCount = $('#divPOItemList tr td').length;

						//noofitems
						if (columnCount > 1)
							$('#lblItemCount').text(rowCount);
						else
							$('#lblItemCount').text(0);

						// if (rowCountGrid > 1) {
						// 	for (var i = 1; i <= rowCount; i++) {
						// 		sum += parseFloat($('#GridAmount-' + i).text() == '.00' ? 0 : $('#GridAmount-' + i).text());
						// 	}

						// }
						// else {
						// 	sum = 0;
						// }

						
						let rowsExist = $(".GridAmount").length > 0;
						let rowsQtyExist = $(".GridQty").length > 0;

						if (rowsExist) {
							$(".GridAmount").each(function () {
								let value = parseFloat($(this).text());
								sum += isNaN(value) ? 0 : value;
							});
						} else {
							sum = 0;
						}

						if (rowsQtyExist) {
							$(".GridQty").each(function () {
								let value = parseFloat($(this).text());
								TotalQty += isNaN(value) ? 0 : value;
							});
						} else {
							TotalQty = 0;
						}
						if (taxRowCountGrid > 1) {

							if ($('#divTaxGrid tr td').length > 1) {
								for (var i = 1; i <= taxRowCount; i++) {
									txSum += parseFloat($('#txGridAmount-' + i).text() == '.00' ? 0 : $('#txGridAmount-' + i).text());
								}
							}
						}
						else {
							txSum = 0;
						}
						$('#ItemNetAmount').val(sum);
						$('#lblItemNetAmount').text(sum.toFixed(2));
						$('#lblTotalQty').text(TotalQty.toFixed(2));
						var txTotal = sum + txSum;
						$('#NetTotal').val(txTotal.toFixed(2));
						// $('#TotalDiscountPercentage').val(0);
						// $('#TotalAmtAftrDiscount').val(0);
						$.notify('Item Deleted From Grid.', "success");
						isEditAllowed = "true";
					}
				},
				error: function (response, status, xhr) {
					$.notify(response.responseText, "error");
				},
				failure: function (response, status, xhr) {
					$.notify(response.responseText, "error");
				}
			});
		}


		function ClearItem() {
					$('#PartCodeText').val('').removeClass('is-invalid'),	$('#PartCode').val('').change(),$('#ItemNameText').val('').removeClass('is-invalid'),$('#ItemCode').val('').change(), $('#HSNNo').val('0'), $('#POQty').val('0'), $('#Rate').val('0.00'), $('#Unit').val('0.00'), $('#AltPOQty').val(0),
				$('#AltUnit').val('NA'), $('#OtherRateCurr').val('0'), $('#UnitRate').val('Unit'), $('#DiscPer').val('0'), $('#DiscRs').val('0.00'), $('#Amount').val('0.00'), $('#TolLimit').val(0),
				$('#Remark').val(''), $('#Description').val(''), $('#StoreName').prop('selectedIndex', 0), $('#SizeDetail').val('0'), $('#AmendmentNo').val('0'), $('#AmendmentDate').val(''),
				$('#AmendmentReason').val(''), $('#Color').val(''), $('#Process').prop('selectedIndex', 0).removeClass('is-invalid'), $('#TolLimitQty').val('0.00'), $('#TolLimitPercent').val('0.00'),
				$('#OldRate').val('0.00'), $('#AdditionalRate').val('0.00'), $('#FirstMonthTentQty').val('0.00'), $('#SecMonthTentQty').val('0.00'), $('#CostCenter').prop('selectedIndex', 0) , $('#VehicleNo').val(''),
				$('#ItemGroupName').val(''), $('#ItemLocation').val(''), $('#SeqNo').val('0'), $('#WorkStock').val('0'),$('#TotalStock').val('0');
		}


		$('#Rate').keyup(function () {
			$('#OtherRateCurr').val($(this).val());
		});

		$(document).keyup(function (e) {
			if (e.altKey && e.keyCode === 83) {
				e.preventDefault();
				$('.PartialSave').trigger("click");
			}
		});
		//        document.addEventListener('keydown', function(event) {
		//  if (event.altKey && event.keyCode === 83) {
		//    event.preventDefault(); // Prevent the default behavior of the event (e.g., opening browser menu)
		//    // Perform your desired actions here
		//    console.log("ALT + S captured");
		//  }
		//});

		function addDays(date, days) {
			var NewDate = new Date(date);
			NewDate.setDate(NewDate.getDate() + days);
			return NewDate.toISOString().substring(0, 10);
		}


		function ScheduleQty() {
			var Sum = 0;
			$(".Qty").each(function () {
				Sum += parseFloat($(this).text());
			});
			return Sum;
		}


		$('#DQty').on('keyup keypress blur change', function (e) {
			const TQty = parseInt($('#DTQty').val());
			const DQty = parseInt($('#DQty').val());

			const SQty = ScheduleQty();

			const Total = TQty - (DQty + SQty);

			if (Total == 0 && DQty + SQty == TQty) {
				$('.addSchedule').prop('disabled', false).removeAttr('readonly');
			}
			else if (Total >= 0) {
				$('.addSchedule').prop('disabled', false).removeAttr('readonly');
			}
			else if (Total <= 0) {
				$('.addSchedule').prop('disabled', true).attr('readonly', 'readonly');
			}
		});


		$('.addSchedule').click(function (e) {
			e.preventDefault();
			const _DDays = parseInt($('#DDays').val().trim());
			const _DDate = new Date();
			const date = addDays(_DDate, _DDays);

			const TQty = !$('#DTQty').val() ? 0 : parseInt($('#DTQty').val());
			const CQty = !$('#DQty').val() ? 0 : parseInt($('#DQty').val());

			if (CQty <= 0) {
				return;
			}

			const Sum = ScheduleQty();

			const Total = TQty - (CQty + Sum);

			if (Total == 0) {
				$('.addSchedule').prop('disabled', true).attr('readonly', 'readonly');
			}
			else if (Total >= 0) {
				$('.addSchedule').prop('disabled', false).removeAttr('readonly');
			}
			else if (Total <= 0) {
				$('.addSchedule').prop('disabled', true).attr('readonly', 'readonly');
			}

			var Data = {
				"DPartCode": $('#POItemCode').val(),
				"Days": _DDays,
				"Date": date,
				"Qty": parseInt($('#DQty').val().trim()),
				"AltQty": parseInt($('#DAltQty').val().trim()),
				"Remarks": $('#DRemark').val(),
			}

			$.ajax({
				type: "POST",
				url: '@Url.Action("AddSchedule")',
				data: Data,
				async: false,
				success: function (resp, status, error) {
					if (resp) {
						$('#POGrid').html(resp);
						$('#DDate').val(date);

						$('#DQty').val(Total <= 0 ? 0 : Total);
						$('#DQty').change();
					}
				},
				error: function (req, status, error) {
					alert(error);
				}
			});
		});


		$('.Schedule').click(function () {
			$('.modal-header').addClass('bg-graident bg-warning');
			$('.modal-title').text('DELIVERY SCHEDULE');
			$('#DTQty').val();
			//$('#DDate').val(new Date().toISOString().substring(0, 10));
			$('#DDate').datepicker({ dateFormat: 'dd/mm/yy' }).datepicker("setDate", 'now');
			$('#PopupModel').modal("show");
		});

		$('.pnl1BG').on("keydown", function (event) {
			if (event.key === "Tab") {
				if ($('.pnl1BG').attr('aria-expanded')) {
					//$('#PartCode').select2('open').select2('focus');
					$('#PartCodeText').focus().autocomplete('search', '');

					event.preventDefault();
				}
			}
		});

		function RefreshSchedule(ID) {
			if (!ID) $('#POItemCode').prop('selectedIndex', 0).change();
			else {
				_PCode = parseInt($('#' + ID).val());
				$.ajax({
					type: "POST",
					url: "@Url.Action("RefreshSchedule")",
					data: { PCode: _PCode, Typ: "SchVal" },
					success: function (data, status, error) {
						$('#DTQty').val(data.schVal.Qty);
						$('#DQty').val();
						$('#DAltQty').val(data.schVal.AltQty);
						$('#DRemark').val(data.schVal.Remark);
					},
					error: function (req, status, error) {
						alert(error);
					}
				}).done(function () {
					$.ajax({
						type: "POST",
						url: "@Url.Action("RefreshSchedule")",
						data: { PCode: _PCode },
						success: function (data, status, error) {
							$('#POGrid').html(data);
						},
						error: function (req, status, error) {
							alert(error);
						}
					});
				});
			}
		}
		$("#Storeid1").change(function () {
			GetTotalStockQty();
		});
		// Autocomplete for PartCodeText



				function FillStoreList() {
			$.ajax({
				type: "POST",
				url: "@Url.Action("GetStoreList", "NRGP")",
				dataType: "json",
				success: function (result, status, error) {

					if (result != null) {
						var obj = $.parseJSON(result);
						$('#Storeid1').empty();
						$('#Storeid1').append('<option value="0">-Select-</option>');

						$.each(obj.Result, function (key, val) {
							$('#Storeid1').append('<option value="' + val.entryid + '" data-type="' + val.Store_Type + '">' + val.store_name + '</option>');
						});
					}

					// check AllowToChangeStore
					if ($('#AllowToChangeStore').val() == "N") {
						// find store where store_type is "Main Store"
						var mainStore = $("#Storeid option[data-type='MAIN STORE']").val();

						if (mainStore) {
							$("#Storeid1").val(mainStore);   // set selected
							$("#Storeid1").prop("disabled", true); // make dropdown readonly
						}
					}
				}
			});
		}


		function FillStoreList1() {
			$.ajax({
				type: "POST",
				url: "@Url.Action("GetStoreList", "NRGP")",
				dataType: "json",
				success: function (result, status, error) {

					if (result != null) {
						var obj = $.parseJSON(result);
						$('#Storeid1').empty();
						// $('#Storeid').append('<option value="0">-Select-</option>');

						$.each(obj.Result, function (key, val) {
							$('#Storeid1').append('<option value="' + val.entryid + '" data-type="' + val.Store_Type + '">' + val.store_name + '</option>');
						});
					}

					// check AllowToChangeStore
					if ($('#AllowToChangeStore').val() == "N") {
						// find store where store_type is "Main Store"
						var mainStore = $("#Storeid option[data-type='MAIN STORE']").val();

						if (mainStore) {
							$("#Storeid1").val(mainStore);   // set selected
							$("#Storeid1").prop("disabled", true); // make dropdown readonly
						}
					}
				}
			});
		}

		function GetTotalStockQty() {

			$.ajax({
				type: "POST",
				url: "@Url.Action("GetStoreTotalStock", "NRGP")",
				data: { ItemCode: $('#ItemCode').val(), StoreId: $('#Storeid1').val(), TillDate: $('#PODate').val() },
				dataType: "json",
				success: function (result, status, error) {

					if (result && result.length > 0) {
						/*         alert(JSON.stringify(result)); */
						/* if (result != null) { */
						/* var obj = $.parseJSON(result); */
						$('#TotalStock').val($.parseJSON(result).Result[0].STOCK);
						/*     $('#TotalStock').val(result[0].STOCK); */
					}
					// SetminQty();
				}
			});
		}

		 function FillWorkCenter() {
            $.ajax({
                type: "POST",
				url: "@Url.Action("FillWorkCenter", "TransferFromWorkCenter")",
                dataType: "json",
                data: {},
                success: function (result, status, error) {
                    if (result != null) {
                        var obj = $.parseJSON(result);
					console.log(obj)
                        if (obj.StatusCode == 200 && obj.StatusText == 'Success') {
							$('#WorkCenter').empty();
                            $('#WorkCenter').append('<option>-Select-</option>');
                            $.each(obj.Result, function (index, val) {
								$('#WorkCenter').append('<option selected value="' + val.WCID + '">' + val.WorkCenterDescription + '</option>');
								$('#WcId').val($('#WorkCenter').val());
                                // $('#/* IssueToStoreId */').val(0);
                            })
                            if ($('#Mode').val() == "U" || $('#Mode').val() == "V") {
								var FromWc = "@Model.WcId";
								$('#WorkCenter').val(FromWc).trigger("change");
                            }
                        }
                    }
                }
            });
        }

		$("#WorkCenter").change(function () {
			GetWorkCenterTotalQty();
		});

		    function GetWorkCenterTotalQty() {
            var dateValue = $('#PODate').val();
            var [day, month, year] = dateValue.split('/');
            day = day.padStart(2, '0'); // Ensure day has two digits
            month = month.padStart(2, '0'); // Ensure month has two digits
            var formattedDate = `${day}/${month}/${year}`;
            $.ajax({
                type: "POST",
				url: "@Url.Action("GetWorkCenterTotalStock", "TransferFromWorkCenter")",
				data: { ItemCode: $('#ItemCode').val(), WcId: $('#WorkCenter').val(), TillDate: formattedDate },
                dataType: "json",
                async: false,
                success: function (result, status, error) {
                    if (result != null) {
                        var obj = $.parseJSON(result);
                        $('#WorkStock').val($.parseJSON(result).Result[0].STOCK);
                    }
                }
            });
        }

		async function DeleteDeliveryRow(SRNo, DPC) {
			$.ajax({
				url: '@Url.Action("DeleteDeliveryRow")',
				type: "POST",
				data: { "SRNo": SRNo, "DPC": DPC },
				success: function (data, status, xhr) {

					$('#POGrid').html(data);
					if ($('#POGrid tbody').children().length == 1) {
						var NoData = '<tr class="text-center"><td colspan="6" class="text-black-50"><strong>NO DATA ADDED</strong></td></tr>';
						$('#POGrid tbody').html(NoData);
					}

					const S = ScheduleQty();
					const T = parseInt($('#DTQty').val());

					T != S ? $('.addSchedule').prop('disabled', false).removeAttr('readonly') : $('.addSchedule').prop('disabled', true).attr('readonly', 'readonly');
				},
				error: function (response, status, xhr) {
					$.notify(response.responseText, "error");
				},
				failure: function (response, status, xhr) {
					$.notify(response.responseText, "error");
				}
			});
			// $(document).ready(function () {
			// 	FillStoreList();
			// });
			

		}

		//window.addEventListener('scroll', function() {
		//  var table = $('#poTable');
		//  var header = $('#poThead');
		//  var rect = table.getBoundingClientRect();

		//  if (rect.top <= 0 && rect.bottom > header.offsetHeight) {
		//    header.classList.add('sticky');
		//  } else {
		//    header.classList.remove('sticky');
		//  }
		//});
	</script>

	<script src="https://cdn.jsdelivr.net/gh/linways/table-to-excel@v1.0.4/dist/tableToExcel.js"></script>

	<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />

	<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

	<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.2/xlsx.full.min.js"></script>
	@*<script src="~/Scripts/table2excel.js"></script>*@
	<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.16.9/xlsx.full.min.js"></script>


}

<style>
	#poTable {
		width: 100%;
		border-collapse: collapse;
	}

	#poThead th {
		background-color: #127387;
		position: sticky;
		top: 0;
		z-index: 1;
	}

	tbody td {
		/* Table cell styles */
	}

	.select2-search__field {
		z-index: 10000 !important; /* Adjust the value as needed */
	}

	


</style>